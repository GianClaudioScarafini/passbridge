import C from"process";var te=typeof globalThis!=="undefined"?globalThis:typeof self!=="undefined"?self:global;var le={};var ce=C;(function(C,te){le=te()})(0,(function(){var C,le,he;function define(te,ce){if(C)if(le){var ue="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+C+")(sharedChunk); ("+le+")(sharedChunk); self.onerror = null;";var de={};C(de);he=ce(de);typeof window!=="undefined"&&window&&window.URL&&window.URL.createObjectURL&&(he.workerUrl=window.URL.createObjectURL(new Blob([ue],{type:"text/javascript"})))}else le=ce;else C=ce}define(["exports"],(function(C){var le="undefined"!=typeof self?self:{},he="3.1.2";let ue;const de={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(null==ue){const C=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{ue=null!=ce.env.API_URL_REGEX?new RegExp(ce.env.API_URL_REGEX):C}catch(te){ue=C}}return ue},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!de.API_URL)return null;try{const C=new URL(de.API_URL);return"api.mapbox.cn"===C.hostname?"https://events.mapbox.cn/events/v2":"api.mapbox.com"===C.hostname?"https://events.mapbox.com/events/v2":null}catch(C){return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},_e={supported:!1,testSupport:function(C){!Se&&ve&&(Me?h(C):ye=C)}};let ye,ve,Se=!1,Me=!1;function h(C){const te=C.createTexture();C.bindTexture(C.TEXTURE_2D,te);try{if(C.texImage2D(C.TEXTURE_2D,0,C.RGBA,C.RGBA,C.UNSIGNED_BYTE,ve),C.isContextLost())return;_e.supported=!0}catch(C){}C.deleteTexture(te),Se=!0}le.document&&(ve=le.document.createElement("img"),ve.onload=function(){ye&&h(ye),ye=null,Me=!0},ve.onerror=function(){Se=!0,ye=null},ve.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const Ae="01";function d(C){return C&&C.__esModule&&Object.prototype.hasOwnProperty.call(C,"default")?C.default:C}var Ce=f;function f(C,le,ce,he){(this||te).cx=3*C,(this||te).bx=3*(ce-C)-(this||te).cx,(this||te).ax=1-(this||te).cx-(this||te).bx,(this||te).cy=3*le,(this||te).by=3*(he-le)-(this||te).cy,(this||te).ay=1-(this||te).cy-(this||te).by,(this||te).p1x=C,(this||te).p1y=le,(this||te).p2x=ce,(this||te).p2y=he}f.prototype={sampleCurveX:function(C){return(((this||te).ax*C+(this||te).bx)*C+(this||te).cx)*C},sampleCurveY:function(C){return(((this||te).ay*C+(this||te).by)*C+(this||te).cy)*C},sampleCurveDerivativeX:function(C){return(3*(this||te).ax*C+2*(this||te).bx)*C+(this||te).cx},solveCurveX:function(C,te){if(void 0===te&&(te=1e-6),C<0)return 0;if(C>1)return 1;for(var le=C,ce=0;ce<8;ce++){var he=this.sampleCurveX(le)-C;if(Math.abs(he)<te)return le;var ue=this.sampleCurveDerivativeX(le);if(Math.abs(ue)<1e-6)break;le-=he/ue}var de=0,_e=1;for(le=C,ce=0;ce<20&&(he=this.sampleCurveX(le),!(Math.abs(he-C)<te));ce++)C>he?de=le:_e=le,le=.5*(_e-de)+de;return le},solve:function(C,te){return this.sampleCurveY(this.solveCurveX(C,te))}};var Oe=d(Ce),Ne=g;function g(C,le){(this||te).x=C,(this||te).y=le}g.prototype={clone:function(){return new g((this||te).x,(this||te).y)},add:function(C){return this.clone()._add(C)},sub:function(C){return this.clone()._sub(C)},multByPoint:function(C){return this.clone()._multByPoint(C)},divByPoint:function(C){return this.clone()._divByPoint(C)},mult:function(C){return this.clone()._mult(C)},div:function(C){return this.clone()._div(C)},rotate:function(C){return this.clone()._rotate(C)},rotateAround:function(C,te){return this.clone()._rotateAround(C,te)},matMult:function(C){return this.clone()._matMult(C)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt((this||te).x*(this||te).x+(this||te).y*(this||te).y)},equals:function(C){return(this||te).x===C.x&&(this||te).y===C.y},dist:function(C){return Math.sqrt(this.distSqr(C))},distSqr:function(C){var le=C.x-(this||te).x,ce=C.y-(this||te).y;return le*le+ce*ce},angle:function(){return Math.atan2((this||te).y,(this||te).x)},angleTo:function(C){return Math.atan2((this||te).y-C.y,(this||te).x-C.x)},angleWith:function(C){return this.angleWithSep(C.x,C.y)},angleWithSep:function(C,le){return Math.atan2((this||te).x*le-(this||te).y*C,(this||te).x*C+(this||te).y*le)},_matMult:function(C){var le=C[2]*(this||te).x+C[3]*(this||te).y;return(this||te).x=C[0]*(this||te).x+C[1]*(this||te).y,(this||te).y=le,this||te},_add:function(C){return(this||te).x+=C.x,(this||te).y+=C.y,this||te},_sub:function(C){return(this||te).x-=C.x,(this||te).y-=C.y,this||te},_mult:function(C){return(this||te).x*=C,(this||te).y*=C,this||te},_div:function(C){return(this||te).x/=C,(this||te).y/=C,this||te},_multByPoint:function(C){return(this||te).x*=C.x,(this||te).y*=C.y,this||te},_divByPoint:function(C){return(this||te).x/=C.x,(this||te).y/=C.y,this||te},_unit:function(){return this._div(this.mag()),this||te},_perp:function(){var C=(this||te).y;return(this||te).y=(this||te).x,(this||te).x=-C,this||te},_rotate:function(C){var le=Math.cos(C),ce=Math.sin(C),he=ce*(this||te).x+le*(this||te).y;return(this||te).x=le*(this||te).x-ce*(this||te).y,(this||te).y=he,this||te},_rotateAround:function(C,le){var ce=Math.cos(C),he=Math.sin(C),ue=le.y+he*((this||te).x-le.x)+ce*((this||te).y-le.y);return(this||te).x=le.x+ce*((this||te).x-le.x)-he*((this||te).y-le.y),(this||te).y=ue,this||te},_round:function(){return(this||te).x=Math.round((this||te).x),(this||te).y=Math.round((this||te).y),this||te}},g.convert=function(C){return C instanceof g?C:Array.isArray(C)?new g(C[0],C[1]):C};var je=d(Ne);function x(C,te){if(Array.isArray(C)){if(!Array.isArray(te)||C.length!==te.length)return!1;for(let le=0;le<C.length;le++)if(!x(C[le],te[le]))return!1;return!0}if("object"==typeof C&&null!==C&&null!==te){if("object"!=typeof te)return!1;if(Object.keys(C).length!==Object.keys(te).length)return!1;for(const le in C)if(!x(C[le],te[le]))return!1;return!0}return C===te}const Ge=Math.PI/180,Ze=180/Math.PI;function w(C){return C*Ge}function T(C){return C*Ze}const qe=[[0,0],[1,0],[1,1],[0,1]];function M(C){if(C<=0)return 0;if(C>=1)return 1;const te=C*C,le=te*C;return 4*(C<.5?le:3*(C-te)+le-.75)}function A(C){let te=1/0,le=1/0,ce=-1/0,he=-1/0;for(const ue of C)te=Math.min(te,ue.x),le=Math.min(le,ue.y),ce=Math.max(ce,ue.x),he=Math.max(he,ue.y);return{min:new je(te,le),max:new je(ce,he)}}function S(C,te,le=0,ce=!0){const he=new je(le,le),ue=C.sub(he),de=te.add(he),_e=[ue,new je(de.x,ue.y),de,new je(ue.x,de.y)];return ce&&_e.push(ue.clone()),_e}function I(C,te,le,ce){const he=new Oe(C,te,le,ce);return function(C){return he.solve(C)}}const $e=I(.25,.1,.25,1);function z(C,te,le){return Math.min(le,Math.max(te,C))}function P(C,te,le){return(le=z((le-C)/(te-C),0,1))*le*(3-2*le)}function D(C,te,le){const ce=le-te,he=((C-te)%ce+ce)%ce+te;return he===te?le:he}function R(C,te,le){if(!C.length)return le(null,[]);let ce=C.length;const he=new Array(C.length);let ue=null;C.forEach(((C,de)=>{te(C,((C,te)=>{C&&(ue=C),he[de]=te,0==--ce&&le(ue,he)}))}))}function L(C){const te=[];for(const le in C)te.push(C[le]);return te}function k(C,...te){for(const le of te)for(const te in le)C[te]=le[te];return C}function O(C,te){const le={};for(let ce=0;ce<te.length;ce++){const he=te[ce];he in C&&(le[he]=C[he])}return le}let He=1;function F(){return He++}function N(){return function e(C){return C?(C^Math.random()*(16>>C/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,e)}()}function U(C){return C<=1?1:Math.pow(2,Math.ceil(Math.log(C)/Math.LN2))}function V(C){return!!C&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(C)}function j(C,te){C.forEach((C=>{te[C]&&(te[C]=te[C].bind(te))}))}function G(C,te){return-1!==C.indexOf(te,C.length-te.length)}function q(C,le,ce){const he={};for(const ue in C)he[ue]=le.call(ce||this||te,C[ue],ue,C);return he}function Z(C,le,ce){const he={};for(const ue in C)le.call(ce||this||te,C[ue],ue,C)&&(he[ue]=C[ue]);return he}function $(C){return Array.isArray(C)?C.map($):"object"==typeof C&&C?q(C,$):C}const We={};function H(C){We[C]||("undefined"!=typeof console&&console.warn(C),We[C]=!0)}function X(C,te,le){return(le.y-C.y)*(te.x-C.x)>(te.y-C.y)*(le.x-C.x)}function Y(C){let te=0;for(let le,ce,he=0,ue=C.length,de=ue-1;he<ue;de=he++)le=C[he],ce=C[de],te+=(ce.x-le.x)*(le.y+ce.y);return te}function K([C,te,le]){const ce=w(te+90),he=w(le);return{x:C*Math.cos(ce)*Math.sin(he),y:C*Math.sin(ce)*Math.sin(he),z:C*Math.cos(he),azimuthal:te,polar:le}}function J(C,te,le){const ce=Math.sqrt(C*C+te*te+le*le),he=ce>0?Math.acos(le/ce)*Ze:0;let ue=0!==C||0!==te?Math.atan2(-te,-C)*Ze+90:0;return ue<0&&(ue+=360),[ce,ue,he]}function Q(){return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope}function ee(C){const te={};if(C.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,((C,le,ce,he)=>{const ue=ce||he;return te[le]=!ue||ue.toLowerCase(),""})),te["max-age"]){const C=parseInt(te["max-age"],10);isNaN(C)?delete te["max-age"]:te["max-age"]=C}return te}let Xe=null;function ie(){return!!le.document.fullscreenElement||!!le.document.webkitFullscreenElement}function re(C){try{const te=le[C];return te.setItem("_mapbox_test_",1),te.removeItem("_mapbox_test_"),!0}catch(C){return!1}}function ne(C,te){return[C[4*te],C[4*te+1],C[4*te+2],C[4*te+3]]}function oe(C,te,le){C[4*te+0]=le[0],C[4*te+1]=le[1],C[4*te+2]=le[2],C[4*te+3]=le[3]}function se(C,te){return[Math.pow(C[0],2.2)*te,Math.pow(C[1],2.2)*te,Math.pow(C[2],2.2)*te]}function ae(C){return[Math.pow(C[0],1/2.2),Math.pow(C[1],1/2.2),Math.pow(C[2],1/2.2)]}const Ye="mapbox-tiles";let Je=500,Qe=50;let tt,rt;function pe(){try{return le.caches}catch(C){}}function fe(){pe()&&!tt&&(tt=le.caches.open(Ye))}function me(C){const te=C.indexOf("?");if(te<0)return C;const le=function(C){const te=C.indexOf("?");return te>0?C.slice(te+1).split("&"):[]}(C),ce=le.filter((C=>{const te=C.split("=");return"language"===te[0]||"worldview"===te[0]}));return ce.length?`${C.slice(0,te)}?${ce.join("&")}`:C.slice(0,te)}let ot=1/0;function ge(C){ot++,ot>Qe&&(C.getActor().send("enforceCacheSizeLimit",Je),ot=0)}const st={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image",Model:"Model"};"function"==typeof Object.freeze&&Object.freeze(st);class xe extends Error{constructor(C,te,le){401===te&&De(le)&&(C+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(C),this.status=te,this.url=le}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const at=Q()?()=>self.worker&&self.worker.referrer:()=>("blob:"===le.location.protocol?le.parent:le).location.href;const be=function(C,te){if(!(/^file:/.test(ce=C.url)||/^file:/.test(at())&&!/^\w+:/.test(ce))){if(le.fetch&&le.Request&&le.AbortController&&le.Request.prototype.hasOwnProperty("signal"))return function(C,te){const ce=new le.AbortController,he=new le.Request(C.url,{method:C.method||"GET",body:C.body,credentials:C.credentials,headers:C.headers,referrer:at(),referrerPolicy:C.referrerPolicy,signal:ce.signal});let ue=!1,de=!1;const _e=(ye=he.url).indexOf("sku=")>0&&De(ye);var ye;"json"===C.type&&he.headers.set("Accept","application/json");const c=(ce,ue,ye)=>{if(de)return;if(ce&&"SecurityError"!==ce.message&&H(ce.toString()),ue&&ye)return h(ue);const ve=Date.now();le.fetch(he).then((le=>{if(le.ok){const C=_e?le.clone():null;return h(le,C,ve)}return te(new xe(le.statusText,le.status,C.url))})).catch((le=>{"AbortError"!==le.name&&te(new Error(`${le.message} ${C.url}`))}))},h=(ce,_e,ye)=>{("arrayBuffer"===C.type?ce.arrayBuffer():"json"===C.type?ce.json():ce.text()).then((C=>{de||(_e&&ye&&function(C,te,ce){if(fe(),!tt)return;const he={status:te.status,statusText:te.statusText,headers:new le.Headers};te.headers.forEach(((C,te)=>he.headers.set(te,C)));const ue=ee(te.headers.get("Cache-Control")||"");if(ue["no-store"])return;ue["max-age"]&&he.headers.set("Expires",new Date(ce+1e3*ue["max-age"]).toUTCString());const de=he.headers.get("Expires");de&&(new Date(de).getTime()-ce<42e4||function(C,te){if(void 0===rt)try{new Response(new ReadableStream),rt=!0}catch(C){rt=!1}rt?te(C.body):C.blob().then(te)}(te,(te=>{const ce=new le.Response(te,he);fe(),tt&&tt.then((te=>te.put(me(C.url),ce))).catch((C=>H(C.message)))})))}(he,_e,ye),ue=!0,te(null,C,ce.headers.get("Cache-Control"),ce.headers.get("Expires")))})).catch((C=>{de||te(new Error(C.message))}))};return _e?function(C,te){if(fe(),!tt)return te(null);const le=me(C.url);tt.then((C=>{C.match(le).then((ce=>{const he=function(C){if(!C)return!1;const te=new Date(C.headers.get("Expires")||0),le=ee(C.headers.get("Cache-Control")||"");return te>Date.now()&&!le["no-cache"]}(ce);C.delete(le),he&&C.put(le,ce.clone()),te(null,ce,he)})).catch(te)})).catch(te)}(he,c):c(null,null),{cancel:()=>{de=!0,ue||ce.abort()}}}(C,te);if(Q()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",C,te,void 0,!0)}var ce;return function(C,te){const ce=new le.XMLHttpRequest;ce.open(C.method||"GET",C.url,!0),"arrayBuffer"===C.type&&(ce.responseType="arraybuffer");for(const te in C.headers)ce.setRequestHeader(te,C.headers[te]);return"json"===C.type&&(ce.responseType="text",ce.setRequestHeader("Accept","application/json")),ce.withCredentials="include"===C.credentials,ce.onerror=()=>{te(new Error(ce.statusText))},ce.onload=()=>{if((ce.status>=200&&ce.status<300||0===ce.status)&&null!==ce.response){let le=ce.response;if("json"===C.type)try{le=JSON.parse(ce.response)}catch(C){return te(C)}te(null,le,ce.getResponseHeader("Cache-Control"),ce.getResponseHeader("Expires"))}else te(new xe(ce.statusText,ce.status,C.url))},ce.send(C.body),{cancel:()=>ce.abort()}}(C,te)},we=function(C,te){return be(k(C,{type:"json"}),te)},Te=function(C,te){return be(k(C,{type:"arrayBuffer"}),te)};function Ee(C){const te=le.document.createElement("a");return te.href=C,te.protocol===le.document.location.protocol&&te.host===le.document.location.host}const lt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let ct,ht;ct=[],ht=0;const Ie=function(C,ce){if(_e.supported&&(C.headers||(C.headers={}),C.headers.accept="image/webp,*/*"),ht>=de.MAX_PARALLEL_IMAGE_REQUESTS){const le={requestParameters:C,callback:ce,cancelled:!1,cancel(){(this||te).cancelled=!0}};return ct.push(le),le}ht++;let he=!1;const s=()=>{if(!he)for(he=!0,ht--;ct.length&&ht<de.MAX_PARALLEL_IMAGE_REQUESTS;){const C=ct.shift(),{requestParameters:te,callback:le,cancelled:ce}=C;ce||(C.cancel=Ie(te,le).cancel)}},ue=Te(C,((C,te,he,ue)=>{s(),C?ce(C):te&&(le.createImageBitmap?function(C,te){const ce=new le.Blob([new Uint8Array(C)],{type:"image/png"});le.createImageBitmap(ce).then((C=>{te(null,C)})).catch((C=>{te(new Error(`Could not load image because of ${C.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))}))}(te,((C,te)=>ce(C,te,he,ue))):function(C,te){const ce=new le.Image,he=le.URL;ce.onload=()=>{te(null,ce),he.revokeObjectURL(ce.src),ce.onload=null,le.requestAnimationFrame((()=>{ce.src=lt}))},ce.onerror=()=>te(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const ue=new le.Blob([new Uint8Array(C)],{type:"image/png"});ce.src=C.byteLength?he.createObjectURL(ue):lt}(te,((C,te)=>ce(C,te,he,ue))))}));return{cancel:()=>{ue.cancel(),s()}}},dt="NO_ACCESS_TOKEN";class ze{constructor(C,te,le){this._transformRequestFn=C,this._customAccessToken=te,this._silenceAuthErrors=!!le,this._createSkuToken()}_createSkuToken(){const C=function(){let C="";for(let te=0;te<10;te++)C+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Ae,C].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=C.token,this._skuTokenExpiresAt=C.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(C,te){return this._transformRequestFn&&this._transformRequestFn(C,te)||{url:C}}normalizeStyleURL(C,te){if(!Pe(C))return C;const le=Be(C);return le.params.push(`sdk=js-${he}`),le.path=`/styles/v1${le.path}`,this._makeAPIURL(le,this._customAccessToken||te)}normalizeGlyphsURL(C,te){if(!Pe(C))return C;const le=Be(C);return le.path=`/fonts/v1${le.path}`,this._makeAPIURL(le,this._customAccessToken||te)}normalizeModelURL(C,te){if(!Pe(C))return C;const le=Be(C);return le.path=`/models/v1${le.path}`,this._makeAPIURL(le,this._customAccessToken||te)}normalizeSourceURL(C,te,le,ce){if(!Pe(C))return C;const he=Be(C);return he.path=`/v4/${he.authority}.json`,he.params.push("secure"),le&&he.params.push(`language=${le}`),ce&&he.params.push(`worldview=${ce}`),this._makeAPIURL(he,this._customAccessToken||te)}normalizeSpriteURL(C,te,le,ce){const he=Be(C);return Pe(C)?(he.path=`/styles/v1${he.path}/sprite${te}${le}`,this._makeAPIURL(he,this._customAccessToken||ce)):(he.path+=`${te}${le}`,Fe(he))}normalizeTileURL(C,te,le){if(this._isSkuTokenExpired()&&this._createSkuToken(),C&&!Pe(C))return C;const ce=Be(C);ce.path=ce.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${te||le&&"raster"!==ce.authority&&512===le?"@2x":""}${_e.supported?".webp":"$1"}`),"raster"===ce.authority?ce.path=`/${de.RASTER_URL_PREFIX}${ce.path}`:(ce.path=ce.path.replace(/^.+\/v4\//,"/"),ce.path=`/${de.TILE_URL_VERSION}${ce.path}`);const he=this._customAccessToken||function(C){for(const te of C){const C=te.match(/^access_token=(.*)$/);if(C)return C[1]}return null}(ce.params)||de.ACCESS_TOKEN;return de.REQUIRE_ACCESS_TOKEN&&he&&this._skuToken&&ce.params.push(`sku=${this._skuToken}`),this._makeAPIURL(ce,he)}canonicalizeTileURL(C,te){const le=Be(C);if(!le.path.match(/^(\/v4\/|\/raster\/v1\/)/)||!le.path.match(/\.[\w]+$/))return C;let ce="mapbox://";le.path.match(/^\/raster\/v1\//)?ce+=`raster/${le.path.replace(`/${de.RASTER_URL_PREFIX}/`,"")}`:ce+=`tiles/${le.path.replace(`/${de.TILE_URL_VERSION}/`,"")}`;let he=le.params;return te&&(he=he.filter((C=>!C.match(/^access_token=/)))),he.length&&(ce+=`?${he.join("&")}`),ce}canonicalizeTileset(C,te){const le=!!te&&Pe(te),ce=[];for(const te of C.tiles||[])De(te)?ce.push(this.canonicalizeTileURL(te,le)):ce.push(te);return ce}_makeAPIURL(C,te){const le="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",ce=Be(de.API_URL);if(C.protocol=ce.protocol,C.authority=ce.authority,"http"===C.protocol){const te=C.params.indexOf("secure");te>=0&&C.params.splice(te,1)}if("/"!==ce.path&&(C.path=`${ce.path}${C.path}`),!de.REQUIRE_ACCESS_TOKEN)return Fe(C);if(te=te||de.ACCESS_TOKEN,!this._silenceAuthErrors){if(!te)throw new Error(`An API access token is required to use Mapbox GL. ${le}`);if("s"===te[0])throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${le}`)}return C.params=C.params.filter((C=>-1===C.indexOf("access_token"))),C.params.push(`access_token=${te||""}`),Fe(C)}}function Pe(C){return 0===C.indexOf("mapbox:")}function De(C){return de.API_URL_REGEX.test(C)}function Re(C){return de.API_CDN_URL_REGEX.test(C)}function Le(C){return de.API_STYLE_REGEX.test(C)&&!ke(C)}function ke(C){return de.API_SPRITE_REGEX.test(C)}const mt=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function Be(C){const te=C.match(mt);if(!te)throw new Error("Unable to parse URL object");return{protocol:te[1],authority:te[2],path:te[3]||"/",params:te[4]?te[4].split("&"):[]}}function Fe(C){const te=C.params.length?`?${C.params.join("&")}`:"";return`${C.protocol}://${C.authority}${C.path}${te}`}const _t="mapbox.eventData";function Ue(C){if(!C)return null;const te=C.split(".");if(!te||3!==te.length)return null;try{return JSON.parse(decodeURIComponent(le.atob(te[1]).split("").map((C=>"%"+("00"+C.charCodeAt(0).toString(16)).slice(-2))).join("")))}catch(C){return null}}class Ve{constructor(C){this.type=C,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(C){const te=Ue(de.ACCESS_TOKEN);let ce="";return ce=te&&te.u?le.btoa(encodeURIComponent(te.u).replace(/%([0-9A-F]{2})/g,((C,te)=>String.fromCharCode(Number("0x"+te))))):de.ACCESS_TOKEN||"",C?`${_t}.${C}:${ce}`:`${_t}:${ce}`}fetchEventData(){const C=re("localStorage"),te=this.getStorageKey(),ce=this.getStorageKey("uuid");if(C)try{const C=le.localStorage.getItem(te);C&&(this.eventData=JSON.parse(C));const he=le.localStorage.getItem(ce);he&&(this.anonId=he)}catch(C){H("Unable to read from LocalStorage")}}saveEventData(){const C=re("localStorage"),te=this.getStorageKey(),ce=this.getStorageKey("uuid");if(C)try{le.localStorage.setItem(ce,this.anonId),Object.keys(this.eventData).length>=1&&le.localStorage.setItem(te,JSON.stringify(this.eventData))}catch(C){H("Unable to write to LocalStorage")}}processRequests(C){}postEvent(C,te,le,ce){if(!de.EVENTS_URL)return;const he=Be(de.EVENTS_URL);he.params.push(`access_token=${ce||de.ACCESS_TOKEN||""}`);const ue={event:this.type,created:new Date(C).toISOString()},_e=te?k(ue,te):ue,ye={url:Fe(he),headers:{"Content-Type":"text/plain"},body:JSON.stringify([_e])};this.pendingRequest=function(C,te){return be(k(C,{method:"POST"}),te)}(ye,(C=>{this.pendingRequest=null,le(C),this.saveEventData(),this.processRequests(ce)}))}queueRequest(C,te){this.queue.push(C),this.processRequests(te)}}const gt=new class extends Ve{constructor(C){super("appUserTurnstile"),this._customAccessToken=C}postTurnstileEvent(C,te){de.EVENTS_URL&&de.ACCESS_TOKEN&&Array.isArray(C)&&C.some((C=>Pe(C)||De(C)))&&this.queueRequest(Date.now(),te)}processRequests(C){if(this.pendingRequest||0===this.queue.length)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const te=Ue(de.ACCESS_TOKEN),le=te?te.u:de.ACCESS_TOKEN;let ce=le!==this.eventData.tokenU;V(this.anonId)||(this.anonId=N(),ce=!0);const ue=this.queue.shift();if(this.eventData.lastSuccess){const C=new Date(this.eventData.lastSuccess),te=new Date(ue),le=(ue-this.eventData.lastSuccess)/864e5;ce=ce||le>=1||le<-1||C.getDate()!==te.getDate()}else ce=!0;ce?this.postEvent(ue,{sdkIdentifier:"mapbox-gl-js",sdkVersion:he,skuId:Ae,"enabled.telemetry":!1,userId:this.anonId},(C=>{C||(this.eventData.lastSuccess=ue,this.eventData.tokenU=le)}),C):this.processRequests()}},Pt=gt.postTurnstileEvent.bind(gt),Ft=new class extends Ve{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(C,te,le,ce){this.skuToken=te,this.errorCb=ce,de.EVENTS_URL&&(le||de.ACCESS_TOKEN?this.queueRequest({id:C,timestamp:Date.now()},le):this.errorCb(new Error(dt)))}processRequests(C){if(this.pendingRequest||0===this.queue.length)return;const{id:te,timestamp:le}=this.queue.shift();te&&this.success[te]||(this.anonId||this.fetchEventData(),V(this.anonId)||(this.anonId=N()),this.postEvent(le,{sdkIdentifier:"mapbox-gl-js",sdkVersion:he,skuId:Ae,skuToken:this.skuToken,userId:this.anonId},(C=>{C?this.errorCb(C):te&&(this.success[te]=!0)}),C))}},jt=Ft.postMapLoadEvent.bind(Ft),Ut=new class extends Ve{constructor(){super("gljs.performance")}postPerformanceEvent(C,te){de.EVENTS_URL&&(C||de.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:te},C)}processRequests(C){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:te,performanceData:ce}=this.queue.shift(),ue=function(C){const te=le.performance.getEntriesByType("resource"),ce=le.performance.getEntriesByType("mark"),ue=function(C){const te={};if(C)for(const le in C)if("other"!==le)for(const ce of C[le]){const C=`${le}ResolveRangeMin`,he=`${le}ResolveRangeMax`,ue=`${le}RequestCount`,de=`${le}RequestCachedCount`;te[C]=Math.min(te[C]||1/0,ce.startTime),te[he]=Math.max(te[he]||-1/0,ce.responseEnd);const a=C=>{void 0===te[C]&&(te[C]=0),++te[C]};void 0!==ce.transferSize&&0===ce.transferSize&&a(de),a(ue)}return te}(function(C,te){const le={};if(C)for(const ce of C){const C=te(ce);void 0===le[C]&&(le[C]=[]),le[C].push(ce)}return le}(te,et)),de=le.devicePixelRatio,_e=le.navigator.connection||le.navigator.mozConnection||le.navigator.webkitConnection,ye={counters:[],metadata:[],attributes:[]},c=(C,te,le)=>{null!=le&&C.push({name:te,value:le.toString()})};for(const C in ue)c(ye.counters,C,ue[C]);if(C.interactionRange[0]!==1/0&&C.interactionRange[1]!==-1/0&&(c(ye.counters,"interactionRangeMin",C.interactionRange[0]),c(ye.counters,"interactionRangeMax",C.interactionRange[1])),ce)for(const C of Object.keys($t)){const te=$t[C],le=ce.find((C=>C.name===te));le&&c(ye.counters,te,le.startTime)}return c(ye.counters,"visibilityHidden",C.visibilityHidden),c(ye.attributes,"style",function(C){if(C)for(const te of C){const C=te.name.split("?")[0];if(Le(C)){const te=C.split("/").slice(-2);if(2===te.length)return`mapbox://styles/${te[0]}/${te[1]}`}}}(te)),c(ye.attributes,"terrainEnabled",C.terrainEnabled?"true":"false"),c(ye.attributes,"fogEnabled",C.fogEnabled?"true":"false"),c(ye.attributes,"projection",C.projection),c(ye.attributes,"zoom",C.zoom),c(ye.metadata,"devicePixelRatio",de),c(ye.metadata,"connectionEffectiveType",_e?_e.effectiveType:void 0),c(ye.metadata,"navigatorUserAgent",le.navigator.userAgent),c(ye.metadata,"screenWidth",le.screen.width),c(ye.metadata,"screenHeight",le.screen.height),c(ye.metadata,"windowWidth",le.innerWidth),c(ye.metadata,"windowHeight",le.innerHeight),c(ye.metadata,"mapWidth",C.width/de),c(ye.metadata,"mapHeight",C.height/de),c(ye.metadata,"webglRenderer",C.renderer),c(ye.metadata,"webglVendor",C.vendor),c(ye.metadata,"sdkVersion",he),c(ye.metadata,"sdkIdentifier","mapbox-gl-js"),ye}(ce);for(const C of ue.metadata);for(const C of ue.counters);for(const C of ue.attributes);this.postEvent(te,ue,(()=>{}),C)}},Vt=Ut.postPerformanceEvent.bind(Ut),Gt=new class extends Ve{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(C,te,le,ce){if(!de.API_URL||!de.SESSION_PATH)return;const he=Be(de.API_URL+de.SESSION_PATH);he.params.push(`sku=${te||""}`),he.params.push(`access_token=${ce||de.ACCESS_TOKEN||""}`);const ue={url:Fe(he),headers:{"Content-Type":"text/plain"}};this.pendingRequest=function(C,te){return be(k(C,{method:"GET"}),te)}(ue,(C=>{this.pendingRequest=null,le(C),this.saveEventData(),this.processRequests(ce)}))}getSessionAPI(C,te,le,ce){this.skuToken=te,this.errorCb=ce,de.SESSION_PATH&&de.API_URL&&(le||de.ACCESS_TOKEN?this.queueRequest({id:C,timestamp:Date.now()},le):this.errorCb(new Error(dt)))}processRequests(C){if(this.pendingRequest||0===this.queue.length)return;const{id:te,timestamp:le}=this.queue.shift();te&&this.success[te]||this.getSession(le,this.skuToken,(C=>{C?this.errorCb(C):te&&(this.success[te]=!0)}),C)}},Zt=Gt.getSessionAPI.bind(Gt),qt=new Set;function Ke(C,te){te?qt.add(C):qt.delete(C)}const $t={create:"create",load:"load",fullLoad:"fullLoad"},Ht={mark(C){le.performance.mark(C)},measure(C,te,ce){le.performance.measure(C,te,ce)}};function et(C){const te=C.name.split("?")[0];return Re(te)&&te.includes("mapbox-gl.js")?"javascript":Re(te)&&te.includes("mapbox-gl.css")?"css":function(C){return de.API_FONTS_REGEX.test(C)}(te)?"fontRange":ke(te)?"sprite":Le(te)?"style":function(C){return de.API_TILEJSON_REGEX.test(C)}(te)?"tilejson":"other"}const Wt=le.performance;function it(C){const te=C?C.url.toString():void 0;return Wt.getEntriesByName(te)}var Xt=nt;function nt(C){return!function(C){return"undefined"==typeof window||"undefined"==typeof document?"not a browser":Array.prototype&&Array.prototype.every&&Array.prototype.filter&&Array.prototype.forEach&&Array.prototype.indexOf&&Array.prototype.lastIndexOf&&Array.prototype.map&&Array.prototype.some&&Array.prototype.reduce&&Array.prototype.reduceRight&&Array.isArray?Function.prototype&&Function.prototype.bind?Object.keys&&Object.create&&Object.getPrototypeOf&&Object.getOwnPropertyNames&&Object.isSealed&&Object.isFrozen&&Object.isExtensible&&Object.getOwnPropertyDescriptor&&Object.defineProperty&&Object.defineProperties&&Object.seal&&Object.freeze&&Object.preventExtensions?"JSON"in window&&"parse"in JSON&&"stringify"in JSON?function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var C,te,le=new Blob([""],{type:"text/javascript"}),ce=URL.createObjectURL(le);try{te=new Worker(ce),C=!0}catch(te){C=!1}return te&&te.terminate(),URL.revokeObjectURL(ce),C}()?"Uint8ClampedArray"in window?ArrayBuffer.isView?function(){var C=document.createElement("canvas");C.width=C.height=1;var te=C.getContext("2d");if(!te)return!1;var le=te.getImageData(0,0,1,1);return le&&le.width===C.width}()?(void 0===Yt[te=C&&C.failIfMajorPerformanceCaveat]&&(Yt[te]=function(C){var te,le=function(C){var te=document.createElement("canvas"),le=Object.create(nt.webGLContextAttributes);return le.failIfMajorPerformanceCaveat=C,te.getContext("webgl",le)||te.getContext("experimental-webgl",le)}(C);if(!le)return!1;try{te=le.createShader(le.VERTEX_SHADER)}catch(C){return!1}return!(!te||le.isContextLost())&&(le.shaderSource(te,"void main() {}"),le.compileShader(te),!0===le.getShaderParameter(te,le.COMPILE_STATUS))}(te)),Yt[te]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL support"):"insufficient Canvas/getImageData support":"insufficient ArrayBuffer support":"insufficient Uint8ClampedArray support":"insufficient worker support":"insufficient JSON support":"insufficient Object support":"insufficient Function support":"insufficent Array support";var te}(C)}var Yt={};let Qt,ri,ni,hi,vi;function ut(){return null==Qt&&(Qt=le.OffscreenCanvas&&new le.OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof le.createImageBitmap),Qt}nt.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const bi={now:()=>void 0!==hi?hi:le.performance.now(),setNow(C){hi=C},restoreNow(){hi=void 0},frame(C){const te=le.requestAnimationFrame(C);return{cancel:()=>le.cancelAnimationFrame(te)}},getImageData(C,te=0){const{width:ce,height:he}=C;vi||(vi=le.document.createElement("canvas"));const ue=vi.getContext("2d",{willReadFrequently:!0});if(!ue)throw new Error("failed to create canvas 2d context");return(ce>vi.width||he>vi.height)&&(vi.width=ce,vi.height=he),ue.clearRect(-te,-te,ce+2*te,he+2*te),ue.drawImage(C,0,0,ce,he),ue.getImageData(-te,-te,ce+2*te,he+2*te)},resolveURL:C=>(ri||(ri=le.document.createElement("a")),ri.href=C,ri.href),get devicePixelRatio(){return le.devicePixelRatio},get prefersReducedMotion(){return!!le.matchMedia&&(null==ni&&(ni=le.matchMedia("(prefers-reduced-motion: reduce)")),ni.matches)},hasCanvasFingerprintNoise(){if(!ut())return!1;const C=new le.OffscreenCanvas(85,1),te=C.getContext("2d",{willReadFrequently:!0});let ce=0;for(let le=0;le<C.width;++le)te.fillStyle=`rgba(${ce++},${ce++},${ce++}, 255)`,te.fillRect(le,0,1,1);const he=te.getImageData(0,0,C.width,C.height);ce=0;for(let C=0;C<he.data.length;++C)if(C%4!=3&&ce++!==he.data[C])return!0;return!1}};function pt(C,te,ce){const he=le.document.createElement(C);return void 0!==te&&(he.className=te),ce&&ce.appendChild(he),he}function ft(C,te,ce){const he=le.document.createElementNS("http://www.w3.org/2000/svg",C);for(const C of Object.keys(te))he.setAttributeNS(null,C,te[C]);return ce&&ce.appendChild(he),he}const wi=le.document&&le.document.documentElement.style,Ei=wi&&void 0!==wi.userSelect?"userSelect":"WebkitUserSelect";let Ii;function yt(){wi&&Ei&&(Ii=wi[Ei],wi[Ei]="none")}function xt(){wi&&Ei&&(wi[Ei]=Ii)}function vt(C){C.preventDefault(),C.stopPropagation(),le.removeEventListener("click",vt,!0)}function bt(){le.addEventListener("click",vt,!0),le.setTimeout((()=>{le.removeEventListener("click",vt,!0)}),0)}function wt(C,te){const le=C.getBoundingClientRect();return Mt(C,le,te)}function Tt(C,te){const le=C.getBoundingClientRect(),ce=[];for(let he=0;he<te.length;he++)ce.push(Mt(C,le,te[he]));return ce}function Et(C){return void 0!==le.InstallTrigger&&2===C.button&&C.ctrlKey&&le.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:C.button}function Mt(C,te,le){const ce=C.offsetWidth===te.width?1:C.offsetWidth/te.width;return new je((le.clientX-te.left)*ce,(le.clientY-te.top)*ce)}function At(C,te,le){le[C]&&-1!==le[C].indexOf(te)||(le[C]=le[C]||[],le[C].push(te))}function St(C,te,le){if(le&&le[C]){const ce=le[C].indexOf(te);-1!==ce&&le[C].splice(ce,1)}}class It{constructor(C,te={}){k(this,te),this.type=C}}class Ct extends It{constructor(C,te={}){super("error",k({error:C},te))}}class zt{on(C,te){return this._listeners=this._listeners||{},At(C,te,this._listeners),this}off(C,te){return St(C,te,this._listeners),St(C,te,this._oneTimeListeners),this}once(C,te){return te?(this._oneTimeListeners=this._oneTimeListeners||{},At(C,te,this._oneTimeListeners),this):new Promise((te=>this.once(C,te)))}fire(C,te){"string"==typeof C&&(C=new It(C,te||{}));const le=C.type;if(this.listens(le)){C.target=this;const te=this._listeners&&this._listeners[le]?this._listeners[le].slice():[];for(const le of te)le.call(this,C);const ce=this._oneTimeListeners&&this._oneTimeListeners[le]?this._oneTimeListeners[le].slice():[];for(const te of ce)St(le,te,this._oneTimeListeners),te.call(this,C);const he=this._eventedParent;he&&(k(C,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),he.fire(C))}else C instanceof Ct&&console.error(C.error);return this}listens(C){return!!(this._listeners&&this._listeners[C]&&this._listeners[C].length>0||this._oneTimeListeners&&this._oneTimeListeners[C]&&this._oneTimeListeners[C].length>0||this._eventedParent&&this._eventedParent.listens(C))}setEventedParent(C,te){return this._eventedParent=C,this._eventedParentData=te,this}}var zi=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"camera":{"type":"camera"},"imports":{"type":"array","value":"import"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"expression":{},"property-type":"data-constant"},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"required":true,"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","private":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-color-saturation":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","default":[0,1],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"raster-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');class Dt{constructor(C,te,le,ce){this.message=(C?`${C}: `:"")+le,ce&&(this.identifier=ce),null!=te&&te.__line__&&(this.line=te.__line__)}}class Rt extends Dt{}function Lt(C,...te){for(const le of te)for(const te in le)C[te]=le[te];return C}function kt(C){return C instanceof Number||C instanceof String||C instanceof Boolean?C.valueOf():C}function Ot(C){if(Array.isArray(C))return C.map(Ot);if(C instanceof Object&&!(C instanceof Number||C instanceof String||C instanceof Boolean)){const te={};for(const le in C)te[le]=Ot(C[le]);return te}return kt(C)}class Bt extends Error{constructor(C,te){super(te),this.message=te,this.key=C}}var Di=Bt;class Nt{constructor(C,te=[]){this.parent=C,this.bindings={};for(const[C,le]of te)this.bindings[C]=le}concat(C){return new Nt(this,C)}get(C){if(this.bindings[C])return this.bindings[C];if(this.parent)return this.parent.get(C);throw new Error(`${C} not found in scope.`)}has(C){return!!this.bindings[C]||!!this.parent&&this.parent.has(C)}}var Pi=Nt;const ki={kind:"null"},Bi={kind:"number"},Fi={kind:"string"},$i={kind:"boolean"},nr={kind:"color"},or={kind:"object"},sr={kind:"value"},ar={kind:"collator"},lr={kind:"formatted"},cr={kind:"resolvedImage"};function Kt(C,te){return{kind:"array",itemType:C,N:te}}function Jt(C){if("array"===C.kind){const te=Jt(C.itemType);return"number"==typeof C.N?`array<${te}, ${C.N}>`:"value"===C.itemType.kind?"array":`array<${te}>`}return C.kind}const ur=[ki,Bi,Fi,$i,nr,lr,or,Kt(sr),cr];function ei(C,te){if("error"===te.kind)return null;if("array"===C.kind){if("array"===te.kind&&(0===te.N&&"value"===te.itemType.kind||!ei(C.itemType,te.itemType))&&("number"!=typeof C.N||C.N===te.N))return null}else{if(C.kind===te.kind)return null;if("value"===C.kind)for(const C of ur)if(!ei(C,te))return null}return`Expected ${Jt(C)} but found ${Jt(te)} instead.`}function ti(C,te){return te.some((te=>te.kind===C.kind))}function ii(C,te){return te.some((te=>"null"===te?null===C:"array"===te?Array.isArray(C):"object"===te?C&&!Array.isArray(C)&&"object"==typeof C:te===typeof C))}var dr,Fr={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function oi(C){return(C=Math.round(C))<0?0:C>255?255:C}function si(C){return oi("%"===C[C.length-1]?parseFloat(C)/100*255:parseInt(C))}function ai(C){return(te="%"===C[C.length-1]?parseFloat(C)/100:parseFloat(C))<0?0:te>1?1:te;var te}function li(C,te,le){return le<0?le+=1:le>1&&(le-=1),6*le<1?C+(te-C)*le*6:2*le<1?te:3*le<2?C+(te-C)*(2/3-le)*6:C}try{dr={}.parseCSSColor=function(C){var te,le=C.replace(/ /g,"").toLowerCase();if(le in Fr)return Fr[le].slice();if("#"===le[0])return 4===le.length?(te=parseInt(le.substr(1),16))>=0&&te<=4095?[(3840&te)>>4|(3840&te)>>8,240&te|(240&te)>>4,15&te|(15&te)<<4,1]:null:7===le.length&&(te=parseInt(le.substr(1),16))>=0&&te<=16777215?[(16711680&te)>>16,(65280&te)>>8,255&te,1]:null;var ce=le.indexOf("("),he=le.indexOf(")");if(-1!==ce&&he+1===le.length){var ue=le.substr(0,ce),de=le.substr(ce+1,he-(ce+1)).split(","),_e=1;switch(ue){case"rgba":if(4!==de.length)return null;_e=ai(de.pop());case"rgb":return 3!==de.length?null:[si(de[0]),si(de[1]),si(de[2]),_e];case"hsla":if(4!==de.length)return null;_e=ai(de.pop());case"hsl":if(3!==de.length)return null;var ye=(parseFloat(de[0])%360+360)%360/360,ve=ai(de[1]),Se=ai(de[2]),Me=Se<=.5?Se*(ve+1):Se+ve-Se*ve,Ae=2*Se-Me;return[oi(255*li(Ae,Me,ye+1/3)),oi(255*li(Ae,Me,ye)),oi(255*li(Ae,Me,ye-1/3)),_e];default:return null}}return null}}catch(C){}class ci{constructor(C,te,le,ce=1){this.r=C,this.g=te,this.b=le,this.a=ce}static parse(C){if(!C)return;if(C instanceof ci)return C;if("string"!=typeof C)return;const te=dr(C);return te?new ci(te[0]/255*te[3],te[1]/255*te[3],te[2]/255*te[3],te[3]):void 0}toString(){const[C,te,le,ce]=this.toArray();return`rgba(${Math.round(C)},${Math.round(te)},${Math.round(le)},${ce})`}toArray(){const{r:C,g:te,b:le,a:ce}=this;return 0===ce?[0,0,0,0]:[255*C/ce,255*te/ce,255*le/ce,ce]}toArray01(){const{r:C,g:te,b:le,a:ce}=this;return 0===ce?[0,0,0,0]:[C/ce,te/ce,le/ce,ce]}toArray01Scaled(C){const{r:te,g:le,b:ce,a:he}=this;return 0===he?[0,0,0]:[te/he*C,le/he*C,ce/he*C]}toArray01PremultipliedAlpha(){const{r:C,g:te,b:le,a:ce}=this;return[C,te,le,ce]}toArray01Linear(){const{r:C,g:te,b:le,a:ce}=this;return 0===ce?[0,0,0,0]:[Math.pow(C/ce,2.2),Math.pow(te/ce,2.2),Math.pow(le/ce,2.2),ce]}}ci.black=new ci(0,0,0,1),ci.white=new ci(1,1,1,1),ci.transparent=new ci(0,0,0,0),ci.red=new ci(1,0,0,1),ci.blue=new ci(0,0,1,1);var qr=ci;class ui{constructor(C,te,le){this.sensitivity=C?te?"variant":"case":te?"accent":"base",this.locale=le,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(C,te){return this.collator.compare(C,te)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class di{constructor(C,te,le,ce,he){this.text=C.normalize?C.normalize():C,this.image=te,this.scale=le,this.fontStack=ce,this.textColor=he}}class pi{constructor(C){this.sections=C}static fromString(C){return new pi([new di(C,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some((C=>0!==C.text.length||C.image&&0!==C.image.namePrimary.length))}static factory(C){return C instanceof pi?C:pi.fromString(C)}toString(){return 0===this.sections.length?"":this.sections.map((C=>C.text)).join("")}serialize(){const C=["format"];for(const te of this.sections){if(te.image){C.push(["image",te.image.namePrimary]);continue}C.push(te.text);const le={};te.fontStack&&(le["text-font"]=["literal",te.fontStack.split(",")]),te.scale&&(le["font-scale"]=te.scale),te.textColor&&(le["text-color"]=["rgba"].concat(te.textColor.toArray())),C.push(le)}return C}}class fi{constructor(C){this.namePrimary=C.namePrimary,C.nameSecondary&&(this.nameSecondary=C.nameSecondary),this.available=C.available}toString(){return this.nameSecondary?`[${this.namePrimary},${this.nameSecondary}]`:this.namePrimary}static fromString(C,te){return C?new fi({namePrimary:C,nameSecondary:te,available:!1}):null}serialize(){return this.nameSecondary?["image",this.namePrimary,this.nameSecondary]:["image",this.namePrimary]}}function mi(C,te,le,ce){return"number"==typeof C&&C>=0&&C<=255&&"number"==typeof te&&te>=0&&te<=255&&"number"==typeof le&&le>=0&&le<=255?void 0===ce||"number"==typeof ce&&ce>=0&&ce<=1?null:`Invalid rgba value [${[C,te,le,ce].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof ce?[C,te,le,ce]:[C,te,le]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function _i(C){if(null===C)return!0;if("string"==typeof C)return!0;if("boolean"==typeof C)return!0;if("number"==typeof C)return!0;if(C instanceof qr)return!0;if(C instanceof ui)return!0;if(C instanceof pi)return!0;if(C instanceof fi)return!0;if(Array.isArray(C)){for(const te of C)if(!_i(te))return!1;return!0}if("object"==typeof C){for(const te in C)if(!_i(C[te]))return!1;return!0}return!1}function gi(C){if(null===C)return ki;if("string"==typeof C)return Fi;if("boolean"==typeof C)return $i;if("number"==typeof C)return Bi;if(C instanceof qr)return nr;if(C instanceof ui)return ar;if(C instanceof pi)return lr;if(C instanceof fi)return cr;if(Array.isArray(C)){const te=C.length;let le;for(const te of C){const C=gi(te);if(le){if(le===C)continue;le=sr;break}le=C}return Kt(le||sr,te)}return or}function yi(C){const te=typeof C;return null===C?"":"string"===te||"number"===te||"boolean"===te?String(C):C instanceof qr||C instanceof pi||C instanceof fi?C.toString():JSON.stringify(C)}class xi{constructor(C,te){this.type=C,this.value=te}static parse(C,te){if(2!==C.length)return te.error(`'literal' expression requires exactly one argument, but found ${C.length-1} instead.`);if(!_i(C[1]))return te.error("invalid value");const le=C[1];let ce=gi(le);const he=te.expectedType;return"array"!==ce.kind||0!==ce.N||!he||"array"!==he.kind||"number"==typeof he.N&&0!==he.N||(ce=he),new xi(ce,le)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof qr?["rgba"].concat(this.value.toArray()):this.value instanceof pi?this.value.serialize():this.value}}var $r=xi,Yr=class{constructor(C){this.name="ExpressionEvaluationError",this.message=C}toJSON(){return this.message}};const Qr={string:Fi,number:Bi,boolean:$i,object:or};class Ti{constructor(C,te){this.type=C,this.args=te}static parse(C,te){if(C.length<2)return te.error("Expected at least one argument.");let le,ce=1;const he=C[0];if("array"===he){let he,ue;if(C.length>2){const le=C[1];if("string"!=typeof le||!(le in Qr)||"object"===le)return te.error('The item type argument of "array" must be one of string, number, boolean',1);he=Qr[le],ce++}else he=sr;if(C.length>3){if(null!==C[2]&&("number"!=typeof C[2]||C[2]<0||C[2]!==Math.floor(C[2])))return te.error('The length argument to "array" must be a positive integer literal',2);ue=C[2],ce++}le=Kt(he,ue)}else le=Qr[he];const ue=[];for(;ce<C.length;ce++){const le=te.parse(C[ce],ce,sr);if(!le)return null;ue.push(le)}return new Ti(le,ue)}evaluate(C){for(let te=0;te<this.args.length;te++){const le=this.args[te].evaluate(C);if(!ei(this.type,gi(le)))return le;if(te===this.args.length-1)throw new Yr(`Expected value to be of type ${Jt(this.type)}, but found ${Jt(gi(le))} instead.`)}return null}eachChild(C){this.args.forEach(C)}outputDefined(){return this.args.every((C=>C.outputDefined()))}serialize(){const C=this.type,te=[C.kind];if("array"===C.kind){const le=C.itemType;if("string"===le.kind||"number"===le.kind||"boolean"===le.kind){te.push(le.kind);const ce=C.N;("number"==typeof ce||this.args.length>1)&&te.push(ce)}}return te.concat(this.args.map((C=>C.serialize())))}}var en=Ti;class Mi{constructor(C){this.type=lr,this.sections=C}static parse(C,te){if(C.length<2)return te.error("Expected at least one argument.");const le=C[1];if(!Array.isArray(le)&&"object"==typeof le)return te.error("First argument must be an image or text section.");const ce=[];let he=!1;for(let le=1;le<=C.length-1;++le){const ue=C[le];if(he&&"object"==typeof ue&&!Array.isArray(ue)){he=!1;let C=null;if(ue["font-scale"]&&(C=te.parse(ue["font-scale"],1,Bi),!C))return null;let le=null;if(ue["text-font"]&&(le=te.parse(ue["text-font"],1,Kt(Fi)),!le))return null;let de=null;if(ue["text-color"]&&(de=te.parse(ue["text-color"],1,nr),!de))return null;const _e=ce[ce.length-1];_e.scale=C,_e.font=le,_e.textColor=de}else{const ue=te.parse(C[le],1,sr);if(!ue)return null;const de=ue.type.kind;if("string"!==de&&"value"!==de&&"null"!==de&&"resolvedImage"!==de)return te.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");he=!0,ce.push({content:ue,scale:null,font:null,textColor:null})}}return new Mi(ce)}evaluate(C){return new pi(this.sections.map((te=>{const le=te.content.evaluate(C);return gi(le)===cr?new di("",le,null,null,null):new di(yi(le),null,te.scale?te.scale.evaluate(C):null,te.font?te.font.evaluate(C).join(","):null,te.textColor?te.textColor.evaluate(C):null)})))}eachChild(C){for(const te of this.sections)C(te.content),te.scale&&C(te.scale),te.font&&C(te.font),te.textColor&&C(te.textColor)}outputDefined(){return!1}serialize(){const C=["format"];for(const te of this.sections){C.push(te.content.serialize());const le={};te.scale&&(le["font-scale"]=te.scale.serialize()),te.font&&(le["text-font"]=te.font.serialize()),te.textColor&&(le["text-color"]=te.textColor.serialize()),C.push(le)}return C}}class Ai{constructor(C,te){this.type=cr,this.inputPrimary=C,this.inputSecondary=te}static parse(C,te){if(C.length<2)return te.error("Expected two or more arguments.");const le=te.parse(C[1],1,Fi);if(!le)return te.error("No image name provided.");if(2===C.length)return new Ai(le);const ce=te.parse(C[2],1,Fi);return ce?new Ai(le,ce):te.error("Secondary image variant is not a string.")}evaluate(C){const te=fi.fromString(this.inputPrimary.evaluate(C),this.inputSecondary?this.inputSecondary.evaluate(C):void 0);return te&&C.availableImages&&(te.available=C.availableImages.indexOf(te.namePrimary)>-1,te.nameSecondary&&te.available&&C.availableImages&&(te.available=C.availableImages.indexOf(te.nameSecondary)>-1)),te}eachChild(C){C(this.inputPrimary),this.inputSecondary&&C(this.inputSecondary)}outputDefined(){return!1}serialize(){return this.inputSecondary?["image",this.inputPrimary.serialize(),this.inputSecondary.serialize()]:["image",this.inputPrimary.serialize()]}}function Si(C){return C instanceof Number?"number":C instanceof String?"string":C instanceof Boolean?"boolean":Array.isArray(C)?"array":null===C?"null":typeof C}const tn={"to-boolean":$i,"to-color":nr,"to-number":Bi,"to-string":Fi};class Ci{constructor(C,te){this.type=C,this.args=te}static parse(C,te){if(C.length<2)return te.error("Expected at least one argument.");const le=C[0],ce=[];let he=ki;if("to-array"===le){if(!Array.isArray(C[1]))return null;const le=C[1].length;if(te.expectedType){if("array"!==te.expectedType.kind)return te.error(`Expected ${te.expectedType.kind} but found array.`);he=Kt(te.expectedType.itemType,le)}else{if(!(le>0&&_i(C[1][0])))return null;he=Kt(gi(C[1][0]),le)}for(let ue=0;ue<le;ue++){const le=C[1][ue];let de;if("array"===Si(le))de=te.parse(le,void 0,he.itemType);else{const C=Si(le);if(C!==he.itemType.kind)return te.error(`Expected ${he.itemType.kind} but found ${C}.`);de=te.registry.literal.parse(["literal",void 0===le?null:le],te)}if(!de)return null;ce.push(de)}}else{if(("to-boolean"===le||"to-string"===le)&&2!==C.length)return te.error("Expected one argument.");he=tn[le];for(let le=1;le<C.length;le++){const he=te.parse(C[le],le,sr);if(!he)return null;ce.push(he)}}return new Ci(he,ce)}evaluate(C){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(C));if("color"===this.type.kind){let te,le;for(const ce of this.args){if(te=ce.evaluate(C),le=null,te instanceof qr)return te;if("string"==typeof te){const le=C.parseColor(te);if(le)return le}else if(Array.isArray(te)&&(le=te.length<3||te.length>4?`Invalid rbga value ${JSON.stringify(te)}: expected an array containing either three or four numeric values.`:mi(te[0],te[1],te[2],te[3]),!le))return new qr(te[0]/255,te[1]/255,te[2]/255,te[3])}throw new Yr(le||`Could not parse color from value '${"string"==typeof te?te:String(JSON.stringify(te))}'`)}if("number"===this.type.kind){let te=null;for(const le of this.args){if(te=le.evaluate(C),null===te)return 0;const ce=Number(te);if(!isNaN(ce))return ce}throw new Yr(`Could not convert ${JSON.stringify(te)} to number.`)}return"formatted"===this.type.kind?pi.fromString(yi(this.args[0].evaluate(C))):"resolvedImage"===this.type.kind?fi.fromString(yi(this.args[0].evaluate(C))):"array"===this.type.kind?this.args.map((te=>te.evaluate(C))):yi(this.args[0].evaluate(C))}eachChild(C){this.args.forEach(C)}outputDefined(){return this.args.every((C=>C.outputDefined()))}serialize(){if("formatted"===this.type.kind)return new Mi([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new Ai(this.args[0]).serialize();const C="array"===this.type.kind?[]:[`to-${this.type.kind}`];return this.eachChild((te=>{C.push(te.serialize())})),C}}var rn=Ci;const nn=["Unknown","Point","LineString","Polygon"];var on=class{constructor(C){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.options=C}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?nn[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(C){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const C=this.featureDistanceData.center,te=this.featureDistanceData.scale,{x:le,y:ce}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(le*te-C[0])+this.featureDistanceData.bearing[1]*(ce*te-C[1])}return 0}parseColor(C){let te=this._parseColorCache[C];return te||(te=this._parseColorCache[C]=qr.parse(C)),te}getConfig(C){return this.options?this.options.get(C):null}};class Ri{constructor(C,te,le,ce,he){this.name=C,this.type=te,this._evaluate=le,this.args=ce,this._overloadIndex=he}evaluate(C){if(!this._evaluate){const C=Ri.definitions[this.name];this._evaluate=Array.isArray(C)?C[2]:C.overloads[this._overloadIndex][1]}return this._evaluate(C,this.args)}eachChild(C){this.args.forEach(C)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map((C=>C.serialize())))}static parse(C,te){const le=C[0],ce=Ri.definitions[le];if(!ce)return te.error(`Unknown expression "${le}". If you wanted a literal array, use ["literal", [...]].`,0);const he=Array.isArray(ce)?ce[0]:ce.type,ue=Array.isArray(ce)?[[ce[1],ce[2]]]:ce.overloads,de=[];let _e=null,ye=-1;for(const[ce,ve]of ue){if(Array.isArray(ce)&&ce.length!==C.length-1)continue;de.push(ce),ye++,_e=new Bn(te.registry,te.path,null,te.scope,void 0,te.options);const ue=[];let Se=!1;for(let te=1;te<C.length;te++){const le=C[te],he=Array.isArray(ce)?ce[te-1]:ce.type,de=_e.parse(le,1+ue.length,he);if(!de){Se=!0;break}ue.push(de)}if(!Se)if(Array.isArray(ce)&&ce.length!==ue.length)_e.error(`Expected ${ce.length} arguments, but found ${ue.length} instead.`);else{for(let C=0;C<ue.length;C++){const te=Array.isArray(ce)?ce[C]:ce.type,le=ue[C];_e.concat(C+1).checkSubtype(te,le.type)}if(0===_e.errors.length)return new Ri(le,he,ve,ue,ye)}}if(1===de.length)te.errors.push(..._e.errors);else{const le=(de.length?de:ue.map((([C])=>C))).map(Li).join(" | "),ce=[];for(let le=1;le<C.length;le++){const he=te.parse(C[le],1+ce.length);if(!he)return null;ce.push(Jt(he.type))}te.error(`Expected arguments of type ${le}, but found (${ce.join(", ")}) instead.`)}return null}static register(C,te){Ri.definitions=te;for(const le in te)C[le]=Ri}}function Li(C){return Array.isArray(C)?`(${C.map(Jt).join(", ")})`:`(${Jt(C.type)}...)`}var sn=Ri;class Oi{constructor(C,te,le){this.type=ar,this.locale=le,this.caseSensitive=C,this.diacriticSensitive=te}static parse(C,te){if(2!==C.length)return te.error("Expected one argument.");const le=C[1];if("object"!=typeof le||Array.isArray(le))return te.error("Collator options argument must be an object.");const ce=te.parse(void 0!==le["case-sensitive"]&&le["case-sensitive"],1,$i);if(!ce)return null;const he=te.parse(void 0!==le["diacritic-sensitive"]&&le["diacritic-sensitive"],1,$i);if(!he)return null;let ue=null;return le.locale&&(ue=te.parse(le.locale,1,Fi),!ue)?null:new Oi(ce,he,ue)}evaluate(C){return new ui(this.caseSensitive.evaluate(C),this.diacriticSensitive.evaluate(C),this.locale?this.locale.evaluate(C):null)}eachChild(C){C(this.caseSensitive),C(this.diacriticSensitive),this.locale&&C(this.locale)}outputDefined(){return!1}serialize(){const C={};return C["case-sensitive"]=this.caseSensitive.serialize(),C["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(C.locale=this.locale.serialize()),["collator",C]}}var an={exports:{}};an.exports=function(){function e(C,te,le,ce,he){for(;ce>le;){if(ce-le>600){var ue=ce-le+1,de=te-le+1,_e=Math.log(ue),ye=.5*Math.exp(2*_e/3),ve=.5*Math.sqrt(_e*ye*(ue-ye)/ue)*(de-ue/2<0?-1:1);e(C,te,Math.max(le,Math.floor(te-de*ye/ue+ve)),Math.min(ce,Math.floor(te+(ue-de)*ye/ue+ve)),he)}var Se=C[te],Me=le,Ae=ce;for(t(C,le,te),he(C[ce],Se)>0&&t(C,le,ce);Me<Ae;){for(t(C,Me,Ae),Me++,Ae--;he(C[Me],Se)<0;)Me++;for(;he(C[Ae],Se)>0;)Ae--}0===he(C[le],Se)?t(C,le,Ae):t(C,++Ae,ce),Ae<=te&&(le=Ae+1),te<=Ae&&(ce=Ae-1)}}function t(C,te,le){var ce=C[te];C[te]=C[le],C[le]=ce}function i(C,te){return C<te?-1:C>te?1:0}return function(C,te,le,ce,he){e(C,te,le||0,ce||C.length-1,he||i)}}();var ln=d(an.exports);function Ni(C){let te=0;for(let le,ce,he=0,ue=C.length,de=ue-1;he<ue;de=he++)le=C[he],ce=C[de],te+=(ce.x-le.x)*(le.y+ce.y);return te}function Ui(C,te){C[0]=Math.min(C[0],te[0]),C[1]=Math.min(C[1],te[1]),C[2]=Math.max(C[2],te[0]),C[3]=Math.max(C[3],te[1])}function Vi(C,te){return!(C[0]<=te[0]||C[2]>=te[2]||C[1]<=te[1]||C[3]>=te[3])}function ji(C,te,le){const ce=C[0]-te[0],he=C[1]-te[1],ue=C[0]-le[0],de=C[1]-le[1];return ce*de-ue*he==0&&ce*ue<=0&&he*de<=0}function Gi(C,te,le=!1){let ce=!1;for(let _e=0,ye=te.length;_e<ye;_e++){const ye=te[_e];for(let te=0,_e=ye.length,ve=_e-1;te<_e;ve=te++){const _e=ye[ve],Se=ye[te];if(ji(C,_e,Se))return le;(ue=_e)[1]>(he=C)[1]!=(de=Se)[1]>he[1]&&he[0]<(de[0]-ue[0])*(he[1]-ue[1])/(de[1]-ue[1])+ue[0]&&(ce=!ce)}}var he,ue,de;return ce}function qi(C,te,le,ce){const he=ce[0]-le[0],ue=ce[1]-le[1],de=(C[0]-le[0])*ue-he*(C[1]-le[1]),_e=(te[0]-le[0])*ue-he*(te[1]-le[1]);return de>0&&_e<0||de<0&&_e>0}function Zi(C,te,le,ce){return 0!=(he=[ce[0]-le[0],ce[1]-le[1]])[0]*(ue=[te[0]-C[0],te[1]-C[1]])[1]-he[1]*ue[0]&&!(!qi(C,te,le,ce)||!qi(le,ce,C,te));var he,ue}const _n=8192;function Wi(C,te){const le=(180+C[0])/360,ce=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+C[1]*Math.PI/360)))/360,he=Math.pow(2,te.z);return[Math.round(le*he*_n),Math.round(ce*he*_n)]}function Hi(C,te){for(let le=0;le<te.length;le++)if(Gi(C,te[le]))return!0;return!1}function Xi(C,te,le){for(const ce of le)for(let le=0,he=ce.length,ue=he-1;le<he;ue=le++)if(Zi(C,te,ce[ue],ce[le]))return!0;return!1}function Yi(C,te){for(let le=0;le<C.length;++le)if(!Gi(C[le],te))return!1;for(let le=0;le<C.length-1;++le)if(Xi(C[le],C[le+1],te))return!1;return!0}function Ki(C,te){for(let le=0;le<te.length;le++)if(Yi(C,te[le]))return!0;return!1}function Ji(C,te,le){const ce=[];for(let he=0;he<C.length;he++){const ue=[];for(let ce=0;ce<C[he].length;ce++){const de=Wi(C[he][ce],le);Ui(te,de),ue.push(de)}ce.push(ue)}return ce}function Qi(C,te,le){const ce=[];for(let he=0;he<C.length;he++){const ue=Ji(C[he],te,le);ce.push(ue)}return ce}function er(C,te,le,ce){if(C[0]<le[0]||C[0]>le[2]){const te=.5*ce;let he=C[0]-le[0]>te?-ce:le[0]-C[0]>te?ce:0;0===he&&(he=C[0]-le[2]>te?-ce:le[2]-C[0]>te?ce:0),C[0]+=he}Ui(te,C)}function tr(C,te,le,ce){const he=Math.pow(2,ce.z)*_n,ue=[ce.x*_n,ce.y*_n],de=[];if(!C)return de;for(const ce of C)for(const C of ce){const ce=[C.x+ue[0],C.y+ue[1]];er(ce,te,le,he),de.push(ce)}return de}function ir(C,te,le,ce){const he=Math.pow(2,ce.z)*_n,ue=[ce.x*_n,ce.y*_n],de=[];if(!C)return de;for(const le of C){const C=[];for(const ce of le){const le=[ce.x+ue[0],ce.y+ue[1]];Ui(te,le),C.push(le)}de.push(C)}if(te[2]-te[0]<=he/2){(_e=te)[0]=_e[1]=1/0,_e[2]=_e[3]=-1/0;for(const C of de)for(const ce of C)er(ce,te,le,he)}var _e;return de}class rr{constructor(C,te){this.type=$i,this.geojson=C,this.geometries=te}static parse(C,te){if(2!==C.length)return te.error(`'within' expression requires exactly one argument, but found ${C.length-1} instead.`);if(_i(C[1])){const te=C[1];if("FeatureCollection"===te.type)for(let C=0;C<te.features.length;++C){const le=te.features[C].geometry.type;if("Polygon"===le||"MultiPolygon"===le)return new rr(te,te.features[C].geometry)}else if("Feature"===te.type){const C=te.geometry.type;if("Polygon"===C||"MultiPolygon"===C)return new rr(te,te.geometry)}else if("Polygon"===te.type||"MultiPolygon"===te.type)return new rr(te,te)}return te.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(C){if(null!=C.geometry()&&null!=C.canonicalID()){if("Point"===C.geometryType())return function(C,te){const le=[1/0,1/0,-1/0,-1/0],ce=[1/0,1/0,-1/0,-1/0],he=C.canonicalID();if(!he)return!1;if("Polygon"===te.type){const ue=Ji(te.coordinates,ce,he),de=tr(C.geometry(),le,ce,he);if(!Vi(le,ce))return!1;for(const C of de)if(!Gi(C,ue))return!1}if("MultiPolygon"===te.type){const ue=Qi(te.coordinates,ce,he),de=tr(C.geometry(),le,ce,he);if(!Vi(le,ce))return!1;for(const C of de)if(!Hi(C,ue))return!1}return!0}(C,this.geometries);if("LineString"===C.geometryType())return function(C,te){const le=[1/0,1/0,-1/0,-1/0],ce=[1/0,1/0,-1/0,-1/0],he=C.canonicalID();if(!he)return!1;if("Polygon"===te.type){const ue=Ji(te.coordinates,ce,he),de=ir(C.geometry(),le,ce,he);if(!Vi(le,ce))return!1;for(const C of de)if(!Yi(C,ue))return!1}if("MultiPolygon"===te.type){const ue=Qi(te.coordinates,ce,he),de=ir(C.geometry(),le,ce,he);if(!Vi(le,ce))return!1;for(const C of de)if(!Ki(C,ue))return!1}return!0}(C,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}var gn=rr,yn={exports:{}};yn.exports=function(){var C={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},le=1/298.257223563,ce=le*(2-le),he=Math.PI/180,n=function(le,ue){if(void 0===le)throw new Error("No latitude given.");if(ue&&!C[ue])throw new Error("Unknown unit "+ue+". Use one of: "+Object.keys(C).join(", "));var de=6378.137*he*(ue?C[ue]:1),_e=Math.cos(le*he),ye=1/(1-ce*(1-_e*_e)),ve=Math.sqrt(ye);(this||te).kx=de*ve*_e,(this||te).ky=de*ve*ye*(1-ce)},ue={units:{configurable:!0}};function s(C,te){return C[0]===te[0]&&C[1]===te[1]}function a(C,te,le){var ce=l(te[0]-C[0]);return[C[0]+ce*le,C[1]+(te[1]-C[1])*le]}function l(C){for(;C<-180;)C+=360;for(;C>180;)C-=360;return C}return n.fromTile=function(C,te,le){var ce=Math.PI*(1-2*(C+.5)/Math.pow(2,te)),ue=Math.atan(.5*(Math.exp(ce)-Math.exp(-ce)))/he;return new n(ue,le)},ue.units.get=function(){return C},n.prototype.distance=function(C,le){var ce=l(C[0]-le[0])*(this||te).kx,he=(C[1]-le[1])*(this||te).ky;return Math.sqrt(ce*ce+he*he)},n.prototype.bearing=function(C,le){var ce=l(le[0]-C[0])*(this||te).kx;return Math.atan2(ce,(le[1]-C[1])*(this||te).ky)/he},n.prototype.destination=function(C,te,le){var ce=le*he;return this.offset(C,Math.sin(ce)*te,Math.cos(ce)*te)},n.prototype.offset=function(C,le,ce){return[C[0]+le/(this||te).kx,C[1]+ce/(this||te).ky]},n.prototype.lineDistance=function(C){for(var te=0,le=0;le<C.length-1;le++)te+=this.distance(C[le],C[le+1]);return te},n.prototype.area=function(C){for(var le=0,ce=0;ce<C.length;ce++)for(var he=C[ce],ue=0,de=he.length,_e=de-1;ue<de;_e=ue++)le+=l(he[ue][0]-he[_e][0])*(he[ue][1]+he[_e][1])*(ce?-1:1);return Math.abs(le)/2*(this||te).kx*(this||te).ky},n.prototype.along=function(C,te){var le=0;if(te<=0)return C[0];for(var ce=0;ce<C.length-1;ce++){var he=C[ce],ue=C[ce+1],de=this.distance(he,ue);if((le+=de)>te)return a(he,ue,(te-(le-de))/de)}return C[C.length-1]},n.prototype.pointToSegmentDistance=function(C,le,ce){var he=le[0],ue=le[1],de=l(ce[0]-he)*(this||te).kx,_e=(ce[1]-ue)*(this||te).ky,ye=0;return 0===de&&0===_e||((ye=(l(C[0]-he)*(this||te).kx*de+(C[1]-ue)*(this||te).ky*_e)/(de*de+_e*_e))>1?(he=ce[0],ue=ce[1]):ye>0&&(he+=de/(this||te).kx*ye,ue+=_e/(this||te).ky*ye)),de=l(C[0]-he)*(this||te).kx,_e=(C[1]-ue)*(this||te).ky,Math.sqrt(de*de+_e*_e)},n.prototype.pointOnLine=function(C,le){for(var ce,he,ue,de,_e=1/0,ye=0;ye<C.length-1;ye++){var ve=C[ye][0],Se=C[ye][1],Me=l(C[ye+1][0]-ve)*(this||te).kx,Ae=(C[ye+1][1]-Se)*(this||te).ky,Ce=0;0===Me&&0===Ae||((Ce=(l(le[0]-ve)*(this||te).kx*Me+(le[1]-Se)*(this||te).ky*Ae)/(Me*Me+Ae*Ae))>1?(ve=C[ye+1][0],Se=C[ye+1][1]):Ce>0&&(ve+=Me/(this||te).kx*Ce,Se+=Ae/(this||te).ky*Ce));var Oe=(Me=l(le[0]-ve)*(this||te).kx)*Me+(Ae=(le[1]-Se)*(this||te).ky)*Ae;Oe<_e&&(_e=Oe,ce=ve,he=Se,ue=ye,de=Ce)}return{point:[ce,he],index:ue,t:Math.max(0,Math.min(1,de))}},n.prototype.lineSlice=function(C,te,le){var ce=this.pointOnLine(le,C),he=this.pointOnLine(le,te);if(ce.index>he.index||ce.index===he.index&&ce.t>he.t){var ue=ce;ce=he,he=ue}var de=[ce.point],_e=ce.index+1,ye=he.index;!s(le[_e],de[0])&&_e<=ye&&de.push(le[_e]);for(var ve=_e+1;ve<=ye;ve++)de.push(le[ve]);return s(le[ye],he.point)||de.push(he.point),de},n.prototype.lineSliceAlong=function(C,te,le){for(var ce=0,he=[],ue=0;ue<le.length-1;ue++){var de=le[ue],_e=le[ue+1],ye=this.distance(de,_e);if((ce+=ye)>C&&0===he.length&&he.push(a(de,_e,(C-(ce-ye))/ye)),ce>=te)return he.push(a(de,_e,(te-(ce-ye))/ye)),he;ce>C&&he.push(_e)}return he},n.prototype.bufferPoint=function(C,le){var ce=le/(this||te).ky,he=le/(this||te).kx;return[C[0]-he,C[1]-ce,C[0]+he,C[1]+ce]},n.prototype.bufferBBox=function(C,le){var ce=le/(this||te).ky,he=le/(this||te).kx;return[C[0]-he,C[1]-ce,C[2]+he,C[3]+ce]},n.prototype.insideBBox=function(C,te){return l(C[0]-te[0])>=0&&l(C[0]-te[2])<=0&&C[1]>=te[1]&&C[1]<=te[3]},Object.defineProperties(n,ue),n}();var bn=d(yn.exports),Tn={exports:{}};Tn.exports=function(){var e=function(C,le){if(void 0===C&&(C=[]),void 0===le&&(le=t),(this||te).data=C,(this||te).length=(this||te).data.length,(this||te).compare=le,(this||te).length>0)for(var ce=((this||te).length>>1)-1;ce>=0;ce--)this._down(ce)};function t(C,te){return C<te?-1:C>te?1:0}return e.prototype.push=function(C){(this||te).data.push(C),(this||te).length++,this._up((this||te).length-1)},e.prototype.pop=function(){if(0!==(this||te).length){var C=(this||te).data[0],le=(this||te).data.pop();return(this||te).length--,(this||te).length>0&&((this||te).data[0]=le,this._down(0)),C}},e.prototype.peek=function(){return(this||te).data[0]},e.prototype._up=function(C){for(var le=(this||te).data,ce=(this||te).compare,he=le[C];C>0;){var ue=C-1>>1,de=le[ue];if(ce(he,de)>=0)break;le[C]=de,C=ue}le[C]=he},e.prototype._down=function(C){for(var le=(this||te).data,ce=(this||te).compare,he=(this||te).length>>1,ue=le[C];C<he;){var de=1+(C<<1),_e=le[de],ye=de+1;if(ye<(this||te).length&&ce(le[ye],_e)<0&&(de=ye,_e=le[ye]),ce(_e,ue)>=0)break;le[C]=_e,C=de}le[C]=ue},e}();var Sn=d(Tn.exports),Mn=8192;function hr(C,te){return te.dist-C.dist}const Cn=100,Pn=50;function pr(C){const te=[1/0,1/0,-1/0,-1/0];if(te.length!==C.length)return!1;for(let le=0;le<te.length;le++)if(te[le]!==C[le])return!1;return!0}function fr(C){return C[1]-C[0]+1}function mr(C,te){const le=C[1]>=C[0]&&C[1]<te;return le||console.warn("Distance Expression: Index is out of range"),le}function _r(C,te){if(C[0]>C[1])return[null,null];const le=fr(C);if(te){if(2===le)return[C,null];const te=Math.floor(le/2);return[[C[0],C[0]+te],[C[0]+te,C[1]]]}{if(1===le)return[C,null];const te=Math.floor(le/2)-1;return[[C[0],C[0]+te],[C[0]+te+1,C[1]]]}}function gr(C,te){const le=[1/0,1/0,-1/0,-1/0];if(!mr(te,C.length))return le;for(let ce=te[0];ce<=te[1];++ce)Ui(le,C[ce]);return le}function yr(C){const te=[1/0,1/0,-1/0,-1/0];for(let le=0;le<C.length;++le)for(let ce=0;ce<C[le].length;++ce)Ui(te,C[le][ce]);return te}function xr(C,te,le){if(pr(C)||pr(te))return NaN;let ce=0,he=0;return C[2]<te[0]&&(ce=te[0]-C[2]),C[0]>te[2]&&(ce=C[0]-te[2]),C[1]>te[3]&&(he=C[1]-te[3]),C[3]<te[1]&&(he=te[1]-C[3]),le.distance([0,0],[ce,he])}function vr(C,te){const le=Math.pow(2,te.z);return[(he=(C.x/Mn+te.x)/le,360*he-180),(ce=(C.y/Mn+te.y)/le,360/Math.PI*Math.atan(Math.exp((180-360*ce)*Math.PI/180))-90)];var ce,he}function br(C,te){const le=[];for(let ce=0;ce<C.length;++ce)le.push(vr(C[ce],te));return le}function wr(C,te,le){const ce=le.pointOnLine(te,C).point;return le.distance(C,ce)}function Tr(C,te,le,ce,he){const ue=le.slice(ce[0],ce[1]+1);let de=1/0;for(let le=te[0];le<=te[1];++le)if(0===(de=Math.min(de,wr(C[le],ue,he))))return 0;return de}function Er(C,te,le,ce,he){const ue=Math.min(he.pointToSegmentDistance(C,le,ce),he.pointToSegmentDistance(te,le,ce)),de=Math.min(he.pointToSegmentDistance(le,C,te),he.pointToSegmentDistance(ce,C,te));return Math.min(ue,de)}function Mr(C,te,le,ce,he){if(!mr(te,C.length)||!mr(ce,le.length))return NaN;let ue=1/0;for(let de=te[0];de<te[1];++de)for(let te=ce[0];te<ce[1];++te){if(Zi(C[de],C[de+1],le[te],le[te+1]))return 0;ue=Math.min(ue,Er(C[de],C[de+1],le[te],le[te+1],he))}return ue}function Ar(C,te,le,ce,he){if(!mr(te,C.length)||!mr(ce,le.length))return NaN;let ue=1/0;for(let de=te[0];de<=te[1];++de)for(let te=ce[0];te<=ce[1];++te)if(0===(ue=Math.min(ue,he.distance(C[de],le[te]))))return ue;return ue}function Sr(C,te,le){if(Gi(C,te,!0))return 0;let ce=1/0;for(const he of te){const te=he.length;if(te<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(he[0]!==he[te-1]&&0===(ce=Math.min(ce,le.pointToSegmentDistance(C,he[te-1],he[0]))))return ce;if(0===(ce=Math.min(ce,wr(C,he,le))))return ce}return ce}function Ir(C,te,le,ce){if(!mr(te,C.length))return NaN;for(let ce=te[0];ce<=te[1];++ce)if(Gi(C[ce],le,!0))return 0;let he=1/0;for(let ue=te[0];ue<te[1];++ue)for(const te of le)for(let le=0,de=te.length,_e=de-1;le<de;_e=le++){if(Zi(C[ue],C[ue+1],te[_e],te[le]))return 0;he=Math.min(he,Er(C[ue],C[ue+1],te[_e],te[le],ce))}return he}function Cr(C,te){for(const le of C)for(let C=0;C<=le.length-1;++C)if(Gi(le[C],te,!0))return!0;return!1}function zr(C,te,le,ce=1/0){const he=yr(C),ue=yr(te);if(ce!==1/0&&xr(he,ue,le)>=ce)return ce;if(Vi(he,ue)){if(Cr(C,te))return 0}else if(Cr(te,C))return 0;let de=ce;for(const ce of C)for(let C=0,he=ce.length,ue=he-1;C<he;ue=C++)for(const he of te)for(let te=0,_e=he.length,ye=_e-1;te<_e;ye=te++){if(Zi(ce[ue],ce[C],he[ye],he[te]))return 0;de=Math.min(de,Er(ce[ue],ce[C],he[ye],he[te],le))}return de}function Pr(C,te,le,ce,he,ue,de){if(null===ue||null===de)return;const _e=xr(gr(ce,ue),gr(he,de),le);_e<te&&C.push({dist:_e,range1:ue,range2:de})}function Dr(C,te,le,ce,he=1/0){let ue=Math.min(ce.distance(C[0],le[0][0]),he);if(0===ue)return ue;const de=new Sn([{dist:0,range1:[0,C.length-1],range2:[0,0]}],hr),_e=te?Pn:Cn,ye=yr(le);for(;de.length;){const he=de.pop();if(he.dist>=ue)continue;const ve=he.range1;if(fr(ve)<=_e){if(!mr(ve,C.length))return NaN;if(te){const te=Ir(C,ve,le,ce);if(0===(ue=Math.min(ue,te)))return ue}else for(let te=ve[0];te<=ve[1];++te){const he=Sr(C[te],le,ce);if(0===(ue=Math.min(ue,he)))return ue}}else{const le=_r(ve,te);if(null!==le[0]){const te=xr(gr(C,le[0]),ye,ce);te<ue&&de.push({dist:te,range1:le[0],range2:[0,0]})}if(null!==le[1]){const te=xr(gr(C,le[1]),ye,ce);te<ue&&de.push({dist:te,range1:le[1],range2:[0,0]})}}}return ue}function Rr(C,te,le,ce,he,ue=1/0){let de=Math.min(ue,he.distance(C[0],le[0]));if(0===de)return de;const _e=new Sn([{dist:0,range1:[0,C.length-1],range2:[0,le.length-1]}],hr),ye=te?Pn:Cn,ve=ce?Pn:Cn;for(;_e.length;){const ue=_e.pop();if(ue.dist>=de)continue;const Se=ue.range1,Me=ue.range2;if(fr(Se)<=ye&&fr(Me)<=ve){if(!mr(Se,C.length)||!mr(Me,le.length))return NaN;if(te&&ce?de=Math.min(de,Mr(C,Se,le,Me,he)):te||ce?te&&!ce?de=Math.min(de,Tr(le,Me,C,Se,he)):!te&&ce&&(de=Math.min(de,Tr(C,Se,le,Me,he))):de=Math.min(de,Ar(C,Se,le,Me,he)),0===de)return de}else{const ue=_r(Se,te),ye=_r(Me,ce);Pr(_e,de,he,C,le,ue[0],ye[0]),Pr(_e,de,he,C,le,ue[0],ye[1]),Pr(_e,de,he,C,le,ue[1],ye[0]),Pr(_e,de,he,C,le,ue[1],ye[1])}}return de}function Lr(C,te,le,ce,he=1/0){let ue=he;const de=gr(C,[0,C.length-1]);for(const he of le)if(!(ue!==1/0&&xr(de,gr(he,[0,he.length-1]),ce)>=ue)&&(ue=Math.min(ue,Rr(C,te,he,!0,ce,ue)),0===ue))return ue;return ue}function kr(C,te,le,ce,he=1/0){let ue=he;const de=gr(C,[0,C.length-1]);for(const he of le){if(ue!==1/0&&xr(de,yr(he),ce)>=ue)continue;const le=Dr(C,te,he,ce,ue);if(isNaN(le))return le;if(0===(ue=Math.min(ue,le)))return ue}return ue}function Or(C){return"Point"===C||"MultiPoint"===C||"LineString"===C||"MultiLineString"===C||"Polygon"===C||"MultiPolygon"===C}class Br{constructor(C,te){this.type=Bi,this.geojson=C,this.geometries=te}static parse(C,te){if(2!==C.length)return te.error(`'distance' expression requires either one argument, but found ' ${C.length-1} instead.`);if(_i(C[1])){const te=C[1];if("FeatureCollection"===te.type){for(let C=0;C<te.features.length;++C)if(Or(te.features[C].geometry.type))return new Br(te,te.features[C].geometry)}else if("Feature"===te.type){if(Or(te.geometry.type))return new Br(te,te.geometry)}else if(Or(te.type))return new Br(te,te)}return te.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(C){const te=C.geometry(),le=C.canonicalID();if(null!=te&&null!=le){if("Point"===C.geometryType())return function(C,te,le){const ce=[];for(const le of C)for(const C of le)ce.push(vr(C,te));const he=new bn(ce[0][1],"meters");return"Point"===le.type||"MultiPoint"===le.type||"LineString"===le.type?Rr(ce,!1,"Point"===le.type?[le.coordinates]:le.coordinates,"LineString"===le.type,he):"MultiLineString"===le.type?Lr(ce,!1,le.coordinates,he):"Polygon"===le.type||"MultiPolygon"===le.type?kr(ce,!1,"Polygon"===le.type?[le.coordinates]:le.coordinates,he):null}(te,le,this.geometries);if("LineString"===C.geometryType())return function(C,te,le){const ce=[];for(const le of C){const C=[];for(const ce of le)C.push(vr(ce,te));ce.push(C)}const he=new bn(ce[0][0][1],"meters");if("Point"===le.type||"MultiPoint"===le.type||"LineString"===le.type)return Lr("Point"===le.type?[le.coordinates]:le.coordinates,"LineString"===le.type,ce,he);if("MultiLineString"===le.type){let C=1/0;for(let te=0;te<le.coordinates.length;te++){const ue=Lr(le.coordinates[te],!0,ce,he,C);if(isNaN(ue))return ue;if(0===(C=Math.min(C,ue)))return C}return C}if("Polygon"===le.type||"MultiPolygon"===le.type){let C=1/0;for(let te=0;te<ce.length;te++){const ue=kr(ce[te],!0,"Polygon"===le.type?[le.coordinates]:le.coordinates,he,C);if(isNaN(ue))return ue;if(0===(C=Math.min(C,ue)))return C}return C}return null}(te,le,this.geometries);if("Polygon"===C.geometryType())return function(C,te,le){const ce=[];for(const le of function(C,te){const le=C.length;if(le<=1)return[C];const ce=[];let he,ue;for(let te=0;te<le;te++){const le=Ni(C[te]);0!==le&&(C[te].area=Math.abs(le),void 0===ue&&(ue=le<0),ue===le<0?(he&&ce.push(he),he=[C[te]]):he.push(C[te]))}return he&&ce.push(he),ce}(C)){const C=[];for(let ce=0;ce<le.length;++ce)C.push(br(le[ce],te));ce.push(C)}const he=new bn(ce[0][0][0][1],"meters");if("Point"===le.type||"MultiPoint"===le.type||"LineString"===le.type)return kr("Point"===le.type?[le.coordinates]:le.coordinates,"LineString"===le.type,ce,he);if("MultiLineString"===le.type){let C=1/0;for(let te=0;te<le.coordinates.length;te++){const ue=kr(le.coordinates[te],!0,ce,he,C);if(isNaN(ue))return ue;if(0===(C=Math.min(C,ue)))return C}return C}return"Polygon"===le.type||"MultiPolygon"===le.type?function(C,te,le){let ce=1/0;for(const he of C)for(const C of te){const te=zr(he,C,le,ce);if(isNaN(te))return te;if(0===(ce=Math.min(ce,te)))return ce}return ce}("Polygon"===le.type?[le.coordinates]:le.coordinates,ce,he):null}(te,le,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}var Rn=Br;function Nr(C){if(C instanceof sn){if("get"===C.name&&1===C.args.length)return!1;if("feature-state"===C.name)return!1;if("has"===C.name&&1===C.args.length)return!1;if("properties"===C.name||"geometry-type"===C.name||"id"===C.name)return!1;if(/^filter-/.test(C.name))return!1}if(C instanceof gn)return!1;if(C instanceof Rn)return!1;let te=!0;return C.eachChild((C=>{te&&!Nr(C)&&(te=!1)})),te}function Ur(C){if(C instanceof sn&&"feature-state"===C.name)return!1;let te=!0;return C.eachChild((C=>{te&&!Ur(C)&&(te=!1)})),te}function Vr(C){if(C instanceof sn&&"config"===C.name)return!1;let te=!0;return C.eachChild((C=>{te&&!Vr(C)&&(te=!1)})),te}function jr(C,te){if(C instanceof sn&&te.indexOf(C.name)>=0)return!1;let le=!0;return C.eachChild((C=>{le&&!jr(C,te)&&(le=!1)})),le}class Gr{constructor(C,te){this.type=te.type,this.name=C,this.boundExpression=te}static parse(C,te){if(2!==C.length||"string"!=typeof C[1])return te.error("'var' expression requires exactly one string literal argument.");const le=C[1];return te.scope.has(le)?new Gr(le,te.scope.get(le)):te.error(`Unknown variable "${le}". Make sure "${le}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(C){return this.boundExpression.evaluate(C)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}var kn=Gr;class Zr{constructor(C,te=[],le,ce=new Pi,he=[],ue){this.registry=C,this.path=te,this.key=te.map((C=>`[${C}]`)).join(""),this.scope=ce,this.errors=he,this.expectedType=le,this.options=ue}parse(C,te,le,ce,he={}){return te||le?this.concat(te,le,ce)._parse(C,he):this._parse(C,he)}_parse(C,te){function i(C,te,le){return"assert"===le?new en(te,[C]):"coerce"===le?new rn(te,[C]):C}if(null!==C&&"string"!=typeof C&&"boolean"!=typeof C&&"number"!=typeof C||(C=["literal",C]),Array.isArray(C)){if(0===C.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const le="string"==typeof C[0]?this.registry[C[0]]:void 0;if(le){let ce=le.parse(C,this);if(!ce)return null;if(this.expectedType){const C=this.expectedType,le=ce.type;if("string"!==C.kind&&"number"!==C.kind&&"boolean"!==C.kind&&"object"!==C.kind&&"array"!==C.kind||"value"!==le.kind)if("color"!==C.kind&&"formatted"!==C.kind&&"resolvedImage"!==C.kind||"value"!==le.kind&&"string"!==le.kind){if(this.checkSubtype(C,le))return null}else ce=i(ce,C,te.typeAnnotation||"coerce");else ce=i(ce,C,te.typeAnnotation||"assert")}if(!(ce instanceof $r)&&"resolvedImage"!==ce.type.kind&&Wr(ce)){const te=new on(this.options);try{ce=new $r(ce.type,ce.evaluate(te))}catch(C){return this.error(C.message),null}}return ce}return rn.parse(["to-array",C],this)}return this.error(void 0===C?"'undefined' value invalid. Use null instead.":"object"==typeof C?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof C} instead.`)}concat(C,te,le){const ce="number"==typeof C?this.path.concat(C):this.path,he=le?this.scope.concat(le):this.scope;return new Zr(this.registry,ce,te||null,he,this.errors,this.options)}error(C,...te){const le=`${this.key}${te.map((C=>`[${C}]`)).join("")}`;this.errors.push(new Di(le,C))}checkSubtype(C,te){const le=ei(C,te);return le&&this.error(le),le}}var Bn=Zr;function Wr(C){if(C instanceof kn)return Wr(C.boundExpression);if(C instanceof sn&&"error"===C.name)return!1;if(C instanceof sn&&"config"===C.name)return!1;if(C instanceof Oi)return!1;if(C instanceof gn)return!1;if(C instanceof Rn)return!1;const te=C instanceof rn||C instanceof en;let le=!0;return C.eachChild((C=>{le=te?le&&Wr(C):le&&C instanceof $r})),!!le&&Nr(C)&&jr(C,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light"])}function Hr(C,te){const le=C.length-1;let ce,he,ue=0,de=le,_e=0;for(;ue<=de;)if(_e=Math.floor((ue+de)/2),ce=C[_e],he=C[_e+1],ce<=te){if(_e===le||te<he)return _e;ue=_e+1}else{if(!(ce>te))throw new Yr("Input is not a number.");de=_e-1}return 0}class Xr{constructor(C,te,le){this.type=C,this.input=te,this.labels=[],this.outputs=[];for(const[C,te]of le)this.labels.push(C),this.outputs.push(te)}static parse(C,te){if(C.length-1<4)return te.error(`Expected at least 4 arguments, but found only ${C.length-1}.`);if((C.length-1)%2!=0)return te.error("Expected an even number of arguments.");const le=te.parse(C[1],1,Bi);if(!le)return null;const ce=[];let he=null;te.expectedType&&"value"!==te.expectedType.kind&&(he=te.expectedType);for(let le=1;le<C.length;le+=2){const ue=1===le?-1/0:C[le],de=C[le+1],_e=le,ye=le+1;if("number"!=typeof ue)return te.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',_e);if(ce.length&&ce[ce.length-1][0]>=ue)return te.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',_e);const ve=te.parse(de,ye,he);if(!ve)return null;he=he||ve.type,ce.push([ue,ve])}return new Xr(he,le,ce)}evaluate(C){const te=this.labels,le=this.outputs;if(1===te.length)return le[0].evaluate(C);const ce=this.input.evaluate(C);if(ce<=te[0])return le[0].evaluate(C);const he=te.length;return ce>=te[he-1]?le[he-1].evaluate(C):le[Hr(te,ce)].evaluate(C)}eachChild(C){C(this.input);for(const te of this.outputs)C(te)}outputDefined(){return this.outputs.every((C=>C.outputDefined()))}serialize(){const C=["step",this.input.serialize()];for(let te=0;te<this.labels.length;te++)te>0&&C.push(this.labels[te]),C.push(this.outputs[te].serialize());return C}}var jn=Xr;function Kr(C,te,le){return C*(1-le)+te*le}function Jr(C,te,le){return C.map(((C,ce)=>Kr(C,te[ce],le)))}var Vn=Object.freeze({__proto__:null,array:Jr,color:function(C,te,le){return new qr(Kr(C.r,te.r,le),Kr(C.g,te.g,le),Kr(C.b,te.b,le),Kr(C.a,te.a,le))},number:Kr});const Gn=.95047,Zn=1.08883,qn=4/29,$n=6/29,Yn=3*$n*$n,oo=$n*$n*$n,jo=Math.PI/180,rs=180/Math.PI;function cn(C){return C>oo?Math.pow(C,1/3):C/Yn+qn}function hn(C){return C>$n?C*C*C:Yn*(C-qn)}function un(C){return 255*(C<=.0031308?12.92*C:1.055*Math.pow(C,1/2.4)-.055)}function dn(C){return(C/=255)<=.04045?C/12.92:Math.pow((C+.055)/1.055,2.4)}function pn(C){const te=dn(C.r),le=dn(C.g),ce=dn(C.b),he=cn((.4124564*te+.3575761*le+.1804375*ce)/Gn),ue=cn((.2126729*te+.7151522*le+.072175*ce)/1);return{l:116*ue-16,a:500*(he-ue),b:200*(ue-cn((.0193339*te+.119192*le+.9503041*ce)/Zn)),alpha:C.a}}function fn(C){let te=(C.l+16)/116,le=isNaN(C.a)?te:te+C.a/500,ce=isNaN(C.b)?te:te-C.b/200;return te=1*hn(te),le=Gn*hn(le),ce=Zn*hn(ce),new qr(un(3.2404542*le-1.5371385*te-.4985314*ce),un(-.969266*le+1.8760108*te+.041556*ce),un(.0556434*le-.2040259*te+1.0572252*ce),C.alpha)}function mn(C,te,le){const ce=te-C;return C+le*(ce>180||ce<-180?ce-360*Math.round(ce/360):ce)}const us={forward:pn,reverse:fn,interpolate:function(C,te,le){return{l:Kr(C.l,te.l,le),a:Kr(C.a,te.a,le),b:Kr(C.b,te.b,le),alpha:Kr(C.alpha,te.alpha,le)}}},Is={forward:function(C){const{l:te,a:le,b:ce}=pn(C),he=Math.atan2(ce,le)*rs;return{h:he<0?he+360:he,c:Math.sqrt(le*le+ce*ce),l:te,alpha:C.a}},reverse:function(C){const te=C.h*jo,le=C.c;return fn({l:C.l,a:Math.cos(te)*le,b:Math.sin(te)*le,alpha:C.alpha})},interpolate:function(C,te,le){return{h:mn(C.h,te.h,le),c:Kr(C.c,te.c,le),l:Kr(C.l,te.l,le),alpha:Kr(C.alpha,te.alpha,le)}}};var Cs=Object.freeze({__proto__:null,hcl:Is,lab:us});class xn{constructor(C,te,le,ce,he){this.type=C,this.operator=te,this.interpolation=le,this.input=ce,this.labels=[],this.outputs=[];for(const[C,te]of he)this.labels.push(C),this.outputs.push(te)}static interpolationFactor(C,te,le,ce){let he=0;if("exponential"===C.name)he=vn(te,C.base,le,ce);else if("linear"===C.name)he=vn(te,1,le,ce);else if("cubic-bezier"===C.name){const ue=C.controlPoints;he=new Oe(ue[0],ue[1],ue[2],ue[3]).solve(vn(te,1,le,ce))}return he}static parse(C,te){let[le,ce,he,...ue]=C;if(!Array.isArray(ce)||0===ce.length)return te.error("Expected an interpolation type expression.",1);if("linear"===ce[0])ce={name:"linear"};else if("exponential"===ce[0]){const C=ce[1];if("number"!=typeof C)return te.error("Exponential interpolation requires a numeric base.",1,1);ce={name:"exponential",base:C}}else{if("cubic-bezier"!==ce[0])return te.error(`Unknown interpolation type ${String(ce[0])}`,1,0);{const C=ce.slice(1);if(4!==C.length||C.some((C=>"number"!=typeof C||C<0||C>1)))return te.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);ce={name:"cubic-bezier",controlPoints:C}}}if(C.length-1<4)return te.error(`Expected at least 4 arguments, but found only ${C.length-1}.`);if((C.length-1)%2!=0)return te.error("Expected an even number of arguments.");if(he=te.parse(he,2,Bi),!he)return null;const de=[];let _e=null;"interpolate-hcl"===le||"interpolate-lab"===le?_e=nr:te.expectedType&&"value"!==te.expectedType.kind&&(_e=te.expectedType);for(let C=0;C<ue.length;C+=2){const le=ue[C],ce=ue[C+1],he=C+3,ye=C+4;if("number"!=typeof le)return te.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',he);if(de.length&&de[de.length-1][0]>=le)return te.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',he);const ve=te.parse(ce,ye,_e);if(!ve)return null;_e=_e||ve.type,de.push([le,ve])}return"number"===_e.kind||"color"===_e.kind||"array"===_e.kind&&"number"===_e.itemType.kind&&"number"==typeof _e.N?new xn(_e,le,ce,he,de):te.error(`Type ${Jt(_e)} is not interpolatable.`)}evaluate(C){const te=this.labels,le=this.outputs;if(1===te.length)return le[0].evaluate(C);const ce=this.input.evaluate(C);if(ce<=te[0])return le[0].evaluate(C);const he=te.length;if(ce>=te[he-1])return le[he-1].evaluate(C);const ue=Hr(te,ce),de=xn.interpolationFactor(this.interpolation,ce,te[ue],te[ue+1]),_e=le[ue].evaluate(C),ye=le[ue+1].evaluate(C);return"interpolate"===this.operator?Vn[this.type.kind.toLowerCase()](_e,ye,de):"interpolate-hcl"===this.operator?Is.reverse(Is.interpolate(Is.forward(_e),Is.forward(ye),de)):us.reverse(us.interpolate(us.forward(_e),us.forward(ye),de))}eachChild(C){C(this.input);for(const te of this.outputs)C(te)}outputDefined(){return this.outputs.every((C=>C.outputDefined()))}serialize(){let C;C="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const te=[this.operator,C,this.input.serialize()];for(let C=0;C<this.labels.length;C++)te.push(this.labels[C],this.outputs[C].serialize());return te}}function vn(C,te,le,ce){const he=ce-le,ue=C-le;return 0===he?0:1===te?ue/he:(Math.pow(te,ue)-1)/(Math.pow(te,he)-1)}var Ds=xn;class wn{constructor(C,te){this.type=C,this.args=te}static parse(C,te){if(C.length<2)return te.error("Expectected at least one argument.");let le=null;const ce=te.expectedType;ce&&"value"!==ce.kind&&(le=ce);const he=[];for(const ce of C.slice(1)){const C=te.parse(ce,1+he.length,le,void 0,{typeAnnotation:"omit"});if(!C)return null;le=le||C.type,he.push(C)}const ue=ce&&he.some((C=>ei(ce,C.type)));return new wn(ue?sr:le,he)}evaluate(C){let te,le=null,ce=0;for(const he of this.args){if(ce++,le=he.evaluate(C),le&&le instanceof fi&&!le.available&&(te||(te=le),le=null,ce===this.args.length))return te;if(null!==le)break}return le}eachChild(C){this.args.forEach(C)}outputDefined(){return this.args.every((C=>C.outputDefined()))}serialize(){const C=["coalesce"];return this.eachChild((te=>{C.push(te.serialize())})),C}}var Ps=wn;class En{constructor(C,te){this.type=te.type,this.bindings=[].concat(C),this.result=te}evaluate(C){return this.result.evaluate(C)}eachChild(C){for(const te of this.bindings)C(te[1]);C(this.result)}static parse(C,te){if(C.length<4)return te.error(`Expected at least 3 arguments, but found ${C.length-1} instead.`);const le=[];for(let ce=1;ce<C.length-1;ce+=2){const he=C[ce];if("string"!=typeof he)return te.error(`Expected string, but found ${typeof he} instead.`,ce);if(/[^a-zA-Z0-9_]/.test(he))return te.error("Variable names must contain only alphanumeric characters or '_'.",ce);const ue=te.parse(C[ce+1],ce+1);if(!ue)return null;le.push([he,ue])}const ce=te.parse(C[C.length-1],C.length-1,te.expectedType,le);return ce?new En(le,ce):null}outputDefined(){return this.result.outputDefined()}serialize(){const C=["let"];for(const[te,le]of this.bindings)C.push(te,le.serialize());return C.push(this.result.serialize()),C}}var Fs=En;class An{constructor(C,te,le){this.type=C,this.index=te,this.input=le}static parse(C,te){if(3!==C.length)return te.error(`Expected 2 arguments, but found ${C.length-1} instead.`);const le=te.parse(C[1],1,Bi),ce=te.parse(C[2],2,Kt(te.expectedType||sr));return le&&ce?new An(ce.type.itemType,le,ce):null}evaluate(C){const te=this.index.evaluate(C),le=this.input.evaluate(C);if(te<0)throw new Yr(`Array index out of bounds: ${te} < 0.`);if(te>=le.length)throw new Yr(`Array index out of bounds: ${te} > ${le.length-1}.`);if(te!==Math.floor(te))throw new Yr(`Array index must be an integer, but found ${te} instead.`);return le[te]}eachChild(C){C(this.index),C(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}var Hs=An;class In{constructor(C,te){this.type=$i,this.needle=C,this.haystack=te}static parse(C,te){if(3!==C.length)return te.error(`Expected 2 arguments, but found ${C.length-1} instead.`);const le=te.parse(C[1],1,sr),ce=te.parse(C[2],2,sr);return le&&ce?ti(le.type,[$i,Fi,Bi,ki,sr])?new In(le,ce):te.error(`Expected first argument to be of type boolean, string, number or null, but found ${Jt(le.type)} instead`):null}evaluate(C){const te=this.needle.evaluate(C),le=this.haystack.evaluate(C);if(null==le)return!1;if(!ii(te,["boolean","string","number","null"]))throw new Yr(`Expected first argument to be of type boolean, string, number or null, but found ${Jt(gi(te))} instead.`);if(!ii(le,["string","array"]))throw new Yr(`Expected second argument to be of type array or string, but found ${Jt(gi(le))} instead.`);return le.indexOf(te)>=0}eachChild(C){C(this.needle),C(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}var Ws=In;class zn{constructor(C,te,le){this.type=Bi,this.needle=C,this.haystack=te,this.fromIndex=le}static parse(C,te){if(C.length<=2||C.length>=5)return te.error(`Expected 3 or 4 arguments, but found ${C.length-1} instead.`);const le=te.parse(C[1],1,sr),ce=te.parse(C[2],2,sr);if(!le||!ce)return null;if(!ti(le.type,[$i,Fi,Bi,ki,sr]))return te.error(`Expected first argument to be of type boolean, string, number or null, but found ${Jt(le.type)} instead`);if(4===C.length){const he=te.parse(C[3],3,Bi);return he?new zn(le,ce,he):null}return new zn(le,ce)}evaluate(C){const te=this.needle.evaluate(C),le=this.haystack.evaluate(C);if(!ii(te,["boolean","string","number","null"]))throw new Yr(`Expected first argument to be of type boolean, string, number or null, but found ${Jt(gi(te))} instead.`);if(!ii(le,["string","array"]))throw new Yr(`Expected second argument to be of type array or string, but found ${Jt(gi(le))} instead.`);if(this.fromIndex){const ce=this.fromIndex.evaluate(C);return le.indexOf(te,ce)}return le.indexOf(te)}eachChild(C){C(this.needle),C(this.haystack),this.fromIndex&&C(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const C=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),C]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}var Xs=zn;class Dn{constructor(C,te,le,ce,he,ue){this.inputType=C,this.type=te,this.input=le,this.cases=ce,this.outputs=he,this.otherwise=ue}static parse(C,te){if(C.length<5)return te.error(`Expected at least 4 arguments, but found only ${C.length-1}.`);if(C.length%2!=1)return te.error("Expected an even number of arguments.");let le,ce;te.expectedType&&"value"!==te.expectedType.kind&&(ce=te.expectedType);const he={},ue=[];for(let de=2;de<C.length-1;de+=2){let _e=C[de];const ye=C[de+1];Array.isArray(_e)||(_e=[_e]);const ve=te.concat(de);if(0===_e.length)return ve.error("Expected at least one branch label.");for(const C of _e){if("number"!=typeof C&&"string"!=typeof C)return ve.error("Branch labels must be numbers or strings.");if("number"==typeof C&&Math.abs(C)>Number.MAX_SAFE_INTEGER)return ve.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof C&&Math.floor(C)!==C)return ve.error("Numeric branch labels must be integer values.");if(le){if(ve.checkSubtype(le,gi(C)))return null}else le=gi(C);if(void 0!==he[String(C)])return ve.error("Branch labels must be unique.");he[String(C)]=ue.length}const Se=te.parse(ye,de,ce);if(!Se)return null;ce=ce||Se.type,ue.push(Se)}const de=te.parse(C[1],1,sr);if(!de)return null;const _e=te.parse(C[C.length-1],C.length-1,ce);return _e?"value"!==de.type.kind&&te.concat(1).checkSubtype(le,de.type)?null:new Dn(le,ce,de,he,ue,_e):null}evaluate(C){const te=this.input.evaluate(C);return(gi(te)===this.inputType&&this.outputs[this.cases[te]]||this.otherwise).evaluate(C)}eachChild(C){C(this.input),this.outputs.forEach(C),C(this.otherwise)}outputDefined(){return this.outputs.every((C=>C.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const C=["match",this.input.serialize()],te=Object.keys(this.cases).sort(),le=[],ce={};for(const C of te){const te=ce[this.cases[C]];void 0===te?(ce[this.cases[C]]=le.length,le.push([this.cases[C],[C]])):le[te][1].push(C)}const n=C=>"number"===this.inputType.kind?Number(C):C;for(const[te,ce]of le)C.push(1===ce.length?n(ce[0]):ce.map(n)),C.push(this.outputs[te].serialize());return C.push(this.otherwise.serialize()),C}}var Ks=Dn;class Ln{constructor(C,te,le){this.type=C,this.branches=te,this.otherwise=le}static parse(C,te){if(C.length<4)return te.error(`Expected at least 3 arguments, but found only ${C.length-1}.`);if(C.length%2!=0)return te.error("Expected an odd number of arguments.");let le;te.expectedType&&"value"!==te.expectedType.kind&&(le=te.expectedType);const ce=[];for(let he=1;he<C.length-1;he+=2){const ue=te.parse(C[he],he,$i);if(!ue)return null;const de=te.parse(C[he+1],he+1,le);if(!de)return null;ce.push([ue,de]),le=le||de.type}const he=te.parse(C[C.length-1],C.length-1,le);return he?new Ln(le,ce,he):null}evaluate(C){for(const[te,le]of this.branches)if(te.evaluate(C))return le.evaluate(C);return this.otherwise.evaluate(C)}eachChild(C){for(const[te,le]of this.branches)C(te),C(le);C(this.otherwise)}outputDefined(){return this.branches.every((([C,te])=>te.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const C=["case"];return this.eachChild((te=>{C.push(te.serialize())})),C}}var Ys=Ln;class On{constructor(C,te,le,ce){this.type=C,this.input=te,this.beginIndex=le,this.endIndex=ce}static parse(C,te){if(C.length<=2||C.length>=5)return te.error(`Expected 3 or 4 arguments, but found ${C.length-1} instead.`);const le=te.parse(C[1],1,sr),ce=te.parse(C[2],2,Bi);if(!le||!ce)return null;if(!ti(le.type,[Kt(sr),Fi,sr]))return te.error(`Expected first argument to be of type array or string, but found ${Jt(le.type)} instead`);if(4===C.length){const he=te.parse(C[3],3,Bi);return he?new On(le.type,le,ce,he):null}return new On(le.type,le,ce)}evaluate(C){const te=this.input.evaluate(C),le=this.beginIndex.evaluate(C);if(!ii(te,["string","array"]))throw new Yr(`Expected first argument to be of type array or string, but found ${Jt(gi(te))} instead.`);if(this.endIndex){const ce=this.endIndex.evaluate(C);return te.slice(le,ce)}return te.slice(le)}eachChild(C){C(this.input),C(this.beginIndex),this.endIndex&&C(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const C=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),C]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}var Js=On;function Fn(C,te){return"=="===C||"!="===C?"boolean"===te.kind||"string"===te.kind||"number"===te.kind||"null"===te.kind||"value"===te.kind:"string"===te.kind||"number"===te.kind||"value"===te.kind}function Nn(C,te,le,ce){return 0===ce.compare(te,le)}function Un(C,te,le){const ce="=="!==C&&"!="!==C;return class n{constructor(C,te,le){this.type=$i,this.lhs=C,this.rhs=te,this.collator=le,this.hasUntypedArgument="value"===C.type.kind||"value"===te.type.kind}static parse(C,te){if(3!==C.length&&4!==C.length)return te.error("Expected two or three arguments.");const le=C[0];let he=te.parse(C[1],1,sr);if(!he)return null;if(!Fn(le,he.type))return te.concat(1).error(`"${le}" comparisons are not supported for type '${Jt(he.type)}'.`);let ue=te.parse(C[2],2,sr);if(!ue)return null;if(!Fn(le,ue.type))return te.concat(2).error(`"${le}" comparisons are not supported for type '${Jt(ue.type)}'.`);if(he.type.kind!==ue.type.kind&&"value"!==he.type.kind&&"value"!==ue.type.kind)return te.error(`Cannot compare types '${Jt(he.type)}' and '${Jt(ue.type)}'.`);ce&&("value"===he.type.kind&&"value"!==ue.type.kind?he=new en(ue.type,[he]):"value"!==he.type.kind&&"value"===ue.type.kind&&(ue=new en(he.type,[ue])));let de=null;if(4===C.length){if("string"!==he.type.kind&&"string"!==ue.type.kind&&"value"!==he.type.kind&&"value"!==ue.type.kind)return te.error("Cannot use collator to compare non-string types.");if(de=te.parse(C[3],3,ar),!de)return null}return new n(he,ue,de)}evaluate(he){const ue=this.lhs.evaluate(he),de=this.rhs.evaluate(he);if(ce&&this.hasUntypedArgument){const te=gi(ue),le=gi(de);if(te.kind!==le.kind||"string"!==te.kind&&"number"!==te.kind)throw new Yr(`Expected arguments for "${C}" to be (string, string) or (number, number), but found (${te.kind}, ${le.kind}) instead.`)}if(this.collator&&!ce&&this.hasUntypedArgument){const C=gi(ue),le=gi(de);if("string"!==C.kind||"string"!==le.kind)return te(he,ue,de)}return this.collator?le(he,ue,de,this.collator.evaluate(he)):te(he,ue,de)}eachChild(C){C(this.lhs),C(this.rhs),this.collator&&C(this.collator)}outputDefined(){return!0}serialize(){const te=[C];return this.eachChild((C=>{te.push(C.serialize())})),te}}}const ta=Un("==",(function(C,te,le){return te===le}),Nn),na=Un("!=",(function(C,te,le){return te!==le}),(function(C,te,le,ce){return!Nn(0,te,le,ce)})),ya=Un("<",(function(C,te,le){return te<le}),(function(C,te,le,ce){return ce.compare(te,le)<0})),wa=Un(">",(function(C,te,le){return te>le}),(function(C,te,le,ce){return ce.compare(te,le)>0})),Ma=Un("<=",(function(C,te,le){return te<=le}),(function(C,te,le,ce){return ce.compare(te,le)<=0})),gl=Un(">=",(function(C,te,le){return te>=le}),(function(C,te,le,ce){return ce.compare(te,le)>=0}));class Wn{constructor(C,te,le,ce,he,ue){this.type=Fi,this.number=C,this.locale=te,this.currency=le,this.unit=ce,this.minFractionDigits=he,this.maxFractionDigits=ue}static parse(C,te){if(3!==C.length)return te.error("Expected two arguments.");const le=te.parse(C[1],1,Bi);if(!le)return null;const ce=C[2];if("object"!=typeof ce||Array.isArray(ce))return te.error("NumberFormat options argument must be an object.");let he=null;if(ce.locale&&(he=te.parse(ce.locale,1,Fi),!he))return null;let ue=null;if(ce.currency&&(ue=te.parse(ce.currency,1,Fi),!ue))return null;let de=null;if(ce.unit&&(de=te.parse(ce.unit,1,Fi),!de))return null;let _e=null;if(ce["min-fraction-digits"]&&(_e=te.parse(ce["min-fraction-digits"],1,Bi),!_e))return null;let ye=null;return ce["max-fraction-digits"]&&(ye=te.parse(ce["max-fraction-digits"],1,Bi),!ye)?null:new Wn(le,he,ue,de,_e,ye)}evaluate(C){return new Intl.NumberFormat(this.locale?this.locale.evaluate(C):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(C):void 0,unit:this.unit?this.unit.evaluate(C):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(C):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(C):void 0}).format(this.number.evaluate(C))}eachChild(C){C(this.number),this.locale&&C(this.locale),this.currency&&C(this.currency),this.unit&&C(this.unit),this.minFractionDigits&&C(this.minFractionDigits),this.maxFractionDigits&&C(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const C={};return this.locale&&(C.locale=this.locale.serialize()),this.currency&&(C.currency=this.currency.serialize()),this.unit&&(C.unit=this.unit.serialize()),this.minFractionDigits&&(C["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(C["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),C]}}class Hn{constructor(C){this.type=Bi,this.input=C}static parse(C,te){if(2!==C.length)return te.error(`Expected 1 argument, but found ${C.length-1} instead.`);const le=te.parse(C[1],1);return le?"array"!==le.type.kind&&"string"!==le.type.kind&&"value"!==le.type.kind?te.error(`Expected argument of type string or array, but found ${Jt(le.type)} instead.`):new Hn(le):null}evaluate(C){const te=this.input.evaluate(C);if("string"==typeof te)return te.length;if(Array.isArray(te))return te.length;throw new Yr(`Expected value to be of type string or array, but found ${Jt(gi(te))} instead.`)}eachChild(C){C(this.input)}outputDefined(){return!1}serialize(){const C=["length"];return this.eachChild((te=>{C.push(te.serialize())})),C}}function Xn(C){return function(){C=1831565813+(C|=0)|0;let te=Math.imul(C^C>>>15,1|C);return te=te+Math.imul(te^te>>>7,61|te)^te,((te^te>>>14)>>>0)/4294967296}}const yl={"==":ta,"!=":na,">":wa,"<":ya,">=":gl,"<=":Ma,array:en,at:Hs,boolean:en,case:Ys,coalesce:Ps,collator:Oi,format:Mi,image:Ai,in:Ws,"index-of":Xs,interpolate:Ds,"interpolate-hcl":Ds,"interpolate-lab":Ds,length:Hn,let:Fs,literal:$r,match:Ks,number:en,"number-format":Wn,object:en,slice:Js,step:jn,string:en,"to-boolean":rn,"to-color":rn,"to-number":rn,"to-string":rn,var:kn,within:gn,distance:Rn};function Kn(C,[te,le,ce,he]){te=te.evaluate(C),le=le.evaluate(C),ce=ce.evaluate(C);const ue=he?he.evaluate(C):1,de=mi(te,le,ce,ue);if(de)throw new Yr(de);return new qr(te/255*ue,le/255*ue,ce/255*ue,ue)}function Jn(C,[te,le,ce,he]){te=te.evaluate(C),le=le.evaluate(C),ce=ce.evaluate(C);const ue=he?he.evaluate(C):1,de=function(C,te,le,ce){return"number"==typeof C&&C>=0&&C<=360?"number"==typeof te&&te>=0&&te<=100&&"number"==typeof le&&le>=0&&le<=100?void 0===ce||"number"==typeof ce&&ce>=0&&ce<=1?null:`Invalid hsla value [${[C,te,le,ce].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${("number"==typeof ce?[C,te,le,ce]:[C,te,le]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${("number"==typeof ce?[C,te,le,ce]:[C,te,le]).join(", ")}]: 'h' must be between 0 and 360.`}(te,le,ce,ue);if(de)throw new Yr(de);const _e=`hsla(${te}, ${le}%, ${ce}%, ${ue})`,ye=qr.parse(_e);if(!ye)throw new Yr(`Failed to parse HSLA color: ${_e}`);return ye}function Qn(C,te){return C in te}function eo(C,te){const le=te[C];return void 0===le?null:le}function to(C,te){switch(C){case"string":return String(te);case"number":return+te;case"boolean":return!!te;case"color":return qr.parse(te)}return te}function io(C,te,le,ce){return void 0!==ce&&(C=ce*Math.round(C/ce)),void 0!==te&&C<te&&(C=te),void 0!==le&&C>le&&(C=le),C}function ro(C,te,le){le.length&&(te+=`${le}`);const ce=C.getConfig(te);if(!ce)return null;const{type:he,value:ue,values:de,minValue:_e,maxValue:ye,stepValue:ve}=ce,Se=ce.default.evaluate(C);let Me=ue?ue.evaluate(C):Se;return he&&(Me=to(he,Me)),void 0!==ue&&void 0!==Me&&de&&!de.includes(Me)&&(Me=Se,he&&(Me=to(he,Me))),void 0===Me||void 0===_e&&void 0===ye&&void 0===ve||("number"==typeof Me?Me=io(Me,_e,ye,ve):Array.isArray(Me)&&(Me=Me.map((C=>"number"==typeof C?io(C,_e,ye,ve):C)))),Me}function no(C){return{type:C}}sn.register(yl,{error:[{kind:"error"},[Fi],(C,[te])=>{throw new Yr(te.evaluate(C))}],typeof:[Fi,[sr],(C,[te])=>Jt(gi(te.evaluate(C)))],"to-rgba":[Kt(Bi,4),[nr],(C,[te])=>te.evaluate(C).toArray()],rgb:[nr,[Bi,Bi,Bi],Kn],rgba:[nr,[Bi,Bi,Bi,Bi],Kn],hsl:[nr,[Bi,Bi,Bi],Jn],hsla:[nr,[Bi,Bi,Bi,Bi],Jn],has:{type:$i,overloads:[[[Fi],(C,[te])=>Qn(te.evaluate(C),C.properties())],[[Fi,or],(C,[te,le])=>Qn(te.evaluate(C),le.evaluate(C))]]},get:{type:sr,overloads:[[[Fi],(C,[te])=>eo(te.evaluate(C),C.properties())],[[Fi,or],(C,[te,le])=>eo(te.evaluate(C),le.evaluate(C))]]},config:{type:sr,overloads:[[[Fi],(C,[te])=>ro(C,te.evaluate(C),"")],[[Fi,Fi],(C,[te,le])=>ro(C,te.evaluate(C),le.evaluate(C))]]},"feature-state":[sr,[Fi],(C,[te])=>eo(te.evaluate(C),C.featureState||{})],properties:[or,[],C=>C.properties()],"geometry-type":[Fi,[],C=>C.geometryType()],id:[sr,[],C=>C.id()],zoom:[Bi,[],C=>C.globals.zoom],pitch:[Bi,[],C=>C.globals.pitch||0],"distance-from-center":[Bi,[],C=>C.distanceFromCenter()],"measure-light":[Bi,[Fi],(C,[te])=>C.measureLight(te.evaluate(C))],"heatmap-density":[Bi,[],C=>C.globals.heatmapDensity||0],"line-progress":[Bi,[],C=>C.globals.lineProgress||0],"raster-value":[Bi,[],C=>C.globals.rasterValue||0],"sky-radial-progress":[Bi,[],C=>C.globals.skyRadialProgress||0],accumulated:[sr,[],C=>void 0===C.globals.accumulated?null:C.globals.accumulated],"+":[Bi,no(Bi),(C,te)=>{let le=0;for(const ce of te)le+=ce.evaluate(C);return le}],"*":[Bi,no(Bi),(C,te)=>{let le=1;for(const ce of te)le*=ce.evaluate(C);return le}],"-":{type:Bi,overloads:[[[Bi,Bi],(C,[te,le])=>te.evaluate(C)-le.evaluate(C)],[[Bi],(C,[te])=>-te.evaluate(C)]]},"/":[Bi,[Bi,Bi],(C,[te,le])=>te.evaluate(C)/le.evaluate(C)],"%":[Bi,[Bi,Bi],(C,[te,le])=>te.evaluate(C)%le.evaluate(C)],ln2:[Bi,[],()=>Math.LN2],pi:[Bi,[],()=>Math.PI],e:[Bi,[],()=>Math.E],"^":[Bi,[Bi,Bi],(C,[te,le])=>Math.pow(te.evaluate(C),le.evaluate(C))],sqrt:[Bi,[Bi],(C,[te])=>Math.sqrt(te.evaluate(C))],log10:[Bi,[Bi],(C,[te])=>Math.log(te.evaluate(C))/Math.LN10],ln:[Bi,[Bi],(C,[te])=>Math.log(te.evaluate(C))],log2:[Bi,[Bi],(C,[te])=>Math.log(te.evaluate(C))/Math.LN2],sin:[Bi,[Bi],(C,[te])=>Math.sin(te.evaluate(C))],cos:[Bi,[Bi],(C,[te])=>Math.cos(te.evaluate(C))],tan:[Bi,[Bi],(C,[te])=>Math.tan(te.evaluate(C))],asin:[Bi,[Bi],(C,[te])=>Math.asin(te.evaluate(C))],acos:[Bi,[Bi],(C,[te])=>Math.acos(te.evaluate(C))],atan:[Bi,[Bi],(C,[te])=>Math.atan(te.evaluate(C))],min:[Bi,no(Bi),(C,te)=>Math.min(...te.map((te=>te.evaluate(C))))],max:[Bi,no(Bi),(C,te)=>Math.max(...te.map((te=>te.evaluate(C))))],abs:[Bi,[Bi],(C,[te])=>Math.abs(te.evaluate(C))],round:[Bi,[Bi],(C,[te])=>{const le=te.evaluate(C);return le<0?-Math.round(-le):Math.round(le)}],floor:[Bi,[Bi],(C,[te])=>Math.floor(te.evaluate(C))],ceil:[Bi,[Bi],(C,[te])=>Math.ceil(te.evaluate(C))],"filter-==":[$i,[Fi,sr],(C,[te,le])=>C.properties()[te.value]===le.value],"filter-id-==":[$i,[sr],(C,[te])=>C.id()===te.value],"filter-type-==":[$i,[Fi],(C,[te])=>C.geometryType()===te.value],"filter-<":[$i,[Fi,sr],(C,[te,le])=>{const ce=C.properties()[te.value],he=le.value;return typeof ce==typeof he&&ce<he}],"filter-id-<":[$i,[sr],(C,[te])=>{const le=C.id(),ce=te.value;return typeof le==typeof ce&&le<ce}],"filter->":[$i,[Fi,sr],(C,[te,le])=>{const ce=C.properties()[te.value],he=le.value;return typeof ce==typeof he&&ce>he}],"filter-id->":[$i,[sr],(C,[te])=>{const le=C.id(),ce=te.value;return typeof le==typeof ce&&le>ce}],"filter-<=":[$i,[Fi,sr],(C,[te,le])=>{const ce=C.properties()[te.value],he=le.value;return typeof ce==typeof he&&ce<=he}],"filter-id-<=":[$i,[sr],(C,[te])=>{const le=C.id(),ce=te.value;return typeof le==typeof ce&&le<=ce}],"filter->=":[$i,[Fi,sr],(C,[te,le])=>{const ce=C.properties()[te.value],he=le.value;return typeof ce==typeof he&&ce>=he}],"filter-id->=":[$i,[sr],(C,[te])=>{const le=C.id(),ce=te.value;return typeof le==typeof ce&&le>=ce}],"filter-has":[$i,[sr],(C,[te])=>te.value in C.properties()],"filter-has-id":[$i,[],C=>null!==C.id()&&void 0!==C.id()],"filter-type-in":[$i,[Kt(Fi)],(C,[te])=>te.value.indexOf(C.geometryType())>=0],"filter-id-in":[$i,[Kt(sr)],(C,[te])=>te.value.indexOf(C.id())>=0],"filter-in-small":[$i,[Fi,Kt(sr)],(C,[te,le])=>le.value.indexOf(C.properties()[te.value])>=0],"filter-in-large":[$i,[Fi,Kt(sr)],(C,[te,le])=>function(C,te,le,ce){for(;le<=ce;){const he=le+ce>>1;if(te[he]===C)return!0;te[he]>C?ce=he-1:le=he+1}return!1}(C.properties()[te.value],le.value,0,le.value.length-1)],all:{type:$i,overloads:[[[$i,$i],(C,[te,le])=>te.evaluate(C)&&le.evaluate(C)],[no($i),(C,te)=>{for(const le of te)if(!le.evaluate(C))return!1;return!0}]]},any:{type:$i,overloads:[[[$i,$i],(C,[te,le])=>te.evaluate(C)||le.evaluate(C)],[no($i),(C,te)=>{for(const le of te)if(le.evaluate(C))return!0;return!1}]]},"!":[$i,[$i],(C,[te])=>!te.evaluate(C)],"is-supported-script":[$i,[Fi],(C,[te])=>{const le=C.globals&&C.globals.isSupportedScript;return!le||le(te.evaluate(C))}],upcase:[Fi,[Fi],(C,[te])=>te.evaluate(C).toUpperCase()],downcase:[Fi,[Fi],(C,[te])=>te.evaluate(C).toLowerCase()],concat:[Fi,no(sr),(C,te)=>te.map((te=>yi(te.evaluate(C)))).join("")],"resolved-locale":[Fi,[ar],(C,[te])=>te.evaluate(C).resolvedLocale()],random:[Bi,[Bi,Bi,sr],(C,te)=>{const[le,ce,he]=te.map((te=>te.evaluate(C)));if(le>ce)return le;if(le===ce)return le;let ue;if("string"==typeof he)ue=function(C){let te=0;if(0===C.length)return te;for(let le=0;le<C.length;le++)te=(te<<5)-te+C.charCodeAt(le),te&=te;return te}(he);else{if("number"!=typeof he)throw new Yr(`Invalid seed input: ${he}`);ue=he}return le+Xn(ue)()*(ce-le)}]});var bl=yl;function so(C){return{result:"success",value:C}}function ao(C){return{result:"error",value:C}}function lo(C,te){return!!C&&!!C.parameters&&C.parameters.indexOf(te)>-1}function co(C){return"data-driven"===C["property-type"]}function ho(C){return lo(C.expression,"measure-light")}function uo(C){return lo(C.expression,"zoom")}function po(C){return!!C.expression&&C.expression.interpolated}function fo(C){return"object"==typeof C&&null!==C&&!Array.isArray(C)}function mo(C){return C}function _o(C,te){const le="color"===te.type,ce=C.stops&&"object"==typeof C.stops[0][0],he=ce||!(ce||void 0!==C.property),ue=C.type||(po(te)?"exponential":"interval");if(le&&((C=Lt({},C)).stops&&(C.stops=C.stops.map((C=>[C[0],qr.parse(C[1])]))),C.default=qr.parse(C.default?C.default:te.default)),C.colorSpace&&"rgb"!==C.colorSpace&&!Cs[C.colorSpace])throw new Error(`Unknown color space: ${C.colorSpace}`);let de,_e,ye;if("exponential"===ue)de=vo;else if("interval"===ue)de=xo;else if("categorical"===ue){de=yo,_e=Object.create(null);for(const te of C.stops)_e[te[0]]=te[1];ye=typeof C.stops[0][0]}else{if("identity"!==ue)throw new Error(`Unknown function type "${ue}"`);de=bo}if(ce){const le={},ce=[];for(let te=0;te<C.stops.length;te++){const he=C.stops[te],ue=he[0].zoom;void 0===le[ue]&&(le[ue]={zoom:ue,type:C.type,property:C.property,default:C.default,stops:[]},ce.push(ue)),le[ue].stops.push([he[0].value,he[1]])}const he=[];for(const C of ce)he.push([le[C].zoom,_o(le[C],te)]);const ue={name:"linear"};return{kind:"composite",interpolationType:ue,interpolationFactor:Ds.interpolationFactor.bind(void 0,ue),zoomStops:he.map((C=>C[0])),evaluate:({zoom:le},ce)=>vo({stops:he,base:C.base},te,le).evaluate(le,ce)}}if(he){const le="exponential"===ue?{name:"exponential",base:void 0!==C.base?C.base:1}:null;return{kind:"camera",interpolationType:le,interpolationFactor:Ds.interpolationFactor.bind(void 0,le),zoomStops:C.stops.map((C=>C[0])),evaluate:({zoom:le})=>de(C,te,le,_e,ye)}}return{kind:"source",evaluate(le,ce){const he=ce&&ce.properties?ce.properties[C.property]:void 0;return void 0===he?go(C.default,te.default):de(C,te,he,_e,ye)}}}function go(C,te,le){return void 0!==C?C:void 0!==te?te:void 0!==le?le:void 0}function yo(C,te,le,ce,he){return go(typeof le===he?ce[le]:void 0,C.default,te.default)}function xo(C,te,le){if("number"!==Si(le))return go(C.default,te.default);const ce=C.stops.length;if(1===ce)return C.stops[0][1];if(le<=C.stops[0][0])return C.stops[0][1];if(le>=C.stops[ce-1][0])return C.stops[ce-1][1];const he=Hr(C.stops.map((C=>C[0])),le);return C.stops[he][1]}function vo(C,te,le){const ce=void 0!==C.base?C.base:1;if("number"!==Si(le))return go(C.default,te.default);const he=C.stops.length;if(1===he)return C.stops[0][1];if(le<=C.stops[0][0])return C.stops[0][1];if(le>=C.stops[he-1][0])return C.stops[he-1][1];const ue=Hr(C.stops.map((C=>C[0])),le),de=function(C,te,le,ce){const he=ce-le,ue=C-le;return 0===he?0:1===te?ue/he:(Math.pow(te,ue)-1)/(Math.pow(te,he)-1)}(le,ce,C.stops[ue][0],C.stops[ue+1][0]),_e=C.stops[ue][1],ye=C.stops[ue+1][1];let ve=Vn[te.type]||mo;if(C.colorSpace&&"rgb"!==C.colorSpace){const te=Cs[C.colorSpace];ve=(C,le)=>te.reverse(te.interpolate(te.forward(C),te.forward(le),de))}return"function"==typeof _e.evaluate?{evaluate(...C){const te=_e.evaluate.apply(void 0,C),le=ye.evaluate.apply(void 0,C);if(void 0!==te&&void 0!==le)return ve(te,le,de)}}:ve(_e,ye,de)}function bo(C,te,le){return"color"===te.type?le=qr.parse(le):"formatted"===te.type?le=pi.fromString(le.toString()):"resolvedImage"===te.type?le=fi.fromString(le.toString()):Si(le)===te.type||"enum"===te.type&&te.values[le]||(le=void 0),go(le,C.default,te.default)}class wo{constructor(C,te,le){this.expression=C,this._warningHistory={},this._evaluator=new on(le),this._defaultValue=te?function(C){return"color"===C.type&&(fo(C.default)||Array.isArray(C.default))?new qr(0,0,0,0):"color"===C.type?qr.parse(C.default)||null:void 0===C.default?null:C.default}(te):null,this._enumValues=te&&"enum"===te.type?te.values:null}evaluateWithoutErrorHandling(C,te,le,ce,he,ue,de,_e){return this._evaluator.globals=C,this._evaluator.feature=te,this._evaluator.featureState=le,this._evaluator.canonical=ce||null,this._evaluator.availableImages=he||null,this._evaluator.formattedSection=ue,this._evaluator.featureTileCoord=de||null,this._evaluator.featureDistanceData=_e||null,this.expression.evaluate(this._evaluator)}evaluate(C,te,le,ce,he,ue,de,_e){this._evaluator.globals=C,this._evaluator.feature=te||null,this._evaluator.featureState=le||null,this._evaluator.canonical=ce||null,this._evaluator.availableImages=he||null,this._evaluator.formattedSection=ue||null,this._evaluator.featureTileCoord=de||null,this._evaluator.featureDistanceData=_e||null;try{const C=this.expression.evaluate(this._evaluator);if(null==C||"number"==typeof C&&C!=C)return this._defaultValue;if(this._enumValues&&!(C in this._enumValues))throw new Yr(`Expected value to be one of ${Object.keys(this._enumValues).map((C=>JSON.stringify(C))).join(", ")}, but found ${JSON.stringify(C)} instead.`);return C}catch(C){return this._warningHistory[C.message]||(this._warningHistory[C.message]=!0,"undefined"!=typeof console&&console.warn(C.message)),this._defaultValue}}}function To(C){return Array.isArray(C)&&C.length>0&&"string"==typeof C[0]&&C[0]in bl}function Eo(C,te,le){const ce=new Bn(bl,[],te?function(C){const te={color:nr,string:Fi,number:Bi,enum:Fi,boolean:$i,formatted:lr,resolvedImage:cr};return"array"===C.type?Kt(te[C.value]||sr,C.length):te[C.type]}(te):void 0,void 0,void 0,le),he=ce.parse(C,void 0,void 0,void 0,te&&"string"===te.type?{typeAnnotation:"coerce"}:void 0);return he?so(new wo(he,te,le)):ao(ce.errors)}class Mo{constructor(C,te,le){this.kind=C,this._styleExpression=te,this.isLightConstant=le,this.isStateDependent="constant"!==C&&!Ur(te.expression),this.isConfigDependent=!Vr(te.expression)}evaluateWithoutErrorHandling(C,te,le,ce,he,ue){return this._styleExpression.evaluateWithoutErrorHandling(C,te,le,ce,he,ue)}evaluate(C,te,le,ce,he,ue){return this._styleExpression.evaluate(C,te,le,ce,he,ue)}}class Ao{constructor(C,te,le,ce,he){this.kind=C,this.zoomStops=le,this._styleExpression=te,this.isStateDependent="camera"!==C&&!Ur(te.expression),this.isLightConstant=he,this.isConfigDependent=!Vr(te.expression),this.interpolationType=ce}evaluateWithoutErrorHandling(C,te,le,ce,he,ue){return this._styleExpression.evaluateWithoutErrorHandling(C,te,le,ce,he,ue)}evaluate(C,te,le,ce,he,ue){return this._styleExpression.evaluate(C,te,le,ce,he,ue)}interpolationFactor(C,te,le){return this.interpolationType?Ds.interpolationFactor(this.interpolationType,C,te,le):0}}function So(C,te,le){if("error"===(C=Eo(C,te,le)).result)return C;const ce=C.value.expression,he=Nr(ce);if(!he&&!co(te))return ao([new Di("","data expressions not supported")]);const ue=jr(ce,["zoom","pitch","distance-from-center"]);if(!ue&&!uo(te))return ao([new Di("","zoom expressions not supported")]);const de=jr(ce,["measure-light"]);if(!de&&!ho(te))return ao([new Di("","measure-light expression not supported")]);const _e=te.expression&&te.expression.relaxZoomRestriction,ye=Co(ce);return ye||ue||_e?ye instanceof Di?ao([ye]):ye instanceof Ds&&!po(te)?ao([new Di("",'"interpolate" expressions cannot be used with this property')]):so(ye?new Ao(he?"camera":"composite",C.value,ye.labels,ye instanceof Ds?ye.interpolation:void 0,de):new Mo(he?"constant":"source",C.value,de)):ao([new Di("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class Io{constructor(C,te){this._parameters=C,this._specification=te,Lt(this,_o(this._parameters,this._specification))}static deserialize(C){return new Io(C._parameters,C._specification)}static serialize(C){return{_parameters:C._parameters,_specification:C._specification}}}function Co(C){let te=null;if(C instanceof Fs)te=Co(C.result);else if(C instanceof Ps){for(const le of C.args)if(te=Co(le),te)break}else(C instanceof jn||C instanceof Ds)&&C.input instanceof sn&&"zoom"===C.input.name&&(te=C);return te instanceof Di||C.eachChild((C=>{const le=Co(C);le instanceof Di?te=le:te&&le&&te!==le&&(te=new Di("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),te}function zo(C){const te=C.key,le=C.value,ce=C.valueSpec||{},he=C.objectElementValidators||{},ue=C.style,de=C.styleSpec;let _e=[];const ye=Si(le);if("object"!==ye)return[new Dt(te,le,`object expected, ${ye} found`)];for(const C in le){const ye=C.split(".")[0];let ve;he[ye]?ve=he[ye]:ce[ye]?ve=ds:he["*"]?ve=he["*"]:ce["*"]&&(ve=ds),ve?_e=_e.concat(ve({key:(te?`${te}.`:te)+C,value:le[C],valueSpec:ce[ye]||ce["*"],style:ue,styleSpec:de,object:le,objectKey:C},le)):_e.push(new Rt(te,le[C],`unknown property "${C}"`))}for(const C in ce)he[C]||ce[C].required&&void 0===ce[C].default&&void 0===le[C]&&_e.push(new Dt(te,le,`missing required property "${C}"`));return _e}function Po(C){const te=C.value,le=C.valueSpec,ce=C.style,he=C.styleSpec,ue=C.key,de=C.arrayElementValidator||ds;if("array"!==Si(te))return[new Dt(ue,te,`array expected, ${Si(te)} found`)];if(le.length&&te.length!==le.length)return[new Dt(ue,te,`array length ${le.length} expected, length ${te.length} found`)];if(le["min-length"]&&te.length<le["min-length"])return[new Dt(ue,te,`array length at least ${le["min-length"]} expected, length ${te.length} found`)];let _e={type:le.value,values:le.values,minimum:le.minimum,maximum:le.maximum,function:void 0};he.$version<7&&(_e.function=le.function),"object"===Si(le.value)&&(_e=le.value);let ye=[];for(let C=0;C<te.length;C++)ye=ye.concat(de({array:te,arrayIndex:C,value:te[C],valueSpec:_e,style:ce,styleSpec:he,key:`${ue}[${C}]`},!0));return ye}function Do(C){const te=C.key,le=C.value,ce=C.valueSpec;let he=Si(le);if("number"===he&&le!=le&&(he="NaN"),"number"!==he)return[new Dt(te,le,`number expected, ${he} found`)];if("minimum"in ce){let he=ce.minimum;if("array"===Si(ce.minimum)&&(he=ce.minimum[C.arrayIndex]),le<he)return[new Dt(te,le,`${le} is less than the minimum value ${he}`)]}if("maximum"in ce){let he=ce.maximum;if("array"===Si(ce.maximum)&&(he=ce.maximum[C.arrayIndex]),le>he)return[new Dt(te,le,`${le} is greater than the maximum value ${he}`)]}return[]}function Ro(C){const te=C.valueSpec,le=kt(C.value.type);let ce,he,ue,de={};const _e="categorical"!==le&&void 0===C.value.property,ye=!_e,ve="array"===Si(C.value.stops)&&"array"===Si(C.value.stops[0])&&"object"===Si(C.value.stops[0][0]),Se=zo({key:C.key,value:C.value,valueSpec:C.styleSpec.function,style:C.style,styleSpec:C.styleSpec,objectElementValidators:{stops:function(C){if("identity"===le)return[new Dt(C.key,C.value,'identity function may not have a "stops" property')];let te=[];const ce=C.value;return te=te.concat(Po({key:C.key,value:ce,valueSpec:C.valueSpec,style:C.style,styleSpec:C.styleSpec,arrayElementValidator:u})),"array"===Si(ce)&&0===ce.length&&te.push(new Dt(C.key,ce,"array must have at least one stop")),te},default:function(C){return ds({key:C.key,value:C.value,valueSpec:te,style:C.style,styleSpec:C.styleSpec})}}});return"identity"===le&&_e&&Se.push(new Dt(C.key,C.value,'missing required property "property"')),"identity"===le||C.value.stops||Se.push(new Dt(C.key,C.value,'missing required property "stops"')),"exponential"===le&&C.valueSpec.expression&&!po(C.valueSpec)&&Se.push(new Dt(C.key,C.value,"exponential functions not supported")),C.styleSpec.$version>=8&&(ye&&!co(C.valueSpec)?Se.push(new Dt(C.key,C.value,"property functions not supported")):_e&&!uo(C.valueSpec)&&Se.push(new Dt(C.key,C.value,"zoom functions not supported"))),"categorical"!==le&&!ve||void 0!==C.value.property||Se.push(new Dt(C.key,C.value,'"property" property is required')),Se;function u(C){let le=[];const ce=C.value,_e=C.key;if("array"!==Si(ce))return[new Dt(_e,ce,`array expected, ${Si(ce)} found`)];if(2!==ce.length)return[new Dt(_e,ce,`array length 2 expected, length ${ce.length} found`)];if(ve){if("object"!==Si(ce[0]))return[new Dt(_e,ce,`object expected, ${Si(ce[0])} found`)];if(void 0===ce[0].zoom)return[new Dt(_e,ce,"object stop key must have zoom")];if(void 0===ce[0].value)return[new Dt(_e,ce,"object stop key must have value")];const te=kt(ce[0].zoom);if("number"!=typeof te)return[new Dt(_e,ce[0].zoom,"stop zoom values must be numbers")];if(ue&&ue>te)return[new Dt(_e,ce[0].zoom,"stop zoom values must appear in ascending order")];te!==ue&&(ue=te,he=void 0,de={}),le=le.concat(zo({key:`${_e}[0]`,value:ce[0],valueSpec:{zoom:{}},style:C.style,styleSpec:C.styleSpec,objectElementValidators:{zoom:Do,value:d}}))}else le=le.concat(d({key:`${_e}[0]`,value:ce[0],valueSpec:{},style:C.style,styleSpec:C.styleSpec},ce));return To(Ot(ce[1]))?le.concat([new Dt(`${_e}[1]`,ce[1],"expressions are not allowed in function stops.")]):le.concat(ds({key:`${_e}[1]`,value:ce[1],valueSpec:te,style:C.style,styleSpec:C.styleSpec}))}function d(C,ue){const _e=Si(C.value),ye=kt(C.value),ve=null!==C.value?C.value:ue;if(ce){if(_e!==ce)return[new Dt(C.key,ve,`${_e} stop domain type must match previous stop domain type ${ce}`)]}else ce=_e;if("number"!==_e&&"string"!==_e&&"boolean"!==_e&&"number"!=typeof ye&&"string"!=typeof ye&&"boolean"!=typeof ye)return[new Dt(C.key,ve,"stop domain value must be a number, string, or boolean")];if("number"!==_e&&"categorical"!==le){let ce=`number expected, ${_e} found`;return co(te)&&void 0===le&&(ce+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new Dt(C.key,ve,ce)]}return"categorical"!==le||"number"!==_e||"number"==typeof ye&&isFinite(ye)&&Math.floor(ye)===ye?"categorical"!==le&&"number"===_e&&"number"==typeof ye&&"number"==typeof he&&void 0!==he&&ye<he?[new Dt(C.key,ve,"stop domain values must appear in ascending order")]:(he=ye,"categorical"===le&&ye in de?[new Dt(C.key,ve,"stop domain values must be unique")]:(de[ye]=!0,[])):[new Dt(C.key,ve,`integer expected, found ${String(ye)}`)]}}function Lo(C){const te=("property"===C.expressionContext?So:Eo)(Ot(C.value),C.valueSpec);if("error"===te.result)return te.value.map((te=>new Dt(`${C.key}${te.key}`,C.value,te.message)));const le=te.value.expression||te.value._styleExpression.expression;if("property"===C.expressionContext&&"text-font"===C.propertyKey&&!le.outputDefined())return[new Dt(C.key,C.value,`Invalid data expression for "${C.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===C.expressionContext&&"layout"===C.propertyType&&!Ur(le))return[new Dt(C.key,C.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===C.expressionContext)return ko(le,C);if(C.expressionContext&&0===C.expressionContext.indexOf("cluster")){if(!jr(le,["zoom","feature-state"]))return[new Dt(C.key,C.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===C.expressionContext&&!Nr(le))return[new Dt(C.key,C.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function ko(C,te){const le=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(te.valueSpec&&te.valueSpec.expression)for(const C of te.valueSpec.expression.parameters)le.delete(C);if(0===le.size)return[];const ce=[];return C instanceof sn&&le.has(C.name)?[new Dt(te.key,te.value,`["${C.name}"] expression is not supported in a filter for a ${te.object.type} layer with id: ${te.object.id}`)]:(C.eachChild((C=>{ce.push(...ko(C,te))})),ce)}function Oo(C){const te=C.key,le=C.value,ce=C.valueSpec,he=[];return Array.isArray(ce.values)?-1===ce.values.indexOf(kt(le))&&he.push(new Dt(te,le,`expected one of [${ce.values.join(", ")}], ${JSON.stringify(le)} found`)):-1===Object.keys(ce.values).indexOf(kt(le))&&he.push(new Dt(te,le,`expected one of [${Object.keys(ce.values).join(", ")}], ${JSON.stringify(le)} found`)),he}function Bo(C){if(!0===C||!1===C)return!0;if(!Array.isArray(C)||0===C.length)return!1;switch(C[0]){case"has":return C.length>=2&&"$id"!==C[1]&&"$type"!==C[1];case"in":return C.length>=3&&("string"!=typeof C[1]||Array.isArray(C[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==C.length||Array.isArray(C[1])||Array.isArray(C[2]);case"any":case"all":for(const te of C.slice(1))if(!Bo(te)&&"boolean"!=typeof te)return!1;return!0;default:return!0}}function Fo(C,te="fill"){if(null==C)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Bo(C)||(C=Zo(C));const le=C;let ce=!0;try{ce=function(C){if(!Vo(C))return C;let te=Ot(C);return Uo(te),te=No(te),te}(le)}catch(C){console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n${JSON.stringify(le,null,2)}\n        `)}const he=zi[`filter_${te}`],ue=Eo(ce,he);let de=null;if("error"===ue.result)throw new Error(ue.value.map((C=>`${C.key}: ${C.message}`)).join(", "));de=(C,te,le)=>ue.value.evaluate(C,te,{},le);let _e=null,ye=null;if(ce!==le){const C=Eo(le,he);if("error"===C.result)throw new Error(C.value.map((C=>`${C.key}: ${C.message}`)).join(", "));_e=(te,le,ce,he,ue)=>C.value.evaluate(te,le,{},ce,void 0,void 0,he,ue),ye=!Nr(C.value.expression)}return{filter:de,dynamicFilter:_e||void 0,needGeometry:qo(ce),needFeature:!!ye}}function No(C){if(!Array.isArray(C))return C;const te=function(C){if(wl.has(C[0]))for(let te=1;te<C.length;te++)if(Vo(C[te]))return!0;return C}(C);return!0===te?te:te.map((C=>No(C)))}function Uo(C){let te=!1;const le=[];if("case"===C[0]){for(let ce=1;ce<C.length-1;ce+=2)te=te||Vo(C[ce]),le.push(C[ce+1]);le.push(C[C.length-1])}else if("match"===C[0]){te=te||Vo(C[1]);for(let te=2;te<C.length-1;te+=2)le.push(C[te+1]);le.push(C[C.length-1])}else if("step"===C[0]){te=te||Vo(C[1]);for(let te=1;te<C.length-1;te+=2)le.push(C[te+1])}te&&(C.length=0,C.push("any",...le));for(let te=1;te<C.length;te++)Uo(C[te])}function Vo(C){if(!Array.isArray(C))return!1;if("pitch"===(te=C[0])||"distance-from-center"===te)return!0;var te;for(let te=1;te<C.length;te++)if(Vo(C[te]))return!0;return!1}const wl=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Go(C,te){return C<te?-1:C>te?1:0}function qo(C){if(!Array.isArray(C))return!1;if("within"===C[0]||"distance"===C[0])return!0;for(let te=1;te<C.length;te++)if(qo(C[te]))return!0;return!1}function Zo(C){if(!C)return!0;const te=C[0];return C.length<=1?"any"!==te:"=="===te?$o(C[1],C[2],"=="):"!="===te?Xo($o(C[1],C[2],"==")):"<"===te||">"===te||"<="===te||">="===te?$o(C[1],C[2],te):"any"===te?(le=C.slice(1),["any"].concat(le.map(Zo))):"all"===te?["all"].concat(C.slice(1).map(Zo)):"none"===te?["all"].concat(C.slice(1).map(Zo).map(Xo)):"in"===te?Wo(C[1],C.slice(2)):"!in"===te?Xo(Wo(C[1],C.slice(2))):"has"===te?Ho(C[1]):"!has"!==te||Xo(Ho(C[1]));var le}function $o(C,te,le){switch(C){case"$type":return[`filter-type-${le}`,te];case"$id":return[`filter-id-${le}`,te];default:return[`filter-${le}`,C,te]}}function Wo(C,te){if(0===te.length)return!1;switch(C){case"$type":return["filter-type-in",["literal",te]];case"$id":return["filter-id-in",["literal",te]];default:return te.length>200&&!te.some((C=>typeof C!=typeof te[0]))?["filter-in-large",C,["literal",te.sort(Go)]]:["filter-in-small",C,["literal",te]]}}function Ho(C){switch(C){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",C]}}function Xo(C){return["!",C]}function Yo(C){return Bo(Ot(C.value))?Lo(Lt({},C,{expressionContext:"filter",valueSpec:C.styleSpec[`filter_${C.layerType||"fill"}`]})):Ko(C)}function Ko(C){const te=C.value,le=C.key;if("array"!==Si(te))return[new Dt(le,te,`array expected, ${Si(te)} found`)];const ce=C.styleSpec;let he,ue=[];if(te.length<1)return[new Dt(le,te,"filter array must have at least 1 element")];switch(ue=ue.concat(Oo({key:`${le}[0]`,value:te[0],valueSpec:ce.filter_operator,style:C.style,styleSpec:C.styleSpec})),kt(te[0])){case"<":case"<=":case">":case">=":te.length>=2&&"$type"===kt(te[1])&&ue.push(new Dt(le,te,`"$type" cannot be use with operator "${te[0]}"`));case"==":case"!=":3!==te.length&&ue.push(new Dt(le,te,`filter array for operator "${te[0]}" must have 3 elements`));case"in":case"!in":te.length>=2&&(he=Si(te[1]),"string"!==he&&ue.push(new Dt(`${le}[1]`,te[1],`string expected, ${he} found`)));for(let de=2;de<te.length;de++)he=Si(te[de]),"$type"===kt(te[1])?ue=ue.concat(Oo({key:`${le}[${de}]`,value:te[de],valueSpec:ce.geometry_type,style:C.style,styleSpec:C.styleSpec})):"string"!==he&&"number"!==he&&"boolean"!==he&&ue.push(new Dt(`${le}[${de}]`,te[de],`string, number, or boolean expected, ${he} found`));break;case"any":case"all":case"none":for(let ce=1;ce<te.length;ce++)ue=ue.concat(Ko({key:`${le}[${ce}]`,value:te[ce],style:C.style,styleSpec:C.styleSpec}));break;case"has":case"!has":he=Si(te[1]),2!==te.length?ue.push(new Dt(le,te,`filter array for "${te[0]}" operator must have 2 elements`)):"string"!==he&&ue.push(new Dt(`${le}[1]`,te[1],`string expected, ${he} found`))}return ue}function Jo(C,te){const le=C.key,ce=C.style,he=C.layer,ue=C.styleSpec,de=C.value,_e=C.objectKey,ye=ue[`${te}_${C.layerType}`];if(!ye)return[];const ve=_e.match(/^(.*)-transition$/);if("paint"===te&&ve&&ye[ve[1]]&&ye[ve[1]].transition)return ds({key:le,value:de,valueSpec:ue.transition,style:ce,styleSpec:ue});const Se=C.valueSpec||ye[_e];if(!Se)return[new Rt(le,de,`unknown property "${_e}"`)];let Me;if("string"===Si(de)&&co(Se)&&!Se.tokens&&(Me=/^{([^}]+)}$/.exec(de))){const C=`\`{ "type": "identity", "property": ${Me?JSON.stringify(Me[1]):'"_"'} }\``;return[new Dt(le,de,`"${_e}" does not support interpolation syntax\nUse an identity property function instead: ${C}.`)]}const Ae=[];if("symbol"===C.layerType)"text-field"!==_e||!ce||ce.glyphs||ce.imports||Ae.push(new Dt(le,de,'use of "text-field" requires a style "glyphs" property')),"text-font"===_e&&fo(Ot(de))&&"identity"===kt(de.type)&&Ae.push(new Dt(le,de,'"text-font" does not support identity functions'));else if("model"===C.layerType&&"paint"===te&&he&&he.layout&&he.layout.hasOwnProperty("model-id")&&co(Se)&&(ho(Se)||uo(Se))){const C=So(Ot(de),Se),te=C.value.expression||C.value._styleExpression.expression;te&&!jr(te,["measure-light"])&&("model-emissive-strength"===_e&&Nr(te)&&Ur(te)||Ae.push(new Dt(le,de,`${_e} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return Ae.concat(ds({key:C.key,value:de,valueSpec:Se,style:ce,styleSpec:ue,expressionContext:"property",propertyType:te,propertyKey:_e}))}function Qo(C){return Jo(C,"paint")}function es(C){return Jo(C,"layout")}function ts(C){let te=[];const le=C.value,ce=C.key,he=C.style,ue=C.styleSpec;le.type||le.ref||te.push(new Dt(ce,le,'either "type" or "ref" is required'));let de=kt(le.type);const _e=kt(le.ref);if(le.id){const ue=kt(le.id);for(let de=0;de<C.arrayIndex;de++){const C=he.layers[de];kt(C.id)===ue&&te.push(new Dt(ce,le.id,`duplicate layer id "${le.id}", previously used at line ${C.id.__line__}`))}}if("ref"in le){let C;["type","source","source-layer","filter","layout"].forEach((C=>{C in le&&te.push(new Dt(ce,le[C],`"${C}" is prohibited for ref layers`))})),he.layers.forEach((te=>{kt(te.id)===_e&&(C=te)})),C?C.ref?te.push(new Dt(ce,le.ref,"ref cannot reference another ref layer")):de=kt(C.type):"string"==typeof _e&&te.push(new Dt(ce,le.ref,`ref layer "${_e}" not found`))}else if("background"!==de&&"sky"!==de&&"slot"!==de)if(le.source){const C=he.sources&&he.sources[le.source],ue=C&&kt(C.type);C?"vector"===ue&&"raster"===de?te.push(new Dt(ce,le.source,`layer "${le.id}" requires a raster source`)):"raster"===ue&&"raster"!==de?te.push(new Dt(ce,le.source,`layer "${le.id}" requires a vector source`)):"vector"!==ue||le["source-layer"]?"raster-dem"===ue&&"hillshade"!==de?te.push(new Dt(ce,le.source,"raster-dem source can only be used with layer type 'hillshade'.")):"line"!==de||!le.paint||!le.paint["line-gradient"]&&!le.paint["line-trim-offset"]||"geojson"===ue&&C.lineMetrics||te.push(new Dt(ce,le,`layer "${le.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):te.push(new Dt(ce,le,`layer "${le.id}" must specify a "source-layer"`)):te.push(new Dt(ce,le.source,`source "${le.source}" not found`))}else te.push(new Dt(ce,le,'missing required property "source"'));return te=te.concat(zo({key:ce,value:le,valueSpec:ue.layer,style:C.style,styleSpec:C.styleSpec,objectElementValidators:{"*":()=>[],type:()=>ds({key:`${ce}.type`,value:le.type,valueSpec:ue.layer.type,style:C.style,styleSpec:C.styleSpec,object:le,objectKey:"type"}),filter:C=>Yo(Lt({layerType:de},C)),layout:C=>zo({layer:le,key:C.key,value:C.value,valueSpec:{},style:C.style,styleSpec:C.styleSpec,objectElementValidators:{"*":C=>es(Lt({layerType:de},C))}}),paint:C=>zo({layer:le,key:C.key,value:C.value,valueSpec:{},style:C.style,styleSpec:C.styleSpec,objectElementValidators:{"*":C=>Qo(Lt({layerType:de,layer:le},C))}})}})),te}function is(C){const te=C.value,le=C.key,ce=Si(te);return"string"!==ce?[new Dt(le,te,`string expected, ${ce} found`)]:[]}const Tl={promoteId:function({key:C,value:te}){if("string"===Si(te))return is({key:C,value:te});{const le=[];for(const ce in te)le.push(...is({key:`${C}.${ce}`,value:te[ce]}));return le}}};function ns(C){const te=C.value,le=C.key,ce=C.styleSpec,he=C.style;if(!te.type)return[new Dt(le,te,'"type" is required')];const ue=kt(te.type);let de=[];switch(["vector","raster","raster-dem"].includes(ue)&&(te.url||te.tiles||de.push(new Dt(le,te,'Either "url" or "tiles" is required.'))),ue){case"vector":case"raster":case"raster-dem":return de=de.concat(zo({key:le,value:te,valueSpec:ce[`source_${ue.replace("-","_")}`],style:C.style,styleSpec:ce,objectElementValidators:Tl})),de;case"geojson":if(de=zo({key:le,value:te,valueSpec:ce.source_geojson,style:he,styleSpec:ce,objectElementValidators:Tl}),te.cluster)for(const C in te.clusterProperties){const[ce,he]=te.clusterProperties[C],ue="string"==typeof ce?[ce,["accumulated"],["get",C]]:ce;de.push(...Lo({key:`${le}.${C}.map`,value:he,expressionContext:"cluster-map"})),de.push(...Lo({key:`${le}.${C}.reduce`,value:ue,expressionContext:"cluster-reduce"}))}return de;case"video":return zo({key:le,value:te,valueSpec:ce.source_video,style:he,styleSpec:ce});case"image":return zo({key:le,value:te,valueSpec:ce.source_image,style:he,styleSpec:ce});case"canvas":return[new Dt(le,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Oo({key:`${le}.type`,value:te.type,valueSpec:{values:os(ce)},style:he,styleSpec:ce})}}function os(C){return C.source.reduce(((te,le)=>{const ce=C[le];return"enum"===ce.type.type&&(te=te.concat(Object.keys(ce.type.values))),te}),[])}function ss(C){const te=C.value;let le=[];if(!te)return le;const ce=Si(te);return"string"!==ce?(le=le.concat([new Dt(C.key,te,`string expected, "${ce}" found`)]),le):(function(C){const te=-1===C.indexOf("://");try{return new URL(C,te?"http://example.com":void 0),!0}catch(C){return!1}}(te)||(le=le.concat([new Dt(C.key,te,`invalid url "${te}"`)])),le)}function as(C){const te=C.value,le=C.styleSpec,ce=le.light,he=C.style;let ue=[];const de=Si(te);if(void 0===te)return ue;if("object"!==de)return ue=ue.concat([new Dt("light",te,`object expected, ${de} found`)]),ue;for(const C in te){const de=C.match(/^(.*)-transition$/);ue=ue.concat(de&&ce[de[1]]&&ce[de[1]].transition?ds({key:C,value:te[C],valueSpec:le.transition,style:he,styleSpec:le}):ce[C]?ds({key:C,value:te[C],valueSpec:ce[C],style:he,styleSpec:le}):[new Dt(C,te[C],`unknown property "${C}"`)])}return ue}function ls(C){const te=C.value;let le=[];if(!te)return le;const ce=Si(te);if("object"!==ce)return le=le.concat([new Dt("light-3d",te,`object expected, ${ce} found`)]),le;const he=C.styleSpec,ue=he["light-3d"],de=C.key,_e=C.style,ye=C.style.lights;for(const C of["type","id"])if(!(C in te))return le=le.concat([new Dt("light-3d",te,`missing property ${C} on light`)]),le;if(te.type&&ye)for(let ce=0;ce<C.arrayIndex;ce++){const C=kt(te.type),he=ye[ce];kt(he.type)===C&&le.push(new Dt(de,te.id,`duplicate light type "${te.type}", previously defined at line ${he.id.__line__}`))}const ve=`properties_light_${te.type}`;if(!(ve in he))return le=le.concat([new Dt("light-3d",te,`Invalid light type ${te.type}`)]),le;const Se=he[ve];for(const ce in te)if("properties"===ce){const ue=te[ce],de=Si(ue);if("object"!==de)return le=le.concat([new Dt("properties",ue,`object expected, ${de} found`)]),le;for(const te in ue)le=le.concat(Se[te]?ds({key:te,value:ue[te],valueSpec:Se[te],style:_e,styleSpec:he}):[new Rt(C.key,ue[te],`unknown property "${te}"`)])}else{const C=ce.match(/^(.*)-transition$/);le=le.concat(C&&ue[C[1]]&&ue[C[1]].transition?ds({key:ce,value:te[ce],valueSpec:he.transition,style:_e,styleSpec:he}):ue[ce]?ds({key:ce,value:te[ce],valueSpec:ue[ce],style:_e,styleSpec:he}):[new Rt(ce,te[ce],`unknown property "${ce}"`)])}return le}function cs(C){const te=C.value,le=C.key,ce=C.style,he=C.styleSpec,ue=he.terrain;let de=[];const _e=Si(te);if(void 0===te)return de;if("null"===_e)return de;if("object"!==_e)return de=de.concat([new Dt("terrain",te,`object expected, ${_e} found`)]),de;for(const C in te){const le=C.match(/^(.*)-transition$/);de=de.concat(le&&ue[le[1]]&&ue[le[1]].transition?ds({key:C,value:te[C],valueSpec:he.transition,style:ce,styleSpec:he}):ue[C]?ds({key:C,value:te[C],valueSpec:ue[C],style:ce,styleSpec:he}):[new Rt(C,te[C],`unknown property "${C}"`)])}if(te.source){const C=ce.sources&&ce.sources[te.source],he=C&&kt(C.type);C?"raster-dem"!==he&&de.push(new Dt(le,te.source,`terrain cannot be used with a source of type ${String(he)}, it only be used with a "raster-dem" source type`)):de.push(new Dt(le,te.source,`source "${te.source}" not found`))}else de.push(new Dt(le,te,'terrain is missing required property "source"'));return de}function hs(C){const te=C.value,le=C.style,ce=C.styleSpec,he=ce.fog;let ue=[];const de=Si(te);if(void 0===te)return ue;if("object"!==de)return ue=ue.concat([new Dt("fog",te,`object expected, ${de} found`)]),ue;for(const C in te){const de=C.match(/^(.*)-transition$/);ue=ue.concat(de&&he[de[1]]&&he[de[1]].transition?ds({key:C,value:te[C],valueSpec:ce.transition,style:le,styleSpec:ce}):he[C]?ds({key:C,value:te[C],valueSpec:he[C],style:le,styleSpec:ce}):[new Rt(C,te[C],`unknown property "${C}"`)])}return ue}const Sl={"*":()=>[],array:Po,boolean:function(C){const te=C.value,le=C.key,ce=Si(te);return"boolean"!==ce?[new Dt(le,te,`boolean expected, ${ce} found`)]:[]},number:Do,color:function(C){const te=C.key,le=C.value,ce=Si(le);return"string"!==ce?[new Dt(te,le,`color expected, ${ce} found`)]:null===dr(le)?[new Dt(te,le,`color expected, "${le}" found`)]:[]},enum:Oo,filter:Yo,function:Ro,layer:ts,object:zo,source:ns,model:ss,light:as,"light-3d":ls,terrain:cs,fog:hs,string:is,formatted:function(C){return 0===is(C).length?[]:Lo(C)},resolvedImage:function(C){return 0===is(C).length?[]:Lo(C)},projection:function(C){const te=C.value,le=C.styleSpec,ce=le.projection,he=C.style;let ue=[];const de=Si(te);if("object"===de)for(const C in te)ue=ue.concat(ds({key:C,value:te[C],valueSpec:ce[C],style:he,styleSpec:le}));else"string"!==de&&(ue=ue.concat([new Dt("projection",te,`object or string expected, ${de} found`)]));return ue},import:function(C){const{value:te,styleSpec:le}=C,{data:ce,...he}=te;Object.defineProperty(he,"__line__",{value:te.__line__,enumerable:!1});let ue=zo(Lt({},C,{value:he,valueSpec:le.import}));return""===kt(he.id)&&ue.push(new Dt(`${C.key}.id`,he,"import id can't be an empty string")),ce&&(ue=ue.concat(fs(ce,le,{key:`${C.key}.data`}))),ue}};function ds(C,te=!1){const le=C.value,ce=C.valueSpec,he=C.styleSpec;if(ce.expression&&fo(kt(le)))return Ro(C);if(ce.expression&&To(Ot(le)))return Lo(C);if(ce.type&&Sl[ce.type]){const le=Sl[ce.type](C);return!0===te&&le.length>0&&"array"===Si(C.value)?Lo(C):le}return zo(Lt({},C,{valueSpec:ce.type?he[ce.type]:ce}))}function ps(C){const te=C.value,le=C.key,ce=is(C);return ce.length||(-1===te.indexOf("{fontstack}")&&ce.push(new Dt(le,te,'"glyphs" url must include a "{fontstack}" token')),-1===te.indexOf("{range}")&&ce.push(new Dt(le,te,'"glyphs" url must include a "{range}" token'))),ce}function fs(C,te=zi,le={}){return ds({key:le.key||"",value:C,valueSpec:te.$root,styleSpec:te,style:C,objectElementValidators:{glyphs:ps,"*":()=>[]}})}function ms(C,te=zi){return As(fs(C,te))}const _s=C=>As(ns(C)),gs=C=>As(as(C)),ys=C=>As(ls(C)),xs=C=>As(cs(C)),vs=C=>As(hs(C)),bs=C=>As(ts(C)),ws=C=>As(Yo(C)),Ts=C=>As(Qo(C)),Es=C=>As(es(C)),Ms=C=>As(ss(C));function As(C){return C.slice().sort(((C,te)=>C.line&&te.line?C.line-te.line:0))}function Ss(C,te){let le=!1;if(te&&te.length)for(const ce of te)ce instanceof Rt?H(ce.message):(C.fire(new Ct(new Error(ce.message))),le=!0);return le}var Ml=zs,El=3;function zs(C,le,ce){var he=(this||te).cells=[];if(C instanceof ArrayBuffer){(this||te).arrayBuffer=C;var ue=new Int32Array((this||te).arrayBuffer);C=ue[0],(this||te).d=(le=ue[1])+2*(ce=ue[2]);for(var de=0;de<(this||te).d*(this||te).d;de++){var _e=ue[El+de],ye=ue[El+de+1];he.push(_e===ye?null:ue.subarray(_e,ye))}var ve=ue[El+he.length+1];(this||te).keys=ue.subarray(ue[El+he.length],ve),(this||te).bboxes=ue.subarray(ve),(this||te).insert=(this||te)._insertReadonly}else{(this||te).d=le+2*ce;for(var Se=0;Se<(this||te).d*(this||te).d;Se++)he.push([]);(this||te).keys=[],(this||te).bboxes=[]}(this||te).n=le,(this||te).extent=C,(this||te).padding=ce,(this||te).scale=le/C,(this||te).uid=0;var Me=ce/le*C;(this||te).min=-Me,(this||te).max=C+Me}zs.prototype.insert=function(C,le,ce,he,ue){this._forEachCell(le,ce,he,ue,(this||te)._insertCell,(this||te).uid++),(this||te).keys.push(C),(this||te).bboxes.push(le),(this||te).bboxes.push(ce),(this||te).bboxes.push(he),(this||te).bboxes.push(ue)},zs.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},zs.prototype._insertCell=function(C,le,ce,he,ue,de){(this||te).cells[ue].push(de)},zs.prototype.query=function(C,le,ce,he,ue){var de=(this||te).min,_e=(this||te).max;if(C<=de&&le<=de&&_e<=ce&&_e<=he&&!ue)return Array.prototype.slice.call((this||te).keys);var ye=[];return this._forEachCell(C,le,ce,he,(this||te)._queryCell,ye,{},ue),ye},zs.prototype._queryCell=function(C,le,ce,he,ue,de,_e,ye){var ve=(this||te).cells[ue];if(null!==ve)for(var Se=(this||te).keys,Me=(this||te).bboxes,Ae=0;Ae<ve.length;Ae++){var Ce=ve[Ae];if(void 0===_e[Ce]){var Oe=4*Ce;(ye?ye(Me[Oe+0],Me[Oe+1],Me[Oe+2],Me[Oe+3]):C<=Me[Oe+2]&&le<=Me[Oe+3]&&ce>=Me[Oe+0]&&he>=Me[Oe+1])?(_e[Ce]=!0,de.push(Se[Ce])):_e[Ce]=!1}}},zs.prototype._forEachCell=function(C,le,ce,he,ue,de,_e,ye){for(var ve=this._convertToCellCoord(C),Se=this._convertToCellCoord(le),Me=this._convertToCellCoord(ce),Ae=this._convertToCellCoord(he),Ce=ve;Ce<=Me;Ce++)for(var Oe=Se;Oe<=Ae;Oe++){var Ne=(this||te).d*Oe+Ce;if((!ye||ye(this._convertFromCellCoord(Ce),this._convertFromCellCoord(Oe),this._convertFromCellCoord(Ce+1),this._convertFromCellCoord(Oe+1)))&&ue.call(this||te,C,le,ce,he,Ne,de,_e,ye))return}},zs.prototype._convertFromCellCoord=function(C){return(C-(this||te).padding)/(this||te).scale},zs.prototype._convertToCellCoord=function(C){return Math.max(0,Math.min((this||te).d-1,Math.floor(C*(this||te).scale)+(this||te).padding))},zs.prototype.toArrayBuffer=function(){if((this||te).arrayBuffer)return(this||te).arrayBuffer;for(var C=(this||te).cells,le=El+(this||te).cells.length+1+1,ce=0,he=0;he<(this||te).cells.length;he++)ce+=(this||te).cells[he].length;var ue=new Int32Array(le+ce+(this||te).keys.length+(this||te).bboxes.length);ue[0]=(this||te).extent,ue[1]=(this||te).n,ue[2]=(this||te).padding;for(var de=le,_e=0;_e<C.length;_e++){var ye=C[_e];ue[El+_e]=de,ue.set(ye,de),de+=ye.length}return ue[El+C.length]=de,ue.set((this||te).keys,de),ue[El+C.length+1]=de+=(this||te).keys.length,ue.set((this||te).bboxes,de),de+=(this||te).bboxes.length,ue.buffer};var Al=d(Ml);const Il={};function Rs(C,te,le={}){Object.defineProperty(C,"_classRegistryKey",{value:te,writeable:!1}),Il[te]={klass:C,omit:le.omit||[]}}Rs(Object,"Object"),Al.serialize=function(C,te){const le=C.toArrayBuffer();return te&&te.add(le),{buffer:le}},Al.deserialize=function(C){return new Al(C.buffer)},Object.defineProperty(Al,"name",{value:"Grid"}),Rs(Al,"Grid"),Rs(qr,"Color"),Rs(Error,"Error"),Rs(xe,"AJAXError"),Rs(fi,"ResolvedImage"),Rs(Io,"StylePropertyFunction"),Rs(wo,"StyleExpression",{omit:["_evaluator"]}),Rs(Ao,"ZoomDependentExpression"),Rs(Mo,"ZoomConstantExpression"),Rs(sn,"CompoundExpression",{omit:["_evaluate"]});for(const C in bl)Il[bl[C]._classRegistryKey]||Rs(bl[C],`Expression${C}`);function Ls(C){return C&&"undefined"!=typeof ArrayBuffer&&(C instanceof ArrayBuffer||C.constructor&&"ArrayBuffer"===C.constructor.name)}function ks(C){return le.ImageBitmap&&C instanceof le.ImageBitmap}function Os(C,te){if(null==C||"boolean"==typeof C||"number"==typeof C||"string"==typeof C||C instanceof Boolean||C instanceof Number||C instanceof String||C instanceof Date||C instanceof RegExp)return C;if(Ls(C)||ks(C))return te&&te.add(C),C;if(ArrayBuffer.isView(C)){const le=C;return te&&te.add(le.buffer),le}if(C instanceof le.ImageData)return te&&te.add(C.data.buffer),C;if(Array.isArray(C)){const le=[];for(const ce of C)le.push(Os(ce,te));return le}if(C instanceof Map){const te={$name:"Map"};for(const[le,ce]of C.entries())te[le]=Os(ce);return te}if("object"==typeof C){const le=C.constructor,ce=le._classRegistryKey;if(!ce)throw new Error(`can't serialize object of unregistered class ${ce}`);const he=le.serialize?le.serialize(C,te):{};if(!le.serialize){for(const le in C)C.hasOwnProperty(le)&&(Il[ce].omit.indexOf(le)>=0||(he[le]=Os(C[le],te)));C instanceof Error&&(he.message=C.message)}if(he.$name)throw new Error("$name property is reserved for worker serialization logic.");return"Object"!==ce&&(he.$name=ce),he}throw new Error("can't serialize object of type "+typeof C)}function Bs(C){if(null==C||"boolean"==typeof C||"number"==typeof C||"string"==typeof C||C instanceof Boolean||C instanceof Number||C instanceof String||C instanceof Date||C instanceof RegExp||Ls(C)||ks(C)||ArrayBuffer.isView(C)||C instanceof le.ImageData)return C;if(Array.isArray(C))return C.map(Bs);if("object"==typeof C){const te=C.$name||"Object";if("Map"===te){const te=new Map;for(const le of Object.keys(C))"$name"!==le&&te.set(le,Bs(C[le]));return te}const{klass:le}=Il[te];if(!le)throw new Error(`can't deserialize unregistered class ${te}`);if(le.deserialize)return le.deserialize(C);const ce=Object.create(le.prototype);for(const te of Object.keys(C))"$name"!==te&&(ce[te]=Bs(C[te]));return ce}throw new Error("can't deserialize object of type "+typeof C)}const Cl={"Latin-1 Supplement":C=>C>=128&&C<=255,Arabic:C=>C>=1536&&C<=1791,"Arabic Supplement":C=>C>=1872&&C<=1919,"Arabic Extended-A":C=>C>=2208&&C<=2303,"Hangul Jamo":C=>C>=4352&&C<=4607,"Unified Canadian Aboriginal Syllabics":C=>C>=5120&&C<=5759,Khmer:C=>C>=6016&&C<=6143,"Unified Canadian Aboriginal Syllabics Extended":C=>C>=6320&&C<=6399,"General Punctuation":C=>C>=8192&&C<=8303,"Letterlike Symbols":C=>C>=8448&&C<=8527,"Number Forms":C=>C>=8528&&C<=8591,"Miscellaneous Technical":C=>C>=8960&&C<=9215,"Control Pictures":C=>C>=9216&&C<=9279,"Optical Character Recognition":C=>C>=9280&&C<=9311,"Enclosed Alphanumerics":C=>C>=9312&&C<=9471,"Geometric Shapes":C=>C>=9632&&C<=9727,"Miscellaneous Symbols":C=>C>=9728&&C<=9983,"Miscellaneous Symbols and Arrows":C=>C>=11008&&C<=11263,"CJK Radicals Supplement":C=>C>=11904&&C<=12031,"Kangxi Radicals":C=>C>=12032&&C<=12255,"Ideographic Description Characters":C=>C>=12272&&C<=12287,"CJK Symbols and Punctuation":C=>C>=12288&&C<=12351,Hiragana:C=>C>=12352&&C<=12447,Katakana:C=>C>=12448&&C<=12543,Bopomofo:C=>C>=12544&&C<=12591,"Hangul Compatibility Jamo":C=>C>=12592&&C<=12687,Kanbun:C=>C>=12688&&C<=12703,"Bopomofo Extended":C=>C>=12704&&C<=12735,"CJK Strokes":C=>C>=12736&&C<=12783,"Katakana Phonetic Extensions":C=>C>=12784&&C<=12799,"Enclosed CJK Letters and Months":C=>C>=12800&&C<=13055,"CJK Compatibility":C=>C>=13056&&C<=13311,"CJK Unified Ideographs Extension A":C=>C>=13312&&C<=19903,"Yijing Hexagram Symbols":C=>C>=19904&&C<=19967,"CJK Unified Ideographs":C=>C>=19968&&C<=40959,"Yi Syllables":C=>C>=40960&&C<=42127,"Yi Radicals":C=>C>=42128&&C<=42191,"Hangul Jamo Extended-A":C=>C>=43360&&C<=43391,"Hangul Syllables":C=>C>=44032&&C<=55215,"Hangul Jamo Extended-B":C=>C>=55216&&C<=55295,"Private Use Area":C=>C>=57344&&C<=63743,"CJK Compatibility Ideographs":C=>C>=63744&&C<=64255,"Arabic Presentation Forms-A":C=>C>=64336&&C<=65023,"Vertical Forms":C=>C>=65040&&C<=65055,"CJK Compatibility Forms":C=>C>=65072&&C<=65103,"Small Form Variants":C=>C>=65104&&C<=65135,"Arabic Presentation Forms-B":C=>C>=65136&&C<=65279,"Halfwidth and Fullwidth Forms":C=>C>=65280&&C<=65519,"CJK Unified Ideographs Extension B":C=>C>=131072&&C<=173791};function Ns(C){for(const te of C)if(js(te.charCodeAt(0)))return!0;return!1}function Us(C){for(const te of C)if(!Vs(te.charCodeAt(0)))return!1;return!0}function Vs(C){return!(Cl.Arabic(C)||Cl["Arabic Supplement"](C)||Cl["Arabic Extended-A"](C)||Cl["Arabic Presentation Forms-A"](C)||Cl["Arabic Presentation Forms-B"](C))}function js(C){return!(746!==C&&747!==C&&(C<4352||!(Cl["Bopomofo Extended"](C)||Cl.Bopomofo(C)||Cl["CJK Compatibility Forms"](C)&&!(C>=65097&&C<=65103)||Cl["CJK Compatibility Ideographs"](C)||Cl["CJK Compatibility"](C)||Cl["CJK Radicals Supplement"](C)||Cl["CJK Strokes"](C)||!(!Cl["CJK Symbols and Punctuation"](C)||C>=12296&&C<=12305||C>=12308&&C<=12319||12336===C)||Cl["CJK Unified Ideographs Extension A"](C)||Cl["CJK Unified Ideographs"](C)||Cl["Enclosed CJK Letters and Months"](C)||Cl["Hangul Compatibility Jamo"](C)||Cl["Hangul Jamo Extended-A"](C)||Cl["Hangul Jamo Extended-B"](C)||Cl["Hangul Jamo"](C)||Cl["Hangul Syllables"](C)||Cl.Hiragana(C)||Cl["Ideographic Description Characters"](C)||Cl.Kanbun(C)||Cl["Kangxi Radicals"](C)||Cl["Katakana Phonetic Extensions"](C)||Cl.Katakana(C)&&12540!==C||!(!Cl["Halfwidth and Fullwidth Forms"](C)||65288===C||65289===C||65293===C||C>=65306&&C<=65310||65339===C||65341===C||65343===C||C>=65371&&C<=65503||65507===C||C>=65512&&C<=65519)||!(!Cl["Small Form Variants"](C)||C>=65112&&C<=65118||C>=65123&&C<=65126)||Cl["Unified Canadian Aboriginal Syllabics"](C)||Cl["Unified Canadian Aboriginal Syllabics Extended"](C)||Cl["Vertical Forms"](C)||Cl["Yijing Hexagram Symbols"](C)||Cl["Yi Syllables"](C)||Cl["Yi Radicals"](C))))}function Gs(C){return!(js(C)||function(C){return!!(Cl["Latin-1 Supplement"](C)&&(167===C||169===C||174===C||177===C||188===C||189===C||190===C||215===C||247===C)||Cl["General Punctuation"](C)&&(8214===C||8224===C||8225===C||8240===C||8241===C||8251===C||8252===C||8258===C||8263===C||8264===C||8265===C||8273===C)||Cl["Letterlike Symbols"](C)||Cl["Number Forms"](C)||Cl["Miscellaneous Technical"](C)&&(C>=8960&&C<=8967||C>=8972&&C<=8991||C>=8996&&C<=9e3||9003===C||C>=9085&&C<=9114||C>=9150&&C<=9165||9167===C||C>=9169&&C<=9179||C>=9186&&C<=9215)||Cl["Control Pictures"](C)&&9251!==C||Cl["Optical Character Recognition"](C)||Cl["Enclosed Alphanumerics"](C)||Cl["Geometric Shapes"](C)||Cl["Miscellaneous Symbols"](C)&&!(C>=9754&&C<=9759)||Cl["Miscellaneous Symbols and Arrows"](C)&&(C>=11026&&C<=11055||C>=11088&&C<=11097||C>=11192&&C<=11243)||Cl["CJK Symbols and Punctuation"](C)||Cl.Katakana(C)||Cl["Private Use Area"](C)||Cl["CJK Compatibility Forms"](C)||Cl["Small Form Variants"](C)||Cl["Halfwidth and Fullwidth Forms"](C)||8734===C||8756===C||8757===C||C>=9984&&C<=10087||C>=10102&&C<=10131||65532===C||65533===C)}(C))}function qs(C){return C>=1424&&C<=2303||Cl["Arabic Presentation Forms-A"](C)||Cl["Arabic Presentation Forms-B"](C)}function Zs(C,te){return!(!te&&qs(C)||C>=2304&&C<=3583||C>=3840&&C<=4255||Cl.Khmer(C))}function $s(C){for(const te of C)if(qs(te.charCodeAt(0)))return!0;return!1}const Vl="deferred",Gl="loading",Zl="loaded";let tc=null,rc="unavailable",nc=null;const Qs=function(C){C&&"string"==typeof C&&C.indexOf("NetworkError")>-1&&(rc="error"),tc&&tc(C)};function ea(){ac.fire(new It("pluginStateChange",{pluginStatus:rc,pluginURL:nc}))}const ac=new zt,ia=function(){return rc},ra=function(){if(rc!==Vl||!nc)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");rc=Gl,ea(),nc&&Te({url:nc},(C=>{C?Qs(C):(rc=Zl,ea())}))},lc={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>rc===Zl||null!=lc.applyArabicShaping,isLoading:()=>rc===Gl,setState(C){rc=C.pluginStatus,nc=C.pluginURL},isParsed:()=>null!=lc.applyArabicShaping&&null!=lc.processBidirectionalText&&null!=lc.processStyledBidirectionalText,getPluginURL:()=>nc};class oa{constructor(C,te){this.zoom=C,te?(this.now=te.now,this.fadeDuration=te.fadeDuration,this.transition=te.transition,this.pitch=te.pitch,this.brightness=te.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(C){return function(C,te){for(const le of C)if(!Zs(le.charCodeAt(0),te))return!1;return!0}(C,lc.isLoaded())}}class sa{constructor(C,te,le){this.property=C,this.value=te,this.expression=function(C,te,le){if(fo(C))return new Io(C,te);if(To(C)||Array.isArray(C)&&C.length>0){const ce=So(C,te,le);if("error"===ce.result)throw new Error(ce.value.map((C=>`${C.key}: ${C.message}`)).join(", "));return ce.value}{let le=C;return"string"==typeof C&&"color"===te.type&&(le=qr.parse(C)),{kind:"constant",isConfigDependent:!1,evaluate:()=>le}}}(void 0===te?C.specification.default:te,C.specification,le)}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(C,te,le){return this.property.possiblyEvaluate(this,C,te,le)}}class aa{constructor(C,te){this.property=C,this.value=new sa(C,void 0,te)}transitioned(C,te){return new ca(this.property,this.value,te,k({},C.transition,this.transition),C.now)}untransitioned(){return new ca(this.property,this.value,null,{},0)}}class la{constructor(C,te){this._properties=C,this._values=Object.create(C.defaultTransitionablePropertyValues),this._options=te,this.isConfigDependent=!1}getValue(C){return $(this._values[C].value.value)}setValue(C,te){this._values.hasOwnProperty(C)||(this._values[C]=new aa(this._values[C].property,this._options)),this._values[C].value=new sa(this._values[C].property,null===te?void 0:$(te),this._options),this.isConfigDependent=this.isConfigDependent||this._values[C].value.expression.isConfigDependent}setTransitionOrValue(C,te){te&&(this._options=te);const le=this._properties.properties;if(C)for(const te in C){const ce=C[te];if(G(te,"-transition")){const C=te.slice(0,-11);le[C]&&this.setTransition(C,ce)}else le[te]&&this.setValue(te,ce)}}getTransition(C){return $(this._values[C].transition)}setTransition(C,te){this._values.hasOwnProperty(C)||(this._values[C]=new aa(this._values[C].property)),this._values[C].transition=$(te)||void 0}serialize(){const C={};for(const te of Object.keys(this._values)){const le=this.getValue(te);void 0!==le&&(C[te]=le);const ce=this.getTransition(te);void 0!==ce&&(C[`${te}-transition`]=ce)}return C}transitioned(C,te){const le=new ha(this._properties);for(const ce of Object.keys(this._values))le._values[ce]=this._values[ce].transitioned(C,te._values[ce]);return le}untransitioned(){const C=new ha(this._properties);for(const te of Object.keys(this._values))C._values[te]=this._values[te].untransitioned();return C}}class ca{constructor(C,te,le,ce,he){const ue=ce.delay||0,de=ce.duration||0;he=he||0,this.property=C,this.value=te,this.begin=he+ue,this.end=this.begin+de,C.specification.transition&&(ce.delay||ce.duration)&&(this.prior=le)}possiblyEvaluate(C,te,le){const ce=C.now||0,he=this.value.possiblyEvaluate(C,te,le),ue=this.prior;if(ue){if(ce>this.end)return this.prior=null,he;if(this.value.isDataDriven())return this.prior=null,he;if(ce<this.begin)return ue.possiblyEvaluate(C,te,le);{const de=(ce-this.begin)/(this.end-this.begin);return this.property.interpolate(ue.possiblyEvaluate(C,te,le),he,M(de))}}return he}}class ha{constructor(C){this._properties=C,this._values=Object.create(C.defaultTransitioningPropertyValues)}possiblyEvaluate(C,te,le){const ce=new pa(this._properties);for(const he of Object.keys(this._values))ce._values[he]=this._values[he].possiblyEvaluate(C,te,le);return ce}hasTransition(){for(const C of Object.keys(this._values))if(this._values[C].prior)return!0;return!1}}class ua{constructor(C,te){this._properties=C,this._values=Object.create(C.defaultPropertyValues),this._options=te,this.isConfigDependent=!1}getValue(C){return $(this._values[C].value)}setValue(C,te){this._values[C]=new sa(this._values[C].property,null===te?void 0:$(te),this._options),this.isConfigDependent=this.isConfigDependent||this._values[C].expression.isConfigDependent}serialize(){const C={};for(const te of Object.keys(this._values)){const le=this.getValue(te);void 0!==le&&(C[te]=le)}return C}possiblyEvaluate(C,te,le){const ce=new pa(this._properties);for(const he of Object.keys(this._values))ce._values[he]=this._values[he].possiblyEvaluate(C,te,le);return ce}}class da{constructor(C,te,le){this.property=C,this.value=te,this.parameters=le}isConstant(){return"constant"===this.value.kind}constantOr(C){return"constant"===this.value.kind?this.value.value:C}evaluate(C,te,le,ce){return this.property.evaluate(this.value,this.parameters,C,te,le,ce)}}class pa{constructor(C){this._properties=C,this._values=Object.create(C.defaultPossiblyEvaluatedValues)}get(C){return this._values[C]}}class fa{constructor(C){this.specification=C}possiblyEvaluate(C,te){return C.expression.evaluate(te)}interpolate(C,te,le){const ce=Vn[this.specification.type];return ce?ce(C,te,le):C}}class ma{constructor(C,te){this.specification=C,this.overrides=te}possiblyEvaluate(C,te,le,ce){return new da(this,"constant"===C.expression.kind||"camera"===C.expression.kind?{kind:"constant",value:C.expression.evaluate(te,null,{},le,ce)}:C.expression,te)}interpolate(C,te,le){if("constant"!==C.value.kind||"constant"!==te.value.kind)return C;if(void 0===C.value.value||void 0===te.value.value)return new da(this,{kind:"constant",value:void 0},C.parameters);const ce=Vn[this.specification.type];return ce?new da(this,{kind:"constant",value:ce(C.value.value,te.value.value,le)},C.parameters):C}evaluate(C,te,le,ce,he,ue){return"constant"===C.kind?C.value:C.evaluate(te,le,ce,he,ue)}}class _a{constructor(C){this.specification=C}possiblyEvaluate(C,te,le,ce){return!!C.expression.evaluate(te,null,{},le,ce)}interpolate(){return!1}}class ga{constructor(C){this.properties=C,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const te=new oa(0,{});for(const le in C){const ce=C[le];ce.specification.overridable&&this.overridableProperties.push(le);const he=this.defaultPropertyValues[le]=new sa(ce,void 0),ue=this.defaultTransitionablePropertyValues[le]=new aa(ce);this.defaultTransitioningPropertyValues[le]=ue.untransitioned(),this.defaultPossiblyEvaluatedValues[le]=he.possiblyEvaluate(te)}}}Rs(ma,"DataDrivenProperty"),Rs(fa,"DataConstantProperty"),Rs(_a,"ColorRampProperty");const cc="";function xa(C){return C.indexOf(cc)>=0}function va(C,te){return te?`${C}${cc}${te}`:C}function ba(C){const te=C.indexOf(cc);return te>=0?C.slice(0,te):C}const hc="-transition";class Ta extends zt{constructor(C,te,le){if(super(),this.id=C.id,this.type=C.type,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.isConfigDependent=!1,"custom"!==C.type&&(this.metadata=C.metadata,this.minzoom=C.minzoom,this.maxzoom=C.maxzoom,"background"!==C.type&&"sky"!==C.type&&"slot"!==C.type&&(this.source=C.source,this.sourceLayer=C["source-layer"],this.filter=C.filter),this.options=le,C.slot&&(this.slot=C.slot),te.layout&&(this._unevaluatedLayout=new ua(te.layout,le),this.isConfigDependent=this.isConfigDependent||this._unevaluatedLayout.isConfigDependent),te.paint)){this._transitionablePaint=new la(te.paint,le);for(const te in C.paint)this.setPaintProperty(te,C.paint[te],{validate:!1});for(const te in C.layout)this.setLayoutProperty(te,C.layout[te],{validate:!1});this.isConfigDependent=this.isConfigDependent||this._transitionablePaint.isConfigDependent,this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new pa(te.paint)}}setScope(C){this.scope=C,this.fqid=va(this.id,C)}getLayoutProperty(C){return"visibility"===C?this.visibility:this._unevaluatedLayout.getValue(C)}setLayoutProperty(C,te,le={}){if(null!=te&&this._validate(Es,`layers.${this.id}.layout.${C}`,C,te,le))return;if("custom"===this.type&&"visibility"===C)return void(this.visibility=te);const ce=this._unevaluatedLayout;ce._properties.properties[C]&&(ce.setValue(C,te),this.isConfigDependent=this.isConfigDependent||ce.isConfigDependent,"visibility"===C&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0})}getPaintProperty(C){return G(C,hc)?this._transitionablePaint.getTransition(C.slice(0,-11)):this._transitionablePaint.getValue(C)}setPaintProperty(C,te,le={}){if(null!=te&&this._validate(Ts,`layers.${this.id}.paint.${C}`,C,te,le))return!1;const ce=this._transitionablePaint,he=ce._properties.properties;if(G(C,hc)){const le=C.slice(0,-11);return he[le]&&ce.setTransition(le,te||void 0),!1}if(!he[C])return!1;const ue=ce._values[C],de=ue.value.isDataDriven(),_e=ue.value;ce.setValue(C,te),this.isConfigDependent=this.isConfigDependent||ce.isConfigDependent,this._handleSpecialPaintPropertyUpdate(C);const ye=ce._values[C].value,ve=ye.isDataDriven(),Se=G(C,"pattern")||"line-dasharray"===C;return ve||de||Se||this._handleOverridablePaintPropertyUpdate(C,_e,ye)}_handleSpecialPaintPropertyUpdate(C){}getProgramIds(){return null}getDefaultProgramParams(C,te){return null}_handleOverridablePaintPropertyUpdate(C,te,le){return!1}isHidden(C){return!!(this.minzoom&&C<this.minzoom)||!!(this.maxzoom&&C>=this.maxzoom)||"none"===this.visibility}updateTransitions(C){this._transitioningPaint=this._transitionablePaint.transitioned(C,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(C,te){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(C,void 0,te)),this.paint=this._transitioningPaint.possiblyEvaluate(C,void 0,te)}serialize(){return Z({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},((C,te)=>!(void 0===C||"layout"===te&&!Object.keys(C).length||"paint"===te&&!Object.keys(C).length)))}_validate(C,te,le,ce,he={}){return(!he||!1!==he.validate)&&Ss(this,C.call(ms,{key:te,layerType:this.type,objectKey:le,value:ce,styleSpec:zi,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}resize(){}isStateDependent(){for(const C in this.paint._values){const te=this.paint.get(C);if(te instanceof da&&co(te.property.specification)&&("source"===te.value.kind||"composite"===te.value.kind)&&te.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=Fo(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(){this._stats&&(this._stats.numRenderedVerticesInShadowPass=0,this._stats.numRenderedVerticesInTransparentPass=0)}}class Ea{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages=new Set}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(C,te){this._updatedSourceCaches[C]=te,this.setDirty()}discardSourceCacheUpdate(C){delete this._updatedSourceCaches[C]}updateLayer(C){const te=C.scope;this._updatedLayers[te]=this._updatedLayers[te]||new Set,this._updatedLayers[te].add(C.id),this.setDirty()}removeLayer(C){const te=C.scope;this._removedLayers[te]=this._removedLayers[te]||{},this._updatedLayers[te]=this._updatedLayers[te]||new Set,this._removedLayers[te][C.id]=C,this._updatedLayers[te].delete(C.id),this._updatedPaintProps.delete(C.fqid),this.setDirty()}getRemovedLayer(C){return this._removedLayers[C.scope]?this._removedLayers[C.scope][C.id]:null}discardLayerRemoval(C){this._removedLayers[C.scope]&&delete this._removedLayers[C.scope][C.id]}getLayerUpdatesByScope(){const C={};for(const te in this._updatedLayers)C[te]=C[te]||{},C[te].updatedIds=Array.from(this._updatedLayers[te].values());for(const te in this._removedLayers)C[te]=C[te]||{},C[te].removedIds=Object.keys(this._removedLayers[te]);return C}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(C){this._updatedPaintProps.add(C.fqid),this.setDirty()}getUpdatedImages(){return Array.from(this._updatedImages.values())}updateImage(C){this._updatedImages.add(C),this.setDirty()}resetUpdatedImages(){this._updatedImages.clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages.clear()}}const uc={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Aa{constructor(C,te){this._structArray=C,this._pos1=te*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Sa{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(C,te){return C._trim(),te&&(C.isTransferred=!0,te.add(C.arrayBuffer)),{length:C.length,arrayBuffer:C.arrayBuffer}}static deserialize(C){const te=Object.create(this.prototype);return te.arrayBuffer=C.arrayBuffer,te.length=C.length,te.capacity=C.arrayBuffer.byteLength/te.bytesPerElement,te._refreshViews(),te}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(C){this.reserve(C),this.length=C}reserve(C){if(C>this.capacity){this.capacity=Math.max(C,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const te=this.uint8;this._refreshViews(),te&&this.uint8.set(te)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function Ia(C,te=1){let le=0,ce=0;return{members:C.map((C=>{const he=uc[C.type].BYTES_PER_ELEMENT,ue=le=Ca(le,Math.max(te,he)),de=C.components||1;return ce=Math.max(ce,he),le+=he*de,{name:C.name,type:C.type,components:de,offset:ue}})),size:Ca(le,Math.max(ce,te)),alignment:te}}function Ca(C,te){return Math.ceil(C/te)*te}class za extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(C,te){const le=this.length;return this.resize(le+1),this.emplace(le,C,te)}emplace(C,te,le){const ce=2*C;return this.int16[ce+0]=te,this.int16[ce+1]=le,C}}za.prototype.bytesPerElement=4,Rs(za,"StructArrayLayout2i4");class Pa extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(C,te,le){const ce=this.length;return this.resize(ce+1),this.emplace(ce,C,te,le)}emplace(C,te,le,ce){const he=3*C;return this.int16[he+0]=te,this.int16[he+1]=le,this.int16[he+2]=ce,C}}Pa.prototype.bytesPerElement=6,Rs(Pa,"StructArrayLayout3i6");class Da extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(C,te,le,ce){const he=this.length;return this.resize(he+1),this.emplace(he,C,te,le,ce)}emplace(C,te,le,ce,he){const ue=4*C;return this.int16[ue+0]=te,this.int16[ue+1]=le,this.int16[ue+2]=ce,this.int16[ue+3]=he,C}}Da.prototype.bytesPerElement=8,Rs(Da,"StructArrayLayout4i8");class Ra extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(C,te,le,ce,he){const ue=this.length;return this.resize(ue+1),this.emplace(ue,C,te,le,ce,he)}emplace(C,te,le,ce,he,ue){const de=5*C;return this.int16[de+0]=te,this.int16[de+1]=le,this.int16[de+2]=ce,this.int16[de+3]=he,this.int16[de+4]=ue,C}}Ra.prototype.bytesPerElement=10,Rs(Ra,"StructArrayLayout5i10");class La extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,te,le,ce,he,ue,de){const _e=this.length;return this.resize(_e+1),this.emplace(_e,C,te,le,ce,he,ue,de)}emplace(C,te,le,ce,he,ue,de,_e){const ye=6*C,ve=12*C,Se=3*C;return this.int16[ye+0]=te,this.int16[ye+1]=le,this.uint8[ve+4]=ce,this.uint8[ve+5]=he,this.uint8[ve+6]=ue,this.uint8[ve+7]=de,this.float32[Se+2]=_e,C}}La.prototype.bytesPerElement=12,Rs(La,"StructArrayLayout2i4ub1f12");class ka extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,te,le,ce){const he=this.length;return this.resize(he+1),this.emplace(he,C,te,le,ce)}emplace(C,te,le,ce,he){const ue=4*C;return this.float32[ue+0]=te,this.float32[ue+1]=le,this.float32[ue+2]=ce,this.float32[ue+3]=he,C}}ka.prototype.bytesPerElement=16,Rs(ka,"StructArrayLayout4f16");class Oa extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,te,le,ce,he){const ue=this.length;return this.resize(ue+1),this.emplace(ue,C,te,le,ce,he)}emplace(C,te,le,ce,he,ue){const de=6*C,_e=3*C;return this.uint16[de+0]=te,this.uint16[de+1]=le,this.uint16[de+2]=ce,this.uint16[de+3]=he,this.float32[_e+2]=ue,C}}Oa.prototype.bytesPerElement=12,Rs(Oa,"StructArrayLayout4ui1f12");class Ba extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(C,te,le,ce){const he=this.length;return this.resize(he+1),this.emplace(he,C,te,le,ce)}emplace(C,te,le,ce,he){const ue=4*C;return this.uint16[ue+0]=te,this.uint16[ue+1]=le,this.uint16[ue+2]=ce,this.uint16[ue+3]=he,C}}Ba.prototype.bytesPerElement=8,Rs(Ba,"StructArrayLayout4ui8");class Fa extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(C,te,le,ce,he,ue){const de=this.length;return this.resize(de+1),this.emplace(de,C,te,le,ce,he,ue)}emplace(C,te,le,ce,he,ue,de){const _e=6*C;return this.int16[_e+0]=te,this.int16[_e+1]=le,this.int16[_e+2]=ce,this.int16[_e+3]=he,this.int16[_e+4]=ue,this.int16[_e+5]=de,C}}Fa.prototype.bytesPerElement=12,Rs(Fa,"StructArrayLayout6i12");class Na extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me){const Ae=this.length;return this.resize(Ae+1),this.emplace(Ae,C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me)}emplace(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae){const Ce=12*C;return this.int16[Ce+0]=te,this.int16[Ce+1]=le,this.int16[Ce+2]=ce,this.int16[Ce+3]=he,this.uint16[Ce+4]=ue,this.uint16[Ce+5]=de,this.uint16[Ce+6]=_e,this.uint16[Ce+7]=ye,this.int16[Ce+8]=ve,this.int16[Ce+9]=Se,this.int16[Ce+10]=Me,this.int16[Ce+11]=Ae,C}}Na.prototype.bytesPerElement=24,Rs(Na,"StructArrayLayout4i4ui4i24");class Ua extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,te,le,ce,he,ue){const de=this.length;return this.resize(de+1),this.emplace(de,C,te,le,ce,he,ue)}emplace(C,te,le,ce,he,ue,de){const _e=10*C,ye=5*C;return this.int16[_e+0]=te,this.int16[_e+1]=le,this.int16[_e+2]=ce,this.float32[ye+2]=he,this.float32[ye+3]=ue,this.float32[ye+4]=de,C}}Ua.prototype.bytesPerElement=20,Rs(Ua,"StructArrayLayout3i3f20");class Va extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(C){const te=this.length;return this.resize(te+1),this.emplace(te,C)}emplace(C,te){return this.uint32[1*C+0]=te,C}}Va.prototype.bytesPerElement=4,Rs(Va,"StructArrayLayout1ul4");class ja extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(C,te){const le=this.length;return this.resize(le+1),this.emplace(le,C,te)}emplace(C,te,le){const ce=2*C;return this.uint16[ce+0]=te,this.uint16[ce+1]=le,C}}ja.prototype.bytesPerElement=4,Rs(ja,"StructArrayLayout2ui4");class Ga extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae){const Ce=this.length;return this.resize(Ce+1),this.emplace(Ce,C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae)}emplace(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce){const Oe=20*C,Ne=10*C;return this.int16[Oe+0]=te,this.int16[Oe+1]=le,this.int16[Oe+2]=ce,this.int16[Oe+3]=he,this.int16[Oe+4]=ue,this.float32[Ne+3]=de,this.float32[Ne+4]=_e,this.float32[Ne+5]=ye,this.float32[Ne+6]=ve,this.int16[Oe+14]=Se,this.uint32[Ne+8]=Me,this.uint16[Oe+18]=Ae,this.uint16[Oe+19]=Ce,C}}Ga.prototype.bytesPerElement=40,Rs(Ga,"StructArrayLayout5i4f1i1ul2ui40");class qa extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(C,te,le,ce,he,ue,de){const _e=this.length;return this.resize(_e+1),this.emplace(_e,C,te,le,ce,he,ue,de)}emplace(C,te,le,ce,he,ue,de,_e){const ye=8*C;return this.int16[ye+0]=te,this.int16[ye+1]=le,this.int16[ye+2]=ce,this.int16[ye+4]=he,this.int16[ye+5]=ue,this.int16[ye+6]=de,this.int16[ye+7]=_e,C}}qa.prototype.bytesPerElement=16,Rs(qa,"StructArrayLayout3i2i2i16");class Za extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(C,te,le,ce,he){const ue=this.length;return this.resize(ue+1),this.emplace(ue,C,te,le,ce,he)}emplace(C,te,le,ce,he,ue){const de=4*C,_e=8*C;return this.float32[de+0]=te,this.float32[de+1]=le,this.float32[de+2]=ce,this.int16[_e+6]=he,this.int16[_e+7]=ue,C}}Za.prototype.bytesPerElement=16,Rs(Za,"StructArrayLayout2f1f2i16");class $a extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,te,le,ce){const he=this.length;return this.resize(he+1),this.emplace(he,C,te,le,ce)}emplace(C,te,le,ce,he){const ue=12*C,de=3*C;return this.uint8[ue+0]=te,this.uint8[ue+1]=le,this.float32[de+1]=ce,this.float32[de+2]=he,C}}$a.prototype.bytesPerElement=12,Rs($a,"StructArrayLayout2ub2f12");class Wa extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(C,te,le){const ce=this.length;return this.resize(ce+1),this.emplace(ce,C,te,le)}emplace(C,te,le,ce){const he=3*C;return this.uint16[he+0]=te,this.uint16[he+1]=le,this.uint16[he+2]=ce,C}}Wa.prototype.bytesPerElement=6,Rs(Wa,"StructArrayLayout3ui6");class Ha extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne,je,Ge,Ze,qe,$e){const He=this.length;return this.resize(He+1),this.emplace(He,C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne,je,Ge,Ze,qe,$e)}emplace(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne,je,Ge,Ze,qe,$e,He){const We=30*C,Xe=15*C,Ye=60*C;return this.int16[We+0]=te,this.int16[We+1]=le,this.int16[We+2]=ce,this.float32[Xe+2]=he,this.float32[Xe+3]=ue,this.uint16[We+8]=de,this.uint16[We+9]=_e,this.uint32[Xe+5]=ye,this.uint32[Xe+6]=ve,this.uint32[Xe+7]=Se,this.uint16[We+16]=Me,this.uint16[We+17]=Ae,this.uint16[We+18]=Ce,this.float32[Xe+10]=Oe,this.float32[Xe+11]=Ne,this.uint8[Ye+48]=je,this.uint8[Ye+49]=Ge,this.uint8[Ye+50]=Ze,this.uint32[Xe+13]=qe,this.int16[We+28]=$e,this.uint8[Ye+58]=He,C}}Ha.prototype.bytesPerElement=60,Rs(Ha,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class Xa extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne,je,Ge,Ze,qe,$e,He,We,Xe,Ye,Je,Qe,tt,rt,ot,st,at){const lt=this.length;return this.resize(lt+1),this.emplace(lt,C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne,je,Ge,Ze,qe,$e,He,We,Xe,Ye,Je,Qe,tt,rt,ot,st,at)}emplace(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne,je,Ge,Ze,qe,$e,He,We,Xe,Ye,Je,Qe,tt,rt,ot,st,at,lt){const ct=20*C,ht=40*C,dt=80*C;return this.float32[ct+0]=te,this.float32[ct+1]=le,this.int16[ht+4]=ce,this.int16[ht+5]=he,this.int16[ht+6]=ue,this.int16[ht+7]=de,this.int16[ht+8]=_e,this.int16[ht+9]=ye,this.int16[ht+10]=ve,this.int16[ht+11]=Se,this.int16[ht+12]=Me,this.uint16[ht+13]=Ae,this.uint16[ht+14]=Ce,this.uint16[ht+15]=Oe,this.uint16[ht+16]=Ne,this.uint16[ht+17]=je,this.uint16[ht+18]=Ge,this.uint16[ht+19]=Ze,this.uint16[ht+20]=qe,this.uint16[ht+21]=$e,this.uint16[ht+22]=He,this.uint16[ht+23]=We,this.uint16[ht+24]=Xe,this.uint16[ht+25]=Ye,this.uint16[ht+26]=Je,this.uint16[ht+27]=Qe,this.uint32[ct+14]=tt,this.float32[ct+15]=rt,this.float32[ct+16]=ot,this.float32[ct+17]=st,this.float32[ct+18]=at,this.uint8[dt+76]=lt,C}}Xa.prototype.bytesPerElement=80,Rs(Xa,"StructArrayLayout2f9i15ui1ul4f1ub80");class Ya extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C){const te=this.length;return this.resize(te+1),this.emplace(te,C)}emplace(C,te){return this.float32[1*C+0]=te,C}}Ya.prototype.bytesPerElement=4,Rs(Ya,"StructArrayLayout1f4");class Ka extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,te,le,ce,he){const ue=this.length;return this.resize(ue+1),this.emplace(ue,C,te,le,ce,he)}emplace(C,te,le,ce,he,ue){const de=5*C;return this.float32[de+0]=te,this.float32[de+1]=le,this.float32[de+2]=ce,this.float32[de+3]=he,this.float32[de+4]=ue,C}}Ka.prototype.bytesPerElement=20,Rs(Ka,"StructArrayLayout5f20");class Ja extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,te,le,ce,he,ue,de){const _e=this.length;return this.resize(_e+1),this.emplace(_e,C,te,le,ce,he,ue,de)}emplace(C,te,le,ce,he,ue,de,_e){const ye=7*C;return this.float32[ye+0]=te,this.float32[ye+1]=le,this.float32[ye+2]=ce,this.float32[ye+3]=he,this.float32[ye+4]=ue,this.float32[ye+5]=de,this.float32[ye+6]=_e,C}}Ja.prototype.bytesPerElement=28,Rs(Ja,"StructArrayLayout7f28");class Qa extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(C,te,le,ce){const he=this.length;return this.resize(he+1),this.emplace(he,C,te,le,ce)}emplace(C,te,le,ce,he){const ue=6*C;return this.uint32[3*C+0]=te,this.uint16[ue+2]=le,this.uint16[ue+3]=ce,this.uint16[ue+4]=he,C}}Qa.prototype.bytesPerElement=12,Rs(Qa,"StructArrayLayout1ul3ui12");class el extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(C){const te=this.length;return this.resize(te+1),this.emplace(te,C)}emplace(C,te){return this.uint16[1*C+0]=te,C}}el.prototype.bytesPerElement=2,Rs(el,"StructArrayLayout1ui2");class tl extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,te,le){const ce=this.length;return this.resize(ce+1),this.emplace(ce,C,te,le)}emplace(C,te,le,ce){const he=3*C;return this.float32[he+0]=te,this.float32[he+1]=le,this.float32[he+2]=ce,C}}tl.prototype.bytesPerElement=12,Rs(tl,"StructArrayLayout3f12");class il extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,te){const le=this.length;return this.resize(le+1),this.emplace(le,C,te)}emplace(C,te,le){const ce=2*C;return this.float32[ce+0]=te,this.float32[ce+1]=le,C}}il.prototype.bytesPerElement=8,Rs(il,"StructArrayLayout2f8");class rl extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne){const je=this.length;return this.resize(je+1),this.emplace(je,C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne)}emplace(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne,je){const Ge=16*C;return this.float32[Ge+0]=te,this.float32[Ge+1]=le,this.float32[Ge+2]=ce,this.float32[Ge+3]=he,this.float32[Ge+4]=ue,this.float32[Ge+5]=de,this.float32[Ge+6]=_e,this.float32[Ge+7]=ye,this.float32[Ge+8]=ve,this.float32[Ge+9]=Se,this.float32[Ge+10]=Me,this.float32[Ge+11]=Ae,this.float32[Ge+12]=Ce,this.float32[Ge+13]=Oe,this.float32[Ge+14]=Ne,this.float32[Ge+15]=je,C}}rl.prototype.bytesPerElement=64,Rs(rl,"StructArrayLayout16f64");class nl extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(C,te,le,ce,he,ue,de){const _e=this.length;return this.resize(_e+1),this.emplace(_e,C,te,le,ce,he,ue,de)}emplace(C,te,le,ce,he,ue,de,_e){const ye=10*C,ve=5*C;return this.uint16[ye+0]=te,this.uint16[ye+1]=le,this.uint16[ye+2]=ce,this.uint16[ye+3]=he,this.float32[ve+2]=ue,this.float32[ve+3]=de,this.float32[ve+4]=_e,C}}nl.prototype.bytesPerElement=20,Rs(nl,"StructArrayLayout4ui3f20");class ol extends Sa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(C){const te=this.length;return this.resize(te+1),this.emplace(te,C)}emplace(C,te){return this.uint8[1*C+0]=te,C}}ol.prototype.bytesPerElement=1,Rs(ol,"StructArrayLayout1ub1");class sl extends Aa{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}sl.prototype.size=40;class al extends Ga{get(C){return new sl(this,C)}}Rs(al,"CollisionBoxArray");class ll extends Aa{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(C){this._structArray.uint8[this._pos1+49]=C}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(C){this._structArray.uint8[this._pos1+50]=C}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(C){this._structArray.uint32[this._pos4+13]=C}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(C){this._structArray.uint8[this._pos1+58]=C}}ll.prototype.size=60;class cl extends Ha{get(C){return new ll(this,C)}}Rs(cl,"PlacedSymbolArray");class hl extends Aa{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(C){this._structArray.uint32[this._pos4+14]=C}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(C){this._structArray.float32[this._pos4+18]=C}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}}hl.prototype.size=80;class ul extends Xa{get(C){return new hl(this,C)}}Rs(ul,"SymbolInstanceArray");class dl extends Ya{getoffsetX(C){return this.float32[1*C+0]}}Rs(dl,"GlyphOffsetArray");class pl extends za{getx(C){return this.int16[2*C+0]}gety(C){return this.int16[2*C+1]}}Rs(pl,"SymbolLineVertexArray");class fl extends Aa{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}fl.prototype.size=12;class ml extends Qa{get(C){return new fl(this,C)}}Rs(ml,"FeatureIndexArray");class _l extends ja{geta_centroid_pos0(C){return this.uint16[2*C+0]}geta_centroid_pos1(C){return this.uint16[2*C+1]}}Rs(_l,"FillExtrusionCentroidArray");const dc=Ia([{name:"a_pos",components:2,type:"Int16"}],4),pc=Ia([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class xl{constructor(C=[]){this.segments=C}_prepareSegment(C,te,le,ce){let he=this.segments[this.segments.length-1];return C>xl.MAX_VERTEX_ARRAY_LENGTH&&H(`Max vertices per segment is ${xl.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${C}`),(!he||he.vertexLength+C>xl.MAX_VERTEX_ARRAY_LENGTH||he.sortKey!==ce)&&(he={vertexOffset:te,primitiveOffset:le,vertexLength:0,primitiveLength:0},void 0!==ce&&(he.sortKey=ce),this.segments.push(he)),he}prepareSegment(C,te,le,ce){return this._prepareSegment(C,te.length,le.length,ce)}get(){return this.segments}destroy(){for(const C of this.segments)for(const te in C.vaos)C.vaos[te].destroy()}static simpleSegment(C,te,le,ce){return new xl([{vertexOffset:C,primitiveOffset:te,vertexLength:le,primitiveLength:ce,vaos:{},sortKey:0}])}}function vl(C,te){return 256*(C=z(Math.floor(C),0,255))+z(Math.floor(te),0,255)}xl.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Rs(xl,"SegmentVector");const mc=Ia([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),xc=Ia([{name:"a_dash",components:4,type:"Uint16"}]);var bc={exports:{}},Sc={exports:{}};!function(C){C.exports=function(C,te){var le,ce,he,ue,de,_e,ye,ve;for(ce=C.length-(le=3&C.length),he=te,de=3432918353,_e=461845907,ve=0;ve<ce;)ye=255&C.charCodeAt(ve)|(255&C.charCodeAt(++ve))<<8|(255&C.charCodeAt(++ve))<<16|(255&C.charCodeAt(++ve))<<24,++ve,he=27492+(65535&(ue=5*(65535&(he=(he^=ye=(65535&(ye=(ye=(65535&ye)*de+(((ye>>>16)*de&65535)<<16)&4294967295)<<15|ye>>>17))*_e+(((ye>>>16)*_e&65535)<<16)&4294967295)<<13|he>>>19))+((5*(he>>>16)&65535)<<16)&4294967295))+((58964+(ue>>>16)&65535)<<16);switch(ye=0,le){case 3:ye^=(255&C.charCodeAt(ve+2))<<16;case 2:ye^=(255&C.charCodeAt(ve+1))<<8;case 1:he^=ye=(65535&(ye=(ye=(65535&(ye^=255&C.charCodeAt(ve)))*de+(((ye>>>16)*de&65535)<<16)&4294967295)<<15|ye>>>17))*_e+(((ye>>>16)*_e&65535)<<16)&4294967295}return he^=C.length,he=2246822507*(65535&(he^=he>>>16))+((2246822507*(he>>>16)&65535)<<16)&4294967295,he=3266489909*(65535&(he^=he>>>13))+((3266489909*(he>>>16)&65535)<<16)&4294967295,(he^=he>>>16)>>>0}}(Sc);var Mc=Sc.exports,Pc={exports:{}};!function(C){C.exports=function(C,te){for(var le,ce=C.length,he=te^ce,ue=0;ce>=4;)le=1540483477*(65535&(le=255&C.charCodeAt(ue)|(255&C.charCodeAt(++ue))<<8|(255&C.charCodeAt(++ue))<<16|(255&C.charCodeAt(++ue))<<24))+((1540483477*(le>>>16)&65535)<<16),he=1540483477*(65535&he)+((1540483477*(he>>>16)&65535)<<16)^(le=1540483477*(65535&(le^=le>>>24))+((1540483477*(le>>>16)&65535)<<16)),ce-=4,++ue;switch(ce){case 3:he^=(255&C.charCodeAt(ue+2))<<16;case 2:he^=(255&C.charCodeAt(ue+1))<<8;case 1:he=1540483477*(65535&(he^=255&C.charCodeAt(ue)))+((1540483477*(he>>>16)&65535)<<16)}return he=1540483477*(65535&(he^=he>>>13))+((1540483477*(he>>>16)&65535)<<16),(he^=he>>>15)>>>0}}(Pc);var Rc=Mc,jc=Pc.exports;bc.exports=Rc,bc.exports.murmur3=Rc,bc.exports.murmur2=jc;var Gc=d(bc.exports);class zl{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(C,te,le,ce){this.ids.push(Pl(C)),this.positions.push(te,le,ce)}eachPosition(C,te){const le=Pl(C);let ce=0,he=this.ids.length-1;for(;ce<he;){const C=ce+he>>1;this.ids[C]>=le?he=C:ce=C+1}for(;this.ids[ce]===le;)te(this.positions[3*ce],this.positions[3*ce+1],this.positions[3*ce+2]),ce++}static serialize(C,te){const le=new Float64Array(C.ids),ce=new Uint32Array(C.positions);return Dl(le,ce,0,le.length-1),te&&(te.add(le.buffer),te.add(ce.buffer)),{ids:le,positions:ce}}static deserialize(C){const te=new zl;let le;te.ids=C.ids,te.positions=C.positions;for(const C of te.ids)C!==le&&te.uniqueIds.push(C),le=C;return te.indexed=!0,te}}function Pl(C){const te=+C;return!isNaN(te)&&Number.MIN_SAFE_INTEGER<=te&&te<=Number.MAX_SAFE_INTEGER?te:Gc(String(C))}function Dl(C,te,le,ce){for(;le<ce;){const he=C[le+ce>>1];let ue=le-1,de=ce+1;for(;;){do{ue++}while(C[ue]<he);do{de--}while(C[de]>he);if(ue>=de)break;Rl(C,ue,de),Rl(te,3*ue,3*de),Rl(te,3*ue+1,3*de+1),Rl(te,3*ue+2,3*de+2)}de-le<ce-de?(Dl(C,te,le,de),le=de+1):(Dl(C,te,de+1,ce),ce=de)}}function Rl(C,te,le){const ce=C[te];C[te]=C[le],C[le]=ce}Rs(zl,"FeaturePositionMap");class Ll{constructor(C){this.gl=C.gl,this.initialized=!1}fetchUniformLocation(C,te){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(C,te),this.initialized=!0),!!this.location}}class kl extends Ll{constructor(C){super(C),this.current=0}set(C,te,le){this.fetchUniformLocation(C,te)&&this.current!==le&&(this.current=le,this.gl.uniform1i(this.location,le))}}class Ol extends Ll{constructor(C){super(C),this.current=0}set(C,te,le){this.fetchUniformLocation(C,te)&&this.current!==le&&(this.current=le,this.gl.uniform1f(this.location,le))}}class Bl extends Ll{constructor(C){super(C),this.current=[0,0]}set(C,te,le){this.fetchUniformLocation(C,te)&&(le[0]===this.current[0]&&le[1]===this.current[1]||(this.current=le,this.gl.uniform2f(this.location,le[0],le[1])))}}class Fl extends Ll{constructor(C){super(C),this.current=[0,0,0]}set(C,te,le){this.fetchUniformLocation(C,te)&&(le[0]===this.current[0]&&le[1]===this.current[1]&&le[2]===this.current[2]||(this.current=le,this.gl.uniform3f(this.location,le[0],le[1],le[2])))}}class Nl extends Ll{constructor(C){super(C),this.current=[0,0,0,0]}set(C,te,le){this.fetchUniformLocation(C,te)&&(le[0]===this.current[0]&&le[1]===this.current[1]&&le[2]===this.current[2]&&le[3]===this.current[3]||(this.current=le,this.gl.uniform4f(this.location,le[0],le[1],le[2],le[3])))}}class Ul extends Ll{constructor(C){super(C),this.current=qr.transparent}set(C,te,le){this.fetchUniformLocation(C,te)&&(le.r===this.current.r&&le.g===this.current.g&&le.b===this.current.b&&le.a===this.current.a||(this.current=le,this.gl.uniform4f(this.location,le.r,le.g,le.b,le.a)))}}const Zc=new Float32Array(16);class jl extends Ll{constructor(C){super(C),this.current=Zc}set(C,te,le){if(this.fetchUniformLocation(C,te)){if(le[12]!==this.current[12]||le[0]!==this.current[0])return this.current=le,void this.gl.uniformMatrix4fv(this.location,!1,le);for(let C=1;C<16;C++)if(le[C]!==this.current[C]){this.current=le,this.gl.uniformMatrix4fv(this.location,!1,le);break}}}}const ih=new Float32Array(9);class ql extends Ll{constructor(C){super(C),this.current=ih}set(C,te,le){if(this.fetchUniformLocation(C,te))for(let C=0;C<9;C++)if(le[C]!==this.current[C]){this.current=le,this.gl.uniformMatrix3fv(this.location,!1,le);break}}}const rh=new Float32Array(4);class $l extends Ll{constructor(C){super(C),this.current=rh}set(C,te,le){if(this.fetchUniformLocation(C,te))for(let C=0;C<4;C++)if(le[C]!==this.current[C]){this.current=le,this.gl.uniformMatrix2fv(this.location,!1,le);break}}}function Wl(C){return[vl(255*C.r,255*C.g),vl(255*C.b,255*C.a)]}class Hl{constructor(C,te,le){this.value=C,this.uniformNames=te.map((C=>`u_${C}`)),this.type=le}setUniform(C,te,le,ce,he){te.set(C,he,ce.constantOr(this.value))}getBinding(C,te){return"color"===this.type?new Ul(C):new Ol(C)}}class Xl{constructor(C,te){this.uniformNames=te.map((C=>`u_${C}`)),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(C){this.pixelRatio=C.pixelRatio||1,this.pattern=C.tl.concat(C.br)}setUniform(C,te,le,ce,he){const ue="u_pattern"===he||"u_dash"===he?this.pattern:"u_pixel_ratio"===he?this.pixelRatio:null;ue&&te.set(C,he,ue)}getBinding(C,te){return"u_pattern"===te||"u_dash"===te?new Nl(C):new Ol(C)}}class Yl{constructor(C,te,le,ce){this.expression=C,this.type=le,this.maxValue=0,this.paintVertexAttributes=te.map((C=>({name:`a_${C}`,type:"Float32",components:"color"===le?2:1,offset:0}))),this.paintVertexArray=new ce}populatePaintArray(C,te,le,ce,he,ue,de){const _e=this.paintVertexArray.length,ye=this.expression.evaluate(new oa(0,{brightness:ue}),te,{},he,ce,de);this.paintVertexArray.resize(C),this._setPaintValue(_e,C,ye)}updatePaintArray(C,te,le,ce,he,ue,de){const _e=this.expression.evaluate({zoom:0,brightness:de},le,ce,void 0,he);this._setPaintValue(C,te,_e)}_setPaintValue(C,te,le){if("color"===this.type){const ce=Wl(le);for(let le=C;le<te;le++)this.paintVertexArray.emplace(le,ce[0],ce[1])}else{for(let ce=C;ce<te;ce++)this.paintVertexArray.emplace(ce,le);this.maxValue=Math.max(this.maxValue,Math.abs(le))}}upload(C){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=C.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Kl{constructor(C,te,le,ce,he,ue){this.expression=C,this.uniformNames=te.map((C=>`u_${C}_t`)),this.type=le,this.useIntegerZoom=ce,this.zoom=he,this.maxValue=0,this.paintVertexAttributes=te.map((C=>({name:`a_${C}`,type:"Float32",components:"color"===le?4:2,offset:0}))),this.paintVertexArray=new ue}populatePaintArray(C,te,le,ce,he,ue,de){const _e=this.expression.evaluate(new oa(this.zoom,{brightness:ue}),te,{},he,ce,de),ye=this.expression.evaluate(new oa(this.zoom+1,{brightness:ue}),te,{},he,ce,de),ve=this.paintVertexArray.length;this.paintVertexArray.resize(C),this._setPaintValue(ve,C,_e,ye)}updatePaintArray(C,te,le,ce,he,ue,de){const _e=this.expression.evaluate({zoom:this.zoom,brightness:de},le,ce,void 0,he),ye=this.expression.evaluate({zoom:this.zoom+1,brightness:de},le,ce,void 0,he);this._setPaintValue(C,te,_e,ye)}_setPaintValue(C,te,le,ce){if("color"===this.type){const he=Wl(le),ue=Wl(ce);for(let le=C;le<te;le++)this.paintVertexArray.emplace(le,he[0],he[1],ue[0],ue[1])}else{for(let he=C;he<te;he++)this.paintVertexArray.emplace(he,le,ce);this.maxValue=Math.max(this.maxValue,Math.abs(le),Math.abs(ce))}}upload(C){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=C.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(C,te,le,ce,he){const ue=this.useIntegerZoom?Math.floor(le.zoom):le.zoom,de=z(this.expression.interpolationFactor(ue,this.zoom,this.zoom+1),0,1);te.set(C,he,de)}getBinding(C,te){return new Ol(C)}}class Jl{constructor(C,te,le,ce,he){this.expression=C,this.layerId=he,this.paintVertexAttributes=("array"===le?xc:mc).members;for(let C=0;C<te.length;++C);this.paintVertexArray=new ce}populatePaintArray(C,te,le){const ce=this.paintVertexArray.length;this.paintVertexArray.resize(C),this._setPaintValues(ce,C,te.patterns&&te.patterns[this.layerId],le)}updatePaintArray(C,te,le,ce,he,ue,de){this._setPaintValues(C,te,le.patterns&&le.patterns[this.layerId],ue)}_setPaintValues(C,te,le,ce){if(!ce||!le)return;const he=ce[le];if(!he)return;const{tl:ue,br:de,pixelRatio:_e}=he;for(let le=C;le<te;le++)this.paintVertexArray.emplace(le,ue[0],ue[1],de[0],de[1],_e)}upload(C){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=C.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Ql{constructor(C,te,le=(()=>!0)){this.binders={},this._buffers=[];const ce=[];for(const he in C.paint._values){const ue=C.paint.get(he);if(!le(he))continue;if(!(ue instanceof da&&co(ue.property.specification)))continue;const de=ic(he,C.type),_e=ue.value,ye=ue.property.specification.type,ve=!!ue.property.useIntegerZoom,Se="line-dasharray"===he||he.endsWith("pattern"),Me="line-dasharray"===he&&"constant"!==C.layout.get("line-cap").value.kind;if("constant"!==_e.kind||Me)if("source"===_e.kind||Me||Se){const te=oc(he,ye,"source");this.binders[he]=Se?new Jl(_e,de,ye,te,C.id):new Yl(_e,de,ye,te),ce.push(`/a_${he}`)}else{const C=oc(he,ye,"composite");this.binders[he]=new Kl(_e,de,ye,ve,te,C),ce.push(`/z_${he}`)}else this.binders[he]=Se?new Xl(_e.value,de):new Hl(_e.value,de,ye),ce.push(`/u_${he}`)}this.cacheKey=ce.sort().join("")}getMaxValue(C){const te=this.binders[C];return te instanceof Yl||te instanceof Kl?te.maxValue:0}populatePaintArrays(C,te,le,ce,he,ue,de){for(const _e in this.binders){const ye=this.binders[_e];(ye instanceof Yl||ye instanceof Kl||ye instanceof Jl)&&ye.populatePaintArray(C,te,le,ce,he,ue,de)}}setConstantPatternPositions(C){for(const te in this.binders){const le=this.binders[te];le instanceof Xl&&le.setConstantPatternPositions(C)}}updatePaintArrays(C,te,le,ce,he,ue,de,_e){let ye=!1;const ve=Object.keys(C),Se=0!==ve.length,Me=Se?ve:te.uniqueIds;for(const ve in this.binders){const Ae=this.binders[ve];if((Ae instanceof Yl||Ae instanceof Kl||Ae instanceof Jl)&&(!0===Ae.expression.isStateDependent||!1===Ae.expression.isLightConstant)){const Ce=he.paint.get(ve);Ae.expression=Ce.value;for(const le of Me){const he=C[le.toString()];te.eachPosition(le,((C,te,le)=>{const ye=ce.feature(C);Ae.updatePaintArray(te,le,ye,he,ue,de,_e)}))}if(!Se)for(const te of le.uniqueIds){const he=C[te.toString()];le.eachPosition(te,((C,te,le)=>{const ye=ce.feature(C);Ae.updatePaintArray(te,le,ye,he,ue,de,_e)}))}ye=!0}}return ye}defines(){const C=[];for(const te in this.binders){const le=this.binders[te];(le instanceof Hl||le instanceof Xl)&&C.push(...le.uniformNames.map((C=>`#define HAS_UNIFORM_${C}`)))}return C}getBinderAttributes(){const C=[];for(const te in this.binders){const le=this.binders[te];if(le instanceof Yl||le instanceof Kl||le instanceof Jl)for(let te=0;te<le.paintVertexAttributes.length;te++)C.push(le.paintVertexAttributes[te].name)}return C}getBinderUniforms(){const C=[];for(const te in this.binders){const le=this.binders[te];if(le instanceof Hl||le instanceof Xl||le instanceof Kl)for(const te of le.uniformNames)C.push(te)}return C}getPaintVertexBuffers(){return this._buffers}getUniforms(C){const te=[];for(const le in this.binders){const ce=this.binders[le];if(ce instanceof Hl||ce instanceof Xl||ce instanceof Kl)for(const he of ce.uniformNames)te.push({name:he,property:le,binding:ce.getBinding(C,he)})}return te}setUniforms(C,te,le,ce,he){for(const{name:te,property:ue,binding:de}of le)this.binders[ue].setUniform(C,de,he,ce.get(ue),te)}updatePaintBuffers(){this._buffers=[];for(const C in this.binders){const te=this.binders[C];(te instanceof Yl||te instanceof Kl||te instanceof Jl)&&te.paintVertexBuffer&&this._buffers.push(te.paintVertexBuffer)}}upload(C){for(const te in this.binders){const le=this.binders[te];(le instanceof Yl||le instanceof Kl||le instanceof Jl)&&le.upload(C)}this.updatePaintBuffers()}destroy(){for(const C in this.binders){const te=this.binders[C];(te instanceof Yl||te instanceof Kl||te instanceof Jl)&&te.destroy()}}}class ec{constructor(C,te,le=(()=>!0)){this.programConfigurations={};for(const ce of C)this.programConfigurations[ce.id]=new Ql(ce,te,le);this.needsUpload=!1,this._featureMap=new zl,this._featureMapWithoutIds=new zl,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(C,te,le,ce,he,ue,de,_e){for(const le in this.programConfigurations)this.programConfigurations[le].populatePaintArrays(C,te,ce,he,ue,de,_e);void 0!==te.id?this._featureMap.add(te.id,le,this._bufferOffset,C):(this._featureMapWithoutIds.add(this._idlessCounter,le,this._bufferOffset,C),this._idlessCounter+=1),this._bufferOffset=C,this.needsUpload=!0}updatePaintArrays(C,te,le,ce,he,ue){for(const de of le)this.needsUpload=this.programConfigurations[de.id].updatePaintArrays(C,this._featureMap,this._featureMapWithoutIds,te,de,ce,he,ue||0)||this.needsUpload}get(C){return this.programConfigurations[C]}upload(C){if(this.needsUpload){for(const te in this.programConfigurations)this.programConfigurations[te].upload(C);this.needsUpload=!1}}destroy(){for(const C in this.programConfigurations)this.programConfigurations[C].destroy()}}const nh={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function ic(C,te){return nh[C]||[C.replace(`${te}-`,"").replace(/-/g,"_")]}const sh={"line-pattern":{source:Oa,composite:Oa},"fill-pattern":{source:Oa,composite:Oa},"fill-extrusion-pattern":{source:Oa,composite:Oa},"line-dasharray":{source:Ba,composite:Ba}},_h={color:{source:il,composite:ka},number:{source:Ya,composite:il}};function oc(C,te,le){const ce=sh[C];return ce&&ce[le]||_h[te][le]}Rs(Hl,"ConstantBinder"),Rs(Xl,"PatternConstantBinder"),Rs(Yl,"SourceExpressionBinder"),Rs(Jl,"PatternCompositeBinder"),Rs(Kl,"CompositeExpressionBinder"),Rs(Ql,"ProgramConfiguration",{omit:["_buffers"]}),Rs(ec,"ProgramConfigurationSet");class sc{constructor(C,te){C&&(te?this.setSouthWest(C).setNorthEast(te):4===C.length?this.setSouthWest([C[0],C[1]]).setNorthEast([C[2],C[3]]):this.setSouthWest(C[0]).setNorthEast(C[1]))}setNorthEast(C){return this._ne=C instanceof $f?new $f(C.lng,C.lat):$f.convert(C),this}setSouthWest(C){return this._sw=C instanceof $f?new $f(C.lng,C.lat):$f.convert(C),this}extend(C){const te=this._sw,le=this._ne;let ce,he;if(C instanceof $f)ce=C,he=C;else{if(!(C instanceof sc))return Array.isArray(C)?4===C.length||C.every(Array.isArray)?this.extend(sc.convert(C)):this.extend($f.convert(C)):"object"==typeof C&&null!==C&&C.hasOwnProperty("lat")&&(C.hasOwnProperty("lon")||C.hasOwnProperty("lng"))?this.extend($f.convert(C)):this;if(ce=C._sw,he=C._ne,!ce||!he)return this}return te||le?(te.lng=Math.min(ce.lng,te.lng),te.lat=Math.min(ce.lat,te.lat),le.lng=Math.max(he.lng,le.lng),le.lat=Math.max(he.lat,le.lat)):(this._sw=new $f(ce.lng,ce.lat),this._ne=new $f(he.lng,he.lat)),this}getCenter(){return new $f((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new $f(this.getWest(),this.getNorth())}getSouthEast(){return new $f(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(C){const{lng:te,lat:le}=$f.convert(C);let ce=this._sw.lng<=te&&te<=this._ne.lng;return this._sw.lng>this._ne.lng&&(ce=this._sw.lng>=te&&te>=this._ne.lng),this._sw.lat<=le&&le<=this._ne.lat&&ce}static convert(C){return!C||C instanceof sc?C:new sc(C)}}var yh={},xh={};Object.defineProperty(xh,"__esModule",{value:!0}),xh.setMatrixArrayType=function(C){xh.ARRAY_TYPE=bh=C},xh.toRadian=function(C){return C*Ph},xh.equals=function(C,te){return Math.abs(C-te)<=vh*Math.max(1,Math.abs(C),Math.abs(te))},xh.RANDOM=xh.ARRAY_TYPE=xh.EPSILON=void 0;var vh=1e-6;xh.EPSILON=vh;var bh="undefined"!=typeof Float32Array?Float32Array:Array;xh.ARRAY_TYPE=bh;var Dh=Math.random;xh.RANDOM=Dh;var Ph=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var C=0,te=arguments.length;te--;)C+=arguments[te]*arguments[te];return Math.sqrt(C)});var Rh={};function fc(C){return fc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(C){return typeof C}:function(C){return C&&"function"==typeof Symbol&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},fc(C)}Object.defineProperty(Rh,"__esModule",{value:!0}),Rh.create=function(){var C=new kh.ARRAY_TYPE(4);return kh.ARRAY_TYPE!=Float32Array&&(C[1]=0,C[2]=0),C[0]=1,C[3]=1,C},Rh.clone=function(C){var te=new kh.ARRAY_TYPE(4);return te[0]=C[0],te[1]=C[1],te[2]=C[2],te[3]=C[3],te},Rh.copy=function(C,te){return C[0]=te[0],C[1]=te[1],C[2]=te[2],C[3]=te[3],C},Rh.identity=function(C){return C[0]=1,C[1]=0,C[2]=0,C[3]=1,C},Rh.fromValues=function(C,te,le,ce){var he=new kh.ARRAY_TYPE(4);return he[0]=C,he[1]=te,he[2]=le,he[3]=ce,he},Rh.set=function(C,te,le,ce,he){return C[0]=te,C[1]=le,C[2]=ce,C[3]=he,C},Rh.transpose=function(C,te){if(C===te){var le=te[1];C[1]=te[2],C[2]=le}else C[0]=te[0],C[1]=te[2],C[2]=te[1],C[3]=te[3];return C},Rh.invert=function(C,te){var le=te[0],ce=te[1],he=te[2],ue=te[3],de=le*ue-he*ce;return de?(C[0]=ue*(de=1/de),C[1]=-ce*de,C[2]=-he*de,C[3]=le*de,C):null},Rh.adjoint=function(C,te){var le=te[0];return C[0]=te[3],C[1]=-te[1],C[2]=-te[2],C[3]=le,C},Rh.determinant=function(C){return C[0]*C[3]-C[2]*C[1]},Rh.multiply=gc,Rh.rotate=function(C,te,le){var ce=te[0],he=te[1],ue=te[2],de=te[3],_e=Math.sin(le),ye=Math.cos(le);return C[0]=ce*ye+ue*_e,C[1]=he*ye+de*_e,C[2]=ce*-_e+ue*ye,C[3]=he*-_e+de*ye,C},Rh.scale=function(C,te,le){var ce=te[1],he=te[2],ue=te[3],de=le[0],_e=le[1];return C[0]=te[0]*de,C[1]=ce*de,C[2]=he*_e,C[3]=ue*_e,C},Rh.fromRotation=function(C,te){var le=Math.sin(te),ce=Math.cos(te);return C[0]=ce,C[1]=le,C[2]=-le,C[3]=ce,C},Rh.fromScaling=function(C,te){return C[0]=te[0],C[1]=0,C[2]=0,C[3]=te[1],C},Rh.str=function(C){return"mat2("+C[0]+", "+C[1]+", "+C[2]+", "+C[3]+")"},Rh.frob=function(C){return Math.hypot(C[0],C[1],C[2],C[3])},Rh.LDU=function(C,te,le,ce){return C[2]=ce[2]/ce[0],le[0]=ce[0],le[1]=ce[1],le[3]=ce[3]-C[2]*le[1],[C,te,le]},Rh.add=function(C,te,le){return C[0]=te[0]+le[0],C[1]=te[1]+le[1],C[2]=te[2]+le[2],C[3]=te[3]+le[3],C},Rh.subtract=yc,Rh.exactEquals=function(C,te){return C[0]===te[0]&&C[1]===te[1]&&C[2]===te[2]&&C[3]===te[3]},Rh.equals=function(C,te){var le=C[0],ce=C[1],he=C[2],ue=C[3],de=te[0],_e=te[1],ye=te[2],ve=te[3];return Math.abs(le-de)<=kh.EPSILON*Math.max(1,Math.abs(le),Math.abs(de))&&Math.abs(ce-_e)<=kh.EPSILON*Math.max(1,Math.abs(ce),Math.abs(_e))&&Math.abs(he-ye)<=kh.EPSILON*Math.max(1,Math.abs(he),Math.abs(ye))&&Math.abs(ue-ve)<=kh.EPSILON*Math.max(1,Math.abs(ue),Math.abs(ve))},Rh.multiplyScalar=function(C,te,le){return C[0]=te[0]*le,C[1]=te[1]*le,C[2]=te[2]*le,C[3]=te[3]*le,C},Rh.multiplyScalarAndAdd=function(C,te,le,ce){return C[0]=te[0]+le[0]*ce,C[1]=te[1]+le[1]*ce,C[2]=te[2]+le[2]*ce,C[3]=te[3]+le[3]*ce,C},Rh.sub=Rh.mul=void 0;var kh=function(C,te){if(C&&C.__esModule)return C;if(null===C||"object"!==fc(C)&&"function"!=typeof C)return{default:C};var le=_c(void 0);if(le&&le.has(C))return le.get(C);var ce={},he=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var ue in C)if("default"!==ue&&Object.prototype.hasOwnProperty.call(C,ue)){var de=he?Object.getOwnPropertyDescriptor(C,ue):null;de&&(de.get||de.set)?Object.defineProperty(ce,ue,de):ce[ue]=C[ue]}return ce.default=C,le&&le.set(C,ce),ce}(xh);function _c(C){if("function"!=typeof WeakMap)return null;var te=new WeakMap,le=new WeakMap;return(_c=function(C){return C?le:te})(C)}function gc(C,te,le){var ce=te[0],he=te[1],ue=te[2],de=te[3],_e=le[0],ye=le[1],ve=le[2],Se=le[3];return C[0]=ce*_e+ue*ye,C[1]=he*_e+de*ye,C[2]=ce*ve+ue*Se,C[3]=he*ve+de*Se,C}function yc(C,te,le){return C[0]=te[0]-le[0],C[1]=te[1]-le[1],C[2]=te[2]-le[2],C[3]=te[3]-le[3],C}Rh.mul=gc,Rh.sub=yc;var Lh={};function vc(C){return vc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(C){return typeof C}:function(C){return C&&"function"==typeof Symbol&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},vc(C)}Object.defineProperty(Lh,"__esModule",{value:!0}),Lh.create=function(){var C=new Oh.ARRAY_TYPE(6);return Oh.ARRAY_TYPE!=Float32Array&&(C[1]=0,C[2]=0,C[4]=0,C[5]=0),C[0]=1,C[3]=1,C},Lh.clone=function(C){var te=new Oh.ARRAY_TYPE(6);return te[0]=C[0],te[1]=C[1],te[2]=C[2],te[3]=C[3],te[4]=C[4],te[5]=C[5],te},Lh.copy=function(C,te){return C[0]=te[0],C[1]=te[1],C[2]=te[2],C[3]=te[3],C[4]=te[4],C[5]=te[5],C},Lh.identity=function(C){return C[0]=1,C[1]=0,C[2]=0,C[3]=1,C[4]=0,C[5]=0,C},Lh.fromValues=function(C,te,le,ce,he,ue){var de=new Oh.ARRAY_TYPE(6);return de[0]=C,de[1]=te,de[2]=le,de[3]=ce,de[4]=he,de[5]=ue,de},Lh.set=function(C,te,le,ce,he,ue,de){return C[0]=te,C[1]=le,C[2]=ce,C[3]=he,C[4]=ue,C[5]=de,C},Lh.invert=function(C,te){var le=te[0],ce=te[1],he=te[2],ue=te[3],de=te[4],_e=te[5],ye=le*ue-ce*he;return ye?(C[0]=ue*(ye=1/ye),C[1]=-ce*ye,C[2]=-he*ye,C[3]=le*ye,C[4]=(he*_e-ue*de)*ye,C[5]=(ce*de-le*_e)*ye,C):null},Lh.determinant=function(C){return C[0]*C[3]-C[1]*C[2]},Lh.multiply=Tc,Lh.rotate=function(C,te,le){var ce=te[0],he=te[1],ue=te[2],de=te[3],_e=te[4],ye=te[5],ve=Math.sin(le),Se=Math.cos(le);return C[0]=ce*Se+ue*ve,C[1]=he*Se+de*ve,C[2]=ce*-ve+ue*Se,C[3]=he*-ve+de*Se,C[4]=_e,C[5]=ye,C},Lh.scale=function(C,te,le){var ce=te[1],he=te[2],ue=te[3],de=te[4],_e=te[5],ye=le[0],ve=le[1];return C[0]=te[0]*ye,C[1]=ce*ye,C[2]=he*ve,C[3]=ue*ve,C[4]=de,C[5]=_e,C},Lh.translate=function(C,te,le){var ce=te[0],he=te[1],ue=te[2],de=te[3],_e=te[4],ye=te[5],ve=le[0],Se=le[1];return C[0]=ce,C[1]=he,C[2]=ue,C[3]=de,C[4]=ce*ve+ue*Se+_e,C[5]=he*ve+de*Se+ye,C},Lh.fromRotation=function(C,te){var le=Math.sin(te),ce=Math.cos(te);return C[0]=ce,C[1]=le,C[2]=-le,C[3]=ce,C[4]=0,C[5]=0,C},Lh.fromScaling=function(C,te){return C[0]=te[0],C[1]=0,C[2]=0,C[3]=te[1],C[4]=0,C[5]=0,C},Lh.fromTranslation=function(C,te){return C[0]=1,C[1]=0,C[2]=0,C[3]=1,C[4]=te[0],C[5]=te[1],C},Lh.str=function(C){return"mat2d("+C[0]+", "+C[1]+", "+C[2]+", "+C[3]+", "+C[4]+", "+C[5]+")"},Lh.frob=function(C){return Math.hypot(C[0],C[1],C[2],C[3],C[4],C[5],1)},Lh.add=function(C,te,le){return C[0]=te[0]+le[0],C[1]=te[1]+le[1],C[2]=te[2]+le[2],C[3]=te[3]+le[3],C[4]=te[4]+le[4],C[5]=te[5]+le[5],C},Lh.subtract=Ec,Lh.multiplyScalar=function(C,te,le){return C[0]=te[0]*le,C[1]=te[1]*le,C[2]=te[2]*le,C[3]=te[3]*le,C[4]=te[4]*le,C[5]=te[5]*le,C},Lh.multiplyScalarAndAdd=function(C,te,le,ce){return C[0]=te[0]+le[0]*ce,C[1]=te[1]+le[1]*ce,C[2]=te[2]+le[2]*ce,C[3]=te[3]+le[3]*ce,C[4]=te[4]+le[4]*ce,C[5]=te[5]+le[5]*ce,C},Lh.exactEquals=function(C,te){return C[0]===te[0]&&C[1]===te[1]&&C[2]===te[2]&&C[3]===te[3]&&C[4]===te[4]&&C[5]===te[5]},Lh.equals=function(C,te){var le=C[0],ce=C[1],he=C[2],ue=C[3],de=C[4],_e=C[5],ye=te[0],ve=te[1],Se=te[2],Me=te[3],Ae=te[4],Ce=te[5];return Math.abs(le-ye)<=Oh.EPSILON*Math.max(1,Math.abs(le),Math.abs(ye))&&Math.abs(ce-ve)<=Oh.EPSILON*Math.max(1,Math.abs(ce),Math.abs(ve))&&Math.abs(he-Se)<=Oh.EPSILON*Math.max(1,Math.abs(he),Math.abs(Se))&&Math.abs(ue-Me)<=Oh.EPSILON*Math.max(1,Math.abs(ue),Math.abs(Me))&&Math.abs(de-Ae)<=Oh.EPSILON*Math.max(1,Math.abs(de),Math.abs(Ae))&&Math.abs(_e-Ce)<=Oh.EPSILON*Math.max(1,Math.abs(_e),Math.abs(Ce))},Lh.sub=Lh.mul=void 0;var Oh=function(C,te){if(C&&C.__esModule)return C;if(null===C||"object"!==vc(C)&&"function"!=typeof C)return{default:C};var le=wc(void 0);if(le&&le.has(C))return le.get(C);var ce={},he=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var ue in C)if("default"!==ue&&Object.prototype.hasOwnProperty.call(C,ue)){var de=he?Object.getOwnPropertyDescriptor(C,ue):null;de&&(de.get||de.set)?Object.defineProperty(ce,ue,de):ce[ue]=C[ue]}return ce.default=C,le&&le.set(C,ce),ce}(xh);function wc(C){if("function"!=typeof WeakMap)return null;var te=new WeakMap,le=new WeakMap;return(wc=function(C){return C?le:te})(C)}function Tc(C,te,le){var ce=te[0],he=te[1],ue=te[2],de=te[3],_e=te[4],ye=te[5],ve=le[0],Se=le[1],Me=le[2],Ae=le[3],Ce=le[4],Oe=le[5];return C[0]=ce*ve+ue*Se,C[1]=he*ve+de*Se,C[2]=ce*Me+ue*Ae,C[3]=he*Me+de*Ae,C[4]=ce*Ce+ue*Oe+_e,C[5]=he*Ce+de*Oe+ye,C}function Ec(C,te,le){return C[0]=te[0]-le[0],C[1]=te[1]-le[1],C[2]=te[2]-le[2],C[3]=te[3]-le[3],C[4]=te[4]-le[4],C[5]=te[5]-le[5],C}Lh.mul=Tc,Lh.sub=Ec;var Bh={};function Ac(C){return Ac="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(C){return typeof C}:function(C){return C&&"function"==typeof Symbol&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},Ac(C)}Object.defineProperty(Bh,"__esModule",{value:!0}),Bh.create=function(){var C=new Fh.ARRAY_TYPE(9);return Fh.ARRAY_TYPE!=Float32Array&&(C[1]=0,C[2]=0,C[3]=0,C[5]=0,C[6]=0,C[7]=0),C[0]=1,C[4]=1,C[8]=1,C},Bh.fromMat4=function(C,te){return C[0]=te[0],C[1]=te[1],C[2]=te[2],C[3]=te[4],C[4]=te[5],C[5]=te[6],C[6]=te[8],C[7]=te[9],C[8]=te[10],C},Bh.clone=function(C){var te=new Fh.ARRAY_TYPE(9);return te[0]=C[0],te[1]=C[1],te[2]=C[2],te[3]=C[3],te[4]=C[4],te[5]=C[5],te[6]=C[6],te[7]=C[7],te[8]=C[8],te},Bh.copy=function(C,te){return C[0]=te[0],C[1]=te[1],C[2]=te[2],C[3]=te[3],C[4]=te[4],C[5]=te[5],C[6]=te[6],C[7]=te[7],C[8]=te[8],C},Bh.fromValues=function(C,te,le,ce,he,ue,de,_e,ye){var ve=new Fh.ARRAY_TYPE(9);return ve[0]=C,ve[1]=te,ve[2]=le,ve[3]=ce,ve[4]=he,ve[5]=ue,ve[6]=de,ve[7]=_e,ve[8]=ye,ve},Bh.set=function(C,te,le,ce,he,ue,de,_e,ye,ve){return C[0]=te,C[1]=le,C[2]=ce,C[3]=he,C[4]=ue,C[5]=de,C[6]=_e,C[7]=ye,C[8]=ve,C},Bh.identity=function(C){return C[0]=1,C[1]=0,C[2]=0,C[3]=0,C[4]=1,C[5]=0,C[6]=0,C[7]=0,C[8]=1,C},Bh.transpose=function(C,te){if(C===te){var le=te[1],ce=te[2],he=te[5];C[1]=te[3],C[2]=te[6],C[3]=le,C[5]=te[7],C[6]=ce,C[7]=he}else C[0]=te[0],C[1]=te[3],C[2]=te[6],C[3]=te[1],C[4]=te[4],C[5]=te[7],C[6]=te[2],C[7]=te[5],C[8]=te[8];return C},Bh.invert=function(C,te){var le=te[0],ce=te[1],he=te[2],ue=te[3],de=te[4],_e=te[5],ye=te[6],ve=te[7],Se=te[8],Me=Se*de-_e*ve,Ae=-Se*ue+_e*ye,Ce=ve*ue-de*ye,Oe=le*Me+ce*Ae+he*Ce;return Oe?(C[0]=Me*(Oe=1/Oe),C[1]=(-Se*ce+he*ve)*Oe,C[2]=(_e*ce-he*de)*Oe,C[3]=Ae*Oe,C[4]=(Se*le-he*ye)*Oe,C[5]=(-_e*le+he*ue)*Oe,C[6]=Ce*Oe,C[7]=(-ve*le+ce*ye)*Oe,C[8]=(de*le-ce*ue)*Oe,C):null},Bh.adjoint=function(C,te){var le=te[0],ce=te[1],he=te[2],ue=te[3],de=te[4],_e=te[5],ye=te[6],ve=te[7],Se=te[8];return C[0]=de*Se-_e*ve,C[1]=he*ve-ce*Se,C[2]=ce*_e-he*de,C[3]=_e*ye-ue*Se,C[4]=le*Se-he*ye,C[5]=he*ue-le*_e,C[6]=ue*ve-de*ye,C[7]=ce*ye-le*ve,C[8]=le*de-ce*ue,C},Bh.determinant=function(C){var te=C[3],le=C[4],ce=C[5],he=C[6],ue=C[7],de=C[8];return C[0]*(de*le-ce*ue)+C[1]*(-de*te+ce*he)+C[2]*(ue*te-le*he)},Bh.multiply=Cc,Bh.translate=function(C,te,le){var ce=te[0],he=te[1],ue=te[2],de=te[3],_e=te[4],ye=te[5],ve=te[6],Se=te[7],Me=te[8],Ae=le[0],Ce=le[1];return C[0]=ce,C[1]=he,C[2]=ue,C[3]=de,C[4]=_e,C[5]=ye,C[6]=Ae*ce+Ce*de+ve,C[7]=Ae*he+Ce*_e+Se,C[8]=Ae*ue+Ce*ye+Me,C},Bh.rotate=function(C,te,le){var ce=te[0],he=te[1],ue=te[2],de=te[3],_e=te[4],ye=te[5],ve=te[6],Se=te[7],Me=te[8],Ae=Math.sin(le),Ce=Math.cos(le);return C[0]=Ce*ce+Ae*de,C[1]=Ce*he+Ae*_e,C[2]=Ce*ue+Ae*ye,C[3]=Ce*de-Ae*ce,C[4]=Ce*_e-Ae*he,C[5]=Ce*ye-Ae*ue,C[6]=ve,C[7]=Se,C[8]=Me,C},Bh.scale=function(C,te,le){var ce=le[0],he=le[1];return C[0]=ce*te[0],C[1]=ce*te[1],C[2]=ce*te[2],C[3]=he*te[3],C[4]=he*te[4],C[5]=he*te[5],C[6]=te[6],C[7]=te[7],C[8]=te[8],C},Bh.fromTranslation=function(C,te){return C[0]=1,C[1]=0,C[2]=0,C[3]=0,C[4]=1,C[5]=0,C[6]=te[0],C[7]=te[1],C[8]=1,C},Bh.fromRotation=function(C,te){var le=Math.sin(te),ce=Math.cos(te);return C[0]=ce,C[1]=le,C[2]=0,C[3]=-le,C[4]=ce,C[5]=0,C[6]=0,C[7]=0,C[8]=1,C},Bh.fromScaling=function(C,te){return C[0]=te[0],C[1]=0,C[2]=0,C[3]=0,C[4]=te[1],C[5]=0,C[6]=0,C[7]=0,C[8]=1,C},Bh.fromMat2d=function(C,te){return C[0]=te[0],C[1]=te[1],C[2]=0,C[3]=te[2],C[4]=te[3],C[5]=0,C[6]=te[4],C[7]=te[5],C[8]=1,C},Bh.fromQuat=function(C,te){var le=te[0],ce=te[1],he=te[2],ue=te[3],de=le+le,_e=ce+ce,ye=he+he,ve=le*de,Se=ce*de,Me=ce*_e,Ae=he*de,Ce=he*_e,Oe=he*ye,Ne=ue*de,je=ue*_e,Ge=ue*ye;return C[0]=1-Me-Oe,C[3]=Se-Ge,C[6]=Ae+je,C[1]=Se+Ge,C[4]=1-ve-Oe,C[7]=Ce-Ne,C[2]=Ae-je,C[5]=Ce+Ne,C[8]=1-ve-Me,C},Bh.normalFromMat4=function(C,te){var le=te[0],ce=te[1],he=te[2],ue=te[3],de=te[4],_e=te[5],ye=te[6],ve=te[7],Se=te[8],Me=te[9],Ae=te[10],Ce=te[11],Oe=te[12],Ne=te[13],je=te[14],Ge=te[15],Ze=le*_e-ce*de,qe=le*ye-he*de,$e=le*ve-ue*de,He=ce*ye-he*_e,We=ce*ve-ue*_e,Xe=he*ve-ue*ye,Ye=Se*Ne-Me*Oe,Je=Se*je-Ae*Oe,Qe=Se*Ge-Ce*Oe,tt=Me*je-Ae*Ne,rt=Me*Ge-Ce*Ne,ot=Ae*Ge-Ce*je,st=Ze*ot-qe*rt+$e*tt+He*Qe-We*Je+Xe*Ye;return st?(C[0]=(_e*ot-ye*rt+ve*tt)*(st=1/st),C[1]=(ye*Qe-de*ot-ve*Je)*st,C[2]=(de*rt-_e*Qe+ve*Ye)*st,C[3]=(he*rt-ce*ot-ue*tt)*st,C[4]=(le*ot-he*Qe+ue*Je)*st,C[5]=(ce*Qe-le*rt-ue*Ye)*st,C[6]=(Ne*Xe-je*We+Ge*He)*st,C[7]=(je*$e-Oe*Xe-Ge*qe)*st,C[8]=(Oe*We-Ne*$e+Ge*Ze)*st,C):null},Bh.projection=function(C,te,le){return C[0]=2/te,C[1]=0,C[2]=0,C[3]=0,C[4]=-2/le,C[5]=0,C[6]=-1,C[7]=1,C[8]=1,C},Bh.str=function(C){return"mat3("+C[0]+", "+C[1]+", "+C[2]+", "+C[3]+", "+C[4]+", "+C[5]+", "+C[6]+", "+C[7]+", "+C[8]+")"},Bh.frob=function(C){return Math.hypot(C[0],C[1],C[2],C[3],C[4],C[5],C[6],C[7],C[8])},Bh.add=function(C,te,le){return C[0]=te[0]+le[0],C[1]=te[1]+le[1],C[2]=te[2]+le[2],C[3]=te[3]+le[3],C[4]=te[4]+le[4],C[5]=te[5]+le[5],C[6]=te[6]+le[6],C[7]=te[7]+le[7],C[8]=te[8]+le[8],C},Bh.subtract=zc,Bh.multiplyScalar=function(C,te,le){return C[0]=te[0]*le,C[1]=te[1]*le,C[2]=te[2]*le,C[3]=te[3]*le,C[4]=te[4]*le,C[5]=te[5]*le,C[6]=te[6]*le,C[7]=te[7]*le,C[8]=te[8]*le,C},Bh.multiplyScalarAndAdd=function(C,te,le,ce){return C[0]=te[0]+le[0]*ce,C[1]=te[1]+le[1]*ce,C[2]=te[2]+le[2]*ce,C[3]=te[3]+le[3]*ce,C[4]=te[4]+le[4]*ce,C[5]=te[5]+le[5]*ce,C[6]=te[6]+le[6]*ce,C[7]=te[7]+le[7]*ce,C[8]=te[8]+le[8]*ce,C},Bh.exactEquals=function(C,te){return C[0]===te[0]&&C[1]===te[1]&&C[2]===te[2]&&C[3]===te[3]&&C[4]===te[4]&&C[5]===te[5]&&C[6]===te[6]&&C[7]===te[7]&&C[8]===te[8]},Bh.equals=function(C,te){var le=C[0],ce=C[1],he=C[2],ue=C[3],de=C[4],_e=C[5],ye=C[6],ve=C[7],Se=C[8],Me=te[0],Ae=te[1],Ce=te[2],Oe=te[3],Ne=te[4],je=te[5],Ge=te[6],Ze=te[7],qe=te[8];return Math.abs(le-Me)<=Fh.EPSILON*Math.max(1,Math.abs(le),Math.abs(Me))&&Math.abs(ce-Ae)<=Fh.EPSILON*Math.max(1,Math.abs(ce),Math.abs(Ae))&&Math.abs(he-Ce)<=Fh.EPSILON*Math.max(1,Math.abs(he),Math.abs(Ce))&&Math.abs(ue-Oe)<=Fh.EPSILON*Math.max(1,Math.abs(ue),Math.abs(Oe))&&Math.abs(de-Ne)<=Fh.EPSILON*Math.max(1,Math.abs(de),Math.abs(Ne))&&Math.abs(_e-je)<=Fh.EPSILON*Math.max(1,Math.abs(_e),Math.abs(je))&&Math.abs(ye-Ge)<=Fh.EPSILON*Math.max(1,Math.abs(ye),Math.abs(Ge))&&Math.abs(ve-Ze)<=Fh.EPSILON*Math.max(1,Math.abs(ve),Math.abs(Ze))&&Math.abs(Se-qe)<=Fh.EPSILON*Math.max(1,Math.abs(Se),Math.abs(qe))},Bh.sub=Bh.mul=void 0;var Fh=function(C,te){if(C&&C.__esModule)return C;if(null===C||"object"!==Ac(C)&&"function"!=typeof C)return{default:C};var le=Ic(void 0);if(le&&le.has(C))return le.get(C);var ce={},he=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var ue in C)if("default"!==ue&&Object.prototype.hasOwnProperty.call(C,ue)){var de=he?Object.getOwnPropertyDescriptor(C,ue):null;de&&(de.get||de.set)?Object.defineProperty(ce,ue,de):ce[ue]=C[ue]}return ce.default=C,le&&le.set(C,ce),ce}(xh);function Ic(C){if("function"!=typeof WeakMap)return null;var te=new WeakMap,le=new WeakMap;return(Ic=function(C){return C?le:te})(C)}function Cc(C,te,le){var ce=te[0],he=te[1],ue=te[2],de=te[3],_e=te[4],ye=te[5],ve=te[6],Se=te[7],Me=te[8],Ae=le[0],Ce=le[1],Oe=le[2],Ne=le[3],je=le[4],Ge=le[5],Ze=le[6],qe=le[7],$e=le[8];return C[0]=Ae*ce+Ce*de+Oe*ve,C[1]=Ae*he+Ce*_e+Oe*Se,C[2]=Ae*ue+Ce*ye+Oe*Me,C[3]=Ne*ce+je*de+Ge*ve,C[4]=Ne*he+je*_e+Ge*Se,C[5]=Ne*ue+je*ye+Ge*Me,C[6]=Ze*ce+qe*de+$e*ve,C[7]=Ze*he+qe*_e+$e*Se,C[8]=Ze*ue+qe*ye+$e*Me,C}function zc(C,te,le){return C[0]=te[0]-le[0],C[1]=te[1]-le[1],C[2]=te[2]-le[2],C[3]=te[3]-le[3],C[4]=te[4]-le[4],C[5]=te[5]-le[5],C[6]=te[6]-le[6],C[7]=te[7]-le[7],C[8]=te[8]-le[8],C}Bh.mul=Cc,Bh.sub=zc;var Nh={};function Dc(C){return Dc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(C){return typeof C}:function(C){return C&&"function"==typeof Symbol&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},Dc(C)}Object.defineProperty(Nh,"__esModule",{value:!0}),Nh.create=function(){var C=new jh.ARRAY_TYPE(16);return jh.ARRAY_TYPE!=Float32Array&&(C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[6]=0,C[7]=0,C[8]=0,C[9]=0,C[11]=0,C[12]=0,C[13]=0,C[14]=0),C[0]=1,C[5]=1,C[10]=1,C[15]=1,C},Nh.clone=function(C){var te=new jh.ARRAY_TYPE(16);return te[0]=C[0],te[1]=C[1],te[2]=C[2],te[3]=C[3],te[4]=C[4],te[5]=C[5],te[6]=C[6],te[7]=C[7],te[8]=C[8],te[9]=C[9],te[10]=C[10],te[11]=C[11],te[12]=C[12],te[13]=C[13],te[14]=C[14],te[15]=C[15],te},Nh.copy=function(C,te){return C[0]=te[0],C[1]=te[1],C[2]=te[2],C[3]=te[3],C[4]=te[4],C[5]=te[5],C[6]=te[6],C[7]=te[7],C[8]=te[8],C[9]=te[9],C[10]=te[10],C[11]=te[11],C[12]=te[12],C[13]=te[13],C[14]=te[14],C[15]=te[15],C},Nh.fromValues=function(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne){var je=new jh.ARRAY_TYPE(16);return je[0]=C,je[1]=te,je[2]=le,je[3]=ce,je[4]=he,je[5]=ue,je[6]=de,je[7]=_e,je[8]=ye,je[9]=ve,je[10]=Se,je[11]=Me,je[12]=Ae,je[13]=Ce,je[14]=Oe,je[15]=Ne,je},Nh.set=function(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne,je){return C[0]=te,C[1]=le,C[2]=ce,C[3]=he,C[4]=ue,C[5]=de,C[6]=_e,C[7]=ye,C[8]=ve,C[9]=Se,C[10]=Me,C[11]=Ae,C[12]=Ce,C[13]=Oe,C[14]=Ne,C[15]=je,C},Nh.identity=kc,Nh.transpose=function(C,te){if(C===te){var le=te[1],ce=te[2],he=te[3],ue=te[6],de=te[7],_e=te[11];C[1]=te[4],C[2]=te[8],C[3]=te[12],C[4]=le,C[6]=te[9],C[7]=te[13],C[8]=ce,C[9]=ue,C[11]=te[14],C[12]=he,C[13]=de,C[14]=_e}else C[0]=te[0],C[1]=te[4],C[2]=te[8],C[3]=te[12],C[4]=te[1],C[5]=te[5],C[6]=te[9],C[7]=te[13],C[8]=te[2],C[9]=te[6],C[10]=te[10],C[11]=te[14],C[12]=te[3],C[13]=te[7],C[14]=te[11],C[15]=te[15];return C},Nh.invert=function(C,te){var le=te[0],ce=te[1],he=te[2],ue=te[3],de=te[4],_e=te[5],ye=te[6],ve=te[7],Se=te[8],Me=te[9],Ae=te[10],Ce=te[11],Oe=te[12],Ne=te[13],je=te[14],Ge=te[15],Ze=le*_e-ce*de,qe=le*ye-he*de,$e=le*ve-ue*de,He=ce*ye-he*_e,We=ce*ve-ue*_e,Xe=he*ve-ue*ye,Ye=Se*Ne-Me*Oe,Je=Se*je-Ae*Oe,Qe=Se*Ge-Ce*Oe,tt=Me*je-Ae*Ne,rt=Me*Ge-Ce*Ne,ot=Ae*Ge-Ce*je,st=Ze*ot-qe*rt+$e*tt+He*Qe-We*Je+Xe*Ye;return st?(C[0]=(_e*ot-ye*rt+ve*tt)*(st=1/st),C[1]=(he*rt-ce*ot-ue*tt)*st,C[2]=(Ne*Xe-je*We+Ge*He)*st,C[3]=(Ae*We-Me*Xe-Ce*He)*st,C[4]=(ye*Qe-de*ot-ve*Je)*st,C[5]=(le*ot-he*Qe+ue*Je)*st,C[6]=(je*$e-Oe*Xe-Ge*qe)*st,C[7]=(Se*Xe-Ae*$e+Ce*qe)*st,C[8]=(de*rt-_e*Qe+ve*Ye)*st,C[9]=(ce*Qe-le*rt-ue*Ye)*st,C[10]=(Oe*We-Ne*$e+Ge*Ze)*st,C[11]=(Me*$e-Se*We-Ce*Ze)*st,C[12]=(_e*Je-de*tt-ye*Ye)*st,C[13]=(le*tt-ce*Je+he*Ye)*st,C[14]=(Ne*qe-Oe*He-je*Ze)*st,C[15]=(Se*He-Me*qe+Ae*Ze)*st,C):null},Nh.adjoint=function(C,te){var le=te[0],ce=te[1],he=te[2],ue=te[3],de=te[4],_e=te[5],ye=te[6],ve=te[7],Se=te[8],Me=te[9],Ae=te[10],Ce=te[11],Oe=te[12],Ne=te[13],je=te[14],Ge=te[15];return C[0]=_e*(Ae*Ge-Ce*je)-Me*(ye*Ge-ve*je)+Ne*(ye*Ce-ve*Ae),C[1]=-(ce*(Ae*Ge-Ce*je)-Me*(he*Ge-ue*je)+Ne*(he*Ce-ue*Ae)),C[2]=ce*(ye*Ge-ve*je)-_e*(he*Ge-ue*je)+Ne*(he*ve-ue*ye),C[3]=-(ce*(ye*Ce-ve*Ae)-_e*(he*Ce-ue*Ae)+Me*(he*ve-ue*ye)),C[4]=-(de*(Ae*Ge-Ce*je)-Se*(ye*Ge-ve*je)+Oe*(ye*Ce-ve*Ae)),C[5]=le*(Ae*Ge-Ce*je)-Se*(he*Ge-ue*je)+Oe*(he*Ce-ue*Ae),C[6]=-(le*(ye*Ge-ve*je)-de*(he*Ge-ue*je)+Oe*(he*ve-ue*ye)),C[7]=le*(ye*Ce-ve*Ae)-de*(he*Ce-ue*Ae)+Se*(he*ve-ue*ye),C[8]=de*(Me*Ge-Ce*Ne)-Se*(_e*Ge-ve*Ne)+Oe*(_e*Ce-ve*Me),C[9]=-(le*(Me*Ge-Ce*Ne)-Se*(ce*Ge-ue*Ne)+Oe*(ce*Ce-ue*Me)),C[10]=le*(_e*Ge-ve*Ne)-de*(ce*Ge-ue*Ne)+Oe*(ce*ve-ue*_e),C[11]=-(le*(_e*Ce-ve*Me)-de*(ce*Ce-ue*Me)+Se*(ce*ve-ue*_e)),C[12]=-(de*(Me*je-Ae*Ne)-Se*(_e*je-ye*Ne)+Oe*(_e*Ae-ye*Me)),C[13]=le*(Me*je-Ae*Ne)-Se*(ce*je-he*Ne)+Oe*(ce*Ae-he*Me),C[14]=-(le*(_e*je-ye*Ne)-de*(ce*je-he*Ne)+Oe*(ce*ye-he*_e)),C[15]=le*(_e*Ae-ye*Me)-de*(ce*Ae-he*Me)+Se*(ce*ye-he*_e),C},Nh.determinant=function(C){var te=C[0],le=C[1],ce=C[2],he=C[3],ue=C[4],de=C[5],_e=C[6],ye=C[7],ve=C[8],Se=C[9],Me=C[10],Ae=C[11],Ce=C[12],Oe=C[13],Ne=C[14],je=C[15];return(te*de-le*ue)*(Me*je-Ae*Ne)-(te*_e-ce*ue)*(Se*je-Ae*Oe)+(te*ye-he*ue)*(Se*Ne-Me*Oe)+(le*_e-ce*de)*(ve*je-Ae*Ce)-(le*ye-he*de)*(ve*Ne-Me*Ce)+(ce*ye-he*_e)*(ve*Oe-Se*Ce)},Nh.multiply=Oc,Nh.translate=function(C,te,le){var ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne=le[0],je=le[1],Ge=le[2];return te===C?(C[12]=te[0]*Ne+te[4]*je+te[8]*Ge+te[12],C[13]=te[1]*Ne+te[5]*je+te[9]*Ge+te[13],C[14]=te[2]*Ne+te[6]*je+te[10]*Ge+te[14],C[15]=te[3]*Ne+te[7]*je+te[11]*Ge+te[15]):(he=te[1],ue=te[2],de=te[3],_e=te[4],ye=te[5],ve=te[6],Se=te[7],Me=te[8],Ae=te[9],Ce=te[10],Oe=te[11],C[0]=ce=te[0],C[1]=he,C[2]=ue,C[3]=de,C[4]=_e,C[5]=ye,C[6]=ve,C[7]=Se,C[8]=Me,C[9]=Ae,C[10]=Ce,C[11]=Oe,C[12]=ce*Ne+_e*je+Me*Ge+te[12],C[13]=he*Ne+ye*je+Ae*Ge+te[13],C[14]=ue*Ne+ve*je+Ce*Ge+te[14],C[15]=de*Ne+Se*je+Oe*Ge+te[15]),C},Nh.scale=function(C,te,le){var ce=le[0],he=le[1],ue=le[2];return C[0]=te[0]*ce,C[1]=te[1]*ce,C[2]=te[2]*ce,C[3]=te[3]*ce,C[4]=te[4]*he,C[5]=te[5]*he,C[6]=te[6]*he,C[7]=te[7]*he,C[8]=te[8]*ue,C[9]=te[9]*ue,C[10]=te[10]*ue,C[11]=te[11]*ue,C[12]=te[12],C[13]=te[13],C[14]=te[14],C[15]=te[15],C},Nh.rotate=function(C,te,le,ce){var he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne,je,Ge,Ze,qe,$e,He,We,Xe,Ye,Je,Qe,tt,rt=ce[0],ot=ce[1],st=ce[2],at=Math.hypot(rt,ot,st);return at<jh.EPSILON?null:(rt*=at=1/at,ot*=at,st*=at,he=Math.sin(le),ue=Math.cos(le),ye=te[1],ve=te[2],Se=te[3],Ae=te[5],Ce=te[6],Oe=te[7],je=te[9],Ge=te[10],Ze=te[11],We=rt*ot*(de=1-ue)-st*he,Xe=ot*ot*de+ue,Ye=st*ot*de+rt*he,Je=rt*st*de+ot*he,Qe=ot*st*de-rt*he,tt=st*st*de+ue,C[0]=(_e=te[0])*(qe=rt*rt*de+ue)+(Me=te[4])*($e=ot*rt*de+st*he)+(Ne=te[8])*(He=st*rt*de-ot*he),C[1]=ye*qe+Ae*$e+je*He,C[2]=ve*qe+Ce*$e+Ge*He,C[3]=Se*qe+Oe*$e+Ze*He,C[4]=_e*We+Me*Xe+Ne*Ye,C[5]=ye*We+Ae*Xe+je*Ye,C[6]=ve*We+Ce*Xe+Ge*Ye,C[7]=Se*We+Oe*Xe+Ze*Ye,C[8]=_e*Je+Me*Qe+Ne*tt,C[9]=ye*Je+Ae*Qe+je*tt,C[10]=ve*Je+Ce*Qe+Ge*tt,C[11]=Se*Je+Oe*Qe+Ze*tt,te!==C&&(C[12]=te[12],C[13]=te[13],C[14]=te[14],C[15]=te[15]),C)},Nh.rotateX=function(C,te,le){var ce=Math.sin(le),he=Math.cos(le),ue=te[4],de=te[5],_e=te[6],ye=te[7],ve=te[8],Se=te[9],Me=te[10],Ae=te[11];return te!==C&&(C[0]=te[0],C[1]=te[1],C[2]=te[2],C[3]=te[3],C[12]=te[12],C[13]=te[13],C[14]=te[14],C[15]=te[15]),C[4]=ue*he+ve*ce,C[5]=de*he+Se*ce,C[6]=_e*he+Me*ce,C[7]=ye*he+Ae*ce,C[8]=ve*he-ue*ce,C[9]=Se*he-de*ce,C[10]=Me*he-_e*ce,C[11]=Ae*he-ye*ce,C},Nh.rotateY=function(C,te,le){var ce=Math.sin(le),he=Math.cos(le),ue=te[0],de=te[1],_e=te[2],ye=te[3],ve=te[8],Se=te[9],Me=te[10],Ae=te[11];return te!==C&&(C[4]=te[4],C[5]=te[5],C[6]=te[6],C[7]=te[7],C[12]=te[12],C[13]=te[13],C[14]=te[14],C[15]=te[15]),C[0]=ue*he-ve*ce,C[1]=de*he-Se*ce,C[2]=_e*he-Me*ce,C[3]=ye*he-Ae*ce,C[8]=ue*ce+ve*he,C[9]=de*ce+Se*he,C[10]=_e*ce+Me*he,C[11]=ye*ce+Ae*he,C},Nh.rotateZ=function(C,te,le){var ce=Math.sin(le),he=Math.cos(le),ue=te[0],de=te[1],_e=te[2],ye=te[3],ve=te[4],Se=te[5],Me=te[6],Ae=te[7];return te!==C&&(C[8]=te[8],C[9]=te[9],C[10]=te[10],C[11]=te[11],C[12]=te[12],C[13]=te[13],C[14]=te[14],C[15]=te[15]),C[0]=ue*he+ve*ce,C[1]=de*he+Se*ce,C[2]=_e*he+Me*ce,C[3]=ye*he+Ae*ce,C[4]=ve*he-ue*ce,C[5]=Se*he-de*ce,C[6]=Me*he-_e*ce,C[7]=Ae*he-ye*ce,C},Nh.fromTranslation=function(C,te){return C[0]=1,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=1,C[6]=0,C[7]=0,C[8]=0,C[9]=0,C[10]=1,C[11]=0,C[12]=te[0],C[13]=te[1],C[14]=te[2],C[15]=1,C},Nh.fromScaling=function(C,te){return C[0]=te[0],C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=te[1],C[6]=0,C[7]=0,C[8]=0,C[9]=0,C[10]=te[2],C[11]=0,C[12]=0,C[13]=0,C[14]=0,C[15]=1,C},Nh.fromRotation=function(C,te,le){var ce,he,ue,de=le[0],_e=le[1],ye=le[2],ve=Math.hypot(de,_e,ye);return ve<jh.EPSILON?null:(de*=ve=1/ve,_e*=ve,ye*=ve,ce=Math.sin(te),he=Math.cos(te),C[0]=de*de*(ue=1-he)+he,C[1]=_e*de*ue+ye*ce,C[2]=ye*de*ue-_e*ce,C[3]=0,C[4]=de*_e*ue-ye*ce,C[5]=_e*_e*ue+he,C[6]=ye*_e*ue+de*ce,C[7]=0,C[8]=de*ye*ue+_e*ce,C[9]=_e*ye*ue-de*ce,C[10]=ye*ye*ue+he,C[11]=0,C[12]=0,C[13]=0,C[14]=0,C[15]=1,C)},Nh.fromXRotation=function(C,te){var le=Math.sin(te),ce=Math.cos(te);return C[0]=1,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=ce,C[6]=le,C[7]=0,C[8]=0,C[9]=-le,C[10]=ce,C[11]=0,C[12]=0,C[13]=0,C[14]=0,C[15]=1,C},Nh.fromYRotation=function(C,te){var le=Math.sin(te),ce=Math.cos(te);return C[0]=ce,C[1]=0,C[2]=-le,C[3]=0,C[4]=0,C[5]=1,C[6]=0,C[7]=0,C[8]=le,C[9]=0,C[10]=ce,C[11]=0,C[12]=0,C[13]=0,C[14]=0,C[15]=1,C},Nh.fromZRotation=function(C,te){var le=Math.sin(te),ce=Math.cos(te);return C[0]=ce,C[1]=le,C[2]=0,C[3]=0,C[4]=-le,C[5]=ce,C[6]=0,C[7]=0,C[8]=0,C[9]=0,C[10]=1,C[11]=0,C[12]=0,C[13]=0,C[14]=0,C[15]=1,C},Nh.fromRotationTranslation=Bc,Nh.fromQuat2=function(C,te){var le=new jh.ARRAY_TYPE(3),ce=-te[0],he=-te[1],ue=-te[2],de=te[3],_e=te[4],ye=te[5],ve=te[6],Se=te[7],Me=ce*ce+he*he+ue*ue+de*de;return Me>0?(le[0]=2*(_e*de+Se*ce+ye*ue-ve*he)/Me,le[1]=2*(ye*de+Se*he+ve*ce-_e*ue)/Me,le[2]=2*(ve*de+Se*ue+_e*he-ye*ce)/Me):(le[0]=2*(_e*de+Se*ce+ye*ue-ve*he),le[1]=2*(ye*de+Se*he+ve*ce-_e*ue),le[2]=2*(ve*de+Se*ue+_e*he-ye*ce)),Bc(C,te,le),C},Nh.getTranslation=function(C,te){return C[0]=te[12],C[1]=te[13],C[2]=te[14],C},Nh.getScaling=Fc,Nh.getRotation=function(C,te){var le=new jh.ARRAY_TYPE(3);Fc(le,te);var ce=1/le[0],he=1/le[1],ue=1/le[2],de=te[0]*ce,_e=te[1]*he,ye=te[2]*ue,ve=te[4]*ce,Se=te[5]*he,Me=te[6]*ue,Ae=te[8]*ce,Ce=te[9]*he,Oe=te[10]*ue,Ne=de+Se+Oe,je=0;return Ne>0?(je=2*Math.sqrt(Ne+1),C[3]=.25*je,C[0]=(Me-Ce)/je,C[1]=(Ae-ye)/je,C[2]=(_e-ve)/je):de>Se&&de>Oe?(je=2*Math.sqrt(1+de-Se-Oe),C[3]=(Me-Ce)/je,C[0]=.25*je,C[1]=(_e+ve)/je,C[2]=(Ae+ye)/je):Se>Oe?(je=2*Math.sqrt(1+Se-de-Oe),C[3]=(Ae-ye)/je,C[0]=(_e+ve)/je,C[1]=.25*je,C[2]=(Me+Ce)/je):(je=2*Math.sqrt(1+Oe-de-Se),C[3]=(_e-ve)/je,C[0]=(Ae+ye)/je,C[1]=(Me+Ce)/je,C[2]=.25*je),C},Nh.fromRotationTranslationScale=function(C,te,le,ce){var he=te[0],ue=te[1],de=te[2],_e=te[3],ye=he+he,ve=ue+ue,Se=de+de,Me=he*ye,Ae=he*ve,Ce=he*Se,Oe=ue*ve,Ne=ue*Se,je=de*Se,Ge=_e*ye,Ze=_e*ve,qe=_e*Se,$e=ce[0],He=ce[1],We=ce[2];return C[0]=(1-(Oe+je))*$e,C[1]=(Ae+qe)*$e,C[2]=(Ce-Ze)*$e,C[3]=0,C[4]=(Ae-qe)*He,C[5]=(1-(Me+je))*He,C[6]=(Ne+Ge)*He,C[7]=0,C[8]=(Ce+Ze)*We,C[9]=(Ne-Ge)*We,C[10]=(1-(Me+Oe))*We,C[11]=0,C[12]=le[0],C[13]=le[1],C[14]=le[2],C[15]=1,C},Nh.fromRotationTranslationScaleOrigin=function(C,te,le,ce,he){var ue=te[0],de=te[1],_e=te[2],ye=te[3],ve=ue+ue,Se=de+de,Me=_e+_e,Ae=ue*ve,Ce=ue*Se,Oe=ue*Me,Ne=de*Se,je=de*Me,Ge=_e*Me,Ze=ye*ve,qe=ye*Se,$e=ye*Me,He=ce[0],We=ce[1],Xe=ce[2],Ye=he[0],Je=he[1],Qe=he[2],tt=(1-(Ne+Ge))*He,rt=(Ce+$e)*He,ot=(Oe-qe)*He,st=(Ce-$e)*We,at=(1-(Ae+Ge))*We,lt=(je+Ze)*We,ct=(Oe+qe)*Xe,ht=(je-Ze)*Xe,dt=(1-(Ae+Ne))*Xe;return C[0]=tt,C[1]=rt,C[2]=ot,C[3]=0,C[4]=st,C[5]=at,C[6]=lt,C[7]=0,C[8]=ct,C[9]=ht,C[10]=dt,C[11]=0,C[12]=le[0]+Ye-(tt*Ye+st*Je+ct*Qe),C[13]=le[1]+Je-(rt*Ye+at*Je+ht*Qe),C[14]=le[2]+Qe-(ot*Ye+lt*Je+dt*Qe),C[15]=1,C},Nh.fromQuat=function(C,te){var le=te[0],ce=te[1],he=te[2],ue=te[3],de=le+le,_e=ce+ce,ye=he+he,ve=le*de,Se=ce*de,Me=ce*_e,Ae=he*de,Ce=he*_e,Oe=he*ye,Ne=ue*de,je=ue*_e,Ge=ue*ye;return C[0]=1-Me-Oe,C[1]=Se+Ge,C[2]=Ae-je,C[3]=0,C[4]=Se-Ge,C[5]=1-ve-Oe,C[6]=Ce+Ne,C[7]=0,C[8]=Ae+je,C[9]=Ce-Ne,C[10]=1-ve-Me,C[11]=0,C[12]=0,C[13]=0,C[14]=0,C[15]=1,C},Nh.frustum=function(C,te,le,ce,he,ue,de){var _e=1/(le-te),ye=1/(he-ce),ve=1/(ue-de);return C[0]=2*ue*_e,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=2*ue*ye,C[6]=0,C[7]=0,C[8]=(le+te)*_e,C[9]=(he+ce)*ye,C[10]=(de+ue)*ve,C[11]=-1,C[12]=0,C[13]=0,C[14]=de*ue*2*ve,C[15]=0,C},Nh.perspectiveNO=Nc,Nh.perspectiveZO=function(C,te,le,ce,he){var ue,de=1/Math.tan(te/2);return C[0]=de/le,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=de,C[6]=0,C[7]=0,C[8]=0,C[9]=0,C[11]=-1,C[12]=0,C[13]=0,C[15]=0,null!=he&&he!==1/0?(C[10]=he*(ue=1/(ce-he)),C[14]=he*ce*ue):(C[10]=-1,C[14]=-ce),C},Nh.perspectiveFromFieldOfView=function(C,te,le,ce){var he=Math.tan(te.upDegrees*Math.PI/180),ue=Math.tan(te.downDegrees*Math.PI/180),de=Math.tan(te.leftDegrees*Math.PI/180),_e=Math.tan(te.rightDegrees*Math.PI/180),ye=2/(de+_e),ve=2/(he+ue);return C[0]=ye,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=ve,C[6]=0,C[7]=0,C[8]=-(de-_e)*ye*.5,C[9]=(he-ue)*ve*.5,C[10]=ce/(le-ce),C[11]=-1,C[12]=0,C[13]=0,C[14]=ce*le/(le-ce),C[15]=0,C},Nh.orthoNO=Uc,Nh.orthoZO=function(C,te,le,ce,he,ue,de){var _e=1/(te-le),ye=1/(ce-he),ve=1/(ue-de);return C[0]=-2*_e,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=-2*ye,C[6]=0,C[7]=0,C[8]=0,C[9]=0,C[10]=ve,C[11]=0,C[12]=(te+le)*_e,C[13]=(he+ce)*ye,C[14]=ue*ve,C[15]=1,C},Nh.lookAt=function(C,te,le,ce){var he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe=te[0],Ne=te[1],je=te[2],Ge=ce[0],Ze=ce[1],qe=ce[2],$e=le[0],He=le[1],We=le[2];return Math.abs(Oe-$e)<jh.EPSILON&&Math.abs(Ne-He)<jh.EPSILON&&Math.abs(je-We)<jh.EPSILON?kc(C):(Se=Oe-$e,Me=Ne-He,Ae=je-We,he=Ze*(Ae*=Ce=1/Math.hypot(Se,Me,Ae))-qe*(Me*=Ce),ue=qe*(Se*=Ce)-Ge*Ae,de=Ge*Me-Ze*Se,(Ce=Math.hypot(he,ue,de))?(he*=Ce=1/Ce,ue*=Ce,de*=Ce):(he=0,ue=0,de=0),_e=Me*de-Ae*ue,ye=Ae*he-Se*de,ve=Se*ue-Me*he,(Ce=Math.hypot(_e,ye,ve))?(_e*=Ce=1/Ce,ye*=Ce,ve*=Ce):(_e=0,ye=0,ve=0),C[0]=he,C[1]=_e,C[2]=Se,C[3]=0,C[4]=ue,C[5]=ye,C[6]=Me,C[7]=0,C[8]=de,C[9]=ve,C[10]=Ae,C[11]=0,C[12]=-(he*Oe+ue*Ne+de*je),C[13]=-(_e*Oe+ye*Ne+ve*je),C[14]=-(Se*Oe+Me*Ne+Ae*je),C[15]=1,C)},Nh.targetTo=function(C,te,le,ce){var he=te[0],ue=te[1],de=te[2],_e=ce[0],ye=ce[1],ve=ce[2],Se=he-le[0],Me=ue-le[1],Ae=de-le[2],Ce=Se*Se+Me*Me+Ae*Ae;Ce>0&&(Se*=Ce=1/Math.sqrt(Ce),Me*=Ce,Ae*=Ce);var Oe=ye*Ae-ve*Me,Ne=ve*Se-_e*Ae,je=_e*Me-ye*Se;return(Ce=Oe*Oe+Ne*Ne+je*je)>0&&(Oe*=Ce=1/Math.sqrt(Ce),Ne*=Ce,je*=Ce),C[0]=Oe,C[1]=Ne,C[2]=je,C[3]=0,C[4]=Me*je-Ae*Ne,C[5]=Ae*Oe-Se*je,C[6]=Se*Ne-Me*Oe,C[7]=0,C[8]=Se,C[9]=Me,C[10]=Ae,C[11]=0,C[12]=he,C[13]=ue,C[14]=de,C[15]=1,C},Nh.str=function(C){return"mat4("+C[0]+", "+C[1]+", "+C[2]+", "+C[3]+", "+C[4]+", "+C[5]+", "+C[6]+", "+C[7]+", "+C[8]+", "+C[9]+", "+C[10]+", "+C[11]+", "+C[12]+", "+C[13]+", "+C[14]+", "+C[15]+")"},Nh.frob=function(C){return Math.hypot(C[0],C[1],C[2],C[3],C[4],C[5],C[6],C[7],C[8],C[9],C[10],C[11],C[12],C[13],C[14],C[15])},Nh.add=function(C,te,le){return C[0]=te[0]+le[0],C[1]=te[1]+le[1],C[2]=te[2]+le[2],C[3]=te[3]+le[3],C[4]=te[4]+le[4],C[5]=te[5]+le[5],C[6]=te[6]+le[6],C[7]=te[7]+le[7],C[8]=te[8]+le[8],C[9]=te[9]+le[9],C[10]=te[10]+le[10],C[11]=te[11]+le[11],C[12]=te[12]+le[12],C[13]=te[13]+le[13],C[14]=te[14]+le[14],C[15]=te[15]+le[15],C},Nh.subtract=Vc,Nh.multiplyScalar=function(C,te,le){return C[0]=te[0]*le,C[1]=te[1]*le,C[2]=te[2]*le,C[3]=te[3]*le,C[4]=te[4]*le,C[5]=te[5]*le,C[6]=te[6]*le,C[7]=te[7]*le,C[8]=te[8]*le,C[9]=te[9]*le,C[10]=te[10]*le,C[11]=te[11]*le,C[12]=te[12]*le,C[13]=te[13]*le,C[14]=te[14]*le,C[15]=te[15]*le,C},Nh.multiplyScalarAndAdd=function(C,te,le,ce){return C[0]=te[0]+le[0]*ce,C[1]=te[1]+le[1]*ce,C[2]=te[2]+le[2]*ce,C[3]=te[3]+le[3]*ce,C[4]=te[4]+le[4]*ce,C[5]=te[5]+le[5]*ce,C[6]=te[6]+le[6]*ce,C[7]=te[7]+le[7]*ce,C[8]=te[8]+le[8]*ce,C[9]=te[9]+le[9]*ce,C[10]=te[10]+le[10]*ce,C[11]=te[11]+le[11]*ce,C[12]=te[12]+le[12]*ce,C[13]=te[13]+le[13]*ce,C[14]=te[14]+le[14]*ce,C[15]=te[15]+le[15]*ce,C},Nh.exactEquals=function(C,te){return C[0]===te[0]&&C[1]===te[1]&&C[2]===te[2]&&C[3]===te[3]&&C[4]===te[4]&&C[5]===te[5]&&C[6]===te[6]&&C[7]===te[7]&&C[8]===te[8]&&C[9]===te[9]&&C[10]===te[10]&&C[11]===te[11]&&C[12]===te[12]&&C[13]===te[13]&&C[14]===te[14]&&C[15]===te[15]},Nh.equals=function(C,te){var le=C[0],ce=C[1],he=C[2],ue=C[3],de=C[4],_e=C[5],ye=C[6],ve=C[7],Se=C[8],Me=C[9],Ae=C[10],Ce=C[11],Oe=C[12],Ne=C[13],je=C[14],Ge=C[15],Ze=te[0],qe=te[1],$e=te[2],He=te[3],We=te[4],Xe=te[5],Ye=te[6],Je=te[7],Qe=te[8],tt=te[9],rt=te[10],ot=te[11],st=te[12],at=te[13],lt=te[14],ct=te[15];return Math.abs(le-Ze)<=jh.EPSILON*Math.max(1,Math.abs(le),Math.abs(Ze))&&Math.abs(ce-qe)<=jh.EPSILON*Math.max(1,Math.abs(ce),Math.abs(qe))&&Math.abs(he-$e)<=jh.EPSILON*Math.max(1,Math.abs(he),Math.abs($e))&&Math.abs(ue-He)<=jh.EPSILON*Math.max(1,Math.abs(ue),Math.abs(He))&&Math.abs(de-We)<=jh.EPSILON*Math.max(1,Math.abs(de),Math.abs(We))&&Math.abs(_e-Xe)<=jh.EPSILON*Math.max(1,Math.abs(_e),Math.abs(Xe))&&Math.abs(ye-Ye)<=jh.EPSILON*Math.max(1,Math.abs(ye),Math.abs(Ye))&&Math.abs(ve-Je)<=jh.EPSILON*Math.max(1,Math.abs(ve),Math.abs(Je))&&Math.abs(Se-Qe)<=jh.EPSILON*Math.max(1,Math.abs(Se),Math.abs(Qe))&&Math.abs(Me-tt)<=jh.EPSILON*Math.max(1,Math.abs(Me),Math.abs(tt))&&Math.abs(Ae-rt)<=jh.EPSILON*Math.max(1,Math.abs(Ae),Math.abs(rt))&&Math.abs(Ce-ot)<=jh.EPSILON*Math.max(1,Math.abs(Ce),Math.abs(ot))&&Math.abs(Oe-st)<=jh.EPSILON*Math.max(1,Math.abs(Oe),Math.abs(st))&&Math.abs(Ne-at)<=jh.EPSILON*Math.max(1,Math.abs(Ne),Math.abs(at))&&Math.abs(je-lt)<=jh.EPSILON*Math.max(1,Math.abs(je),Math.abs(lt))&&Math.abs(Ge-ct)<=jh.EPSILON*Math.max(1,Math.abs(Ge),Math.abs(ct))},Nh.sub=Nh.mul=Nh.ortho=Nh.perspective=void 0;var jh=function(C,te){if(C&&C.__esModule)return C;if(null===C||"object"!==Dc(C)&&"function"!=typeof C)return{default:C};var le=Lc(void 0);if(le&&le.has(C))return le.get(C);var ce={},he=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var ue in C)if("default"!==ue&&Object.prototype.hasOwnProperty.call(C,ue)){var de=he?Object.getOwnPropertyDescriptor(C,ue):null;de&&(de.get||de.set)?Object.defineProperty(ce,ue,de):ce[ue]=C[ue]}return ce.default=C,le&&le.set(C,ce),ce}(xh);function Lc(C){if("function"!=typeof WeakMap)return null;var te=new WeakMap,le=new WeakMap;return(Lc=function(C){return C?le:te})(C)}function kc(C){return C[0]=1,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=1,C[6]=0,C[7]=0,C[8]=0,C[9]=0,C[10]=1,C[11]=0,C[12]=0,C[13]=0,C[14]=0,C[15]=1,C}function Oc(C,te,le){var ce=te[0],he=te[1],ue=te[2],de=te[3],_e=te[4],ye=te[5],ve=te[6],Se=te[7],Me=te[8],Ae=te[9],Ce=te[10],Oe=te[11],Ne=te[12],je=te[13],Ge=te[14],Ze=te[15],qe=le[0],$e=le[1],He=le[2],We=le[3];return C[0]=qe*ce+$e*_e+He*Me+We*Ne,C[1]=qe*he+$e*ye+He*Ae+We*je,C[2]=qe*ue+$e*ve+He*Ce+We*Ge,C[3]=qe*de+$e*Se+He*Oe+We*Ze,C[4]=(qe=le[4])*ce+($e=le[5])*_e+(He=le[6])*Me+(We=le[7])*Ne,C[5]=qe*he+$e*ye+He*Ae+We*je,C[6]=qe*ue+$e*ve+He*Ce+We*Ge,C[7]=qe*de+$e*Se+He*Oe+We*Ze,C[8]=(qe=le[8])*ce+($e=le[9])*_e+(He=le[10])*Me+(We=le[11])*Ne,C[9]=qe*he+$e*ye+He*Ae+We*je,C[10]=qe*ue+$e*ve+He*Ce+We*Ge,C[11]=qe*de+$e*Se+He*Oe+We*Ze,C[12]=(qe=le[12])*ce+($e=le[13])*_e+(He=le[14])*Me+(We=le[15])*Ne,C[13]=qe*he+$e*ye+He*Ae+We*je,C[14]=qe*ue+$e*ve+He*Ce+We*Ge,C[15]=qe*de+$e*Se+He*Oe+We*Ze,C}function Bc(C,te,le){var ce=te[0],he=te[1],ue=te[2],de=te[3],_e=ce+ce,ye=he+he,ve=ue+ue,Se=ce*_e,Me=ce*ye,Ae=ce*ve,Ce=he*ye,Oe=he*ve,Ne=ue*ve,je=de*_e,Ge=de*ye,Ze=de*ve;return C[0]=1-(Ce+Ne),C[1]=Me+Ze,C[2]=Ae-Ge,C[3]=0,C[4]=Me-Ze,C[5]=1-(Se+Ne),C[6]=Oe+je,C[7]=0,C[8]=Ae+Ge,C[9]=Oe-je,C[10]=1-(Se+Ce),C[11]=0,C[12]=le[0],C[13]=le[1],C[14]=le[2],C[15]=1,C}function Fc(C,te){var le=te[4],ce=te[5],he=te[6],ue=te[8],de=te[9],_e=te[10];return C[0]=Math.hypot(te[0],te[1],te[2]),C[1]=Math.hypot(le,ce,he),C[2]=Math.hypot(ue,de,_e),C}function Nc(C,te,le,ce,he){var ue,de=1/Math.tan(te/2);return C[0]=de/le,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=de,C[6]=0,C[7]=0,C[8]=0,C[9]=0,C[11]=-1,C[12]=0,C[13]=0,C[15]=0,null!=he&&he!==1/0?(C[10]=(he+ce)*(ue=1/(ce-he)),C[14]=2*he*ce*ue):(C[10]=-1,C[14]=-2*ce),C}function Uc(C,te,le,ce,he,ue,de){var _e=1/(te-le),ye=1/(ce-he),ve=1/(ue-de);return C[0]=-2*_e,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=-2*ye,C[6]=0,C[7]=0,C[8]=0,C[9]=0,C[10]=2*ve,C[11]=0,C[12]=(te+le)*_e,C[13]=(he+ce)*ye,C[14]=(de+ue)*ve,C[15]=1,C}function Vc(C,te,le){return C[0]=te[0]-le[0],C[1]=te[1]-le[1],C[2]=te[2]-le[2],C[3]=te[3]-le[3],C[4]=te[4]-le[4],C[5]=te[5]-le[5],C[6]=te[6]-le[6],C[7]=te[7]-le[7],C[8]=te[8]-le[8],C[9]=te[9]-le[9],C[10]=te[10]-le[10],C[11]=te[11]-le[11],C[12]=te[12]-le[12],C[13]=te[13]-le[13],C[14]=te[14]-le[14],C[15]=te[15]-le[15],C}Nh.perspective=Nc,Nh.ortho=Uc,Nh.mul=Oc,Nh.sub=Vc;var Uh={},Vh={};function qc(C){return qc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(C){return typeof C}:function(C){return C&&"function"==typeof Symbol&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},qc(C)}Object.defineProperty(Vh,"__esModule",{value:!0}),Vh.create=Wc,Vh.clone=function(C){var te=new Gh.ARRAY_TYPE(3);return te[0]=C[0],te[1]=C[1],te[2]=C[2],te},Vh.length=Hc,Vh.fromValues=function(C,te,le){var ce=new Gh.ARRAY_TYPE(3);return ce[0]=C,ce[1]=te,ce[2]=le,ce},Vh.copy=function(C,te){return C[0]=te[0],C[1]=te[1],C[2]=te[2],C},Vh.set=function(C,te,le,ce){return C[0]=te,C[1]=le,C[2]=ce,C},Vh.add=function(C,te,le){return C[0]=te[0]+le[0],C[1]=te[1]+le[1],C[2]=te[2]+le[2],C},Vh.subtract=Xc,Vh.multiply=Yc,Vh.divide=Kc,Vh.ceil=function(C,te){return C[0]=Math.ceil(te[0]),C[1]=Math.ceil(te[1]),C[2]=Math.ceil(te[2]),C},Vh.floor=function(C,te){return C[0]=Math.floor(te[0]),C[1]=Math.floor(te[1]),C[2]=Math.floor(te[2]),C},Vh.min=function(C,te,le){return C[0]=Math.min(te[0],le[0]),C[1]=Math.min(te[1],le[1]),C[2]=Math.min(te[2],le[2]),C},Vh.max=function(C,te,le){return C[0]=Math.max(te[0],le[0]),C[1]=Math.max(te[1],le[1]),C[2]=Math.max(te[2],le[2]),C},Vh.round=function(C,te){return C[0]=Math.round(te[0]),C[1]=Math.round(te[1]),C[2]=Math.round(te[2]),C},Vh.scale=function(C,te,le){return C[0]=te[0]*le,C[1]=te[1]*le,C[2]=te[2]*le,C},Vh.scaleAndAdd=function(C,te,le,ce){return C[0]=te[0]+le[0]*ce,C[1]=te[1]+le[1]*ce,C[2]=te[2]+le[2]*ce,C},Vh.distance=Jc,Vh.squaredDistance=Qc,Vh.squaredLength=eh,Vh.negate=function(C,te){return C[0]=-te[0],C[1]=-te[1],C[2]=-te[2],C},Vh.inverse=function(C,te){return C[0]=1/te[0],C[1]=1/te[1],C[2]=1/te[2],C},Vh.normalize=function(C,te){var le=te[0],ce=te[1],he=te[2],ue=le*le+ce*ce+he*he;return ue>0&&(ue=1/Math.sqrt(ue)),C[0]=te[0]*ue,C[1]=te[1]*ue,C[2]=te[2]*ue,C},Vh.dot=th,Vh.cross=function(C,te,le){var ce=te[0],he=te[1],ue=te[2],de=le[0],_e=le[1],ye=le[2];return C[0]=he*ye-ue*_e,C[1]=ue*de-ce*ye,C[2]=ce*_e-he*de,C},Vh.lerp=function(C,te,le,ce){var he=te[0],ue=te[1],de=te[2];return C[0]=he+ce*(le[0]-he),C[1]=ue+ce*(le[1]-ue),C[2]=de+ce*(le[2]-de),C},Vh.hermite=function(C,te,le,ce,he,ue){var de=ue*ue,_e=de*(2*ue-3)+1,ye=de*(ue-2)+ue,ve=de*(ue-1),Se=de*(3-2*ue);return C[0]=te[0]*_e+le[0]*ye+ce[0]*ve+he[0]*Se,C[1]=te[1]*_e+le[1]*ye+ce[1]*ve+he[1]*Se,C[2]=te[2]*_e+le[2]*ye+ce[2]*ve+he[2]*Se,C},Vh.bezier=function(C,te,le,ce,he,ue){var de=1-ue,_e=de*de,ye=ue*ue,ve=_e*de,Se=3*ue*_e,Me=3*ye*de,Ae=ye*ue;return C[0]=te[0]*ve+le[0]*Se+ce[0]*Me+he[0]*Ae,C[1]=te[1]*ve+le[1]*Se+ce[1]*Me+he[1]*Ae,C[2]=te[2]*ve+le[2]*Se+ce[2]*Me+he[2]*Ae,C},Vh.random=function(C,te){te=te||1;var le=2*Gh.RANDOM()*Math.PI,ce=2*Gh.RANDOM()-1,he=Math.sqrt(1-ce*ce)*te;return C[0]=Math.cos(le)*he,C[1]=Math.sin(le)*he,C[2]=ce*te,C},Vh.transformMat4=function(C,te,le){var ce=te[0],he=te[1],ue=te[2],de=le[3]*ce+le[7]*he+le[11]*ue+le[15];return C[0]=(le[0]*ce+le[4]*he+le[8]*ue+le[12])/(de=de||1),C[1]=(le[1]*ce+le[5]*he+le[9]*ue+le[13])/de,C[2]=(le[2]*ce+le[6]*he+le[10]*ue+le[14])/de,C},Vh.transformMat3=function(C,te,le){var ce=te[0],he=te[1],ue=te[2];return C[0]=ce*le[0]+he*le[3]+ue*le[6],C[1]=ce*le[1]+he*le[4]+ue*le[7],C[2]=ce*le[2]+he*le[5]+ue*le[8],C},Vh.transformQuat=function(C,te,le){var ce=le[0],he=le[1],ue=le[2],de=te[0],_e=te[1],ye=te[2],ve=he*ye-ue*_e,Se=ue*de-ce*ye,Me=ce*_e-he*de,Ae=he*Me-ue*Se,Ce=ue*ve-ce*Me,Oe=ce*Se-he*ve,Ne=2*le[3];return Se*=Ne,Me*=Ne,Ce*=2,Oe*=2,C[0]=de+(ve*=Ne)+(Ae*=2),C[1]=_e+Se+Ce,C[2]=ye+Me+Oe,C},Vh.rotateX=function(C,te,le,ce){var he=[],ue=[];return he[0]=te[0]-le[0],he[1]=te[1]-le[1],he[2]=te[2]-le[2],ue[0]=he[0],ue[1]=he[1]*Math.cos(ce)-he[2]*Math.sin(ce),ue[2]=he[1]*Math.sin(ce)+he[2]*Math.cos(ce),C[0]=ue[0]+le[0],C[1]=ue[1]+le[1],C[2]=ue[2]+le[2],C},Vh.rotateY=function(C,te,le,ce){var he=[],ue=[];return he[0]=te[0]-le[0],he[1]=te[1]-le[1],he[2]=te[2]-le[2],ue[0]=he[2]*Math.sin(ce)+he[0]*Math.cos(ce),ue[1]=he[1],ue[2]=he[2]*Math.cos(ce)-he[0]*Math.sin(ce),C[0]=ue[0]+le[0],C[1]=ue[1]+le[1],C[2]=ue[2]+le[2],C},Vh.rotateZ=function(C,te,le,ce){var he=[],ue=[];return he[0]=te[0]-le[0],he[1]=te[1]-le[1],he[2]=te[2]-le[2],ue[0]=he[0]*Math.cos(ce)-he[1]*Math.sin(ce),ue[1]=he[0]*Math.sin(ce)+he[1]*Math.cos(ce),ue[2]=he[2],C[0]=ue[0]+le[0],C[1]=ue[1]+le[1],C[2]=ue[2]+le[2],C},Vh.angle=function(C,te){var le=C[0],ce=C[1],he=C[2],ue=te[0],de=te[1],_e=te[2],ye=Math.sqrt(le*le+ce*ce+he*he)*Math.sqrt(ue*ue+de*de+_e*_e),ve=ye&&th(C,te)/ye;return Math.acos(Math.min(Math.max(ve,-1),1))},Vh.zero=function(C){return C[0]=0,C[1]=0,C[2]=0,C},Vh.str=function(C){return"vec3("+C[0]+", "+C[1]+", "+C[2]+")"},Vh.exactEquals=function(C,te){return C[0]===te[0]&&C[1]===te[1]&&C[2]===te[2]},Vh.equals=function(C,te){var le=C[0],ce=C[1],he=C[2],ue=te[0],de=te[1],_e=te[2];return Math.abs(le-ue)<=Gh.EPSILON*Math.max(1,Math.abs(le),Math.abs(ue))&&Math.abs(ce-de)<=Gh.EPSILON*Math.max(1,Math.abs(ce),Math.abs(de))&&Math.abs(he-_e)<=Gh.EPSILON*Math.max(1,Math.abs(he),Math.abs(_e))},Vh.forEach=Vh.sqrLen=Vh.len=Vh.sqrDist=Vh.dist=Vh.div=Vh.mul=Vh.sub=void 0;var Gh=function(C,te){if(C&&C.__esModule)return C;if(null===C||"object"!==qc(C)&&"function"!=typeof C)return{default:C};var le=$c(void 0);if(le&&le.has(C))return le.get(C);var ce={},he=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var ue in C)if("default"!==ue&&Object.prototype.hasOwnProperty.call(C,ue)){var de=he?Object.getOwnPropertyDescriptor(C,ue):null;de&&(de.get||de.set)?Object.defineProperty(ce,ue,de):ce[ue]=C[ue]}return ce.default=C,le&&le.set(C,ce),ce}(xh);function $c(C){if("function"!=typeof WeakMap)return null;var te=new WeakMap,le=new WeakMap;return($c=function(C){return C?le:te})(C)}function Wc(){var C=new Gh.ARRAY_TYPE(3);return Gh.ARRAY_TYPE!=Float32Array&&(C[0]=0,C[1]=0,C[2]=0),C}function Hc(C){return Math.hypot(C[0],C[1],C[2])}function Xc(C,te,le){return C[0]=te[0]-le[0],C[1]=te[1]-le[1],C[2]=te[2]-le[2],C}function Yc(C,te,le){return C[0]=te[0]*le[0],C[1]=te[1]*le[1],C[2]=te[2]*le[2],C}function Kc(C,te,le){return C[0]=te[0]/le[0],C[1]=te[1]/le[1],C[2]=te[2]/le[2],C}function Jc(C,te){return Math.hypot(te[0]-C[0],te[1]-C[1],te[2]-C[2])}function Qc(C,te){var le=te[0]-C[0],ce=te[1]-C[1],he=te[2]-C[2];return le*le+ce*ce+he*he}function eh(C){var te=C[0],le=C[1],ce=C[2];return te*te+le*le+ce*ce}function th(C,te){return C[0]*te[0]+C[1]*te[1]+C[2]*te[2]}Vh.sub=Xc,Vh.mul=Yc,Vh.div=Kc,Vh.dist=Jc,Vh.sqrDist=Qc,Vh.len=Hc,Vh.sqrLen=eh;var Zh,qh=(Zh=Wc(),function(C,te,le,ce,he,ue){var de,_e;for(te||(te=3),le||(le=0),_e=ce?Math.min(ce*te+le,C.length):C.length,de=le;de<_e;de+=te)Zh[0]=C[de],Zh[1]=C[de+1],Zh[2]=C[de+2],he(Zh,Zh,ue),C[de]=Zh[0],C[de+1]=Zh[1],C[de+2]=Zh[2];return C});Vh.forEach=qh;var Hh={};function oh(C){return oh="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(C){return typeof C}:function(C){return C&&"function"==typeof Symbol&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},oh(C)}Object.defineProperty(Hh,"__esModule",{value:!0}),Hh.create=lh,Hh.clone=function(C){var te=new Wh.ARRAY_TYPE(4);return te[0]=C[0],te[1]=C[1],te[2]=C[2],te[3]=C[3],te},Hh.fromValues=function(C,te,le,ce){var he=new Wh.ARRAY_TYPE(4);return he[0]=C,he[1]=te,he[2]=le,he[3]=ce,he},Hh.copy=function(C,te){return C[0]=te[0],C[1]=te[1],C[2]=te[2],C[3]=te[3],C},Hh.set=function(C,te,le,ce,he){return C[0]=te,C[1]=le,C[2]=ce,C[3]=he,C},Hh.add=function(C,te,le){return C[0]=te[0]+le[0],C[1]=te[1]+le[1],C[2]=te[2]+le[2],C[3]=te[3]+le[3],C},Hh.subtract=ch,Hh.multiply=hh,Hh.divide=uh,Hh.ceil=function(C,te){return C[0]=Math.ceil(te[0]),C[1]=Math.ceil(te[1]),C[2]=Math.ceil(te[2]),C[3]=Math.ceil(te[3]),C},Hh.floor=function(C,te){return C[0]=Math.floor(te[0]),C[1]=Math.floor(te[1]),C[2]=Math.floor(te[2]),C[3]=Math.floor(te[3]),C},Hh.min=function(C,te,le){return C[0]=Math.min(te[0],le[0]),C[1]=Math.min(te[1],le[1]),C[2]=Math.min(te[2],le[2]),C[3]=Math.min(te[3],le[3]),C},Hh.max=function(C,te,le){return C[0]=Math.max(te[0],le[0]),C[1]=Math.max(te[1],le[1]),C[2]=Math.max(te[2],le[2]),C[3]=Math.max(te[3],le[3]),C},Hh.round=function(C,te){return C[0]=Math.round(te[0]),C[1]=Math.round(te[1]),C[2]=Math.round(te[2]),C[3]=Math.round(te[3]),C},Hh.scale=function(C,te,le){return C[0]=te[0]*le,C[1]=te[1]*le,C[2]=te[2]*le,C[3]=te[3]*le,C},Hh.scaleAndAdd=function(C,te,le,ce){return C[0]=te[0]+le[0]*ce,C[1]=te[1]+le[1]*ce,C[2]=te[2]+le[2]*ce,C[3]=te[3]+le[3]*ce,C},Hh.distance=dh,Hh.squaredDistance=ph,Hh.length=fh,Hh.squaredLength=mh,Hh.negate=function(C,te){return C[0]=-te[0],C[1]=-te[1],C[2]=-te[2],C[3]=-te[3],C},Hh.inverse=function(C,te){return C[0]=1/te[0],C[1]=1/te[1],C[2]=1/te[2],C[3]=1/te[3],C},Hh.normalize=function(C,te){var le=te[0],ce=te[1],he=te[2],ue=te[3],de=le*le+ce*ce+he*he+ue*ue;return de>0&&(de=1/Math.sqrt(de)),C[0]=le*de,C[1]=ce*de,C[2]=he*de,C[3]=ue*de,C},Hh.dot=function(C,te){return C[0]*te[0]+C[1]*te[1]+C[2]*te[2]+C[3]*te[3]},Hh.cross=function(C,te,le,ce){var he=le[0]*ce[1]-le[1]*ce[0],ue=le[0]*ce[2]-le[2]*ce[0],de=le[0]*ce[3]-le[3]*ce[0],_e=le[1]*ce[2]-le[2]*ce[1],ye=le[1]*ce[3]-le[3]*ce[1],ve=le[2]*ce[3]-le[3]*ce[2],Se=te[0],Me=te[1],Ae=te[2],Ce=te[3];return C[0]=Me*ve-Ae*ye+Ce*_e,C[1]=-Se*ve+Ae*de-Ce*ue,C[2]=Se*ye-Me*de+Ce*he,C[3]=-Se*_e+Me*ue-Ae*he,C},Hh.lerp=function(C,te,le,ce){var he=te[0],ue=te[1],de=te[2],_e=te[3];return C[0]=he+ce*(le[0]-he),C[1]=ue+ce*(le[1]-ue),C[2]=de+ce*(le[2]-de),C[3]=_e+ce*(le[3]-_e),C},Hh.random=function(C,te){var le,ce,he,ue,de,_e;te=te||1;do{de=(le=2*Wh.RANDOM()-1)*le+(ce=2*Wh.RANDOM()-1)*ce}while(de>=1);do{_e=(he=2*Wh.RANDOM()-1)*he+(ue=2*Wh.RANDOM()-1)*ue}while(_e>=1);var ye=Math.sqrt((1-de)/_e);return C[0]=te*le,C[1]=te*ce,C[2]=te*he*ye,C[3]=te*ue*ye,C},Hh.transformMat4=function(C,te,le){var ce=te[0],he=te[1],ue=te[2],de=te[3];return C[0]=le[0]*ce+le[4]*he+le[8]*ue+le[12]*de,C[1]=le[1]*ce+le[5]*he+le[9]*ue+le[13]*de,C[2]=le[2]*ce+le[6]*he+le[10]*ue+le[14]*de,C[3]=le[3]*ce+le[7]*he+le[11]*ue+le[15]*de,C},Hh.transformQuat=function(C,te,le){var ce=te[0],he=te[1],ue=te[2],de=le[0],_e=le[1],ye=le[2],ve=le[3],Se=ve*ce+_e*ue-ye*he,Me=ve*he+ye*ce-de*ue,Ae=ve*ue+de*he-_e*ce,Ce=-de*ce-_e*he-ye*ue;return C[0]=Se*ve+Ce*-de+Me*-ye-Ae*-_e,C[1]=Me*ve+Ce*-_e+Ae*-de-Se*-ye,C[2]=Ae*ve+Ce*-ye+Se*-_e-Me*-de,C[3]=te[3],C},Hh.zero=function(C){return C[0]=0,C[1]=0,C[2]=0,C[3]=0,C},Hh.str=function(C){return"vec4("+C[0]+", "+C[1]+", "+C[2]+", "+C[3]+")"},Hh.exactEquals=function(C,te){return C[0]===te[0]&&C[1]===te[1]&&C[2]===te[2]&&C[3]===te[3]},Hh.equals=function(C,te){var le=C[0],ce=C[1],he=C[2],ue=C[3],de=te[0],_e=te[1],ye=te[2],ve=te[3];return Math.abs(le-de)<=Wh.EPSILON*Math.max(1,Math.abs(le),Math.abs(de))&&Math.abs(ce-_e)<=Wh.EPSILON*Math.max(1,Math.abs(ce),Math.abs(_e))&&Math.abs(he-ye)<=Wh.EPSILON*Math.max(1,Math.abs(he),Math.abs(ye))&&Math.abs(ue-ve)<=Wh.EPSILON*Math.max(1,Math.abs(ue),Math.abs(ve))},Hh.forEach=Hh.sqrLen=Hh.len=Hh.sqrDist=Hh.dist=Hh.div=Hh.mul=Hh.sub=void 0;var Wh=function(C,te){if(C&&C.__esModule)return C;if(null===C||"object"!==oh(C)&&"function"!=typeof C)return{default:C};var le=ah(void 0);if(le&&le.has(C))return le.get(C);var ce={},he=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var ue in C)if("default"!==ue&&Object.prototype.hasOwnProperty.call(C,ue)){var de=he?Object.getOwnPropertyDescriptor(C,ue):null;de&&(de.get||de.set)?Object.defineProperty(ce,ue,de):ce[ue]=C[ue]}return ce.default=C,le&&le.set(C,ce),ce}(xh);function ah(C){if("function"!=typeof WeakMap)return null;var te=new WeakMap,le=new WeakMap;return(ah=function(C){return C?le:te})(C)}function lh(){var C=new Wh.ARRAY_TYPE(4);return Wh.ARRAY_TYPE!=Float32Array&&(C[0]=0,C[1]=0,C[2]=0,C[3]=0),C}function ch(C,te,le){return C[0]=te[0]-le[0],C[1]=te[1]-le[1],C[2]=te[2]-le[2],C[3]=te[3]-le[3],C}function hh(C,te,le){return C[0]=te[0]*le[0],C[1]=te[1]*le[1],C[2]=te[2]*le[2],C[3]=te[3]*le[3],C}function uh(C,te,le){return C[0]=te[0]/le[0],C[1]=te[1]/le[1],C[2]=te[2]/le[2],C[3]=te[3]/le[3],C}function dh(C,te){return Math.hypot(te[0]-C[0],te[1]-C[1],te[2]-C[2],te[3]-C[3])}function ph(C,te){var le=te[0]-C[0],ce=te[1]-C[1],he=te[2]-C[2],ue=te[3]-C[3];return le*le+ce*ce+he*he+ue*ue}function fh(C){return Math.hypot(C[0],C[1],C[2],C[3])}function mh(C){var te=C[0],le=C[1],ce=C[2],he=C[3];return te*te+le*le+ce*ce+he*he}Hh.sub=ch,Hh.mul=hh,Hh.div=uh,Hh.dist=dh,Hh.sqrDist=ph,Hh.len=fh,Hh.sqrLen=mh;var Xh=function(){var C=lh();return function(te,le,ce,he,ue,de){var _e,ye;for(le||(le=4),ce||(ce=0),ye=he?Math.min(he*le+ce,te.length):te.length,_e=ce;_e<ye;_e+=le)C[0]=te[_e],C[1]=te[_e+1],C[2]=te[_e+2],C[3]=te[_e+3],ue(C,C,de),te[_e]=C[0],te[_e+1]=C[1],te[_e+2]=C[2],te[_e+3]=C[3];return te}}();function gh(C){return gh="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(C){return typeof C}:function(C){return C&&"function"==typeof Symbol&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},gh(C)}Hh.forEach=Xh,Object.defineProperty(Uh,"__esModule",{value:!0}),Uh.create=Eh,Uh.identity=function(C){return C[0]=0,C[1]=0,C[2]=0,C[3]=1,C},Uh.setAxisAngle=Mh,Uh.getAxisAngle=function(C,te){var le=2*Math.acos(te[3]),ce=Math.sin(le/2);return ce>tu.EPSILON?(C[0]=te[0]/ce,C[1]=te[1]/ce,C[2]=te[2]/ce):(C[0]=1,C[1]=0,C[2]=0),le},Uh.getAngle=function(C,te){var le=_u(C,te);return Math.acos(2*le*le-1)},Uh.multiply=Ah,Uh.rotateX=function(C,te,le){le*=.5;var ce=te[0],he=te[1],ue=te[2],de=te[3],_e=Math.sin(le),ye=Math.cos(le);return C[0]=ce*ye+de*_e,C[1]=he*ye+ue*_e,C[2]=ue*ye-he*_e,C[3]=de*ye-ce*_e,C},Uh.rotateY=function(C,te,le){le*=.5;var ce=te[0],he=te[1],ue=te[2],de=te[3],_e=Math.sin(le),ye=Math.cos(le);return C[0]=ce*ye-ue*_e,C[1]=he*ye+de*_e,C[2]=ue*ye+ce*_e,C[3]=de*ye-he*_e,C},Uh.rotateZ=function(C,te,le){le*=.5;var ce=te[0],he=te[1],ue=te[2],de=te[3],_e=Math.sin(le),ye=Math.cos(le);return C[0]=ce*ye+he*_e,C[1]=he*ye-ce*_e,C[2]=ue*ye+de*_e,C[3]=de*ye-ue*_e,C},Uh.calculateW=function(C,te){var le=te[0],ce=te[1],he=te[2];return C[0]=le,C[1]=ce,C[2]=he,C[3]=Math.sqrt(Math.abs(1-le*le-ce*ce-he*he)),C},Uh.exp=Sh,Uh.ln=Ih,Uh.pow=function(C,te,le){return Ih(C,te),su(C,C,le),Sh(C,C),C},Uh.slerp=Ch,Uh.random=function(C){var te=tu.RANDOM(),le=tu.RANDOM(),ce=tu.RANDOM(),he=Math.sqrt(1-te),ue=Math.sqrt(te);return C[0]=he*Math.sin(2*Math.PI*le),C[1]=he*Math.cos(2*Math.PI*le),C[2]=ue*Math.sin(2*Math.PI*ce),C[3]=ue*Math.cos(2*Math.PI*ce),C},Uh.invert=function(C,te){var le=te[0],ce=te[1],he=te[2],ue=te[3],de=le*le+ce*ce+he*he+ue*ue,_e=de?1/de:0;return C[0]=-le*_e,C[1]=-ce*_e,C[2]=-he*_e,C[3]=ue*_e,C},Uh.conjugate=function(C,te){return C[0]=-te[0],C[1]=-te[1],C[2]=-te[2],C[3]=te[3],C},Uh.fromMat3=zh,Uh.fromEuler=function(C,te,le,ce){var he=.5*Math.PI/180;te*=he,le*=he,ce*=he;var ue=Math.sin(te),de=Math.cos(te),_e=Math.sin(le),ye=Math.cos(le),ve=Math.sin(ce),Se=Math.cos(ce);return C[0]=ue*ye*Se-de*_e*ve,C[1]=de*_e*Se+ue*ye*ve,C[2]=de*ye*ve-ue*_e*Se,C[3]=de*ye*Se+ue*_e*ve,C},Uh.str=function(C){return"quat("+C[0]+", "+C[1]+", "+C[2]+", "+C[3]+")"},Uh.setAxes=Uh.sqlerp=Uh.rotationTo=Uh.equals=Uh.exactEquals=Uh.normalize=Uh.sqrLen=Uh.squaredLength=Uh.len=Uh.length=Uh.lerp=Uh.dot=Uh.scale=Uh.mul=Uh.add=Uh.set=Uh.copy=Uh.fromValues=Uh.clone=void 0;var tu=Th(xh),iu=Th(Bh),ru=Th(Vh),nu=Th(Hh);function wh(C){if("function"!=typeof WeakMap)return null;var te=new WeakMap,le=new WeakMap;return(wh=function(C){return C?le:te})(C)}function Th(C,te){if(!te&&C&&C.__esModule)return C;if(null===C||"object"!==gh(C)&&"function"!=typeof C)return{default:C};var le=wh(te);if(le&&le.has(C))return le.get(C);var ce={},he=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var ue in C)if("default"!==ue&&Object.prototype.hasOwnProperty.call(C,ue)){var de=he?Object.getOwnPropertyDescriptor(C,ue):null;de&&(de.get||de.set)?Object.defineProperty(ce,ue,de):ce[ue]=C[ue]}return ce.default=C,le&&le.set(C,ce),ce}function Eh(){var C=new tu.ARRAY_TYPE(4);return tu.ARRAY_TYPE!=Float32Array&&(C[0]=0,C[1]=0,C[2]=0),C[3]=1,C}function Mh(C,te,le){le*=.5;var ce=Math.sin(le);return C[0]=ce*te[0],C[1]=ce*te[1],C[2]=ce*te[2],C[3]=Math.cos(le),C}function Ah(C,te,le){var ce=te[0],he=te[1],ue=te[2],de=te[3],_e=le[0],ye=le[1],ve=le[2],Se=le[3];return C[0]=ce*Se+de*_e+he*ve-ue*ye,C[1]=he*Se+de*ye+ue*_e-ce*ve,C[2]=ue*Se+de*ve+ce*ye-he*_e,C[3]=de*Se-ce*_e-he*ye-ue*ve,C}function Sh(C,te){var le=te[0],ce=te[1],he=te[2],ue=te[3],de=Math.sqrt(le*le+ce*ce+he*he),_e=Math.exp(ue),ye=de>0?_e*Math.sin(de)/de:0;return C[0]=le*ye,C[1]=ce*ye,C[2]=he*ye,C[3]=_e*Math.cos(de),C}function Ih(C,te){var le=te[0],ce=te[1],he=te[2],ue=te[3],de=Math.sqrt(le*le+ce*ce+he*he),_e=de>0?Math.atan2(de,ue)/de:0;return C[0]=le*_e,C[1]=ce*_e,C[2]=he*_e,C[3]=.5*Math.log(le*le+ce*ce+he*he+ue*ue),C}function Ch(C,te,le,ce){var he,ue,de,_e,ye,ve=te[0],Se=te[1],Me=te[2],Ae=te[3],Ce=le[0],Oe=le[1],Ne=le[2],je=le[3];return(ue=ve*Ce+Se*Oe+Me*Ne+Ae*je)<0&&(ue=-ue,Ce=-Ce,Oe=-Oe,Ne=-Ne,je=-je),1-ue>tu.EPSILON?(he=Math.acos(ue),de=Math.sin(he),_e=Math.sin((1-ce)*he)/de,ye=Math.sin(ce*he)/de):(_e=1-ce,ye=ce),C[0]=_e*ve+ye*Ce,C[1]=_e*Se+ye*Oe,C[2]=_e*Me+ye*Ne,C[3]=_e*Ae+ye*je,C}function zh(C,te){var le,ce=te[0]+te[4]+te[8];if(ce>0)le=Math.sqrt(ce+1),C[3]=.5*le,C[0]=(te[5]-te[7])*(le=.5/le),C[1]=(te[6]-te[2])*le,C[2]=(te[1]-te[3])*le;else{var he=0;te[4]>te[0]&&(he=1),te[8]>te[3*he+he]&&(he=2);var ue=(he+1)%3,de=(he+2)%3;le=Math.sqrt(te[3*he+he]-te[3*ue+ue]-te[3*de+de]+1),C[he]=.5*le,C[3]=(te[3*ue+de]-te[3*de+ue])*(le=.5/le),C[ue]=(te[3*ue+he]+te[3*he+ue])*le,C[de]=(te[3*de+he]+te[3*he+de])*le}return C}Uh.clone=nu.clone,Uh.fromValues=nu.fromValues,Uh.copy=nu.copy,Uh.set=nu.set,Uh.add=nu.add,Uh.mul=Ah;var su=nu.scale;Uh.scale=su;var _u=nu.dot;Uh.dot=_u,Uh.lerp=nu.lerp;var yu=nu.length;Uh.length=yu,Uh.len=yu;var xu=nu.squaredLength;Uh.squaredLength=xu,Uh.sqrLen=xu;var vu=nu.normalize;Uh.normalize=vu,Uh.exactEquals=nu.exactEquals,Uh.equals=nu.equals;var bu,wu,Tu,Su=(bu=ru.create(),wu=ru.fromValues(1,0,0),Tu=ru.fromValues(0,1,0),function(C,te,le){var ce=ru.dot(te,le);return ce<-.999999?(ru.cross(bu,wu,te),ru.len(bu)<1e-6&&ru.cross(bu,Tu,te),ru.normalize(bu,bu),Mh(C,bu,Math.PI),C):ce>.999999?(C[0]=0,C[1]=0,C[2]=0,C[3]=1,C):(ru.cross(bu,te,le),C[0]=bu[0],C[1]=bu[1],C[2]=bu[2],C[3]=1+ce,vu(C,C))});Uh.rotationTo=Su;var Mu,Eu,Au=(Mu=Eh(),Eu=Eh(),function(C,te,le,ce,he,ue){return Ch(Mu,te,he,ue),Ch(Eu,le,ce,ue),Ch(C,Mu,Eu,2*ue*(1-ue)),C});Uh.sqlerp=Au;var Iu,Cu=(Iu=iu.create(),function(C,te,le,ce){return Iu[0]=le[0],Iu[3]=le[1],Iu[6]=le[2],Iu[1]=ce[0],Iu[4]=ce[1],Iu[7]=ce[2],Iu[2]=-te[0],Iu[5]=-te[1],Iu[8]=-te[2],vu(C,zh(C,Iu))});Uh.setAxes=Cu;var zu={};function $h(C){return $h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(C){return typeof C}:function(C){return C&&"function"==typeof Symbol&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},$h(C)}Object.defineProperty(zu,"__esModule",{value:!0}),zu.create=function(){var C=new Du.ARRAY_TYPE(8);return Du.ARRAY_TYPE!=Float32Array&&(C[0]=0,C[1]=0,C[2]=0,C[4]=0,C[5]=0,C[6]=0,C[7]=0),C[3]=1,C},zu.clone=function(C){var te=new Du.ARRAY_TYPE(8);return te[0]=C[0],te[1]=C[1],te[2]=C[2],te[3]=C[3],te[4]=C[4],te[5]=C[5],te[6]=C[6],te[7]=C[7],te},zu.fromValues=function(C,te,le,ce,he,ue,de,_e){var ye=new Du.ARRAY_TYPE(8);return ye[0]=C,ye[1]=te,ye[2]=le,ye[3]=ce,ye[4]=he,ye[5]=ue,ye[6]=de,ye[7]=_e,ye},zu.fromRotationTranslationValues=function(C,te,le,ce,he,ue,de){var _e=new Du.ARRAY_TYPE(8);_e[0]=C,_e[1]=te,_e[2]=le,_e[3]=ce;var ye=.5*he,ve=.5*ue,Se=.5*de;return _e[4]=ye*ce+ve*le-Se*te,_e[5]=ve*ce+Se*C-ye*le,_e[6]=Se*ce+ye*te-ve*C,_e[7]=-ye*C-ve*te-Se*le,_e},zu.fromRotationTranslation=Jh,zu.fromTranslation=function(C,te){return C[0]=0,C[1]=0,C[2]=0,C[3]=1,C[4]=.5*te[0],C[5]=.5*te[1],C[6]=.5*te[2],C[7]=0,C},zu.fromRotation=function(C,te){return C[0]=te[0],C[1]=te[1],C[2]=te[2],C[3]=te[3],C[4]=0,C[5]=0,C[6]=0,C[7]=0,C},zu.fromMat4=function(C,te){var le=Pu.create();Ru.getRotation(le,te);var ce=new Du.ARRAY_TYPE(3);return Ru.getTranslation(ce,te),Jh(C,le,ce),C},zu.copy=Qh,zu.identity=function(C){return C[0]=0,C[1]=0,C[2]=0,C[3]=1,C[4]=0,C[5]=0,C[6]=0,C[7]=0,C},zu.set=function(C,te,le,ce,he,ue,de,_e,ye){return C[0]=te,C[1]=le,C[2]=ce,C[3]=he,C[4]=ue,C[5]=de,C[6]=_e,C[7]=ye,C},zu.getDual=function(C,te){return C[0]=te[4],C[1]=te[5],C[2]=te[6],C[3]=te[7],C},zu.setDual=function(C,te){return C[4]=te[0],C[5]=te[1],C[6]=te[2],C[7]=te[3],C},zu.getTranslation=function(C,te){var le=te[4],ce=te[5],he=te[6],ue=te[7],de=-te[0],_e=-te[1],ye=-te[2],ve=te[3];return C[0]=2*(le*ve+ue*de+ce*ye-he*_e),C[1]=2*(ce*ve+ue*_e+he*de-le*ye),C[2]=2*(he*ve+ue*ye+le*_e-ce*de),C},zu.translate=function(C,te,le){var ce=te[0],he=te[1],ue=te[2],de=te[3],_e=.5*le[0],ye=.5*le[1],ve=.5*le[2],Se=te[4],Me=te[5],Ae=te[6],Ce=te[7];return C[0]=ce,C[1]=he,C[2]=ue,C[3]=de,C[4]=de*_e+he*ve-ue*ye+Se,C[5]=de*ye+ue*_e-ce*ve+Me,C[6]=de*ve+ce*ye-he*_e+Ae,C[7]=-ce*_e-he*ye-ue*ve+Ce,C},zu.rotateX=function(C,te,le){var ce=-te[0],he=-te[1],ue=-te[2],de=te[3],_e=te[4],ye=te[5],ve=te[6],Se=te[7],Me=_e*de+Se*ce+ye*ue-ve*he,Ae=ye*de+Se*he+ve*ce-_e*ue,Ce=ve*de+Se*ue+_e*he-ye*ce,Oe=Se*de-_e*ce-ye*he-ve*ue;return Pu.rotateX(C,te,le),C[4]=Me*(de=C[3])+Oe*(ce=C[0])+Ae*(ue=C[2])-Ce*(he=C[1]),C[5]=Ae*de+Oe*he+Ce*ce-Me*ue,C[6]=Ce*de+Oe*ue+Me*he-Ae*ce,C[7]=Oe*de-Me*ce-Ae*he-Ce*ue,C},zu.rotateY=function(C,te,le){var ce=-te[0],he=-te[1],ue=-te[2],de=te[3],_e=te[4],ye=te[5],ve=te[6],Se=te[7],Me=_e*de+Se*ce+ye*ue-ve*he,Ae=ye*de+Se*he+ve*ce-_e*ue,Ce=ve*de+Se*ue+_e*he-ye*ce,Oe=Se*de-_e*ce-ye*he-ve*ue;return Pu.rotateY(C,te,le),C[4]=Me*(de=C[3])+Oe*(ce=C[0])+Ae*(ue=C[2])-Ce*(he=C[1]),C[5]=Ae*de+Oe*he+Ce*ce-Me*ue,C[6]=Ce*de+Oe*ue+Me*he-Ae*ce,C[7]=Oe*de-Me*ce-Ae*he-Ce*ue,C},zu.rotateZ=function(C,te,le){var ce=-te[0],he=-te[1],ue=-te[2],de=te[3],_e=te[4],ye=te[5],ve=te[6],Se=te[7],Me=_e*de+Se*ce+ye*ue-ve*he,Ae=ye*de+Se*he+ve*ce-_e*ue,Ce=ve*de+Se*ue+_e*he-ye*ce,Oe=Se*de-_e*ce-ye*he-ve*ue;return Pu.rotateZ(C,te,le),C[4]=Me*(de=C[3])+Oe*(ce=C[0])+Ae*(ue=C[2])-Ce*(he=C[1]),C[5]=Ae*de+Oe*he+Ce*ce-Me*ue,C[6]=Ce*de+Oe*ue+Me*he-Ae*ce,C[7]=Oe*de-Me*ce-Ae*he-Ce*ue,C},zu.rotateByQuatAppend=function(C,te,le){var ce=le[0],he=le[1],ue=le[2],de=le[3],_e=te[0],ye=te[1],ve=te[2],Se=te[3];return C[0]=_e*de+Se*ce+ye*ue-ve*he,C[1]=ye*de+Se*he+ve*ce-_e*ue,C[2]=ve*de+Se*ue+_e*he-ye*ce,C[3]=Se*de-_e*ce-ye*he-ve*ue,C[4]=(_e=te[4])*de+(Se=te[7])*ce+(ye=te[5])*ue-(ve=te[6])*he,C[5]=ye*de+Se*he+ve*ce-_e*ue,C[6]=ve*de+Se*ue+_e*he-ye*ce,C[7]=Se*de-_e*ce-ye*he-ve*ue,C},zu.rotateByQuatPrepend=function(C,te,le){var ce=te[0],he=te[1],ue=te[2],de=te[3],_e=le[0],ye=le[1],ve=le[2],Se=le[3];return C[0]=ce*Se+de*_e+he*ve-ue*ye,C[1]=he*Se+de*ye+ue*_e-ce*ve,C[2]=ue*Se+de*ve+ce*ye-he*_e,C[3]=de*Se-ce*_e-he*ye-ue*ve,C[4]=ce*(Se=le[7])+de*(_e=le[4])+he*(ve=le[6])-ue*(ye=le[5]),C[5]=he*Se+de*ye+ue*_e-ce*ve,C[6]=ue*Se+de*ve+ce*ye-he*_e,C[7]=de*Se-ce*_e-he*ye-ue*ve,C},zu.rotateAroundAxis=function(C,te,le,ce){if(Math.abs(ce)<Du.EPSILON)return Qh(C,te);var he=Math.hypot(le[0],le[1],le[2]);ce*=.5;var ue=Math.sin(ce),de=ue*le[0]/he,_e=ue*le[1]/he,ye=ue*le[2]/he,ve=Math.cos(ce),Se=te[0],Me=te[1],Ae=te[2],Ce=te[3];C[0]=Se*ve+Ce*de+Me*ye-Ae*_e,C[1]=Me*ve+Ce*_e+Ae*de-Se*ye,C[2]=Ae*ve+Ce*ye+Se*_e-Me*de,C[3]=Ce*ve-Se*de-Me*_e-Ae*ye;var Oe=te[4],Ne=te[5],je=te[6],Ge=te[7];return C[4]=Oe*ve+Ge*de+Ne*ye-je*_e,C[5]=Ne*ve+Ge*_e+je*de-Oe*ye,C[6]=je*ve+Ge*ye+Oe*_e-Ne*de,C[7]=Ge*ve-Oe*de-Ne*_e-je*ye,C},zu.add=function(C,te,le){return C[0]=te[0]+le[0],C[1]=te[1]+le[1],C[2]=te[2]+le[2],C[3]=te[3]+le[3],C[4]=te[4]+le[4],C[5]=te[5]+le[5],C[6]=te[6]+le[6],C[7]=te[7]+le[7],C},zu.multiply=eu,zu.scale=function(C,te,le){return C[0]=te[0]*le,C[1]=te[1]*le,C[2]=te[2]*le,C[3]=te[3]*le,C[4]=te[4]*le,C[5]=te[5]*le,C[6]=te[6]*le,C[7]=te[7]*le,C},zu.lerp=function(C,te,le,ce){var he=1-ce;return Ou(te,le)<0&&(ce=-ce),C[0]=te[0]*he+le[0]*ce,C[1]=te[1]*he+le[1]*ce,C[2]=te[2]*he+le[2]*ce,C[3]=te[3]*he+le[3]*ce,C[4]=te[4]*he+le[4]*ce,C[5]=te[5]*he+le[5]*ce,C[6]=te[6]*he+le[6]*ce,C[7]=te[7]*he+le[7]*ce,C},zu.invert=function(C,te){var le=Fu(te);return C[0]=-te[0]/le,C[1]=-te[1]/le,C[2]=-te[2]/le,C[3]=te[3]/le,C[4]=-te[4]/le,C[5]=-te[5]/le,C[6]=-te[6]/le,C[7]=te[7]/le,C},zu.conjugate=function(C,te){return C[0]=-te[0],C[1]=-te[1],C[2]=-te[2],C[3]=te[3],C[4]=-te[4],C[5]=-te[5],C[6]=-te[6],C[7]=te[7],C},zu.normalize=function(C,te){var le=Fu(te);if(le>0){le=Math.sqrt(le);var ce=te[0]/le,he=te[1]/le,ue=te[2]/le,de=te[3]/le,_e=te[4],ye=te[5],ve=te[6],Se=te[7],Me=ce*_e+he*ye+ue*ve+de*Se;C[0]=ce,C[1]=he,C[2]=ue,C[3]=de,C[4]=(_e-ce*Me)/le,C[5]=(ye-he*Me)/le,C[6]=(ve-ue*Me)/le,C[7]=(Se-de*Me)/le}return C},zu.str=function(C){return"quat2("+C[0]+", "+C[1]+", "+C[2]+", "+C[3]+", "+C[4]+", "+C[5]+", "+C[6]+", "+C[7]+")"},zu.exactEquals=function(C,te){return C[0]===te[0]&&C[1]===te[1]&&C[2]===te[2]&&C[3]===te[3]&&C[4]===te[4]&&C[5]===te[5]&&C[6]===te[6]&&C[7]===te[7]},zu.equals=function(C,te){var le=C[0],ce=C[1],he=C[2],ue=C[3],de=C[4],_e=C[5],ye=C[6],ve=C[7],Se=te[0],Me=te[1],Ae=te[2],Ce=te[3],Oe=te[4],Ne=te[5],je=te[6],Ge=te[7];return Math.abs(le-Se)<=Du.EPSILON*Math.max(1,Math.abs(le),Math.abs(Se))&&Math.abs(ce-Me)<=Du.EPSILON*Math.max(1,Math.abs(ce),Math.abs(Me))&&Math.abs(he-Ae)<=Du.EPSILON*Math.max(1,Math.abs(he),Math.abs(Ae))&&Math.abs(ue-Ce)<=Du.EPSILON*Math.max(1,Math.abs(ue),Math.abs(Ce))&&Math.abs(de-Oe)<=Du.EPSILON*Math.max(1,Math.abs(de),Math.abs(Oe))&&Math.abs(_e-Ne)<=Du.EPSILON*Math.max(1,Math.abs(_e),Math.abs(Ne))&&Math.abs(ye-je)<=Du.EPSILON*Math.max(1,Math.abs(ye),Math.abs(je))&&Math.abs(ve-Ge)<=Du.EPSILON*Math.max(1,Math.abs(ve),Math.abs(Ge))},zu.sqrLen=zu.squaredLength=zu.len=zu.length=zu.dot=zu.mul=zu.setReal=zu.getReal=void 0;var Du=Kh(xh),Pu=Kh(Uh),Ru=Kh(Nh);function Yh(C){if("function"!=typeof WeakMap)return null;var te=new WeakMap,le=new WeakMap;return(Yh=function(C){return C?le:te})(C)}function Kh(C,te){if(!te&&C&&C.__esModule)return C;if(null===C||"object"!==$h(C)&&"function"!=typeof C)return{default:C};var le=Yh(te);if(le&&le.has(C))return le.get(C);var ce={},he=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var ue in C)if("default"!==ue&&Object.prototype.hasOwnProperty.call(C,ue)){var de=he?Object.getOwnPropertyDescriptor(C,ue):null;de&&(de.get||de.set)?Object.defineProperty(ce,ue,de):ce[ue]=C[ue]}return ce.default=C,le&&le.set(C,ce),ce}function Jh(C,te,le){var ce=.5*le[0],he=.5*le[1],ue=.5*le[2],de=te[0],_e=te[1],ye=te[2],ve=te[3];return C[0]=de,C[1]=_e,C[2]=ye,C[3]=ve,C[4]=ce*ve+he*ye-ue*_e,C[5]=he*ve+ue*de-ce*ye,C[6]=ue*ve+ce*_e-he*de,C[7]=-ce*de-he*_e-ue*ye,C}function Qh(C,te){return C[0]=te[0],C[1]=te[1],C[2]=te[2],C[3]=te[3],C[4]=te[4],C[5]=te[5],C[6]=te[6],C[7]=te[7],C}function eu(C,te,le){var ce=te[0],he=te[1],ue=te[2],de=te[3],_e=le[4],ye=le[5],ve=le[6],Se=le[7],Me=te[4],Ae=te[5],Ce=te[6],Oe=te[7],Ne=le[0],je=le[1],Ge=le[2],Ze=le[3];return C[0]=ce*Ze+de*Ne+he*Ge-ue*je,C[1]=he*Ze+de*je+ue*Ne-ce*Ge,C[2]=ue*Ze+de*Ge+ce*je-he*Ne,C[3]=de*Ze-ce*Ne-he*je-ue*Ge,C[4]=ce*Se+de*_e+he*ve-ue*ye+Me*Ze+Oe*Ne+Ae*Ge-Ce*je,C[5]=he*Se+de*ye+ue*_e-ce*ve+Ae*Ze+Oe*je+Ce*Ne-Me*Ge,C[6]=ue*Se+de*ve+ce*ye-he*_e+Ce*Ze+Oe*Ge+Me*je-Ae*Ne,C[7]=de*Se-ce*_e-he*ye-ue*ve+Oe*Ze-Me*Ne-Ae*je-Ce*Ge,C}zu.getReal=Pu.copy,zu.setReal=Pu.copy,zu.mul=eu;var Ou=Pu.dot;zu.dot=Ou;var Bu=Pu.length;zu.length=Bu,zu.len=Bu;var Fu=Pu.squaredLength;zu.squaredLength=Fu,zu.sqrLen=Fu;var Nu={};function ou(C){return ou="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(C){return typeof C}:function(C){return C&&"function"==typeof Symbol&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},ou(C)}Object.defineProperty(Nu,"__esModule",{value:!0}),Nu.create=lu,Nu.clone=function(C){var te=new Uu.ARRAY_TYPE(2);return te[0]=C[0],te[1]=C[1],te},Nu.fromValues=function(C,te){var le=new Uu.ARRAY_TYPE(2);return le[0]=C,le[1]=te,le},Nu.copy=function(C,te){return C[0]=te[0],C[1]=te[1],C},Nu.set=function(C,te,le){return C[0]=te,C[1]=le,C},Nu.add=function(C,te,le){return C[0]=te[0]+le[0],C[1]=te[1]+le[1],C},Nu.subtract=cu,Nu.multiply=hu,Nu.divide=uu,Nu.ceil=function(C,te){return C[0]=Math.ceil(te[0]),C[1]=Math.ceil(te[1]),C},Nu.floor=function(C,te){return C[0]=Math.floor(te[0]),C[1]=Math.floor(te[1]),C},Nu.min=function(C,te,le){return C[0]=Math.min(te[0],le[0]),C[1]=Math.min(te[1],le[1]),C},Nu.max=function(C,te,le){return C[0]=Math.max(te[0],le[0]),C[1]=Math.max(te[1],le[1]),C},Nu.round=function(C,te){return C[0]=Math.round(te[0]),C[1]=Math.round(te[1]),C},Nu.scale=function(C,te,le){return C[0]=te[0]*le,C[1]=te[1]*le,C},Nu.scaleAndAdd=function(C,te,le,ce){return C[0]=te[0]+le[0]*ce,C[1]=te[1]+le[1]*ce,C},Nu.distance=du,Nu.squaredDistance=pu,Nu.length=fu,Nu.squaredLength=mu,Nu.negate=function(C,te){return C[0]=-te[0],C[1]=-te[1],C},Nu.inverse=function(C,te){return C[0]=1/te[0],C[1]=1/te[1],C},Nu.normalize=function(C,te){var le=te[0],ce=te[1],he=le*le+ce*ce;return he>0&&(he=1/Math.sqrt(he)),C[0]=te[0]*he,C[1]=te[1]*he,C},Nu.dot=function(C,te){return C[0]*te[0]+C[1]*te[1]},Nu.cross=function(C,te,le){var ce=te[0]*le[1]-te[1]*le[0];return C[0]=C[1]=0,C[2]=ce,C},Nu.lerp=function(C,te,le,ce){var he=te[0],ue=te[1];return C[0]=he+ce*(le[0]-he),C[1]=ue+ce*(le[1]-ue),C},Nu.random=function(C,te){te=te||1;var le=2*Uu.RANDOM()*Math.PI;return C[0]=Math.cos(le)*te,C[1]=Math.sin(le)*te,C},Nu.transformMat2=function(C,te,le){var ce=te[0],he=te[1];return C[0]=le[0]*ce+le[2]*he,C[1]=le[1]*ce+le[3]*he,C},Nu.transformMat2d=function(C,te,le){var ce=te[0],he=te[1];return C[0]=le[0]*ce+le[2]*he+le[4],C[1]=le[1]*ce+le[3]*he+le[5],C},Nu.transformMat3=function(C,te,le){var ce=te[0],he=te[1];return C[0]=le[0]*ce+le[3]*he+le[6],C[1]=le[1]*ce+le[4]*he+le[7],C},Nu.transformMat4=function(C,te,le){var ce=te[0],he=te[1];return C[0]=le[0]*ce+le[4]*he+le[12],C[1]=le[1]*ce+le[5]*he+le[13],C},Nu.rotate=function(C,te,le,ce){var he=te[0]-le[0],ue=te[1]-le[1],de=Math.sin(ce),_e=Math.cos(ce);return C[0]=he*_e-ue*de+le[0],C[1]=he*de+ue*_e+le[1],C},Nu.angle=function(C,te){var le=C[0],ce=C[1],he=te[0],ue=te[1],de=Math.sqrt(le*le+ce*ce)*Math.sqrt(he*he+ue*ue);return Math.acos(Math.min(Math.max(de&&(le*he+ce*ue)/de,-1),1))},Nu.zero=function(C){return C[0]=0,C[1]=0,C},Nu.str=function(C){return"vec2("+C[0]+", "+C[1]+")"},Nu.exactEquals=function(C,te){return C[0]===te[0]&&C[1]===te[1]},Nu.equals=function(C,te){var le=C[0],ce=C[1],he=te[0],ue=te[1];return Math.abs(le-he)<=Uu.EPSILON*Math.max(1,Math.abs(le),Math.abs(he))&&Math.abs(ce-ue)<=Uu.EPSILON*Math.max(1,Math.abs(ce),Math.abs(ue))},Nu.forEach=Nu.sqrLen=Nu.sqrDist=Nu.dist=Nu.div=Nu.mul=Nu.sub=Nu.len=void 0;var Uu=function(C,te){if(C&&C.__esModule)return C;if(null===C||"object"!==ou(C)&&"function"!=typeof C)return{default:C};var le=au(void 0);if(le&&le.has(C))return le.get(C);var ce={},he=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var ue in C)if("default"!==ue&&Object.prototype.hasOwnProperty.call(C,ue)){var de=he?Object.getOwnPropertyDescriptor(C,ue):null;de&&(de.get||de.set)?Object.defineProperty(ce,ue,de):ce[ue]=C[ue]}return ce.default=C,le&&le.set(C,ce),ce}(xh);function au(C){if("function"!=typeof WeakMap)return null;var te=new WeakMap,le=new WeakMap;return(au=function(C){return C?le:te})(C)}function lu(){var C=new Uu.ARRAY_TYPE(2);return Uu.ARRAY_TYPE!=Float32Array&&(C[0]=0,C[1]=0),C}function cu(C,te,le){return C[0]=te[0]-le[0],C[1]=te[1]-le[1],C}function hu(C,te,le){return C[0]=te[0]*le[0],C[1]=te[1]*le[1],C}function uu(C,te,le){return C[0]=te[0]/le[0],C[1]=te[1]/le[1],C}function du(C,te){return Math.hypot(te[0]-C[0],te[1]-C[1])}function pu(C,te){var le=te[0]-C[0],ce=te[1]-C[1];return le*le+ce*ce}function fu(C){return Math.hypot(C[0],C[1])}function mu(C){var te=C[0],le=C[1];return te*te+le*le}Nu.len=fu,Nu.sub=cu,Nu.mul=hu,Nu.div=uu,Nu.dist=du,Nu.sqrDist=pu,Nu.sqrLen=mu;var Vu=function(){var C=lu();return function(te,le,ce,he,ue,de){var _e,ye;for(le||(le=2),ce||(ce=0),ye=he?Math.min(he*le+ce,te.length):te.length,_e=ce;_e<ye;_e+=le)C[0]=te[_e],C[1]=te[_e+1],ue(C,C,de),te[_e]=C[0],te[_e+1]=C[1];return te}}();function gu(C){return gu="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(C){return typeof C}:function(C){return C&&"function"==typeof Symbol&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},gu(C)}Nu.forEach=Vu,Object.defineProperty(yh,"__esModule",{value:!0});var $u=yh.vec4=Zd=yh.vec3=yh.vec2=yh.quat2=Md=yh.quat=ld=yh.mat4=sd=yh.mat3=yh.mat2d=rd=yh.mat2=yh.glMatrix=void 0,td=ku(xh);yh.glMatrix=td;var id=ku(Rh),rd=yh.mat2=id,nd=ku(Lh);yh.mat2d=nd;var od=ku(Bh),sd=yh.mat3=od,ad=ku(Nh),ld=yh.mat4=ad,cd=ku(Uh),Md=yh.quat=cd,jd=ku(zu);yh.quat2=jd;var Ud=ku(Nu);yh.vec2=Ud;var Vd=ku(Vh),Zd=yh.vec3=Vd,qd=ku(Hh);function Lu(C){if("function"!=typeof WeakMap)return null;var te=new WeakMap,le=new WeakMap;return(Lu=function(C){return C?le:te})(C)}function ku(C,te){if(!te&&C&&C.__esModule)return C;if(null===C||"object"!==gu(C)&&"function"!=typeof C)return{default:C};var le=Lu(te);if(le&&le.has(C))return le.get(C);var ce={},he=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var ue in C)if("default"!==ue&&Object.prototype.hasOwnProperty.call(C,ue)){var de=he?Object.getOwnPropertyDescriptor(C,ue):null;de&&(de.get||de.set)?Object.defineProperty(ce,ue,de):ce[ue]=C[ue]}return ce.default=C,le&&le.set(C,ce),ce}$u=yh.vec4=qd;const Hd=Ia([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Wd}=Hd,Xd=Ia([{name:"a_pos_3",components:3,type:"Int16"}]);var rp=Ia([{name:"a_pos",type:"Int16",components:2}]),pp={};!function(C,te){!function(C){function t(C,te,le){var ce=i(256*C,256*(te=Math.pow(2,le)-te-1),le),he=i(256*(C+1),256*(te+1),le);return ce[0]+","+ce[1]+","+he[0]+","+he[1]}function i(C,te,le){var ce=2*Math.PI*6378137/256/Math.pow(2,le);return[C*ce-2*Math.PI*6378137/2,te*ce-2*Math.PI*6378137/2]}C.getURL=function(C,te,le,ce,he,ue){return ue=ue||{},C+"?"+["bbox="+t(le,ce,he),"format="+(ue.format||"image/png"),"service="+(ue.service||"WMS"),"version="+(ue.version||"1.1.1"),"request="+(ue.request||"GetMap"),"srs="+(ue.srs||"EPSG:3857"),"width="+(ue.width||256),"height="+(ue.height||256),"layers="+te].join("&")},C.getTileBBox=t,C.getMercCoords=i,Object.defineProperty(C,"__esModule",{value:!0})}(te)}(0,pp);var fp=pp;class ju{constructor(C,te,le){this.z=C,this.x=te,this.y=le,this.key=Zu(0,C,C,te,le)}equals(C){return this.z===C.z&&this.x===C.x&&this.y===C.y}url(C,te){const le=fp.getTileBBox(this.x,this.y,this.z),ce=function(C,te,le){let ce,he="";for(let ue=C;ue>0;ue--)ce=1<<ue-1,he+=(te&ce?1:0)+(le&ce?2:0);return he}(this.z,this.x,this.y);return C[(this.x+this.y)%C.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String("tms"===te?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",ce).replace("{bbox-epsg-3857}",le)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Gu{constructor(C,te){this.wrap=C,this.canonical=te,this.key=Zu(C,te.z,te.z,te.x,te.y)}}class qu{constructor(C,te,le,ce,he){this.overscaledZ=C,this.wrap=te,this.canonical=new ju(le,+ce,+he),this.key=0===te&&C===le?this.canonical.key:Zu(te,C,le,ce,he)}equals(C){return this.overscaledZ===C.overscaledZ&&this.wrap===C.wrap&&this.canonical.equals(C.canonical)}scaledTo(C){const te=this.canonical.z-C;return C>this.canonical.z?new qu(C,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new qu(C,this.wrap,C,this.canonical.x>>te,this.canonical.y>>te)}calculateScaledKey(C,te=!0){if(this.overscaledZ===C&&te)return this.key;if(C>this.canonical.z)return Zu(this.wrap*+te,C,this.canonical.z,this.canonical.x,this.canonical.y);{const le=this.canonical.z-C;return Zu(this.wrap*+te,C,C,this.canonical.x>>le,this.canonical.y>>le)}}isChildOf(C){if(C.wrap!==this.wrap)return!1;const te=this.canonical.z-C.canonical.z;return 0===C.overscaledZ||C.overscaledZ<this.overscaledZ&&C.canonical.z<this.canonical.z&&C.canonical.x===this.canonical.x>>te&&C.canonical.y===this.canonical.y>>te}children(C){if(this.overscaledZ>=C)return[new qu(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const te=this.canonical.z+1,le=2*this.canonical.x,ce=2*this.canonical.y;return[new qu(te,this.wrap,te,le,ce),new qu(te,this.wrap,te,le+1,ce),new qu(te,this.wrap,te,le,ce+1),new qu(te,this.wrap,te,le+1,ce+1)]}isLessThan(C){return this.wrap<C.wrap||!(this.wrap>C.wrap)&&(this.overscaledZ<C.overscaledZ||!(this.overscaledZ>C.overscaledZ)&&(this.canonical.x<C.canonical.x||!(this.canonical.x>C.canonical.x)&&this.canonical.y<C.canonical.y))}wrapped(){return new qu(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(C){return new qu(this.overscaledZ,C,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Gu(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Zu(C,te,le,ce,he){const ue=1<<Math.min(le,22);let de=ue*(he%ue)+ce%ue;return C&&le<22&&(de+=ue*ue*((C<0?-2*C-1:2*C)%(1<<2*(22-le)))),16*(32*de+le)+(te-le)}const Np=[C=>{let te=C.canonical.x-1,le=C.wrap;return te<0&&(te=(1<<C.canonical.z)-1,le--),new qu(C.overscaledZ,le,C.canonical.z,te,C.canonical.y)},C=>{let te=C.canonical.x+1,le=C.wrap;return te===1<<C.canonical.z&&(te=0,le++),new qu(C.overscaledZ,le,C.canonical.z,te,C.canonical.y)},C=>new qu(C.overscaledZ,C.wrap,C.canonical.z,C.canonical.x,(0===C.canonical.y?1<<C.canonical.z:C.canonical.y)-1),C=>new qu(C.overscaledZ,C.wrap,C.canonical.z,C.canonical.x,C.canonical.y===(1<<C.canonical.z)-1?0:C.canonical.y+1)];Rs(ju,"CanonicalTileID"),Rs(qu,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});class Wu{constructor(C,te){this.pos=C,this.dir=te}intersectsPlane(C,te,le){const ce=Zd.dot(te,this.dir);if(Math.abs(ce)<1e-6)return!1;const he=((C[0]-this.pos[0])*te[0]+(C[1]-this.pos[1])*te[1]+(C[2]-this.pos[2])*te[2])/ce;return le[0]=this.pos[0]+this.dir[0]*he,le[1]=this.pos[1]+this.dir[1]*he,le[2]=this.pos[2]+this.dir[2]*he,!0}closestPointOnSphere(C,te,le){if(Zd.equals(this.pos,C)||0===te)return le[0]=le[1]=le[2]=0,!1;const[ce,he,ue]=this.dir,de=this.pos[0]-C[0],_e=this.pos[1]-C[1],ye=this.pos[2]-C[2],ve=ce*ce+he*he+ue*ue,Se=2*(de*ce+_e*he+ye*ue),Me=Se*Se-4*ve*(de*de+_e*_e+ye*ye-te*te);if(Me<0){const C=Math.max(-Se/2,0),ve=de+ce*C,Me=_e+he*C,Ae=ye+ue*C,Ce=Math.hypot(ve,Me,Ae);return le[0]=ve*te/Ce,le[1]=Me*te/Ce,le[2]=Ae*te/Ce,!1}{const C=(-Se-Math.sqrt(Me))/(2*ve);if(C<0){const C=Math.hypot(de,_e,ye);return le[0]=de*te/C,le[1]=_e*te/C,le[2]=ye*te/C,!1}return le[0]=de+ce*C,le[1]=_e+he*C,le[2]=ye+ue*C,!0}}}class Hu{constructor(C,te,le,ce,he){this.TL=C,this.TR=te,this.BR=le,this.BL=ce,this.horizon=he}static fromInvProjectionMatrix(C,te,le){const ce=[-1,1,1],he=[1,1,1],ue=[1,-1,1],de=[-1,-1,1],_e=Zd.transformMat4(ce,ce,C),ye=Zd.transformMat4(he,he,C),ve=Zd.transformMat4(ue,ue,C),Se=Zd.transformMat4(de,de,C);return new Hu(_e,ye,ve,Se,te/le)}}function Xu(C,te,le){let ce=1/0,he=-1/0;const ue=[];for(const de of C){Zd.sub(ue,de,te);const C=Zd.dot(ue,le);ce=Math.min(ce,C),he=Math.max(he,C)}return[ce,he]}function Yu(C,te){let le=!0;for(let ce=0;ce<C.planes.length;ce++){const he=C.planes[ce];let ue=0;for(let C=0;C<te.length;C++)ue+=Zd.dot(he,te[C])+he[3]>=0;if(0===ue)return 0;ue!==te.length&&(le=!1)}return le?2:1}function Ku(C,te){for(const le of C.projections){const ce=Xu(te,C.points[0],le.axis);if(le.projection[1]<ce[0]||le.projection[0]>ce[1])return 0}return 1}function Ju(C,te){let le=0;const ce=[0,0,0,0];for(let he=0;he<C.length;he++)ce[0]=C[he][0],ce[1]=C[he][1],ce[2]=C[he][2],ce[3]=1,$u.dot(ce,te)>=0&&le++;return le}class Qu{constructor(C,te){this.points=C||new Array(8).fill([0,0,0]),this.planes=te||new Array(6).fill([0,0,0,0]),this.bounds=ed.fromPoints(this.points),this.projections=[],this.frustumEdges=[Zd.sub([],this.points[2],this.points[3]),Zd.sub([],this.points[0],this.points[3]),Zd.sub([],this.points[4],this.points[0]),Zd.sub([],this.points[5],this.points[1]),Zd.sub([],this.points[6],this.points[2]),Zd.sub([],this.points[7],this.points[3])];for(const C of this.frustumEdges){const te=[0,-C[2],C[1]],le=[C[2],0,-C[0]];this.projections.push({axis:te,projection:Xu(this.points,this.points[0],te)}),this.projections.push({axis:le,projection:Xu(this.points,this.points[0],le)})}}static fromInvProjectionMatrix(C,te,le,ce){const he=Math.pow(2,le),ue=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map((le=>{const ue=$u.transformMat4([],le,C),de=1/ue[3]/te*he;return $u.mul(ue,ue,[de,de,ce?1/ue[3]:de,de])})),de=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map((C=>{const te=Zd.sub([],ue[C[0]],ue[C[1]]),le=Zd.sub([],ue[C[2]],ue[C[1]]),ce=Zd.normalize([],Zd.cross([],te,le)),he=-Zd.dot(ce,ue[C[1]]);return ce.concat(he)})),_e=[];for(let C=0;C<ue.length;C++)_e.push([ue[C][0],ue[C][1],ue[C][2]]);return new Qu(_e,de)}intersectsPrecise(C,te,le){for(let le=0;le<te.length;le++)if(!Ju(C,te[le]))return 0;for(let te=0;te<this.planes.length;te++)if(!Ju(C,this.planes[te]))return 0;for(const te of le)for(const le of this.frustumEdges){const ce=Zd.cross([],te,le),he=Zd.length(ce);if(0===he)continue;Zd.scale(ce,ce,1/he);const ue=Xu(this.points,this.points[0],ce),de=Xu(C,this.points[0],ce);if(ue[0]>de[1]||de[0]>ue[1])return 0}return 1}}class ed{static fromPoints(C){const te=[1/0,1/0,1/0],le=[-1/0,-1/0,-1/0];for(const ce of C)Zd.min(te,te,ce),Zd.max(le,le,ce);return new ed(te,le)}static fromTileIdAndHeight(C,te,le){const ce=1<<C.canonical.z,he=C.canonical.x,ue=C.canonical.y;return new ed([he/ce,ue/ce,te],[(he+1)/ce,(ue+1)/ce,le])}static applyTransform(C,te){const le=C.getCorners();for(let C=0;C<le.length;++C)Zd.transformMat4(le[C],le[C],te);return ed.fromPoints(le)}static projectAabbCorners(C,te){const le=C.getCorners();for(let C=0;C<le.length;++C)Zd.transformMat4(le[C],le[C],te);return le}constructor(C,te){this.min=C,this.max=te,this.center=Zd.scale([],Zd.add([],this.min,this.max),.5)}quadrant(C){const te=[C%2==0,C<2],le=Zd.clone(this.min),ce=Zd.clone(this.max);for(let C=0;C<te.length;C++)le[C]=te[C]?this.min[C]:this.center[C],ce[C]=te[C]?this.center[C]:this.max[C];return ce[2]=this.max[2],new ed(le,ce)}distanceX(C){return Math.max(Math.min(this.max[0],C[0]),this.min[0])-C[0]}distanceY(C){return Math.max(Math.min(this.max[1],C[1]),this.min[1])-C[1]}distanceZ(C){return Math.max(Math.min(this.max[2],C[2]),this.min[2])-C[2]}getCorners(){const C=this.min,te=this.max;return[[C[0],C[1],C[2]],[te[0],C[1],C[2]],[te[0],te[1],C[2]],[C[0],te[1],C[2]],[C[0],C[1],te[2]],[te[0],C[1],te[2]],[te[0],te[1],te[2]],[C[0],te[1],te[2]]]}intersects(C){return this.intersectsAabb(C.bounds)?Yu(C,this.getCorners()):0}intersectsFlat(C){return this.intersectsAabb(C.bounds)?Yu(C,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(C,te){return te||this.intersects(C)?Ku(C,this.getCorners()):0}intersectsPreciseFlat(C,te){return te||this.intersectsFlat(C)?Ku(C,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(C){for(let te=0;te<3;++te)if(this.min[te]>C.max[te]||C.min[te]>this.max[te])return!1;return!0}intersectsAabbXY(C){return!(this.min[0]>C.max[0]||C.min[0]>this.max[0]||this.min[1]>C.max[1]||C.min[1]>this.max[1])}encapsulate(C){for(let te=0;te<3;te++)this.min[te]=Math.min(this.min[te],C.min[te]),this.max[te]=Math.max(this.max[te],C.max[te])}encapsulatePoint(C){for(let te=0;te<3;te++)this.min[te]=Math.min(this.min[te],C[te]),this.max[te]=Math.max(this.max[te],C[te])}closestPoint(C){return[Math.max(Math.min(this.max[0],C[0]),this.min[0]),Math.max(Math.min(this.max[1],C[1]),this.min[1]),Math.max(Math.min(this.max[2],C[2]),this.min[2])]}}Rs(ed,"Aabb");const Up=5,Vp=6,$p=Mn/Math.PI/2,Wp=16383,rf=64,nf=[rf,32,16],sf=-$p,af=$p,lf=[new ed([sf,sf,sf],[af,af,af]),new ed([sf,sf,sf],[0,0,af]),new ed([0,sf,sf],[af,0,af]),new ed([sf,0,sf],[0,af,af]),new ed([0,0,sf],[af,af,af])];function hd(C){return C*$p/Zf}function ud(C,te,le,ce=!0){const he=Zd.scale([],C._camera.position,C.worldSize),ue=[te,le,1,1];$u.transformMat4(ue,ue,C.pixelMatrixInverse),$u.scale(ue,ue,1/ue[3]);const de=Zd.sub([],ue,he),_e=Zd.normalize([],de),ye=C.globeMatrix,ve=[ye[12],ye[13],ye[14]],Se=Zd.sub([],ve,he),Me=Zd.length(Se),Ae=Zd.normalize([],Se),Ce=C.worldSize/(2*Math.PI),Oe=Zd.dot(Ae,_e),Ne=Math.asin(Ce/Me);if(Ne<Math.acos(Oe)){if(!ce)return null;const C=[],te=[];Zd.scale(C,_e,Me/Oe),Zd.normalize(te,Zd.sub(te,C,Se)),Zd.normalize(_e,Zd.add(_e,Se,Zd.scale(_e,te,Math.tan(Ne)*Me)))}const je=[];new Wu(he,_e).closestPointOnSphere(ve,Ce,je);const Ge=Zd.normalize([],ne(ye,0)),Ze=Zd.normalize([],ne(ye,1)),qe=Zd.normalize([],ne(ye,2)),$e=Zd.dot(Ge,je),He=Zd.dot(Ze,je),We=Zd.dot(qe,je),Xe=T(Math.asin(-He/Ce));let Ye=T(Math.atan2($e,We));Ye=C.center.lng+function(C,te){const le=(te-C+180)%360-180;return le<-180?le+360:le}(C.center.lng,Ye);const Je=Kd(Ye),Qe=z(Jd(Xe),0,1);return new lp(Je,Qe)}class dd{constructor(C,te,le){this.a=Zd.sub([],C,le),this.b=Zd.sub([],te,le),this.center=le;const ce=Zd.normalize([],this.a),he=Zd.normalize([],this.b);this.angle=Math.acos(Zd.dot(ce,he))}}function pd(C,te){if(0===C.angle)return null;let le;return le=0===C.a[te]?1/C.angle*.5*Math.PI:1/C.angle*Math.atan(C.b[te]/C.a[te]/Math.sin(C.angle)-1/Math.tan(C.angle)),le<0||le>1?null:function(C,te,le,ce){const he=Math.sin(le);return C*(Math.sin((1-ce)*le)/he)+te*(Math.sin(ce*le)/he)}(C.a[te],C.b[te],C.angle,z(le,0,1))+C.center[te]}function fd(C){if(C.z<=1)return lf[C.z+2*C.y+C.x];const te=vd(xd(C));return ed.fromPoints(te)}function md(C,te,le){return Zd.scale(C,C,1-le),Zd.scaleAndAdd(C,C,te,le)}function _d(C,te){const le=Dd(te.zoom);if(0===le)return fd(C);const ce=xd(C),he=vd(ce),ue=Kd(ce.getWest())*te.worldSize,de=Kd(ce.getEast())*te.worldSize,_e=Jd(ce.getNorth())*te.worldSize,ye=Jd(ce.getSouth())*te.worldSize,ve=[ue,_e,0],Se=[de,_e,0],Me=[ue,ye,0],Ae=[de,ye,0],Ce=ld.invert([],te.globeMatrix);return Zd.transformMat4(ve,ve,Ce),Zd.transformMat4(Se,Se,Ce),Zd.transformMat4(Me,Me,Ce),Zd.transformMat4(Ae,Ae,Ce),he[0]=md(he[0],Me,le),he[1]=md(he[1],Ae,le),he[2]=md(he[2],Se,le),he[3]=md(he[3],ve,le),ed.fromPoints(he)}function gd(C,te,le){for(const ce of C)Zd.transformMat4(ce,ce,te),Zd.scale(ce,ce,le)}function yd(C,te,le,ce){const he=te/C.worldSize,ue=C.globeMatrix;if(le.z<=1){const C=fd(le).getCorners();return gd(C,ue,he),ed.fromPoints(C)}const de=xd(le,ce),_e=vd(de);gd(_e,ue,he);const ye=Number.MAX_VALUE,ve=[-ye,-ye,-ye],Se=[ye,ye,ye];if(de.contains(C.center)){for(const C of _e)Zd.min(Se,Se,C),Zd.max(ve,ve,C);ve[2]=0;const te=C.point,le=[te.x*he,te.y*he,0];return Zd.min(Se,Se,le),Zd.max(ve,ve,le),new ed(Se,ve)}const Me=[ue[12]*he,ue[13]*he,ue[14]*he],Ae=de.getCenter(),Ce=z(C.center.lat,-Xf,Xf),Oe=z(Ae.lat,-Xf,Xf),Ne=Kd(C.center.lng),je=Jd(Ce);let Ge=Ne-Kd(Ae.lng);const Ze=je-Jd(Oe);Ge>.5?Ge-=1:Ge<-.5&&(Ge+=1);let qe=0;if(Math.abs(Ge)>Math.abs(Ze))qe=Ge>=0?1:3;else{qe=Ze>=0?0:2;const C=[ue[4]*he,ue[5]*he,ue[6]*he],te=-Math.sin(w(Ze>=0?de.getSouth():de.getNorth()))*$p;Zd.scaleAndAdd(Me,Me,C,te)}const $e=_e[qe],He=_e[(qe+1)%4],We=new dd($e,He,Me),Xe=[pd(We,0)||$e[0],pd(We,1)||$e[1],pd(We,2)||$e[2]],Ye=Dd(C.zoom);if(Ye>0){const ce=function({x:C,y:te,z:le},ce,he,ue,de){const _e=1/(1<<le);let ye=C*_e,ve=ye+_e,Se=te*_e,Me=Se+_e,Ae=0;const Ce=(ye+ve)/2-ue;return Ce>.5?Ae=-1:Ce<-.5&&(Ae=1),ye=((ye+Ae)*ce-(ue*=ce))*he+ue,ve=((ve+Ae)*ce-ue)*he+ue,Se=(Se*ce-(de*=ce))*he+de,Me=(Me*ce-de)*he+de,[[ye,Me,0],[ve,Me,0],[ve,Se,0],[ye,Se,0]]}(le,te,C._pixelsPerMercatorPixel,Ne,je);for(let C=0;C<_e.length;C++)md(_e[C],ce[C],Ye);const he=Zd.add([],ce[qe],ce[(qe+1)%4]);Zd.scale(he,he,.5),md(Xe,he,Ye)}for(const C of _e)Zd.min(Se,Se,C),Zd.max(ve,ve,C);return Se[2]=Math.min($e[2],He[2]),Zd.min(Se,Se,Xe),Zd.max(ve,ve,Xe),new ed(Se,ve)}function xd({x:C,y:te,z:le},ce=!1){const he=1/(1<<le),ue=new $f(ep(C*he),te===(1<<le)-1&&ce?-90:tp((te+1)*he)),de=new $f(ep((C+1)*he),0===te&&ce?90:tp(te*he));return new sc(ue,de)}function vd(C){const te=w(C.getNorth()),le=w(C.getSouth()),ce=Math.cos(te),he=Math.cos(le),ue=Math.sin(te),de=Math.sin(le),_e=C.getWest(),ye=C.getEast();return[bd(he,de,_e),bd(he,de,ye),bd(ce,ue,ye),bd(ce,ue,_e)]}function bd(C,te,le,ce=$p){return le=w(le),[C*Math.sin(le)*ce,-te*ce,C*Math.cos(le)*ce]}function wd(C,te,le){return bd(Math.cos(w(C)),Math.sin(w(C)),te,le)}function Td(C,te,le,ce){const he=1<<le.z,ue=(C/Mn+le.x)/he;return wd(tp((te/Mn+le.y)/he),ep(ue),ce)}function Ed({min:C,max:te}){return Wp/Math.max(te[0]-C[0],te[1]-C[1],te[2]-C[2])}const cf=new Float64Array(16);function Ad(C){const te=Ed(C),le=ld.fromScaling(cf,[te,te,te]);return ld.translate(le,le,Zd.negate([],C.min))}function Sd(C){const te=ld.fromTranslation(cf,C.min),le=1/Ed(C);return ld.scale(te,te,[le,le,le])}function Id(C){const te=Mn/(2*Math.PI);return C/(2*Math.PI)/te}function Cd(C,te){return Mn/(512*Math.pow(2,C))*Ed(fd(te))}function zd(C,te,le,ce,he){const ue=Id(le),de=[C,te,-le/(2*Math.PI)],_e=ld.identity(new Float64Array(16));return ld.translate(_e,_e,de),ld.scale(_e,_e,[ue,ue,ue]),ld.rotateX(_e,_e,w(-he)),ld.rotateY(_e,_e,w(-ce)),_e}function Pd(C){const te=C.pixelsPerMeter,le=te/Qd(1,C.center.lat),ce=ld.identity(new Float64Array(16));return ld.translate(ce,ce,[C.point.x,C.point.y,0]),ld.scale(ce,ce,[le,le,te]),Float32Array.from(ce)}function Dd(C){return P(Up,Vp,C)}function Rd(C,te,le){const ce=ld.identity(new Float64Array(16)),he=(te/(1<<C)-.5)*Math.PI*2;return ld.rotateY(ce,le.globeMatrix,he),Float32Array.from(ce)}function Ld(C,te,le){const ce=Dd(le.zoom),he=C.style.map._antialias,ue=te.options.extStandardDerivativesForceOff||C.terrain&&C.terrain.exaggeration()>0;return 0===ce&&!he&&!ue}function kd(C,te,le,ce){const he=te.getNorth(),ue=te.getSouth(),de=te.getWest(),_e=te.getEast(),ye=1<<C.z,ve=_e-de,Se=he-ue,Me=ve/rf,Ae=-Se/nf[le],Ce=[0,Me,0,Ae,0,0,he,de,0];if(C.z>0){const C=180/ce;sd.multiply(Ce,Ce,[C/ve+1,0,0,0,C/Se+1,0,-.5*C/Me,.5*C/Ae,1])}return Ce[2]=ye,Ce[5]=C.x,Ce[8]=C.y,Ce}function Od(C){const te=Xf-5;C=z(C,-te,te)/te*90;const le=Math.pow(Math.abs(Math.sin(w(C))),3);return Math.round(le*(nf.length-1))}function Bd(C){const te=[0,0,0],le=ld.identity(new Float64Array(16));return ld.multiply(le,C.pixelMatrix,C.globeMatrix),Zd.transformMat4(te,te,le),new je(te[0],te[1])}function Fd(C,te){const le=wd(te.lat,te.lng),ce=function(C){const te=wd(C._center.lat,C._center.lng),le=Zd.fromValues(0,1,0);let ce=Zd.cross([],le,te);const he=ld.fromRotation([],-C.angle,te);ce=Zd.transformMat4(ce,ce,he),ld.fromRotation(he,-C._pitch,ce);const ue=Zd.normalize([],te);return Zd.scale(ue,ue,hd(C.cameraToCenterDistance/C.pixelsPerMeter)),Zd.transformMat4(ue,ue,he),Zd.add([],te,ue)}(C),he=Zd.subtract([],ce,le);return Zd.angle(he,le)}function Nd(C,te){return Fd(C,te)>Math.PI/2*1.01}const hf=w(85),Bf=Math.cos(hf),Gf=Math.sin(hf);class Gd{constructor(C){this._createGrid(C),this._createPoles(C)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const C of this._poleSegments)C.destroy();for(const C of this._gridSegments)C.withSkirts.destroy(),C.withoutSkirts.destroy()}_fillGridMeshWithLods(C,te){const le=new za,ce=new Wa,he=[],ue=C+1+2,de=te[0]+1,_e=te[0]+1+(1+te.length),l=(C,te,le)=>{let ce=C===ue-1?C-2:0===C?C:C-1;return ce+=le?24575:0,[ce,te]};for(let C=0;C<ue;++C)le.emplaceBack(...l(C,0,!0));for(let C=0;C<de;++C)for(let te=0;te<ue;++te)le.emplaceBack(...l(te,C,(0===te||te===ue-1)&&!0));for(let C=0;C<te.length;++C){const ce=te[C];for(let C=0;C<ue;++C)le.emplaceBack(...l(C,ce,!0))}for(let C=0;C<te.length;++C){const de=ce.length,ye=te[C]+1+2,ve=new Wa;for(let le=0;le<ye-1;le++){const he=le===ye-2,de=he?ue*(_e-te.length+C-le):ue;for(let C=0;C<ue-1;C++){const te=le*ue+C;0===le||he||0===C||C===ue-2?(ve.emplaceBack(te+1,te,te+de),ve.emplaceBack(te+de,te+de+1,te+1)):(ce.emplaceBack(te+1,te,te+de),ce.emplaceBack(te+de,te+de+1,te+1))}}const Se=xl.simpleSegment(0,de,le.length,ce.length-de);for(let C=0;C<ve.uint16.length;C+=3)ce.emplaceBack(ve.uint16[C],ve.uint16[C+1],ve.uint16[C+2]);const Me=xl.simpleSegment(0,de,le.length,ce.length-de);he.push({withoutSkirts:Se,withSkirts:Me})}return{vertices:le,indices:ce,segments:he}}_createGrid(C){const te=this._fillGridMeshWithLods(rf,nf);this._gridSegments=te.segments,this._gridBuffer=C.createVertexBuffer(te.vertices,rp.members),this._gridIndexBuffer=C.createIndexBuffer(te.indices,!0)}_createPoles(C){const te=new Wa;for(let C=0;C<=rf;C++)te.emplaceBack(0,C+1,C+2);this._poleIndexBuffer=C.createIndexBuffer(te,!0);const le=new Ka,ce=new Ka,he=new Ka,ue=new Ka;this._poleSegments=[];for(let C=0,te=0;C<Up;C++){const de=360/(1<<C);le.emplaceBack(0,-$p,0,.5,0),ce.emplaceBack(0,-$p,0,.5,1),he.emplaceBack(0,-$p,0,.5,.5),ue.emplaceBack(0,-$p,0,.5,.5);for(let C=0;C<=rf;C++){let te=C/rf,_e=0;const ye=Kr(0,de,te),[ve,Se,Me]=bd(Bf,Gf,ye,$p);le.emplaceBack(ve,Se,Me,te,_e),ce.emplaceBack(ve,Se,Me,te,1-_e);const Ae=w(ye);te=.5+.5*Math.sin(Ae),_e=.5+.5*Math.cos(Ae),he.emplaceBack(ve,Se,Me,te,_e),ue.emplaceBack(ve,Se,Me,te,1-_e)}this._poleSegments.push(xl.simpleSegment(te,0,66,64)),te+=66}this._poleNorthVertexBuffer=C.createVertexBuffer(le,Wd,!1),this._poleSouthVertexBuffer=C.createVertexBuffer(ce,Wd,!1),this._texturedPoleNorthVertexBuffer=C.createVertexBuffer(he,Wd,!1),this._texturedPoleSouthVertexBuffer=C.createVertexBuffer(ue,Wd,!1)}getGridBuffers(C,te){return[this._gridBuffer,this._gridIndexBuffer,te?this._gridSegments[C].withSkirts:this._gridSegments[C].withoutSkirts]}getPoleBuffers(C,te){return[te?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,te?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[C]]}}const Zf=6371008.8,qf=2*Math.PI*Zf;class $d{constructor(C,te){if(isNaN(C)||isNaN(te))throw new Error(`Invalid LngLat object: (${C}, ${te})`);if(this.lng=+C,this.lat=+te,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new $d(D(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(C){const te=Math.PI/180,le=this.lat*te,ce=C.lat*te,he=Math.sin(le)*Math.sin(ce)+Math.cos(le)*Math.cos(ce)*Math.cos((C.lng-this.lng)*te);return Zf*Math.acos(Math.min(he,1))}toBounds(C=0){const te=360*C/40075017,le=te/Math.cos(Math.PI/180*this.lat);return new sc(new $d(this.lng-le,this.lat-te),new $d(this.lng+le,this.lat+te))}toEcef(C){const te=hd(C);return wd(this.lat,this.lng,$p+te)}static convert(C){if(C instanceof $d)return C;if(Array.isArray(C)&&(2===C.length||3===C.length))return new $d(Number(C[0]),Number(C[1]));if(!Array.isArray(C)&&"object"==typeof C&&null!==C)return new $d(Number("lng"in C?C.lng:C.lon),Number(C.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}var $f=$d;const Hf=0,Wf=25.5;function Yd(C){return qf*Math.cos(C*Math.PI/180)}function Kd(C){return(180+C)/360}function Jd(C){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+C*Math.PI/360)))/360}function Qd(C,te){return C/Yd(te)}function ep(C){return 360*C-180}function tp(C){return 360/Math.PI*Math.atan(Math.exp((180-360*C)*Math.PI/180))-90}function ip(C,te){return C*Yd(tp(te))}const Xf=85.051129;function np(C){return Math.cos(w(z(C,-Xf,Xf)))}function op(C,te){const le=z(te,Hf,Wf),ce=Math.pow(2,le);return np(C)*qf/(512*ce)}function sp(C){return 1/Math.cos(C*Math.PI/180)}function ap(C,te=0){const le=Math.exp(Math.PI*(1-(C.y+te/Mn)/(1<<C.z)*2));return 80150034*le/(le*le+1)/Mn/(1<<C.z)}class lp{constructor(C,te,le=0){this.x=+C,this.y=+te,this.z=+le}static fromLngLat(C,te=0){const le=$f.convert(C);return new lp(Kd(le.lng),Jd(le.lat),Qd(te,le.lat))}toLngLat(){return new $f(ep(this.x),tp(this.y))}toAltitude(){return ip(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/qf*sp(tp(this.y))}}function cp(C,te,le,ce,he,ue,de,_e,ye){const ve=(te+ce)/2,Se=(le+he)/2,Me=new je(ve,Se);_e(Me),function(C,te,le,ce,he,ue){const de=le-he,_e=ce-ue;return Math.abs((ce-te)*de-(le-C)*_e)/Math.hypot(de,_e)}(Me.x,Me.y,ue.x,ue.y,de.x,de.y)>=ye?(cp(C,te,le,ve,Se,ue,Me,_e,ye),cp(C,ve,Se,ce,he,Me,de,_e,ye)):C.push(de)}function hp(C,te,le){let ce=C[0],he=ce.x,ue=ce.y;te(ce);const de=[ce];for(let _e=1;_e<C.length;_e++){const ye=C[_e],{x:ve,y:Se}=ye;te(ye),cp(de,he,ue,ve,Se,ce,ye,te,le),he=ve,ue=Se,ce=ye}return de}function up(C,te,le,ce){if(ce(te,le)){const he=te.add(le)._mult(.5);up(C,te,he,ce),up(C,he,le,ce)}else C.push(le)}function dp(C,te){let le=C[0];const ce=[le];for(let he=1;he<C.length;he++){const ue=C[he];up(ce,le,ue,te),le=ue}return ce}const Kf=Math.pow(2,14)-1,Yf=-Kf-1;function mp(C,te){const le=Math.round(C.x*te),ce=Math.round(C.y*te);return C.x=z(le,Yf,Kf),C.y=z(ce,Yf,Kf),(le<C.x||le>C.x+1||ce<C.y||ce>C.y+1)&&H("Geometry exceeds allowed extent, reduce your vector tile buffer size"),C}function _p(C,te,le){const ce=C.loadGeometry(),he=C.extent,ue=Mn/he;if(te&&le&&le.projection.isReprojectedInTileSpace){const ue=1<<te.z,{scale:de,x:_e,y:ye,projection:ve}=le,h=C=>{const le=ep((te.x+C.x/he)/ue),ce=tp((te.y+C.y/he)/ue),Se=ve.project(le,ce);C.x=(Se.x*de-_e)*he,C.y=(Se.y*de-ye)*he};for(let te=0;te<ce.length;te++)if(1!==C.type)ce[te]=hp(ce[te],h,1);else{const C=[];for(const le of ce[te])le.x<0||le.x>=he||le.y<0||le.y>=he||(h(le),C.push(le));ce[te]=C}}for(const C of ce)for(const te of C)mp(te,ue);return ce}function gp(C,te){return{type:C.type,id:C.id,properties:C.properties,geometry:te?_p(C):[]}}function yp(C,te,le,ce,he){C.emplaceBack(2*te+(ce+1)/2,2*le+(he+1)/2)}function xp(C,te,le){const ce=16384;C.emplaceBack(te.x,te.y,te.z,le[0]*ce,le[1]*ce,le[2]*ce)}class vp{constructor(C){this.zoom=C.zoom,this.overscaling=C.overscaling,this.layers=C.layers,this.layerIds=this.layers.map((C=>C.fqid)),this.index=C.index,this.hasPattern=!1,this.projection=C.projection,this.layoutVertexArray=new za,this.indexArray=new Wa,this.segments=new xl,this.programConfigurations=new ec(C.layers,C.zoom),this.stateDependentLayerIds=this.layers.filter((C=>C.isStateDependent())).map((C=>C.id))}populate(C,te,le,ce){const he=this.layers[0],ue=[];let de=null;"circle"===he.type&&(de=he.layout.get("circle-sort-key"));for(const{feature:te,id:he,index:_e,sourceLayerIndex:ye}of C){const C=this.layers[0]._featureFilter.needGeometry,ve=gp(te,C);if(!this.layers[0]._featureFilter.filter(new oa(this.zoom),ve,le))continue;const Se=de?de.evaluate(ve,{},le):void 0,Me={id:he,properties:te.properties,type:te.type,sourceLayerIndex:ye,index:_e,geometry:C?ve.geometry:_p(te,le,ce),patterns:{},sortKey:Se};ue.push(Me)}de&&ue.sort(((C,te)=>C.sortKey-te.sortKey));let _e=null;"globe"===ce.projection.name&&(this.globeExtVertexArray=new Fa,_e=ce.projection);for(const ce of ue){const{geometry:he,index:ue,sourceLayerIndex:de}=ce,ye=C[ue].feature;this.addFeature(ce,he,ue,te.availableImages,le,_e,te.brightness),te.featureIndex.insert(ye,he,ue,de,this.index)}}update(C,te,le,ce,he){const ue=0!==Object.keys(C).length;ue&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(C,te,ue?this.stateDependentLayers:this.layers,le,ce,he)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(C){this.uploaded||(this.layoutVertexBuffer=C.createVertexBuffer(this.layoutVertexArray,dc.members),this.indexBuffer=C.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=C.createVertexBuffer(this.globeExtVertexArray,pc.members))),this.programConfigurations.upload(C),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(C,te,le,ce,he,ue,de){for(const le of te)for(const te of le){const le=te.x,ce=te.y;if(le<0||le>=Mn||ce<0||ce>=Mn)continue;if(ue){const C=ue.projectTilePoint(le,ce,he),te=ue.upVector(he,le,ce),de=this.globeExtVertexArray;xp(de,C,te),xp(de,C,te),xp(de,C,te),xp(de,C,te)}const de=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,C.sortKey),_e=de.vertexLength;yp(this.layoutVertexArray,le,ce,-1,-1),yp(this.layoutVertexArray,le,ce,1,-1),yp(this.layoutVertexArray,le,ce,1,1),yp(this.layoutVertexArray,le,ce,-1,1),this.indexArray.emplaceBack(_e,_e+1,_e+2),this.indexArray.emplaceBack(_e,_e+2,_e+3),de.vertexLength+=4,de.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,C,le,{},ce,he,de)}}function bp(C,te){for(let le=0;le<C.length;le++)if(zp(te,C[le]))return!0;for(let le=0;le<te.length;le++)if(zp(C,te[le]))return!0;return!!Mp(C,te)}function wp(C,te,le){return!!zp(C,te)||!!Sp(te,C,le)}function Tp(C,te){if(1===C.length)return Cp(te,C[0]);for(let le=0;le<te.length;le++){const ce=te[le];for(let te=0;te<ce.length;te++)if(zp(C,ce[te]))return!0}for(let le=0;le<C.length;le++)if(Cp(te,C[le]))return!0;for(let le=0;le<te.length;le++)if(Mp(C,te[le]))return!0;return!1}function Ep(C,te,le){if(C.length>1){if(Mp(C,te))return!0;for(let ce=0;ce<te.length;ce++)if(Sp(te[ce],C,le))return!0}for(let ce=0;ce<C.length;ce++)if(Sp(C[ce],te,le))return!0;return!1}function Mp(C,te){if(0===C.length||0===te.length)return!1;for(let le=0;le<C.length-1;le++){const ce=C[le],he=C[le+1];for(let C=0;C<te.length-1;C++)if(Ap(ce,he,te[C],te[C+1]))return!0}return!1}function Ap(C,te,le,ce){return X(C,le,ce)!==X(te,le,ce)&&X(C,te,le)!==X(C,te,ce)}function Sp(C,te,le){const ce=le*le;if(1===te.length)return C.distSqr(te[0])<ce;for(let le=1;le<te.length;le++)if(Ip(C,te[le-1],te[le])<ce)return!0;return!1}function Ip(C,te,le){const ce=te.distSqr(le);if(0===ce)return C.distSqr(te);const he=((C.x-te.x)*(le.x-te.x)+(C.y-te.y)*(le.y-te.y))/ce;return C.distSqr(he<0?te:he>1?le:le.sub(te)._mult(he)._add(te))}function Cp(C,te){let le,ce,he,ue=!1;for(let de=0;de<C.length;de++){le=C[de];for(let C=0,de=le.length-1;C<le.length;de=C++)ce=le[C],he=le[de],ce.y>te.y!=he.y>te.y&&te.x<(he.x-ce.x)*(te.y-ce.y)/(he.y-ce.y)+ce.x&&(ue=!ue)}return ue}function zp(C,te){let le=!1;for(let ce=0,he=C.length-1;ce<C.length;he=ce++){const ue=C[ce],de=C[he];ue.y>te.y!=de.y>te.y&&te.x<(de.x-ue.x)*(te.y-ue.y)/(de.y-ue.y)+ue.x&&(le=!le)}return le}function Pp(C,te,le,ce,he){for(const ue of C)if(te<=ue.x&&le<=ue.y&&ce>=ue.x&&he>=ue.y)return!0;const ue=[new je(te,le),new je(te,he),new je(ce,he),new je(ce,le)];if(C.length>2)for(const te of ue)if(zp(C,te))return!0;for(let te=0;te<C.length-1;te++)if(Dp(C[te],C[te+1],ue))return!0;return!1}function Dp(C,te,le){const ce=le[0],he=le[2];if(C.x<ce.x&&te.x<ce.x||C.x>he.x&&te.x>he.x||C.y<ce.y&&te.y<ce.y||C.y>he.y&&te.y>he.y)return!1;const ue=X(C,te,le[0]);return ue!==X(C,te,le[1])||ue!==X(C,te,le[2])||ue!==X(C,te,le[3])}function Rp(C,te,le,ce,he,ue){let de=te.y-C.y,_e=C.x-te.x;if(ue=ue||0){const C=de*de+_e*_e;if(0===C)return!0;const te=Math.sqrt(C);de/=te,_e/=te}return!((le.x-C.x)*de+(le.y-C.y)*_e-ue<0||(ce.x-C.x)*de+(ce.y-C.y)*_e-ue<0||(he.x-C.x)*de+(he.y-C.y)*_e-ue<0)}function Lp(C,te,le,ce,he,ue,de){return!(Rp(C,te,ce,he,ue,de)||Rp(te,le,ce,he,ue,de)||Rp(le,C,ce,he,ue,de)||Rp(ce,he,C,te,le,de)||Rp(he,ue,C,te,le,de)||Rp(ue,ce,C,te,le,de))}function kp(C,te,le){const ce=te.paint.get(C).value;return"constant"===ce.kind?ce.value:le.programConfigurations.get(te.id).getMaxValue(C)}function Op(C){return Math.sqrt(C[0]*C[0]+C[1]*C[1])}function Bp(C,te,le,ce,he){if(!te[0]&&!te[1])return C;const ue=je.convert(te)._mult(he);"viewport"===le&&ue._rotate(-ce);const de=[];for(let te=0;te<C.length;te++)de.push(C[te].sub(ue));return de}function Fp(C,te,le,ce){const he=je.convert(C)._mult(ce);return"viewport"===te&&he._rotate(-le),he}Rs(vp,"CircleBucket",{omit:["layers"]});const Jf=new ga({"circle-sort-key":new ma(zi.layout_circle["circle-sort-key"]),visibility:new fa(zi.layout_circle.visibility)});var Qf={paint:new ga({"circle-radius":new ma(zi.paint_circle["circle-radius"]),"circle-color":new ma(zi.paint_circle["circle-color"]),"circle-blur":new ma(zi.paint_circle["circle-blur"]),"circle-opacity":new ma(zi.paint_circle["circle-opacity"]),"circle-translate":new fa(zi.paint_circle["circle-translate"]),"circle-translate-anchor":new fa(zi.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new fa(zi.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new fa(zi.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new ma(zi.paint_circle["circle-stroke-width"]),"circle-stroke-color":new ma(zi.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new ma(zi.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new fa(zi.paint_circle["circle-emissive-strength"])}),layout:Jf};const rm=ld.create(),jp=(C,te,le,ce,he,ue)=>{const de=C.transform,_e="globe"===de.projection.name;let ye;if("map"===ue.paint.get("circle-pitch-alignment"))if(_e){const C=Cd(de.zoom,te.canonical)*de._pixelsPerMercatorPixel;ye=Float32Array.from([C,0,0,C])}else ye=de.calculatePixelsToTileUnitsMatrix(le);else ye=new Float32Array([de.pixelsToGLUnits[0],0,0,de.pixelsToGLUnits[1]]);const ve={u_camera_to_center_distance:C.transform.getCameraToCenterDistance(de.projection),u_matrix:C.translatePosMatrix(te.projMatrix,le,ue.paint.get("circle-translate"),ue.paint.get("circle-translate-anchor")),u_device_pixel_ratio:bi.devicePixelRatio,u_extrude_scale:ye,u_inv_rot_matrix:rm,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:ue.paint.get("circle-emissive-strength")};if(_e){ve.u_inv_rot_matrix=ce,ve.u_merc_center=he,ve.u_tile_id=[te.canonical.x,te.canonical.y,1<<te.canonical.z],ve.u_zoom_transition=Dd(de.zoom);const C=he[0]*Mn,le=he[1]*Mn;ve.u_up_dir=de.projection.upVector(new ju(0,0,0),C,le)}return ve},Gp=C=>{const te=[];return"map"===C.paint.get("circle-pitch-alignment")&&te.push("PITCH_WITH_MAP"),"map"===C.paint.get("circle-pitch-scale")&&te.push("SCALE_WITH_MAP"),te};function qp(C,te,le,ce,he,ue,de,_e,ye){if(ue&&C.queryGeometry.isAboveHorizon)return!1;ue&&(ye*=C.pixelToTileUnitsFactor);const ve=C.tileID.canonical,Se=le.projection.upVectorScale(ve,le.center.lat,le.worldSize).metersToTile;for(const Me of te)for(const te of Me){const Me=te.add(_e),Ae=he&&le.elevation?le.elevation.exaggeration()*he.getElevationAt(Me.x,Me.y,!0):0,Ce=le.projection.projectTilePoint(Me.x,Me.y,ve);if(Ae>0){const C=le.projection.upVector(ve,Me.x,Me.y);Ce.x+=C[0]*Se*Ae,Ce.y+=C[1]*Se*Ae,Ce.z+=C[2]*Se*Ae}const Oe=ue?Me:Zp(Ce.x,Ce.y,Ce.z,ce),Ne=ue?C.tilespaceRays.map((C=>Hp(C,Ae))):C.queryGeometry.screenGeometry,je=$u.transformMat4([],[Ce.x,Ce.y,Ce.z,1],ce);if(!de&&ue?ye*=je[3]/le.cameraToCenterDistance:de&&!ue&&(ye*=le.cameraToCenterDistance/je[3]),ue){const C=tp((te.y/Mn+ve.y)/(1<<ve.z));ye/=le.projection.pixelsPerMeter(C,1)/Qd(1,C)}if(wp(Ne,Oe,ye))return!0}return!1}function Zp(C,te,le,ce){const he=$u.transformMat4([],[C,te,le,1],ce);return new je(he[0]/he[3],he[1]/he[3])}const nm=Zd.fromValues(0,0,0),am=Zd.fromValues(0,0,1);function Hp(C,te){const le=Zd.create();return nm[2]=te,C.intersectsPlane(nm,am,le),new je(le[0],le[1])}class Xp extends vp{}function Yp(C,{width:te,height:le},ce,he){if(he){if(he instanceof Uint8ClampedArray)he=new Uint8Array(he.buffer);else if(he.length!==te*le*ce)throw new RangeError("mismatched image size")}else he=new Uint8Array(te*le*ce);return C.width=te,C.height=le,C.data=he,C}function Kp(C,te,le){const{width:ce,height:he}=te;ce===C.width&&he===C.height||(Jp(C,te,{x:0,y:0},{x:0,y:0},{width:Math.min(C.width,ce),height:Math.min(C.height,he)},le),C.width=ce,C.height=he,C.data=te.data)}function Jp(C,te,le,ce,he,ue){if(0===he.width||0===he.height)return te;if(he.width>C.width||he.height>C.height||le.x>C.width-he.width||le.y>C.height-he.height)throw new RangeError("out of range source coordinates for image copy");if(he.width>te.width||he.height>te.height||ce.x>te.width-he.width||ce.y>te.height-he.height)throw new RangeError("out of range destination coordinates for image copy");const de=C.data,_e=te.data;for(let ye=0;ye<he.height;ye++){const ve=((le.y+ye)*C.width+le.x)*ue,Se=((ce.y+ye)*te.width+ce.x)*ue;for(let C=0;C<he.width*ue;C++)_e[Se+C]=de[ve+C]}return te}Rs(Xp,"HeatmapBucket",{omit:["layers"]});class Qp{constructor(C,te){Yp(this,C,1,te)}resize(C){Kp(this,new Qp(C),1)}clone(){return new Qp({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(C,te,le,ce,he){Jp(C,te,le,ce,he,1)}}class ef{constructor(C,te){Yp(this,C,4,te)}resize(C){Kp(this,new ef(C),4)}replace(C,te){te?this.data.set(C):this.data=C instanceof Uint8ClampedArray?new Uint8Array(C.buffer):C}clone(){return new ef({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(C,te,le,ce,he){Jp(C,te,le,ce,he,4)}}class tf{constructor(C,te){this.width=C.width,this.height=C.height,this.data=te instanceof Uint8Array?new Float32Array(te.buffer):te}}Rs(Qp,"AlphaImage"),Rs(ef,"RGBAImage");const cm=new ga({visibility:new fa(zi.layout_heatmap.visibility)});var hm={paint:new ga({"heatmap-radius":new ma(zi.paint_heatmap["heatmap-radius"]),"heatmap-weight":new ma(zi.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new fa(zi.paint_heatmap["heatmap-intensity"]),"heatmap-color":new _a(zi.paint_heatmap["heatmap-color"]),"heatmap-opacity":new fa(zi.paint_heatmap["heatmap-opacity"])}),layout:cm};function of(C){const te={},le=C.resolution||256,ce=C.clips?C.clips.length:1,he=C.image||new ef({width:le,height:ce}),o=(le,ce,ue)=>{te[C.evaluationKey]=ue;const de=C.expression.evaluate(te);de&&(he.data[le+ce+0]=Math.floor(255*de.r/de.a),he.data[le+ce+1]=Math.floor(255*de.g/de.a),he.data[le+ce+2]=Math.floor(255*de.b/de.a),he.data[le+ce+3]=Math.floor(255*de.a))};if(C.clips)for(let te=0,he=0;te<ce;++te,he+=4*le)for(let ce=0,ue=0;ce<le;ce++,ue+=4){const de=ce/(le-1),{start:_e,end:ye}=C.clips[te];o(he,ue,_e*(1-de)+ye*de)}else for(let C=0,te=0;C<le;C++,te+=4)o(0,te,C/(le-1));return he}const pm=new ga({visibility:new fa(zi.layout_hillshade.visibility)});var fm={paint:new ga({"hillshade-illumination-direction":new fa(zi.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new fa(zi.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new fa(zi.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new fa(zi.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new fa(zi.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new fa(zi.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new fa(zi.paint_hillshade["hillshade-emissive-strength"])}),layout:pm};const mm=Ia([{name:"a_pos",components:2,type:"Int16"}],4),{members:gm}=mm;var ym={exports:{}};function uf(C,te,le){le=le||2;var ce,he,ue,de,_e,ye,ve,Se=te&&te.length,Me=Se?te[0]*le:C.length,Ae=df(C,0,Me,le,!0),Ce=[];if(!Ae||Ae.next===Ae.prev)return Ce;if(Se&&(Ae=function(C,te,le,ce){var he,ue,de,_e=[];for(he=0,ue=te.length;he<ue;he++)(de=df(C,te[he]*ce,he<ue-1?te[he+1]*ce:C.length,ce,!1))===de.next&&(de.steiner=!0),_e.push(Tf(de));for(_e.sort(xf),he=0;he<_e.length;he++)le=vf(_e[he],le);return le}(C,te,Ae,le)),C.length>80*le){ce=ue=C[0],he=de=C[1];for(var Oe=le;Oe<Me;Oe+=le)(_e=C[Oe])<ce&&(ce=_e),(ye=C[Oe+1])<he&&(he=ye),_e>ue&&(ue=_e),ye>de&&(de=ye);ve=0!==(ve=Math.max(ue-ce,de-he))?32767/ve:0}return ff(Ae,Ce,le,ce,he,ve,0),Ce}function df(C,te,le,ce,he){var ue,de;if(he===Of(C,te,le,ce)>0)for(ue=te;ue<le;ue+=ce)de=Rf(ue,C[ue],C[ue+1],de);else for(ue=le-ce;ue>=te;ue-=ce)de=Rf(ue,C[ue],C[ue+1],de);return de&&Sf(de,de.next)&&(Lf(de),de=de.next),de}function pf(C,te){if(!C)return C;te||(te=C);var le,ce=C;do{if(le=!1,ce.steiner||!Sf(ce,ce.next)&&0!==Af(ce.prev,ce,ce.next))ce=ce.next;else{if(Lf(ce),(ce=te=ce.prev)===ce.next)break;le=!0}}while(le||ce!==te);return te}function ff(C,te,le,ce,he,ue,de){if(C){!de&&ue&&function(C,te,le,ce){var he=C;do{0===he.z&&(he.z=wf(he.x,he.y,te,le,ce)),he.prevZ=he.prev,he.nextZ=he.next,he=he.next}while(he!==C);he.prevZ.nextZ=null,he.prevZ=null,function(C){var te,le,ce,he,ue,de,_e,ye,ve=1;do{for(le=C,C=null,ue=null,de=0;le;){for(de++,ce=le,_e=0,te=0;te<ve&&(_e++,ce=ce.nextZ);te++);for(ye=ve;_e>0||ye>0&&ce;)0!==_e&&(0===ye||!ce||le.z<=ce.z)?(he=le,le=le.nextZ,_e--):(he=ce,ce=ce.nextZ,ye--),ue?ue.nextZ=he:C=he,he.prevZ=ue,ue=he;le=ce}ue.nextZ=null,ve*=2}while(de>1)}(he)}(C,ce,he,ue);for(var _e,ye,ve=C;C.prev!==C.next;)if(_e=C.prev,ye=C.next,ue?_f(C,ce,he,ue):mf(C))te.push(_e.i/le|0),te.push(C.i/le|0),te.push(ye.i/le|0),Lf(C),C=ye.next,ve=ye.next;else if((C=ye)===ve){de?1===de?ff(C=gf(pf(C),te,le),te,le,ce,he,ue,2):2===de&&yf(C,te,le,ce,he,ue):ff(pf(C),te,le,ce,he,ue,1);break}}}function mf(C){var te=C.prev,le=C,ce=C.next;if(Af(te,le,ce)>=0)return!1;for(var he=te.x,ue=le.x,de=ce.x,_e=te.y,ye=le.y,ve=ce.y,Se=he<ue?he<de?he:de:ue<de?ue:de,Me=_e<ye?_e<ve?_e:ve:ye<ve?ye:ve,Ae=he>ue?he>de?he:de:ue>de?ue:de,Ce=_e>ye?_e>ve?_e:ve:ye>ve?ye:ve,Oe=ce.next;Oe!==te;){if(Oe.x>=Se&&Oe.x<=Ae&&Oe.y>=Me&&Oe.y<=Ce&&Ef(he,_e,ue,ye,de,ve,Oe.x,Oe.y)&&Af(Oe.prev,Oe,Oe.next)>=0)return!1;Oe=Oe.next}return!0}function _f(C,te,le,ce){var he=C.prev,ue=C,de=C.next;if(Af(he,ue,de)>=0)return!1;for(var _e=he.x,ye=ue.x,ve=de.x,Se=he.y,Me=ue.y,Ae=de.y,Ce=_e<ye?_e<ve?_e:ve:ye<ve?ye:ve,Oe=Se<Me?Se<Ae?Se:Ae:Me<Ae?Me:Ae,Ne=_e>ye?_e>ve?_e:ve:ye>ve?ye:ve,je=Se>Me?Se>Ae?Se:Ae:Me>Ae?Me:Ae,Ge=wf(Ce,Oe,te,le,ce),Ze=wf(Ne,je,te,le,ce),qe=C.prevZ,$e=C.nextZ;qe&&qe.z>=Ge&&$e&&$e.z<=Ze;){if(qe.x>=Ce&&qe.x<=Ne&&qe.y>=Oe&&qe.y<=je&&qe!==he&&qe!==de&&Ef(_e,Se,ye,Me,ve,Ae,qe.x,qe.y)&&Af(qe.prev,qe,qe.next)>=0)return!1;if(qe=qe.prevZ,$e.x>=Ce&&$e.x<=Ne&&$e.y>=Oe&&$e.y<=je&&$e!==he&&$e!==de&&Ef(_e,Se,ye,Me,ve,Ae,$e.x,$e.y)&&Af($e.prev,$e,$e.next)>=0)return!1;$e=$e.nextZ}for(;qe&&qe.z>=Ge;){if(qe.x>=Ce&&qe.x<=Ne&&qe.y>=Oe&&qe.y<=je&&qe!==he&&qe!==de&&Ef(_e,Se,ye,Me,ve,Ae,qe.x,qe.y)&&Af(qe.prev,qe,qe.next)>=0)return!1;qe=qe.prevZ}for(;$e&&$e.z<=Ze;){if($e.x>=Ce&&$e.x<=Ne&&$e.y>=Oe&&$e.y<=je&&$e!==he&&$e!==de&&Ef(_e,Se,ye,Me,ve,Ae,$e.x,$e.y)&&Af($e.prev,$e,$e.next)>=0)return!1;$e=$e.nextZ}return!0}function gf(C,te,le){var ce=C;do{var he=ce.prev,ue=ce.next.next;!Sf(he,ue)&&If(he,ce,ce.next,ue)&&Pf(he,ue)&&Pf(ue,he)&&(te.push(he.i/le|0),te.push(ce.i/le|0),te.push(ue.i/le|0),Lf(ce),Lf(ce.next),ce=C=ue),ce=ce.next}while(ce!==C);return pf(ce)}function yf(C,te,le,ce,he,ue){var de=C;do{for(var _e=de.next.next;_e!==de.prev;){if(de.i!==_e.i&&Mf(de,_e)){var ye=Df(de,_e);return de=pf(de,de.next),ye=pf(ye,ye.next),ff(de,te,le,ce,he,ue,0),void ff(ye,te,le,ce,he,ue,0)}_e=_e.next}de=de.next}while(de!==C)}function xf(C,te){return C.x-te.x}function vf(C,te){var le=function(C,te){var le,ce=te,he=C.x,ue=C.y,de=-1/0;do{if(ue<=ce.y&&ue>=ce.next.y&&ce.next.y!==ce.y){var _e=ce.x+(ue-ce.y)*(ce.next.x-ce.x)/(ce.next.y-ce.y);if(_e<=he&&_e>de&&(de=_e,le=ce.x<ce.next.x?ce:ce.next,_e===he))return le}ce=ce.next}while(ce!==te);if(!le)return null;var ye,ve=le,Se=le.x,Me=le.y,Ae=1/0;ce=le;do{he>=ce.x&&ce.x>=Se&&he!==ce.x&&Ef(ue<Me?he:de,ue,Se,Me,ue<Me?de:he,ue,ce.x,ce.y)&&(ye=Math.abs(ue-ce.y)/(he-ce.x),Pf(ce,C)&&(ye<Ae||ye===Ae&&(ce.x>le.x||ce.x===le.x&&bf(le,ce)))&&(le=ce,Ae=ye)),ce=ce.next}while(ce!==ve);return le}(C,te);if(!le)return te;var ce=Df(le,C);return pf(ce,ce.next),pf(le,le.next)}function bf(C,te){return Af(C.prev,C,te.prev)<0&&Af(te.next,C,C.next)<0}function wf(C,te,le,ce,he){return(C=1431655765&((C=858993459&((C=252645135&((C=16711935&((C=(C-le)*he|0)|C<<8))|C<<4))|C<<2))|C<<1))|(te=1431655765&((te=858993459&((te=252645135&((te=16711935&((te=(te-ce)*he|0)|te<<8))|te<<4))|te<<2))|te<<1))<<1}function Tf(C){var te=C,le=C;do{(te.x<le.x||te.x===le.x&&te.y<le.y)&&(le=te),te=te.next}while(te!==C);return le}function Ef(C,te,le,ce,he,ue,de,_e){return(he-de)*(te-_e)>=(C-de)*(ue-_e)&&(C-de)*(ce-_e)>=(le-de)*(te-_e)&&(le-de)*(ue-_e)>=(he-de)*(ce-_e)}function Mf(C,te){return C.next.i!==te.i&&C.prev.i!==te.i&&!function(C,te){var le=C;do{if(le.i!==C.i&&le.next.i!==C.i&&le.i!==te.i&&le.next.i!==te.i&&If(le,le.next,C,te))return!0;le=le.next}while(le!==C);return!1}(C,te)&&(Pf(C,te)&&Pf(te,C)&&function(C,te){var le=C,ce=!1,he=(C.x+te.x)/2,ue=(C.y+te.y)/2;do{le.y>ue!=le.next.y>ue&&le.next.y!==le.y&&he<(le.next.x-le.x)*(ue-le.y)/(le.next.y-le.y)+le.x&&(ce=!ce),le=le.next}while(le!==C);return ce}(C,te)&&(Af(C.prev,C,te.prev)||Af(C,te.prev,te))||Sf(C,te)&&Af(C.prev,C,C.next)>0&&Af(te.prev,te,te.next)>0)}function Af(C,te,le){return(te.y-C.y)*(le.x-te.x)-(te.x-C.x)*(le.y-te.y)}function Sf(C,te){return C.x===te.x&&C.y===te.y}function If(C,te,le,ce){var he=zf(Af(C,te,le)),ue=zf(Af(C,te,ce)),de=zf(Af(le,ce,C)),_e=zf(Af(le,ce,te));return he!==ue&&de!==_e||!(0!==he||!Cf(C,le,te))||!(0!==ue||!Cf(C,ce,te))||!(0!==de||!Cf(le,C,ce))||!(0!==_e||!Cf(le,te,ce))}function Cf(C,te,le){return te.x<=Math.max(C.x,le.x)&&te.x>=Math.min(C.x,le.x)&&te.y<=Math.max(C.y,le.y)&&te.y>=Math.min(C.y,le.y)}function zf(C){return C>0?1:C<0?-1:0}function Pf(C,te){return Af(C.prev,C,C.next)<0?Af(C,te,C.next)>=0&&Af(C,C.prev,te)>=0:Af(C,te,C.prev)<0||Af(C,C.next,te)<0}function Df(C,te){var le=new kf(C.i,C.x,C.y),ce=new kf(te.i,te.x,te.y),he=C.next,ue=te.prev;return C.next=te,te.prev=C,le.next=he,he.prev=le,ce.next=le,le.prev=ce,ue.next=ce,ce.prev=ue,ce}function Rf(C,te,le,ce){var he=new kf(C,te,le);return ce?(he.next=ce.next,he.prev=ce,ce.next.prev=he,ce.next=he):(he.prev=he,he.next=he),he}function Lf(C){C.next.prev=C.prev,C.prev.next=C.next,C.prevZ&&(C.prevZ.nextZ=C.nextZ),C.nextZ&&(C.nextZ.prevZ=C.prevZ)}function kf(C,le,ce){(this||te).i=C,(this||te).x=le,(this||te).y=ce,(this||te).prev=null,(this||te).next=null,(this||te).z=0,(this||te).prevZ=null,(this||te).nextZ=null,(this||te).steiner=!1}function Of(C,te,le,ce){for(var he=0,ue=te,de=le-ce;ue<le;ue+=ce)he+=(C[de]-C[ue])*(C[ue+1]+C[de+1]),de=ue;return he}ym.exports=uf,ym.exports.default=uf,uf.deviation=function(C,te,le,ce){var he=te&&te.length,ue=Math.abs(Of(C,0,he?te[0]*le:C.length,le));if(he)for(var de=0,_e=te.length;de<_e;de++)ue-=Math.abs(Of(C,te[de]*le,de<_e-1?te[de+1]*le:C.length,le));var ye=0;for(de=0;de<ce.length;de+=3){var ve=ce[de]*le,Se=ce[de+1]*le,Me=ce[de+2]*le;ye+=Math.abs((C[ve]-C[Me])*(C[Se+1]-C[ve+1])-(C[ve]-C[Se])*(C[Me+1]-C[ve+1]))}return 0===ue&&0===ye?0:Math.abs((ye-ue)/ue)},uf.flatten=function(C){for(var te=C[0][0].length,le={vertices:[],holes:[],dimensions:te},ce=0,he=0;he<C.length;he++){for(var ue=0;ue<C[he].length;ue++)for(var de=0;de<te;de++)le.vertices.push(C[he][ue][de]);he>0&&le.holes.push(ce+=C[he-1].length)}return le};var xm=d(ym.exports);function Ff(C,te){const le=C.length;if(le<=1)return[C];const ce=[];let he,ue;for(let te=0;te<le;te++){const le=Y(C[te]);0!==le&&(C[te].area=Math.abs(le),void 0===ue&&(ue=le<0),ue===le<0?(he&&ce.push(he),he=[C[te]]):he.push(C[te]))}if(he&&ce.push(he),te>1)for(let C=0;C<ce.length;C++)ce[C].length<=te||(ln(ce[C],te,1,ce[C].length-1,Nf),ce[C]=ce[C].slice(0,te));return ce}function Nf(C,te){return te.area-C.area}function Uf(C,te,le){const ce=le.patternDependencies;let he=!1;for(const le of te){const te=le.paint.get(`${C}-pattern`);te.isConstant()||(he=!0);const ue=te.constantOr(null);ue&&(he=!0,ce[ue]=!0)}return he}function Vf(C,te,le,ce,he){const ue=he.patternDependencies;for(const de of te){const te=de.paint.get(`${C}-pattern`).value;if("constant"!==te.kind){let C=te.evaluate({zoom:ce},le,{},he.availableImages);C=C&&C.name?C.name:C,ue[C]=!0,le.patterns[de.id]=C}}return le}class jf{constructor(C){this.zoom=C.zoom,this.overscaling=C.overscaling,this.layers=C.layers,this.layerIds=this.layers.map((C=>C.fqid)),this.index=C.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new za,this.indexArray=new Wa,this.indexArray2=new ja,this.programConfigurations=new ec(C.layers,C.zoom),this.segments=new xl,this.segments2=new xl,this.stateDependentLayerIds=this.layers.filter((C=>C.isStateDependent())).map((C=>C.id)),this.projection=C.projection}populate(C,te,le,ce){this.hasPattern=Uf("fill",this.layers,te);const he=this.layers[0].layout.get("fill-sort-key"),ue=[];for(const{feature:de,id:_e,index:ye,sourceLayerIndex:ve}of C){const C=this.layers[0]._featureFilter.needGeometry,Se=gp(de,C);if(!this.layers[0]._featureFilter.filter(new oa(this.zoom),Se,le))continue;const Me=he?he.evaluate(Se,{},le,te.availableImages):void 0,Ae={id:_e,properties:de.properties,type:de.type,sourceLayerIndex:ve,index:ye,geometry:C?Se.geometry:_p(de,le,ce),patterns:{},sortKey:Me};ue.push(Ae)}he&&ue.sort(((C,te)=>C.sortKey-te.sortKey));for(const ce of ue){const{geometry:he,index:ue,sourceLayerIndex:de}=ce;if(this.hasPattern){const C=Vf("fill",this.layers,ce,this.zoom,te);this.patternFeatures.push(C)}else this.addFeature(ce,he,ue,le,{},te.availableImages,te.brightness);te.featureIndex.insert(C[ue].feature,he,ue,de,this.index)}}update(C,te,le,ce,he){const ue=0!==Object.keys(C).length;ue&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(C,te,ue?this.stateDependentLayers:this.layers,le,ce,he)}addFeatures(C,te,le,ce,he,ue){for(const C of this.patternFeatures)this.addFeature(C,C.geometry,C.index,te,le,ce,ue)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(C){this.uploaded||(this.layoutVertexBuffer=C.createVertexBuffer(this.layoutVertexArray,gm),this.indexBuffer=C.createIndexBuffer(this.indexArray),this.indexBuffer2=C.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(C),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(C,te,le,ce,he,ue=[],de){for(const C of Ff(te,500)){let te=0;for(const le of C)te+=le.length;const le=this.segments.prepareSegment(te,this.layoutVertexArray,this.indexArray),ce=le.vertexLength,he=[],ue=[];for(const te of C){if(0===te.length)continue;te!==C[0]&&ue.push(he.length/2);const le=this.segments2.prepareSegment(te.length,this.layoutVertexArray,this.indexArray2),ce=le.vertexLength;this.layoutVertexArray.emplaceBack(te[0].x,te[0].y),this.indexArray2.emplaceBack(ce+te.length-1,ce),he.push(te[0].x),he.push(te[0].y);for(let C=1;C<te.length;C++)this.layoutVertexArray.emplaceBack(te[C].x,te[C].y),this.indexArray2.emplaceBack(ce+C-1,ce+C),he.push(te[C].x),he.push(te[C].y);le.vertexLength+=te.length,le.primitiveLength+=te.length}const de=xm(he,ue);for(let C=0;C<de.length;C+=3)this.indexArray.emplaceBack(ce+de[C],ce+de[C+1],ce+de[C+2]);le.vertexLength+=te,le.primitiveLength+=de.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,C,le,he,ue,ce,de)}}Rs(jf,"FillBucket",{omit:["layers","patternFeatures"]});const km=new ga({"fill-sort-key":new ma(zi.layout_fill["fill-sort-key"]),visibility:new fa(zi.layout_fill.visibility)});var Om={paint:new ga({"fill-antialias":new fa(zi.paint_fill["fill-antialias"]),"fill-opacity":new ma(zi.paint_fill["fill-opacity"]),"fill-color":new ma(zi.paint_fill["fill-color"]),"fill-outline-color":new ma(zi.paint_fill["fill-outline-color"]),"fill-translate":new fa(zi.paint_fill["fill-translate"]),"fill-translate-anchor":new fa(zi.paint_fill["fill-translate-anchor"]),"fill-pattern":new ma(zi.paint_fill["fill-pattern"]),"fill-emissive-strength":new fa(zi.paint_fill["fill-emissive-strength"])}),layout:km};const Wm=Ia([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),i_=Ia([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),r_=Ia([{name:"a_centroid_pos",components:2,type:"Uint16"}]),n_=Ia([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),o_=Ia([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:s_}=Wm;var a_={},l_=Ne,c_=em;function em(C,le,ce,he,ue){(this||te).properties={},(this||te).extent=ce,(this||te).type=0,(this||te)._pbf=C,(this||te)._geometry=-1,(this||te)._keys=he,(this||te)._values=ue,C.readFields(tm,this||te,le)}function tm(C,te,le){1==C?te.id=le.readVarint():2==C?function(C,te){for(var le=C.readVarint()+C.pos;C.pos<le;){var ce=te._keys[C.readVarint()],he=te._values[C.readVarint()];te.properties[ce]=he}}(le,te):3==C?te.type=le.readVarint():4==C&&(te._geometry=le.pos)}function im(C){for(var te,le,ce=0,he=0,ue=C.length,de=ue-1;he<ue;de=he++)ce+=((le=C[de]).x-(te=C[he]).x)*(te.y+le.y);return ce}em.types=["Unknown","Point","LineString","Polygon"],em.prototype.loadGeometry=function(){var C=(this||te)._pbf;C.pos=(this||te)._geometry;for(var le,ce=C.readVarint()+C.pos,he=1,ue=0,de=0,_e=0,ye=[];C.pos<ce;){if(ue<=0){var ve=C.readVarint();he=7&ve,ue=ve>>3}if(ue--,1===he||2===he)de+=C.readSVarint(),_e+=C.readSVarint(),1===he&&(le&&ye.push(le),le=[]),le.push(new l_(de,_e));else{if(7!==he)throw new Error("unknown command "+he);le&&le.push(le[0].clone())}}return le&&ye.push(le),ye},em.prototype.bbox=function(){var C=(this||te)._pbf;C.pos=(this||te)._geometry;for(var le=C.readVarint()+C.pos,ce=1,he=0,ue=0,de=0,_e=1/0,ye=-1/0,ve=1/0,Se=-1/0;C.pos<le;){if(he<=0){var Me=C.readVarint();ce=7&Me,he=Me>>3}if(he--,1===ce||2===ce)(ue+=C.readSVarint())<_e&&(_e=ue),ue>ye&&(ye=ue),(de+=C.readSVarint())<ve&&(ve=de),de>Se&&(Se=de);else if(7!==ce)throw new Error("unknown command "+ce)}return[_e,ve,ye,Se]},em.prototype.toGeoJSON=function(C,le,ce){var he,ue,de=(this||te).extent*Math.pow(2,ce),_e=(this||te).extent*C,ye=(this||te).extent*le,ve=this.loadGeometry(),Se=em.types[(this||te).type];function h(C){for(var te=0;te<C.length;te++){var le=C[te];C[te]=[360*(le.x+_e)/de-180,360/Math.PI*Math.atan(Math.exp((180-360*(le.y+ye)/de)*Math.PI/180))-90]}}switch((this||te).type){case 1:var Me=[];for(he=0;he<ve.length;he++)Me[he]=ve[he][0];h(ve=Me);break;case 2:for(he=0;he<ve.length;he++)h(ve[he]);break;case 3:for(ve=function(C){var te=C.length;if(te<=1)return[C];for(var le,ce,he=[],ue=0;ue<te;ue++){var de=im(C[ue]);0!==de&&(void 0===ce&&(ce=de<0),ce===de<0?(le&&he.push(le),le=[C[ue]]):le.push(C[ue]))}return le&&he.push(le),he}(ve),he=0;he<ve.length;he++)for(ue=0;ue<ve[he].length;ue++)h(ve[he][ue])}1===ve.length?ve=ve[0]:Se="Multi"+Se;var Ae={type:"Feature",geometry:{type:Se,coordinates:ve},properties:(this||te).properties};return"id"in(this||te)&&(Ae.id=(this||te).id),Ae};var h_=c_,u_=om;function om(C,le){(this||te).version=1,(this||te).name=null,(this||te).extent=4096,(this||te).length=0,(this||te)._pbf=C,(this||te)._keys=[],(this||te)._values=[],(this||te)._features=[],C.readFields(sm,this||te,le),(this||te).length=(this||te)._features.length}function sm(C,te,le){15===C?te.version=le.readVarint():1===C?te.name=le.readString():5===C?te.extent=le.readVarint():2===C?te._features.push(le.pos):3===C?te._keys.push(le.readString()):4===C&&te._values.push(function(C){for(var te=null,le=C.readVarint()+C.pos;C.pos<le;){var ce=C.readVarint()>>3;te=1===ce?C.readString():2===ce?C.readFloat():3===ce?C.readDouble():4===ce?C.readVarint64():5===ce?C.readVarint():6===ce?C.readSVarint():7===ce?C.readBoolean():null}return te}(le))}om.prototype.feature=function(C){if(C<0||C>=(this||te)._features.length)throw new Error("feature index out of bounds");(this||te)._pbf.pos=(this||te)._features[C];var le=(this||te)._pbf.readVarint()+(this||te)._pbf.pos;return new h_((this||te)._pbf,le,(this||te).extent,(this||te)._keys,(this||te)._values)};var d_=u_;function lm(C,te,le){if(3===C){var ce=new d_(le,le.readVarint()+le.pos);ce.length&&(te[ce.name]=ce)}}var __=a_.VectorTile=function(C,le){(this||te).layers=C.readFields(lm,{},le)},y_=a_.VectorTileFeature=c_;function um(C,te,le,ce){const he=[],ue=0===ce?(C,te,le,ce,he,ue)=>{C.push(new je(ue,le+(ue-te)/(ce-te)*(he-le)))}:(C,te,le,ce,he,ue)=>{C.push(new je(te+(ue-le)/(he-le)*(ce-te),ue))};for(const de of C){const C=[];for(const he of de){if(he.length<=2)continue;const de=[];for(let C=0;C<he.length-1;C++){const _e=he[C].x,ye=he[C].y,ve=he[C+1].x,Se=he[C+1].y,Me=0===ce?_e:ye,Ae=0===ce?ve:Se;Me<te?Ae>te&&ue(de,_e,ye,ve,Se,te):Me>le?Ae<le&&ue(de,_e,ye,ve,Se,le):de.push(he[C]),Ae<te&&Me>=te&&ue(de,_e,ye,ve,Se,te),Ae>le&&Me<=le&&ue(de,_e,ye,ve,Se,le)}let _e=he[he.length-1];const ye=0===ce?_e.x:_e.y;ye>=te&&ye<=le&&de.push(_e),de.length&&(_e=de[de.length-1],de[0].x===_e.x&&de[0].y===_e.y||de.push(de[0]),C.push(de))}C.length&&he.push(C)}return he}a_.VectorTileLayer=u_;class dm{constructor(C){this._stringToNumber={},this._numberToString=[];for(let te=0;te<C.length;te++){const le=C[te];this._stringToNumber[le]=te,this._numberToString[te]=le}}encode(C){return this._stringToNumber[C]}decode(C){return this._numberToString[C]}}var b_={read:function(C,te,le,ce,he){var ue,de,_e=8*he-ce-1,ye=(1<<_e)-1,ve=ye>>1,Se=-7,Me=le?he-1:0,Ae=le?-1:1,Ce=C[te+Me];for(Me+=Ae,ue=Ce&(1<<-Se)-1,Ce>>=-Se,Se+=_e;Se>0;ue=256*ue+C[te+Me],Me+=Ae,Se-=8);for(de=ue&(1<<-Se)-1,ue>>=-Se,Se+=ce;Se>0;de=256*de+C[te+Me],Me+=Ae,Se-=8);if(0===ue)ue=1-ve;else{if(ue===ye)return de?NaN:1/0*(Ce?-1:1);de+=Math.pow(2,ce),ue-=ve}return(Ce?-1:1)*de*Math.pow(2,ue-ce)},write:function(C,te,le,ce,he,ue){var de,_e,ye,ve=8*ue-he-1,Se=(1<<ve)-1,Me=Se>>1,Ae=23===he?Math.pow(2,-24)-Math.pow(2,-77):0,Ce=ce?0:ue-1,Oe=ce?1:-1,Ne=te<0||0===te&&1/te<0?1:0;for(te=Math.abs(te),isNaN(te)||te===1/0?(_e=isNaN(te)?1:0,de=Se):(de=Math.floor(Math.log(te)/Math.LN2),te*(ye=Math.pow(2,-de))<1&&(de--,ye*=2),(te+=de+Me>=1?Ae/ye:Ae*Math.pow(2,1-Me))*ye>=2&&(de++,ye/=2),de+Me>=Se?(_e=0,de=Se):de+Me>=1?(_e=(te*ye-1)*Math.pow(2,he),de+=Me):(_e=te*Math.pow(2,Me-1)*Math.pow(2,he),de=0));he>=8;C[le+Ce]=255&_e,Ce+=Oe,_e/=256,he-=8);for(de=de<<he|_e,ve+=he;ve>0;C[le+Ce]=255&de,Ce+=Oe,de/=256,ve-=8);C[le+Ce-Oe]|=128*Ne}},S_=_m,M_=b_;function _m(C){(this||te).buf=ArrayBuffer.isView&&ArrayBuffer.isView(C)?C:new Uint8Array(C||0),(this||te).pos=0,(this||te).type=0,(this||te).length=(this||te).buf.length}_m.Varint=0,_m.Fixed64=1,_m.Bytes=2,_m.Fixed32=5;var A_=4294967296,D_=1/A_,P_="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function vm(C){return C.type===_m.Bytes?C.readVarint()+C.pos:C.pos+1}function bm(C,te,le){return le?4294967296*te+(C>>>0):4294967296*(te>>>0)+(C>>>0)}function wm(C,te,le){var ce=te<=16383?1:te<=2097151?2:te<=268435455?3:Math.floor(Math.log(te)/(7*Math.LN2));le.realloc(ce);for(var he=le.pos-1;he>=C;he--)le.buf[he+ce]=le.buf[he]}function Tm(C,te){for(var le=0;le<C.length;le++)te.writeVarint(C[le])}function Em(C,te){for(var le=0;le<C.length;le++)te.writeSVarint(C[le])}function Mm(C,te){for(var le=0;le<C.length;le++)te.writeFloat(C[le])}function Am(C,te){for(var le=0;le<C.length;le++)te.writeDouble(C[le])}function Sm(C,te){for(var le=0;le<C.length;le++)te.writeBoolean(C[le])}function Im(C,te){for(var le=0;le<C.length;le++)te.writeFixed32(C[le])}function Cm(C,te){for(var le=0;le<C.length;le++)te.writeSFixed32(C[le])}function zm(C,te){for(var le=0;le<C.length;le++)te.writeFixed64(C[le])}function Pm(C,te){for(var le=0;le<C.length;le++)te.writeSFixed64(C[le])}function Dm(C,te){return(C[te]|C[te+1]<<8|C[te+2]<<16)+16777216*C[te+3]}function Rm(C,te,le){C[le]=te,C[le+1]=te>>>8,C[le+2]=te>>>16,C[le+3]=te>>>24}function Lm(C,te){return(C[te]|C[te+1]<<8|C[te+2]<<16)+(C[te+3]<<24)}_m.prototype={destroy:function(){(this||te).buf=null},readFields:function(C,le,ce){for(ce=ce||(this||te).length;(this||te).pos<ce;){var he=this.readVarint(),ue=he>>3,de=(this||te).pos;(this||te).type=7&he,C(ue,le,this||te),(this||te).pos===de&&this.skip(he)}return le},readMessage:function(C,le){return this.readFields(C,le,this.readVarint()+(this||te).pos)},readFixed32:function(){var C=Dm((this||te).buf,(this||te).pos);return(this||te).pos+=4,C},readSFixed32:function(){var C=Lm((this||te).buf,(this||te).pos);return(this||te).pos+=4,C},readFixed64:function(){var C=Dm((this||te).buf,(this||te).pos)+Dm((this||te).buf,(this||te).pos+4)*A_;return(this||te).pos+=8,C},readSFixed64:function(){var C=Dm((this||te).buf,(this||te).pos)+Lm((this||te).buf,(this||te).pos+4)*A_;return(this||te).pos+=8,C},readFloat:function(){var C=M_.read((this||te).buf,(this||te).pos,!0,23,4);return(this||te).pos+=4,C},readDouble:function(){var C=M_.read((this||te).buf,(this||te).pos,!0,52,8);return(this||te).pos+=8,C},readVarint:function(C){var le,ce,he=(this||te).buf;return le=127&(ce=he[(this||te).pos++]),ce<128?le:(le|=(127&(ce=he[(this||te).pos++]))<<7,ce<128?le:(le|=(127&(ce=he[(this||te).pos++]))<<14,ce<128?le:(le|=(127&(ce=he[(this||te).pos++]))<<21,ce<128?le:function(C,te,le){var ce,he,ue=le.buf;if(ce=(112&(he=ue[le.pos++]))>>4,he<128)return bm(C,ce,te);if(ce|=(127&(he=ue[le.pos++]))<<3,he<128)return bm(C,ce,te);if(ce|=(127&(he=ue[le.pos++]))<<10,he<128)return bm(C,ce,te);if(ce|=(127&(he=ue[le.pos++]))<<17,he<128)return bm(C,ce,te);if(ce|=(127&(he=ue[le.pos++]))<<24,he<128)return bm(C,ce,te);if(ce|=(1&(he=ue[le.pos++]))<<31,he<128)return bm(C,ce,te);throw new Error("Expected varint not more than 10 bytes")}(le|=(15&(ce=he[(this||te).pos]))<<28,C,this||te))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var C=this.readVarint();return C%2==1?(C+1)/-2:C/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var C=this.readVarint()+(this||te).pos,le=(this||te).pos;return(this||te).pos=C,C-le>=12&&P_?function(C,te,le){return P_.decode(C.subarray(te,le))}((this||te).buf,le,C):function(C,te,le){for(var ce="",he=te;he<le;){var ue,de,_e,ye=C[he],ve=null,Se=ye>239?4:ye>223?3:ye>191?2:1;if(he+Se>le)break;1===Se?ye<128&&(ve=ye):2===Se?128==(192&(ue=C[he+1]))&&(ve=(31&ye)<<6|63&ue)<=127&&(ve=null):3===Se?(de=C[he+2],128==(192&(ue=C[he+1]))&&128==(192&de)&&((ve=(15&ye)<<12|(63&ue)<<6|63&de)<=2047||ve>=55296&&ve<=57343)&&(ve=null)):4===Se&&(de=C[he+2],_e=C[he+3],128==(192&(ue=C[he+1]))&&128==(192&de)&&128==(192&_e)&&((ve=(15&ye)<<18|(63&ue)<<12|(63&de)<<6|63&_e)<=65535||ve>=1114112)&&(ve=null)),null===ve?(ve=65533,Se=1):ve>65535&&(ve-=65536,ce+=String.fromCharCode(ve>>>10&1023|55296),ve=56320|1023&ve),ce+=String.fromCharCode(ve),he+=Se}return ce}((this||te).buf,le,C)},readBytes:function(){var C=this.readVarint()+(this||te).pos,le=(this||te).buf.subarray((this||te).pos,C);return(this||te).pos=C,le},readPackedVarint:function(C,le){if((this||te).type!==_m.Bytes)return C.push(this.readVarint(le));var ce=vm(this||te);for(C=C||[];(this||te).pos<ce;)C.push(this.readVarint(le));return C},readPackedSVarint:function(C){if((this||te).type!==_m.Bytes)return C.push(this.readSVarint());var le=vm(this||te);for(C=C||[];(this||te).pos<le;)C.push(this.readSVarint());return C},readPackedBoolean:function(C){if((this||te).type!==_m.Bytes)return C.push(this.readBoolean());var le=vm(this||te);for(C=C||[];(this||te).pos<le;)C.push(this.readBoolean());return C},readPackedFloat:function(C){if((this||te).type!==_m.Bytes)return C.push(this.readFloat());var le=vm(this||te);for(C=C||[];(this||te).pos<le;)C.push(this.readFloat());return C},readPackedDouble:function(C){if((this||te).type!==_m.Bytes)return C.push(this.readDouble());var le=vm(this||te);for(C=C||[];(this||te).pos<le;)C.push(this.readDouble());return C},readPackedFixed32:function(C){if((this||te).type!==_m.Bytes)return C.push(this.readFixed32());var le=vm(this||te);for(C=C||[];(this||te).pos<le;)C.push(this.readFixed32());return C},readPackedSFixed32:function(C){if((this||te).type!==_m.Bytes)return C.push(this.readSFixed32());var le=vm(this||te);for(C=C||[];(this||te).pos<le;)C.push(this.readSFixed32());return C},readPackedFixed64:function(C){if((this||te).type!==_m.Bytes)return C.push(this.readFixed64());var le=vm(this||te);for(C=C||[];(this||te).pos<le;)C.push(this.readFixed64());return C},readPackedSFixed64:function(C){if((this||te).type!==_m.Bytes)return C.push(this.readSFixed64());var le=vm(this||te);for(C=C||[];(this||te).pos<le;)C.push(this.readSFixed64());return C},skip:function(C){var le=7&C;if(le===_m.Varint)for(;(this||te).buf[(this||te).pos++]>127;);else if(le===_m.Bytes)(this||te).pos=this.readVarint()+(this||te).pos;else if(le===_m.Fixed32)(this||te).pos+=4;else{if(le!==_m.Fixed64)throw new Error("Unimplemented type: "+le);(this||te).pos+=8}},writeTag:function(C,te){this.writeVarint(C<<3|te)},realloc:function(C){for(var le=(this||te).length||16;le<(this||te).pos+C;)le*=2;if(le!==(this||te).length){var ce=new Uint8Array(le);ce.set((this||te).buf),(this||te).buf=ce,(this||te).length=le}},finish:function(){return(this||te).length=(this||te).pos,(this||te).pos=0,(this||te).buf.subarray(0,(this||te).length)},writeFixed32:function(C){this.realloc(4),Rm((this||te).buf,C,(this||te).pos),(this||te).pos+=4},writeSFixed32:function(C){this.realloc(4),Rm((this||te).buf,C,(this||te).pos),(this||te).pos+=4},writeFixed64:function(C){this.realloc(8),Rm((this||te).buf,-1&C,(this||te).pos),Rm((this||te).buf,Math.floor(C*D_),(this||te).pos+4),(this||te).pos+=8},writeSFixed64:function(C){this.realloc(8),Rm((this||te).buf,-1&C,(this||te).pos),Rm((this||te).buf,Math.floor(C*D_),(this||te).pos+4),(this||te).pos+=8},writeVarint:function(C){(C=+C||0)>268435455||C<0?function(C,te){var le,ce;if(C>=0?(le=C%4294967296|0,ce=C/4294967296|0):(ce=~(-C/4294967296),4294967295^(le=~(-C%4294967296))?le=le+1|0:(le=0,ce=ce+1|0)),C>=0x10000000000000000||C<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");te.realloc(10),function(C,te,le){le.buf[le.pos++]=127&C|128,C>>>=7,le.buf[le.pos++]=127&C|128,C>>>=7,le.buf[le.pos++]=127&C|128,C>>>=7,le.buf[le.pos++]=127&C|128,le.buf[le.pos]=127&(C>>>=7)}(le,0,te),function(C,te){var le=(7&C)<<4;te.buf[te.pos++]|=le|((C>>>=3)?128:0),C&&(te.buf[te.pos++]=127&C|((C>>>=7)?128:0),C&&(te.buf[te.pos++]=127&C|((C>>>=7)?128:0),C&&(te.buf[te.pos++]=127&C|((C>>>=7)?128:0),C&&(te.buf[te.pos++]=127&C|((C>>>=7)?128:0),C&&(te.buf[te.pos++]=127&C)))))}(ce,te)}(C,this||te):(this.realloc(4),(this||te).buf[(this||te).pos++]=127&C|(C>127?128:0),C<=127||((this||te).buf[(this||te).pos++]=127&(C>>>=7)|(C>127?128:0),C<=127||((this||te).buf[(this||te).pos++]=127&(C>>>=7)|(C>127?128:0),C<=127||((this||te).buf[(this||te).pos++]=C>>>7&127))))},writeSVarint:function(C){this.writeVarint(C<0?2*-C-1:2*C)},writeBoolean:function(C){this.writeVarint(Boolean(C))},writeString:function(C){C=String(C),this.realloc(4*C.length),(this||te).pos++;var le=(this||te).pos;(this||te).pos=function(C,te,le){for(var ce,he,ue=0;ue<te.length;ue++){if((ce=te.charCodeAt(ue))>55295&&ce<57344){if(!he){ce>56319||ue+1===te.length?(C[le++]=239,C[le++]=191,C[le++]=189):he=ce;continue}if(ce<56320){C[le++]=239,C[le++]=191,C[le++]=189,he=ce;continue}ce=he-55296<<10|ce-56320|65536,he=null}else he&&(C[le++]=239,C[le++]=191,C[le++]=189,he=null);ce<128?C[le++]=ce:(ce<2048?C[le++]=ce>>6|192:(ce<65536?C[le++]=ce>>12|224:(C[le++]=ce>>18|240,C[le++]=ce>>12&63|128),C[le++]=ce>>6&63|128),C[le++]=63&ce|128)}return le}((this||te).buf,C,(this||te).pos);var ce=(this||te).pos-le;ce>=128&&wm(le,ce,this||te),(this||te).pos=le-1,this.writeVarint(ce),(this||te).pos+=ce},writeFloat:function(C){this.realloc(4),M_.write((this||te).buf,C,(this||te).pos,!0,23,4),(this||te).pos+=4},writeDouble:function(C){this.realloc(8),M_.write((this||te).buf,C,(this||te).pos,!0,52,8),(this||te).pos+=8},writeBytes:function(C){var le=C.length;this.writeVarint(le),this.realloc(le);for(var ce=0;ce<le;ce++)(this||te).buf[(this||te).pos++]=C[ce]},writeRawMessage:function(C,le){(this||te).pos++;var ce=(this||te).pos;C(le,this||te);var he=(this||te).pos-ce;he>=128&&wm(ce,he,this||te),(this||te).pos=ce-1,this.writeVarint(he),(this||te).pos+=he},writeMessage:function(C,te,le){this.writeTag(C,_m.Bytes),this.writeRawMessage(te,le)},writePackedVarint:function(C,te){te.length&&this.writeMessage(C,Tm,te)},writePackedSVarint:function(C,te){te.length&&this.writeMessage(C,Em,te)},writePackedBoolean:function(C,te){te.length&&this.writeMessage(C,Sm,te)},writePackedFloat:function(C,te){te.length&&this.writeMessage(C,Mm,te)},writePackedDouble:function(C,te){te.length&&this.writeMessage(C,Am,te)},writePackedFixed32:function(C,te){te.length&&this.writeMessage(C,Im,te)},writePackedSFixed32:function(C,te){te.length&&this.writeMessage(C,Cm,te)},writePackedFixed64:function(C,te){te.length&&this.writeMessage(C,zm,te)},writePackedSFixed64:function(C,te){te.length&&this.writeMessage(C,Pm,te)},writeBytesField:function(C,te){this.writeTag(C,_m.Bytes),this.writeBytes(te)},writeFixed32Field:function(C,te){this.writeTag(C,_m.Fixed32),this.writeFixed32(te)},writeSFixed32Field:function(C,te){this.writeTag(C,_m.Fixed32),this.writeSFixed32(te)},writeFixed64Field:function(C,te){this.writeTag(C,_m.Fixed64),this.writeFixed64(te)},writeSFixed64Field:function(C,te){this.writeTag(C,_m.Fixed64),this.writeSFixed64(te)},writeVarintField:function(C,te){this.writeTag(C,_m.Varint),this.writeVarint(te)},writeSVarintField:function(C,te){this.writeTag(C,_m.Varint),this.writeSVarint(te)},writeStringField:function(C,te){this.writeTag(C,_m.Bytes),this.writeString(te)},writeFloatField:function(C,te){this.writeTag(C,_m.Fixed32),this.writeFloat(te)},writeDoubleField:function(C,te){this.writeTag(C,_m.Fixed64),this.writeDouble(te)},writeBooleanField:function(C,te){this.writeVarintField(C,Boolean(te))}};var J_=d(S_);const tg=["tile","layer","source","sourceLayer","state"];class Bm{constructor(C,te,le,ce,he){this.type="Feature",this._vectorTileFeature=C,this._z=te,this._x=le,this._y=ce,this.properties=C.properties,this.id=he}get geometry(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(C){this._geometry=C}toJSON(){const C={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};void 0!==this.id&&(C.id=this.id);for(const te of tg)void 0!==this[te]&&(C[te]=this[te]);return C}}class Fm{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(C,te,le){const ce=String(te);if(this.stateChanges[C]=this.stateChanges[C]||{},this.stateChanges[C][ce]=this.stateChanges[C][ce]||{},k(this.stateChanges[C][ce],le),null===this.deletedStates[C]){this.deletedStates[C]={};for(const te in this.state[C])te!==ce&&(this.deletedStates[C][te]=null)}else if(this.deletedStates[C]&&null===this.deletedStates[C][ce]){this.deletedStates[C][ce]={};for(const te in this.state[C][ce])le[te]||(this.deletedStates[C][ce][te]=null)}else for(const te in le)this.deletedStates[C]&&this.deletedStates[C][ce]&&null===this.deletedStates[C][ce][te]&&delete this.deletedStates[C][ce][te]}removeFeatureState(C,te,le){if(null===this.deletedStates[C])return;const ce=String(te);if(this.deletedStates[C]=this.deletedStates[C]||{},le&&void 0!==te)null!==this.deletedStates[C][ce]&&(this.deletedStates[C][ce]=this.deletedStates[C][ce]||{},this.deletedStates[C][ce][le]=null);else if(void 0!==te)if(this.stateChanges[C]&&this.stateChanges[C][ce])for(le in this.deletedStates[C][ce]={},this.stateChanges[C][ce])this.deletedStates[C][ce][le]=null;else this.deletedStates[C][ce]=null;else this.deletedStates[C]=null}getState(C,te){const le=String(te),ce=k({},(this.state[C]||{})[le],(this.stateChanges[C]||{})[le]);if(null===this.deletedStates[C])return{};if(this.deletedStates[C]){const le=this.deletedStates[C][te];if(null===le)return{};for(const C in le)delete ce[C]}return ce}initializeTileState(C,te){C.setFeatureState(this.state,te)}coalesceChanges(C,te){const le={};for(const C in this.stateChanges){this.state[C]=this.state[C]||{};const te={};for(const le in this.stateChanges[C])this.state[C][le]||(this.state[C][le]={}),k(this.state[C][le],this.stateChanges[C][le]),te[le]=this.state[C][le];le[C]=te}for(const C in this.deletedStates){this.state[C]=this.state[C]||{};const te={};if(null===this.deletedStates[C])for(const le in this.state[C])te[le]={},this.state[C][le]={};else for(const le in this.deletedStates[C]){if(null===this.deletedStates[C][le])this.state[C][le]={};else if(this.state[C][le])for(const te of Object.keys(this.deletedStates[C][le]))delete this.state[C][le][te];te[le]=this.state[C][le]}le[C]=le[C]||{},k(le[C],te)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(le).length)for(const ce in C)C[ce].setFeatureState(le,te)}}class Nm{constructor(C){this.size=C,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(C,te){const le=this.toIdx(C,te);return{min:this.minimums[le],max:this.maximums[le]}}isLeaf(C,te){return this.leaves[this.toIdx(C,te)]}toIdx(C,te){return te*this.size+C}}function Um(C,te,le,ce){let he=0,ue=Number.MAX_VALUE;for(let de=0;de<3;de++)if(Math.abs(ce[de])<1e-15){if(le[de]<C[de]||le[de]>te[de])return null}else{const _e=1/ce[de];let ye=(C[de]-le[de])*_e,ve=(te[de]-le[de])*_e;if(ye>ve){const C=ye;ye=ve,ve=C}if(ye>he&&(he=ye),ve<ue&&(ue=ve),he>ue)return null}return he}function Vm(C,te,le,ce,he,ue,de,_e,ye,ve,Se){const Me=ce-C,Ae=he-te,Ce=ue-le,Oe=de-C,Ne=_e-te,je=ye-le,Ge=Se[1]*je-Se[2]*Ne,Ze=Se[2]*Oe-Se[0]*je,qe=Se[0]*Ne-Se[1]*Oe,$e=Me*Ge+Ae*Ze+Ce*qe;if(Math.abs($e)<1e-15)return null;const He=1/$e,We=ve[0]-C,Xe=ve[1]-te,Ye=ve[2]-le,Je=(We*Ge+Xe*Ze+Ye*qe)*He;if(Je<0||Je>1)return null;const Qe=Xe*Ce-Ye*Ae,tt=Ye*Me-We*Ce,rt=We*Ae-Xe*Me,ot=(Se[0]*Qe+Se[1]*tt+Se[2]*rt)*He;return ot<0||Je+ot>1?null:(Oe*Qe+Ne*tt+je*rt)*He}function jm(C,te,le){return(C-te)/(le-te)}function Gm(C,te,le,ce,he,ue,de,_e,ye){const ve=1<<le,Se=ue-ce,Me=de-he,Ae=(C+1)/ve*Se+ce,Ce=(te+0)/ve*Me+he,Oe=(te+1)/ve*Me+he;_e[0]=(C+0)/ve*Se+ce,_e[1]=Ce,ye[0]=Ae,ye[1]=Oe}class qm{constructor(C){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=C,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const te=function(C){const te=Math.ceil(Math.log2(C.dim/8)),le=[];let ce=Math.ceil(Math.pow(2,te));const he=1/ce,o=(C,te,le,ce,he)=>{const ue=ce?1:0,de=(C+1)*le-ue,_e=te*le,ye=(te+1)*le-ue;he[0]=C*le,he[1]=_e,he[2]=de,he[3]=ye};let ue=new Nm(ce);const de=[];for(let te=0;te<ce*ce;te++){o(te%ce,Math.floor(te/ce),he,!1,de);const le=$m(de[0],de[1],C),_e=$m(de[2],de[1],C),ye=$m(de[2],de[3],C),ve=$m(de[0],de[3],C);ue.minimums.push(Math.min(le,_e,ye,ve)),ue.maximums.push(Math.max(le,_e,ye,ve)),ue.leaves.push(1)}for(le.push(ue),ce/=2;ce>=1;ce/=2){const C=le[le.length-1];ue=new Nm(ce);for(let te=0;te<ce*ce;te++){o(te%ce,Math.floor(te/ce),2,!0,de);const le=C.getElevation(de[0],de[1]),he=C.getElevation(de[2],de[1]),_e=C.getElevation(de[2],de[3]),ye=C.getElevation(de[0],de[3]),ve=C.isLeaf(de[0],de[1]),Se=C.isLeaf(de[2],de[1]),Me=C.isLeaf(de[2],de[3]),Ae=C.isLeaf(de[0],de[3]),Ce=Math.min(le.min,he.min,_e.min,ye.min),Oe=Math.max(le.max,he.max,_e.max,ye.max),Ne=ve&&Se&&Me&&Ae;ue.maximums.push(Oe),ue.minimums.push(Ce),ue.leaves.push(Oe-Ce<=5&&Ne?1:0)}le.push(ue)}return le}(this.dem),le=te.length-1,ce=te[le];this._addNode(ce.minimums[0],ce.maximums[0],ce.leaves[0]),this._construct(te,0,0,le,0)}raycastRoot(C,te,le,ce,he,ue,de=1){return Um([C,te,-100],[le,ce,this.maximums[0]*de],he,ue)}raycast(C,te,le,ce,he,ue,de=1){if(!this.nodeCount)return null;const _e=this.raycastRoot(C,te,le,ce,he,ue,de);if(null==_e)return null;const ye=[],ve=[],Se=[],Me=[],Ae=[{idx:0,t:_e,nodex:0,nodey:0,depth:0}];for(;Ae.length>0;){const{idx:_e,t:Ce,nodex:Oe,nodey:Ne,depth:je}=Ae.pop();if(this.leaves[_e]){Gm(Oe,Ne,je,C,te,le,ce,Se,Me);const _e=1<<je,ye=(Oe+0)/_e,ve=(Oe+1)/_e,Ae=(Ne+0)/_e,Ge=(Ne+1)/_e,Ze=$m(ye,Ae,this.dem)*de,qe=$m(ve,Ae,this.dem)*de,$e=$m(ve,Ge,this.dem)*de,He=$m(ye,Ge,this.dem)*de,We=Vm(Se[0],Se[1],Ze,Me[0],Se[1],qe,Me[0],Me[1],$e,he,ue),Xe=Vm(Me[0],Me[1],$e,Se[0],Me[1],He,Se[0],Se[1],Ze,he,ue),Ye=Math.min(null!==We?We:Number.MAX_VALUE,null!==Xe?Xe:Number.MAX_VALUE);if(Ye!==Number.MAX_VALUE)return Ye;{const C=Zd.scaleAndAdd([],he,ue,Ce);if(Zm(Ze,qe,He,$e,jm(C[0],Se[0],Me[0]),jm(C[1],Se[1],Me[1]))>=C[2])return Ce}continue}let Ge=0;for(let Ae=0;Ae<this._siblingOffset.length;Ae++){Gm((Oe<<1)+this._siblingOffset[Ae][0],(Ne<<1)+this._siblingOffset[Ae][1],je+1,C,te,le,ce,Se,Me),Se[2]=-100,Me[2]=this.maximums[this.childOffsets[_e]+Ae]*de;const Ce=Um(Se,Me,he,ue);if(null!=Ce){const C=Ce;ye[Ae]=C;let te=!1;for(let le=0;le<Ge&&!te;le++)C>=ye[ve[le]]&&(ve.splice(le,0,Ae),te=!0);te||(ve[Ge]=Ae),Ge++}}for(let C=0;C<Ge;C++){const te=ve[C];Ae.push({idx:this.childOffsets[_e]+te,t:ye[te],nodex:(Oe<<1)+this._siblingOffset[te][0],nodey:(Ne<<1)+this._siblingOffset[te][1],depth:je+1})}}return null}_addNode(C,te,le){return this.minimums.push(C),this.maximums.push(te),this.leaves.push(le),this.childOffsets.push(0),this.nodeCount++}_construct(C,te,le,ce,he){if(1===C[ce].isLeaf(te,le))return;this.childOffsets[he]||(this.childOffsets[he]=this.nodeCount);const ue=ce-1,de=C[ue];let _e=0,ye=0;for(let C=0;C<this._siblingOffset.length;C++){const ce=2*te+this._siblingOffset[C][0],he=2*le+this._siblingOffset[C][1],ue=de.getElevation(ce,he),ve=de.isLeaf(ce,he),Se=this._addNode(ue.min,ue.max,ve);ve&&(_e|=1<<C),ye||(ye=Se)}for(let ce=0;ce<this._siblingOffset.length;ce++)_e&1<<ce||this._construct(C,2*te+this._siblingOffset[ce][0],2*le+this._siblingOffset[ce][1],ue,ye+ce)}}function Zm(C,te,le,ce,he,ue){return Kr(Kr(C,le,ue),Kr(te,ce,ue),he)}function $m(C,te,le){const ce=le.dim,he=z(C*ce-.5,0,ce-1),ue=z(te*ce-.5,0,ce-1),de=Math.floor(he),_e=Math.floor(ue),ye=Math.min(de+1,ce-1),ve=Math.min(_e+1,ce-1);return Zm(le.get(de,_e),le.get(ye,_e),le.get(de,ve),le.get(ye,ve),he-de,ue-_e)}const ng={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function Hm(C,te,le){return(256*C*256+256*te+le)/10-1e4}function Xm(C,te,le){return 256*C+te+le/256-32768}class Ym{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(C,te,le,ce=!1){if(this.uid=C,te.height!==te.width)throw new RangeError("DEM tiles must be square");if(le&&"mapbox"!==le&&"terrarium"!==le)return H(`"${le}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=te.height;const he=this.dim=te.height-2,ue=new Uint32Array(te.data.buffer);if(this.pixels=new Uint8Array(te.data.buffer),this.floatView=new Float32Array(te.data.buffer),this.borderReady=ce,this._modifiedForSources={},!ce){for(let C=0;C<he;C++)ue[this._idx(-1,C)]=ue[this._idx(0,C)],ue[this._idx(he,C)]=ue[this._idx(he-1,C)],ue[this._idx(C,-1)]=ue[this._idx(C,0)],ue[this._idx(C,he)]=ue[this._idx(C,he-1)];ue[this._idx(-1,-1)]=ue[this._idx(0,0)],ue[this._idx(he,-1)]=ue[this._idx(he-1,0)],ue[this._idx(-1,he)]=ue[this._idx(0,he-1)],ue[this._idx(he,he)]=ue[this._idx(he-1,he-1)]}const de="terrarium"===le?Xm:Hm;for(let C=0;C<ue.length;++C){const te=4*C;this.floatView[C]=de(this.pixels[te],this.pixels[te+1],this.pixels[te+2])}this._timestamp=bi.now()}_buildQuadTree(){this._tree=new qm(this)}get(C,te,le=!1){le&&(C=z(C,-1,this.dim),te=z(te,-1,this.dim));const ce=this._idx(C,te);return this.floatView[ce]}set(C,te,le){const ce=this._idx(C,te),he=this.floatView[ce];return this.floatView[ce]=le,le-he}static getUnpackVector(C){return ng[C]}_idx(C,te){if(C<-1||C>=this.dim+1||te<-1||te>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(te+1)*this.stride+(C+1)}static pack(C,te){const le=[0,0,0,0],ce=Ym.getUnpackVector(te);let he=Math.floor((C+ce[3])/ce[2]);return le[2]=he%256,he=Math.floor(he/256),le[1]=he%256,he=Math.floor(he/256),le[0]=he,le}getPixels(){return new tf({width:this.stride,height:this.stride},this.pixels)}backfillBorder(C,te,le){if(this.dim!==C.dim)throw new Error("dem dimension mismatch");let ce=te*this.dim,he=te*this.dim+this.dim,ue=le*this.dim,de=le*this.dim+this.dim;switch(te){case-1:ce=he-1;break;case 1:he=ce+1}switch(le){case-1:ue=de-1;break;case 1:de=ue+1}const _e=-te*this.dim,ye=-le*this.dim;for(let te=ue;te<de;te++)for(let le=ce;le<he;le++){const ce=4*this._idx(le,te),he=4*this._idx(le+_e,te+ye);this.pixels[ce+0]=C.pixels[he+0],this.pixels[ce+1]=C.pixels[he+1],this.pixels[ce+2]=C.pixels[he+2],this.pixels[ce+3]=C.pixels[he+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}Rs(Ym,"DEMData"),Rs(qm,"DemMinMaxQuadTree",{omit:["dem"]});class Km{isDataAvailableAtPoint(C){const te=this._source();if(this.isUsingMockSource()||!te||C.y<0||C.y>1)return!1;const le=te.getSource().maxzoom,ce=1<<le,he=Math.floor(C.x),ue=Math.floor((C.x-he)*ce),de=Math.floor(C.y*ce),_e=this.findDEMTileFor(new qu(le,he,le,ue,de));return!(!_e||!_e.dem)}getAtPointOrZero(C,te=0){return this.getAtPoint(C,te)||0}getAtPoint(C,te,le=!0){if(this.isUsingMockSource())return null;null==te&&(te=null);const ce=this._source();if(!ce)return te;if(C.y<0||C.y>1)return te;const he=ce.getSource().maxzoom,ue=1<<he,de=Math.floor(C.x),_e=C.x-de,ye=new qu(he,de,he,Math.floor(_e*ue),Math.floor(C.y*ue)),ve=this.findDEMTileFor(ye);if(!ve||!ve.dem)return te;const Se=ve.dem,Me=1<<ve.tileID.canonical.z,Ae=(_e*Me-ve.tileID.canonical.x)*Se.dim,Ce=(C.y*Me-ve.tileID.canonical.y)*Se.dim,Oe=Math.floor(Ae),Ne=Math.floor(Ce);return(le?this.exaggeration():1)*Kr(Kr(Se.get(Oe,Ne),Se.get(Oe,Ne+1),Ce-Ne),Kr(Se.get(Oe+1,Ne),Se.get(Oe+1,Ne+1),Ce-Ne),Ae-Oe)}getAtTileOffset(C,te,le){const ce=1<<C.canonical.z;return this.getAtPointOrZero(new lp(C.wrap+(C.canonical.x+te/Mn)/ce,(C.canonical.y+le/Mn)/ce))}getAtTileOffsetFunc(C,te,le,ce){return he=>{const ue=this.getAtTileOffset(C,he.x,he.y),de=ce.upVector(C.canonical,he.x,he.y),_e=ce.upVectorScale(C.canonical,te,le).metersToTile;return Zd.scale(de,de,ue*_e),de}}getForTilePoints(C,te,le,ce){if(this.isUsingMockSource())return!1;const he=Jm.create(this,C,ce);return!!he&&(te.forEach((C=>{C[2]=this.exaggeration()*he.getElevationAt(C[0],C[1],le)})),!0)}getMinMaxForTile(C){if(this.isUsingMockSource())return null;const te=this.findDEMTileFor(C);if(!te||!te.dem)return null;const le=te.dem.tree,ce=te.tileID,he=1<<C.canonical.z-ce.canonical.z;let ue=C.canonical.x/he-ce.canonical.x,de=C.canonical.y/he-ce.canonical.y,_e=0;for(let te=0;te<C.canonical.z-ce.canonical.z&&!le.leaves[_e];te++){ue*=2,de*=2;const C=2*Math.floor(de)+Math.floor(ue);_e=le.childOffsets[_e]+C,ue%=1,de%=1}return{min:this.exaggeration()*le.minimums[_e],max:this.exaggeration()*le.maximums[_e]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(C,te,le){throw new Error("Pure virtual method called.")}pointCoordinate(C){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(C){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const C=this.visibleDemTiles;if(0===C.length)return null;let te=!1,le=Number.MAX_VALUE,ce=Number.MIN_VALUE;for(const he of C){const C=this.getMinMaxForTile(he.tileID);C&&(le=Math.min(le,C.min),ce=Math.max(ce,C.max),te=!0)}return te?{min:le,max:ce}:null}}class Jm{constructor(C,te,le){this._demTile=C,this._dem=this._demTile.dem,this._scale=te,this._offset=le}static create(C,te,le){const ce=le||C.findDEMTileFor(te);if(!ce||!ce.dem)return;const he=ce.dem,ue=ce.tileID,de=1<<te.canonical.z-ue.canonical.z;return new Jm(ce,he.dim/Mn/de,[(te.canonical.x/de-ue.canonical.x)*he.dim,(te.canonical.y/de-ue.canonical.y)*he.dim])}tileCoordToPixel(C,te){const le=te*this._scale+this._offset[1],ce=Math.floor(C*this._scale+this._offset[0]),he=Math.floor(le);return new je(ce,he)}getElevationAt(C,te,le,ce){const he=C*this._scale+this._offset[0],ue=te*this._scale+this._offset[1],de=Math.floor(he),_e=Math.floor(ue),ye=this._dem;return ce=!!ce,le?Kr(Kr(ye.get(de,_e,ce),ye.get(de,_e+1,ce),ue-_e),Kr(ye.get(de+1,_e,ce),ye.get(de+1,_e+1,ce),ue-_e),he-de):ye.get(de,_e,ce)}getElevationAtPixel(C,te,le){return this._dem.get(C,te,!!le)}getMeterToDEM(C){return(1<<this._demTile.tileID.canonical.z)*Qd(1,C)*this._dem.stride}}class Qm{constructor(C,te){this.tileID=C,this.x=C.canonical.x,this.y=C.canonical.y,this.z=C.canonical.z,this.grid=new Al(Mn,16,0),this.featureIndexArray=new ml,this.promoteId=te}insert(C,te,le,ce,he,ue=0){const de=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(le,ce,he,ue);const _e=this.grid;for(let C=0;C<te.length;C++){const le=te[C],ce=[1/0,1/0,-1/0,-1/0];for(let C=0;C<le.length;C++){const te=le[C];ce[0]=Math.min(ce[0],te.x),ce[1]=Math.min(ce[1],te.y),ce[2]=Math.max(ce[2],te.x),ce[3]=Math.max(ce[3],te.y)}ce[0]<Mn&&ce[1]<Mn&&ce[2]>=0&&ce[3]>=0&&_e.insert(de,ce[0],ce[1],ce[2],ce[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new __(new J_(this.rawTileData)).layers,this.sourceLayerCoder=new dm(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const C in this.vtLayers)this.vtFeatures[C]=[]}return this.vtLayers}query(C,te,le,ce){this.loadVTLayers();const he=C.params||{},ue=Fo(he.filter),de=C.tileResult,_e=C.transform,ye=de.bufferedTilespaceBounds,ve=this.grid.query(ye.min.x,ye.min.y,ye.max.x,ye.max.y,((C,te,le,ce)=>Pp(de.bufferedTilespaceGeometry,C,te,le,ce)));ve.sort(t_);let Se=null;_e.elevation&&ve.length>0&&(Se=Jm.create(_e.elevation,this.tileID));const Me={};let Ae;for(let _e=0;_e<ve.length;_e++){const ye=ve[_e];if(ye===Ae)continue;Ae=ye;const Ce=this.featureIndexArray.get(ye);let Oe=null;this.loadMatchingFeature(Me,Ce,ue,he.layers,he.availableImages,te,le,ce,((te,le,ce,he=0)=>(Oe||(Oe=_p(te,this.tileID.canonical,C.tileTransform)),le.queryIntersectsFeature(de,te,ce,Oe,this.z,C.transform,C.pixelPosMatrix,Se,he))))}return Me}loadMatchingFeature(C,te,le,ce,he,ue,de,_e,ye){const{featureIndex:ve,bucketIndex:Se,sourceLayerIndex:Me,layoutVertexArrayOffset:Ae}=te,Ce=this.bucketLayerIDs[Se];if(ce&&!function(C,te){for(let le=0;le<C.length;le++)if(te.indexOf(C[le])>=0)return!0;return!1}(ce,Ce))return;const Oe=this.sourceLayerCoder.decode(Me),Ne=this.vtLayers[Oe].feature(ve);if(le.needGeometry){const C=gp(Ne,!0);if(!le.filter(new oa(this.tileID.overscaledZ),C,this.tileID.canonical))return}else if(!le.filter(new oa(this.tileID.overscaledZ),Ne))return;const je=this.getId(Ne,Oe);for(let te=0;te<Ce.length;te++){const le=Ce[te];if(ce&&ce.indexOf(le)<0)continue;const Se=ue[le];if(!Se)continue;let Me={};void 0!==je&&_e&&(Me=_e.getState(Se.sourceLayer||"_geojsonTileLayer",je));const Oe=k({},de[le]);Oe.paint=e_(Oe.paint,Se.paint,Ne,Me,he),Oe.layout=e_(Oe.layout,Se.layout,Ne,Me,he);const Ge=!ye||ye(Ne,Se,Me,Ae);if(!Ge)continue;const Ze=new Bm(Ne,this.z,this.x,this.y,je);Ze.layer=Oe;let qe=C[le];void 0===qe&&(qe=C[le]=[]),qe.push({featureIndex:ve,feature:Ze,intersectionZ:Ge})}}lookupSymbolFeatures(C,te,le,ce,he,ue,de,_e){const ye={};this.loadVTLayers();const ve=Fo(he);for(const he of C)this.loadMatchingFeature(ye,{bucketIndex:le,sourceLayerIndex:ce,featureIndex:he,layoutVertexArrayOffset:0},ve,ue,de,_e,te);return ye}loadFeature(C){const{featureIndex:te,sourceLayerIndex:le}=C;this.loadVTLayers();const ce=this.sourceLayerCoder.decode(le),he=this.vtFeatures[ce];if(he[te])return he[te];const ue=this.vtLayers[ce].feature(te);return he[te]=ue,ue}hasLayer(C){for(const te of this.bucketLayerIDs)for(const le of te)if(C===le)return!0;return!1}getId(C,te){let le=C.id;if(this.promoteId){const ce="string"==typeof this.promoteId?this.promoteId:this.promoteId[te];null!=ce&&(le=C.properties[ce]),"boolean"==typeof le&&(le=Number(le))}return le}}function e_(C,te,le,ce,he){return q(C,((C,ue)=>{const de=te instanceof pa?te.get(ue):null;return de&&de.evaluate?de.evaluate(le,ce,he):de}))}function t_(C,te){return te-C}Rs(Qm,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const sg=Ia([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),_g=Ia([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),gg=Ia([{name:"a_projected_pos",components:4,type:"Float32"}],4);Ia([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const yg=Ia([{name:"a_z_offset",components:1,type:"Float32"}],4),Tg=Ia([{name:"a_texb",components:2,type:"Uint16"}]),Eg=Ia([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),kg=Ia([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_z_offset",components:1,type:"Float32"}]);Ia([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const Fg=Ia([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Ng=Ia([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);Ia([{name:"triangle",components:3,type:"Uint16"}]),Ia([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),Ia([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"}]),Ia([{type:"Float32",name:"offsetX"}]),Ia([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var jg=24;const Ug=128;function p_(C,te){const{expression:le}=te;if("constant"===le.kind)return{kind:"constant",layoutSize:le.evaluate(new oa(C+1))};if("source"===le.kind)return{kind:"source"};{const{zoomStops:te,interpolationType:ce}=le;let he=0;for(;he<te.length&&te[he]<=C;)he++;he=Math.max(0,he-1);let ue=he;for(;ue<te.length&&te[ue]<C+1;)ue++;ue=Math.min(te.length-1,ue);const de=te[he],_e=te[ue];return"composite"===le.kind?{kind:"composite",minZoom:de,maxZoom:_e,interpolationType:ce}:{kind:"camera",minZoom:de,maxZoom:_e,minSize:le.evaluate(new oa(de)),maxSize:le.evaluate(new oa(_e)),interpolationType:ce}}}function f_(C,{uSize:te,uSizeT:le},{lowerSize:ce,upperSize:he}){return"source"===C.kind?ce/Ug:"composite"===C.kind?Kr(ce/Ug,he/Ug,le):te}function m_(C,te){let le=0,ce=0;if("constant"===C.kind)ce=C.layoutSize;else if("source"!==C.kind){const{interpolationType:he,minZoom:ue,maxZoom:de}=C,_e=he?z(Ds.interpolationFactor(he,te,ue,de),0,1):0;"camera"===C.kind?ce=Kr(C.minSize,C.maxSize,_e):le=_e}return{uSizeT:le,uSize:ce}}var Vg=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:Ug,evaluateSizeForFeature:f_,evaluateSizeForZoom:m_,getSizeData:p_});function g_(C,te,le){return C.sections.forEach((C=>{C.text=function(C,te,le){const ce=te.layout.get("text-transform").evaluate(le,{});return"uppercase"===ce?C=C.toLocaleUpperCase():"lowercase"===ce&&(C=C.toLocaleLowerCase()),lc.applyArabicShaping&&(C=lc.applyArabicShaping(C)),C}(C.text,te,le)})),C}const Zg={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};function x_(C){return""===C||""===C||""===C||""===C||""===C||""===C||""===C||""===C||""===C||""===C||""===C||""===C||""===C||""===C||""===C||""===C||""===C}function v_(C){return""===C||""===C||""===C||""===C||""===C||""===C||""===C||""===C||""===C||""===C}const Xg=3;function w_(C,te,le){te.glyphs=[],1===C&&le.readMessage(T_,te)}function T_(C,te,le){if(3===C){const{id:C,bitmap:ce,width:he,height:ue,left:de,top:_e,advance:ye}=le.readMessage(E_,{});te.glyphs.push({id:C,bitmap:new Qp({width:he+2*Xg,height:ue+2*Xg},ce),metrics:{width:he,height:ue,left:de,top:_e,advance:ye}})}else 4===C?te.ascender=le.readSVarint():5===C&&(te.descender=le.readSVarint())}function E_(C,te,le){1===C?te.id=le.readVarint():2===C?te.bitmap=le.readBytes():3===C?te.width=le.readVarint():4===C?te.height=le.readVarint():5===C?te.left=le.readSVarint():6===C?te.top=le.readSVarint():7===C&&(te.advance=le.readVarint())}const Kg=Xg,iy={horizontal:1,vertical:2,horizontalOnly:3},ry=-17;class I_{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(C,te){const le=new I_;return le.scale=C||1,le.fontStack=te,le}static forImage(C){const te=new I_;return te.imageName=C,te}}class C_{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(C,te){const le=new C_;for(let ce=0;ce<C.sections.length;ce++){const he=C.sections[ce];he.image?le.addImageSection(he):le.addTextSection(he,te)}return le}length(){return this.text.length}getSection(C){return this.sections[this.sectionIndex[C]]}getSections(){return this.sections}getSectionIndex(C){return this.sectionIndex[C]}getCodePoint(C){return this.text.codePointAt(C)}verticalizePunctuation(C){this.text=function(C,te){let le="";for(let ce=0;ce<C.length;ce++){const he=C.charCodeAt(ce+1)||null,ue=C.charCodeAt(ce-1)||null;le+=!te&&(he&&Gs(he)&&!Zg[C[ce+1]]||ue&&Gs(ue)&&!Zg[C[ce-1]])||!Zg[C[ce]]?C[ce]:Zg[C[ce]]}return le}(this.text,C)}trim(){let C=0;for(let te=0;te<this.text.length&&sy[this.text.charCodeAt(te)];te++)C++;let te=this.text.length;for(let le=this.text.length-1;le>=0&&le>=C&&sy[this.text.charCodeAt(le)];le--)te--;this.text=this.text.substring(C,te),this.sectionIndex=this.sectionIndex.slice(C,te)}substring(C,te){const le=new C_;return le.text=this.text.substring(C,te),le.sectionIndex=this.sectionIndex.slice(C,te),le.sections=this.sections,le}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((C,te)=>Math.max(C,this.sections[te].scale)),0)}addTextSection(C,te){this.text+=C.text,this.sections.push(I_.forText(C.scale,C.fontStack||te));const le=this.sections.length-1;for(let te=0;te<C.text.length;++te)this.sectionIndex.push(le)}addImageSection(C){const te=C.image?C.image.namePrimary:"";if(0===te.length)return void H("Can't add FormattedSection with an empty image.");const le=this.getNextImageSectionCharCode();le?(this.text+=String.fromCodePoint(le),this.sections.push(I_.forImage(te)),this.sectionIndex.push(this.sections.length-1)):H("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function z_(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe){const Ne=C_.fromFeature(C,he);Me===iy.vertical&&Ne.verticalizePunctuation(Ae);let je=[];const Ge=function(C,te,le,ce,he,ue){if(!C)return[];const de=[],_e=function(C,te,le,ce,he,ue){let de=0;for(let le=0;le<C.length();le++){const _e=C.getSection(le);de+=R_(C.getCodePoint(le),_e,ce,he,te,ue)}return de/Math.max(1,Math.ceil(de/le))}(C,te,le,ce,he,ue),ye=C.text.indexOf("")>=0;let ve=0;for(let le=0;le<C.length();le++){const Me=C.getSection(le),Ae=C.getCodePoint(le);if(sy[Ae]||(ve+=R_(Ae,Me,ce,he,te,ue)),le<C.length()-1){const te=!((Se=Ae)<11904||!(Cl["Bopomofo Extended"](Se)||Cl.Bopomofo(Se)||Cl["CJK Compatibility Forms"](Se)||Cl["CJK Compatibility Ideographs"](Se)||Cl["CJK Compatibility"](Se)||Cl["CJK Radicals Supplement"](Se)||Cl["CJK Strokes"](Se)||Cl["CJK Symbols and Punctuation"](Se)||Cl["CJK Unified Ideographs Extension A"](Se)||Cl["CJK Unified Ideographs"](Se)||Cl["Enclosed CJK Letters and Months"](Se)||Cl["Halfwidth and Fullwidth Forms"](Se)||Cl.Hiragana(Se)||Cl["Ideographic Description Characters"](Se)||Cl["Kangxi Radicals"](Se)||Cl["Katakana Phonetic Extensions"](Se)||Cl.Katakana(Se)||Cl["Vertical Forms"](Se)||Cl["Yi Radicals"](Se)||Cl["Yi Syllables"](Se)));(ay[Ae]||te||Me.imageName)&&de.push(O_(le+1,ve,_e,de,k_(Ae,C.getCodePoint(le+1),te&&ye),!1))}}var Se;return B_(O_(C.length(),ve,_e,de,0,!0))}(Ne,ve,ue,te,ce,Ce),{processBidirectionalText:Ze,processStyledBidirectionalText:qe}=lc;if(Ze&&1===Ne.sections.length){const C=Ze(Ne.toString(),Ge);for(const te of C){const C=new C_;C.text=te,C.sections=Ne.sections;for(let le=0;le<te.length;le++)C.sectionIndex.push(0);je.push(C)}}else if(qe){const C=qe(Ne.text,Ne.sectionIndex,Ge);for(const te of C){const C=new C_;C.text=te[0],C.sectionIndex=te[1],C.sections=Ne.sections,je.push(C)}}else je=function(C,te){const le=[],ce=C.text;let he=0;for(const ce of te)le.push(C.substring(he,ce)),he=ce;return he<ce.length&&le.push(C.substring(he,ce.length)),le}(Ne,Ge);const $e=[],He={positionedLines:$e,text:Ne.toString(),top:Se[1],bottom:Se[1],left:Se[0],right:Se[0],writingMode:Me,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me){let Ae=0,Ce=0,Oe=0;const Ne="right"===_e?1:"left"===_e?0:.5;let je=!1;for(const C of he){const le=C.getSections();for(const C of le){if(C.imageName)continue;const le=te[C.fontStack];if(le&&(je=void 0!==le.ascender&&void 0!==le.descender,!je))break}if(!je)break}let Ge=0;for(const de of he){de.trim();const he=de.getMaxScale(),_e=(he-1)*jg,qe={positionedGlyphs:[],lineOffset:0};C.positionedLines[Ge]=qe;const $e=qe.positionedGlyphs;let He=0;if(!de.length()){Ce+=ue,++Ge;continue}let We=0,Xe=0;for(let ue=0;ue<de.length();ue++){const _e=de.getSection(ue),Oe=de.getSectionIndex(ue),Ne=de.getCodePoint(ue);let Ge=_e.scale,qe=null,Ye=null,Je=null,Qe=jg,tt=0;const rt=!(ye===iy.horizontal||!Se&&!js(Ne)||Se&&(sy[Ne]||(Ze=Ne,Cl.Arabic(Ze)||Cl["Arabic Supplement"](Ze)||Cl["Arabic Extended-A"](Ze)||Cl["Arabic Presentation Forms-A"](Ze)||Cl["Arabic Presentation Forms-B"](Ze))));if(_e.imageName){const te=ce[_e.imageName];if(!te)continue;Je=_e.imageName,C.iconsInText=C.iconsInText||!0,Ye=te.paddedRect;const le=te.displaySize;Ge=Ge*jg/Me,qe={width:le[0],height:le[1],left:0,top:-Kg,advance:rt?le[1]:le[0],localGlyph:!1},tt=je?-qe.height*Ge:ry+he*jg-le[1]*Ge,Qe=qe.advance;const ue=(rt?le[0]:le[1])*Ge-jg*he;ue>0&&ue>He&&(He=ue)}else{const C=le[_e.fontStack];if(!C)continue;C[Ne]&&(Ye=C[Ne]);const ce=te[_e.fontStack];if(!ce)continue;const ue=ce.glyphs[Ne];if(!ue)continue;if(qe=ue.metrics,Qe=8203!==Ne?jg:0,je){const C=void 0!==ce.ascender?Math.abs(ce.ascender):0,te=void 0!==ce.descender?Math.abs(ce.descender):0,le=(C+te)*Ge;We<le&&(We=le,Xe=(C-te)/2*Ge),tt=-C*Ge}else tt=ry+(he-Ge)*jg}rt?(C.verticalizable=!0,$e.push({glyph:Ne,imageName:Je,x:Ae,y:Ce+tt,vertical:rt,scale:Ge,localGlyph:qe.localGlyph,fontStack:_e.fontStack,sectionIndex:Oe,metrics:qe,rect:Ye}),Ae+=Qe*Ge+ve):($e.push({glyph:Ne,imageName:Je,x:Ae,y:Ce+tt,vertical:rt,scale:Ge,localGlyph:qe.localGlyph,fontStack:_e.fontStack,sectionIndex:Oe,metrics:qe,rect:Ye}),Ae+=qe.advance*Ge+ve)}0!==$e.length&&(Oe=Math.max(Ae-ve,Oe),je?N_($e,Ne,He,Xe,ue*he/2):N_($e,Ne,He,0,ue/2)),Ae=0;const Ye=ue*he+He;qe.lineOffset=Math.max(He,_e),Ce+=Ye,++Ge}var Ze;const qe=Ce,{horizontalAlign:$e,verticalAlign:He}=F_(de);(function(C,te,le,ce,he,ue){const de=(te-le)*he,_e=-ue*ce;for(const te of C)for(const C of te.positionedGlyphs)C.x+=de,C.y+=_e})(C.positionedLines,Ne,$e,He,Oe,qe),C.top+=-He*qe,C.bottom=C.top+qe,C.left+=-$e*Oe,C.right=C.left+Oe,C.hasBaseline=je}(He,te,le,ce,je,de,_e,ye,Me,ve,Ae,Oe),!function(C){for(const te of C)if(0!==te.positionedGlyphs.length)return!1;return!0}($e)&&He}const sy={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},ay={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function R_(C,te,le,ce,he,ue){if(te.imageName){const C=ce[te.imageName];return C?C.displaySize[0]*te.scale*jg/ue+he:0}{const ce=le[te.fontStack],ue=ce&&ce.glyphs[C];return ue?ue.metrics.advance*te.scale+he:0}}function L_(C,te,le,ce){const he=Math.pow(C-te,2);return ce?C<te?he/2:2*he:he+Math.abs(le)*le}function k_(C,te,le){let ce=0;return 10===C&&(ce-=1e4),le&&(ce+=150),40!==C&&65288!==C||(ce+=50),41!==te&&65289!==te||(ce+=50),ce}function O_(C,te,le,ce,he,ue){let de=null,_e=L_(te,le,he,ue);for(const C of ce){const ce=L_(te-C.x,le,he,ue)+C.badness;ce<=_e&&(de=C,_e=ce)}return{index:C,x:te,priorBreak:de,badness:_e}}function B_(C){return C?B_(C.priorBreak).concat(C.index):[]}function F_(C){let te=.5,le=.5;switch(C){case"right":case"top-right":case"bottom-right":te=1;break;case"left":case"top-left":case"bottom-left":te=0}switch(C){case"bottom":case"bottom-right":case"bottom-left":le=1;break;case"top":case"top-right":case"top-left":le=0}return{horizontalAlign:te,verticalAlign:le}}function N_(C,te,le,ce,he){if(!(te||le||ce||he))return;const ue=C.length-1,de=C[ue],_e=(de.x+de.metrics.advance*de.scale)*te;for(let te=0;te<=ue;te++)C[te].x-=_e,C[te].y+=le+ce+he}function U_(C,te,le,ce){const{horizontalAlign:he,verticalAlign:ue}=F_(ce),de=le[0]-C.displaySize[0]*he,_e=le[1]-C.displaySize[1]*ue;return{imagePrimary:C,imageSecondary:te,top:_e,bottom:_e+C.displaySize[1],left:de,right:de+C.displaySize[0]}}function V_(C,te,le,ce,he,ue){const de=C.imagePrimary;let _e;if(de.content){const C=de.content,te=de.pixelRatio||1;_e=[C[0]/te,C[1]/te,de.displaySize[0]-C[2]/te,de.displaySize[1]-C[3]/te]}const ye=te.left*ue,ve=te.right*ue;let Se,Me,Ae,Ce;"width"===le||"both"===le?(Ce=he[0]+ye-ce[3],Me=he[0]+ve+ce[1]):(Ce=he[0]+(ye+ve-de.displaySize[0])/2,Me=Ce+de.displaySize[0]);const Oe=te.top*ue,Ne=te.bottom*ue;return"height"===le||"both"===le?(Se=he[1]+Oe-ce[0],Ae=he[1]+Ne+ce[2]):(Se=he[1]+(Oe+Ne-de.displaySize[1])/2,Ae=Se+de.displaySize[1]),{imagePrimary:de,imageSecondary:void 0,top:Se,right:Me,bottom:Ae,left:Ce,collisionPadding:_e}}class j_ extends je{constructor(C,te,le,ce,he){super(C,te),this.angle=ce,this.z=le,void 0!==he&&(this.segment=he)}clone(){return new j_(this.x,this.y,this.z,this.angle,this.segment)}}function G_(C,te,le,ce,he){if(void 0===te.segment)return!0;let ue=te,de=te.segment+1,_e=0;for(;_e>-le/2;){if(de--,de<0)return!1;_e-=C[de].dist(ue),ue=C[de]}_e+=C[de].dist(C[de+1]),de++;const ye=[];let ve=0;for(;_e<le/2;){const te=C[de],le=C[de+1];if(!le)return!1;let ue=C[de-1].angleTo(te)-te.angleTo(le);for(ue=Math.abs((ue+3*Math.PI)%(2*Math.PI)-Math.PI),ye.push({distance:_e,angleDelta:ue}),ve+=ue;_e-ye[0].distance>ce;)ve-=ye.shift().angleDelta;if(ve>he)return!1;de++,_e+=te.dist(le)}return!0}function q_(C){let te=0;for(let le=0;le<C.length-1;le++)te+=C[le].dist(C[le+1]);return te}function Z_(C,te,le){return C?.6*te*le:0}function $_(C,te){return Math.max(C?C.right-C.left:0,te?te.right-te.left:0)}function W_(C,te,le,ce,he,ue){const de=Z_(le,he,ue),_e=$_(le,ce)*ue;let ye=0;const ve=q_(C)/2;for(let le=0;le<C.length-1;le++){const ce=C[le],he=C[le+1],ue=ce.dist(he);if(ye+ue>ve){const Se=(ve-ye)/ue,Me=Kr(ce.x,he.x,Se),Ae=Kr(ce.y,he.y,Se),Ce=new j_(Me,Ae,0,he.angleTo(ce),le);return!de||G_(C,Ce,_e,de,te)?Ce:void 0}ye+=ue}}function H_(C,te,le,ce,he,ue,de,_e,ye){const ve=Z_(ce,ue,de),Se=$_(ce,he),Me=Se*de,Ae=0===C[0].x||C[0].x===ye||0===C[0].y||C[0].y===ye;return te-Me<te/4&&(te=Me+te/4),X_(C,Ae?te/2*_e%te:(Se/2+2*ue)*de*_e%te,te,ve,le,Me,Ae,!1,ye)}function X_(C,te,le,ce,he,ue,de,_e,ye){const ve=ue/2,Se=q_(C);let Me=0,Ae=te-le,Ce=[];for(let te=0;te<C.length-1;te++){const de=C[te],_e=C[te+1],Oe=de.dist(_e),Ne=_e.angleTo(de);for(;Ae+le<Me+Oe;){Ae+=le;const je=(Ae-Me)/Oe,Ge=Kr(de.x,_e.x,je),Ze=Kr(de.y,_e.y,je);if(Ge>=0&&Ge<ye&&Ze>=0&&Ze<ye&&Ae-ve>=0&&Ae+ve<=Se){const le=new j_(Ge,Ze,0,Ne,te);ce&&!G_(C,le,ue,ce,he)||Ce.push(le)}}Me+=Oe}return _e||Ce.length||de||(Ce=X_(C,Me/2,le,ce,he,ue,de,!0,ye)),Ce}function Y_(C,te,le,ce,he){const ue=[];for(let de=0;de<C.length;de++){const _e=C[de];let ye;for(let C=0;C<_e.length-1;C++){let de=_e[C],ve=_e[C+1];de.x<te&&ve.x<te||(de.x<te?de=new je(te,de.y+(te-de.x)/(ve.x-de.x)*(ve.y-de.y))._round():ve.x<te&&(ve=new je(te,de.y+(te-de.x)/(ve.x-de.x)*(ve.y-de.y))._round()),de.y<le&&ve.y<le||(de.y<le?de=new je(de.x+(le-de.y)/(ve.y-de.y)*(ve.x-de.x),le)._round():ve.y<le&&(ve=new je(de.x+(le-de.y)/(ve.y-de.y)*(ve.x-de.x),le)._round()),de.x>=ce&&ve.x>=ce||(de.x>=ce?de=new je(ce,de.y+(ce-de.x)/(ve.x-de.x)*(ve.y-de.y))._round():ve.x>=ce&&(ve=new je(ce,de.y+(ce-de.x)/(ve.x-de.x)*(ve.y-de.y))._round()),de.y>=he&&ve.y>=he||(de.y>=he?de=new je(de.x+(he-de.y)/(ve.y-de.y)*(ve.x-de.x),he)._round():ve.y>=he&&(ve=new je(de.x+(he-de.y)/(ve.y-de.y)*(ve.x-de.x),he)._round()),ye&&de.equals(ye[ye.length-1])||(ye=[de],ue.push(ye)),ye.push(ve)))))}}return ue}function K_(C){let te=0,le=0;for(const ce of C)te+=ce.w*ce.h,le=Math.max(le,ce.w);C.sort(((C,te)=>te.h-C.h));const ce=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(te/.95)),le),h:1/0}];let he=0,ue=0;for(const te of C)for(let C=ce.length-1;C>=0;C--){const le=ce[C];if(!(te.w>le.w||te.h>le.h)){if(te.x=le.x,te.y=le.y,ue=Math.max(ue,te.y+te.h),he=Math.max(he,te.x+te.w),te.w===le.w&&te.h===le.h){const te=ce.pop();C<ce.length&&(ce[C]=te)}else te.h===le.h?(le.x+=te.w,le.w-=te.w):te.w===le.w?(le.y+=te.h,le.h-=te.h):(ce.push({x:le.x+te.w,y:le.y,w:le.w-te.w,h:te.h}),le.y+=te.h,le.h-=te.h);break}}return{w:he,h:ue,fill:te/(he*ue)||0}}Rs(j_,"Anchor");const gy=1;class Q_{constructor(C,{pixelRatio:te,version:le,stretchX:ce,stretchY:he,content:ue}){this.paddedRect=C,this.pixelRatio=te,this.stretchX=ce,this.stretchY=he,this.content=ue,this.version=le}get tl(){return[this.paddedRect.x+gy,this.paddedRect.y+gy]}get br(){return[this.paddedRect.x+this.paddedRect.w-gy,this.paddedRect.y+this.paddedRect.h-gy]}get displaySize(){return[(this.paddedRect.w-2*gy)/this.pixelRatio,(this.paddedRect.h-2*gy)/this.pixelRatio]}}class eg{constructor(C,te){const le={},ce={};this.haveRenderCallbacks=[];const he=[];this.addImages(C,le,he),this.addImages(te,ce,he);const{w:ue,h:de}=K_(he),_e=new ef({width:ue||1,height:de||1});for(const te in C){const ce=C[te],he=le[te].paddedRect;ef.copy(ce.data,_e,{x:0,y:0},{x:he.x+gy,y:he.y+gy},ce.data)}for(const C in te){const le=te[C],he=ce[C].paddedRect,ue=he.x+gy,de=he.y+gy,ye=le.data.width,ve=le.data.height;ef.copy(le.data,_e,{x:0,y:0},{x:ue,y:de},le.data),ef.copy(le.data,_e,{x:0,y:ve-1},{x:ue,y:de-1},{width:ye,height:1}),ef.copy(le.data,_e,{x:0,y:0},{x:ue,y:de+ve},{width:ye,height:1}),ef.copy(le.data,_e,{x:ye-1,y:0},{x:ue-1,y:de},{width:1,height:ve}),ef.copy(le.data,_e,{x:0,y:0},{x:ue+ye,y:de},{width:1,height:ve})}this.image=_e,this.iconPositions=le,this.patternPositions=ce}addImages(C,te,le){for(const ce in C){const he=C[ce],ue={x:0,y:0,w:he.data.width+2*gy,h:he.data.height+2*gy};le.push(ue),te[ce]=new Q_(ue,he),he.hasRenderCallback&&this.haveRenderCallbacks.push(ce)}}patchUpdatedImages(C,te,le){this.haveRenderCallbacks=this.haveRenderCallbacks.filter((te=>C.hasImage(te,le))),C.dispatchRenderCallbacks(this.haveRenderCallbacks,le);for(const ce in C.getUpdatedImages(le))this.patchUpdatedImage(this.iconPositions[ce],C.getImage(ce,le),te),this.patchUpdatedImage(this.patternPositions[ce],C.getImage(ce,le),te)}patchUpdatedImage(C,te,le){if(!C||!te)return;if(C.version===te.version)return;C.version=te.version;const[ce,he]=C.tl;le.update(te.data,void 0,{x:ce,y:he})}}Rs(Q_,"ImagePosition"),Rs(eg,"ImageAtlas");const yy=1e20;function ig(C,te,le,ce,he,ue,de,_e,ye){for(let ve=te;ve<te+ce;ve++)rg(C,le*ue+ve,ue,he,de,_e,ye);for(let ve=le;ve<le+he;ve++)rg(C,ve*ue+te,1,ce,de,_e,ye)}function rg(C,te,le,ce,he,ue,de){ue[0]=0,de[0]=-yy,de[1]=yy,he[0]=C[te];for(let _e=1,ye=0,ve=0;_e<ce;_e++){he[_e]=C[te+_e*le];const ce=_e*_e;do{const C=ue[ye];ve=(he[_e]-he[C]+ce-C*C)/(_e-C)/2}while(ve<=de[ye]&&--ye>-1);ye++,ue[ye]=_e,de[ye]=ve,de[ye+1]=yy}for(let _e=0,ye=0;_e<ce;_e++){for(;de[ye+1]<_e;)ye++;const ce=ue[ye],ve=_e-ce;C[te+_e*le]=he[ce]+ve*ve}}const xy=2;class og{constructor(C,te,le){this.requestManager=C,this.localGlyphMode=te,this.localFontFamily=le,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(C,te){this.urls[te]=C}getGlyphs(C,te,le){const ce=[],he=this.urls[te]||de.GLYPHS_URL;for(const te in C)for(const le of C[te])ce.push({stack:te,id:le});R(ce,(({stack:C,id:te},le)=>{let ce=this.entries[C];ce||(ce=this.entries[C]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let ue=ce.glyphs[te];if(void 0!==ue)return void le(null,{stack:C,id:te,glyph:ue});if(ue=this._tinySDF(ce,C,te),ue)return ce.glyphs[te]=ue,void le(null,{stack:C,id:te,glyph:ue});const de=Math.floor(te/256);if(256*de>65535)return void le(new Error("glyphs > 65535 not supported"));if(ce.ranges[de])return void le(null,{stack:C,id:te,glyph:ue});let _e=ce.requests[de];_e||(_e=ce.requests[de]=[],og.loadGlyphRange(C,de,he,this.requestManager,((C,te)=>{if(te){ce.ascender=te.ascender,ce.descender=te.descender;for(const C in te.glyphs)this._doesCharSupportLocalGlyph(+C)||(ce.glyphs[+C]=te.glyphs[+C]);ce.ranges[de]=!0}for(const le of _e)le(C,te);delete ce.requests[de]}))),_e.push(((ce,he)=>{ce?le(ce):he&&le(null,{stack:C,id:te,glyph:he.glyphs[te]||null})}))}),((C,te)=>{if(C)le(C);else if(te){const C={};for(const{stack:le,id:ce,glyph:he}of te)void 0===C[le]&&(C[le]={}),void 0===C[le].glyphs&&(C[le].glyphs={}),C[le].glyphs[ce]=he&&{id:he.id,bitmap:he.bitmap.clone(),metrics:he.metrics},C[le].ascender=this.entries[le].ascender,C[le].descender=this.entries[le].descender;le(null,C)}}))}_doesCharSupportLocalGlyph(C){return 0!==this.localGlyphMode&&(2===this.localGlyphMode?!!this.localFontFamily:!!this.localFontFamily&&(Cl["CJK Unified Ideographs"](C)||Cl["Hangul Syllables"](C)||Cl.Hiragana(C)||Cl.Katakana(C)||Cl["CJK Symbols and Punctuation"](C)||Cl["CJK Unified Ideographs Extension A"](C)||Cl["CJK Unified Ideographs Extension B"](C)))}_tinySDF(C,te,le){const ce=this.localFontFamily;if(!ce||!this._doesCharSupportLocalGlyph(le))return;let he=C.tinySDF;if(!he){let le="400";/bold/i.test(te)?le="900":/medium/i.test(te)?le="500":/light/i.test(te)&&(le="200"),he=C.tinySDF=new og.TinySDF({fontFamily:ce,fontWeight:le,fontSize:24*xy,buffer:3*xy,radius:8*xy}),he.fontWeight=le}if(this.localGlyphs[he.fontWeight][le])return this.localGlyphs[he.fontWeight][le];const ue=String.fromCodePoint(le),{data:de,width:_e,height:ye,glyphWidth:ve,glyphHeight:Se,glyphLeft:Me,glyphTop:Ae,glyphAdvance:Ce}=he.draw(ue);return this.localGlyphs[he.fontWeight][le]={id:le,bitmap:new Qp({width:_e,height:ye},de),metrics:{width:ve/xy,height:Se/xy,left:Me/xy,top:Ae/xy-27,advance:Ce/xy,localGlyph:!0}}}}og.loadGlyphRange=function(C,te,le,ce,he){const ue=256*te,de=ue+255,_e=ce.transformRequest(ce.normalizeGlyphsURL(le).replace("{fontstack}",C).replace("{range}",`${ue}-${de}`),st.Glyphs);Te(_e,((C,te)=>{if(C)he(C);else if(te){const C={},le=function(C){return new J_(C).readFields(w_,{})}(te);for(const te of le.glyphs)C[te.id]=te;he(null,{glyphs:C,ascender:le.ascender,descender:le.descender})}}))},og.TinySDF=class{constructor({fontSize:C=24,buffer:te=3,radius:le=8,cutoff:ce=.25,fontFamily:he="sans-serif",fontWeight:ue="normal",fontStyle:de="normal"}={}){this.buffer=te,this.cutoff=ce,this.radius=le;const _e=this.size=C+4*te,ye=this._createCanvas(_e),ve=this.ctx=ye.getContext("2d",{willReadFrequently:!0});ve.font=`${de} ${ue} ${C}px ${he}`,ve.textBaseline="alphabetic",ve.textAlign="left",ve.fillStyle="black",this.gridOuter=new Float64Array(_e*_e),this.gridInner=new Float64Array(_e*_e),this.f=new Float64Array(_e),this.z=new Float64Array(_e+1),this.v=new Uint16Array(_e)}_createCanvas(C){const te=document.createElement("canvas");return te.width=te.height=C,te}draw(C){const{width:te,actualBoundingBoxAscent:le,actualBoundingBoxDescent:ce,actualBoundingBoxLeft:he,actualBoundingBoxRight:ue}=this.ctx.measureText(C),de=Math.ceil(le),_e=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(ue-he))),ye=Math.min(this.size-this.buffer,de+Math.ceil(ce)),ve=_e+2*this.buffer,Se=ye+2*this.buffer,Me=Math.max(ve*Se,0),Ae=new Uint8ClampedArray(Me),Ce={data:Ae,width:ve,height:Se,glyphWidth:_e,glyphHeight:ye,glyphTop:de,glyphLeft:0,glyphAdvance:te};if(0===_e||0===ye)return Ce;const{ctx:Oe,buffer:Ne,gridInner:je,gridOuter:Ge}=this;Oe.clearRect(Ne,Ne,_e,ye),Oe.fillText(C,Ne,Ne+de);const Ze=Oe.getImageData(Ne,Ne,_e,ye);Ge.fill(yy,0,Me),je.fill(0,0,Me);for(let C=0;C<ye;C++)for(let te=0;te<_e;te++){const le=Ze.data[4*(C*_e+te)+3]/255;if(0===le)continue;const ce=(C+Ne)*ve+te+Ne;if(1===le)Ge[ce]=0,je[ce]=yy;else{const C=.5-le;Ge[ce]=C>0?C*C:0,je[ce]=C<0?C*C:0}}ig(Ge,0,0,ve,Se,ve,this.f,this.v,this.z),ig(je,Ne,Ne,_e,ye,ve,this.f,this.v,this.z);for(let C=0;C<Me;C++){const te=Math.sqrt(Ge[C])-Math.sqrt(je[C]);Ae[C]=Math.round(255-255*(te/this.radius+this.cutoff))}return Ce}};const vy=gy;function ag(C,te,le,ce){const he=[],ue=C.imagePrimary,de=ue.pixelRatio,_e=ue.paddedRect.w-2*vy,ye=ue.paddedRect.h-2*vy,ve=C.right-C.left,Se=C.bottom-C.top,Me=ue.stretchX||[[0,_e]],Ae=ue.stretchY||[[0,ye]],p=(C,te)=>C+te[1]-te[0],Ce=Me.reduce(p,0),Oe=Ae.reduce(p,0),Ne=_e-Ce,Ge=ye-Oe;let Ze=0,qe=Ce,$e=0,He=Oe,We=0,Xe=Ne,Ye=0,Je=Ge;if(ue.content&&ce){const C=ue.content;Ze=lg(Me,0,C[0]),$e=lg(Ae,0,C[1]),qe=lg(Me,C[0],C[2]),He=lg(Ae,C[1],C[3]),We=C[0]-Ze,Ye=C[1]-$e,Xe=C[2]-C[0]-qe,Je=C[3]-C[1]-He}const S=(ce,he,_e,ye)=>{const Me=hg(ce.stretch-Ze,qe,ve,C.left),Ae=ug(ce.fixed-We,Xe,ce.stretch,Ce),Ne=hg(he.stretch-$e,He,Se,C.top),Ge=ug(he.fixed-Ye,Je,he.stretch,Oe),Qe=hg(_e.stretch-Ze,qe,ve,C.left),tt=ug(_e.fixed-We,Xe,_e.stretch,Ce),rt=hg(ye.stretch-$e,He,Se,C.top),ot=ug(ye.fixed-Ye,Je,ye.stretch,Oe),st=new je(Me,Ne),at=new je(Qe,Ne),lt=new je(Qe,rt),ct=new je(Me,rt),ht=new je(Ae/de,Ge/de),dt=new je(tt/de,ot/de),mt=te*Math.PI/180;if(mt){const C=Math.sin(mt),te=Math.cos(mt),le=[te,-C,C,te];st._matMult(le),at._matMult(le),ct._matMult(le),lt._matMult(le)}const _t=ce.stretch+ce.fixed,gt=_e.stretch+_e.fixed,Pt=he.stretch+he.fixed,Ft=ye.stretch+ye.fixed,jt=C.imageSecondary;return{tl:st,tr:at,bl:ct,br:lt,texPrimary:{x:ue.paddedRect.x+vy+_t,y:ue.paddedRect.y+vy+Pt,w:gt-_t,h:Ft-Pt},texSecondary:jt?{x:jt.paddedRect.x+vy+_t,y:jt.paddedRect.y+vy+Pt,w:gt-_t,h:Ft-Pt}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:ht,pixelOffsetBR:dt,minFontScaleX:Xe/de/ve,minFontScaleY:Je/de/Se,isSDF:le}};if(ce&&(ue.stretchX||ue.stretchY)){const C=cg(Me,Ne,Ce),te=cg(Ae,Ge,Oe);for(let le=0;le<C.length-1;le++){const ce=C[le],ue=C[le+1];for(let C=0;C<te.length-1;C++)he.push(S(ce,te[C],ue,te[C+1]))}}else he.push(S({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:_e+1},{fixed:0,stretch:ye+1}));return he}function lg(C,te,le){let ce=0;for(const he of C)ce+=Math.max(te,Math.min(le,he[1]))-Math.max(te,Math.min(le,he[0]));return ce}function cg(C,te,le){const ce=[{fixed:-vy,stretch:0}];for(const[te,le]of C){const C=ce[ce.length-1];ce.push({fixed:te-C.stretch,stretch:C.stretch}),ce.push({fixed:te-C.stretch,stretch:C.stretch+(le-te)})}return ce.push({fixed:te+vy,stretch:le}),ce}function hg(C,te,le,ce){return C/te*le+ce}function ug(C,te,le,ce){return C-te*le/ce}function dg(C,te,le,ce){const he=te+C.positionedLines[ce].lineOffset;return 0===ce?le+he/2:le+(he+(te+C.positionedLines[ce-1].lineOffset))/2}function pg(C,te=1,le=!1){let ce=1/0,he=1/0,ue=-1/0,de=-1/0;const _e=C[0];for(let C=0;C<_e.length;C++){const te=_e[C];(!C||te.x<ce)&&(ce=te.x),(!C||te.y<he)&&(he=te.y),(!C||te.x>ue)&&(ue=te.x),(!C||te.y>de)&&(de=te.y)}const ye=Math.min(ue-ce,de-he);let ve=ye/2;const Se=new Sn([],fg);if(0===ye)return new je(ce,he);for(let te=ce;te<ue;te+=ye)for(let le=he;le<de;le+=ye)Se.push(new mg(te+ve,le+ve,ve,C));let Me=function(C){let te=0,le=0,ce=0;const he=C[0];for(let C=0,ue=he.length,de=ue-1;C<ue;de=C++){const ue=he[C],_e=he[de],ye=ue.x*_e.y-_e.x*ue.y;le+=(ue.x+_e.x)*ye,ce+=(ue.y+_e.y)*ye,te+=3*ye}return new mg(le/te,ce/te,0,C)}(C),Ae=Se.length;for(;Se.length;){const ce=Se.pop();(ce.d>Me.d||!Me.d)&&(Me=ce,le&&console.log("found best %d after %d probes",Math.round(1e4*ce.d)/1e4,Ae)),ce.max-Me.d<=te||(ve=ce.h/2,Se.push(new mg(ce.p.x-ve,ce.p.y-ve,ve,C)),Se.push(new mg(ce.p.x+ve,ce.p.y-ve,ve,C)),Se.push(new mg(ce.p.x-ve,ce.p.y+ve,ve,C)),Se.push(new mg(ce.p.x+ve,ce.p.y+ve,ve,C)),Ae+=4)}return le&&(console.log(`num probes: ${Ae}`),console.log(`best distance: ${Me.d}`)),Me.p}function fg(C,te){return te.max-C.max}class mg{constructor(C,te,le,ce){this.p=new je(C,te),this.h=le,this.d=function(C,te){let le=!1,ce=1/0;for(let he=0;he<te.length;he++){const ue=te[he];for(let te=0,he=ue.length,de=he-1;te<he;de=te++){const he=ue[te],_e=ue[de];he.y>C.y!=_e.y>C.y&&C.x<(_e.x-he.x)*(C.y-he.y)/(_e.y-he.y)+he.x&&(le=!le),ce=Math.min(ce,Ip(C,he,_e))}}return(le?1:-1)*Math.sqrt(ce)}(this.p,ce),this.max=this.d+this.h*Math.SQRT2}}const by=7,wy=Number.POSITIVE_INFINITY,Ty=Math.sqrt(2);function xg(C,[te,le]){let ce=0,he=0;if(le===wy){te<0&&(te=0);const le=te/Ty;switch(C){case"top-right":case"top-left":he=le-by;break;case"bottom-right":case"bottom-left":he=-le+by;break;case"bottom":he=-te+by;break;case"top":he=te-by}switch(C){case"top-right":case"bottom-right":ce=-le;break;case"top-left":case"bottom-left":ce=le;break;case"left":ce=te;break;case"right":ce=-te}}else{switch(te=Math.abs(te),le=Math.abs(le),C){case"top-right":case"top-left":case"top":he=le-by;break;case"bottom-right":case"bottom-left":case"bottom":he=-le+by}switch(C){case"top-right":case"bottom-right":case"right":ce=-te;break;case"top-left":case"bottom-left":case"left":ce=te}}return[ce,he]}function vg(C,te,le,ce,he,ue,de,_e,ye,ve,Se){C.createArrays(),C.tilePixelRatio=Mn/(512*C.overscaling),C.compareText={},C.iconsNeedLinear=!1;const Me=C.layers[0].layout,Ae=C.layers[0]._unevaluatedLayout._values,Ce={};if("composite"===C.textSizeData.kind){const{minZoom:te,maxZoom:le}=C.textSizeData;Ce.compositeTextSizes=[Ae["text-size"].possiblyEvaluate(new oa(te),_e),Ae["text-size"].possiblyEvaluate(new oa(le),_e)]}if("composite"===C.iconSizeData.kind){const{minZoom:te,maxZoom:le}=C.iconSizeData;Ce.compositeIconSizes=[Ae["icon-size"].possiblyEvaluate(new oa(te),_e),Ae["icon-size"].possiblyEvaluate(new oa(le),_e)]}Ce.layoutTextSize=Ae["text-size"].possiblyEvaluate(new oa(ye+1),_e),Ce.layoutIconSize=Ae["icon-size"].possiblyEvaluate(new oa(ye+1),_e),Ce.textMaxSize=Ae["text-size"].possiblyEvaluate(new oa(18),_e);const Oe="map"===Me.get("text-rotation-alignment")&&"point"!==Me.get("symbol-placement"),Ne=Me.get("text-size");let je=!1;for(const te of C.features)if(te.icon&&te.icon.nameSecondary){je=!0;break}for(const ue of C.features){const ye=Me.get("text-font").evaluate(ue,{},_e).join(","),Ae=Ne.evaluate(ue,{},_e),Ge=Ce.layoutTextSize.evaluate(ue,{},_e),Ze=(Ce.layoutIconSize.evaluate(ue,{},_e),{horizontal:{},vertical:void 0}),qe=ue.text;let $e,He=[0,0];if(qe){const ce=qe.toString(),de=Me.get("text-letter-spacing").evaluate(ue,{},_e)*jg,ve=Me.get("text-line-height").evaluate(ue,{},_e)*jg,Se=Us(ce)?de:0,Ce=Me.get("text-anchor").evaluate(ue,{},_e),Ne=Me.get("text-variable-anchor");if(!Ne){const C=Me.get("text-radial-offset").evaluate(ue,{},_e);He=C?xg(Ce,[C*jg,wy]):Me.get("text-offset").evaluate(ue,{},_e).map((C=>C*jg))}let je=Oe?"center":Me.get("text-justify").evaluate(ue,{},_e);const $e="point"===Me.get("symbol-placement"),We=$e?Me.get("text-max-width").evaluate(ue,{},_e)*jg:1/0,T=ue=>{C.allowVerticalPlacement&&Ns(ce)&&(Ze.vertical=z_(qe,te,le,he,ye,We,ve,Ce,ue,Se,He,iy.vertical,!0,Ge,Ae))};if(!Oe&&Ne){const C="auto"===je?Ne.map((C=>bg(C))):[je];let ce=!1;for(let ue=0;ue<C.length;ue++){const de=C[ue];if(!Ze.horizontal[de])if(ce)Ze.horizontal[de]=Ze.horizontal[0];else{const C=z_(qe,te,le,he,ye,We,ve,"center",de,Se,He,iy.horizontal,!1,Ge,Ae);C&&(Ze.horizontal[de]=C,ce=1===C.positionedLines.length)}}T("left")}else{if("auto"===je&&(je=bg(Ce)),$e||Me.get("text-writing-mode").indexOf("horizontal")>=0||!Ns(ce)){const C=z_(qe,te,le,he,ye,We,ve,Ce,je,Se,He,iy.horizontal,!1,Ge,Ae);C&&(Ze.horizontal[je]=C)}T($e?"left":je)}}let We=!1;if(ue.icon&&ue.icon.namePrimary){const te=ce[ue.icon.namePrimary];te&&($e=U_(he[ue.icon.namePrimary],ue.icon.nameSecondary?he[ue.icon.nameSecondary]:void 0,Me.get("icon-offset").evaluate(ue,{},_e),Me.get("icon-anchor").evaluate(ue,{},_e)),We=te.sdf,void 0===C.sdfIcons?C.sdfIcons=te.sdf:C.sdfIcons!==te.sdf&&H("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(te.pixelRatio!==C.pixelRatio||0!==Me.get("icon-rotate").constantOr(1))&&(C.iconsNeedLinear=!0))}const Xe=Ag(Ze.horizontal)||Ze.vertical;C.iconsInText||(C.iconsInText=!!Xe&&Xe.iconsInText),(Xe||$e)&&wg(C,ue,Ze,$e,ce,Ce,Ge,0,He,We,de,_e,ve,Se,je)}ue&&C.generateCollisionDebugBuffers(ye,C.collisionBoxArray)}function bg(C){switch(C){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function wg(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe){let Ne=ue.textMaxSize.evaluate(te,{},Me);void 0===Ne&&(Ne=de);const je=C.layers[0].layout,Ge=je.get("icon-offset").evaluate(te,{},Me),Ze=Ag(le.horizontal)||le.vertical,qe="globe"===Ae.name,$e=jg,He=de/$e,We=C.tilePixelRatio*Ne/$e,Xe=(at=C.overscaling,C.zoom>18&&at>2&&(at>>=1),Math.max(Mn/(512*at),1)*je.get("symbol-spacing")),Ye=je.get("text-padding")*C.tilePixelRatio,Je=je.get("icon-padding")*C.tilePixelRatio,Qe=w(je.get("text-max-angle")),tt="map"===je.get("text-rotation-alignment")&&"point"!==je.get("symbol-placement"),rt="map"===je.get("icon-rotation-alignment")&&"point"!==je.get("symbol-placement"),ot=je.get("symbol-placement"),st=Xe/2;var at;const lt=je.get("icon-text-fit").evaluate(te,{},Me),ct=je.get("icon-text-fit-padding").evaluate(te,{},Me),ht="none"!==lt;let dt;!1===C.hasAnyIconTextFit&&ht&&(C.hasAnyIconTextFit=!0),ce&&ht&&(C.allowVerticalPlacement&&le.vertical&&(dt=V_(ce,le.vertical,lt,ct,Ge,He)),Ze&&(ce=V_(ce,Ze,lt,ct,Ge,He)));const B=(de,_e,Ne)=>{if(_e.x<0||_e.x>=Mn||_e.y<0||_e.y>=Mn)return;let je=null;if(qe){const{x:C,y:te,z:le}=Ae.projectTilePoint(_e.x,_e.y,Ne);je={anchor:new j_(C,te,le,0,void 0),up:Ae.upVector(Ne,_e.x,_e.y)}}!function(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne,je,Ge,Ze,qe,$e,He,We,Xe,Ye,Je,Qe){const tt=C.addToLineVertexArray(te,ce);let rt,ot,st,at,lt,ct,ht,dt=0,mt=0,_t=0,gt=0,Pt=-1,Ft=-1;const jt={};let Ut=Gc("");const Vt=le?le.anchor:te,Gt="none"!==ye.layout.get("icon-text-fit").evaluate($e,{},Ye);let Zt=0,qt=0;if(void 0===ye._unevaluatedLayout.getValue("text-radial-offset")?[Zt,qt]=ye.layout.get("text-offset").evaluate($e,{},Ye).map((C=>C*jg)):(Zt=ye.layout.get("text-radial-offset").evaluate($e,{},Ye)*jg,qt=wy),C.allowVerticalPlacement&&he.vertical){const C=he.vertical;if(Oe)ct=Ig(C),_e&&(ht=Ig(_e));else{const le=ye.layout.get("text-rotate").evaluate($e,{},Ye)+90;st=Sg(ve,Vt,te,Se,Me,Ae,C,Ce,le,Ne),_e&&(at=Sg(ve,Vt,te,Se,Me,Ae,_e,Ge,le))}}if(ue){const ce=ye.layout.get("icon-rotate").evaluate($e,{},Ye),he=ag(ue,ce,We,Gt),de=_e?ag(_e,ce,We,Gt):void 0;ot=Sg(ve,Vt,te,Se,Me,Ae,ue,Ge,ce),dt=4*he.length;const Ce=C.iconSizeData;let Oe=null;"source"===Ce.kind?(Oe=[Ug*ye.layout.get("icon-size").evaluate($e,{},Ye)],Oe[0]>Iy&&H(`${C.layerIds[0]}: Value for "icon-size" is >= ${Sy}. Reduce your "icon-size".`)):"composite"===Ce.kind&&(Oe=[Ug*He.compositeIconSizes[0].evaluate($e,{},Ye),Ug*He.compositeIconSizes[1].evaluate($e,{},Ye)],(Oe[0]>Iy||Oe[1]>Iy)&&H(`${C.layerIds[0]}: Value for "icon-size" is >= ${Sy}. Reduce your "icon-size".`)),C.addSymbols(C.icon,he,Oe,qe,Ze,$e,!1,le,te,tt.lineStartIndex,tt.lineLength,-1,Xe,Ye,Je,Qe),Pt=C.icon.placedSymbolArray.length-1,de&&(mt=4*de.length,C.addSymbols(C.icon,de,Oe,qe,Ze,$e,iy.vertical,le,te,tt.lineStartIndex,tt.lineLength,-1,Xe,Ye,Je,Qe),Ft=C.icon.placedSymbolArray.length-1)}for(const ce in he.horizontal){const ue=he.horizontal[ce];rt||(Ut=Gc(ue.text),Oe?lt=Ig(ue):rt=Sg(ve,Vt,te,Se,Me,Ae,ue,Ce,ye.layout.get("text-rotate").evaluate($e,{},Ye),Ne));const _e=1===ue.positionedLines.length;if(_t+=Mg(C,le,te,ue,de,ye,Oe,$e,Ne,tt,he.vertical?iy.horizontal:iy.horizontalOnly,_e?Object.keys(he.horizontal):[ce],jt,Pt,He,Xe,Ye,Je),_e)break}he.vertical&&(gt+=Mg(C,le,te,he.vertical,de,ye,Oe,$e,Ne,tt,iy.vertical,["vertical"],jt,Ft,He,Xe,Ye,Je));let $t=-1;const X=(C,te)=>C?Math.max(C,te):te;$t=X(lt,$t),$t=X(ct,$t),$t=X(ht,$t);const Ht=$t>-1?1:0;C.glyphOffsetArray.length>=Nx.MAX_GLYPHS&&H("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==$e.sortKey&&C.addToSortKeyRanges(C.symbolInstances.length,$e.sortKey),C.symbolInstances.emplaceBack(te.x,te.y,Vt.x,Vt.y,Vt.z,jt.right>=0?jt.right:-1,jt.center>=0?jt.center:-1,jt.left>=0?jt.left:-1,jt.vertical>=0?jt.vertical:-1,Pt,Ft,Ut,void 0!==rt?rt:C.collisionBoxArray.length,void 0!==rt?rt+1:C.collisionBoxArray.length,void 0!==st?st:C.collisionBoxArray.length,void 0!==st?st+1:C.collisionBoxArray.length,void 0!==ot?ot:C.collisionBoxArray.length,void 0!==ot?ot+1:C.collisionBoxArray.length,at||C.collisionBoxArray.length,at?at+1:C.collisionBoxArray.length,Se,_t,gt,dt,mt,Ht,0,Zt,qt,$t,0,Gt?1:0)}(C,_e,je,de,le,ce,he,dt,C.layers[0],C.collisionBoxArray,te.index,te.sourceLayerIndex,C.index,Ye,tt,ye,0,Je,rt,Ge,te,ue,ve,Se,Me,Ce,Oe)};if("line"===ot)for(const he of Y_(te.geometry,0,0,Mn,Mn)){const te=H_(he,Xe,Qe,le.vertical||Ze,ce,$e,We,C.overscaling,Mn);for(const le of te)Ze&&Cg(C,Ze.text,st,le)||B(he,le,Me)}else if("line-center"===ot){for(const C of te.geometry)if(C.length>1){const te=W_(C,Qe,le.vertical||Ze,ce,$e,We);te&&B(C,te,Me)}}else if("Polygon"===te.type)for(const C of Ff(te.geometry,0)){const te=pg(C,16);B(C[0],new j_(te.x,te.y,0,0,void 0),Me)}else if("LineString"===te.type)for(const C of te.geometry)B(C,new j_(C[0].x,C[0].y,0,0,void 0),Me);else if("Point"===te.type)for(const C of te.geometry)for(const te of C)B([te],new j_(te.x,te.y,0,0,void 0),Me)}const Sy=255,Iy=Sy*Ug;function Mg(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne,Ge,Ze){const qe=function(C,te,le,ce,he,ue,de,_e){const ye=[];if(0===te.positionedLines.length)return ye;const ve=ce.layout.get("text-rotate").evaluate(ue,{})*Math.PI/180,Se=function(C){const te=C[0],le=C[1],ce=te*le;return ce>0?[te,-le]:ce<0?[-te,le]:0===te?[le,te]:[le,-te]}(le);let Me=Math.abs(te.top-te.bottom);for(const C of te.positionedLines)Me-=C.lineOffset;const Ae=te.positionedLines.length,Ce=Me/Ae;let Oe=te.top-le[1];for(let C=0;C<Ae;++C){const ce=te.positionedLines[C];Oe=dg(te,Ce,Oe,C);for(const C of ce.positionedGlyphs){if(!C.rect)continue;const ce=C.rect||{};let ue=Kg+1,Me=!0,Ae=1,Ce=0;if(C.imageName){const te=de[C.imageName];if(!te)continue;if(te.sdf){H("SDF images are not supported in formatted text and will be ignored.");continue}Me=!1,Ae=te.pixelRatio,ue=gy/Ae}const Ne=(he||_e)&&C.vertical,Ge=C.metrics.advance*C.scale/2,Ze=C.metrics,qe=C.rect;if(null===qe)continue;_e&&te.verticalizable&&(Ce=C.imageName?Ge-C.metrics.width*C.scale/2:0);const $e=he?[C.x+Ge,C.y]:[0,0];let He=[0,0],We=[0,0],Xe=!1;he||(Ne?(We=[C.x+Ge+Se[0],C.y+Se[1]-Ce],Xe=!0):He=[C.x+Ge+le[0],C.y+le[1]-Ce]);const Ye=qe.w*C.scale/(Ae*(C.localGlyph?xy:1)),Je=qe.h*C.scale/(Ae*(C.localGlyph?xy:1));let Qe,tt,rt,ot;if(Ne){const te=C.y-Oe,le=new je(-Ge,Ge-te),ce=-Math.PI/2,he=new je(...We);Qe=new je(-Ge+He[0],He[1]),Qe._rotateAround(ce,le)._add(he),Qe.x+=-te+Ge,Qe.y-=(Ze.left-ue)*C.scale;const de=C.imageName?Ze.advance*C.scale:jg*C.scale,_e=String.fromCodePoint(C.glyph);x_(_e)?Qe.x+=(1-ue)*C.scale:v_(_e)?Qe.x+=de-Ze.height*C.scale+(-ue-1)*C.scale:Qe.x+=C.imageName||Ze.width+2*ue===qe.w&&Ze.height+2*ue===qe.h?(de-Je)/2:(de-(Ze.height+2*ue)*C.scale)/2,tt=new je(Qe.x,Qe.y-Ye),rt=new je(Qe.x+Je,Qe.y),ot=new je(Qe.x+Je,Qe.y-Ye)}else{const te=(Ze.left-ue)*C.scale-Ge+He[0],le=(-Ze.top-ue)*C.scale+He[1],ce=te+Ye,he=le+Je;Qe=new je(te,le),tt=new je(ce,le),rt=new je(te,he),ot=new je(ce,he)}if(ve){let C;C=he?new je(0,0):Xe?new je(Se[0],Se[1]):new je(le[0],le[1]),Qe._rotateAround(ve,C),tt._rotateAround(ve,C),rt._rotateAround(ve,C),ot._rotateAround(ve,C)}const st=new je(0,0),at=new je(0,0);ye.push({tl:Qe,tr:tt,bl:rt,br:ot,texPrimary:ce,texSecondary:void 0,writingMode:te.writingMode,glyphOffset:$e,sectionIndex:C.sectionIndex,isSDF:Me,pixelOffsetTL:st,pixelOffsetBR:at,minFontScaleX:0,minFontScaleY:0})}}return ye}(0,ce,ye,ue,de,_e,he,C.allowVerticalPlacement),$e=C.textSizeData;let He=null;"source"===$e.kind?(He=[Ug*ue.layout.get("text-size").evaluate(_e,{},Ge)],He[0]>Iy&&H(`${C.layerIds[0]}: Value for "text-size" is >= ${Sy}. Reduce your "text-size".`)):"composite"===$e.kind&&(He=[Ug*Oe.compositeTextSizes[0].evaluate(_e,{},Ge),Ug*Oe.compositeTextSizes[1].evaluate(_e,{},Ge)],(He[0]>Iy||He[1]>Iy)&&H(`${C.layerIds[0]}: Value for "text-size" is >= ${Sy}. Reduce your "text-size".`)),C.addSymbols(C.text,qe,He,ye,de,_e,Se,te,le,ve.lineStartIndex,ve.lineLength,Ce,Ne,Ge,Ze,!1);for(const te of Me)Ae[te]=C.text.placedSymbolArray.length-1;return 4*qe.length}function Ag(C){for(const te in C)return C[te];return null}function Sg(C,te,le,ce,he,ue,de,_e,ye,ve){let Se=de.top,Me=de.bottom,Ae=de.left,Ce=de.right;const Oe=de.collisionPadding;if(Oe&&(Ae-=Oe[0],Se-=Oe[1],Ce+=Oe[2],Me+=Oe[3]),ye){const C=new je(Ae,Se),te=new je(Ce,Se),le=new je(Ae,Me),ce=new je(Ce,Me),he=w(ye);let ue=new je(0,0);ve&&(ue=new je(ve[0],ve[1])),C._rotateAround(he,ue),te._rotateAround(he,ue),le._rotateAround(he,ue),ce._rotateAround(he,ue),Ae=Math.min(C.x,te.x,le.x,ce.x),Ce=Math.max(C.x,te.x,le.x,ce.x),Se=Math.min(C.y,te.y,le.y,ce.y),Me=Math.max(C.y,te.y,le.y,ce.y)}return C.emplaceBack(te.x,te.y,te.z,le.x,le.y,Ae,Se,Ce,Me,_e,ce,he,ue),C.length-1}function Ig(C){C.collisionPadding&&(C.top-=C.collisionPadding[1],C.bottom+=C.collisionPadding[3]);const te=C.bottom-C.top;return te>0?Math.max(10,te):null}function Cg(C,te,le,ce){const he=C.compareText;if(te in he){const C=he[te];for(let te=C.length-1;te>=0;te--)if(ce.dist(C[te])<le)return!0}else he[te]=[];return he[te].push(ce),!1}function zg(C,te){const le=C.fovAboveCenter,ce=C.elevation?C.elevation.getMinElevationBelowMSL()*te:0,he=(C._camera.position[2]*C.worldSize-ce)/Math.cos(C._pitch),ue=Math.sin(le)*he/Math.sin(Math.max(Math.PI/2-C._pitch-le,.01)),de=Math.sin(C._pitch)*ue+he;return Math.min(1.01*de,he*(1/C._horizonShift))}function Pg(C,te){if(!te.isReprojectedInTileSpace)return{scale:1<<C.z,x:C.x,y:C.y,x2:C.x+1,y2:C.y+1,projection:te};const le=Math.pow(2,-C.z),ce=C.x*le,he=(C.x+1)*le,ue=C.y*le,de=(C.y+1)*le,_e=ep(ce),ye=ep(he),ve=tp(ue),Se=tp(de),Me=te.project(_e,ve),Ae=te.project(ye,ve),Ce=te.project(ye,Se),Oe=te.project(_e,Se);let Ne=Math.min(Me.x,Ae.x,Ce.x,Oe.x),je=Math.min(Me.y,Ae.y,Ce.y,Oe.y),Ge=Math.max(Me.x,Ae.x,Ce.x,Oe.x),Ze=Math.max(Me.y,Ae.y,Ce.y,Oe.y);const qe=le/16;function v(C,le,ce,he,ue,de){const _e=(ce+ue)/2,ye=(he+de)/2,ve=te.project(ep(_e),tp(ye)),Se=Math.max(0,Ne-ve.x,je-ve.y,ve.x-Ge,ve.y-Ze);Ne=Math.min(Ne,ve.x),Ge=Math.max(Ge,ve.x),je=Math.min(je,ve.y),Ze=Math.max(Ze,ve.y),Se>qe&&(v(C,ve,ce,he,_e,ye),v(ve,le,_e,ye,ue,de))}v(Me,Ae,ce,ue,he,ue),v(Ae,Ce,he,ue,he,de),v(Ce,Oe,he,de,ce,de),v(Oe,Me,ce,de,ce,ue),Ne-=qe,je-=qe,Ge+=qe,Ze+=qe;const $e=1/Math.max(Ge-Ne,Ze-je);return{scale:$e,x:Ne*$e,y:je*$e,x2:Ge*$e,y2:Ze*$e,projection:te}}function Dg(C,te,le,ce,he,ue,de,_e,ye){if("globe"===ye.name)return yd(C,te,new ju(le,ce,he),!1);const ve=Pg({z:le,x:ce,y:he},ye);return new ed([(ue+ve.x/ve.scale)*te,te*(ve.y/ve.scale),de],[(ue+ve.x2/ve.scale)*te,te*(ve.y2/ve.scale),_e])}function Rg(C,{x:te,y:le},ce=0){return new je(((te-ce)*C.scale-C.x)*Mn,(le*C.scale-C.y)*Mn)}function Lg(C,te,le=0){return Zd.fromValues(((te.x-le)*C.scale-C.x)*Mn,(te.y*C.scale-C.y)*Mn,ip(te.z,te.y))}const Cy=ld.identity(new Float32Array(16));class Og{constructor(C){this.spec=C,this.name=C.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(C,te){return{x:0,y:0,z:0}}unproject(C,te){return new $f(0,0)}projectTilePoint(C,te,le){return{x:C,y:te,z:0}}locationPoint(C,te,le=!0){return C._coordinatePoint(C.locationCoordinate(te),le)}pixelsPerMeter(C,te){return Qd(1,C)*te}pixelSpaceConversion(C,te,le){return 1}farthestPixelDistance(C){return zg(C,C.pixelsPerMeter)}pointCoordinate(C,te,le,ce){const he=C.horizonLineFromTop(!1),ue=new je(te,Math.max(he,le));return C.rayIntersectionCoordinate(C.pointRayIntersection(ue,ce))}pointCoordinate3D(C,te,le){const ce=new je(te,le);if(C.elevation)return C.elevation.pointCoordinate(ce);{const te=this.pointCoordinate(C,ce.x,ce.y,0);return[te.x,te.y,te.z]}}isPointAboveHorizon(C,te){if(C.elevation)return!this.pointCoordinate3D(C,te.x,te.y);const le=C.horizonLineFromTop();return te.y<le}createInversionMatrix(C,te){return Cy}createTileMatrix(C,te,le){let ce,he,ue;const de=le.canonical,_e=ld.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){const ye=Pg(de,this);ce=1,he=ye.x+le.wrap*ye.scale,ue=ye.y,ld.scale(_e,_e,[ce/ye.scale,ce/ye.scale,C.pixelsPerMeter/te])}else ce=te/C.zoomScale(de.z),he=(de.x+Math.pow(2,de.z)*le.wrap)*ce,ue=de.y*ce;return ld.translate(_e,_e,[he,ue,0]),ld.scale(_e,_e,[ce/Mn,ce/Mn,1]),_e}upVector(C,te,le){return[0,0,1]}upVectorScale(C,te,le){return{metersToTile:1}}}class Bg extends Og{constructor(C){super(C),this.range=[4,7],this.center=C.center||[-96,37.5];const[te,le]=this.parallels=C.parallels||[29.5,45.5],ce=Math.sin(w(te));this.n=(ce+Math.sin(w(le)))/2,this.c=1+ce*(2*this.n-ce),this.r0=Math.sqrt(this.c)/this.n}project(C,te){const{n:le,c:ce,r0:he}=this,ue=w(C-this.center[0]),de=w(te),_e=Math.sqrt(ce-2*le*Math.sin(de))/le;return{x:_e*Math.sin(ue*le),y:_e*Math.cos(ue*le)-he,z:0}}unproject(C,te){const{n:le,c:ce,r0:he}=this,ue=he+te;let de=Math.atan2(C,Math.abs(ue))*Math.sign(ue);ue*le<0&&(de-=Math.PI*Math.sign(C)*Math.sign(ue));const _e=w(this.center[0])*le;de=D(de,-Math.PI-_e,Math.PI-_e);const ye=z(T(de/le)+this.center[0],-180,180),ve=Math.asin(z((ce-(C*C+ue*ue)*le*le)/(2*le),-1,1)),Se=z(T(ve),-Xf,Xf);return new $f(ye,Se)}}const zy=1.340264,Dy=-.081106,Py=893e-6,ky=.003796,Ly=Math.sqrt(3)/2;class Gg extends Og{project(C,te){te=te/180*Math.PI,C=C/180*Math.PI;const le=Math.asin(Ly*Math.sin(te)),ce=le*le,he=ce*ce*ce;return{x:.5*(C*Math.cos(le)/(Ly*(zy+3*Dy*ce+he*(7*Py+9*ky*ce)))/Math.PI+.5),y:1-.5*(le*(zy+Dy*ce+he*(Py+ky*ce))/Math.PI+1),z:0}}unproject(C,te){C=(2*C-.5)*Math.PI;let le=te=(2*(1-te)-1)*Math.PI,ce=le*le,he=ce*ce*ce;for(let C,ue,de,_e=0;_e<12&&(ue=le*(zy+Dy*ce+he*(Py+ky*ce))-te,de=zy+3*Dy*ce+he*(7*Py+9*ky*ce),C=ue/de,le=z(le-C,-Math.PI/3,Math.PI/3),ce=le*le,he=ce*ce*ce,!(Math.abs(C)<1e-12));++_e);const ue=Ly*C*(zy+3*Dy*ce+he*(7*Py+9*ky*ce))/Math.cos(le),de=Math.asin(Math.sin(le)/Ly),_e=z(180*ue/Math.PI,-180,180),ye=z(180*de/Math.PI,-Xf,Xf);return new $f(_e,ye)}}class qg extends Og{constructor(C){super(C),this.wrap=!0,this.supportsWorldCopies=!0}project(C,te){return{x:.5+C/360,y:.5-te/360,z:0}}unproject(C,te){const le=360*(C-.5),ce=z(360*(.5-te),-Xf,Xf);return new $f(le,ce)}}const Ny=Math.PI/2;function $g(C){return Math.tan((Ny+C)/2)}class Wg extends Og{constructor(C){super(C),this.center=C.center||[0,30];const[te,le]=this.parallels=C.parallels||[30,30];let ce=w(te),he=w(le);this.southernCenter=ce+he<0,this.southernCenter&&(ce=-ce,he=-he);const ue=Math.cos(ce),de=$g(ce);this.n=ce===he?Math.sin(ce):Math.log(ue/Math.cos(he))/Math.log($g(he)/de),this.f=ue*Math.pow($g(ce),this.n)/this.n}project(C,te){te=w(te),this.southernCenter&&(te=-te),C=w(C-this.center[0]);const le=1e-6,{n:ce,f:he}=this;he>0?te<-Ny+le&&(te=-Ny+le):te>Ny-le&&(te=Ny-le);const ue=he/Math.pow($g(te),ce);let de=ue*Math.sin(ce*C),_e=he-ue*Math.cos(ce*C);return de=.5*(de/Math.PI+.5),_e=.5*(_e/Math.PI+.5),{x:de,y:this.southernCenter?_e:1-_e,z:0}}unproject(C,te){C=(2*C-.5)*Math.PI,this.southernCenter&&(te=1-te),te=(2*(1-te)-.5)*Math.PI;const{n:le,f:ce}=this,he=ce-te,ue=Math.sign(he),de=Math.sign(le)*Math.sqrt(C*C+he*he);let _e=Math.atan2(C,Math.abs(he))*ue;he*le<0&&(_e-=Math.PI*Math.sign(C)*ue);const ye=z(T(_e/le)+this.center[0],-180,180),ve=z(T(2*Math.atan(Math.pow(ce/de,1/le))-Ny),-Xf,Xf);return new $f(ye,this.southernCenter?-ve:ve)}}class Hg extends Og{constructor(C){super(C),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(C,te){return{x:Kd(C),y:Jd(te),z:0}}unproject(C,te){const le=ep(C),ce=tp(te);return new $f(le,ce)}}const ax=w(Xf);class Yg extends Og{project(C,te){const le=(te=w(te))*te,ce=le*le;return{x:.5*((C=w(C))*(.8707-.131979*le+ce*(ce*(.003971*le-.001529*ce)-.013791))/Math.PI+.5),y:1-.5*(te*(1.007226+le*(.015085+ce*(.028874*le-.044475-.005916*ce)))/Math.PI+1),z:0}}unproject(C,te){C=(2*C-.5)*Math.PI;let le=te=(2*(1-te)-1)*Math.PI,ce=25,he=0,ue=le*le;do{ue=le*le;const C=ue*ue;he=(le*(1.007226+ue*(.015085+C*(.028874*ue-.044475-.005916*C)))-te)/(1.007226+ue*(.045255+C*(.259866*ue-.311325-.005916*11*C))),le=z(le-he,-ax,ax)}while(Math.abs(he)>1e-6&&--ce>0);ue=le*le;const de=z(T(C/(.8707+ue*(ue*(ue*ue*ue*(.003971-.001529*ue)-.013791)-.131979))),-180,180),_e=T(le);return new $f(de,_e)}}const Ax=w(Xf);class Jg extends Og{project(C,te){te=w(te),C=w(C);const le=Math.cos(te),ce=2/Math.PI,he=Math.acos(le*Math.cos(C/2)),ue=Math.sin(he)/he,de=.5*(C*ce+2*le*Math.sin(C/2)/ue)||0,_e=.5*(te+Math.sin(te)/ue)||0;return{x:.5*(de/Math.PI+.5),y:1-.5*(_e/Math.PI+1),z:0}}unproject(C,te){let le=C=(2*C-.5)*Math.PI,ce=te=(2*(1-te)-1)*Math.PI,he=25;const ue=1e-6;let de=0,_e=0;do{const he=Math.cos(ce),ue=Math.sin(ce),ye=2*ue*he,ve=ue*ue,Se=he*he,Me=Math.cos(le/2),Ae=Math.sin(le/2),Ce=2*Me*Ae,Oe=Ae*Ae,Ne=1-Se*Me*Me,je=Ne?1/Ne:0,Ge=Ne?Math.acos(he*Me)*Math.sqrt(1/Ne):0,Ze=.5*(2*Ge*he*Ae+2*le/Math.PI)-C,qe=.5*(Ge*ue+ce)-te,$e=.5*je*(Se*Oe+Ge*he*Me*ve)+1/Math.PI,He=je*(Ce*ye/4-Ge*ue*Ae),We=.125*je*(ye*Ae-Ge*ue*Se*Ce),Xe=.5*je*(ve*Me+Ge*Oe*he)+.5,Ye=He*We-Xe*$e;de=(qe*He-Ze*Xe)/Ye,_e=(Ze*We-qe*$e)/Ye,le=z(le-de,-Math.PI,Math.PI),ce=z(ce-_e,-Ax,Ax)}while((Math.abs(de)>ue||Math.abs(_e)>ue)&&--he>0);return new $f(T(le),T(ce))}}class Qg extends Og{constructor(C){super(C),this.center=C.center||[0,0],this.parallels=C.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(w(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(C,te){const{scale:le,cosPhi:ce}=this;return{x:w(C)*ce*le+.5,y:-Math.sin(w(te))/ce*le+.5,z:0}}unproject(C,te){const{scale:le,cosPhi:ce}=this,he=-(te-.5)/le,ue=z(T((C-.5)/le)/ce,-180,180),de=Math.asin(z(he*ce,-1,1)),_e=z(T(de),-Xf,Xf);return new $f(ue,_e)}}class ey extends Hg{constructor(C){super(C),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(C,te,le){const ce=Td(C,te,le),he=Ad(fd(le));return Zd.transformMat4(ce,ce,he),{x:ce[0],y:ce[1],z:ce[2]}}locationPoint(C,te){const le=wd(te.lat,te.lng),ce=Zd.normalize([],le),he=C.elevation?C.elevation.getAtPointOrZero(C.locationCoordinate(te),C._centerAltitude):C._centerAltitude,ue=Qd(1,0)*Mn*he;Zd.scaleAndAdd(le,le,ce,ue);const de=ld.identity(new Float64Array(16));return ld.multiply(de,C.pixelMatrix,C.globeMatrix),Zd.transformMat4(le,le,de),new je(le[0],le[1])}pixelsPerMeter(C,te){return Qd(1,0)*te}pixelSpaceConversion(C,te,le){const ce=Qd(1,C)*te,he=Kr(Qd(1,45)*te,ce,le);return this.pixelsPerMeter(C,te)/he}createTileMatrix(C,te,le){const ce=Sd(fd(le.canonical));return ld.multiply(new Float64Array(16),C.globeMatrix,ce)}createInversionMatrix(C,te){const{center:le}=C,ce=Ad(fd(te));return ld.rotateY(ce,ce,w(le.lng)),ld.rotateX(ce,ce,w(le.lat)),ld.scale(ce,ce,[C._pixelsPerMercatorPixel,C._pixelsPerMercatorPixel,1]),Float32Array.from(ce)}pointCoordinate(C,te,le,ce){return ud(C,te,le,!0)||new lp(0,0)}pointCoordinate3D(C,te,le){const ce=this.pointCoordinate(C,te,le,0);return[ce.x,ce.y,ce.z]}isPointAboveHorizon(C,te){return!ud(C,te.x,te.y,!1)}farthestPixelDistance(C){const te=function(C,te){const le=C.cameraToCenterDistance,ce=C._centerAltitude*te,he=C._camera,ue=C._camera.forward(),de=Zd.add([],Zd.scale([],ue,-le),[0,0,ce]),_e=C.worldSize/(2*Math.PI),ye=[0,0,-_e],ve=C.width/C.height,Se=Math.tan(C.fovAboveCenter),Me=Zd.scale([],he.up(),Se),Ae=Zd.scale([],he.right(),Se*ve),Ce=Zd.normalize([],Zd.add([],Zd.add([],ue,Me),Ae)),Oe=[];let Ne;if(new Wu(de,Ce).closestPointOnSphere(ye,_e,Oe)){const te=Zd.add([],Oe,ye),le=Zd.sub([],te,de);Ne=Math.cos(C.fovAboveCenter)*Zd.length(le)}else{const C=Zd.sub([],de,ye),te=Zd.sub([],ye,de);Zd.normalize(te,te);const le=Zd.length(C)-_e;Ne=Math.sqrt(le*(le+2*_e));const ce=Math.acos(Ne/(_e+le))-Math.acos(Zd.dot(ue,te));Ne*=Math.cos(ce)}return 1.01*Ne}(C,this.pixelsPerMeter(C.center.lat,C.worldSize)),le=Dd(C.zoom);if(le>0){const ce=zg(C,Qd(1,C.center.lat)*C.worldSize),he=C.worldSize/(2*Math.PI),ue=Math.max(C.width,C.height)/C.worldSize*Math.PI;return Kr(te,ce+he*(1-Math.cos(ue)),Math.pow(le,10))}return te}upVector(C,te,le){return Td(te,le,C,1)}upVectorScale(C){return{metersToTile:hd(Ed(fd(C)))}}}function ty(C){const te=C.parallels,le=!!te&&Math.abs(te[0]+te[1])<.01;switch(C.name){case"mercator":return new Hg(C);case"equirectangular":return new qg(C);case"naturalEarth":return new Yg(C);case"equalEarth":return new Gg(C);case"winkelTripel":return new Jg(C);case"albers":return le?new Qg(C):new Bg(C);case"lambertConformalConic":return le?new Qg(C):new Wg(C);case"globe":return new ey(C)}throw new Error(`Invalid projection name: ${C.name}`)}const Ix=new ga({"symbol-placement":new fa(zi.layout_symbol["symbol-placement"]),"symbol-spacing":new fa(zi.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new fa(zi.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new ma(zi.layout_symbol["symbol-sort-key"]),"symbol-z-order":new fa(zi.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new fa(zi.layout_symbol["symbol-z-elevate"]),"icon-allow-overlap":new fa(zi.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new fa(zi.layout_symbol["icon-ignore-placement"]),"icon-optional":new fa(zi.layout_symbol["icon-optional"]),"icon-rotation-alignment":new fa(zi.layout_symbol["icon-rotation-alignment"]),"icon-size":new ma(zi.layout_symbol["icon-size"]),"icon-text-fit":new ma(zi.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new ma(zi.layout_symbol["icon-text-fit-padding"]),"icon-image":new ma(zi.layout_symbol["icon-image"]),"icon-rotate":new ma(zi.layout_symbol["icon-rotate"]),"icon-padding":new fa(zi.layout_symbol["icon-padding"]),"icon-keep-upright":new fa(zi.layout_symbol["icon-keep-upright"]),"icon-offset":new ma(zi.layout_symbol["icon-offset"]),"icon-anchor":new ma(zi.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new fa(zi.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new fa(zi.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new fa(zi.layout_symbol["text-rotation-alignment"]),"text-field":new ma(zi.layout_symbol["text-field"]),"text-font":new ma(zi.layout_symbol["text-font"]),"text-size":new ma(zi.layout_symbol["text-size"]),"text-max-width":new ma(zi.layout_symbol["text-max-width"]),"text-line-height":new ma(zi.layout_symbol["text-line-height"]),"text-letter-spacing":new ma(zi.layout_symbol["text-letter-spacing"]),"text-justify":new ma(zi.layout_symbol["text-justify"]),"text-radial-offset":new ma(zi.layout_symbol["text-radial-offset"]),"text-variable-anchor":new fa(zi.layout_symbol["text-variable-anchor"]),"text-anchor":new ma(zi.layout_symbol["text-anchor"]),"text-max-angle":new fa(zi.layout_symbol["text-max-angle"]),"text-writing-mode":new fa(zi.layout_symbol["text-writing-mode"]),"text-rotate":new ma(zi.layout_symbol["text-rotate"]),"text-padding":new fa(zi.layout_symbol["text-padding"]),"text-keep-upright":new fa(zi.layout_symbol["text-keep-upright"]),"text-transform":new ma(zi.layout_symbol["text-transform"]),"text-offset":new ma(zi.layout_symbol["text-offset"]),"text-allow-overlap":new fa(zi.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new fa(zi.layout_symbol["text-ignore-placement"]),"text-optional":new fa(zi.layout_symbol["text-optional"]),visibility:new fa(zi.layout_symbol.visibility)});var zx={paint:new ga({"icon-opacity":new ma(zi.paint_symbol["icon-opacity"]),"icon-emissive-strength":new ma(zi.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new ma(zi.paint_symbol["text-emissive-strength"]),"icon-color":new ma(zi.paint_symbol["icon-color"]),"icon-halo-color":new ma(zi.paint_symbol["icon-halo-color"]),"icon-halo-width":new ma(zi.paint_symbol["icon-halo-width"]),"icon-halo-blur":new ma(zi.paint_symbol["icon-halo-blur"]),"icon-translate":new fa(zi.paint_symbol["icon-translate"]),"icon-translate-anchor":new fa(zi.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new ma(zi.paint_symbol["icon-image-cross-fade"]),"text-opacity":new ma(zi.paint_symbol["text-opacity"]),"text-color":new ma(zi.paint_symbol["text-color"],{runtimeType:nr,getOverride:C=>C.textColor,hasOverride:C=>!!C.textColor}),"text-halo-color":new ma(zi.paint_symbol["text-halo-color"]),"text-halo-width":new ma(zi.paint_symbol["text-halo-width"]),"text-halo-blur":new ma(zi.paint_symbol["text-halo-blur"]),"text-translate":new fa(zi.paint_symbol["text-translate"]),"text-translate-anchor":new fa(zi.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new fa(zi.paint_symbol["icon-color-saturation"])}),layout:Ix};class ny{constructor(C){this.type=C.property.overrides?C.property.overrides.runtimeType:ki,this.defaultValue=C}evaluate(C){if(C.formattedSection){const te=this.defaultValue.property.overrides;if(te&&te.hasOverride(C.formattedSection))return te.getOverride(C.formattedSection)}return C.feature&&C.featureState?this.defaultValue.evaluate(C.feature,C.featureState):this.defaultValue.property.specification.default}eachChild(C){this.defaultValue.isConstant()||C(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Rs(ny,"FormatSectionOverride",{omit:["defaultValue"]});class oy extends Ta{constructor(C,te){super(C,zx,te)}recalculate(C,te){super.recalculate(C,te),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const le=this.layout.get("text-writing-mode");if(le){const C=[];for(const te of le)C.indexOf(te)<0&&C.push(te);this.layout._values["text-writing-mode"]=C}else this.layout._values["text-writing-mode"]="point"===this.layout.get("symbol-placement")?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getValueAndResolveTokens(C,te,le,ce){const he=this.layout.get(C).evaluate(te,{},le,ce),ue=this._unevaluatedLayout._values[C];return ue.isDataDriven()||To(ue.value)||!he?he:function(C,te){return te.replace(/{([^{}]+)}/g,((te,le)=>le in C?String(C[le]):""))}(te.properties,he)}createBucket(C){return new Nx(C)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const C of zx.paint.overridableProperties){if(!oy.hasPaintOverride(this.layout,C))continue;const te=this.paint.get(C),le=new ny(te),ce=new wo(le,te.property.specification);let he=null;he="constant"===te.value.kind||"source"===te.value.kind?new Mo("source",ce):new Ao("composite",ce,te.value.zoomStops,te.value._interpolationType),this.paint._values[C]=new da(te.property,he,te.parameters)}}_handleOverridablePaintPropertyUpdate(C,te,le){return!(!this.layout||te.isDataDriven()||le.isDataDriven())&&oy.hasPaintOverride(this.layout,C)}static hasPaintOverride(C,te){const le=C.get("text-field"),ce=zx.paint.properties[te];let he=!1;const o=C=>{for(const te of C)if(ce.overrides&&ce.overrides.hasOverride(te))return void(he=!0)};if("constant"===le.value.kind&&le.value.value instanceof pi)o(le.value.value.sections);else if("source"===le.value.kind){const e=C=>{he||(C instanceof $r&&gi(C.value)===lr?o(C.value.sections):C instanceof Mi?o(C.sections):C.eachChild(e))},C=le.value;C._styleExpression&&e(C._styleExpression.expression)}return he}getProgramIds(){const C=0!==this.paint.get("icon-opacity").constantOr(1),te=0!==this.paint.get("text-opacity").constantOr(1),le=[];return C&&le.push("symbolIcon"),te&&le.push("symbolSDF"),le}getDefaultProgramParams(C,te){return{config:new Ql(this,te),overrideFog:!1}}}const Px=y_.types,Fx=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function ly(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae){const Ce=_e?Math.min(Iy,Math.round(_e[0])):0,Oe=_e?Math.min(Iy,Math.round(_e[1])):0;C.emplaceBack(te,le,Math.round(32*ce),Math.round(32*he),ue,de,(Ce<<1)+(ye?1:0),Oe,16*ve,16*Se,256*Me,256*Ae)}function cy(C,te,le){C.emplaceBack(te,le)}function hy(C,te,le,ce,he,ue,de){C.emplaceBack(te,le,ce,he,ue,de)}function uy(C,te,le,ce,he){const ue=5*te+2;C.float32[ue+0]=le,C.float32[ue+1]=ce,C.float32[ue+2]=he}function dy(C,te,le,ce,he){C.emplaceBack(te,le,ce,he),C.emplaceBack(te,le,ce,he),C.emplaceBack(te,le,ce,he),C.emplaceBack(te,le,ce,he)}function py(C){for(const te of C.sections)if($s(te.text))return!0;return!1}class fy{constructor(C){this.layoutVertexArray=new Na,this.indexArray=new Wa,this.programConfigurations=C,this.segments=new xl,this.dynamicLayoutVertexArray=new ka,this.opacityVertexArray=new Va,this.placedSymbolArray=new cl,this.iconTransitioningVertexArray=new ja,this.globeExtVertexArray=new Ua,this.zOffsetVertexArray=new Ya}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length&&0===this.iconTransitioningVertexArray.length}upload(C,te,le,ce,he){this.isEmpty()||(le&&(this.layoutVertexBuffer=C.createVertexBuffer(this.layoutVertexArray,sg.members),this.indexBuffer=C.createIndexBuffer(this.indexArray,te),this.dynamicLayoutVertexBuffer=C.createVertexBuffer(this.dynamicLayoutVertexArray,gg.members,!0),this.opacityVertexBuffer=C.createVertexBuffer(this.opacityVertexArray,Fx,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=C.createVertexBuffer(this.iconTransitioningVertexArray,Tg.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=C.createVertexBuffer(this.globeExtVertexArray,_g.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||he)&&(this.zOffsetVertexBuffer=C.createVertexBuffer(this.zOffsetVertexArray,yg.members,!0)),this.opacityVertexBuffer.itemSize=1),(le||ce)&&this.programConfigurations.upload(C))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}Rs(fy,"SymbolBuffers");class my{constructor(C,te,le){this.layoutVertexArray=new C,this.layoutAttributes=te,this.indexArray=new le,this.segments=new xl,this.collisionVertexArray=new $a,this.collisionVertexArrayExt=new ka}upload(C){this.layoutVertexBuffer=C.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=C.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=C.createVertexBuffer(this.collisionVertexArray,Eg.members,!0),this.collisionVertexBufferExt=C.createVertexBuffer(this.collisionVertexArrayExt,kg.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Rs(my,"CollisionBuffers");class _y{constructor(C){this.collisionBoxArray=C.collisionBoxArray,this.zoom=C.zoom,this.overscaling=C.overscaling,this.layers=C.layers,this.layerIds=this.layers.map((C=>C.fqid)),this.index=C.index,this.pixelRatio=C.pixelRatio,this.sourceLayerIndex=C.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=ld.identity([]),this.placementViewportMatrix=ld.identity([]);const te=this.layers[0]._unevaluatedLayout._values;this.textSizeData=p_(this.zoom,te["text-size"]),this.iconSizeData=p_(this.zoom,te["icon-size"]);const le=this.layers[0].layout,ce=le.get("symbol-sort-key"),he=le.get("symbol-z-order");this.canOverlap=le.get("text-allow-overlap")||le.get("icon-allow-overlap")||le.get("text-ignore-placement")||le.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==he&&void 0!==ce.constantOr(1),this.sortFeaturesByY=("viewport-y"===he||"auto"===he&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=le.get("text-writing-mode").map((C=>iy[C])),this.stateDependentLayerIds=this.layers.filter((C=>C.isStateDependent())).map((C=>C.id)),this.sourceID=C.sourceID,this.projection=C.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=le.get("symbol-z-elevate")}createArrays(){this.text=new fy(new ec(this.layers,this.zoom,(C=>/^text/.test(C)))),this.icon=new fy(new ec(this.layers,this.zoom,(C=>/^icon/.test(C)))),this.glyphOffsetArray=new dl,this.lineVertexArray=new pl,this.symbolInstances=new ul}calculateGlyphDependencies(C,te,le,ce,he){for(let le=0;le<C.length;le++){const ue=C.codePointAt(le);if(void 0===ue)break;if(te[ue]=!0,ce&&he&&ue<=65535){const ce=Zg[C.charAt(le)];ce&&(te[ce.charCodeAt(0)]=!0)}}}populate(C,te,le,ce){const he=this.layers[0],ue=he.layout,de="globe"===this.projection.name,_e=ue.get("text-font"),ye=ue.get("text-field"),ve=ue.get("icon-image"),Se=("constant"!==ye.value.kind||ye.value.value instanceof pi&&!ye.value.value.isEmpty()||ye.value.value.toString().length>0)&&("constant"!==_e.value.kind||_e.value.value.length>0),Me="constant"!==ve.value.kind||!!ve.value.value||Object.keys(ve.parameters).length>0,Ae=ue.get("symbol-sort-key");if(this.features=[],!Se&&!Me)return;const Ce=te.iconDependencies,Oe=te.glyphDependencies,Ne=te.availableImages,je=new oa(this.zoom);for(const{feature:te,id:ye,index:ve,sourceLayerIndex:Ge}of C){const C=he._featureFilter.needGeometry,Ze=gp(te,C);if(!he._featureFilter.filter(je,Ze,le))continue;if(C||(Ze.geometry=_p(te,le,ce)),de&&1!==te.type&&le.z<=5){const C=Ze.geometry,te=.98078528056,r=(C,ce)=>{const he=Td(C.x,C.y,le,1),ue=Td(ce.x,ce.y,le,1);return Zd.dot(he,ue)<te};for(let te=0;te<C.length;te++)C[te]=dp(C[te],r)}let qe,$e;if(Se){const C=he.getValueAndResolveTokens("text-field",Ze,le,Ne),te=pi.factory(C);py(te)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===ia()||this.hasRTLText&&lc.isParsed())&&(qe=g_(te,he,Ze))}if(Me){const C=he.getValueAndResolveTokens("icon-image",Ze,le,Ne);$e=C instanceof fi?C:fi.fromString(C)}if(!qe&&!$e)continue;const He=this.sortFeaturesByKey?Ae.evaluate(Ze,{},le):void 0;if(this.features.push({id:ye,text:qe,icon:$e,index:ve,sourceLayerIndex:Ge,geometry:Ze.geometry,properties:te.properties,type:Px[te.type],sortKey:He}),$e&&(Ce[$e.namePrimary]=!0,$e.nameSecondary&&(Ce[$e.nameSecondary]=!0)),qe){const C=_e.evaluate(Ze,{},le).join(","),te="map"===ue.get("text-rotation-alignment")&&"point"!==ue.get("symbol-placement");this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(iy.vertical)>=0;for(const le of qe.sections)if(le.image)Ce[le.image.namePrimary]=!0;else{const ce=Ns(qe.toString()),he=le.fontStack||C,ue=Oe[he]=Oe[he]||{};this.calculateGlyphDependencies(le.text,ue,te,this.allowVerticalPlacement,ce)}}}"line"===ue.get("symbol-placement")&&(this.features=function(C){const te={},le={},ce=[];let he=0;function o(te){ce.push(C[te]),he++}function s(C,te,he){const ue=le[C];return delete le[C],le[te]=ue,ce[ue].geometry[0].pop(),ce[ue].geometry[0]=ce[ue].geometry[0].concat(he[0]),ue}function a(C,le,he){const ue=te[le];return delete te[le],te[C]=ue,ce[ue].geometry[0].shift(),ce[ue].geometry[0]=he[0].concat(ce[ue].geometry[0]),ue}function l(C,te,le){const ce=le?te[0][te[0].length-1]:te[0][0];return`${C}:${ce.x}:${ce.y}`}for(let ue=0;ue<C.length;ue++){const de=C[ue],_e=de.geometry,ye=de.text?de.text.toString():null;if(!ye){o(ue);continue}const ve=l(ye,_e),Se=l(ye,_e,!0);if(ve in le&&Se in te&&le[ve]!==te[Se]){const C=a(ve,Se,_e),he=s(ve,Se,ce[C].geometry);delete te[ve],delete le[Se],le[l(ye,ce[he].geometry,!0)]=he,ce[C].geometry=null}else ve in le?s(ve,Se,_e):Se in te?a(ve,Se,_e):(o(ue),te[ve]=he-1,le[Se]=he-1)}return ce.filter((C=>C.geometry))}(this.features)),this.sortFeaturesByKey&&this.features.sort(((C,te)=>C.sortKey-te.sortKey))}update(C,te,le,ce,he){const ue=0!==Object.keys(C).length;if(ue&&!this.stateDependentLayers.length)return;const de=ue?this.stateDependentLayers:this.layers;this.text.programConfigurations.updatePaintArrays(C,te,de,le,ce,he),this.icon.programConfigurations.updatePaintArrays(C,te,de,le,ce,he)}updateZOffset(){const e=(te,le,ce)=>{C+=le,C>te.length&&te.resize(C);for(let he=-le;he<0;he++)te.emplace(he+C,ce)},t=(C,le,ce)=>{te+=le,te>C.length&&C.resize(te);for(let he=-le;he<0;he++)C.emplace(he+te,ce)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let C=0,te=0;for(let C=0;C<this.symbolInstances.length;C++){const te=this.symbolInstances.get(C),{numHorizontalGlyphVertices:le,numVerticalGlyphVertices:ce,numIconVertices:he}=te,ue=te.zOffset,de=he>0;if((le>0||ce>0)&&(e(this.text.zOffsetVertexArray,le,ue),e(this.text.zOffsetVertexArray,ce,ue)),de){const{placedIconSymbolIndex:C,verticalPlacedIconSymbolIndex:le}=te;C>=0&&t(this.icon.zOffsetVertexArray,he,ue),le>=0&&t(this.icon.zOffsetVertexArray,te.numVerticalIconVertices,ue)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(C){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(C),this.iconCollisionBox.upload(C)),this.text.upload(C,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(C,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=ty(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(C,te){const le=this.lineVertexArray.length;if(void 0!==C.segment)for(const{x:C,y:le}of te)this.lineVertexArray.emplaceBack(C,le);return{lineStartIndex:le,lineLength:this.lineVertexArray.length-le}}addSymbols(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne){const je=C.indexArray,Ge=C.layoutVertexArray,Ze=C.globeExtVertexArray,qe=C.segments.prepareSegment(4*te.length,Ge,je,this.canOverlap?ue.sortKey:void 0),$e=this.glyphOffsetArray.length,He=qe.vertexLength,We=this.allowVerticalPlacement&&de===iy.vertical?Math.PI/2:0,Xe=ue.text&&ue.text.sections;for(let ce=0;ce<te.length;ce++){const{tl:he,tr:de,bl:ve,br:Se,texPrimary:Me,texSecondary:$e,pixelOffsetTL:He,pixelOffsetBR:Ye,minFontScaleX:Je,minFontScaleY:Qe,glyphOffset:tt,isSDF:rt,sectionIndex:ot}=te[ce],st=qe.vertexLength,at=tt[1];if(ly(Ge,ye.x,ye.y,he.x,at+he.y,Me.x,Me.y,le,rt,He.x,He.y,Je,Qe),ly(Ge,ye.x,ye.y,de.x,at+de.y,Me.x+Me.w,Me.y,le,rt,Ye.x,He.y,Je,Qe),ly(Ge,ye.x,ye.y,ve.x,at+ve.y,Me.x,Me.y+Me.h,le,rt,He.x,Ye.y,Je,Qe),ly(Ge,ye.x,ye.y,Se.x,at+Se.y,Me.x+Me.w,Me.y+Me.h,le,rt,Ye.x,Ye.y,Je,Qe),_e){const{x:te,y:le,z:ce}=_e.anchor,[he,ue,de]=_e.up;hy(Ze,te,le,ce,he,ue,de),hy(Ze,te,le,ce,he,ue,de),hy(Ze,te,le,ce,he,ue,de),hy(Ze,te,le,ce,he,ue,de),dy(C.dynamicLayoutVertexArray,te,le,ce,We)}else dy(C.dynamicLayoutVertexArray,ye.x,ye.y,ye.z,We);if(Ne){const te=$e||Me;cy(C.iconTransitioningVertexArray,te.x,te.y),cy(C.iconTransitioningVertexArray,te.x+te.w,te.y),cy(C.iconTransitioningVertexArray,te.x,te.y+te.h),cy(C.iconTransitioningVertexArray,te.x+te.w,te.y+te.h)}je.emplaceBack(st,st+1,st+2),je.emplaceBack(st+1,st+2,st+3),qe.vertexLength+=4,qe.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(tt[0]),ce!==te.length-1&&ot===te[ce+1].sectionIndex||C.programConfigurations.populatePaintArrays(Ge.length,ue,ue.index,{},Ae,Ce,Oe,Xe&&Xe[ot])}const Ye=_e?_e.anchor:ye;C.placedSymbolArray.emplaceBack(Ye.x,Ye.y,Ye.z,ye.x,ye.y,$e,this.glyphOffsetArray.length-$e,He,ve,Se,ye.segment,le?le[0]:0,le?le[1]:0,ce[0],ce[1],de,0,!1,0,Me,0)}_commitLayoutVertex(C,te,le,ce,he,ue,de){C.emplaceBack(te,le,ce,he,ue,Math.round(de.x),Math.round(de.y))}_addCollisionDebugVertices(C,te,le,ce,he,ue,de){const _e=le.segments.prepareSegment(4,le.layoutVertexArray,le.indexArray),ye=_e.vertexLength,ve=de.tileAnchorX,Se=de.tileAnchorY;for(let C=0;C<4;C++)le.collisionVertexArray.emplaceBack(0,0,0,0);this._commitDebugCollisionVertexUpdate(le.collisionVertexArrayExt,te,C.padding,de.zOffset),this._commitLayoutVertex(le.layoutVertexArray,ce,he,ue,ve,Se,new je(C.x1,C.y1)),this._commitLayoutVertex(le.layoutVertexArray,ce,he,ue,ve,Se,new je(C.x2,C.y1)),this._commitLayoutVertex(le.layoutVertexArray,ce,he,ue,ve,Se,new je(C.x2,C.y2)),this._commitLayoutVertex(le.layoutVertexArray,ce,he,ue,ve,Se,new je(C.x1,C.y2)),_e.vertexLength+=4;const Me=le.indexArray;Me.emplaceBack(ye,ye+1),Me.emplaceBack(ye+1,ye+2),Me.emplaceBack(ye+2,ye+3),Me.emplaceBack(ye+3,ye),_e.primitiveLength+=4}_addTextDebugCollisionBoxes(C,te,le,ce,he,ue){for(let de=ce;de<he;de++){const ce=le.get(de),he=this.getSymbolInstanceTextSize(C,ue,te,de);this._addCollisionDebugVertices(ce,he,this.textCollisionBox,ce.projectedAnchorX,ce.projectedAnchorY,ce.projectedAnchorZ,ue)}}_addIconDebugCollisionBoxes(C,te,le,ce,he,ue){for(let de=ce;de<he;de++){const ce=le.get(de),he=this.getSymbolInstanceIconSize(C,te,ue.placedIconSymbolIndex);this._addCollisionDebugVertices(ce,he,this.iconCollisionBox,ce.projectedAnchorX,ce.projectedAnchorY,ce.projectedAnchorZ,ue)}}generateCollisionDebugBuffers(C,te){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new my(qa,Fg.members,ja),this.iconCollisionBox=new my(qa,Fg.members,ja);const le=m_(this.iconSizeData,C),ce=m_(this.textSizeData,C);for(let he=0;he<this.symbolInstances.length;he++){const ue=this.symbolInstances.get(he);this._addTextDebugCollisionBoxes(ce,C,te,ue.textBoxStartIndex,ue.textBoxEndIndex,ue),this._addTextDebugCollisionBoxes(ce,C,te,ue.verticalTextBoxStartIndex,ue.verticalTextBoxEndIndex,ue),this._addIconDebugCollisionBoxes(le,C,te,ue.iconBoxStartIndex,ue.iconBoxEndIndex,ue),this._addIconDebugCollisionBoxes(le,C,te,ue.verticalIconBoxStartIndex,ue.verticalIconBoxEndIndex,ue)}}getSymbolInstanceTextSize(C,te,le,ce){const he=this.text.placedSymbolArray.get(te.rightJustifiedTextSymbolIndex>=0?te.rightJustifiedTextSymbolIndex:te.centerJustifiedTextSymbolIndex>=0?te.centerJustifiedTextSymbolIndex:te.leftJustifiedTextSymbolIndex>=0?te.leftJustifiedTextSymbolIndex:te.verticalPlacedTextSymbolIndex>=0?te.verticalPlacedTextSymbolIndex:ce),ue=f_(this.textSizeData,C,he)/jg;return this.tilePixelRatio*ue}getSymbolInstanceIconSize(C,te,le){const ce=this.icon.placedSymbolArray.get(le),he=f_(this.iconSizeData,C,ce);return this.tilePixelRatio*he}_commitDebugCollisionVertexUpdate(C,te,le,ce){C.emplaceBack(te,-le,-le,ce),C.emplaceBack(te,le,-le,ce),C.emplaceBack(te,le,le,ce),C.emplaceBack(te,-le,le,ce)}_updateTextDebugCollisionBoxes(C,te,le,ce,he,ue){for(let de=ce;de<he;de++){const ce=le.get(de),he=this.getSymbolInstanceTextSize(C,ue,te,de);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,he,ce.padding,ue.zOffset)}}_updateIconDebugCollisionBoxes(C,te,le,ce,he,ue){for(let de=ce;de<he;de++){const ce=le.get(de),he=this.getSymbolInstanceIconSize(C,te,ue.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,he,ce.padding,ue.zOffset)}}updateCollisionDebugBuffers(C,te){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const le=m_(this.iconSizeData,C),ce=m_(this.textSizeData,C);for(let he=0;he<this.symbolInstances.length;he++){const ue=this.symbolInstances.get(he);this._updateTextDebugCollisionBoxes(ce,C,te,ue.textBoxStartIndex,ue.textBoxEndIndex,ue),this._updateTextDebugCollisionBoxes(ce,C,te,ue.verticalTextBoxStartIndex,ue.verticalTextBoxEndIndex,ue),this._updateIconDebugCollisionBoxes(le,C,te,ue.iconBoxStartIndex,ue.iconBoxEndIndex,ue),this._updateIconDebugCollisionBoxes(le,C,te,ue.verticalIconBoxStartIndex,ue.verticalIconBoxEndIndex,ue)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(C,te,le,ce,he,ue,de,_e,ye){const ve={};if(te<le){const{x1:le,y1:ce,x2:he,y2:ue,padding:de,projectedAnchorX:_e,projectedAnchorY:ye,projectedAnchorZ:Se,tileAnchorX:Me,tileAnchorY:Ae,featureIndex:Ce}=C.get(te);ve.textBox={x1:le,y1:ce,x2:he,y2:ue,padding:de,projectedAnchorX:_e,projectedAnchorY:ye,projectedAnchorZ:Se,tileAnchorX:Me,tileAnchorY:Ae},ve.textFeatureIndex=Ce}if(ce<he){const{x1:te,y1:le,x2:he,y2:ue,padding:de,projectedAnchorX:_e,projectedAnchorY:ye,projectedAnchorZ:Se,tileAnchorX:Me,tileAnchorY:Ae,featureIndex:Ce}=C.get(ce);ve.verticalTextBox={x1:te,y1:le,x2:he,y2:ue,padding:de,projectedAnchorX:_e,projectedAnchorY:ye,projectedAnchorZ:Se,tileAnchorX:Me,tileAnchorY:Ae},ve.verticalTextFeatureIndex=Ce}if(ue<de){const{x1:te,y1:le,x2:ce,y2:he,padding:de,projectedAnchorX:_e,projectedAnchorY:ye,projectedAnchorZ:Se,tileAnchorX:Me,tileAnchorY:Ae,featureIndex:Ce}=C.get(ue);ve.iconBox={x1:te,y1:le,x2:ce,y2:he,padding:de,projectedAnchorX:_e,projectedAnchorY:ye,projectedAnchorZ:Se,tileAnchorX:Me,tileAnchorY:Ae},ve.iconFeatureIndex=Ce}if(_e<ye){const{x1:te,y1:le,x2:ce,y2:he,padding:ue,projectedAnchorX:de,projectedAnchorY:ye,projectedAnchorZ:Se,tileAnchorX:Me,tileAnchorY:Ae,featureIndex:Ce}=C.get(_e);ve.verticalIconBox={x1:te,y1:le,x2:ce,y2:he,padding:ue,projectedAnchorX:de,projectedAnchorY:ye,projectedAnchorZ:Se,tileAnchorX:Me,tileAnchorY:Ae},ve.verticalIconFeatureIndex=Ce}return ve}deserializeCollisionBoxes(C){this.collisionArrays=[];for(let te=0;te<this.symbolInstances.length;te++){const le=this.symbolInstances.get(te);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(C,le.textBoxStartIndex,le.textBoxEndIndex,le.verticalTextBoxStartIndex,le.verticalTextBoxEndIndex,le.iconBoxStartIndex,le.iconBoxEndIndex,le.verticalIconBoxStartIndex,le.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(C,te){const le=C.placedSymbolArray.get(te),ce=le.vertexStartIndex+4*le.numGlyphs;for(let te=le.vertexStartIndex;te<ce;te+=4)C.indexArray.emplaceBack(te,te+1,te+2),C.indexArray.emplaceBack(te+1,te+2,te+3)}getSortedSymbolIndexes(C){if(this.sortedAngle===C&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;const te=Math.sin(C),le=Math.cos(C),ce=[],he=[],ue=[];for(let C=0;C<this.symbolInstances.length;++C){ue.push(C);const de=this.symbolInstances.get(C);ce.push(0|Math.round(te*de.tileAnchorX+le*de.tileAnchorY)),he.push(de.featureIndex)}return ue.sort(((C,te)=>ce[C]-ce[te]||he[te]-he[C])),ue}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let C=0;C<this.symbolInstances.length;++C)this.symbolInstanceIndexesSortedZOffset.push(C)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort(((C,te)=>this.symbolInstances.get(te).zOffset-this.symbolInstances.get(C).zOffset))}addToSortKeyRanges(C,te){const le=this.sortKeyRanges[this.sortKeyRanges.length-1];le&&le.sortKey===te?le.symbolInstanceEnd=C+1:this.sortKeyRanges.push({sortKey:te,symbolInstanceStart:C,symbolInstanceEnd:C+1})}sortFeatures(C){if(this.sortFeaturesByY&&this.sortedAngle!==C&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(C),this.sortedAngle=C,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const C of this.symbolInstanceIndexes){const te=this.symbolInstances.get(C);this.featureSortOrder.push(te.featureIndex);const{rightJustifiedTextSymbolIndex:le,centerJustifiedTextSymbolIndex:ce,leftJustifiedTextSymbolIndex:he,verticalPlacedTextSymbolIndex:ue,placedIconSymbolIndex:de,verticalPlacedIconSymbolIndex:_e}=te;le>=0&&this.addIndicesForPlacedSymbol(this.text,le),ce>=0&&ce!==le&&this.addIndicesForPlacedSymbol(this.text,ce),he>=0&&he!==ce&&he!==le&&this.addIndicesForPlacedSymbol(this.text,he),ue>=0&&this.addIndicesForPlacedSymbol(this.text,ue),de>=0&&this.addIndicesForPlacedSymbol(this.icon,de),_e>=0&&this.addIndicesForPlacedSymbol(this.icon,_e)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}Rs(_y,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),_y.MAX_GLYPHS=65535,_y.addDynamicAttributes=dy;var Nx=_y;const jx=Ia([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:Ux}=jx,Vx=Ia([{name:"a_packed",components:4,type:"Float32"}]),{members:Gx}=Vx,qx=y_.types,ev=Math.cos(Math.PI/180*37.5);class Ey{constructor(C){this.zoom=C.zoom,this.overscaling=C.overscaling,this.layers=C.layers,this.layerIds=this.layers.map((C=>C.fqid)),this.index=C.index,this.projection=C.projection,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((C=>{this.gradients[C.id]={}})),this.layoutVertexArray=new La,this.layoutVertexArray2=new ka,this.indexArray=new Wa,this.programConfigurations=new ec(C.layers,C.zoom),this.segments=new xl,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter((C=>C.isStateDependent())).map((C=>C.id))}populate(C,te,le,ce){this.hasPattern=Uf("line",this.layers,te);const he=this.layers[0].layout.get("line-sort-key"),ue=[];for(const{feature:te,id:de,index:_e,sourceLayerIndex:ye}of C){const C=this.layers[0]._featureFilter.needGeometry,ve=gp(te,C);if(!this.layers[0]._featureFilter.filter(new oa(this.zoom),ve,le))continue;const Se=he?he.evaluate(ve,{},le):void 0,Me={id:de,properties:te.properties,type:te.type,sourceLayerIndex:ye,index:_e,geometry:C?ve.geometry:_p(te,le,ce),patterns:{},sortKey:Se};ue.push(Me)}he&&ue.sort(((C,te)=>C.sortKey-te.sortKey));const{lineAtlas:de,featureIndex:_e}=te,ye=this.addConstantDashes(de);for(const ce of ue){const{geometry:he,index:ue,sourceLayerIndex:ve}=ce;if(ye&&this.addFeatureDashes(ce,de),this.hasPattern){const C=Vf("line",this.layers,ce,this.zoom,te);this.patternFeatures.push(C)}else this.addFeature(ce,he,ue,le,de.positions,te.availableImages,te.brightness);_e.insert(C[ue].feature,he,ue,ve,this.index)}}addConstantDashes(C){let te=!1;for(const le of this.layers){const ce=le.paint.get("line-dasharray").value,he=le.layout.get("line-cap").value;if("constant"!==ce.kind||"constant"!==he.kind)te=!0;else{const te=he.value,le=ce.value;if(!le)continue;C.addDash(le,te)}}return te}addFeatureDashes(C,te){const le=this.zoom;for(const ce of this.layers){const he=ce.paint.get("line-dasharray").value,ue=ce.layout.get("line-cap").value;if("constant"===he.kind&&"constant"===ue.kind)continue;let de,_e;if("constant"===he.kind){if(de=he.value,!de)continue}else de=he.evaluate({zoom:le},C);_e="constant"===ue.kind?ue.value:ue.evaluate({zoom:le},C),te.addDash(de,_e),C.patterns[ce.id]=te.getKey(de,_e)}}update(C,te,le,ce,he){const ue=0!==Object.keys(C).length;ue&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(C,te,ue?this.stateDependentLayers:this.layers,le,ce,he)}addFeatures(C,te,le,ce,he,ue){for(const C of this.patternFeatures)this.addFeature(C,C.geometry,C.index,te,le,ce,ue)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(C){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=C.createVertexBuffer(this.layoutVertexArray2,Gx)),this.layoutVertexBuffer=C.createVertexBuffer(this.layoutVertexArray,Ux),this.indexBuffer=C.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(C),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(C){if(C.properties&&C.properties.hasOwnProperty("mapbox_clip_start")&&C.properties.hasOwnProperty("mapbox_clip_end"))return{start:+C.properties.mapbox_clip_start,end:+C.properties.mapbox_clip_end}}addFeature(C,te,le,ce,he,ue,de){const _e=this.layers[0].layout,ye=_e.get("line-join").evaluate(C,{}),ve=_e.get("line-cap").evaluate(C,{}),Se=_e.get("line-miter-limit"),Me=_e.get("line-round-limit");this.lineClips=this.lineFeatureClips(C);for(const le of te)this.addLine(le,C,ye,ve,Se,Me);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,C,le,he,ue,ce,de)}addLine(C,te,le,ce,he,ue){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let te=0;te<C.length-1;te++)this.totalDistance+=C[te].dist(C[te+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const de="Polygon"===qx[te.type];let _e=C.length;for(;_e>=2&&C[_e-1].equals(C[_e-2]);)_e--;let ye=0;for(;ye<_e-1&&C[ye].equals(C[ye+1]);)ye++;if(_e<(de?3:2))return;"bevel"===le&&(he=1.05);const ve=this.overscaling<=16?15*Mn/(512*this.overscaling):0,Se=this.segments.prepareSegment(10*_e,this.layoutVertexArray,this.indexArray);let Me,Ae,Ce,Oe,Ne;this.e1=this.e2=-1,de&&(Me=C[_e-2],Ne=C[ye].sub(Me)._unit()._perp());for(let te=ye;te<_e;te++){if(Ce=te===_e-1?de?C[ye+1]:void 0:C[te+1],Ce&&C[te].equals(Ce))continue;Ne&&(Oe=Ne),Me&&(Ae=Me),Me=C[te],Ne=Ce?Ce.sub(Me)._unit()._perp():Oe,Oe=Oe||Ne;let je=Oe.add(Ne);0===je.x&&0===je.y||je._unit();const Ge=Oe.x*Ne.x+Oe.y*Ne.y,Ze=je.x*Ne.x+je.y*Ne.y,qe=0!==Ze?1/Ze:1/0,$e=2*Math.sqrt(2-2*Ze),He=Ze<ev&&Ae&&Ce,We=Oe.x*Ne.y-Oe.y*Ne.x>0;if(He&&te>ye){const C=Me.dist(Ae);if(C>2*ve){const te=Me.sub(Me.sub(Ae)._mult(ve/C)._round());this.updateDistance(Ae,te),this.addCurrentVertex(te,Oe,0,0,Se),Ae=te}}const Xe=Ae&&Ce;let Ye=Xe?le:de?"butt":ce;if(Xe&&"round"===Ye&&(qe<ue?Ye="miter":qe<=2&&(Ye="fakeround")),"miter"===Ye&&qe>he&&(Ye="bevel"),"bevel"===Ye&&(qe>2&&(Ye="flipbevel"),qe<he&&(Ye="miter")),Ae&&this.updateDistance(Ae,Me),"miter"===Ye)je._mult(qe),this.addCurrentVertex(Me,je,0,0,Se);else if("flipbevel"===Ye){if(qe>100)je=Ne.mult(-1);else{const C=qe*Oe.add(Ne).mag()/Oe.sub(Ne).mag();je._perp()._mult(C*(We?-1:1))}this.addCurrentVertex(Me,je,0,0,Se),this.addCurrentVertex(Me,je.mult(-1),0,0,Se)}else if("bevel"===Ye||"fakeround"===Ye){const C=-Math.sqrt(qe*qe-1),te=We?C:0,le=We?0:C;if(Ae&&this.addCurrentVertex(Me,Oe,te,le,Se),"fakeround"===Ye){const C=Math.round(180*$e/Math.PI/20);for(let te=1;te<C;te++){let le=te/C;if(.5!==le){const C=le-.5;le+=le*C*(le-1)*((1.0904+Ge*(Ge*(3.55645-1.43519*Ge)-3.2452))*C*C+(.848013+Ge*(.215638*Ge-1.06021)))}const ce=Ne.sub(Oe)._mult(le)._add(Oe)._unit()._mult(We?-1:1);this.addHalfVertex(Me,ce.x,ce.y,!1,We,0,Se)}}Ce&&this.addCurrentVertex(Me,Ne,-te,-le,Se)}else if("butt"===Ye)this.addCurrentVertex(Me,je,0,0,Se);else if("square"===Ye){const C=Ae?1:-1;Ae||this.addCurrentVertex(Me,je,C,C,Se),this.addCurrentVertex(Me,je,0,0,Se),Ae&&this.addCurrentVertex(Me,je,C,C,Se)}else"round"===Ye&&(Ae&&(this.addCurrentVertex(Me,Oe,0,0,Se),this.addCurrentVertex(Me,Oe,1,1,Se,!0)),Ce&&(this.addCurrentVertex(Me,Ne,-1,-1,Se,!0),this.addCurrentVertex(Me,Ne,0,0,Se)));if(He&&te<_e-1){const C=Me.dist(Ce);if(C>2*ve){const te=Me.add(Ce.sub(Me)._mult(ve/C)._round());this.updateDistance(Me,te),this.addCurrentVertex(te,Ne,0,0,Se),Me=te}}}}addCurrentVertex(C,te,le,ce,he,ue=!1){const de=te.y*ce-te.x,_e=-te.y-te.x*ce;this.addHalfVertex(C,te.x+te.y*le,te.y-te.x*le,ue,!1,le,he),this.addHalfVertex(C,de,_e,ue,!0,-ce,he)}addHalfVertex({x:C,y:te},le,ce,he,ue,de,_e){this.layoutVertexArray.emplaceBack((C<<1)+(he?1:0),(te<<1)+(ue?1:0),Math.round(63*le)+128,Math.round(63*ce)+128,1+(0===de?0:de<0?-1:1),0,this.lineSoFar),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineClips.start,this.lineClips.end);const ye=_e.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,ye),_e.primitiveLength++),ue?this.e2=ye:this.e1=ye}updateScaledDistance(){if(this.lineClips){const C=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=C*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(C,te){this.distance+=C.dist(te),this.updateScaledDistance()}}Rs(Ey,"LineBucket",{omit:["layers","patternFeatures"]});class My{constructor(C,te,le,ce){this.context=C,this.format=le,this.texture=C.gl.createTexture(),this.update(te,ce)}update(C,te,ce){const{width:he,height:ue}=C,{context:de}=this,{gl:_e}=de,{HTMLImageElement:ye,HTMLCanvasElement:ve,HTMLVideoElement:Se,ImageData:Me,ImageBitmap:Ae}=le;if(_e.bindTexture(_e.TEXTURE_2D,this.texture),de.pixelStoreUnpackFlipY.set(!1),de.pixelStoreUnpack.set(1),de.pixelStoreUnpackPremultiplyAlpha.set(this.format===_e.RGBA&&(!te||!1!==te.premultiply)),ce||this.size&&this.size[0]===he&&this.size[1]===ue){const{x:te,y:le}=ce||{x:0,y:0};if(C instanceof ye||C instanceof ve||C instanceof Se||C instanceof Me||Ae&&C instanceof Ae)_e.texSubImage2D(_e.TEXTURE_2D,0,te,le,_e.RGBA,_e.UNSIGNED_BYTE,C);else{let ce=this.format,de=_e.UNSIGNED_BYTE;this.format===_e.R32F&&(ce=_e.RED,de=_e.FLOAT),_e.texSubImage2D(_e.TEXTURE_2D,0,te,le,he,ue,ce,de,C.data)}}else if(this.size=[he,ue],C instanceof ye||C instanceof ve||C instanceof Se||C instanceof Me||Ae&&C instanceof Ae){let te=this.format;this.format===_e.R8&&(te=_e.RED),_e.texImage2D(_e.TEXTURE_2D,0,this.format,te,_e.UNSIGNED_BYTE,C)}else{let te=this.format,le=this.format,ce=_e.UNSIGNED_BYTE;this.format===_e.DEPTH_COMPONENT&&(te=_e.DEPTH_COMPONENT16,ce=_e.UNSIGNED_SHORT),this.format===_e.R32F&&(ce=_e.FLOAT,le=_e.RED),_e.texImage2D(_e.TEXTURE_2D,0,te,he,ue,0,le,ce,C.data)}this.useMipmap=Boolean(te&&te.useMipmap),this.useMipmap&&_e.generateMipmap(_e.TEXTURE_2D)}bind(C,te){const{context:le}=this,{gl:ce}=le;ce.bindTexture(ce.TEXTURE_2D,this.texture),C!==this.minFilter&&(ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_MAG_FILTER,C),ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_MIN_FILTER,this.useMipmap?C===ce.NEAREST?ce.NEAREST_MIPMAP_NEAREST:ce.LINEAR_MIPMAP_NEAREST:C),this.minFilter=C),te!==this.wrapS&&(ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_WRAP_S,te),ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_WRAP_T,te),this.wrapS=te)}bindExtraParam(C,te,le,ce){const{context:he}=this,{gl:ue}=he;ue.bindTexture(ue.TEXTURE_2D,this.texture),te!==this.magFilter&&(ue.texParameteri(ue.TEXTURE_2D,ue.TEXTURE_MAG_FILTER,te),this.magFilter=te),C!==this.minFilter&&(ue.texParameteri(ue.TEXTURE_2D,ue.TEXTURE_MIN_FILTER,this.useMipmap?C===ue.NEAREST?ue.NEAREST_MIPMAP_NEAREST:ue.LINEAR_MIPMAP_NEAREST:C),this.minFilter=C),le!==this.wrapS&&(ue.texParameteri(ue.TEXTURE_2D,ue.TEXTURE_WRAP_S,le),this.wrapS=le),ce!==this.wrapT&&(ue.texParameteri(ue.TEXTURE_2D,ue.TEXTURE_WRAP_T,ce),this.wrapT=ce)}destroy(){const{gl:C}=this.context;C.deleteTexture(this.texture),this.texture=null}}class Ay{constructor(C,te){this.context=C,this.texture=te}bind(C,te){const{context:le}=this,{gl:ce}=le;ce.bindTexture(ce.TEXTURE_2D,this.texture),C!==this.minFilter&&(ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_MAG_FILTER,C),ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_MIN_FILTER,C),this.minFilter=C),te!==this.wrapS&&(ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_WRAP_S,te),ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_WRAP_T,te),this.wrapS=te)}}const nv=32,ov=33,Sv=new Uint16Array(8184);for(let C=0;C<2046;C++){let te=C+2,le=0,ce=0,he=0,ue=0,de=0,_e=0;for(1&te?he=ue=de=nv:le=ce=_e=nv;(te>>=1)>1;){const C=le+he>>1,ye=ce+ue>>1;1&te?(he=le,ue=ce,le=de,ce=_e):(le=he,ce=ue,he=de,ue=_e),de=C,_e=ye}const ye=4*C;Sv[ye+0]=le,Sv[ye+1]=ce,Sv[ye+2]=he,Sv[ye+3]=ue}const Iv=new Uint16Array(2178),Fv=new Uint8Array(1089),Nv=new Uint16Array(1089);function Ry(C){return 0===C?-.03125:32===C?.03125:0}var Uv=Ia([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);const Vv={type:2,extent:Mn,loadGeometry:()=>[[new je(0,0),new je(Mn+1,0),new je(Mn+1,Mn+1),new je(0,Mn+1),new je(0,0)]]};class Oy{constructor(C,te,le,ce,he){this.tileID=C,this.uid=F(),this.uses=0,this.tileSize=te,this.tileZoom=le,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=he,ce&&ce.style&&(this._lastUpdatedBrightness=ce.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",ce&&ce.transform&&(this.projection=ce.transform.projection)}registerFadeDuration(C){const te=C+this.timeAdded;te<bi.now()||this.fadeEndTime&&te<this.fadeEndTime||(this.fadeEndTime=te)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}get tileTransform(){return this._tileTransform||(this._tileTransform=Pg(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(C,te,le){if(this.unloadVectorData(),this.state="loaded",C){C.featureIndex&&(this.latestFeatureIndex=C.featureIndex,C.rawTileData?(this.latestRawTileData=C.rawTileData,this.latestFeatureIndex.rawTileData=C.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=C.collisionBoxArray,this.buckets=function(C,te){const le={};if(!te)return le;for(const ce of C){const C=ce.layerIds.map((C=>te.getLayer(C))).filter(Boolean);if(0!==C.length){ce.layers=C,ce.stateDependentLayerIds&&(ce.stateDependentLayers=ce.stateDependentLayerIds.map((te=>C.filter((C=>C.id===te))[0])));for(const te of C)le[te.fqid]=ce}}return le}(C.buckets,te.style),this.hasSymbolBuckets=!1;for(const C in this.buckets){const te=this.buckets[C];if(te instanceof Nx){if(this.hasSymbolBuckets=!0,!le)break;te.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const C in this.buckets){const te=this.buckets[C];if(te instanceof Nx&&te.hasRTLText){this.hasRTLText=!0,lc.isLoading()||lc.isLoaded()||"deferred"!==ia()||ra();break}}this.queryPadding=0;for(const C in this.buckets){const le=this.buckets[C],ce=te.style.getOwnLayer(C);if(!ce)continue;const he=ce.queryRadius(le);this.queryPadding=Math.max(this.queryPadding,he)}C.imageAtlas&&(this.imageAtlas=C.imageAtlas),C.glyphAtlasImage&&(this.glyphAtlasImage=C.glyphAtlasImage),C.lineAtlas&&(this.lineAtlas=C.lineAtlas),this._lastUpdatedBrightness=C.brightness}else this.collisionBoxArray=new al}unloadVectorData(){if(this.hasData()){for(const C in this.buckets)this.buckets[C].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(C){return this.buckets[C.fqid]}upload(C){for(const te in this.buckets){const le=this.buckets[te];le.uploadPending()&&le.upload(C)}const te=C.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new My(C,this.imageAtlas.image,te.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new My(C,this.glyphAtlasImage,te.ALPHA),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new My(C,this.lineAtlas.image,te.ALPHA),this.lineAtlas.uploaded=!0)}prepare(C,te,le){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(C,this.imageAtlasTexture,le),!te||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const ce=te.style.getBrightness();(this._lastUpdatedBrightness||ce)&&(this._lastUpdatedBrightness&&ce&&Math.abs(this._lastUpdatedBrightness-ce)<.001||(this._lastUpdatedBrightness=ce,this.updateBuckets(void 0,te)))}queryRenderedFeatures(C,te,le,ce,he,ue,de,_e){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({tileResult:ce,pixelPosMatrix:de,transform:ue,params:he,tileTransform:this.tileTransform},C,te,le):{}}querySourceFeatures(C,te){const le=this.latestFeatureIndex;if(!le||!le.rawTileData)return;const ce=le.loadVTLayers(),he=te?te.sourceLayer:"",ue=ce._geojsonTileLayer||ce[he];if(!ue)return;const de=Fo(te&&te.filter),{z:_e,x:ye,y:ve}=this.tileID.canonical,Se={z:_e,x:ye,y:ve};for(let te=0;te<ue.length;te++){const ce=ue.feature(te);if(de.needGeometry){const C=gp(ce,!0);if(!de.filter(new oa(this.tileID.overscaledZ),C,this.tileID.canonical))continue}else if(!de.filter(new oa(this.tileID.overscaledZ),ce))continue;const Me=le.getId(ce,he),Ae=new Bm(ce,_e,ye,ve,Me);Ae.tile=Se,C.push(Ae)}}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}bucketsLoaded(){for(const C in this.buckets)if(this.buckets[C].uploadPending())return!1;return!0}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(C){const te=this.expirationTime;if(C.cacheControl){const te=ee(C.cacheControl);te["max-age"]&&(this.expirationTime=Date.now()+1e3*te["max-age"])}else C.expires&&(this.expirationTime=new Date(C.expires).getTime());if(this.expirationTime){const C=Date.now();let le=!1;if(this.expirationTime>C)le=!1;else if(te)if(this.expirationTime<te)le=!0;else{const ce=this.expirationTime-te;ce?this.expirationTime=C+Math.max(ce,3e4):le=!0}else le=!0;le?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)}setFeatureState(C,te){this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData&&0!==Object.keys(C).length&&te&&this.updateBuckets(C,te)}updateBuckets(C,te){if(!this.latestFeatureIndex)return;const le=this.latestFeatureIndex.loadVTLayers(),ce=te.style.listImages(),he=te.style.getBrightness();for(const ue in this.buckets){if(!te.style.hasLayer(ue))continue;const de=this.buckets[ue],_e=de.layers[0].sourceLayer||"_geojsonTileLayer",ye=le[_e];let ve={};if(C&&(ve=C[_e],!ye||!ve||0===Object.keys(ve).length))continue;if(de.update(ve,ye,ce,this.imageAtlas&&this.imageAtlas.patternPositions||{},he),de instanceof Ey||de instanceof jf){const C=te.style.getOwnSourceCache(de.layers[0].source);te._terrain&&te._terrain.enabled&&C&&de.programConfigurations.needsUpload&&te._terrain._clearRenderCacheForTile(C.id,this.tileID)}const Se=te&&te.style&&te.style.getOwnLayer(ue);Se&&(this.queryPadding=Math.max(this.queryPadding,Se.queryRadius(de)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<bi.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(C){this.symbolFadeHoldUntil=bi.now()+C}setTexture(C,te){const le=te.context,ce=le.gl;this.texture=this.texture||te.getTileTexture(C.width),this.texture&&this.texture instanceof My?this.texture.update(C,{useMipmap:!0}):(this.texture=new My(le,C,ce.RGBA,{useMipmap:!0}),this.texture.bind(ce.LINEAR,ce.CLAMP_TO_EDGE))}setDependencies(C,te){const le={};for(const C of te)le[C]=!0;this.dependencies[C]=le}hasDependency(C,te){for(const le of C){const C=this.dependencies[le];if(C)for(const le of te)if(C[le])return!0}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(C,te){if(!te||"mercator"===te.name||this._tileDebugBuffer)return;const le=_p(Vv,this.tileID.canonical,this.tileTransform)[0],ce=new za,he=new el;for(let C=0;C<le.length;C++){const{x:te,y:ue}=le[C];ce.emplaceBack(te,ue),he.emplaceBack(C)}he.emplaceBack(0),this._tileDebugIndexBuffer=C.createIndexBuffer(he),this._tileDebugBuffer=C.createVertexBuffer(ce,rp.members),this._tileDebugSegments=xl.simpleSegment(0,0,ce.length,he.length)}_makeTileBoundsBuffers(C,te){if(this._tileBoundsBuffer||!te||"mercator"===te.name)return;const le=_p(Vv,this.tileID.canonical,this.tileTransform)[0];let ce,he;if(this.isRaster){const C=function(C,te){const le=Pg(C,te),ce=Math.pow(2,C.z);for(let he=0;he<ov;he++)for(let ue=0;ue<ov;ue++){const de=ep((C.x+(ue+Ry(ue))/nv)/ce),_e=tp((C.y+(he+Ry(he))/nv)/ce),ye=te.project(de,_e),ve=he*ov+ue;Iv[2*ve+0]=Math.round((ye.x*le.scale-le.x)*Mn),Iv[2*ve+1]=Math.round((ye.y*le.scale-le.y)*Mn)}Fv.fill(0),Nv.fill(0);for(let C=2045;C>=0;C--){const te=4*C,le=Sv[te+0],ce=Sv[te+1],he=Sv[te+2],ue=Sv[te+3],de=le+he>>1,_e=ce+ue>>1,ye=de+_e-ce,ve=_e+le-de,Se=ce*ov+le,Me=ue*ov+he,Ae=_e*ov+de,Ce=Math.hypot((Iv[2*Se+0]+Iv[2*Me+0])/2-Iv[2*Ae+0],(Iv[2*Se+1]+Iv[2*Me+1])/2-Iv[2*Ae+1])>=16;Fv[Ae]=Fv[Ae]||(Ce?1:0),C<1022&&(Fv[Ae]=Fv[Ae]||Fv[(ce+ve>>1)*ov+(le+ye>>1)]||Fv[(ue+ve>>1)*ov+(he+ye>>1)])}const he=new Da,ue=new Wa;let de=0;function a(C,te){const le=te*ov+C;return 0===Nv[le]&&(he.emplaceBack(Iv[2*le+0],Iv[2*le+1],C*Mn/nv,te*Mn/nv),Nv[le]=++de),Nv[le]-1}function l(C,te,le,ce,he,de){const _e=C+le>>1,ye=te+ce>>1;if(Math.abs(C-he)+Math.abs(te-de)>1&&Fv[ye*ov+_e])l(he,de,C,te,_e,ye),l(le,ce,he,de,_e,ye);else{const _e=a(C,te),ye=a(le,ce),ve=a(he,de);ue.emplaceBack(_e,ye,ve)}}return l(0,0,nv,nv,nv,0),l(nv,nv,0,0,0,nv),{vertices:he,indices:ue}}(this.tileID.canonical,te);ce=C.vertices,he=C.indices}else{ce=new Da,he=new Wa;for(const{x:C,y:te}of le)ce.emplaceBack(C,te,0,0);const C=xm(ce.int16,void 0,4);for(let te=0;te<C.length;te+=3)he.emplaceBack(C[te],C[te+1],C[te+2])}this._tileBoundsBuffer=C.createVertexBuffer(ce,Uv.members),this._tileBoundsIndexBuffer=C.createIndexBuffer(he),this._tileBoundsSegments=xl.simpleSegment(0,0,ce.length,he.length)}_makeGlobeTileDebugBuffers(C,te){const le=te.projection;if(!le||"globe"!==le.name||te.freezeTileCoverage)return;const ce=this.tileID.canonical,he=Ad(_d(ce,te)),ue=Dd(te.zoom);let de;ue>0&&(de=ld.invert(new Float64Array(16),te.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(C,ce,te,he,de,ue),this._makeGlobeTileDebugTextBuffer(C,ce,te,he,de,ue)}_globePoint(C,te,le,ce,he,ue,de){let _e=Td(C,te,le);if(ue){const he=1<<le.z,ye=Kd(ce.center.lng),ve=Jd(ce.center.lat),Se=(le.x+.5)/he-ye;let Me=0;Se>.5?Me=-1:Se<-.5&&(Me=1);let Ae=(C/Mn+le.x)/he+Me,Ce=(te/Mn+le.y)/he;Ae=(Ae-ye)*ce._pixelsPerMercatorPixel+ye,Ce=(Ce-ve)*ce._pixelsPerMercatorPixel+ve;const Oe=[Ae*ce.worldSize,Ce*ce.worldSize,0];Zd.transformMat4(Oe,Oe,ue),_e=md(_e,Oe,de)}return Zd.transformMat4(_e,_e,he)}_makeGlobeTileDebugBorderBuffer(C,te,le,ce,he,ue){const de=new za,_e=new el,ye=new Pa,c=(C,ve,Se,Me,Ae)=>{const Ce=(Se-C)/(Ae-1),Oe=(Me-ve)/(Ae-1),Ne=de.length;for(let Se=0;Se<Ae;Se++){const Me=C+Se*Ce,Ae=ve+Se*Oe;de.emplaceBack(Me,Ae);const je=this._globePoint(Me,Ae,te,le,ce,he,ue);ye.emplaceBack(je[0],je[1],je[2]),_e.emplaceBack(Ne+Se)}},ve=Mn;c(0,0,ve,0,16),c(ve,0,ve,ve,16),c(ve,ve,0,ve,16),c(0,ve,0,0,16),this._tileDebugIndexBuffer=C.createIndexBuffer(_e),this._tileDebugBuffer=C.createVertexBuffer(de,rp.members),this._globeTileDebugBorderBuffer=C.createVertexBuffer(ye,Xd.members),this._tileDebugSegments=xl.simpleSegment(0,0,de.length,_e.length)}_makeGlobeTileDebugTextBuffer(C,te,le,ce,he,ue){const de=Mn/4,_e=new za,ye=new Wa,ve=new Pa,Se=25;ye.reserve(32),_e.reserve(Se),ve.reserve(Se);const u=(C,te)=>Se*C+te;for(let C=0;C<Se;C++){const ye=C*de;for(let C=0;C<Se;C++){const Se=C*de;_e.emplaceBack(Se,ye);const Me=this._globePoint(Se,ye,te,le,ce,he,ue);ve.emplaceBack(Me[0],Me[1],Me[2])}}for(let C=0;C<4;C++)for(let te=0;te<4;te++){const le=u(C,te),ce=u(C,te+1),he=u(C+1,te),ue=u(C+1,te+1);ye.emplaceBack(le,ce,he),ye.emplaceBack(he,ce,ue)}this._tileDebugTextIndexBuffer=C.createIndexBuffer(ye),this._tileDebugTextBuffer=C.createVertexBuffer(_e,rp.members),this._globeTileDebugTextBuffer=C.createVertexBuffer(ve,Xd.members),this._tileDebugTextSegments=xl.simpleSegment(0,0,Se,32)}destroy(C=!1){for(const C in this.buckets)this.buckets[C].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!C&&this.texture&&this.texture instanceof My&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.latestFeatureIndex=null,this.state="unloaded"}}class By{constructor(C,te){this.max=C,this.onRemove=te,this.reset()}reset(){for(const C in this.data)for(const te of this.data[C])te.timeout&&clearTimeout(te.timeout),this.onRemove(te.value);return this.data={},this.order=[],this}add(C,te,le){const ce=C.wrapped().key;void 0===this.data[ce]&&(this.data[ce]=[]);const he={value:te,timeout:void 0};if(void 0!==le&&(he.timeout=setTimeout((()=>{this.remove(C,he)}),le)),this.data[ce].push(he),this.order.push(ce),this.order.length>this.max){const C=this._getAndRemoveByKey(this.order[0]);C&&this.onRemove(C)}return this}has(C){return C.wrapped().key in this.data}getAndRemove(C){return this.has(C)?this._getAndRemoveByKey(C.wrapped().key):null}_getAndRemoveByKey(C){const te=this.data[C].shift();return te.timeout&&clearTimeout(te.timeout),0===this.data[C].length&&delete this.data[C],this.order.splice(this.order.indexOf(C),1),te.value}getByKey(C){const te=this.data[C];return te?te[0].value:null}get(C){return this.has(C)?this.data[C.wrapped().key][0].value:null}remove(C,te){if(!this.has(C))return this;const le=C.wrapped().key,ce=void 0===te?0:this.data[le].indexOf(te),he=this.data[le][ce];return this.data[le].splice(ce,1),he.timeout&&clearTimeout(he.timeout),0===this.data[le].length&&delete this.data[le],this.onRemove(he.value),this.order.splice(this.order.indexOf(le),1),this}setMaxSize(C){for(this.max=C;this.order.length>this.max;){const C=this._getAndRemoveByKey(this.order[0]);C&&this.onRemove(C)}return this}filter(C){const te=[];for(const le in this.data)for(const ce of this.data[le])C(ce.value)||te.push(ce);for(const C of te)this.remove(C.value.tileID,C)}}class Fy{constructor(C,te,le,ce){this.id=Fy.uniqueIdxCounter,Fy.uniqueIdxCounter++,this.context=C;const he=C.gl;this.buffer=he.createBuffer(),this.dynamicDraw=Boolean(le),this.context.unbindVAO(),C.bindElementBuffer.set(this.buffer),he.bufferData(he.ELEMENT_ARRAY_BUFFER,te.arrayBuffer,this.dynamicDraw?he.DYNAMIC_DRAW:he.STATIC_DRAW),this.dynamicDraw||ce||te.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(C){this.id=Fy.uniqueIdxCounter,Fy.uniqueIdxCounter++;const te=this.context.gl;this.context.unbindVAO(),this.bind(),te.bufferSubData(te.ELEMENT_ARRAY_BUFFER,0,C.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}Fy.uniqueIdxCounter=0;const Gv={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Uy{constructor(C,te,le,ce,he,ue){this.length=te.length,this.attributes=le,this.itemSize=te.bytesPerElement,this.dynamicDraw=ce,this.instanceCount=ue,this.context=C;const de=C.gl;this.buffer=de.createBuffer(),C.bindVertexBuffer.set(this.buffer),de.bufferData(de.ARRAY_BUFFER,te.arrayBuffer,this.dynamicDraw?de.DYNAMIC_DRAW:de.STATIC_DRAW),this.dynamicDraw||he||te.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(C){const te=this.context.gl;this.bind(),te.bufferSubData(te.ARRAY_BUFFER,0,C.arrayBuffer)}enableAttributes(C,te){for(let le=0;le<this.attributes.length;le++){const ce=te.attributes[this.attributes[le].name];void 0!==ce&&C.enableVertexAttribArray(ce)}}setVertexAttribPointers(C,te,le){for(let ce=0;ce<this.attributes.length;ce++){const he=this.attributes[ce],ue=te.attributes[he.name];void 0!==ue&&C.vertexAttribPointer(ue,he.components,C[Gv[he.type]],!1,this.itemSize,he.offset+this.itemSize*(le||0))}}setVertexAttribDivisor(C,te,le){for(let ce=0;ce<this.attributes.length;ce++){const he=te.attributes[this.attributes[ce].name];void 0!==he&&this.instanceCount&&this.instanceCount>0&&C.vertexAttribDivisor(he,le)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Vy{constructor(C){this.gl=C.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(C){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class jy extends Vy{getDefault(){return qr.transparent}set(C){const te=this.current;(C.r!==te.r||C.g!==te.g||C.b!==te.b||C.a!==te.a||this.dirty)&&(this.gl.clearColor(C.r,C.g,C.b,C.a),this.current=C,this.dirty=!1)}}class Gy extends Vy{getDefault(){return 1}set(C){(C!==this.current||this.dirty)&&(this.gl.clearDepth(C),this.current=C,this.dirty=!1)}}class qy extends Vy{getDefault(){return 0}set(C){(C!==this.current||this.dirty)&&(this.gl.clearStencil(C),this.current=C,this.dirty=!1)}}class Zy extends Vy{getDefault(){return[!0,!0,!0,!0]}set(C){const te=this.current;(C[0]!==te[0]||C[1]!==te[1]||C[2]!==te[2]||C[3]!==te[3]||this.dirty)&&(this.gl.colorMask(C[0],C[1],C[2],C[3]),this.current=C,this.dirty=!1)}}class $y extends Vy{getDefault(){return!0}set(C){(C!==this.current||this.dirty)&&(this.gl.depthMask(C),this.current=C,this.dirty=!1)}}class Wy extends Vy{getDefault(){return 255}set(C){(C!==this.current||this.dirty)&&(this.gl.stencilMask(C),this.current=C,this.dirty=!1)}}class Hy extends Vy{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(C){const te=this.current;(C.func!==te.func||C.ref!==te.ref||C.mask!==te.mask||this.dirty)&&(this.gl.stencilFunc(C.func,C.ref,C.mask),this.current=C,this.dirty=!1)}}class Xy extends Vy{getDefault(){const C=this.gl;return[C.KEEP,C.KEEP,C.KEEP]}set(C){const te=this.current;(C[0]!==te[0]||C[1]!==te[1]||C[2]!==te[2]||this.dirty)&&(this.gl.stencilOp(C[0],C[1],C[2]),this.current=C,this.dirty=!1)}}class Yy extends Vy{getDefault(){return!1}set(C){if(C===this.current&&!this.dirty)return;const te=this.gl;C?te.enable(te.STENCIL_TEST):te.disable(te.STENCIL_TEST),this.current=C,this.dirty=!1}}class Ky extends Vy{getDefault(){return[0,1]}set(C){const te=this.current;(C[0]!==te[0]||C[1]!==te[1]||this.dirty)&&(this.gl.depthRange(C[0],C[1]),this.current=C,this.dirty=!1)}}class Jy extends Vy{getDefault(){return!1}set(C){if(C===this.current&&!this.dirty)return;const te=this.gl;C?te.enable(te.DEPTH_TEST):te.disable(te.DEPTH_TEST),this.current=C,this.dirty=!1}}class Qy extends Vy{getDefault(){return this.gl.LESS}set(C){(C!==this.current||this.dirty)&&(this.gl.depthFunc(C),this.current=C,this.dirty=!1)}}class ex extends Vy{getDefault(){return!1}set(C){if(C===this.current&&!this.dirty)return;const te=this.gl;C?te.enable(te.BLEND):te.disable(te.BLEND),this.current=C,this.dirty=!1}}class tx extends Vy{getDefault(){const C=this.gl;return[C.ONE,C.ZERO,C.ONE,C.ZERO]}set(C){const te=this.current;(C[0]!==te[0]||C[1]!==te[1]||C[2]!==te[2]||C[3]!==te[3]||this.dirty)&&(this.gl.blendFuncSeparate(C[0],C[1],C[2],C[3]),this.current=C,this.dirty=!1)}}class ix extends Vy{getDefault(){return qr.transparent}set(C){const te=this.current;(C.r!==te.r||C.g!==te.g||C.b!==te.b||C.a!==te.a||this.dirty)&&(this.gl.blendColor(C.r,C.g,C.b,C.a),this.current=C,this.dirty=!1)}}class rx extends Vy{getDefault(){return this.gl.FUNC_ADD}set(C){(C!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(C,C),this.current=C,this.dirty=!1)}}class nx extends Vy{getDefault(){return!1}set(C){if(C===this.current&&!this.dirty)return;const te=this.gl;C?te.enable(te.CULL_FACE):te.disable(te.CULL_FACE),this.current=C,this.dirty=!1}}class ox extends Vy{getDefault(){return this.gl.BACK}set(C){(C!==this.current||this.dirty)&&(this.gl.cullFace(C),this.current=C,this.dirty=!1)}}class sx extends Vy{getDefault(){return this.gl.CCW}set(C){(C!==this.current||this.dirty)&&(this.gl.frontFace(C),this.current=C,this.dirty=!1)}}let rb=class extends Vy{getDefault(){return null}set(C){(C!==this.current||this.dirty)&&(this.gl.useProgram(C),this.current=C,this.dirty=!1)}};class lx extends Vy{getDefault(){return this.gl.TEXTURE0}set(C){(C!==this.current||this.dirty)&&(this.gl.activeTexture(C),this.current=C,this.dirty=!1)}}class cx extends Vy{getDefault(){const C=this.gl;return[0,0,C.drawingBufferWidth,C.drawingBufferHeight]}set(C){const te=this.current;(C[0]!==te[0]||C[1]!==te[1]||C[2]!==te[2]||C[3]!==te[3]||this.dirty)&&(this.gl.viewport(C[0],C[1],C[2],C[3]),this.current=C,this.dirty=!1)}}class hx extends Vy{getDefault(){return null}set(C){if(C===this.current&&!this.dirty)return;const te=this.gl;te.bindFramebuffer(te.FRAMEBUFFER,C),this.current=C,this.dirty=!1}}class ux extends Vy{getDefault(){return null}set(C){if(C===this.current&&!this.dirty)return;const te=this.gl;te.bindRenderbuffer(te.RENDERBUFFER,C),this.current=C,this.dirty=!1}}class dx extends Vy{getDefault(){return null}set(C){if(C===this.current&&!this.dirty)return;const te=this.gl;te.bindTexture(te.TEXTURE_2D,C),this.current=C,this.dirty=!1}}class px extends Vy{getDefault(){return null}set(C){if(C===this.current&&!this.dirty)return;const te=this.gl;te.bindBuffer(te.ARRAY_BUFFER,C),this.current=C,this.dirty=!1}}class fx extends Vy{getDefault(){return null}set(C){const te=this.gl;te.bindBuffer(te.ELEMENT_ARRAY_BUFFER,C),this.current=C,this.dirty=!1}}class mx extends Vy{getDefault(){return null}set(C){this.gl&&(C!==this.current||this.dirty)&&(this.gl.bindVertexArray(C),this.current=C,this.dirty=!1)}}class _x extends Vy{getDefault(){return 4}set(C){if(C===this.current&&!this.dirty)return;const te=this.gl;te.pixelStorei(te.UNPACK_ALIGNMENT,C),this.current=C,this.dirty=!1}}class gx extends Vy{getDefault(){return!1}set(C){if(C===this.current&&!this.dirty)return;const te=this.gl;te.pixelStorei(te.UNPACK_PREMULTIPLY_ALPHA_WEBGL,C),this.current=C,this.dirty=!1}}class yx extends Vy{getDefault(){return!1}set(C){if(C===this.current&&!this.dirty)return;const te=this.gl;te.pixelStorei(te.UNPACK_FLIP_Y_WEBGL,C),this.current=C,this.dirty=!1}}class xx extends Vy{constructor(C,te){super(C),this.context=C,this.parent=te}getDefault(){return null}}class vx extends xx{setDirty(){this.dirty=!0}set(C){if(C===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const te=this.gl;te.framebufferTexture2D(te.FRAMEBUFFER,te.COLOR_ATTACHMENT0,te.TEXTURE_2D,C,0),this.current=C,this.dirty=!1}}class bx extends xx{attachment(){return this.gl.DEPTH_ATTACHMENT}set(C){if(C===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const te=this.gl;te.framebufferRenderbuffer(te.FRAMEBUFFER,this.attachment(),te.RENDERBUFFER,C),this.current=C,this.dirty=!1}}class wx extends xx{attachment(){return this.gl.DEPTH_ATTACHMENT}set(C){if(C===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const te=this.gl;te.framebufferTexture2D(te.FRAMEBUFFER,this.attachment(),te.TEXTURE_2D,C,0),this.current=C,this.dirty=!1}}class Tx extends bx{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class Ex{constructor(C,te,le,ce,he){this.context=C,this.width=te,this.height=le;const ue=this.framebuffer=C.gl.createFramebuffer();ce&&(this.colorAttachment=new vx(C,ue)),he&&(this.depthAttachmentType=he,this.depthAttachment="renderbuffer"===he?new bx(C,ue):new wx(C,ue))}destroy(){const C=this.context.gl;if(this.colorAttachment){const te=this.colorAttachment.get();te&&C.deleteTexture(te)}if(this.depthAttachment&&this.depthAttachmentType)if("renderbuffer"===this.depthAttachmentType){const te=this.depthAttachment.get();te&&C.deleteRenderbuffer(te)}else{const te=this.depthAttachment.get();te&&C.deleteTexture(te)}C.deleteFramebuffer(this.framebuffer)}}class Mx{constructor(C,te,le){this.func=C,this.mask=te,this.range=le}}Mx.ReadOnly=!1,Mx.ReadWrite=!0,Mx.disabled=new Mx(519,Mx.ReadOnly,[0,1]);const nb=7680;class Sx{constructor(C,te,le,ce,he,ue){this.test=C,this.ref=te,this.mask=le,this.fail=ce,this.depthFail=he,this.pass=ue}}Sx.disabled=new Sx({func:519,mask:0},0,0,nb,nb,nb);const ob=771;class Cx{constructor(C,te,le,ce){this.blendFunction=C,this.blendColor=te,this.mask=le,this.blendEquation=ce}}Cx.Replace=[1,0,1,0],Cx.disabled=new Cx(Cx.Replace,qr.transparent,[!1,!1,!1,!1]),Cx.unblended=new Cx(Cx.Replace,qr.transparent,[!0,!0,!0,!0]),Cx.alphaBlended=new Cx([1,ob,1,ob],qr.transparent,[!0,!0,!0,!0]),Cx.multiply=new Cx([774,0,774,0],qr.transparent,[!0,!0,!0,!0]);const sb=1029,ab=2305;class Dx{constructor(C,te,le){this.enable=C,this.mode=te,this.frontFace=le}}Dx.disabled=new Dx(!1,sb,ab),Dx.backCCW=new Dx(!0,sb,ab),Dx.backCW=new Dx(!0,sb,2304),Dx.frontCW=new Dx(!0,1028,2304),Dx.frontCCW=new Dx(!0,1028,ab);class Rx{constructor(C,te){this.gl=C,this.clearColor=new jy(this),this.clearDepth=new Gy(this),this.clearStencil=new qy(this),this.colorMask=new Zy(this),this.depthMask=new $y(this),this.stencilMask=new Wy(this),this.stencilFunc=new Hy(this),this.stencilOp=new Xy(this),this.stencilTest=new Yy(this),this.depthRange=new Ky(this),this.depthTest=new Jy(this),this.depthFunc=new Qy(this),this.blend=new ex(this),this.blendFunc=new tx(this),this.blendColor=new ix(this),this.blendEquation=new rx(this),this.cullFace=new nx(this),this.cullFaceSide=new ox(this),this.frontFace=new sx(this),this.program=new rb(this),this.activeTexture=new lx(this),this.viewport=new cx(this),this.bindFramebuffer=new hx(this),this.bindRenderbuffer=new ux(this),this.bindTexture=new dx(this),this.bindVertexBuffer=new px(this),this.bindElementBuffer=new fx(this),this.bindVertexArrayOES=new mx(this),this.pixelStoreUnpack=new _x(this),this.pixelStoreUnpackPremultiplyAlpha=new gx(this),this.pixelStoreUnpackFlipY=new yx(this),this.options=te?{...te}:{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=C.getExtension("EXT_texture_filter_anisotropic")||C.getExtension("MOZ_EXT_texture_filter_anisotropic")||C.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=C.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=C.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=C.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=C.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=C.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=C.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=C.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=C.getParameter(C.MAX_TEXTURE_SIZE)}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(C,te,le){return new Fy(this,C,te,le)}createVertexBuffer(C,te,le,ce,he){return new Uy(this,C,te,le,ce,he)}createRenderbuffer(C,te,le){const ce=this.gl,he=ce.createRenderbuffer();return this.bindRenderbuffer.set(he),ce.renderbufferStorage(ce.RENDERBUFFER,C,te,le),this.bindRenderbuffer.set(null),he}createFramebuffer(C,te,le,ce){return new Ex(this,C,te,le,ce)}clear({color:C,depth:te,stencil:le,colorMask:ce}){const he=this.gl;let ue=0;C&&(ue|=he.COLOR_BUFFER_BIT,this.clearColor.set(C),this.colorMask.set(ce||[!0,!0,!0,!0])),void 0!==te&&(ue|=he.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(te),this.depthMask.set(!0)),void 0!==le&&(ue|=he.STENCIL_BUFFER_BIT,this.clearStencil.set(le),this.stencilMask.set(255)),he.clear(ue)}setCullFace(C){!1===C.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(C.mode),this.frontFace.set(C.frontFace))}setDepthMode(C){C.func!==this.gl.ALWAYS||C.mask?(this.depthTest.set(!0),this.depthFunc.set(C.func),this.depthMask.set(C.mask),this.depthRange.set(C.range)):this.depthTest.set(!1)}setStencilMode(C){C.test.func!==this.gl.ALWAYS||C.mask?(this.stencilTest.set(!0),this.stencilMask.set(C.mask),this.stencilOp.set([C.fail,C.depthFail,C.pass]),this.stencilFunc.set({func:C.test.func,ref:C.ref,mask:C.test.mask})):this.stencilTest.set(!1)}setColorMode(C){x(C.blendFunction,Cx.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(C.blendFunction),this.blendColor.set(C.blendColor),C.blendEquation?this.blendEquation.set(C.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(C.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}class Lx extends zt{constructor(C,te,le){super(),this.id=C,this._onlySymbols=le,te.on("data",(C=>{"source"===C.dataType&&"metadata"===C.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===C.dataType&&"content"===C.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform))})),te.on("error",(()=>{this._sourceErrored=!0})),this._source=te,this._tiles={},this._cache=new By(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=te.minTileCacheSize,this._maxTileCacheSize=te.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Fm,this._isRaster="raster"===this._source.type||"raster-dem"===this._source.type||"custom"===this._source.type&&"raster"===this._source._dataType}onAdd(C){this.map=C,this._minTileCacheSize=void 0===this._minTileCacheSize&&C?C._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=void 0===this._maxTileCacheSize&&C?C._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded)return!1;if(!this._source.loaded())return!1;for(const C in this._tiles){const te=this._tiles[C];if("errored"!==te.state&&("loaded"!==te.state||!te.bucketsLoaded()))return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const C=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,C&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(C,te){return C.isSymbolTile=this._onlySymbols,C.isExtraShadowCaster=this._shadowCasterTiles[C.tileID.key],this._source.loadTile(C,te)}_unloadTile(C){if(this._source.unloadTile)return this._source.unloadTile(C,(()=>{}))}_abortTile(C){if(this._source.abortTile)return this._source.abortTile(C,(()=>{}))}serialize(){return this._source.serialize()}prepare(C){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const te in this._tiles){const le=this._tiles[te];le.upload(C),le.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return L(this._tiles).map((C=>C.tileID)).sort(kx).map((C=>C.key))}getRenderableIds(C,te){const le=[];for(const ce in this._tiles)this._isIdRenderable(+ce,C,te)&&le.push(this._tiles[ce]);return C?le.sort(((C,te)=>{const le=C.tileID,ce=te.tileID,he=new je(le.canonical.x,le.canonical.y)._rotate(this.transform.angle),ue=new je(ce.canonical.x,ce.canonical.y)._rotate(this.transform.angle);return le.overscaledZ-ce.overscaledZ||ue.y-he.y||ue.x-he.x})).map((C=>C.tileID.key)):le.map((C=>C.tileID)).sort(kx).map((C=>C.key))}hasRenderableParent(C){const te=this.findLoadedParent(C,0);return!!te&&this._isIdRenderable(te.tileID.key)}_isIdRenderable(C,te,le){return this._tiles[C]&&this._tiles[C].hasData()&&!this._coveredTiles[C]&&(te||!this._tiles[C].holdingForFade())&&(le||!this._shadowCasterTiles[C])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const C in this._tiles)"errored"!==this._tiles[C].state&&this._reloadTile(+C,"reloading")}}_reloadTile(C,te){const le=this._tiles[C];le&&("loading"!==le.state&&(le.state=te),this._loadTile(le,this._tileLoaded.bind(this,le,C,te)))}_tileLoaded(C,te,le,ce){if(ce)if(C.state="errored",404!==ce.status)this._source.fire(new Ct(ce,{tile:C}));else{if(!(C.tileID.key in this._loadedParentTiles))return void this._source.fire(new It("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id}));if("raster-dem"===this._source.type&&this.usedForTerrain&&this.map.painter.terrain){const C=this.map.painter.terrain;this.update(this.transform,C.getScaledDemTileSize(),!0),C.resetTileLookupCache(this.id)}else this.update(this.transform)}else C.timeAdded=bi.now(),"expired"===le&&(C.refreshedUponExpiration=!0),this._setTileReloadTimer(te,C),"raster-dem"===this._source.type&&C.dem&&this._backfillDEM(C),this._state.initializeTileState(C,this.map?this.map.painter:null),this._source.fire(new It("data",{dataType:"source",tile:C,coord:C.tileID,sourceCacheId:this.id}))}_backfillDEM(C){const te=this.getRenderableIds();for(let le=0;le<te.length;le++){const ce=te[le];if(C.neighboringTiles&&C.neighboringTiles[ce]){const te=this.getTileByID(ce);i(C,te),i(te,C)}}function i(C,te){if(!C.dem||C.dem.borderReady)return;C.needsHillshadePrepare=!0,C.needsDEMTextureUpload=!0;let le=te.tileID.canonical.x-C.tileID.canonical.x;const ce=te.tileID.canonical.y-C.tileID.canonical.y,he=Math.pow(2,C.tileID.canonical.z),ue=te.tileID.key;0===le&&0===ce||Math.abs(ce)>1||(Math.abs(le)>1&&(1===Math.abs(le+he)?le+=he:1===Math.abs(le-he)&&(le-=he)),te.dem&&C.dem&&(C.dem.backfillBorder(te.dem,le,ce),C.neighboringTiles&&C.neighboringTiles[ue]&&(C.neighboringTiles[ue].backfilled=!0)))}}getTile(C){return this.getTileByID(C.key)}getTileByID(C){return this._tiles[C]}_retainLoadedChildren(C,te,le,ce){for(const he in this._tiles){let ue=this._tiles[he];if(ce[he]||!ue.hasData()||ue.tileID.overscaledZ<=te||ue.tileID.overscaledZ>le)continue;let de=ue.tileID;for(;ue&&ue.tileID.overscaledZ>te+1;){const C=ue.tileID.scaledTo(ue.tileID.overscaledZ-1);ue=this._tiles[C.key],ue&&ue.hasData()&&(de=C)}let _e=de;for(;_e.overscaledZ>te;)if(_e=_e.scaledTo(_e.overscaledZ-1),C[_e.key]){ce[de.key]=de;break}}}findLoadedParent(C,te){if(C.key in this._loadedParentTiles){const le=this._loadedParentTiles[C.key];return le&&le.tileID.overscaledZ>=te?le:null}for(let le=C.overscaledZ-1;le>=te;le--){const te=C.scaledTo(le),ce=this._getLoadedTile(te);if(ce)return ce}}_getLoadedTile(C){const te=this._tiles[C.key];return te&&te.hasData()?te:this._cache.getByKey(this._source.reparseOverscaled?C.wrapped().key:C.canonical.key)}updateCacheSize(C,te){te=te||this._source.tileSize;const le=Math.ceil(C.width/te)+1,ce=Math.ceil(C.height/te)+1,he=Math.floor(le*ce*5),ue="number"==typeof this._minTileCacheSize?Math.max(this._minTileCacheSize,he):he,de="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,ue):ue;this._cache.setMaxSize(de)}handleWrapJump(C){const te=Math.round((C-(void 0===this._prevLng?C:this._prevLng))/360);if(this._prevLng=C,te){const C={};for(const le in this._tiles){const ce=this._tiles[le];ce.tileID=ce.tileID.unwrapTo(ce.tileID.wrap+te),C[ce.tileID.key]=ce}this._tiles=C;for(const C in this._timers)clearTimeout(this._timers[C]),delete this._timers[C];for(const C in this._tiles)this._setTileReloadTimer(+C,this._tiles[C])}}update(C,te,le,ce){if(this.transform=C,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage)return;if(this.usedForTerrain&&!le)return;let he;if(this.updateCacheSize(C,te),"globe"!==this.transform.projection.name&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?he=C.getVisibleUnwrappedCoordinates(this._source.tileID).map((C=>new qu(C.canonical.z,C.wrap,C.canonical.z,C.canonical.x,C.canonical.y))):(he=C.coveringTiles({tileSize:te||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!le,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile&&(he=he.filter((C=>this._source.hasTile(C))))):he=[],he.length>0&&this.castsShadows&&ce&&"globe"!==this.transform.projection.name&&!this.usedForTerrain&&!Ox(this._source.type)){const ue=C.coveringZoomLevel({tileSize:te||this._source.tileSize,roundZoom:this._source.roundZoom&&!le}),de=Math.min(ue,this._source.maxzoom),_e=C.extendTileCoverForShadows(he,ce,de);for(const C of _e)this._shadowCasterTiles[C.key]=!0,he.push(C)}const ue=this._updateRetainedTiles(he);if(Ox(this._source.type)&&0!==he.length){const C={},te={},le=Object.keys(ue);for(const ce of le){const le=ue[ce],he=this._tiles[ce];if(!he||he.fadeEndTime&&he.fadeEndTime<=bi.now())continue;const de=this.findLoadedParent(le,Math.max(le.overscaledZ-Lx.maxOverzooming,this._source.minzoom));de&&(this._addTile(de.tileID),C[de.tileID.key]=de.tileID),te[ce]=le}const ce=he[he.length-1].overscaledZ;for(const C in this._tiles){const le=this._tiles[C];if(ue[C]||!le.hasData())continue;let he=le.tileID;for(;he.overscaledZ>ce;){he=he.scaledTo(he.overscaledZ-1);const ce=this._tiles[he.key];if(ce&&ce.hasData()&&te[he.key]){ue[C]=le.tileID;break}}}for(const te in C)ue[te]||(this._coveredTiles[te]=!0,ue[te]=C[te])}for(const C in ue)this._tiles[C].clearFadeHold();const de=function(C,te){const le=[];for(const ce in C)ce in te||le.push(ce);return le}(this._tiles,ue);for(const C of de){const te=this._tiles[C];te.hasSymbolBuckets&&!te.holdingForFade()?te.setHoldDuration(this.map._fadeDuration):te.hasSymbolBuckets&&!te.symbolFadeFinished()||this._removeTile(+C)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const C in this._tiles)this._tiles[C].holdingForFade()&&this._removeTile(+C)}_updateRetainedTiles(C){const te={};if(0===C.length)return te;const le={},ce=C.reduce(((C,te)=>Math.min(C,te.overscaledZ)),1/0),he=C[0].overscaledZ,ue=Math.max(he-Lx.maxOverzooming,this._source.minzoom),de=Math.max(he+Lx.maxUnderzooming,this._source.minzoom),_e={};for(const le of C){const C=this._addTile(le);te[le.key]=le,C.hasData()||ce<this._source.maxzoom&&(_e[le.key]=le)}this._retainLoadedChildren(_e,ce,de,te);for(const ce of C){let C=this._tiles[ce.key];if(C.hasData())continue;if(ce.canonical.z>=this._source.maxzoom){const C=ce.children(this._source.maxzoom)[0],le=this.getTile(C);if(le&&le.hasData()){te[C.key]=C;continue}}else{const C=ce.children(this._source.maxzoom);if(te[C[0].key]&&te[C[1].key]&&te[C[2].key]&&te[C[3].key])continue}let he=C.wasRequested();for(let de=ce.overscaledZ-1;de>=ue;--de){const ue=ce.scaledTo(de);if(le[ue.key])break;if(le[ue.key]=!0,C=this.getTile(ue),!C&&he&&(C=this._addTile(ue)),C&&(te[ue.key]=ue,he=C.wasRequested(),C.hasData()))break}}return te}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const C in this._tiles){const te=[];let le,ce=this._tiles[C].tileID;for(;ce.overscaledZ>0;){if(ce.key in this._loadedParentTiles){le=this._loadedParentTiles[ce.key];break}te.push(ce.key);const C=ce.scaledTo(ce.overscaledZ-1);if(le=this._getLoadedTile(C),le)break;ce=C}for(const C of te)this._loadedParentTiles[C]=le}}_addTile(C){let te=this._tiles[C.key];if(te)return!0!==te.isExtraShadowCaster||!!this._shadowCasterTiles[C.key]||this._reloadTile(C.key,"reloading"),te;te=this._cache.getAndRemove(C),te&&(this._setTileReloadTimer(C.key,te),te.tileID=C,this._state.initializeTileState(te,this.map?this.map.painter:null),this._cacheTimers[C.key]&&(clearTimeout(this._cacheTimers[C.key]),delete this._cacheTimers[C.key],this._setTileReloadTimer(C.key,te)));const le=Boolean(te);if(!le){const le=this.map?this.map.painter:null;te=new Oy(C,this._source.tileSize*C.overscaleFactor(),this.transform.tileZoom,le,this._isRaster),this._loadTile(te,this._tileLoaded.bind(this,te,C.key,te.state))}return te?(te.uses++,this._tiles[C.key]=te,le||this._source.fire(new It("dataloading",{tile:te,coord:te.tileID,dataType:"source"})),te):null}_setTileReloadTimer(C,te){C in this._timers&&(clearTimeout(this._timers[C]),delete this._timers[C]);const le=te.getExpiryTimeout();le&&(this._timers[C]=setTimeout((()=>{this._reloadTile(C,"expired"),delete this._timers[C]}),le))}_removeTile(C){const te=this._tiles[C];te&&(te.uses--,delete this._tiles[C],this._timers[C]&&(clearTimeout(this._timers[C]),delete this._timers[C]),te.uses>0||(te.hasData()&&"reloading"!==te.state?this._cache.add(te.tileID,te,te.getExpiryTimeout()):(te.aborted=!0,this._abortTile(te),this._unloadTile(te))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const C in this._tiles)this._removeTile(+C);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(C,te,le){const ce=[],he=this.transform;if(!he)return ce;const ue="globe"===he.projection.name,de=Kd(he.center.lng);for(const _e in this._tiles){const ye=this._tiles[_e];if(le&&ye.clearQueryDebugViz(),ye.holdingForFade())continue;let ve;if(ue){const C=ye.tileID.canonical;if(0===C.z){const te=[Math.abs(z(de,...Bx(C,-1))-de),Math.abs(z(de,...Bx(C,1))-de)];ve=[0,2*te.indexOf(Math.min(...te))-1]}else{const te=[Math.abs(z(de,...Bx(C,-1))-de),Math.abs(z(de,...Bx(C,0))-de),Math.abs(z(de,...Bx(C,1))-de)];ve=[te.indexOf(Math.min(...te))-1]}}else ve=[0];for(const le of ve){const ue=C.containsTile(ye,he,te,le);ue&&ce.push(ue)}}return ce}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(C){return this._getRenderableCoordinates(C)}_getRenderableCoordinates(C,te){const le=this.getRenderableIds(C,te).map((C=>this._tiles[C].tileID)),ce="globe"===this.transform.projection.name;for(const C of le)C.projMatrix=this.transform.calculateProjMatrix(C.toUnwrapped()),C.expandedProjMatrix=ce?this.transform.calculateProjMatrix(C.toUnwrapped(),!1,!0):C.projMatrix;return le}sortCoordinatesByDistance(C){const te=C.slice(),le=this.transform._camera.position,ce=this.transform._camera.forward(),he={};for(const C of te){const te=1/(1<<C.canonical.z);he[C.key]=((C.canonical.x+.5)*te+C.wrap-le[0])*ce[0]+((C.canonical.y+.5)*te-le[1])*ce[1]-le[2]*ce[2]}return te.sort(((C,te)=>he[C.key]-he[te.key])),te}hasTransition(){if(this._source.hasTransition())return!0;if(Ox(this._source.type))for(const C in this._tiles){const te=this._tiles[C];if(void 0!==te.fadeEndTime&&te.fadeEndTime>=bi.now())return!0}return!1}setFeatureState(C,te,le){this._state.updateState(C=C||"_geojsonTileLayer",te,le)}removeFeatureState(C,te,le){this._state.removeFeatureState(C=C||"_geojsonTileLayer",te,le)}getFeatureState(C,te){return this._state.getState(C=C||"_geojsonTileLayer",te)}setDependencies(C,te,le){const ce=this._tiles[C];ce&&ce.setDependencies(te,le)}reloadTilesForDependencies(C,te){for(const le in this._tiles)this._tiles[le].hasDependency(C,te)&&this._reloadTile(+le,"reloading");this._cache.filter((le=>!le.hasDependency(C,te)))}_preloadTiles(C,te){if(!this._sourceLoaded){const i=()=>{this._sourceLoaded&&(this._source.off("data",i),this._preloadTiles(C,te))};return void this._source.on("data",i)}const le=new Map,ce=Array.isArray(C)?C:[C],he=this.map.painter.terrain,ue=this.usedForTerrain&&he?he.getScaledDemTileSize():this._source.tileSize;for(const C of ce){const te=C.coveringTiles({tileSize:ue,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const C of te)le.set(C.key,C);this.usedForTerrain&&C.updateElevation(!1)}R(Array.from(le.values()),((C,te)=>{const le=new Oy(C,this._source.tileSize*C.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(le,(C=>{"raster-dem"===this._source.type&&le.dem&&this._backfillDEM(le),te(C,le)}))}),te)}}function kx(C,te){const le=Math.abs(2*C.wrap)-+(C.wrap<0),ce=Math.abs(2*te.wrap)-+(te.wrap<0);return C.overscaledZ-te.overscaledZ||ce-le||te.canonical.y-C.canonical.y||te.canonical.x-C.canonical.x}function Ox(C){return"raster"===C||"image"===C||"video"===C||"custom"===C}function Bx(C,te){const le=1<<C.z;return[C.x/le+te,(C.x+1)/le+te]}Lx.maxOverzooming=10,Lx.maxUnderzooming=3;const lb=Ia([{name:"a_pos_3f",components:3,type:"Float32"}]),cb=Ia([{name:"a_color_3f",components:3,type:"Float32"}]),gb=Ia([{name:"a_color_4f",components:4,type:"Float32"}]),Db=Ia([{name:"a_uv_2f",components:2,type:"Float32"}]),Pb=Ia([{name:"a_normal_3f",components:3,type:"Float32"}]),Bb=Ia([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),Fb=Ia([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);class Zx{constructor(C=0,te=0,le=0,ce=0){if(isNaN(C)||C<0||isNaN(te)||te<0||isNaN(le)||le<0||isNaN(ce)||ce<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=C,this.bottom=te,this.left=le,this.right=ce}interpolate(C,te,le){return null!=te.top&&null!=C.top&&(this.top=Kr(C.top,te.top,le)),null!=te.bottom&&null!=C.bottom&&(this.bottom=Kr(C.bottom,te.bottom,le)),null!=te.left&&null!=C.left&&(this.left=Kr(C.left,te.left,le)),null!=te.right&&null!=C.right&&(this.right=Kr(C.right,te.right,le)),this}getCenter(C,te){const le=z((this.left+C-this.right)/2,0,C),ce=z((this.top+te-this.bottom)/2,0,te);return new je(le,ce)}equals(C){return this.top===C.top&&this.bottom===C.bottom&&this.left===C.left&&this.right===C.right}clone(){return new Zx(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function $x(C,te){const le=ne(C,3);ld.fromQuat(C,te),oe(C,3,le)}function Wx(C,te){const le=Md.identity([]);return Md.rotateZ(le,le,-te),Md.rotateX(le,le,-C),le}function Hx(C,te){const le=[C[0],C[1],0],ce=[te[0],te[1],0];if(Zd.length(le)>=1e-15){const C=Zd.normalize([],le);Zd.scale(ce,C,Zd.dot(ce,C)),te[0]=ce[0],te[1]=ce[1]}const he=Zd.cross([],te,C);if(Zd.len(he)<1e-15)return null;const ue=Math.atan2(-he[1],he[0]);return Wx(Math.atan2(Math.sqrt(C[0]*C[0]+C[1]*C[1]),-C[2]),ue)}class Xx{constructor(C,te){this.position=C,this.orientation=te}get position(){return this._position}set position(C){if(C){const te=C instanceof lp?C:new lp(C[0],C[1],C[2]);this._renderWorldCopies&&(te.x=D(te.x,0,1)),this._position=te}else this._position=null}lookAtPoint(C,te){if(this.orientation=null,!this.position)return;const le=this.position,ce=this._elevation?this._elevation.getAtPointOrZero(lp.fromLngLat(C)):0,he=lp.fromLngLat(C,ce),ue=[he.x-le.x,he.y-le.y,he.z-le.z];te||(te=[0,0,1]),te[2]=Math.abs(te[2]),this.orientation=Hx(ue,te)}setPitchBearing(C,te){this.orientation=Wx(w(C),w(-te))}}class Yx{constructor(C,te){this._transform=ld.identity([]),this.orientation=te,this.position=C}get mercatorPosition(){const C=this.position;return new lp(C[0],C[1],C[2])}get position(){const C=ne(this._transform,3);return[C[0],C[1],C[2]]}set position(C){var te;C&&oe(this._transform,3,[(te=C)[0],te[1],te[2],1])}get orientation(){return this._orientation}set orientation(C){this._orientation=C||Md.identity([]),C&&$x(this._transform,this._orientation)}getPitchBearing(){const C=this.forward(),te=this.right();return{bearing:Math.atan2(-te[1],te[0]),pitch:Math.atan2(Math.sqrt(C[0]*C[0]+C[1]*C[1]),-C[2])}}setPitchBearing(C,te){this._orientation=Wx(C,te),$x(this._transform,this._orientation)}forward(){const C=ne(this._transform,2);return[-C[0],-C[1],-C[2]]}up(){const C=ne(this._transform,1);return[-C[0],-C[1],-C[2]]}right(){const C=ne(this._transform,0);return[C[0],C[1],C[2]]}getCameraToWorld(C,te){const le=new Float64Array(16);return ld.invert(le,this.getWorldToCamera(C,te)),le}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(C,te,le){const ce=this.position;Zd.scale(ce,ce,-C);const he=new Float64Array(16);return ld.fromScaling(he,[le,le,le]),ld.translate(he,he,ce),he[10]*=te,he}getWorldToCamera(C,te){const le=new Float64Array(16),ce=new Float64Array(4),he=this.position;return Md.conjugate(ce,this._orientation),Zd.scale(he,he,-C),ld.fromQuat(le,ce),ld.translate(le,le,he),le[1]*=-1,le[5]*=-1,le[9]*=-1,le[13]*=-1,le[8]*=te,le[9]*=te,le[10]*=te,le[11]*=te,le}getCameraToClipPerspective(C,te,le,ce){const he=new Float64Array(16);return ld.perspective(he,C,te,le,ce),he}getCameraToClipOrthographic(C,te,le,ce,he,ue){const de=new Float64Array(16);return ld.ortho(de,C,te,le,ce,he,ue),de}getDistanceToElevation(C,te=!1){const le=0===C?0:Qd(C,te?tp(this.position[1]):this.position[1]),ce=this.forward();return(le-this.position[2])/ce[2]}clone(){return new Yx([...this.position],[...this.orientation])}}function Kx(C,te){const le=Qx(C.projection,C.zoom,C.width,C.height),ce=function(C,te,le,ce,he){const ue=new $f(le.lng-180*Zb,le.lat),de=new $f(le.lng+180*Zb,le.lat),_e=C.project(ue.lng,ue.lat),ye=C.project(de.lng,de.lat),ve=-Math.atan2(ye.y-_e.y,ye.x-_e.x),Se=lp.fromLngLat(le);Se.y=z(Se.y,-1+Zb,1-Zb);const Me=Se.toLngLat(),Ae=C.project(Me.lng,Me.lat),Ce=lp.fromLngLat(Me);Ce.x+=Zb;const Oe=Ce.toLngLat(),Ne=C.project(Oe.lng,Oe.lat),je=iv(Ne.x-Ae.x,Ne.y-Ae.y,ve),Ge=lp.fromLngLat(Me);Ge.y+=Zb;const Ze=Ge.toLngLat(),qe=C.project(Ze.lng,Ze.lat),$e=iv(qe.x-Ae.x,qe.y-Ae.y,ve),He=Math.abs(je.x)/Math.abs($e.y),We=ld.identity([]);ld.rotateZ(We,We,-ve*(1-(he?0:ce)));const Xe=ld.identity([]);return ld.scale(Xe,Xe,[1,1-(1-He)*ce,1]),Xe[4]=-$e.x/$e.y*ce,ld.rotateZ(Xe,Xe,ve),ld.multiply(Xe,We,Xe),Xe}(C.projection,0,C.center,le,te),he=Jx(C);return ld.scale(ce,ce,[he,he,1]),ce}function Jx(C){const te=C.projection,le=Qx(C.projection,C.zoom,C.width,C.height),ce=tv(te,C.center),he=tv(te,$f.convert(te.center));return Math.pow(2,ce*le+(1-le)*he)}function Qx(C,te,le,ce,he=1/0){const ue=C.range;if(!ue)return 0;const de=Math.min(he,Math.max(le,ce)),_e=Math.log(de/1024)/Math.LN2;return P(ue[0]+_e,ue[1]+_e,te)}const Zb=1/4e4;function tv(C,te){const le=z(te.lat,-Xf,Xf),ce=new $f(te.lng-180*Zb,le),he=new $f(te.lng+180*Zb,le),ue=C.project(ce.lng,le),de=C.project(he.lng,le),_e=lp.fromLngLat(ce),ye=lp.fromLngLat(he),ve=de.x-ue.x,Se=de.y-ue.y,Me=ye.x-_e.x,Ae=ye.y-_e.y,Ce=Math.sqrt((Me*Me+Ae*Ae)/(ve*ve+Se*Se));return Math.log(Ce)/Math.LN2}function iv(C,te,le){const ce=Math.cos(le),he=Math.sin(le);return{x:C*ce-te*he,y:C*he+te*ce}}function rv(C,te,le){return te*(Mn/(C.tileSize*Math.pow(2,le-C.tileID.overscaledZ)))}const Hb={unknown:0,flipRequired:1,flipNotRequired:2},Wb=Math.tan(85*Math.PI/180);function sv(C,te,le,ce,he,ue,de){const _e=ld.create();if(le)if("globe"===ue.name){const C=function(C,te){const{x:le,y:ce}=C.point,he=zd(le,ce,C.worldSize/C._pixelsPerMercatorPixel,0,0);return ld.multiply(he,he,Sd(fd(te)))}(he,te);ld.multiply(_e,_e,C)}else{const C=rd.invert([],de);_e[0]=C[0],_e[1]=C[1],_e[4]=C[2],_e[5]=C[3],ce||ld.rotateZ(_e,_e,he.angle)}else ld.multiply(_e,he.labelPlaneMatrix,C);return _e}function av(C,te,le,ce,he,ue,de){const _e=sv(C,te,le,ce,he,ue,de);return"globe"===ue.name&&le||(_e[2]=_e[6]=_e[10]=_e[14]=0),_e}function lv(C,te,le,ce,he,ue,de){if(le){if("globe"===ue.name){const _e=sv(C,te,le,ce,he,ue,de);return ld.invert(_e,_e),ld.multiply(_e,C,_e),_e}{const te=ld.clone(C),le=ld.identity([]);return le[0]=de[0],le[1]=de[1],le[4]=de[2],le[5]=de[3],ld.multiply(te,te,le),ce||ld.rotateZ(te,te,-he.angle),te}}return he.glCoordMatrix}function cv(C,te,le,ce){const he=[C,te,le,1];le?$u.transformMat4(he,he,ce):vv(he,he,ce);const ue=he[3];return he[0]/=ue,he[1]/=ue,he[2]/=ue,he}function hv(C,te){return Math.min(.5+C/te*.5,1.5)}function uv(C,te){const le=C[0]/C[3],ce=C[1]/C[3];return le>=-te[0]&&le<=te[0]&&ce>=-te[1]&&ce<=te[1]}function dv(C,te,le,ce,he,ue,de,_e,ye,ve){const Se=le.transform,Me=ce?C.textSizeData:C.iconSizeData,Ae=m_(Me,le.transform.zoom),Ce="globe"===Se.projection.name,Oe=[256/le.width*2+1,256/le.height*2+1],Ne=ce?C.text.dynamicLayoutVertexArray:C.icon.dynamicLayoutVertexArray;Ne.clear();let Ge=null;Ce&&(Ge=ce?C.text.globeExtVertexArray:C.icon.globeExtVertexArray);const Ze=C.lineVertexArray,qe=ce?C.text.placedSymbolArray:C.icon.placedSymbolArray,$e=le.transform.width/le.transform.height;let He,We=!1;for(let ce=0;ce<qe.length;ce++){const Ce=qe.get(ce),{numGlyphs:Xe,writingMode:Ye}=Ce;if(Ye!==iy.vertical||We||He===iy.horizontal||(We=!0),He=Ye,(Ce.hidden||Ye===iy.vertical)&&!We){xv(Xe,Ne);continue}We=!1;const Je=new je(Ce.tileAnchorX,Ce.tileAnchorY);let{x:Qe,y:tt,z:rt}=Se.projection.projectTilePoint(Je.x,Je.y,ve.canonical);if(ye){const[C,te,le]=ye(Je);Qe+=C,tt+=te,rt+=le}const ot=[Qe,tt,rt,1];if($u.transformMat4(ot,ot,te),!uv(ot,Oe)){xv(Xe,Ne);continue}const st=ot[3],at=hv(le.transform.getCameraToCenterDistance(Se.projection),st),lt=f_(Me,Ae,Ce),ct=de?lt/at:lt*at,ht=cv(Qe,tt,rt,he);if(ht[3]<=0){xv(Xe,Ne);continue}let dt={};const mt=de?null:ye,_t=mv(Ce,ct,!1,_e,te,he,ue,C.glyphOffsetArray,Ze,Ne,Ge,ht,Je,dt,$e,mt,Se.projection,ve,de);We=_t.useVertical,mt&&_t.needsFlipping&&(dt={}),(_t.notEnoughRoom||We||_t.needsFlipping&&mv(Ce,ct,!0,_e,te,he,ue,C.glyphOffsetArray,Ze,Ne,Ge,ht,Je,dt,$e,mt,Se.projection,ve,de).notEnoughRoom)&&xv(Xe,Ne)}ce?(C.text.dynamicLayoutVertexBuffer.updateData(Ne),Ge&&C.text.globeExtVertexBuffer&&C.text.globeExtVertexBuffer.updateData(Ge)):(C.icon.dynamicLayoutVertexBuffer.updateData(Ne),Ge&&C.icon.globeExtVertexBuffer&&C.icon.globeExtVertexBuffer.updateData(Ge))}function pv(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne){const{lineStartIndex:je,glyphStartIndex:Ge,segment:Ze}=_e,qe=Ge+_e.numGlyphs,$e=je+_e.lineLength,He=te.getoffsetX(Ge),We=te.getoffsetX(qe-1),Xe=yv(C*He,le,ce,he,ue,de,Ze,je,$e,ye,ve,Se,Me,Ae,!0,Ce,Oe,Ne);if(!Xe)return null;const Ye=yv(C*We,le,ce,he,ue,de,Ze,je,$e,ye,ve,Se,Me,Ae,!0,Ce,Oe,Ne);return Ye?{first:Xe,last:Ye}:null}function fv(C,te,le,ce){return C===iy.horizontal&&Math.abs(ce)>Math.abs(le)?{useVertical:!0}:C===iy.vertical?ce>0?{needsFlipping:!0}:null:te!==Hb.unknown&&function(C,te){return 0===C||Math.abs(te/C)>Wb}(le,ce)?te===Hb.flipRequired?{needsFlipping:!0}:null:le<0?{needsFlipping:!0}:null}function mv(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne,Ge,Ze,qe){const $e=te/24,He=C.lineOffsetX*$e,We=C.lineOffsetY*$e,{lineStartIndex:Xe,glyphStartIndex:Ye,numGlyphs:Je,segment:Qe,writingMode:tt,flipState:rt}=C,ot=Xe+C.lineLength,z=C=>{if(Se){const[te,le,ce]=C.up,he=ve.length;uy(Se,he+0,te,le,ce),uy(Se,he+1,te,le,ce),uy(Se,he+2,te,le,ce),uy(Se,he+3,te,le,ce)}const[te,le,ce]=C.point;dy(ve,te,le,ce,C.angle)};if(Je>1){const te=pv($e,_e,He,We,le,Me,Ae,C,ye,ue,Ce,Ne,!1,Ge,Ze,qe);if(!te)return{notEnoughRoom:!0};if(ce&&!le){let[le,ce,he]=te.first.point,[ue,_e,ye]=te.last.point;[le,ce]=cv(le,ce,he,de),[ue,_e]=cv(ue,_e,ye,de);const ve=fv(tt,rt,(ue-le)*Oe,_e-ce);if(C.flipState=ve&&ve.needsFlipping?Hb.flipRequired:Hb.flipNotRequired,ve)return ve}z(te.first);for(let C=Ye+1;C<Ye+Je-1;C++){const te=yv($e*_e.getoffsetX(C),He,We,le,Me,Ae,Qe,Xe,ot,ye,ue,Ce,Ne,!1,!1,Ge,Ze,qe);if(!te)return ve.length-=4*(C-Ye),{notEnoughRoom:!0};z(te)}z(te.last)}else{if(ce&&!le){const te=cv(Ae.x,Ae.y,0,he),le=Xe+Qe+1,ce=new je(ye.getx(le),ye.gety(le)),ue=cv(ce.x,ce.y,0,he),de=ue[3]>0?ue:gv(Ae,ce,te,1,he,void 0,Ge,Ze.canonical),_e=fv(tt,rt,(de[0]-te[0])*Oe,de[1]-te[1]);if(C.flipState=_e&&_e.needsFlipping?Hb.flipRequired:Hb.flipNotRequired,_e)return _e}const te=yv($e*_e.getoffsetX(Ye),He,We,le,Me,Ae,Qe,Xe,ot,ye,ue,Ce,Ne,!1,!1,Ge,Ze,qe);if(!te)return{notEnoughRoom:!0};z(te)}return{}}function _v(C,te,le,ce,he){const{x:ue,y:de,z:_e}=ce.projectTilePoint(C.x,C.y,te);if(!he)return cv(ue,de,_e,le);const[ye,ve,Se]=he(C);return cv(ue+ye,de+ve,_e+Se,le)}function gv(C,te,le,ce,he,ue,de,_e){const ye=_v(C.sub(te)._unit()._add(C),_e,he,de,ue);return Zd.sub(ye,le,ye),Zd.normalize(ye,ye),Zd.scaleAndAdd(ye,le,ye,ce)}function yv(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne,Ge,Ze){const qe=ce?C-te:C+te;let $e=qe>0?1:-1,He=0;ce&&($e*=-1,He=Math.PI),$e<0&&(He+=Math.PI);let We=_e+de+($e>0?0:1)|0,Xe=he,Ye=he,Je=0,Qe=0;const tt=Math.abs(qe),rt=[],ot=[];let st=ue,at=st;const D=()=>gv(at,st,Ye,tt-Je+1,Se,Ae,Ne,Ge.canonical);for(;Je+Qe<=tt;){if(We+=$e,We<_e||We>=ye)return null;if(Ye=Xe,at=st,rt.push(Ye),Ce&&ot.push(at),st=new je(ve.getx(We),ve.gety(We)),Xe=Me[We],!Xe){const C=_v(st,Ge.canonical,Se,Ne,Ae);Xe=C[3]>0?Me[We]=C:D()}Je+=Qe,Qe=Zd.distance(Ye,Xe)}Oe&&Ae&&(Me[We]&&(Xe=D(),Qe=Zd.distance(Ye,Xe)),Me[We]=Xe);const lt=(tt-Je)/Qe,ct=st.sub(at)._mult(lt)._add(at),ht=Zd.sub([],Xe,Ye),dt=Zd.scaleAndAdd([],Ye,ht,lt);let mt=[0,0,1],_t=ht[0],gt=ht[1];if(Ze&&(mt=Ne.upVector(Ge.canonical,ct.x,ct.y),0!==mt[0]||0!==mt[1]||1!==mt[2])){const C=[mt[2],0,-mt[0]],te=Zd.cross([],mt,C);Zd.normalize(C,C),Zd.normalize(te,te),_t=Zd.dot(ht,C),gt=Zd.dot(ht,te)}if(le){const C=Zd.cross([],mt,ht);Zd.normalize(C,C),Zd.scaleAndAdd(dt,dt,C,le*$e)}const Pt=He+Math.atan2(gt,_t);return rt.push(dt),Ce&&ot.push(ct),{point:dt,angle:Pt,path:rt,tilePath:ot,up:mt}}function xv(C,te){const le=te.length,ce=le+4*C;te.resize(ce),te.float32.fill(-1/0,4*le,4*ce)}function vv(C,te,le){const ce=te[0],he=te[1];return C[0]=le[0]*ce+le[4]*he+le[12],C[1]=le[1]*ce+le[5]*he+le[13],C[3]=le[3]*ce+le[7]*he+le[15],C}const bv=(C,te,le)=>(1-le)*C+le*te,wv=C=>C*C*C*C*C;class Tv{constructor(C,te,le,ce,he,ue,de){this.tileSize=512,this._renderWorldCopies=void 0===he||he,this._minZoom=C||0,this._maxZoom=te||22,this._minPitch=null==le?0:le,this._maxPitch=null==ce?60:ce,this.setProjection(ue),this.setMaxBounds(de),this.width=0,this.height=0,this._center=new $f(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Zx,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new Yx,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1}clone(){const C=new Tv(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return C._elevation=this._elevation,C._centerAltitude=this._centerAltitude,C._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,C.tileSize=this.tileSize,C.mercatorFromTransition=this.mercatorFromTransition,C.width=this.width,C.height=this.height,C.cameraElevationReference=this.cameraElevationReference,C._center=this._center,C._setZoom(this.zoom),C._seaLevelZoom=this._seaLevelZoom,C.angle=this.angle,C._fov=this._fov,C._pitch=this._pitch,C._nearZ=this._nearZ,C._farZ=this._farZ,C._averageElevation=this._averageElevation,C._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,C._unmodified=this._unmodified,C._edgeInsets=this._edgeInsets.clone(),C._camera=this._camera.clone(),C._calcMatrices(),C.freezeTileCoverage=this.freezeTileCoverage,C.frustumCorners=this.frustumCorners,C}get isOrthographic(){return"globe"!==this.projection.name&&this._orthographicProjectionAtLowPitch&&this.pitch<15}get elevation(){return this._elevation}set elevation(C){this._elevation!==C&&(this._elevation=C,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return"globe"!==this.projection.name&&!this.isOrthographic}updateElevation(C,te=!1){const le=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(null==this._seaLevelZoom||le)&&this._updateCameraOnTerrain(),(C||le)&&this._constrainCamera(te),this._calcMatrices()}getProjection(){return O(this.projection,["name","center","parallels"])}setProjection(C){this.projectionOptions=C||{name:"mercator"};const te=this.projection?this.getProjection():void 0;this.projection=ty(this.projectionOptions);const le=!x(te,this.getProjection());return le&&this._calcMatrices(),this.mercatorFromTransition=!1,le}setOrthographicProjectionAtLowPitch(C){return this._orthographicProjectionAtLowPitch!==C&&(this._orthographicProjectionAtLowPitch=C,this._calcMatrices(),!0)}setMercatorFromTransition(){const C=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=ty({name:"mercator"});const te=C!==this.projection.name;return te&&this._calcMatrices(),te}get minZoom(){return this._minZoom}set minZoom(C){this._minZoom!==C&&(this._minZoom=C,this.zoom=Math.max(this.zoom,C))}get maxZoom(){return this._maxZoom}set maxZoom(C){this._maxZoom!==C&&(this._maxZoom=C,this.zoom=Math.min(this.zoom,C))}get minPitch(){return this._minPitch}set minPitch(C){this._minPitch!==C&&(this._minPitch=C,this.pitch=Math.max(this.pitch,C))}get maxPitch(){return this._maxPitch}set maxPitch(C){this._maxPitch!==C&&(this._maxPitch=C,this.pitch=Math.min(this.pitch,C))}get renderWorldCopies(){return this._renderWorldCopies&&!0===this.projection.supportsWorldCopies}set renderWorldCopies(C){void 0===C?C=!0:null===C&&(C=!1),this._renderWorldCopies=C}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const C=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(C))}get cameraWorldSize(){const C=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(C))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return Qd(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new je(this.width,this.height)}get bearing(){return D(this.rotation,-180,180)}set bearing(C){this.rotation=C}get rotation(){return-this.angle/Math.PI*180}set rotation(C){const te=-C*Math.PI/180;this.angle!==te&&(this._unmodified=!1,this.angle=te,this._calcMatrices(),this.rotationMatrix=rd.create(),rd.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(C){const te=z(C,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==te&&(this._unmodified=!1,this._pitch=te,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}get fovX(){return this._fov}get fovY(){const C=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/C)}set fov(C){C=Math.max(.01,Math.min(60,C)),this._fov!==C&&(this._unmodified=!1,this._fov=w(C),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(C){this._averageElevation=C,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(C){const te=Math.min(Math.max(C,this.minZoom),this.maxZoom);this._zoom!==te&&(this._unmodified=!1,this._setZoom(te),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(C){this._zoom=C,this.scale=this.zoomScale(C),this.tileZoom=Math.floor(C),this.zoomFraction=C-this.tileZoom}_updateCameraOnTerrain(){const C=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,te=this.elevation&&C===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||C===Number.NEGATIVE_INFINITY&&(!te||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const le=this._elevation;te||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&le.exaggeration()&&this._centerAltitudeValidForExaggeration!==le.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*le.exaggeration(),this._centerAltitudeValidForExaggeration=le.exaggeration()):(this._centerAltitude=C||0,this._centerAltitudeValidForExaggeration=le.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){void 0!==this._centerAltitudeValidForExaggeration&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const C=this._elevation,te=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],le=this.horizonLineFromTop();let ce=0,he=0;for(let ue=0;ue<te.length;ue++){const de=new je(te[ue][0]*this.width,le+te[ue][1]*(this.height-le)),_e=C.pointCoordinate(de);if(!_e)continue;const ye=1/Math.hypot(_e[0]-this._camera.position[0],_e[1]-this._camera.position[1]);ce+=_e[3]*ye,he+=ye}return 0===he?NaN:ce/he}get center(){return this._center}set center(C){C.lat===this._center.lat&&C.lng===this._center.lng||(this._unmodified=!1,this._center=C,this._terrainEnabled()&&("ground"===this.cameraElevationReference?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(null==this._seaLevelZoom||!this._elevation)return;const C=this._seaLevelZoom,te=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),le=this.pixelsPerMeter/this.worldSize*te,ce=this._mercatorZfromZoom(C),he=this._mercatorZfromZoom(this._maxZoom),ue=Math.max(ce-le,he);this._setZoom(this._zoomFromMercatorZ(ue))}get padding(){return this._edgeInsets.toJSON()}set padding(C){this._edgeInsets.equals(C)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,C,1),this._calcMatrices())}computeZoomRelativeTo(C){const te=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,C.toAltitude()));let le;le=C.z<this._camera.position[2]?[te.x,te.y,te.z]:[C.x,C.y,C.z];const ce=Zd.length(Zd.sub([],this._camera.position,le));return z(this._zoomFromMercatorZ(ce),this._minZoom,this._maxZoom)}setFreeCameraOptions(C){if(!this.height)return;if(!C.position&&!C.orientation)return;this._updateCameraState();let te=!1;if(C.orientation&&!Md.exactEquals(C.orientation,this._camera.orientation)&&(te=this._setCameraOrientation(C.orientation)),C.position){const le=[C.position.x,C.position.y,C.position.z];Zd.exactEquals(le,this._camera.position)||(this._setCameraPosition(le),te=!0)}te&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const C=this._camera.position,te=new Xx;return te.position=new lp(C[0],C[1],C[2]),te.orientation=this._camera.orientation,te._elevation=this.elevation,te._renderWorldCopies=this.renderWorldCopies,te}_setCameraOrientation(C){if(!Md.length(C))return!1;Md.normalize(C,C);const te=Zd.transformQuat([],[0,0,-1],C),le=Zd.transformQuat([],[0,-1,0],C);if(le[2]<0)return!1;const ce=Hx(te,le);return!!ce&&(this._camera.orientation=ce,!0)}_setCameraPosition(C){const te=this.zoomScale(this.minZoom)*this.tileSize,le=this.zoomScale(this.maxZoom)*this.tileSize,ce=this.cameraToCenterDistance;C[2]=z(C[2],ce/le,ce/te),this._camera.position=C}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(C){return this._edgeInsets.equals(C)}interpolatePadding(C,te,le){this._unmodified=!1,this._edgeInsets.interpolate(C,te,le),this._constrain(),this._calcMatrices()}coveringZoomLevel(C){const te=(C.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/C.tileSize));return Math.max(0,te)}getVisibleUnwrappedCoordinates(C){const te=[new Gu(0,C)];if(this.renderWorldCopies){const le=this.pointCoordinate(new je(0,0)),ce=this.pointCoordinate(new je(this.width,0)),he=this.pointCoordinate(new je(this.width,this.height)),ue=this.pointCoordinate(new je(0,this.height)),de=Math.floor(Math.min(le.x,ce.x,he.x,ue.x)),_e=Math.floor(Math.max(le.x,ce.x,he.x,ue.x)),ye=1;for(let le=de-ye;le<=_e+ye;le++)0!==le&&te.push(new Gu(le,C))}return te}isLODDisabled(C){return(!C||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCoverForShadows(C,te,le){let ce=[];if(0===te[0]&&0===te[1])return ce;for(const le of C){const C=le.canonical,he=le.overscaledZ,ue=le.wrap,de=1<<C.z,_e=C.x+1<de,ye=C.x>0,ve=C.y+1<de,Se=C.y>0,Me=le.wrap-(ye?0:1),Ae=le.wrap+(_e?0:1),Ce=ye?C.x-1:de-1,Oe=_e?C.x+1:0;te[0]<0?(ce.push(new qu(he,Ae,C.z,Oe,C.y)),te[1]<0&&ve&&(ce.push(new qu(he,ue,C.z,C.x,C.y+1)),ce.push(new qu(he,Ae,C.z,Oe,C.y+1))),te[1]>0&&Se&&(ce.push(new qu(he,ue,C.z,C.x,C.y-1)),ce.push(new qu(he,Ae,C.z,Oe,C.y-1)))):te[0]>0?(ce.push(new qu(he,Me,C.z,Ce,C.y)),te[1]<0&&ve&&(ce.push(new qu(he,ue,C.z,C.x,C.y+1)),ce.push(new qu(he,Me,C.z,Ce,C.y+1))),te[1]>0&&Se&&(ce.push(new qu(he,ue,C.z,C.x,C.y-1)),ce.push(new qu(he,Me,C.z,Ce,C.y-1)))):te[1]<0&&ve?ce.push(new qu(he,ue,C.z,C.x,C.y+1)):Se&&ce.push(new qu(he,ue,C.z,C.x,C.y-1))}if(ce.length>1){ce.sort(((C,te)=>C.overscaledZ-te.overscaledZ||C.wrap-te.wrap||C.canonical.z-te.canonical.z||C.canonical.x-te.canonical.x||C.canonical.y-te.canonical.y));let C=0,te=0;for(;te<ce.length;)ce[te].equals(ce[C])?++te:ce[++C]=ce[te++];ce.length=C+1}const he=[];for(const C of ce)ce.some((te=>C.isChildOf(te)))||he.push(C);return ce=he.filter((te=>!C.some((C=>!!(te.overscaledZ<le&&C.isChildOf(te))||te.equals(C)||te.isChildOf(C))))),ce}coveringTiles(C){let te=this.coveringZoomLevel(C);const le=te,ce=this.elevation&&this.elevation.exaggeration(),he=ce&&!C.isTerrainDEM,ue="mercator"===this.projection.name;if(void 0!==C.minzoom&&te<C.minzoom)return[];void 0!==C.maxzoom&&te>C.maxzoom&&(te=C.maxzoom);const de=this.locationCoordinate(this.center),_e=this.center.lat,ye=1<<te,ve=[ye*de.x,ye*de.y,0],Se="globe"===this.projection.name,Me=!Se,Ae=Qu.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,te,Me),Ce=Se?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),Oe=ye*Qd(1,this.center.lat),Ne=this._camera.position[2]/Qd(1,this.center.lat),je=[ye*Ce.x,ye*Ce.y,Ne*(Me?1:Oe)],Ge=Se||ce,Ze=this.cameraToCenterDistance/C.tileSize*(C.roundZoom?1:.502),$e=this.isLODDisabled(!0)?te:0;let He;if(this._elevation&&C.isTerrainDEM)He=1e4*this._elevation.exaggeration();else if(this._elevation){const C=this._elevation.getMinMaxForVisibleTiles();He=C?C.max:this._centerAltitude}else He=this._centerAltitude;const We=C.isTerrainDEM?-He:this._elevation?this._elevation.getMinElevationBelowMSL():0,Xe=this.projection.isReprojectedInTileSpace?Jx(this):1,T=C=>{const te=1/4e4,le=new lp(C.x+te,C.y,C.z),ce=new lp(C.x,C.y+te,C.z),he=C.toLngLat(),ue=le.toLngLat(),de=ce.toLngLat(),_e=this.locationCoordinate(he),ye=this.locationCoordinate(ue),ve=this.locationCoordinate(de),Se=Math.hypot(ye.x-_e.x,ye.y-_e.y),Me=Math.hypot(ve.x-_e.x,ve.y-_e.y);return Math.sqrt(Se*Me)*Xe/te},M=C=>{const te=He,le=We;return{aabb:Dg(this,ye,0,0,0,C,le,te,this.projection),zoom:0,x:0,y:0,minZ:le,maxZ:te,wrap:C,fullyVisible:!1}},Ye=[];let Je=[];const Qe=te,tt=C.reparseOverscaled?le:te,z=C=>C*C,rt=z((Ne-this._centerAltitude)*Oe),D=C=>{if(!this._elevation||!C.tileID||!ue)return;const te=this._elevation.getMinMaxForTile(C.tileID),le=C.aabb;te?(le.min[2]=te.min,le.max[2]=te.max,le.center[2]=(le.min[2]+le.max[2])/2):(C.shouldSplit=R(C),C.shouldSplit||(le.min[2]=le.max[2]=le.center[2]=this._centerAltitude))},R=C=>{if(C.zoom<$e)return!0;if(C.zoom===Qe)return!1;if(null!=C.shouldSplit)return C.shouldSplit;const te=C.aabb.distanceX(je),ce=C.aabb.distanceY(je);let ue=rt,de=1;if(Se){ue=z(C.aabb.distanceZ(je));const te=Math.pow(2,C.zoom),le=tp((C.y+1)/te),ce=tp(C.y/te),he=Math.min(Math.max(_e,le),ce),ye=Yd(he)/Yd(_e);if(de=he===_e?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,ye/this._mercatorScaleRatio),this.zoom<=Up&&C.zoom===Qe-1&&ye>=.9)return!0}else if(he&&(ue=z(C.aabb.distanceZ(je)*Oe)),this.projection.isReprojectedInTileSpace&&le<=5){const te=Math.pow(2,C.zoom),le=T(new lp((C.x+.5)/te,(C.y+.5)/te));de=le>.85?1:le}const ye=te*te+ce*ce+ue,ve=z((1<<Qe-C.zoom)*Ze*de*((C,te)=>{if(te*z(.707)<C)return 1;const le=Math.sqrt(te/C);return le/(1.4144271570014144+(Math.pow(1.1,le-1.4144271570014144+1)-1)/(1.1-1)-1)})(Math.max(ue,rt),ye));return ye<ve};if(this.renderWorldCopies)for(let C=1;C<=3;C++)Ye.push(M(-C)),Ye.push(M(C));for(Ye.push(M(0));Ye.length>0;){const le=Ye.pop(),ce=le.x,de=le.y;let _e=le.fullyVisible;const u=()=>"globe"===this.projection.name&&(0===le.y||le.y===(1<<le.zoom)-1);if(!_e){let C=Ge?le.aabb.intersects(Ae):le.aabb.intersectsFlat(Ae);if(0===C&&u()){const te=new ju(le.zoom,ce,de);C=yd(this,ye,te,!0).intersects(Ae)}if(0===C)continue;_e=2===C}if(le.zoom!==Qe&&R(le))for(let C=0;C<4;C++){const te=(ce<<1)+C%2,ve=(de<<1)+(C>>1),Me={aabb:ue?le.aabb.quadrant(C):Dg(this,ye,le.zoom+1,te,ve,le.wrap,le.minZ,le.maxZ,this.projection),zoom:le.zoom+1,x:te,y:ve,wrap:le.wrap,fullyVisible:_e,tileID:void 0,shouldSplit:void 0,minZ:le.minZ,maxZ:le.maxZ};he&&!Se&&(Me.tileID=new qu(le.zoom+1===Qe?tt:le.zoom+1,le.wrap,le.zoom+1,te,ve),D(Me)),Ye.push(Me)}else{const he=le.zoom===Qe?tt:le.zoom;if(C.minzoom&&C.minzoom>he)continue;if(!_e){let C=Ge?le.aabb.intersectsPrecise(Ae):le.aabb.intersectsPreciseFlat(Ae);if(0===C&&u()){const te=new ju(le.zoom,ce,de);C=yd(this,ye,te,!0).intersectsPrecise(Ae)}if(0===C)continue}const ue=ve[0]-(.5+ce+(le.wrap<<le.zoom))*(1<<te-le.zoom),Se=ve[1]-.5-de,Me=le.tileID?le.tileID:new qu(he,le.wrap,le.zoom,ce,de);Je.push({tileID:Me,distanceSq:ue*ue+Se*Se})}}if(this.fogCullDistSq){const te=this.fogCullDistSq,le=this.horizonLineFromTop();Je=Je.filter((ce=>{const he=[0,0,0,1],ue=[Mn,Mn,0,1],de=this.calculateFogTileMatrix(ce.tileID.toUnwrapped());$u.transformMat4(he,he,de),$u.transformMat4(ue,ue,de);const _e=function(C,te,le){let ce=0;for(let le=0;le<2;++le){const he=0;C[le]>he&&(ce+=(C[le]-he)*(C[le]-he)),te[le]<he&&(ce+=(he-te[le])*(he-te[le]))}return ce}($u.min([],he,ue),$u.max([],he,ue));if(0===_e)return!0;let ye=!1;const ve=this._elevation;if(ve&&_e>te&&0!==le){const te=this.calculateProjMatrix(ce.tileID.toUnwrapped());let he;C.isTerrainDEM||(he=ve.getMinMaxForTile(ce.tileID)),he||(he={min:We,max:He});const ue=function(C){const te=Math.round((C+45+360)%360/90)%4;return qe[te]}(this.rotation),de=[ue[0]*Mn,ue[1]*Mn,he.max];Zd.transformMat4(de,de,te),ye=(1-de[1])*this.height*.5<le}return _e<te||ye}))}return Je.sort(((C,te)=>C.distanceSq-te.distanceSq)).map((C=>C.tileID))}resize(C,te){this.width=C,this.height=te,this.pixelsToGLUnits=[2/C,-2/te],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(C){return Math.pow(2,C)}scaleZoom(C){return Math.log(C)/Math.LN2}project(C){const te=z(C.lat,-Xf,Xf),le=this.projection.project(C.lng,te);return new je(le.x*this.worldSize,le.y*this.worldSize)}unproject(C){return this.projection.unproject(C.x/this.worldSize,C.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/Qd(1,this.center.lat)/this.worldSize}setLocationAtPoint(C,te){let le,ce;const he=this.centerPoint;if("globe"===this.projection.name){const C=this.worldSize;le=(te.x-he.x)/C,ce=(te.y-he.y)/C}else{const C=this.pointCoordinate(te),ue=this.pointCoordinate(he);le=C.x-ue.x,ce=C.y-ue.y}const ue=this.locationCoordinate(C);this.setLocation(new lp(ue.x-le,ue.y-ce))}setLocation(C){this.center=this.coordinateLocation(C),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(C){return this.projection.locationPoint(this,C)}locationPoint3D(C){return this.projection.locationPoint(this,C,!0)}pointLocation(C){return this.coordinateLocation(this.pointCoordinate(C))}pointLocation3D(C){return this.coordinateLocation(this.pointCoordinate3D(C))}locationCoordinate(C,te){const le=te?Qd(te,C.lat):void 0,ce=this.projection.project(C.lng,C.lat);return new lp(ce.x,ce.y,le)}coordinateLocation(C){return this.projection.unproject(C.x,C.y)}pointRayIntersection(C,te){const le=null!=te?te:this._centerAltitude,ce=[C.x,C.y,0,1],he=[C.x,C.y,1,1];$u.transformMat4(ce,ce,this.pixelMatrixInverse),$u.transformMat4(he,he,this.pixelMatrixInverse);const ue=he[3];$u.scale(ce,ce,1/ce[3]),$u.scale(he,he,1/ue);const de=ce[2],_e=he[2];return{p0:ce,p1:he,t:de===_e?0:(le-de)/(_e-de)}}screenPointToMercatorRay(C){const te=[C.x,C.y,0,1],le=[C.x,C.y,1,1];return $u.transformMat4(te,te,this.pixelMatrixInverse),$u.transformMat4(le,le,this.pixelMatrixInverse),$u.scale(te,te,1/te[3]),$u.scale(le,le,1/le[3]),te[2]=Qd(te[2],this._center.lat)*this.worldSize,le[2]=Qd(le[2],this._center.lat)*this.worldSize,$u.scale(te,te,1/this.worldSize),$u.scale(le,le,1/this.worldSize),new Wu([te[0],te[1],te[2]],Zd.normalize([],Zd.sub([],le,te)))}rayIntersectionCoordinate(C){const{p0:te,p1:le,t:ce}=C,he=Qd(te[2],this._center.lat),ue=Qd(le[2],this._center.lat);return new lp(Kr(te[0],le[0],ce)/this.worldSize,Kr(te[1],le[1],ce)/this.worldSize,Kr(he,ue,ce))}pointCoordinate(C,te=this._centerAltitude){return this.projection.pointCoordinate(this,C.x,C.y,te)}pointCoordinate3D(C){if(!this.elevation)return this.pointCoordinate(C);let te=this.projection.pointCoordinate3D(this,C.x,C.y);if(te)return new lp(te[0],te[1],te[2]);let le=0,ce=this.horizonLineFromTop();if(C.y>ce)return this.pointCoordinate(C);const he=.02*ce,ue=C.clone();for(let C=0;C<10&&ce-le>he;C++){ue.y=Kr(le,ce,.66);const C=this.projection.pointCoordinate3D(this,ue.x,ue.y);C?(ce=ue.y,te=C):le=ue.y}return te?new lp(te[0],te[1],te[2]):this.pointCoordinate(C)}isPointAboveHorizon(C){return this.projection.isPointAboveHorizon(this,C)}isPointOnSurface(C){if(C.y<0||C.y>this.height||C.x<0||C.x>this.width)return!1;if(this.elevation||this.zoom>=Vp)return!this.isPointAboveHorizon(C);const te=this.pointCoordinate(C);return te.y>=0&&te.y<=1}_coordinatePoint(C,te){const le=te&&this.elevation?this.elevation.getAtPointOrZero(C,this._centerAltitude):this._centerAltitude,ce=[C.x*this.worldSize,C.y*this.worldSize,le+C.toAltitude(),1];return $u.transformMat4(ce,ce,this.pixelMatrix),ce[3]>0?new je(ce[0]/ce[3],ce[1]/ce[3]):new je(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:C,left:te}=this._edgeInsets,le=this.height-this._edgeInsets.bottom,ce=this.width-this._edgeInsets.right,he=this.pointLocation3D(new je(te,C)),ue=this.pointLocation3D(new je(ce,C)),de=this.pointLocation3D(new je(ce,le)),_e=this.pointLocation3D(new je(te,le));let ye=Math.min(he.lng,ue.lng,de.lng,_e.lng),ve=Math.max(he.lng,ue.lng,de.lng,_e.lng),Se=Math.min(he.lat,ue.lat,de.lat,_e.lat),Me=Math.max(he.lat,ue.lat,de.lat,_e.lat);const Ae=Math.pow(2,-this.zoom)/16*270,Ce="globe"===this.projection.name?1:4,f=(C,te,le,ce,he)=>{const ue=(C+le)/2,de=(te+ce)/2,_e=new je(ue,de),{lng:Oe,lat:Ne}=this.pointLocation3D(_e),Ge=Math.max(0,ye-Oe,Se-Ne,Oe-ve,Ne-Me);ye=Math.min(ye,Oe),ve=Math.max(ve,Oe),Se=Math.min(Se,Ne),Me=Math.max(Me,Ne),(he<Ce||Ge>Ae)&&(f(C,te,ue,de,he+1),f(ue,de,le,ce,he+1))};if(f(te,C,ce,C,1),f(ce,C,ce,le,1),f(ce,le,te,le,1),f(te,le,te,C,1),"globe"===this.projection.name){const[C,te]=function(C){const te=ld.identity(new Float64Array(16));ld.multiply(te,C.pixelMatrix,C.globeMatrix);const le=[0,sf,0],ce=[0,af,0];return Zd.transformMat4(le,le,te),Zd.transformMat4(ce,ce,te),[le[0]>0&&le[0]<=C.width&&le[1]>0&&le[1]<=C.height&&!Nd(C,new $f(C.center.lat,90)),ce[0]>0&&ce[0]<=C.width&&ce[1]>0&&ce[1]<=C.height&&!Nd(C,new $f(C.center.lat,-90))]}(this);C?(Me=90,ve=180,ye=-180):te&&(Se=-90,ve=180,ye=-180)}return new sc(new $f(ye,Se),new $f(ve,Me))}_getBoundsRectangular(C,te){const{top:le,left:ce}=this._edgeInsets,he=this.height-this._edgeInsets.bottom,ue=this.width-this._edgeInsets.right,de=new je(ce,le),_e=new je(ue,le),ye=new je(ue,he),ve=new je(ce,he);let Se=this.pointCoordinate(de,C),Me=this.pointCoordinate(_e,C);const Ae=this.pointCoordinate(ye,te),Ce=this.pointCoordinate(ve,te),f=(C,te)=>(te.y-C.y)/(te.x-C.x);return Se.y>1&&Me.y>=0?Se=new lp((1-Ce.y)/f(Ce,Se)+Ce.x,1):Se.y<0&&Me.y<=1&&(Se=new lp(-Ce.y/f(Ce,Se)+Ce.x,0)),Me.y>1&&Se.y>=0?Me=new lp((1-Ae.y)/f(Ae,Me)+Ae.x,1):Me.y<0&&Se.y<=1&&(Me=new lp(-Ae.y/f(Ae,Me)+Ae.x,0)),(new sc).extend(this.coordinateLocation(Se)).extend(this.coordinateLocation(Me)).extend(this.coordinateLocation(Ce)).extend(this.coordinateLocation(Ae))}_getBoundsRectangularTerrain(){const C=this.elevation;if(!C.visibleDemTiles.length||C.isUsingMockSource())return this._getBoundsRectangular(0,0);const te=C.visibleDemTiles.reduce(((C,te)=>{if(te.dem){const le=te.dem.tree;C.min=Math.min(C.min,le.minimums[0]),C.max=Math.max(C.max,le.maximums[0])}return C}),{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(te.min*C.exaggeration(),te.max*C.exaggeration())}getBounds(){return"mercator"===this.projection.name||"equirectangular"===this.projection.name?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(C=!0){const te=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,le=this.height/2-te*(1-this._horizonShift);return C?Math.max(0,le):le}getMaxBounds(){return this.maxBounds}setMaxBounds(C){this.maxBounds=C,this.minLat=-Xf,this.maxLat=Xf,this.minLng=-180,this.maxLng=180,C&&(this.minLat=C.getSouth(),this.maxLat=C.getNorth(),this.minLng=C.getWest(),this.maxLng=C.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=Kd(this.minLng)*this.tileSize,this.worldMaxX=Kd(this.maxLng)*this.tileSize,this.worldMinY=Jd(this.maxLat)*this.tileSize,this.worldMaxY=Jd(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(C,te){return this.projection.createTileMatrix(this,te,C)}calculateDistanceTileData(C){const te=C.key,le=this._distanceTileDataCache;if(le[te])return le[te];const ce=C.canonical,he=1/this.height,ue=this.cameraWorldSize,de=ue/this.zoomScale(ce.z),_e=(ce.x+Math.pow(2,ce.z)*C.wrap)*de,ye=ce.y*de,ve=this.point;ve.x*=ue/this.worldSize,ve.y*=ue/this.worldSize;const Se=this.angle,Me=Math.sin(-Se),Ae=-Math.cos(-Se);return le[te]={bearing:[Me,Ae],center:[(ve.x-_e)*he,(ve.y-ye)*he],scale:de/Mn*he},le[te]}calculateFogTileMatrix(C){const te=C.key,le=this._fogTileMatrixCache;if(le[te])return le[te];const ce=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,C);return ld.multiply(ce,this.worldToFogMatrix,ce),le[te]=new Float32Array(ce),le[te]}calculateProjMatrix(C,te=!1,le=!1){const ce=C.key;let he;if(he=le?this._expandedProjMatrixCache:te?this._alignedProjMatrixCache:this._projMatrixCache,he[ce])return he[ce];const ue=this.calculatePosMatrix(C,this.worldSize);let de;return de=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:le?this.expandedFarZProjMatrix:te?this.alignedProjMatrix:this.projMatrix,ld.multiply(ue,de,ue),he[ce]=new Float32Array(ue),he[ce]}calculatePixelsToTileUnitsMatrix(C){const te=C.tileID.key,le=this._pixelsToTileUnitsCache;if(le[te])return le[te];const ce=function(C,te){const{scale:le}=C.tileTransform,ce=le*Mn/(C.tileSize*Math.pow(2,te.zoom-C.tileID.overscaledZ+C.tileID.canonical.z));return rd.scale(new Float32Array(4),te.inverseAdjustmentMatrix,[ce,ce])}(C,this);return le[te]=ce,le[te]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if("globe"===this.projection.name){const C=1/this.worldSize,te=ld.fromScaling([],[C,C,C]);return ld.multiply(te,te,this.globeMatrix),te}}recenterOnTerrain(){if(!this._elevation||"globe"===this.projection.name)return;const C=this._elevation;this._updateCameraState();const te=Qd(1,this._center.lat)*this.worldSize,le=this._computeCameraPosition(te),ce=this._camera.forward(),he=Qd(1,this._center.lat);le[2]/=he,ce[2]/=he,Zd.normalize(ce,ce);const ue=C.raycast(le,ce,C.exaggeration());if(ue){const C=Zd.scaleAndAdd([],le,ce,ue),te=new lp(C[0],C[1],Qd(C[2],tp(C[1]))),de=(te.z+Zd.length([te.x-le[0],te.y-le[1],te.z-le[2]*he]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(de),this._centerAltitude=te.toAltitude(),this._center=this.coordinateLocation(te),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(C=!1){if(!this._elevation)return;const te=this._elevation,le=Qd(1,this._center.lat)*this.worldSize,ce=this._computeCameraPosition(le),he=te.getAtPointOrZero(new lp(...ce)),ue=this.pixelsPerMeter/this.worldSize*he,de=this._minimumHeightOverTerrain(),_e=ce[2]-ue;if(_e<=de)if(_e<0||C){const C=this.locationCoordinate(this._center,this._centerAltitude),te=[ce[0],ce[1],C.z-ce[2]],le=Zd.length(te);te[2]-=(de-_e)/this._pixelsPerMercatorPixel;const he=Zd.length(te);if(0===he)return;Zd.scale(te,te,le/he*this._pixelsPerMercatorPixel),this._camera.position=[ce[0],ce[1],C.z*this._pixelsPerMercatorPixel-te[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const C="globe"===this.projection.name||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||C){const te=this.center;return te.lat=z(te.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!C)&&(te.lng=z(te.lng,this.minLng,this.maxLng)),this.center=te,void(this._constraining=!1)}const te=this._unmodified,{x:le,y:ce}=this.point;let he=0,ue=le,de=ce;const _e=this.width/2,ye=this.height/2,ve=this.worldMinY*this.scale,Se=this.worldMaxY*this.scale;if(ce-ye<ve&&(de=ve+ye),ce+ye>Se&&(de=Se-ye),Se-ve<this.height&&(he=Math.max(he,this.height/(Se-ve)),de=(Se+ve)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const C=this.worldMinX*this.scale,te=this.worldMaxX*this.scale,ce=this.worldSize/2-(C+te)/2;ue=(le+ce+this.worldSize)%this.worldSize-ce,ue-_e<C&&(ue=C+_e),ue+_e>te&&(ue=te-_e),te-C<this.width&&(he=Math.max(he,this.width/(te-C)),ue=(te+C)/2)}ue===le&&de===ce||(this.center=this.unproject(new je(ue,de))),he&&(this.zoom+=this.scaleZoom(he)),this._constrainCamera(),this._unmodified=te,this._constraining=!1}_minZoomForBounds(){let C=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(C=Math.max(C,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),C}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const C=this.centerOffset,te="globe"===this.projection.name,le=this.pixelsPerMeter;"globe"===this.projection.name&&(this._mercatorScaleRatio=Qd(1,this.center.lat)/Qd(1,45));const ce=Qx(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,ce),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const he="meters"===this.projection.zAxisUnit?le:1,ue=this._camera.getWorldToCamera(this.worldSize,he);let de;const _e=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(_e[8]=2*-C.x/this.width,_e[9]=2*C.y/this.height,this.isOrthographic){let te=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),le=te*this.aspect,ce=-le,he=-te;le-=C.x,ce-=C.x,te+=C.y,he+=C.y,de=this._camera.getCameraToClipOrthographic(ce,le,he,te,this._nearZ,this._farZ),((C,te,le,ce)=>{for(let he=0;he<16;he++)C[he]=bv(te[he],le[he],ce)})(de,de,_e,wv(this.pitch>=15?1:this.pitch/15))}else de=_e;const ye=ld.mul([],_e,ue);let ve=ld.mul([],de,ue);if(this.projection.isReprojectedInTileSpace){const C=this.locationCoordinate(this.center),te=ld.identity([]);ld.translate(te,te,[C.x*this.worldSize,C.y*this.worldSize,0]),ld.multiply(te,te,Kx(this)),ld.translate(te,te,[-C.x*this.worldSize,-C.y*this.worldSize,0]),ld.multiply(ve,ve,te),ld.multiply(ye,ye,te),this.inverseAdjustmentMatrix=function(C){const te=Kx(C,!0);return rd.invert([],[te[0],te[1],te[4],te[5]])}(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=ld.scale([],ve,[this.worldSize,this.worldSize,this.worldSize/he,1]),this.projMatrix=ve,this.invProjMatrix=ld.invert(new Float64Array(16),this.projMatrix),te){const te=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);te[8]=2*-C.x/this.width,te[9]=2*C.y/this.height,this.expandedFarZProjMatrix=ld.mul([],te,ue)}else this.expandedFarZProjMatrix=this.projMatrix;const Se=ld.invert([],de);this.frustumCorners=Hu.fromInvProjectionMatrix(Se,this.horizonLineFromTop(),this.height),this.cameraFrustum=Qu.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!te);const Me=new Float32Array(16);ld.identity(Me),ld.scale(Me,Me,[1,-1,1]),ld.rotateX(Me,Me,this._pitch),ld.rotateZ(Me,Me,this.angle);const Ae=ld.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=ld.clone(Ae);const Ce=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;Ae[8]=2*-C.x/this.width,Ae[9]=2*(C.y+Ce)/this.height,this.skyboxMatrix=ld.multiply(Me,Ae,Me);const Oe=this.point,Ne=Oe.x,je=Oe.y,Ge=this.width%2/2,Ze=this.height%2/2,qe=Math.cos(this.angle),$e=Math.sin(this.angle),He=Ne-Math.round(Ne)+qe*Ge+$e*Ze,We=je-Math.round(je)+qe*Ze+$e*Ge,Xe=new Float64Array(ve);if(ld.translate(Xe,Xe,[He>.5?He-1:He,We>.5?We-1:We,0]),this.alignedProjMatrix=Xe,ve=ld.create(),ld.scale(ve,ve,[this.width/2,-this.height/2,1]),ld.translate(ve,ve,[1,-1,0]),this.labelPlaneMatrix=ve,ve=ld.create(),ld.scale(ve,ve,[1,-1,1]),ld.translate(ve,ve,[-1,-1,0]),ld.scale(ve,ve,[2/this.width,2/this.height,1]),this.glCoordMatrix=ve,this.pixelMatrix=ld.multiply(new Float64Array(16),this.labelPlaneMatrix,ye),this._calcFogMatrices(),this._distanceTileDataCache={},ve=ld.invert(new Float64Array(16),this.pixelMatrix),!ve)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=ve,"globe"===this.projection.name||this.mercatorFromTransition){this.globeMatrix=function(C){const{x:te,y:le}=C.point,{lng:ce,lat:he}=C._center;return zd(te,le,C.worldSize,ce,he)}(this);const C=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=Zd.transformMat4(C,C,ue),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=ve;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const C=this.cameraWorldSizeForFog,te=this.cameraPixelsPerMeter,le=this._camera.position,ce=1/this.height/this._pixelsPerMercatorPixel,he=[C,C,te];Zd.scale(he,he,ce),Zd.scale(le,le,-1),Zd.multiply(le,le,he);const ue=ld.create();ld.translate(ue,ue,le),ld.scale(ue,ue,he),this.mercatorFogMatrix=ue,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(C,te,ce)}_computeCameraPosition(C){const te=(C=C||this.pixelsPerMeter)/this.pixelsPerMeter,le=this._camera.forward(),ce=this.point,he=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*te-C/this.worldSize*this._centerAltitude;return[ce.x/this.worldSize-le[0]*he,ce.y/this.worldSize-le[1]*he,C/this.worldSize*this._centerAltitude-le[2]*he]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(C){const te=this._maxCameraBoundsDistance()*Math.cos(this._pitch),le=this._camera.position[2],ce=C[2];let he=1;this.projection.wrap&&(this.center=this.center.wrap()),ce>0&&(he=Math.min((te-le)/ce,1)),this._camera.position=Zd.scaleAndAdd([],this._camera.position,C,he),this._updateStateFromCamera()}_updateStateFromCamera(){const C=this._camera.position,te=this._camera.forward(),{pitch:le,bearing:ce}=this._camera.getPitchBearing(),he=Qd(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,ue=this._mercatorZfromZoom(this._maxZoom)*Math.cos(w(this._maxPitch)),de=Math.max((C[2]-he)/Math.cos(le),ue),_e=this._zoomFromMercatorZ(de);Zd.scaleAndAdd(C,C,te,de),this._pitch=z(le,w(this.minPitch),w(this.maxPitch)),this.angle=D(ce,-Math.PI,Math.PI),this._setZoom(z(_e,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new lp(C[0],C[1],C[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(C){return Math.pow(2,C)*this.tileSize}_mercatorZfromZoom(C){return this.cameraToCenterDistance/this._worldSizeFromZoom(C)}_minimumHeightOverTerrain(){const C=Math.min((null!=this._seaLevelZoom?this._seaLevelZoom:this._zoom)+4,this._maxZoom);return this._mercatorZfromZoom(C)}_zoomFromMercatorZ(C){return this.scaleZoom(this.cameraToCenterDistance/(C*this.tileSize))}zoomFromMercatorZAdjusted(C){let te=0,le=Vp,ce=0,he=1/0;for(;le-te>1e-6&&le>te;){const ue=te+.5*(le-te),de=this.tileSize*Math.pow(2,ue),_e=this.getCameraToCenterDistance(this.projection,ue,de),ye=this.scaleZoom(_e/(C*this.tileSize)),ve=Math.abs(ue-ye);ve<he&&(he=ve,ce=ue),ue<ye?te=ue:le=ue}return ce}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(H("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(C,te){const le=Math.min(C.x,te.x),ce=Math.max(C.x,te.x),he=Math.min(C.y,te.y),ue=Math.max(C.y,te.y);if(he<this.horizonLineFromTop(!1))return!0;if("mercator"!==this.projection.name)return!1;const de=[new je(le,he),new je(ce,ue),new je(le,ue),new je(ce,he)],_e=this.renderWorldCopies?-3:0,ye=this.renderWorldCopies?4:1;for(const C of de){const te=this.pointRayIntersection(C);if(te.t<0)return!0;const le=this.rayIntersectionCoordinate(te);if(le.x<_e||le.y<0||le.x>ye||le.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+T(this.fovAboveCenter)>88||this.anyCornerOffEdge(new je(0,0),new je(this.width,this.height))}zoomDeltaToMovement(C,te){const le=Zd.length(Zd.sub([],this._camera.position,C)),ce=this._zoomFromMercatorZ(le)+te;return le-this._mercatorZfromZoom(ce)}getCameraPoint(){if("globe"===this.projection.name){const C=function([C,te,le],ce){const he=[C,te,le,1];$u.transformMat4(he,he,ce);const ue=he[3]=Math.max(he[3],1e-6);return he[0]/=ue,he[1]/=ue,he[2]/=ue,he}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new je(C[0],C[1])}{const C=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new je(0,C))}}getCameraToCenterDistance(C,te=this.zoom,le=this.worldSize){const ce=Qx(C,te,this.width,this.height,1024),he=C.pixelSpaceConversion(this.center.lat,le,ce);let ue=.5/Math.tan(.5*this._fov)*this.height*he;return this.isOrthographic&&(ue=bv(1,ue,wv(this.pitch>=15?1:this.pitch/15))),ue}getWorldToCameraMatrix(){const C=this._camera.getWorldToCamera(this.worldSize,"meters"===this.projection.zAxisUnit?this.pixelsPerMeter:1);return"globe"===this.projection.name&&ld.multiply(C,C,this.globeMatrix),C}getFrustum(C){return Qu.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,C,"meters"===this.projection.zAxisUnit)}}function Ev(C,te,le){ld.identity(C),ld.rotateZ(C,C,w(te[2])),ld.rotateX(C,C,w(te[0])),ld.rotateY(C,C,w(te[1])),ld.scale(C,C,le),ld.multiply(C,C,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function Mv(C,te,le,ce,he,ue,de,_e){const ye=[le[0]-te[0],le[1]-te[1],0],ve=[ce[0]-te[0],ce[1]-te[1],0];if(Zd.length(ye)<1e-12||Zd.length(ve)<1e-12)return Md.identity(C);const Se=Zd.cross([],ye,ve);Zd.normalize(Se,Se),Zd.subtract(ve,ce,te),ye[2]=(ue-he)*_e,ve[2]=(de-he)*_e;const Me=ye;return Zd.cross(Me,ye,ve),Zd.normalize(Me,Me),Md.rotationTo(C,Se,Me)}function Av(C,te,le=!1){const ce=Dd(te.zoom),he=function(C,te,le){const ce=te.worldSize,he=[C[12],C[13],C[14]],ue=tp(he[1]/ce),de=ep(he[0]/ce),_e=ld.identity([]),ye=Qd(1,ue)*ce,ve=Qd(1,0)*ce*op(ue,te.zoom),Se=1/Id(ce);let Me=ve*Se;if(le){const C=Qx(te.projection,te.zoom,te.width,te.height,1024);Me=Se*te.projection.pixelSpaceConversion(te.center.lat,ce,C)}const Ae=wd(ue,de);Zd.add(Ae,Ae,Zd.scale([],Zd.normalize([],Ae),ye*Me*he[2]));const Ce=function(C){const te=[C[0],C[1],C[2]];let le=[0,1,0];const ce=Zd.cross([],le,te);return Zd.cross(le,te,ce),0===Zd.squaredLength(le)&&(le=[0,1,0],Zd.cross(ce,te,le)),Zd.normalize(ce,ce),Zd.normalize(le,le),Zd.normalize(te,te),[ce[0],ce[1],ce[2],0,le[0],le[1],le[2],0,te[0],te[1],te[2],0,C[0],C[1],C[2],1]}(Ae);ld.scale(_e,_e,[Me,Me,Me*ye]),ld.translate(_e,_e,[-he[0],-he[1],-he[2]]);const Oe=ld.multiply([],te.globeMatrix,Ce);return ld.multiply(Oe,Oe,_e),ld.multiply(Oe,Oe,C),Oe}(C,te,le);if(ce>0){const le=function(C,te){const le=te.worldSize,ce=Qd(1,0)*le*op(te.center.lat,te.zoom)/Id(le),he=Qd(1,te.center.lat)*le,ue=ld.identity([]);return ld.rotateY(ue,ue,w(te.center.lng)),ld.rotateX(ue,ue,w(te.center.lat)),ld.translate(ue,ue,[0,0,$p]),ld.scale(ue,ue,[ce,ce,ce*he]),ld.translate(ue,ue,[te.point.x-.5*le,te.point.y-.5*le,0]),ld.multiply(ue,ue,C),ld.multiply(ue,te.globeMatrix,ue)}(C,te);return function(C,te,le){const r=(C,te,le)=>{const ce=Zd.length(C),he=Zd.length(te),ue=md(C,te,le);return Zd.scale(ue,ue,1/Zd.length(ue)*Kr(ce,he,le))},ce=r([C[0],C[1],C[2]],[te[0],te[1],te[2]],le),he=r([C[4],C[5],C[6]],[te[4],te[5],te[6]],le),ue=r([C[8],C[9],C[10]],[te[8],te[9],te[10]],le),de=md([C[12],C[13],C[14]],[te[12],te[13],te[14]],le);return[ce[0],ce[1],ce[2],0,he[0],he[1],he[2],0,ue[0],ue[1],ue[2],0,de[0],de[1],de[2],1]}(he,le,ce)}return he}const Xb=64,Yb=[1,1,1];class Cv{constructor(C,te,le,ce){this.id=C,this.position=null!=te?new $f(te[0],te[1]):new $f(0,0),this.orientation=null!=le?le:[0,0,0],this.nodes=ce,this.uploaded=!1,this.aabb=new ed([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(C,te){if(ld.multiply(C.matrix,te,C.matrix),C.meshes)for(const te of C.meshes){const le=ed.applyTransform(te.aabb,C.matrix);this.aabb.encapsulate(le)}if(C.children)for(const te of C.children)this._applyTransformations(te,C.matrix)}computeBoundsAndApplyParent(){const C=ld.identity([]);for(const te of this.nodes)this._applyTransformations(te,C)}_positionModelOnTerrain(C,te){const le=C.elevation;if(!le)return 0;const ce=ed.projectAabbCorners(this.aabb,this.matrix),he=Qd(1,this.position.lat)*C.worldSize,ue=function(C,te){const le=[0,0,1],ce=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const he of ce){const ce=C[he.corners[0]],ue=C[he.corners[1]],de=C[he.corners[2]],_e=[ue[0]-ce[0],ue[1]-ce[1],te*(ue[2]-ce[2])],ye=Zd.cross(_e,_e,[de[0]-ce[0],de[1]-ce[1],te*(de[2]-ce[2])]);Zd.normalize(ye,ye),he.dotProductWithUp=Zd.dot(ye,le)}return ce.sort(((C,te)=>C.dotProductWithUp-te.dotProductWithUp)),ce[0].corners}(ce,he),de=ce[ue[0]],_e=ce[ue[1]],ye=ce[ue[2]],ve=ce[ue[3]],Se=le.getAtPointOrZero(new lp(de[0]/C.worldSize,de[1]/C.worldSize),0),Me=le.getAtPointOrZero(new lp(_e[0]/C.worldSize,_e[1]/C.worldSize),0),Ae=le.getAtPointOrZero(new lp(ye[0]/C.worldSize,ye[1]/C.worldSize),0),Ce=le.getAtPointOrZero(new lp(ve[0]/C.worldSize,ve[1]/C.worldSize),0),Oe=(Se+Ce)/2,Ne=(Me+Ae)/2;return Oe>Ne?Me<Ae?Mv(te,_e,ve,de,Me,Ce,Se,he):Mv(te,ye,de,ve,Ae,Se,Ce,he):Se<Ce?Mv(te,de,_e,ye,Se,Me,Ae,he):Mv(te,ve,ye,_e,Ce,Ae,Me,he),Math.max(Oe,Ne)}computeModelMatrix(C,te,le,ce,he,ue,de=!1){const _e=C.transform,ye=_e.zoom,ve=_e.project(this.position),Se=op(this.position.lat,ye),Me=1/Se;ld.identity(this.matrix),ld.translate(this.matrix,this.matrix,[ve.x+ce[0]*Me,ve.y+ce[1]*Me,ce[2]]);let Ae=1,Ce=1;const Oe=_e.worldSize;if(de){if("mercator"===_e.projection.name){let C=0;_e.elevation&&(C=_e.elevation.getAtPointOrZero(new lp(ve.x/Oe,ve.y/Oe),0));const te=$u.transformMat4([],[ve.x,ve.y,C,1],_e.projMatrix)[3]/_e.cameraToCenterDistance;Ae=te,Ce=te*op(_e.center.lat,ye)}else if("globe"===_e.projection.name){const C=Av(this.matrix,_e),te=ld.multiply([],_e.projMatrix,C),le=[0,0,0,1];$u.transformMat4(le,le,te);const ce=le[3]/_e.cameraToCenterDistance,he=Dd(ye),ue=_e.projection.pixelsPerMeter(this.position.lat,Oe)*op(this.position.lat,ye),de=_e.projection.pixelsPerMeter(_e.center.lat,Oe)*op(_e.center.lat,ye);Ae=ce/Kr(ue,np(_e.center.lat),he),Ce=ce*Se/ue,Ae*=de,Ce*=de}}else Ae=Me;ld.scale(this.matrix,this.matrix,[Ae,Ae,Ce]);const Ne=[...this.matrix],je=this.orientation,Ge=[];if(Ev(Ge,[je[0]+te[0],je[1]+te[1],je[2]+te[2]],le),ld.multiply(this.matrix,Ne,Ge),he&&_e.elevation){let C=0;const te=[];if(ue&&_e.elevation){C=this._positionModelOnTerrain(_e,te);const le=ld.fromQuat([],te),ce=ld.multiply([],le,Ge);ld.multiply(this.matrix,Ne,ce)}else C=_e.elevation.getAtPointOrZero(new lp(ve.x/Oe,ve.y/Oe),0);0!==C&&(this.matrix[14]+=C)}}upload(C){if(!this.uploaded){for(const te of this.nodes)Dv(te,C);for(const C of this.nodes)Rv(C);this.uploaded=!0}}destroy(){for(const C of this.nodes)Lv(C)}}function zv(C,te,le=!1){C.uploaded||(C.gfxTexture=new My(te,C.image,le?te.gl.R8:te.gl.RGBA,{useMipmap:C.sampler.minFilter>=te.gl.NEAREST_MIPMAP_NEAREST}),C.uploaded=!0,C.image=null)}function Pv(C,te,le){C.indexBuffer=te.createIndexBuffer(C.indexArray,!1,!0),C.vertexBuffer=te.createVertexBuffer(C.vertexArray,lb.members,!1,!0),C.normalArray&&(C.normalBuffer=te.createVertexBuffer(C.normalArray,Pb.members,!1,!0)),C.texcoordArray&&(C.texcoordBuffer=te.createVertexBuffer(C.texcoordArray,Db.members,!1,!0)),C.colorArray&&(C.colorBuffer=te.createVertexBuffer(C.colorArray,(12===C.colorArray.bytesPerElement?cb:gb).members,!1,!0)),C.featureArray&&(C.pbrBuffer=te.createVertexBuffer(C.featureArray,Fb.members,!0)),C.segments=xl.simpleSegment(0,0,C.vertexArray.length,C.indexArray.length);const ce=C.material;ce.pbrMetallicRoughness.baseColorTexture&&zv(ce.pbrMetallicRoughness.baseColorTexture,te),ce.pbrMetallicRoughness.metallicRoughnessTexture&&zv(ce.pbrMetallicRoughness.metallicRoughnessTexture,te),ce.normalTexture&&zv(ce.normalTexture,te),ce.occlusionTexture&&zv(ce.occlusionTexture,te,le),ce.emissionTexture&&zv(ce.emissionTexture,te)}function Dv(C,te,le){if(C.meshes)for(const ce of C.meshes)Pv(ce,te,le);if(C.children)for(const ce of C.children)Dv(ce,te,le)}function Rv(C){if(C.meshes)for(const te of C.meshes)te.indexArray.destroy(),te.vertexArray.destroy(),te.colorArray&&te.colorArray.destroy(),te.normalArray&&te.normalArray.destroy(),te.texcoordArray&&te.texcoordArray.destroy(),te.featureArray&&te.featureArray.destroy();if(C.children)for(const te of C.children)Rv(te)}function Lv(C){if(C.meshes)for(const le of C.meshes)le.vertexBuffer&&(le.vertexBuffer.destroy(),le.indexBuffer.destroy(),le.normalBuffer&&le.normalBuffer.destroy(),le.texcoordBuffer&&le.texcoordBuffer.destroy(),le.colorBuffer&&le.colorBuffer.destroy(),le.pbrBuffer&&le.pbrBuffer.destroy(),le.segments.destroy(),le.material&&((te=le.material).pbrMetallicRoughness.baseColorTexture&&te.pbrMetallicRoughness.baseColorTexture.gfxTexture&&te.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),te.pbrMetallicRoughness.metallicRoughnessTexture&&te.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&te.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),te.normalTexture&&te.normalTexture.gfxTexture&&te.normalTexture.gfxTexture.destroy(),te.emissionTexture&&te.emissionTexture.gfxTexture&&te.emissionTexture.gfxTexture.destroy(),te.occlusionTexture&&te.occlusionTexture.gfxTexture&&te.occlusionTexture.gfxTexture.destroy()));var te;if(C.children)for(const te of C.children)Lv(te)}class kv{constructor(C,te){this.feature=C,this.instancedDataOffset=te,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class Ov{constructor(){this.instancedDataArray=new rl,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class Bv{constructor(C){this.zoom=C.zoom,this.canonical=C.canonical,this.layers=C.layers,this.layerIds=this.layers.map((C=>C.fqid)),this.projection=C.projection,this.index=C.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter((C=>C.isStateDependent())).map((C=>C.id)),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0}}populate(C,te,le,ce){this.tileToMeter=ap(le);const he=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:ue,id:de,index:_e,sourceLayerIndex:ye}of C){const C=gp(ue,he);if(!this.layers[0]._featureFilter.filter(new oa(this.zoom),C,le))continue;const ve={id:de,sourceLayerIndex:ye,index:_e,geometry:he?C.geometry:_p(ue,le,ce),properties:ue.properties,type:ue.type,patterns:{}},Se=this.addFeature(ve,ve.geometry,C);Se&&te.featureIndex.insert(ue,ve.geometry,_e,ye,this.index,this.instancesPerModel[Se].instancedDataArray.length)}this.lookup=null}update(C,te,le,ce){for(const te in this.instancesPerModel){const le=this.instancesPerModel[te];for(const te in C)le.idToFeaturesIndex.hasOwnProperty(te)&&this.evaluate(le.features[le.idToFeaturesIndex[te]],C[te],le,!0)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let C=!1;for(const te in this.instancesPerModel){const le=this.instancesPerModel[te];for(const te of le.features){const ce=this.layers[0],he=te.feature,ue=this.canonical,de=ce.paint.get("model-rotation").evaluate(he,{},ue),_e=ce.paint.get("model-scale").evaluate(he,{},ue),ye=ce.paint.get("model-translation").evaluate(he,{},ue);Zd.exactEquals(te.rotation,de)&&Zd.exactEquals(te.scale,_e)&&Zd.exactEquals(te.translation,ye)||(this.evaluate(te,te.featureStates,le,!0),C=!0)}}return C}isEmpty(){for(const C in this.instancesPerModel)if(0!==this.instancesPerModel[C].instancedDataArray.length)return!1;return!0}uploadPending(){return!this.uploaded}upload(C){if(!this.uploaded)for(const te in this.instancesPerModel){const le=this.instancesPerModel[te];le.instancedDataArray.length<0||0===le.instancedDataArray.length||(le.instancedDataBuffer?le.instancedDataBuffer.updateData(le.instancedDataArray):le.instancedDataBuffer=C.createVertexBuffer(le.instancedDataArray,Bb.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const C in this.instancesPerModel){const te=this.instancesPerModel[C];0!==te.instancedDataArray.length&&te.instancedDataBuffer&&te.instancedDataBuffer.destroy()}}addFeature(C,te,le){const ce=this.layers[0],he=ce.layout.get("model-id").evaluate(le,{},this.canonical);if(!he)return H(`modelId is not evaluated for layer ${ce.id} and it is not going to get rendered.`),he;this.instancesPerModel[he]||(this.instancesPerModel[he]=new Ov);const ue=this.instancesPerModel[he],de=ue.instancedDataArray,_e=new kv(le,de.length);for(const C of te)for(const te of C){if(te.x<0||te.x>=Mn||te.y<0||te.y>=Mn)continue;const C=(this.lookupDim-1)/Mn,le=this.lookupDim*(te.y*C|0)+te.x*C|0;if(this.lookup){if(0!==this.lookup[le])continue;this.lookup[le]=1}this.instanceCount++;const ce=de.length;de.resize(ce+1),ue.instancesEvaluatedElevation.push(0),de.float32[16*ce]=te.x,de.float32[16*ce+1]=te.y}return _e.instancedDataCount=ue.instancedDataArray.length-_e.instancedDataOffset,_e.instancedDataCount>0&&(C.id&&(ue.idToFeaturesIndex[C.id]=ue.features.length),ue.features.push(_e),this.evaluate(_e,{},ue,!1)),he}evaluate(C,te,le,ce){const he=this.layers[0],ue=C.feature,de=this.canonical,_e=C.rotation=he.paint.get("model-rotation").evaluate(ue,te,de),ye=C.scale=he.paint.get("model-scale").evaluate(ue,te,de),ve=C.translation=he.paint.get("model-translation").evaluate(ue,te,de),Se=he.paint.get("model-color").evaluate(ue,te,de);Se.a=he.paint.get("model-color-mix-intensity").evaluate(ue,te,de);const Me=[];this.maxVerticalOffset<ve[2]&&(this.maxVerticalOffset=ve[2]),this.maxScale=Math.max(Math.max(this.maxScale,ye[0]),Math.max(ye[1],ye[2])),Ev(Me,_e,ye);const Ae=Math.round(100*Se.a)+Se.b/1.05;for(let te=0;te<C.instancedDataCount;++te){const he=C.instancedDataOffset+te,ue=16*he,_e=le.instancedDataArray.float32;let ye=0;ce&&(ye=_e[ue+6]-le.instancesEvaluatedElevation[he]);const Ce=0|_e[ue+1];_e[ue]=(0|_e[ue])+Se.r/1.05,_e[ue+1]=Ce+Se.g/1.05,_e[ue+2]=Ae,_e[ue+3]=1/(de.z>10?this.tileToMeter:ap(de,Ce)),_e[ue+4]=ve[0],_e[ue+5]=ve[1],_e[ue+6]=ve[2]+ye,_e[ue+7]=Me[0],_e[ue+8]=Me[1],_e[ue+9]=Me[2],_e[ue+10]=Me[4],_e[ue+11]=Me[5],_e[ue+12]=Me[6],_e[ue+13]=Me[8],_e[ue+14]=Me[9],_e[ue+15]=Me[10],le.instancesEvaluatedElevation[he]=ve[2]}}}Rs(Bv,"ModelBucket",{omit:["layers"]}),Rs(Ov,"PerModelAttributes"),Rs(kv,"ModelFeature");const ew=new ga({visibility:new fa(zi.layout_model.visibility),"model-id":new ma(zi.layout_model["model-id"])});var tw={paint:new ga({"model-opacity":new fa(zi.paint_model["model-opacity"]),"model-rotation":new ma(zi.paint_model["model-rotation"]),"model-scale":new ma(zi.paint_model["model-scale"]),"model-translation":new ma(zi.paint_model["model-translation"]),"model-color":new ma(zi.paint_model["model-color"]),"model-color-mix-intensity":new ma(zi.paint_model["model-color-mix-intensity"]),"model-type":new fa(zi.paint_model["model-type"]),"model-cast-shadows":new fa(zi.paint_model["model-cast-shadows"]),"model-receive-shadows":new fa(zi.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new fa(zi.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new ma(zi.paint_model["model-emissive-strength"]),"model-roughness":new ma(zi.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new ma(zi.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new fa(zi.paint_model["model-cutoff-fade-range"])}),layout:ew};const rw=new Float32Array(262144),nw=new Uint8Array(262144);function jv(C){let te=0;if(C.meshes)for(const le of C.meshes)te=Math.max(te,le.aabb.max[2]);if(C.children)for(const le of C.children)te=Math.max(te,jv(le));return te}const lw=["","wall","door","roof","window","lamp","logo"];class qv{constructor(C){this.node=C,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.feature={type:"Point",id:C.id,geometry:[],properties:{height:jv(C)}}}}class Zv{constructor(C,te,le,ce){this.nodes=C,this.id=te,this.modelTraits|=1,this.uploaded=!1,this.hasPattern=!1,le&&(this.modelTraits|=4),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=ce,this.dirty=!0,this.needsUpload=!1}update(){console.log("Update 3D model bucket")}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(C){if(!this.needsUpload)return;const te=this.getNodesInfo();for(const le of te){const te=le.node;this.uploaded?this.updatePbrBuffer(te):Dv(te,C,!0)}for(const C of te)Rv(C.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(C){let te=!1;if(!C.meshes)return te;for(const le of C.meshes)le.pbrBuffer&&(le.pbrBuffer.updateData(le.featureArray),te=!0);return te}needsReEvaluation(C,te,le){const ce=C.transform.projectionOptions,he=C.style.getBrightness(),ue=this.brightness!==he;return!!(!this.uploaded||this.dirty||ce.name!==this.projection.name||$v(le.paint.get("model-color").value,ue)||$v(le.paint.get("model-color-mix-intensity").value,ue)||$v(le.paint.get("model-roughness").value,ue)||$v(le.paint.get("model-emissive-strength").value,ue)||$v(le.paint.get("model-height-based-emissive-strength-multiplier").value,ue))&&(this.projection=ce,this.brightness=he,!0)}evaluateScale(C,te){if(C.transform.zoom===this.zoom)return;this.zoom=C.transform.zoom;const le=this.getNodesInfo(),ce=this.id.canonical;for(const C of le){const le=C.feature;C.evaluatedScale=te.paint.get("model-scale").evaluate(le,{},ce)}}evaluate(C){const te=this.getNodesInfo();for(const le of te){if(!le.node.meshes)continue;const te=le.feature,ce=le.node.meshes&&le.node.meshes[0].featureData,he=le.evaluatedColor[2],ue=le.evaluatedRMEA[2],de=this.id.canonical;if(le.hasTranslucentParts=!1,ce){for(let ce=0;ce<lw.length;ce++){const he=lw[ce];he.length&&(te.properties.part=he);const ue=C.paint.get("model-color").evaluate(te,{},de),_e=C.paint.get("model-color-mix-intensity").evaluate(te,{},de);le.evaluatedColor[ce]=[ue.r,ue.g,ue.b,_e],le.evaluatedRMEA[ce][0]=C.paint.get("model-roughness").evaluate(te,{},de),le.evaluatedRMEA[ce][2]=C.paint.get("model-emissive-strength").evaluate(te,{},de),le.evaluatedRMEA[ce][3]=ue.a,le.emissionHeightBasedParams[ce]=C.paint.get("model-height-based-emissive-strength-multiplier").evaluate(te,{},de),!le.hasTranslucentParts&&ue.a<1&&(le.hasTranslucentParts=!0)}delete te.properties.part,Hv(le,he!==le.evaluatedColor[2]||ue!==le.evaluatedRMEA[2])}le.evaluatedScale=C.paint.get("model-scale").evaluate(te,{},de),this.updatePbrBuffer(le.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(C,te,le,ce){const he=C.findDEMTileFor(le);if(he&&(he.tileID.canonical!==this.terrainTile||te!==this.terrainExaggeration)){if(he.dem&&he.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=he.tileID.overscaledZ;const te=Jm.create(C,le,he);if(!te)return;4&this.modelTraits&&this.updateDEM(C,te,le,ce);for(const C of this.getNodesInfo()){const le=C.node;if(!le.footprint||!le.footprint.vertices||!le.footprint.vertices.length)continue;const ce=le.footprint.vertices;let he=te.getElevationAt(ce[0].x,ce[0].y,!0,!0);for(let C=1;C<ce.length;C++)he=Math.min(he,te.getElevationAt(ce[C].x,ce[C].y,!0,!0));le.elevation=he}}this.terrainTile=he.tileID.canonical,this.terrainExaggeration=te}}updateDEM(C,te,le,ce){let he=te._dem._modifiedForSources[ce];if(void 0===he&&(te._dem._modifiedForSources[ce]=[],he=te._dem._modifiedForSources[ce]),he.includes(le.canonical))return;const ue=te._dem.dim;he.push(le.canonical);let de=!1;for(const C of this.getNodesInfo()){const le=C.node;if(!le.footprint||!le.footprint.grid)continue;const ce=le.footprint.grid,he=te.tileCoordToPixel(ce.min.x,ce.min.y),_e=te.tileCoordToPixel(ce.max.x,ce.max.y),ye=Math.min(Math.min(ue-_e.y,he.x),Math.min(he.y,ue-_e.x));if(ye<0)continue;const ve=z(ye,2,5);let Se=Math.max(0,he.x-ve),Me=Math.max(0,he.y-ve),Ae=Math.min(_e.x+ve,ue-1),Ce=Math.min(_e.y+ve,ue-1);for(let C=Me;C<=Ce;++C)for(let te=Se;te<=Ae;++te)nw[C*ue+te]=255;let Oe=0,Ne=0;for(let C=0;C<ce.cellsY;++C)for(let le=0;le<ce.cellsX;++le){if(!ce.cells[C*ce.cellsX+le])continue;const he=te.tileCoordToPixel(ce.min.x+le/ce.xScale,ce.min.y+C/ce.yScale),de=te.tileCoordToPixel(ce.min.x+(le+1)/ce.xScale,ce.min.y+(C+1)/ce.yScale);for(let C=he.y;C<=Math.min(de.y+1,ue-1);++C)for(let le=he.x;le<=Math.min(de.x+1,ue-1);++le)255===nw[C*ue+le]&&(nw[C*ue+le]=0,Oe+=te.getElevationAtPixel(le,C),Ne++)}const je=Oe/Ne;Se=Math.max(1,he.x-ve),Me=Math.max(1,he.y-ve),Ae=Math.min(_e.x+ve,ue-2),Ce=Math.min(_e.y+ve,ue-2),de=!0;for(let C=Me;C<=Ce;++C)for(let le=Se;le<=Ae;++le)0===nw[C*ue+le]&&(rw[C*ue+le]=te._dem.set(le,C,je));for(let C=1;C<ve;++C){Se=Math.max(1,he.x-C),Me=Math.max(1,he.y-C),Ae=Math.min(_e.x+C,ue-2),Ce=Math.min(_e.y+C,ue-2);for(let le=Me;le<=Ce;++le)for(let ce=Se;ce<=Ae;++ce){const he=le*ue+ce;if(255===nw[he]){let de=0,_e=0,ye=-1,Se=-1;for(let te=-1;te<=1;++te)for(let he=-1;he<=1;++he){const ve=(le+te)*ue+ce+he;if(nw[ve]>=C)continue;const Me=rw[ve],Ae=Math.abs(Me);Ae>_e&&(de=Me,_e=Ae,ye=he,Se=te)}if(_e>.1){const ue=1-(C+.5*Math.abs(ye*Se))/ve;let _e=te._dem.get(ce,le)+de*ue;const Me=te._dem.get(ce+ye,le+Se),Ae=te._dem.get(ce-ye,le-Se,!0);(_e-Me)*(_e-Ae)>0&&(_e=(Me+Ae)/2),rw[he]=te._dem.set(ce,le,_e),nw[he]=C}}}}}de&&(te._demTile.needsDEMTextureUpload=!0,te._dem._timestamp=bi.now())}getNodesInfo(){if(!this.nodesInfo){this.nodesInfo=[];for(const C of this.nodes)this.nodesInfo.push(new qv(C));this.freeNodes()}return this.nodesInfo}freeNodes(){if(this.nodes){for(const C of this.nodes)Lv(C);this.nodes.splice(0,this.nodes.length)}}destroy(){this.freeNodes();const C=this.getNodesInfo();for(const te of C)Rv(te.node),Lv(te.node)}isEmpty(){return!this.nodes.length}updateReplacement(C,te){if(te.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=te.updateTime;const le=te.getReplacementRegionsForTile(C.toUnwrapped()),ce=this.getNodesInfo();for(let C=0;C<this.nodesInfo.length;C++){const te=ce[C].node;ce[C].hiddenByReplacement=!!te.footprint&&!le.find((C=>C.footprint===te.footprint))}}getHeightAtTileCoord(C,te){const le=this.getNodesInfo(),ce=[];for(let he=0;he<this.nodesInfo.length;he++){const ue=le[he],de=ue.node.meshes[0];if(C<de.aabb.min[0]||te<de.aabb.min[1]||C>de.aabb.max[0]||te>de.aabb.max[1])continue;const _e=(C-de.aabb.min[0])/(de.aabb.max[0]-de.aabb.min[0])*Xb|0,ye=Math.min(63,(te-de.aabb.min[1])/(de.aabb.max[1]-de.aabb.min[1])*Xb|0)*Xb+Math.min(63,_e);if(!(de.heightmap[ye]<0&&ue.node.footprint)){if(ue.hiddenByReplacement)return;return{height:de.heightmap[ye],maxHeight:ue.feature.properties.height,hidden:!1,verticalScale:ue.evaluatedScale[2]}}if(ue.node.footprint.grid.query(new je(C,te),new je(C,te),ce),ce.length>0)return{height:void 0,maxHeight:ue.feature.properties.height,hidden:ue.hiddenByReplacement,verticalScale:ue.evaluatedScale[2]}}}}function $v(C,te){return!C.isLightConstant&&te}function Wv(C,te,le,ce,he,ue,de,_e){let ye=(61440&te|(61440&te)>>4)>>8,ve=(3840&te|(3840&te)>>4)>>4,Se=240&te|(240&te)>>4;le[3]>0&&(ye=Kr(ye,255*le[0],le[3]),ve=Kr(ve,255*le[1],le[3]),Se=Kr(Se,255*le[2],le[3]));const Me=ye<<8|ve,Ae=Se<<8|Math.floor(255*ce[3]),Ce=function(C){const te=z(C,0,2);return Math.min(Math.round(.5*te*255),255)}(ce[2])<<8|15*ce[0]<<4|15*ce[1],Oe=z(he[0],0,1),Ne=z(he[1],0,1),je=z(he[2],0,1),Ge=z(he[3],0,1);let Ze,qe,$e,He;if(Oe!==Ne&&de!==ue&&Ne!==Oe){const C=de-ue;qe=1/(C*(Ne-Oe)),$e=-(ue+C*Oe)/(C*(Ne-Oe));const te=z(he[4],-1,1);He=Math.pow(10,te),Ze=255*je<<8|255*Ge}else Ze=65535,qe=0,$e=1,He=1;if(C.emplaceBack(Me,Ae,Ce,Ze,qe,$e,He),_e){const C=_e.length;_e.clear();for(let te=0;te<C;te++)_e.emplaceBack(Me,Ae,Ce,Ze,qe,$e,He)}}function Hv(C,te){const le=C.node;let ce=0;for(const he of le.meshes){if(le.lights&&le.lightMeshIndex===ce)continue;if(!he.featureData)continue;he.featureArray=new nl,he.featureArray.reserve(he.featureData.length);let ue=te;for(const te of he.featureData){let ce;const de=65535&te,_e=(15&de)<8?15&de:0,ye=te>>16&65535,ve=C.evaluatedRMEA[_e],Se=C.evaluatedColor[_e],Me=C.emissionHeightBasedParams[_e];if(ue&&2===_e&&le.lights&&(ce=new nl,ce.resize(10*le.lights.length)),Wv(he.featureArray,ye,Se,ve,Me,he.aabb.min[2],he.aabb.max[2],ce),ce&&ue){ue=!1;const C=le.meshes[le.lightMeshIndex];C.featureArray=ce,C.featureArray._trim()}}he.featureArray._trim(),ce++}}Rs(Zv,"Tiled3dModelBucket",{omit:["layers"]}),Rs(qv,"Tiled3dModelFeature");class Xv{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[]}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(C){const te=Qv(new je(0,0),new je(Mn,Mn),C),le=[];for(const ce of this._activeRegions){if(ce.hiddenByOverlap)continue;if(!Jv(te,ce))continue;const he=eb(ce.min,ce.max,C);le.push({min:he.min,max:he.max,sourceId:this._sourceIds[ce.priority],footprint:ce.footprint,footprintTileId:ce.tileId})}return le}setSources(C){this._setSources(C.map((C=>({getSourceId:()=>C.cache.id,getFootprints:()=>{const te=[];for(const le of C.cache.getVisibleCoordinates()){const ce=C.cache.getTile(le).buckets[C.layer];if(ce)for(const C of ce.getNodesInfo()){const ce=C.node;ce.footprint&&te.push({footprint:ce.footprint,id:le.toUnwrapped()})}}return te}}))))}_addSource(C){const te=C.getFootprints();if(0!==te.length){for(const C of te){if(!C.footprint)continue;const te=Qv(C.footprint.min,C.footprint.max,C.id);this._activeRegions.push({min:te.min,max:te.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:C.id,footprint:C.footprint})}this._sourceIds.push(C.getSourceId())}}_computeReplacement(){this._activeRegions.sort(((C,te)=>C.priority-te.priority||Yv(C.min,te.min)||Yv(C.max,te.max)));let C=this._activeRegions.length!==this._prevRegions.length;if(!C){let te=0,le=0;for(;!C&&te!==this._activeRegions.length;){const ce=this._activeRegions[te],he=this._prevRegions[le];C=ce.priority!==he.priority||!Kv(ce,he),++te,++le}}if(C){++this._updateTime;const e=C=>{const te=this._activeRegions;if(C>=te.length)return C;const le=te[C].priority;for(;C<te.length&&te[C].priority===le;)++C;return C};if(this._sourceIds.length>1){let C=0,te=e(C);for(;C!==te;){let le=C;const ce=C;for(;le!==te;){const C=this._activeRegions[le];C.hiddenByOverlap=!1;for(let te=0;te<ce;te++){const le=this._activeRegions[te];if(!le.hiddenByOverlap&&Jv(C,le)&&(C.hiddenByOverlap=ib(C.footprint,C.tileId,le.footprint,le.tileId),C.hiddenByOverlap))break}++le}C=te,te=e(C)}}}}_setSources(C){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let te=C.length-1;te>=0;te--)this._addSource(C[te]);this._computeReplacement()}}function Yv(C,te){return C.x-te.x||C.y-te.y}function Kv(C,te){return 0===Yv(C.min,te.min)&&0===Yv(C.max,te.max)}function Jv(C,te){return!(C.min.x>te.max.x||C.max.x<te.min.x||C.min.y>te.max.y||C.max.y<te.min.y)}function Qv(C,te,le){const ce=1/Mn,he=1/(1<<le.canonical.z),ue=(te.x*ce+le.canonical.x)*he+le.wrap,de=(te.y*ce+le.canonical.y)*he;return{min:new je((C.x*ce+le.canonical.x)*he+le.wrap,(C.y*ce+le.canonical.y)*he),max:new je(ue,de)}}function eb(C,te,le){const ce=1<<le.canonical.z,he=((te.x-le.wrap)*ce-le.canonical.x)*Mn,ue=(te.y*ce-le.canonical.y)*Mn;return{min:new je(((C.x-le.wrap)*ce-le.canonical.x)*Mn,(C.y*ce-le.canonical.y)*Mn),max:new je(he,ue)}}function tb(C,te,le,ce,he,ue,de){const _e=C.indices,ye=C.vertices,ve=[];for(let Se=ce;Se<ce+he;Se+=3){const ce=te[le[Se+0]+ue],he=te[le[Se+1]+ue],Me=te[le[Se+2]+ue],Ae=Math.min(ce.x,he.x,Me.x),Ce=Math.max(ce.x,he.x,Me.x),Oe=Math.min(ce.y,he.y,Me.y),Ne=Math.max(ce.y,he.y,Me.y);ve.length=0,C.grid.query(new je(Ae,Oe),new je(Ce,Ne),ve);for(let C=0;C<ve.length;C++){const te=ve[C];if(Lp(ye[_e[3*te+0]],ye[_e[3*te+1]],ye[_e[3*te+2]],ce,he,Me,de))return!0}}return!1}function ib(C,te,le,ce){if(!C||!le)return!1;let he=C.vertices;if(!te.canonical.equals(ce.canonical)||te.wrap!==ce.wrap){if(le.vertices.length<C.vertices.length)return ib(le,ce,C,te);const ue=te.canonical,de=ce.canonical,_e=Math.pow(2,de.z-ue.z);he=C.vertices.map((C=>new je(C.x*ue.x*Mn*_e-de.x*Mn,C.y*ue.y*Mn*_e-de.y*Mn)))}return tb(le,he,C.indices,0,C.indices.length,0,0)}const hw=y_.types,uw=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius"],dw=["fill-extrusion-flood-light-ground-radius"],pw=Math.pow(2,13),fw=Math.pow(2,15)-1,xw=new je(0,1),Sw=2147483648;function hb(C,te,le,ce,he,ue,de,_e){C.emplaceBack((te<<1)+de,(le<<1)+ue,(Math.floor(ce*pw)<<1)+he,Math.round(_e))}function ub(C,te,le,ce,he,ue){C.emplaceBack(te.x,te.y,(le.x<<1)+ce,(le.y<<1)+he,ue)}function db(C,te,le){const ce=16384;C.emplaceBack(te.x,te.y,te.z,le[0]*ce,le[1]*ce,le[2]*ce)}class pb{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class fb{constructor(){this.centroidXY=new je(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new je(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new je(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new je(this.max.x-this.min.x,this.max.y-this.min.y)}}class mb{constructor(){this.acc=new je(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(C,te){C.min.x===Number.MAX_VALUE&&(C.min.x=C.max.x=te.x,C.min.y=C.max.y=te.y)}appendEdge(C,te,le){this.accCount++,this.acc._add(te);let ce=!!this.borders;te.x<C.min.x?(C.min.x=te.x,ce=!0):te.x>C.max.x&&(C.max.x=te.x,ce=!0),te.y<C.min.y?(C.min.y=te.y,ce=!0):te.y>C.max.y&&(C.max.y=te.y,ce=!0),((0===te.x||te.x===Mn)&&te.x===le.x)!=((0===te.y||te.y===Mn)&&te.y===le.y)&&this.processBorderOverlap(te,le),ce&&this.checkBorderIntersection(te,le)}checkBorderIntersection(C,te){te.x<0!=C.x<0&&this.addBorderIntersection(0,Kr(te.y,C.y,(0-te.x)/(C.x-te.x))),te.x>Mn!=C.x>Mn&&this.addBorderIntersection(1,Kr(te.y,C.y,(Mn-te.x)/(C.x-te.x))),te.y<0!=C.y<0&&this.addBorderIntersection(2,Kr(te.x,C.x,(0-te.y)/(C.y-te.y))),te.y>Mn!=C.y>Mn&&this.addBorderIntersection(3,Kr(te.x,C.x,(Mn-te.y)/(C.y-te.y)))}addBorderIntersection(C,te){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const le=this.borders[C];te<le[0]&&(le[0]=te),te>le[1]&&(le[1]=te)}processBorderOverlap(C,te){if(C.x===te.x){if(C.y===te.y)return;const le=0===C.x?0:1;this.addBorderIntersection(le,te.y),this.addBorderIntersection(le,C.y)}else{const le=0===C.y?2:3;this.addBorderIntersection(le,te.x),this.addBorderIntersection(le,C.x)}}centroid(){return 0===this.accCount?new je(0,0):new je(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce(((C,te)=>C+ +(te[0]!==Number.MAX_VALUE)),0):0}}function _b(C,te){const le=C.add(te)._unit(),ce=z(C.x*le.x+C.y*le.y,-1,1);var he,ue,de;return he=Math.acos(ce),Math.min(4,Math.max(-4,Math.tan(he)))/4*fw*((ue=C).x*(de=te).y-ue.y*de.x<0?-1:1)}const Aw=[C=>C.x<0,C=>C.x>Mn,C=>C.y<0,C=>C.y>Mn];function yb(C,te,le,ce){const he=[4];if(0===ce)return he;le._mult(ce);const ue=C.sub(le),de=te.sub(le),_e=[C,te,ue,de];for(let C=0;C<4;C++)for(const te of _e)if(Aw[C](te)){he.push(C);break}return he}class xb{constructor(C){this.vertexArray=new Ra,this.indexArray=new Wa,this.programConfigurations=new ec(C.layers,C.zoom,(C=>dw.includes(C))),this._segments=new xl,this.hiddenByLandmarkVertexArray=new ol,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new xl}getDefaultSegment(){return this.regionSegments[4]}hasData(){return 0!==this.vertexArray.length}addData(C,te,le,ce=!1){const he=C.length;if(he>2){let ue=Math.max(0,this._segments.get().length-1);const de=this._segments._prepareSegment(4*he,this.vertexArray.length,2*this._segmentToGroundQuads[ue].length);let _e;ue!==this._segments.get().length-1&&(ue++,this._segmentToGroundQuads[ue]=[],this._segmentToRegionTriCounts[ue]=[0,0,0,0,0]);{const te=C[0],le=C[1];_e=_b(te.sub(C[he-1])._perp()._unit(),le.sub(te)._perp()._unit())}for(let ye=0;ye<he;ye++){const ve=ye===he-1?0:ye+1,Se=C[ye],Me=C[ve],Ae=C[ve===he-1?0:ve+1],Ce=Me.sub(Se)._perp()._unit(),Oe=_b(Ce,Ae.sub(Me)._perp()._unit()),Ne=_e,je=Oe;if(Eb(Se,Me,te)||ce&&Mb(Se,te)&&Mb(Me,te)){_e=Oe;continue}const Ge=de.vertexLength;ub(this.vertexArray,Se,Me,1,1,Ne),ub(this.vertexArray,Se,Me,1,0,Ne),ub(this.vertexArray,Se,Me,0,1,je),ub(this.vertexArray,Se,Me,0,0,je),de.vertexLength+=4;const Ze=yb(Se,Me,Ce,le);for(const C of Ze)this._segmentToGroundQuads[ue].push({id:Ge,region:C}),this._segmentToRegionTriCounts[ue][C]+=2,de.primitiveLength+=2;_e=Oe}}}prepareBorderSegments(){if(!this.hasData())return;const C=this._segments.get(),te=C.length;for(let C=0;C<te;C++)this._segmentToGroundQuads[C].sort(((C,te)=>C.region-te.region));for(let le=0;le<te;le++){const te=this._segmentToGroundQuads[le],ce=C[le],he=this._segmentToRegionTriCounts[le];he.reduce(((C,te)=>C+te),0);let ue=0;for(let C=0;C<=4;C++){const te=he[C];if(0!==te){let le=this.regionSegments[C];le||(le=this.regionSegments[C]=new xl);const he={vertexOffset:ce.vertexOffset,primitiveOffset:ce.primitiveOffset+ue,vertexLength:ce.vertexLength,primitiveLength:te};le.get().push(he)}ue+=te}for(let C=0;C<te.length;C++){const le=te[C].id;this.indexArray.emplaceBack(le,le+1,le+3),this.indexArray.emplaceBack(le,le+3,le+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(C,te,le,ce,he,ue){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,C,te,le,ce,he,ue)}upload(C){this.hasData()&&(this.vertexBuffer=C.createVertexBuffer(this.vertexArray,i_.members),this.indexBuffer=C.createIndexBuffer(this.indexArray))}uploadPaintProperties(C){this.hasData()&&this.programConfigurations.upload(C)}update(C,te,le,ce,he,ue){this.hasData()&&this.programConfigurations.updatePaintArrays(C,te,le,ce,he,ue)}updateHiddenByLandmark(C){if(!this.hasData())return;const te=C.groundVertexCount+C.groundVertexArrayOffset;if(0===C.groundVertexCount)return;const le=C.flags&Sw?1:0;for(let ce=C.groundVertexArrayOffset;ce<te;++ce)this.hiddenByLandmarkVertexArray.emplace(ce,le);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(C){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=C.createVertexBuffer(this.hiddenByLandmarkVertexArray,n_.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let C=0;C<=4;C++){const te=this.regionSegments[C];te&&te.destroy()}}}}class vb{constructor(C){this.zoom=C.zoom,this.canonical=C.canonical,this.overscaling=C.overscaling,this.layers=C.layers,this.layerIds=this.layers.map((C=>C.fqid)),this.index=C.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=C.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new Wa,this.footprintVertices=new za,this.footprintSegments=[],this.layoutVertexArray=new Da,this.centroidVertexArray=new _l,this.indexArray=new Wa,this.programConfigurations=new ec(C.layers,C.zoom,(C=>uw.includes(C))),this.segments=new xl,this.stateDependentLayerIds=this.layers.filter((C=>C.isStateDependent())).map((C=>C.id)),this.groundEffect=new xb(C),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}populate(C,te,le,ce){this.features=[],this.hasPattern=Uf("fill-extrusion",this.layers,te),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.tileToMeter=ap(le),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter;for(const{feature:he,id:ue,index:de,sourceLayerIndex:_e}of C){const C=this.layers[0]._featureFilter.needGeometry,ye=gp(he,C);if(!this.layers[0]._featureFilter.filter(new oa(this.zoom),ye,le))continue;const ve={id:ue,sourceLayerIndex:_e,index:de,geometry:C?ye.geometry:_p(he,le,ce),properties:he.properties,type:he.type,patterns:{}},Se=this.layoutVertexArray.length;this.hasPattern?this.features.push(Vf("fill-extrusion",this.layers,ve,this.zoom,te)):this.addFeature(ve,ve.geometry,de,le,{},te.availableImages,ce,te.brightness),te.featureIndex.insert(he,ve.geometry,de,_e,this.index,Se)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(C,te,le,ce,he,ue){for(const C of this.features){const{geometry:de}=C;this.addFeature(C,de,C.index,te,le,ce,he,ue)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles()}update(C,te,le,ce,he){const ue=0!==Object.keys(C).length;if(ue&&!this.stateDependentLayers.length)return;const de=ue?this.stateDependentLayers:this.layers;this.programConfigurations.updatePaintArrays(C,te,de,le,ce,he),this.groundEffect.update(C,te,de,le,ce,he)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(C){this.uploaded||(this.layoutVertexBuffer=C.createVertexBuffer(this.layoutVertexArray,s_),this.indexBuffer=C.createIndexBuffer(this.indexArray),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=C.createVertexBuffer(this.layoutVertexExtArray,o_.members,!0)),this.groundEffect.upload(C)),this.groundEffect.uploadPaintProperties(C),this.programConfigurations.upload(C),this.uploaded=!0}uploadCentroid(C){this.groundEffect.uploadHiddenByLandmark(C),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=C.createVertexBuffer(this.centroidVertexArray,r_.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(C,te,le,ce,he,ue,de,_e){const ye=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(C,{})/this.tileToMeter,ve=[new je(0,0),new je(Mn,Mn)],Se=de.projection,Me="globe"===Se.name,Ae="Polygon"===hw[C.type],Ce=new mb;Ce.centroidDataIndex=this.centroidData.length;const Oe=new fb,Ne=this.layers[0].paint.get("fill-extrusion-base").evaluate(C,{},ce)<=0,Ge=this.layers[0].paint.get("fill-extrusion-height").evaluate(C,{},ce);Oe.height=Ge,Oe.vertexArrayOffset=this.layoutVertexArray.length,Oe.groundVertexArrayOffset=this.groundEffect.vertexArray.length,Me&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Fa);const Ze=Ff(te,500);for(let C=Ze.length-1;C>=0;C--){const te=Ze[C];(0===te.length||(qe=te[0]).every((C=>C.x<=0))||qe.every((C=>C.x>=Mn))||qe.every((C=>C.y<=0))||qe.every((C=>C.y>=Mn)))&&Ze.splice(C,1)}var qe;let $e;if(Me)$e=Cb(Ze,ve,ce);else{$e=[];for(const C of Ze)$e.push({polygon:C,bounds:ve})}const He=Ae?this.edgeRadius:0,We=He>0&&this.zoom<17,T=(C,te)=>{if(0===C.length)return!1;const le=C[C.length-1];return te.x===le.x&&te.y===le.y};for(const{polygon:C,bounds:te}of $e){let le=0,he=0;for(const te of C)Ae&&!te[0].equals(te[te.length-1])&&te.push(te[0]),he+=Ae?te.length-1:te.length;const ue=this.segments.prepareSegment((Ae?5:4)*he,this.layoutVertexArray,this.indexArray);Oe.footprintSegIdx<0&&(Oe.footprintSegIdx=this.footprintSegments.length),Oe.polygonSegIdx<0&&(Oe.polygonSegIdx=this.polygonSegments.length);const de={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},_e=new pb;if(_e.vertexOffset=this.footprintVertices.length,_e.indexOffset=3*this.footprintIndices.length,_e.ringIndices=[],Ae){const he=[],de=[];le=ue.vertexLength;for(let le=0;le<C.length;le++){const ve=C[le];ve.length&&0!==le&&de.push(he.length/2);const Ae=[];let Ce,Oe;Ce=ve[1].sub(ve[0])._perp()._unit(),_e.ringIndices.push(ve.length-1);for(let C=1;C<ve.length;C++){const te=ve[C],le=ve[C===ve.length-1?1:C+1],de=te.clone();if(He){Oe=le.sub(te)._perp()._unit();const C=Ce.add(Oe)._unit(),ce=He*Math.min(4,1/(Ce.x*C.x+Ce.y*C.y));de.x+=ce*C.x,de.y+=ce*C.y,de.x=Math.round(de.x),de.y=Math.round(de.y),Ce=Oe}!Ne||0!==He&&!We||T(Ae,de)||Ae.push(de),hb(this.layoutVertexArray,de.x,de.y,0,0,1,1,0),ue.vertexLength++,this.footprintVertices.emplaceBack(te.x,te.y),he.push(te.x,te.y),Me&&db(this.layoutVertexExtArray,Se.projectTilePoint(de.x,de.y,ce),Se.upVector(ce,de.x,de.y))}Ne&&(0===He||We)&&(0!==Ae.length&&T(Ae,Ae[0])&&Ae.pop(),this.groundEffect.addData(Ae,te,ye))}const ve=xm(he,de);for(let C=0;C<ve.length;C+=3)this.footprintIndices.emplaceBack(_e.vertexOffset+ve[C+0],_e.vertexOffset+ve[C+1],_e.vertexOffset+ve[C+2]),this.indexArray.emplaceBack(le+ve[C],le+ve[C+2],le+ve[C+1]),ue.primitiveLength++;_e.indexCount+=ve.length,_e.vertexCount+=this.footprintVertices.length-_e.vertexOffset}for(let he=0;he<C.length;he++){const de=C[he];Ce.startRing(Oe,de[0]);let _e=de.length>4&&Ab(de[de.length-2],de[0],de[1]),ve=He?wb(de[de.length-2],de[0],de[1],He):0;const je=[];let Ge,Ze,qe;Ze=de[1].sub(de[0])._perp()._unit();let $e=!0;for(let C=1,he=0;C<de.length;C++){let ye=de[C-1],Ae=de[C];const We=de[C===de.length-1?1:C+1];if(Ce.appendEdge(Oe,Ae,ye),Eb(Ae,ye,te)){He&&(Ze=We.sub(Ae)._perp()._unit(),$e=!$e);continue}const Xe=Ae.sub(ye)._perp(),Ye=Xe.x/(Math.abs(Xe.x)+Math.abs(Xe.y)),Je=Xe.y>0?1:0,Qe=ye.dist(Ae);if(he+Qe>32768&&(he=0),He){qe=We.sub(Ae)._perp()._unit();let C=Tb(ye,Ae,We,bb(Ze,qe),He);isNaN(C)&&(C=0);const te=Ae.sub(ye)._unit();ye=ye.add(te.mult(ve))._round(),Ae=Ae.add(te.mult(-C))._round(),ve=C,Ze=qe,Ne&&this.zoom>=17&&(T(je,ye)||je.push(ye),T(je,Ae)||je.push(Ae))}const tt=ue.vertexLength,rt=de.length>4&&Ab(ye,Ae,We);let ot=Sb(he,_e,$e);if(hb(this.layoutVertexArray,ye.x,ye.y,Ye,Je,0,0,ot),hb(this.layoutVertexArray,ye.x,ye.y,Ye,Je,0,1,ot),he+=Qe,ot=Sb(he,rt,!$e),_e=rt,hb(this.layoutVertexArray,Ae.x,Ae.y,Ye,Je,0,0,ot),hb(this.layoutVertexArray,Ae.x,Ae.y,Ye,Je,0,1,ot),ue.vertexLength+=4,this.indexArray.emplaceBack(tt+0,tt+1,tt+2),this.indexArray.emplaceBack(tt+1,tt+3,tt+2),ue.primitiveLength+=2,He){const ce=le+(1===C?de.length-2:C-2),he=1===C?le:ce+1;if(this.indexArray.emplaceBack(tt+1,ce,tt+3),this.indexArray.emplaceBack(ce,he,tt+3),ue.primitiveLength+=2,void 0===Ge&&(Ge=tt),!Eb(We,de[C],te)){const te=C===de.length-1?Ge:ue.vertexLength;this.indexArray.emplaceBack(tt+2,tt+3,te),this.indexArray.emplaceBack(tt+3,te+1,te),this.indexArray.emplaceBack(tt+3,he,te+1),ue.primitiveLength+=3}$e=!$e}if(Me){const C=this.layoutVertexExtArray,te=Se.projectTilePoint(ye.x,ye.y,ce),le=Se.projectTilePoint(Ae.x,Ae.y,ce),he=Se.upVector(ce,ye.x,ye.y),ue=Se.upVector(ce,Ae.x,Ae.y);db(C,te,he),db(C,te,he),db(C,le,ue),db(C,le,ue)}}Ae&&(le+=de.length-1),Ne&&He&&this.zoom>=17&&(0!==je.length&&T(je,je[0])&&je.pop(),this.groundEffect.addData(je,te,ye,He>0))}this.footprintSegments.push(_e),de.triangleCount=this.indexArray.length-de.triangleArrayOffset,this.polygonSegments.push(de),++Oe.footprintSegLen,++Oe.polygonSegLen}if(Oe.vertexCount=this.layoutVertexArray.length-Oe.vertexArrayOffset,Oe.groundVertexCount=this.groundEffect.vertexArray.length-Oe.groundVertexArrayOffset,0!==Oe.vertexCount){if(Oe.centroidXY=Ce.borders?xw:this.encodeCentroid(Ce,Oe),this.centroidData.push(Oe),Ce.borders){this.featuresOnBorder.push(Ce);const C=this.featuresOnBorder.length-1;for(let te=0;te<Ce.borders.length;te++)Ce.borders[te][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[te].push(C)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,C,le,he,ue,ce,_e),this.groundEffect.addPaintPropertiesData(C,le,he,ue,ce,_e),this.maxHeight=Math.max(this.maxHeight,Ge)}}sortBorders(){for(let C=0;C<this.borderFeatureIndices.length;C++)this.borderFeatureIndices[C].sort(((te,le)=>this.featuresOnBorder[te].borders[C][0]-this.featuresOnBorder[le].borders[C][0]))}splitToSubtiles(){const C=[];for(let te=0;te<this.centroidData.length;te++){const le=this.centroidData[te],ce=+(le.min.y+le.max.y>Mn),he=2*ce+(+(le.min.x+le.max.x>Mn)^ce);for(let ce=0;ce<le.polygonSegLen;ce++){const ue=le.polygonSegIdx+ce;C.push({centroidIdx:te,subtile:he,polygonSegmentIdx:ue,triangleSegmentIdx:this.polygonSegments[ue].triangleSegIdx})}}const te=new Wa;C.sort(((C,te)=>C.triangleSegmentIdx===te.triangleSegmentIdx?C.subtile-te.subtile:C.triangleSegmentIdx-te.triangleSegmentIdx));let le=0,ce=0,he=0;for(const te of C){if(te.triangleSegmentIdx!==le)break;he++}const ue=C.length;for(;ce!==C.length;){le=C[ce].triangleSegmentIdx;let de=0,_e=ce,ye=ce;for(let te=_e;te<he&&C[te].subtile===de;te++)ye++;for(;_e!==he;){const ce=C[_e];de=ce.subtile;const ue=this.centroidData[ce.centroidIdx].min.clone(),ve=this.centroidData[ce.centroidIdx].max.clone(),Se={vertexOffset:this.segments.segments[le].vertexOffset,primitiveOffset:te.length,vertexLength:this.segments.segments[le].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let le=_e;le<ye;le++){const ce=C[le],he=this.polygonSegments[ce.polygonSegmentIdx],de=this.centroidData[ce.centroidIdx].min,_e=this.centroidData[ce.centroidIdx].max,ye=this.indexArray.uint16;for(let C=he.triangleArrayOffset;C<he.triangleArrayOffset+he.triangleCount;C++)te.emplaceBack(ye[3*C],ye[3*C+1],ye[3*C+2]);Se.primitiveLength+=he.triangleCount,ue.x=Math.min(ue.x,de.x),ue.y=Math.min(ue.y,de.y),ve.x=Math.max(ve.x,_e.x),ve.y=Math.max(ve.y,_e.y)}Se.primitiveLength>0&&this.triangleSubSegments.push({segment:Se,min:ue,max:ve}),_e=ye;for(let te=_e;te<he&&C[te].subtile===C[_e].subtile;te++)ye++}ce=he;for(let te=ce;te<ue&&C[te].triangleSegmentIdx===C[ce].triangleSegmentIdx;te++)he++}te._trim(),this.indexArray=te}getVisibleSegments(C,te,le){let ce=0,he=0;const ue=1<<C.canonical.z;if(te){const le=te.getMinMaxForTile(C);le&&(ce=le.min,he=le.max)}he+=this.maxHeight;const de=C.toUnwrapped();let _e;const ye=[de.canonical.x/ue+de.wrap,de.canonical.y/ue],ve=[(de.canonical.x+1)/ue+de.wrap,(de.canonical.y+1)/ue],Se=new xl,u=(C,te,le)=>[C[0]*(1-le[0])+te[0]*le[0],C[1]*(1-le[1])+te[1]*le[1]],Me=[],Ae=[];for(const C of this.triangleSubSegments){Me[0]=C.min.x/Mn,Me[1]=C.min.y/Mn,Ae[0]=C.max.x/Mn,Ae[1]=C.max.y/Mn;const te=u(ye,ve,Me),ue=u(ye,ve,Ae);if(0===new ed([te[0],te[1],ce],[ue[0],ue[1],he]).intersectsPrecise(le)){_e&&(Se.segments.push(_e),_e=void 0);continue}const de=C.segment;_e&&_e.vertexOffset!==de.vertexOffset&&(Se.segments.push(_e),_e=void 0),_e?(_e.vertexLength+=de.vertexLength,_e.primitiveLength+=de.primitiveLength):_e={vertexOffset:de.vertexOffset,primitiveLength:de.primitiveLength,vertexLength:de.vertexLength,primitiveOffset:de.primitiveOffset,sortKey:void 0,vaos:{}}}return _e&&Se.segments.push(_e),Se}encodeCentroid(C,te){const le=C.centroid(),ce=te.span(),he=Math.min(7,Math.round(ce.x*this.tileToMeter/10)),ue=Math.min(7,Math.round(ce.y*this.tileToMeter/10));return new je(z(le.x,1,Mn-1)<<3|he,z(le.y,1,Mn-1)<<3|ue)}showCentroid(C){const te=this.centroidData[C.centroidDataIndex];te.flags&=Sw,te.centroidXY.x=0,te.centroidXY.y=0,this.writeCentroidToBuffer(te)}writeCentroidToBuffer(C){this.groundEffect.updateHiddenByLandmark(C);const te=C.vertexArrayOffset,le=C.vertexCount+C.vertexArrayOffset,ce=C.flags&Sw?xw:C.centroidXY,he=this.centroidVertexArray.geta_centroid_pos0(te);if(this.centroidVertexArray.geta_centroid_pos1(te)!==ce.y||he!==ce.x){for(let C=te;C<le;++C)this.centroidVertexArray.emplace(C,ce.x,ce.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const C of this.centroidData)this.writeCentroidToBuffer(C)}updateReplacement(C,te){if(te.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=te.updateTime;const le=te.getReplacementRegionsForTile(C.toUnwrapped());if(function(C,te){if(C.length!==te.length)return!1;for(let le=0;le<C.length;le++)if(C[le].sourceId!==te[le].sourceId||!Kv(C[le],te[le]))return!1;return!0}(this.activeReplacements,le))return;if(this.activeReplacements=le,0===this.centroidVertexArray.length)this.createCentroidsBuffer();else for(const C of this.centroidData)C.flags&=2147483647;const ce=[];for(const te of this.activeReplacements){const le=Math.pow(2,te.footprintTileId.canonical.z-C.canonical.z);for(const he of this.centroidData)if(!(he.flags&Sw||te.min.x>he.max.x||he.min.x>te.max.x||te.min.y>he.max.y||he.min.y>te.max.y))for(let ue=0;ue<he.footprintSegLen;ue++){const de=this.footprintSegments[he.footprintSegIdx+ue];if(ce.length=0,zb(this.footprintVertices,de.vertexOffset,de.vertexCount,te.footprintTileId.canonical,C.canonical,ce),tb(te.footprint,ce,this.footprintIndices.uint16,de.indexOffset,de.indexCount,-de.vertexOffset,-le)){he.flags|=Sw;break}}}for(const C of this.centroidData)this.writeCentroidToBuffer(C);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(C,te,le){let ce=!1;for(let he=0;he<le.footprintSegLen;he++){const ue=this.footprintSegments[le.footprintSegIdx+he];let de=0;for(const le of ue.ringIndices){for(let he=de,_e=le+de-1;he<le+de;_e=he++){const le=this.footprintVertices.int16[2*(he+ue.vertexOffset)+0],de=this.footprintVertices.int16[2*(he+ue.vertexOffset)+1],ye=this.footprintVertices.int16[2*(_e+ue.vertexOffset)+1];de>te!=ye>te&&C<(this.footprintVertices.int16[2*(_e+ue.vertexOffset)+0]-le)*(te-de)/(ye-de)+le&&(ce=!ce)}de=le}}return ce}getHeightAtTileCoord(C,te){let le=Number.NEGATIVE_INFINITY,ce=!0;const he=4*(C+Mn)*Mn+(te+Mn);if(this.partLookup.hasOwnProperty(he)){const C=this.partLookup[he];return C?{height:C.height,hidden:!!(C.flags&Sw)}:void 0}for(const ue of this.centroidData)C>ue.max.x||ue.min.x>C||te>ue.max.y||ue.min.y>te||this.footprintContainsPoint(C,te,ue)&&ue&&ue.height>le&&(le=ue.height,this.partLookup[he]=ue,ce=!!(ue.flags&Sw));if(le!==Number.NEGATIVE_INFINITY)return{height:le,hidden:ce};this.partLookup[he]=void 0}}function bb(C,te){const le=C.add(te)._unit();return C.x*le.x+C.y*le.y}function wb(C,te,le,ce){const he=te.sub(C)._perp()._unit(),ue=le.sub(te)._perp()._unit();return Tb(C,te,le,bb(he,ue),ce)}function Tb(C,te,le,ce,he){const ue=Math.sqrt(1-ce*ce);return Math.min(C.dist(te)/3,te.dist(le)/3,he*ue/ce)}function Eb(C,te,le){return C.x<le[0].x&&te.x<le[0].x||C.x>le[1].x&&te.x>le[1].x||C.y<le[0].y&&te.y<le[0].y||C.y>le[1].y&&te.y>le[1].y}function Mb(C,te){return C.x<te[0].x||C.x>te[1].x||C.y<te[0].y||C.y>te[1].y}function Ab(C,te,le){if(C.x<0||C.x>=Mn||te.x<0||te.x>=Mn||le.x<0||le.x>=Mn)return!1;const ce=le.sub(te),he=ce.perp(),ue=C.sub(te);return(ce.x*ue.x+ce.y*ue.y)/Math.sqrt((ce.x*ce.x+ce.y*ce.y)*(ue.x*ue.x+ue.y*ue.y))>-.866&&he.x*ue.x+he.y*ue.y<0}function Sb(C,te,le){const ce=te?2|C:-3&C;return le?1|ce:-2&ce}function Ib(){const C=Math.PI/32,te=Math.tan(C),le=Zf;return le*Math.sqrt(1+2*te*te)-le}function Cb(C,te,le){const ce=1<<le.z,he=ep(le.x/ce),ue=ep((le.x+1)/ce),de=tp(le.y/ce),_e=tp((le.y+1)/ce);return function(C,te,le,ce,he=0,ue){const de=[];if(!C.length||!le||!ce)return de;const a=(C,te)=>{for(const le of C)de.push({polygon:le,bounds:te})},_e=Math.ceil(Math.log2(le)),ye=Math.ceil(Math.log2(ce)),ve=_e-ye,Se=[];for(let C=0;C<Math.abs(ve);C++)Se.push(ve>0?0:1);for(let C=0;C<Math.min(_e,ye);C++)Se.push(0),Se.push(1);let Me=C;if(Me=um(Me,te[0].y-he,te[1].y+he,1),Me=um(Me,te[0].x-he,te[1].x+he,0),!Me.length)return de;const Ae=[];for(Se.length?Ae.push({polygons:Me,bounds:te,depth:0}):a(Me,te);Ae.length;){const C=Ae.pop(),te=C.depth,le=Se[te],ce=C.bounds[0],de=C.bounds[1],_e=0===le?ce.x:ce.y,ye=0===le?de.x:de.y,ve=ue?ue(le,_e,ye):.5*(_e+ye),Me=um(C.polygons,_e-he,ve+he,le),Ce=um(C.polygons,ve-he,ye+he,le);if(Me.length){const C=[ce,new je(0===le?ve:de.x,1===le?ve:de.y)];Se.length>te+1?Ae.push({polygons:Me,bounds:C,depth:te+1}):a(Me,C)}if(Ce.length){const C=[new je(0===le?ve:ce.x,1===le?ve:ce.y),de];Se.length>te+1?Ae.push({polygons:Ce,bounds:C,depth:te+1}):a(Ce,C)}}return de}(C,te,Math.ceil((ue-he)/11.25),Math.ceil((de-_e)/11.25),1,((C,te,he)=>{if(0===C)return.5*(te+he);{const C=tp((le.y+te/Mn)/ce);return(Jd(.5*(tp((le.y+he/Mn)/ce)+C))*ce-le.y)*Mn}}))}function zb(C,te,le,ce,he,ue){const de=Math.pow(2,ce.z-he.z);for(let _e=0;_e<le;_e++){let le=C.int16[2*(_e+te)+0],ye=C.int16[2*(_e+te)+1];le=(le+he.x*Mn)*de-ce.x*Mn,ye=(ye+he.y*Mn)*de-ce.y*Mn,ue.push(new je(le,ye))}}Rs(vb,"FillExtrusionBucket",{omit:["layers","features"]}),Rs(fb,"PartData"),Rs(pb,"FootprintSegment"),Rs(mb,"BorderCentroidData"),Rs(xb,"GroundEffect");const kw=new ga({visibility:new fa(zi["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new fa(zi["layout_fill-extrusion"]["fill-extrusion-edge-radius"])});var qw={paint:new ga({"fill-extrusion-opacity":new fa(zi["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new ma(zi["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new fa(zi["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new fa(zi["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new ma(zi["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new ma(zi["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new ma(zi["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new fa(zi["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new fa(zi["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new fa(zi["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new fa(zi["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new fa(zi["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new fa(zi["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new fa(zi["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new fa(zi["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new ma(zi["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new ma(zi["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new fa(zi["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new fa(zi["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new fa(zi["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new fa(zi["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new fa(zi["paint_fill-extrusion"]["fill-extrusion-emissive-strength"])}),layout:kw};class Rb extends je{constructor(C,te,le){super(C,te),this.z=le}}function Lb(C,te){return C.x*te.x+C.y*te.y}function kb(C,te){if(1===C.length){let le=0;const ce=te[le++];let he;for(;!he||ce.equals(he);)if(he=te[le++],!he)return 1/0;for(;le<te.length;le++){const ue=te[le],de=C[0],_e=he.sub(ce),ye=ue.sub(ce),ve=de.sub(ce),Se=Lb(_e,_e),Me=Lb(_e,ye),Ae=Lb(ye,ye),Ce=Lb(ve,_e),Oe=Lb(ve,ye),Ne=Se*Ae-Me*Me,je=(Ae*Ce-Me*Oe)/Ne,Ge=(Se*Oe-Me*Ce)/Ne,Ze=ce.z*(1-je-Ge)+he.z*je+ue.z*Ge;if(isFinite(Ze))return Ze}return 1/0}{let C=1/0;for(const le of te)C=Math.min(C,le.z);return C}}function Ob(C,te,le,ce,he,ue,de,_e){const ye=de*he.getElevationAt(C,te,!0,!0),ve=0!==ue[0],Se=ve?0===ue[1]?de*(ue[0]/7-450):de*function(C,te,le){const ce=Math.floor(te[0]/8),he=Math.floor(te[1]/8),ue=10*(te[0]-8*ce),de=10*(te[1]-8*he),_e=C.getElevationAt(ce,he,!0,!0),ye=C.getMeterToDEM(le),ve=Math.floor(.5*(ue*ye-1)),Se=Math.floor(.5*(de*ye-1)),Me=C.tileCoordToPixel(ce,he),Ae=2*ve+1,Ce=2*Se+1,Oe=function(C,te,le,ce,he){return[C.getElevationAtPixel(te,le,!0),C.getElevationAtPixel(te+he,le,!0),C.getElevationAtPixel(te,le+he,!0),C.getElevationAtPixel(te+ce,le+he,!0)]}(C,Me.x-ve,Me.y-Se,Ae,Ce),Ne=Math.abs(Oe[0]-Oe[1]),je=Math.abs(Oe[2]-Oe[3]),Ge=Math.abs(Oe[0]-Oe[2])+Math.abs(Oe[1]-Oe[3]),Ze=Math.min(.25,.5*ye*(Ne+je)/Ae),qe=Math.min(.25,.5*ye*Ge/Ce);return _e+Math.max(Ze*ue,qe*de)}(he,ue,_e):ye;return{base:ye+(0===le)?-1:le,top:ve?Math.max(Se+ce,ye+le+2):ye+ce}}const $w=new ga({"line-cap":new ma(zi.layout_line["line-cap"]),"line-join":new ma(zi.layout_line["line-join"]),"line-miter-limit":new fa(zi.layout_line["line-miter-limit"]),"line-round-limit":new fa(zi.layout_line["line-round-limit"]),"line-sort-key":new ma(zi.layout_line["line-sort-key"]),visibility:new fa(zi.layout_line.visibility)});var Hw={paint:new ga({"line-opacity":new ma(zi.paint_line["line-opacity"]),"line-color":new ma(zi.paint_line["line-color"]),"line-translate":new fa(zi.paint_line["line-translate"]),"line-translate-anchor":new fa(zi.paint_line["line-translate-anchor"]),"line-width":new ma(zi.paint_line["line-width"]),"line-gap-width":new ma(zi.paint_line["line-gap-width"]),"line-offset":new ma(zi.paint_line["line-offset"]),"line-blur":new ma(zi.paint_line["line-blur"]),"line-dasharray":new ma(zi.paint_line["line-dasharray"]),"line-pattern":new ma(zi.paint_line["line-pattern"]),"line-gradient":new _a(zi.paint_line["line-gradient"]),"line-trim-offset":new fa(zi.paint_line["line-trim-offset"]),"line-emissive-strength":new fa(zi.paint_line["line-emissive-strength"]),"line-border-width":new ma(zi.paint_line["line-border-width"]),"line-border-color":new ma(zi.paint_line["line-border-color"])}),layout:$w};const Nb=(C,te,le,ce,he,ue,de)=>{const _e=C.transform,ye=_e.calculatePixelsToTileUnitsMatrix(te);return{u_matrix:jb(C,te,le,ce),u_pixels_to_tile_units:ye,u_device_pixel_ratio:ue,u_units_to_pixels:[1/_e.pixelsToGLUnits[0],1/_e.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:he,u_texsize:qb(le)&&te.lineAtlasTexture?te.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:Vb(te,C.transform),u_alpha_discard_threshold:0,u_trim_offset:de,u_emissive_strength:le.paint.get("line-emissive-strength")}},Ub=(C,te,le,ce,he)=>{const ue=C.transform;return{u_matrix:jb(C,te,le,ce),u_texsize:te.imageAtlasTexture?te.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:ue.calculatePixelsToTileUnitsMatrix(te),u_device_pixel_ratio:he,u_image:0,u_tile_units_to_pixels:Vb(te,ue),u_units_to_pixels:[1/ue.pixelsToGLUnits[0],1/ue.pixelsToGLUnits[1]],u_alpha_discard_threshold:0}};function Vb(C,te){return 1/rv(C,1,te.tileZoom)}function jb(C,te,le,ce){return C.translatePosMatrix(ce||te.tileID.projMatrix,te,le.paint.get("line-translate"),le.paint.get("line-translate-anchor"))}const Gb=C=>{const te=[];qb(C)&&te.push("RENDER_LINE_DASH"),C.paint.get("line-gradient")&&te.push("RENDER_LINE_GRADIENT");const le=C.paint.get("line-trim-offset");return 0===le[0]&&0===le[1]||te.push("RENDER_LINE_TRIM_OFFSET"),0!==C.paint.get("line-border-width").constantOr(1)&&te.push("RENDER_LINE_BORDER"),te};function qb(C){const te=C.paint.get("line-dasharray").value;return te.value||"constant"!==te.kind}const Xw=new class extends ma{possiblyEvaluate(C,te){return te=new oa(Math.floor(te.zoom),{now:te.now,fadeDuration:te.fadeDuration,transition:te.transition}),super.possiblyEvaluate(C,te)}evaluate(C,te,le,ce){return te=k({},te,{zoom:Math.floor(te.zoom)}),super.evaluate(C,te,le,ce)}}(Hw.paint.properties["line-width"].specification);function $b(C,te){return te>0?te+2*C:C}Xw.useIntegerZoom=!0;const Kw=new ga({visibility:new fa(zi.layout_background.visibility)});var Yw={paint:new ga({"background-color":new fa(zi.paint_background["background-color"]),"background-pattern":new fa(zi.paint_background["background-pattern"]),"background-opacity":new fa(zi.paint_background["background-opacity"]),"background-emissive-strength":new fa(zi.paint_background["background-emissive-strength"])}),layout:Kw};const Qw=new ga({visibility:new fa(zi.layout_raster.visibility)});var eT={paint:new ga({"raster-opacity":new fa(zi.paint_raster["raster-opacity"]),"raster-color":new _a(zi.paint_raster["raster-color"]),"raster-color-mix":new fa(zi.paint_raster["raster-color-mix"]),"raster-color-range":new fa(zi.paint_raster["raster-color-range"]),"raster-hue-rotate":new fa(zi.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new fa(zi.paint_raster["raster-brightness-min"]),"raster-brightness-max":new fa(zi.paint_raster["raster-brightness-max"]),"raster-saturation":new fa(zi.paint_raster["raster-saturation"]),"raster-contrast":new fa(zi.paint_raster["raster-contrast"]),"raster-resampling":new fa(zi.paint_raster["raster-resampling"]),"raster-fade-duration":new fa(zi.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new fa(zi.paint_raster["raster-emissive-strength"]),"raster-array-band":new fa(zi.paint_raster["raster-array-band"]),"raster-elevation":new fa(zi.paint_raster["raster-elevation"])}),layout:Qw};function Kb(C,te,le,ce,he,ue,de,_e){const ye=[C,le,he,te,ce,ue,1,1,1],ve=[de,_e,1],Se=sd.adjoint([],ye),[Me,Ae,Ce]=Zd.transformMat3(ve,ve,sd.transpose(Se,Se));return sd.multiply(ye,[Me,0,0,0,Ae,0,0,0,Ce],ye)}class Jb extends zt{constructor(C,te,le,ce){super(),this.id=C,this.dispatcher=le,this.coordinates=te.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(ce),this.options=te,this._dirty=!1}load(C,te){if(this._loaded=te||!1,this.fire(new It("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return C&&(this.coordinates=C),this._loaded=!0,void this._finishLoading();this._imageRequest=Ie(this.map._requestManager.transformRequest(this.url,st.Image),((te,ce)=>{if(this._imageRequest=null,this._loaded=!0,te)this.fire(new Ct(te));else if(ce){const{HTMLImageElement:te}=le;this.image=ce instanceof te?bi.getImageData(ce):ce,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,C&&(this.coordinates=C),this._finishLoading()}}))}loaded(){return this._loaded}updateImage(C){return C.url?(this._imageRequest&&C.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=C.url,this.load(C.coordinates,this._loaded),this):this}setTexture(C){if(!(C.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new Ay(this.map.painter.context,C.handle),this.width=C.dimensions[0],this.height=C.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new It("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(C){this.map=C,this.load()}onRemove(){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof Ay||this.texture.destroy()}setCoordinates(C){if(this.coordinates=C,this._boundsArray=void 0,!C.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let te=C[0][1],le=C[0][1];for(const ce of C)ce[1]>le&&(le=ce[1]),ce[1]<te&&(te=ce[1]);const ce=(le+te)/2;if(ce>Xf?this.onNorthPole=!0:ce<-Xf&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const te=C.map(lp.fromLngLat);this.tileID=function(C){let te=1/0,le=1/0,ce=-1/0,he=-1/0;for(const ue of C)te=Math.min(te,ue.x),le=Math.min(le,ue.y),ce=Math.max(ce,ue.x),he=Math.max(he,ue.y);const ue=Math.max(ce-te,he-le),de=Math.max(0,Math.floor(-Math.log(ue)/Math.LN2)),_e=Math.pow(2,de);return new ju(de,Math.floor((te+ce)/2*_e),Math.floor((le+he)/2*_e))}(te),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new It("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0}_prepareData(C){for(const C in this.tiles){const te=this.tiles[C];"loaded"!==te.state&&(te.state="loaded",te.texture=this.texture)}if(this._boundsArray)return;const te=Pg(this.tileID,this.map.transform.projection),[le,ce,he,ue]=this.coordinates.map((C=>{const le=te.projection.project(C[0],C[1]);return Rg(te,le)._round()}));this.perspectiveTransform=function(C,te,le,ce,he,ue,de,_e,ye,ve){const Se=Kb(0,0,C,0,0,te,C,te),Me=Kb(le,ce,he,ue,de,_e,ye,ve);return sd.multiply(Me,sd.adjoint(Se,Se),Me),[Me[6]/Me[8]*C/Mn,Me[7]/Me[8]*te/Mn]}(this.width,this.height,le.x,le.y,ce.x,ce.y,ue.x,ue.y,he.x,he.y);const de=this._boundsArray=new Da;de.emplaceBack(le.x,le.y,0,0),de.emplaceBack(ce.x,ce.y,Mn,0),de.emplaceBack(ue.x,ue.y,0,Mn),de.emplaceBack(he.x,he.y,Mn,Mn),this.boundsBuffer&&this.boundsBuffer.destroy(),this.boundsBuffer=C.createVertexBuffer(de,Uv.members),this.boundsSegments=xl.simpleSegment(0,0,4,2)}prepare(){const C=0!==Object.keys(this.tiles).length;if(this.tileID&&!C)return;const te=this.map.painter.context,le=te.gl;!this._dirty||this.texture instanceof Ay||(this.texture?this.texture.update(this.image):(this.texture=new My(te,this.image,le.RGBA),this.texture.bind(le.LINEAR,le.CLAMP_TO_EDGE)),this._dirty=!1),C&&this._prepareData(te)}loadTile(C,te){this.tileID&&this.tileID.equals(C.tileID.canonical)?(this.tiles[String(C.tileID.wrap)]=C,C.buckets={},te(null)):(C.state="errored",te(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}class Qb extends Ta{constructor(C){super(C,{}),this.implementation=C,C.slot&&(this.slot=C.slot)}is3D(){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}isLayerDraped(C){return void 0!==this.implementation.renderToTile}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(C){this.implementation.onAdd&&this.implementation.onAdd(C,C.painter.context.gl)}onRemove(C){this.implementation.onRemove&&this.implementation.onRemove(C,C.painter.context.gl)}}const tT=new ga({visibility:new fa(zi.layout_sky.visibility)});var iT={paint:new ga({"sky-type":new fa(zi.paint_sky["sky-type"]),"sky-atmosphere-sun":new fa(zi.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new fa(zi.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new fa(zi.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new fa(zi.paint_sky["sky-gradient-radius"]),"sky-gradient":new _a(zi.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new fa(zi.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new fa(zi.paint_sky["sky-atmosphere-color"]),"sky-opacity":new fa(zi.paint_sky["sky-opacity"])}),layout:tT};function iw(C,te,le){const ce=[0,0,1],he=Md.identity([]);return Md.rotateY(he,he,le?-w(C)+Math.PI:w(C)),Md.rotateX(he,he,-w(te)),Zd.transformQuat(ce,ce,he),Zd.normalize(ce,ce)}var rT={paint:new ga({})};const oT={circle:class extends Ta{constructor(C,te){super(C,Qf,te)}createBucket(C){return new vp(C)}queryRadius(C){const te=C;return kp("circle-radius",this,te)+kp("circle-stroke-width",this,te)+Op(this.paint.get("circle-translate"))}queryIntersectsFeature(C,te,le,ce,he,ue,de,_e){const ye=Fp(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),ue.angle,C.pixelToTileUnitsFactor),ve=this.paint.get("circle-radius").evaluate(te,le)+this.paint.get("circle-stroke-width").evaluate(te,le);return qp(C,ce,ue,de,_e,"map"===this.paint.get("circle-pitch-alignment"),"map"===this.paint.get("circle-pitch-scale"),ye,ve)}getProgramIds(){return["circle"]}getDefaultProgramParams(C,te){const le=Gp(this);return{config:new Ql(this,te),defines:le,overrideFog:!1}}},heatmap:class extends Ta{createBucket(C){return new Xp(C)}constructor(C,te){super(C,hm,te),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(C){"heatmap-color"===C&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=of({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(C){return kp("heatmap-radius",this,C)}queryIntersectsFeature(C,te,le,ce,he,ue,de,_e){const ye=this.paint.get("heatmap-radius").evaluate(te,le);return qp(C,ce,ue,de,_e,!0,!0,new je(0,0),ye)}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(C,te){return"heatmap"===C?{config:new Ql(this,te),overrideFog:!1}:{}}},hillshade:class extends Ta{constructor(C,te){super(C,fm,te)}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(C,te){return{overrideFog:!1}}},fill:class extends Ta{constructor(C,te){super(C,Om,te)}getProgramIds(){const C=this.paint.get("fill-pattern"),te=C&&C.constantOr(1),le=[te?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&le.push(te&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),le}getDefaultProgramParams(C,te){return{config:new Ql(this,te),overrideFog:!1}}recalculate(C,te){super.recalculate(C,te);const le=this.paint._values["fill-outline-color"];"constant"===le.value.kind&&void 0===le.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(C){return new jf(C)}queryRadius(){return Op(this.paint.get("fill-translate"))}queryIntersectsFeature(C,te,le,ce,he,ue){return!C.queryGeometry.isAboveHorizon&&Tp(Bp(C.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),ue.angle,C.pixelToTileUnitsFactor),ce)}isTileClipped(){return!0}},"fill-extrusion":class extends Ta{constructor(C,te){super(C,qw,te),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(C){return new vb(C)}queryRadius(){return Op(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}hasShadowPass(){return!0}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(C,te,le,ce,he,ue,de,_e,ye){const ve=Fp(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),ue.angle,C.pixelToTileUnitsFactor),Se=this.paint.get("fill-extrusion-height").evaluate(te,le),Me=this.paint.get("fill-extrusion-base").evaluate(te,le),Ae=[0,0],Ce=_e&&ue.elevation,Oe=ue.elevation?ue.elevation.exaggeration():1,Ne=C.tile.getBucket(this);if(Ce&&Ne instanceof vb){const C=Ne.centroidVertexArray,te=ye+1;te<C.length&&(Ae[0]=C.geta_centroid_pos0(te),Ae[1]=C.geta_centroid_pos1(te))}if(0===Ae[0]&&1===Ae[1])return!1;"globe"===ue.projection.name&&(ce=Cb([ce],[new je(0,0),new je(Mn,Mn)],C.tileID.canonical).map((C=>C.polygon)).flat());const Ge=Ce?_e:null,[Ze,qe]=function(C,te,le,ce,he,ue,de,_e,ye,ve,Se){return"globe"===C.projection.name?function(C,te,le,ce,he,ue,de,_e,ye,ve,Se){const Me=[],Ae=[],Ce=C.projection.upVectorScale(Se,C.center.lat,C.worldSize).metersToTile,Oe=[0,0,0,1],Ne=[0,0,0,1],_=(C,te,le,ce)=>{C[0]=te,C[1]=le,C[2]=ce,C[3]=1},je=Ib();le>0&&(le+=je),ce+=je;for(const je of te){const te=[],Ge=[];for(const Me of je){const Ae=Me.x+he.x,je=Me.y+he.y,Ze=C.projection.projectTilePoint(Ae,je,Se),qe=C.projection.upVector(Se,Me.x,Me.y);let $e=le,He=ce;if(de){const C=Ob(Ae,je,le,ce,de,_e,ye,ve);$e+=C.base,He+=C.top}0!==le?_(Oe,Ze.x+qe[0]*Ce*$e,Ze.y+qe[1]*Ce*$e,Ze.z+qe[2]*Ce*$e):_(Oe,Ze.x,Ze.y,Ze.z),_(Ne,Ze.x+qe[0]*Ce*He,Ze.y+qe[1]*Ce*He,Ze.z+qe[2]*Ce*He),Zd.transformMat4(Oe,Oe,ue),Zd.transformMat4(Ne,Ne,ue),te.push(new Rb(Oe[0],Oe[1],Oe[2])),Ge.push(new Rb(Ne[0],Ne[1],Ne[2]))}Me.push(te),Ae.push(Ge)}return[Me,Ae]}(C,te,le,ce,he,ue,de,_e,ye,ve,Se):de?function(C,te,le,ce,he,ue,de,_e,ye){const ve=[],Se=[],Me=[0,0,0,1];for(const Ae of C){const C=[],Ce=[];for(const ve of Ae){const Se=ve.x+ce.x,Ae=ve.y+ce.y,Oe=Ob(Se,Ae,te,le,ue,de,_e,ye);Me[0]=Se,Me[1]=Ae,Me[2]=Oe.base,Me[3]=1,$u.transformMat4(Me,Me,he),Me[3]=Math.max(Me[3],1e-5);const Ne=new Rb(Me[0]/Me[3],Me[1]/Me[3],Me[2]/Me[3]);Me[0]=Se,Me[1]=Ae,Me[2]=Oe.top,Me[3]=1,$u.transformMat4(Me,Me,he),Me[3]=Math.max(Me[3],1e-5);const je=new Rb(Me[0]/Me[3],Me[1]/Me[3],Me[2]/Me[3]);C.push(Ne),Ce.push(je)}ve.push(C),Se.push(Ce)}return[ve,Se]}(te,le,ce,he,ue,de,_e,ye,ve):function(C,te,le,ce,he){const ue=[],de=[],_e=he[8]*te,ye=he[9]*te,ve=he[10]*te,Se=he[11]*te,Me=he[8]*le,Ae=he[9]*le,Ce=he[10]*le,Oe=he[11]*le;for(const te of C){const C=[],le=[];for(const ue of te){const te=ue.x+ce.x,de=ue.y+ce.y,Ne=he[0]*te+he[4]*de+he[12],je=he[1]*te+he[5]*de+he[13],Ge=he[2]*te+he[6]*de+he[14],Ze=he[3]*te+he[7]*de+he[15],qe=Ne+_e,$e=je+ye,He=Ge+ve,We=Math.max(Ze+Se,1e-5),Xe=Ne+Me,Ye=je+Ae,Je=Ge+Ce,Qe=Math.max(Ze+Oe,1e-5);C.push(new Rb(qe/We,$e/We,He/We)),le.push(new Rb(Xe/Qe,Ye/Qe,Je/Qe))}ue.push(C),de.push(le)}return[ue,de]}(te,le,ce,he,ue)}(ue,ce,Me,Se,ve,de,Ge,Ae,Oe,ue.center.lat,C.tileID.canonical),$e=C.queryGeometry;return function(C,te,le){let ce=1/0;Tp(le,te)&&(ce=kb(le,te[0]));for(let he=0;he<te.length;he++){const ue=te[he],de=C[he];for(let C=0;C<ue.length-1;C++){const te=ue[C],he=[te,ue[C+1],de[C+1],de[C],te];bp(le,he)&&(ce=Math.min(ce,kb(le,he)))}}return ce!==1/0&&ce}(Ze,qe,$e.isPointQuery()?$e.screenBounds:$e.screenGeometry)}},line:class extends Ta{constructor(C,te){super(C,Hw,te),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(C){if("line-gradient"===C){const C=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=C._styleExpression&&C._styleExpression.expression instanceof jn,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(C,te){super.recalculate(C,te),this.paint._values["line-floorwidth"]=Xw.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,C)}createBucket(C){return new Ey(C)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(C,te){const le=Gb(this);return{config:new Ql(this,te),defines:le,overrideFog:!1}}queryRadius(C){const te=C,le=$b(kp("line-width",this,te),kp("line-gap-width",this,te)),ce=kp("line-offset",this,te);return le/2+Math.abs(ce)+Op(this.paint.get("line-translate"))}queryIntersectsFeature(C,te,le,ce,he,ue){if(C.queryGeometry.isAboveHorizon)return!1;const de=Bp(C.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),ue.angle,C.pixelToTileUnitsFactor),_e=C.pixelToTileUnitsFactor/2*$b(this.paint.get("line-width").evaluate(te,le),this.paint.get("line-gap-width").evaluate(te,le)),ye=this.paint.get("line-offset").evaluate(te,le);return ye&&(ce=function(C,te){const le=[],ce=new je(0,0);for(let he=0;he<C.length;he++){const ue=C[he],de=[];for(let C=0;C<ue.length;C++){const le=ue[C],he=ue[C+1],_e=0===C?ce:le.sub(ue[C-1])._unit()._perp(),ye=C===ue.length-1?ce:he.sub(le)._unit()._perp(),ve=_e._add(ye)._unit();ve._mult(1/(ve.x*ye.x+ve.y*ye.y)),de.push(ve._mult(te)._add(le))}le.push(de)}return le}(ce,ye*C.pixelToTileUnitsFactor)),function(C,te,le){for(let ce=0;ce<te.length;ce++){const he=te[ce];if(C.length>=3)for(let te=0;te<he.length;te++)if(zp(C,he[te]))return!0;if(Ep(C,he,le))return!0}return!1}(de,ce,_e)}isTileClipped(){return!0}},symbol:oy,background:class extends Ta{constructor(C,te){super(C,Yw,te)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(C,te){return{overrideFog:!1}}},raster:class extends Ta{constructor(C,te){super(C,eT,te),this._updateColorRamp()}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}isLayerDraped(C){return!(C&&C._source instanceof Jb)||!C._source.onNorthPole&&!C._source.onSouthPole&&0===this.paint.get("raster-elevation")}_handleSpecialPaintPropertyUpdate(C){"raster-color"!==C&&"raster-color-range"!==C||this._updateColorRamp()}_updateColorRamp(){if(!this.hasColorMap())return;const C=this._transitionablePaint._values["raster-color"].value.expression,[te,le]=this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0});this.colorRamp=of({expression:C,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:te,end:le}],resolution:256}),this.colorRampTexture=null}},sky:class extends Ta{constructor(C,te){super(C,iT,te),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(C){"sky-gradient"===C?this._updateColorRamp():"sky-atmosphere-sun"!==C&&"sky-atmosphere-halo-color"!==C&&"sky-atmosphere-color"!==C&&"sky-atmosphere-sun-intensity"!==C||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=of({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(C){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const te=C.style.light.properties.get("position");return this._lightPosition.azimuthal!==te.azimuthal||this._lightPosition.polar!==te.polar}return!1}getCenter(C,te){if("atmosphere"===this.paint.get("sky-type")){const le=this.paint.get("sky-atmosphere-sun"),ce=!le,he=C.style.light,ue=he.properties.get("position");return ce&&"viewport"===he.properties.get("anchor")&&H("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),ce?iw(ue.azimuthal,90-ue.polar,te):iw(le[0],90-le[1],te)}const le=this.paint.get("sky-gradient-center");return iw(le[0],90-le[1],te)}isSky(){return!0}markSkyboxValid(C){this._skyboxInvalidated=!1,this._lightPosition=C.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const C=this.paint.get("sky-type");return"atmosphere"===C?["skyboxCapture","skybox"]:"gradient"===C?["skyboxGradient"]:null}},slot:class extends Ta{constructor(C,te){super(C,rT)}},model:class extends Ta{constructor(C,te){super(C,tw,te)}createBucket(C){return new Bv(C)}getProgramIds(){return["model"]}is3D(){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(){return 0}queryIntersectsFeature(){return!1}_handleOverridablePaintPropertyUpdate(C,te,le){return!(!this.layout||te.isDataDriven()||le.isDataDriven()||"model-color"!==C&&"model-color-mix-intensity"!==C&&"model-rotation"!==C&&"model-scale"!==C&&"model-translation"!==C&&"model-emissive-strength"!==C)}_isPropertyZoomDependent(C){const te=this._transitionablePaint._values[C];return null!=te&&null!=te.value&&null!=te.value.expression&&te.value.expression instanceof Ao}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}}};function ow(C,te){return"custom"===C.type?new Qb(C):new oT[C.type](C,te)}function sw(C){const{userImage:te}=C;return!!(te&&te.render&&te.render())&&(C.data.replace(new Uint8Array(te.data.buffer)),!0)}class aw extends zt{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.atlasImage={},this.atlasTexture={},this.dirty=!0}createScope(C){this.images[C]={},this.loaded[C]=!1,this.updatedImages[C]={},this.patterns[C]={},this.callbackDispatchedThisFrame[C]={},this.atlasImage[C]=new ef({width:1,height:1})}isLoaded(){for(const C in this.loaded)if(!this.loaded[C])return!1;return!0}setLoaded(C,te){if(this.loaded[te]!==C&&(this.loaded[te]=C,C)){for(const{ids:C,callback:le}of this.requestors)this._notify(C,te,le);this.requestors=[]}}hasImage(C,te){return!!this.getImage(C,te)}getImage(C,te){return this.images[te][C]}addImage(C,te,le){this._validate(C,le)&&(this.images[te][C]=le)}_validate(C,te){let le=!0;return this._validateStretch(te.stretchX,te.data&&te.data.width)||(this.fire(new Ct(new Error(`Image "${C}" has invalid "stretchX" value`))),le=!1),this._validateStretch(te.stretchY,te.data&&te.data.height)||(this.fire(new Ct(new Error(`Image "${C}" has invalid "stretchY" value`))),le=!1),this._validateContent(te.content,te)||(this.fire(new Ct(new Error(`Image "${C}" has invalid "content" value`))),le=!1),le}_validateStretch(C,te){if(!C)return!0;let le=0;for(const ce of C){if(ce[0]<le||ce[1]<ce[0]||te<ce[1])return!1;le=ce[1]}return!0}_validateContent(C,te){return!(C&&(4!==C.length||C[0]<0||te.data.width<C[0]||C[1]<0||te.data.height<C[1]||C[2]<0||te.data.width<C[2]||C[3]<0||te.data.height<C[3]||C[2]<C[0]||C[3]<C[1]))}updateImage(C,te,le){le.version=this.images[te][C].version+1,this.images[te][C]=le,this.updatedImages[te][C]=!0}removeImage(C,te){const le=this.images[te][C];delete this.images[te][C],delete this.patterns[te][C],le.userImage&&le.userImage.onRemove&&le.userImage.onRemove()}listImages(C){return Object.keys(this.images[C])}getImages(C,te,le){let ce=!0;const he=!!this.loaded[te];if(!he)for(const le of C)this.images[te][le]||(ce=!1);he||ce?this._notify(C,te,le):this.requestors.push({ids:C,scope:te,callback:le})}getUpdatedImages(C){return this.updatedImages[C]}_notify(C,te,le){const ce={};for(const le of C){this.images[te][le]||this.fire(new It("styleimagemissing",{id:le}));const C=this.images[te][le];C?ce[le]={data:C.data.clone(),pixelRatio:C.pixelRatio,sdf:C.sdf,version:C.version,stretchX:C.stretchX,stretchY:C.stretchY,content:C.content,hasRenderCallback:Boolean(C.userImage&&C.userImage.render)}:H(`Image "${le}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}le(null,ce)}getPixelSize(C){const{width:te,height:le}=this.atlasImage[C];return{width:te,height:le}}getPattern(C,te){const le=this.patterns[te][C],ce=this.getImage(C,te);if(!ce)return null;if(le&&le.position.version===ce.version)return le.position;if(le)le.position.version=ce.version;else{const le={w:ce.data.width+2,h:ce.data.height+2,x:0,y:0},he=new Q_(le,ce);this.patterns[te][C]={bin:le,position:he}}return this._updatePatternAtlas(te),this.patterns[te][C].position}bind(C,te){const le=C.gl;let ce=this.atlasTexture[te];ce?this.dirty&&(ce.update(this.atlasImage[te]),this.dirty=!1):(ce=new My(C,this.atlasImage[te],le.RGBA),this.atlasTexture[te]=ce),ce.bind(le.LINEAR,le.CLAMP_TO_EDGE)}_updatePatternAtlas(C){const te=[];for(const le in this.patterns[C])te.push(this.patterns[C][le].bin);const{w:le,h:ce}=K_(te),he=this.atlasImage[C];he.resize({width:le||1,height:ce||1});for(const te in this.patterns[C]){const{bin:le}=this.patterns[C][te],ce=le.x+1,ue=le.y+1,de=this.images[C][te].data,_e=de.width,ye=de.height;ef.copy(de,he,{x:0,y:0},{x:ce,y:ue},{width:_e,height:ye}),ef.copy(de,he,{x:0,y:ye-1},{x:ce,y:ue-1},{width:_e,height:1}),ef.copy(de,he,{x:0,y:0},{x:ce,y:ue+ye},{width:_e,height:1}),ef.copy(de,he,{x:_e-1,y:0},{x:ce-1,y:ue},{width:1,height:ye}),ef.copy(de,he,{x:0,y:0},{x:ce+_e,y:ue},{width:1,height:ye})}this.dirty=!0}beginFrame(){for(const C in this.images)this.callbackDispatchedThisFrame[C]={}}dispatchRenderCallbacks(C,te){for(const le of C){if(this.callbackDispatchedThisFrame[te][le])continue;this.callbackDispatchedThisFrame[te][le]=!0;const C=this.images[te][le];sw(C)&&this.updateImage(le,te,C)}}}const aT=new ga({anchor:new fa(zi.light.anchor),position:new class{constructor(C){this.specification=C}possiblyEvaluate(C,te){return K(C.expression.evaluate(te))}interpolate(C,te,le){return{x:Kr(C.x,te.x,le),y:Kr(C.y,te.y,le),z:Kr(C.z,te.z,le),azimuthal:Kr(C.azimuthal,te.azimuthal,le),polar:Kr(C.polar,te.polar,le)}}}(zi.light.position),color:new fa(zi.light.color),intensity:new fa(zi.light.intensity)});class cw extends zt{constructor(C,te="flat"){super(),this._transitionable=new la(aT),this.setLight(C,te),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(C,te,le={}){this._validate(gs,C,le)||(this._transitionable.setTransitionOrValue(C),this.id=te)}updateTransitions(C){this._transitioning=this._transitionable.transitioned(C,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(C){this.properties=this._transitioning.possiblyEvaluate(C)}_validate(C,te,le){return(!le||!1!==le.validate)&&Ss(this,C.call(ms,k({value:te,style:{glyphs:!0,sprite:!0},styleSpec:zi})))}}const lT=new ga({source:new fa(zi.terrain.source),exaggeration:new fa(zi.terrain.exaggeration)});let AT=class extends zt{constructor(C,te,le,ce){super(),this.scope=le,this._transitionable=new la(lT,ce),this._transitionable.setTransitionOrValue(C,ce),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=te}get(){return this._transitionable.serialize()}set(C,te){this._transitionable.setTransitionOrValue(C,te)}updateTransitions(C){this._transitioning=this._transitionable.transitioned(C,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(C){this.properties=this._transitioning.possiblyEvaluate(C)}getExaggeration(C){return this._transitioning.possiblyEvaluate(new oa(C)).get("exaggeration")}isZoomDependent(){const C=this._transitionable._values.exaggeration;return null!=C&&null!=C.value&&null!=C.value.expression&&C.value.expression instanceof Ao}};const RT=45,OT=65,$T=.05;function mw(C,te,le,ce){const he=P(RT,OT,le),[ue,de]=_w(C,ce);let _e=1-Math.min(1,Math.exp((te-ue)/(de-ue)*-6));return _e*=_e*_e,_e=Math.min(1,1.00747*_e),_e*he*C.alpha}function _w(C,te){const le=.5/Math.tan(.5*te);return[C.range[0]+le,C.range[1]+le]}function gw(C,te,le,ce,he){const ue=Zd.transformMat4([],[te,le,ce],he.mercatorFogMatrix);return mw(C,Zd.length(ue),he.pitch,he._fov)}function yw(C,te,le,ce,he,ue,de){const _e=[[le,ce,0],[he,ce,0],[he,ue,0],[le,ue,0]];let ye=Number.MAX_VALUE,ve=-Number.MAX_VALUE;for(const C of _e){const le=Zd.transformMat4([],C,te),ce=Zd.length(le);ye=Math.min(ye,ce),ve=Math.max(ve,ce)}return[mw(C,ye,de.pitch,de._fov),mw(C,ve,de.pitch,de._fov)]}const eS=new ga({range:new fa(zi.fog.range),color:new fa(zi.fog.color),"high-color":new fa(zi.fog["high-color"]),"space-color":new fa(zi.fog["space-color"]),"horizon-blend":new fa(zi.fog["horizon-blend"]),"star-intensity":new fa(zi.fog["star-intensity"]),"vertical-range":new fa(zi.fog["vertical-range"])});class vw extends zt{constructor(C,te){super(),this._transitionable=new la(eS),this.set(C),this._transitioning=this._transitionable.untransitioned(),this._transform=te}get state(){const C=this._transform,te="globe"===C.projection.name,le=Dd(C.zoom),ce=this.properties.get("range"),he=[.5,3];return{range:te?[Kr(he[0],ce[0],le),Kr(he[1],ce[1],le)]:ce,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(C,te={}){if(this._validate(vs,C,te))return;const le=k({},C);for(const C of Object.keys(zi.fog))void 0===le[C]&&(le[C]=zi.fog[C].default);this._transitionable.setTransitionOrValue(le)}getOpacity(C){if(!this._transform.projection.supportsFog)return 0;const te=this.properties&&this.properties.get("color")||1;return("globe"===this._transform.projection.name?1:P(RT,OT,C))*te.a}getOpacityAtLatLng(C,te){return this._transform.projection.supportsFog?function(C,te,le){const ce=lp.fromLngLat(te),he=le.elevation?le.elevation.getAtPointOrZero(ce):0;return gw(C,ce.x,ce.y,he,le)}(this.state,C,te):0}getOpacityForTile(C){if(!this._transform.projection.supportsFog)return[1,1];const te=this._transform.calculateFogTileMatrix(C.toUnwrapped());return yw(this.state,te,0,0,Mn,Mn,this._transform)}getOpacityForBounds(C,te,le,ce,he){return this._transform.projection.supportsFog?yw(this.state,C,te,le,ce,he,this._transform):[1,1]}getFovAdjustedRange(C){return this._transform.projection.supportsFog?_w(this.state,C):[0,1]}isVisibleOnFrustum(C){if(!this._transform.projection.supportsFog)return!1;const te=[4,5,6,7];for(const le of te){const te=C.points[le];let ce;if(te[2]>=0)ce=te;else{const he=C.points[le-4];ce=Jr(he,te,he[2]/(he[2]-te[2]))}if(gw(this.state,ce[0],ce[1],0,this._transform)>=$T)return!0}return!1}updateTransitions(C){this._transitioning=this._transitionable.transitioned(C,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(C){this.properties=this._transitioning.possiblyEvaluate(C)}_validate(C,te,le){return(!le||!1!==le.validate)&&Ss(this,C.call(ms,k({value:te,style:{glyphs:!0,sprite:!0},styleSpec:zi})))}}class bw{constructor(C){this._callback=C,this._triggered=!1,"undefined"!=typeof MessageChannel&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._callback()}),0))}remove(){this._channel=void 0,this._callback=()=>{}}}class ww{constructor(){this.tasks={},this.taskQueue=[],j(["process"],this),this.invoker=new bw(this.process),this.nextId=0}add(C,te){const le=this.nextId++,ce=function({type:C,isSymbolTile:te,zoom:le}){return le=le||0,"message"===C?0:"maybePrepare"!==C||te?"parseTile"!==C||te?"parseTile"===C&&te?300-le:"maybePrepare"===C&&te?400-le:500:200-le:100-le}(te);if(0===ce){Q();try{C()}finally{}return{cancel:()=>{}}}return this.tasks[le]={fn:C,metadata:te,priority:ce,id:le},this.taskQueue.push(le),this.invoker.trigger(),{cancel:()=>{delete this.tasks[le]}}}process(){Q();try{if(this.taskQueue=this.taskQueue.filter((C=>!!this.tasks[C])),!this.taskQueue.length)return;const C=this.pick();if(null===C)return;const te=this.tasks[C];if(delete this.tasks[C],this.taskQueue.length&&this.invoker.trigger(),!te)return;te.fn()}finally{}}pick(){let C=null,te=1/0;for(let le=0;le<this.taskQueue.length;le++){const ce=this.tasks[this.taskQueue[le]];ce.priority<te&&(te=ce.priority,C=le)}if(null===C)return null;const le=this.taskQueue[C];return this.taskQueue.splice(C,1),le}remove(){this.invoker.remove()}}class Tw{constructor(C,te,le){this.target=C,this.parent=te,this.mapId=le,this.callbacks={},this.cancelCallbacks={},j(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new ww}send(C,te,le,ce,he=!1,ue){const de=Math.round(1e18*Math.random()).toString(36).substring(0,10);le&&(le.metadata=ue,this.callbacks[de]=le);const _e=new Set;return this.target.postMessage({id:de,type:C,hasCallback:!!le,targetMapId:ce,mustQueue:he,sourceMapId:this.mapId,data:Os(te,_e)},_e),{cancel:()=>{le&&delete this.callbacks[de],this.target.postMessage({id:de,type:"<cancel>",targetMapId:ce,sourceMapId:this.mapId})}}}receive(C){const te=C.data,le=te.id;if(le&&(!te.targetMapId||this.mapId===te.targetMapId))if("<cancel>"===te.type){const C=this.cancelCallbacks[le];delete this.cancelCallbacks[le],C&&C.cancel()}else if(te.mustQueue||Q()){const C=this.callbacks[le];this.cancelCallbacks[le]=this.scheduler.add((()=>this.processTask(le,te)),C&&C.metadata||{type:"message"})}else this.processTask(le,te)}processTask(C,te){if("<response>"===te.type){const le=this.callbacks[C];delete this.callbacks[C],le&&(te.error?le(Bs(te.error)):le(null,Bs(te.data)))}else{const le=new Set,ce=te.hasCallback?(te,ce)=>{delete this.cancelCallbacks[C],this.target.postMessage({id:C,type:"<response>",sourceMapId:this.mapId,error:te?Os(te):null,data:Os(ce,le)},le)}:C=>{},he=Bs(te.data);if(this.parent[te.type])this.parent[te.type](te.sourceMapId,he,ce);else if(this.parent.getWorkerSource){const C=te.type.split(".");this.parent.getWorkerSource(te.sourceMapId,C[0],he.source,he.scope)[C[1]](he,ce)}else ce(new Error(`Could not find function ${te.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}class Ew{constructor(C,te){this.workerPool=C,this.actors=[],this.currentActor=0,this.id=F();const le=this.workerPool.acquire(this.id);for(let C=0;C<le.length;C++){const ce=new Ew.Actor(le[C],te,this.id);ce.name=`Worker ${C}`,this.actors.push(ce)}this.ready=!1,this.broadcast("checkIfReady",null,(()=>{this.ready=!0}))}broadcast(C,te,le){R(this.actors,((le,ce)=>{le.send(C,te,ce)}),le=le||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach((C=>{C.remove()})),this.actors=[],this.workerPool.release(this.id)}}Ew.Actor=Tw;class Mw extends zt{constructor(C,te,le,ce){super(),this.scope=le,this._options=C,this.properties=new pa(te),this._transitionable=new la(te,new Map(ce)),this._transitionable.setTransitionOrValue(C.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(C){this._transitionable.setTransitionOrValue(this._options.properties,new Map(C))}updateTransitions(C){this._transitioning=this._transitionable.transitioned(C,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(C){this.properties=this._transitioning.possiblyEvaluate(C)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(C,te){this._options=C,this._transitionable.setTransitionOrValue(C.properties,te)}shadowsEnabled(){return!!this.properties&&!0===this.properties.get("cast-shadows")}}const tS=new ga({color:new fa(zi.properties_light_ambient.color),intensity:new fa(zi.properties_light_ambient.intensity)}),sS=new ga({direction:new class{constructor(C){this.specification=C}possiblyEvaluate(C,te){return function([C,te]){const le=K([1,C,te]);return{x:le.x,y:le.y,z:le.z}}(C.expression.evaluate(te))}interpolate(C,te,le){return{x:Kr(C.x,te.x,le),y:Kr(C.y,te.y,le),z:Kr(C.z,te.z,le)}}}(zi.properties_light_directional.direction),color:new fa(zi.properties_light_directional.color),intensity:new fa(zi.properties_light_directional.intensity),"cast-shadows":new fa(zi.properties_light_directional["cast-shadows"]),"shadow-intensity":new fa(zi.properties_light_directional["shadow-intensity"])});class Iw{constructor(C,te,le,ce){this.screenBounds=C,this.cameraPoint=te,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=le,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,ce)}static createFromScreenPoints(C,te){let le,ce;if(C instanceof je||"number"==typeof C[0]){const he=je.convert(C);le=[he],ce=te.isPointAboveHorizon(he)}else{const he=je.convert(C[0]),ue=je.convert(C[1]);le=[he,ue],ce=S(he,ue).every((C=>te.isPointAboveHorizon(C)))}return new Iw(le,te.getCameraPoint(),ce,te)}isPointQuery(){return 1===this.screenBounds.length}bufferedScreenGeometry(C){return S(this.screenBounds[0],1===this.screenBounds.length?this.screenBounds[0]:this.screenBounds[1],C)}bufferedCameraGeometry(C){const te=this.screenBounds[0],le=1===this.screenBounds.length?this.screenBounds[0].add(new je(1,1)):this.screenBounds[1],ce=S(te,le,0,!1);return this.cameraPoint.y>le.y&&(this.cameraPoint.x>te.x&&this.cameraPoint.x<le.x?ce.splice(3,0,this.cameraPoint):this.cameraPoint.x>=le.x?ce[2]=this.cameraPoint:this.cameraPoint.x<=te.x&&(ce[3]=this.cameraPoint)),function(C,te){const le=[];for(let ce=0;ce<C.length;ce++){const he=D(ce-1,-1,C.length-1),ue=D(ce+1,-1,C.length-1),de=C[ce],_e=C[ue],ye=C[he].sub(de).unit(),ve=_e.sub(de).unit(),Se=ve.angleWithSep(ye.x,ye.y),Me=ye.add(ve).unit().mult(-1*te/Math.sin(Se/2));le.push(de.add(Me))}return le}(ce,C)}bufferedCameraGeometryGlobe(C){const te=this.screenBounds[0],le=1===this.screenBounds.length?this.screenBounds[0].add(new je(1,1)):this.screenBounds[1],ce=S(te,le,C),he=this.cameraPoint.clone();switch(3*((he.y>te.y)+(he.y>le.y))+((he.x>te.x)+(he.x>le.x))){case 0:ce[0]=he,ce[4]=he.clone();break;case 1:ce.splice(1,0,he);break;case 2:ce[1]=he;break;case 3:ce.splice(4,0,he);break;case 5:ce.splice(2,0,he);break;case 6:ce[3]=he;break;case 7:ce.splice(3,0,he);break;case 8:ce[2]=he}return ce}containsTile(C,te,le,ce=0){const he=C.queryPadding/te._pixelsPerMercatorPixel+1,ue=le?this._bufferedCameraMercator(he,te):this._bufferedScreenMercator(he,te);let de=C.tileID.wrap+(ue.unwrapped?ce:0);const _e=ue.polygon.map((te=>Rg(C.tileTransform,te,de)));if(!Pp(_e,0,0,Mn,Mn))return;de=C.tileID.wrap+(this.screenGeometryMercator.unwrapped?ce:0);const ye=this.screenGeometryMercator.polygon.map((te=>Lg(C.tileTransform,te,de))),ve=ye.map((C=>new je(C[0],C[1]))),Se=te.getFreeCameraOptions().position||new lp(0,0,0),Me=Lg(C.tileTransform,Se,de),Ae=ye.map((C=>{const te=Zd.sub(C,C,Me);return Zd.normalize(te,te),new Wu(Me,te)})),Ce=rv(C,1,te.zoom)*te._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:ve,tilespaceRays:Ae,bufferedTilespaceGeometry:_e,bufferedTilespaceBounds:(Oe=A(_e),Oe.min.x=z(Oe.min.x,0,Mn),Oe.min.y=z(Oe.min.y,0,Mn),Oe.max.x=z(Oe.max.x,0,Mn),Oe.max.y=z(Oe.max.y,0,Mn),Oe),tile:C,tileID:C.tileID,pixelToTileUnitsFactor:Ce};var Oe}_bufferedScreenMercator(C,te){const le=Pw(C);if(this._screenRaycastCache[le])return this._screenRaycastCache[le];{let ce;return ce="globe"===te.projection.name?this._projectAndResample(this.bufferedScreenGeometry(C),te):{polygon:this.bufferedScreenGeometry(C).map((C=>te.pointCoordinate3D(C))),unwrapped:!0},this._screenRaycastCache[le]=ce,ce}}_bufferedCameraMercator(C,te){const le=Pw(C);if(this._cameraRaycastCache[le])return this._cameraRaycastCache[le];{let ce;return ce="globe"===te.projection.name?this._projectAndResample(this.bufferedCameraGeometryGlobe(C),te):{polygon:this.bufferedCameraGeometry(C).map((C=>te.pointCoordinate3D(C))),unwrapped:!0},this._cameraRaycastCache[le]=ce,ce}}_projectAndResample(C,te){const le=function(C,te){const le=ld.multiply([],te.pixelMatrix,te.globeMatrix),ce=[0,-$p,0,1],he=[0,$p,0,1],ue=[0,0,0,1];$u.transformMat4(ce,ce,le),$u.transformMat4(he,he,le),$u.transformMat4(ue,ue,le);const de=new je(ce[0]/ce[3],ce[1]/ce[3]),_e=new je(he[0]/he[3],he[1]/he[3]),ye=zp(C,de)&&ce[3]<ue[3],ve=zp(C,_e)&&he[3]<ue[3];if(!ye&&!ve)return null;const Se=function(C,te,le){for(let ce=1;ce<C.length;ce++){const he=zw(te.pointCoordinate3D(C[ce-1]).x),ue=zw(te.pointCoordinate3D(C[ce]).x);if(le<0){if(he<ue)return{idx:ce,t:-he/(ue-1-he)}}else if(ue<he)return{idx:ce,t:(1-he)/(ue+1-he)}}return null}(C,te,ye?-1:1);if(!Se)return null;const{idx:Me,t:Ae}=Se;let Ce=Me>1?Cw(C.slice(0,Me),te):[],Oe=Me<C.length?Cw(C.slice(Me),te):[];Ce=Ce.map((C=>new je(zw(C.x),C.y))),Oe=Oe.map((C=>new je(zw(C.x),C.y)));const Ne=[...Ce];0===Ne.length&&Ne.push(Oe[Oe.length-1]);const Ge=Kr(Ne[Ne.length-1].y,(0===Oe.length?Ce[0]:Oe[0]).y,Ae);let Ze;return Ze=ye?[new je(0,Ge),new je(0,0),new je(1,0),new je(1,Ge)]:[new je(1,Ge),new je(1,1),new je(0,1),new je(0,Ge)],Ne.push(...Ze),0===Oe.length?Ne.push(Ce[0]):Ne.push(...Oe),{polygon:Ne.map((C=>new lp(C.x,C.y))),unwrapped:!1}}(C,te);if(le)return le;const ce=function(C,te){let le=!1,ce=-1/0,he=0;for(let te=0;te<C.length-1;te++)C[te].x>ce&&(ce=C[te].x,he=te);for(let te=0;te<C.length-1;te++){const ce=(he+te)%(C.length-1),ue=C[ce],de=C[ce+1];Math.abs(ue.x-de.x)>.5&&(ue.x<de.x?(ue.x+=1,0===ce&&(C[C.length-1].x+=1)):(de.x+=1,ce+1===C.length-1&&(C[0].x+=1)),le=!0)}const ue=Kd(te.center.lng);return le&&ue<Math.abs(ue-1)&&C.forEach((C=>{C.x-=1})),{polygon:C,unwrapped:le}}(Cw(C,te).map((C=>new je(zw(C.x),C.y))),te);return{polygon:ce.polygon.map((C=>new lp(C.x,C.y))),unwrapped:ce.unwrapped}}}function Cw(C,te){return hp(C,(C=>{const le=te.pointCoordinate3D(C);C.x=le.x,C.y=le.y}),1/256)}function zw(C){return C<0?1+C%1:C%1}function Pw(C){return 100*C|0}function Dw(C,te,le,ce,he){const o=function(le,ce){if(le)return he(le);if(ce){C.url&&ce.tiles&&C.tiles&&delete C.tiles;const le=O(k(ce,C),["tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);ce.vector_layers&&(le.vectorLayers=ce.vector_layers,le.vectorLayerIds=le.vectorLayers.map((C=>C.id))),le.tiles=te.canonicalizeTileset(le,C.url),he(null,le)}};return C.url?we(te.transformRequest(te.normalizeSourceURL(C.url,null,le,ce),st.Source),o):bi.frame((()=>o(null,C)))}class Rw{constructor(C,te,le){this.bounds=sc.convert(this.validateBounds(C)),this.minzoom=te||0,this.maxzoom=le||24}validateBounds(C){return Array.isArray(C)&&4===C.length?[Math.max(-180,C[0]),Math.max(-90,C[1]),Math.min(180,C[2]),Math.min(90,C[3])]:[-180,-90,180,90]}contains(C){const te=Math.pow(2,C.z),le=Math.floor(Kd(this.bounds.getWest())*te),ce=Math.floor(Jd(this.bounds.getNorth())*te),he=Math.ceil(Kd(this.bounds.getEast())*te),ue=Math.ceil(Jd(this.bounds.getSouth())*te);return C.x>=le&&C.x<he&&C.y>=ce&&C.y<ue}}class Lw{constructor(C,te){this.width=C,this.height=te,this.nextRow=0,this.image=new Qp({width:C,height:te}),this.positions={},this.uploaded=!1}getDash(C,te){const le=this.getKey(C,te);return this.positions[le]}trim(){const C=this.width,te=this.height=U(this.nextRow);this.image.resize({width:C,height:te})}getKey(C,te){return C.join(",")+te}getDashRanges(C,te,le){const ce=[];let he=C.length%2==1?-C[C.length-1]*le:0,ue=C[0]*le,de=!0;ce.push({left:he,right:ue,isDash:de,zeroLength:0===C[0]});let _e=C[0];for(let te=1;te<C.length;te++){de=!de;const ye=C[te];he=_e*le,_e+=ye,ue=_e*le,ce.push({left:he,right:ue,isDash:de,zeroLength:0===ye})}return ce}addRoundDash(C,te,le){const ce=te/2;for(let te=-le;te<=le;te++){const he=this.width*(this.nextRow+le+te);let ue=0,de=C[ue];for(let _e=0;_e<this.width;_e++){_e/de.right>1&&(de=C[++ue]);const ye=Math.abs(_e-de.left),ve=Math.abs(_e-de.right),Se=Math.min(ye,ve);let Me;const Ae=te/le*(ce+1);if(de.isDash){const C=ce-Math.abs(Ae);Me=Math.sqrt(Se*Se+C*C)}else Me=ce-Math.sqrt(Se*Se+Ae*Ae);this.image.data[he+_e]=Math.max(0,Math.min(255,Me+128))}}}addRegularDash(C,te){for(let te=C.length-1;te>=0;--te){const le=C[te],ce=C[te+1];le.zeroLength?C.splice(te,1):ce&&ce.isDash===le.isDash&&(ce.left=le.left,C.splice(te,1))}const le=C[0],ce=C[C.length-1];le.isDash===ce.isDash&&(le.left=ce.left-this.width,ce.right=le.right+this.width);const he=this.width*this.nextRow;let ue=0,de=C[ue];for(let le=0;le<this.width;le++){le/de.right>1&&(de=C[++ue]);const ce=Math.abs(le-de.left),_e=Math.abs(le-de.right),ye=Math.min(ce,_e);this.image.data[he+le]=Math.max(0,Math.min(255,(de.isDash?ye:-ye)+te+128))}}addDash(C,te){const le=this.getKey(C,te);if(this.positions[le])return this.positions[le];const ce="round"===te,he=ce?7:0,ue=2*he+1;if(this.nextRow+ue>this.height)return H("LineAtlas out of space"),null;0===C.length&&C.push(1);let de=0;for(let te=0;te<C.length;te++)C[te]<0&&(H("Negative value is found in line dasharray, replacing values with 0"),C[te]=0),de+=C[te];if(0!==de){const le=this.width/de,ue=this.getDashRanges(C,this.width,le);ce?this.addRoundDash(ue,le,he):this.addRegularDash(ue,"square"===te?.5*le:0)}const _e=this.nextRow+he;this.nextRow+=ue;const ye={tl:[_e,he],br:[de,0]};return this.positions[le]=ye,ye}}Rs(Lw,"LineAtlas");const aS=1*xy;class Ow{constructor(C){const te={},le=[];for(const ce in C){const he=C[ce],ue=te[ce]={};for(const C in he.glyphs){const te=he.glyphs[+C];if(!te||0===te.bitmap.width||0===te.bitmap.height)continue;const ce=te.metrics.localGlyph?aS:1,de={x:0,y:0,w:te.bitmap.width+2*ce,h:te.bitmap.height+2*ce};le.push(de),ue[C]=de}}const{w:ce,h:he}=K_(le),ue=new Qp({width:ce||1,height:he||1});for(const le in C){const ce=C[le];for(const C in ce.glyphs){const he=ce.glyphs[+C];if(!he||0===he.bitmap.width||0===he.bitmap.height)continue;const de=te[le][C],_e=he.metrics.localGlyph?aS:1;Qp.copy(he.bitmap,ue,{x:0,y:0},{x:de.x+_e,y:de.y+_e},he.bitmap)}}this.image=ue,this.positions=te}}Rs(Ow,"GlyphAtlas");class Bw{constructor(C){this.tileID=new qu(C.tileID.overscaledZ,C.tileID.wrap,C.tileID.canonical.z,C.tileID.canonical.x,C.tileID.canonical.y),this.tileZoom=C.tileZoom,this.uid=C.uid,this.zoom=C.zoom,this.canonical=C.tileID.canonical,this.pixelRatio=C.pixelRatio,this.tileSize=C.tileSize,this.source=C.source,this.scope=C.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=C.showCollisionBoxes,this.collectResourceTiming=!!C.collectResourceTiming,this.promoteId=C.promoteId,this.isSymbolTile=C.isSymbolTile,this.tileTransform=Pg(C.tileID.canonical,C.projection),this.projection=C.projection,this.brightness=C.brightness,this.extraShadowCaster=!!C.extraShadowCaster}parse(C,te,le,ce,he){this.status="parsing",this.data=C,this.collisionBoxArray=new al;const ue=new dm(Object.keys(C.layers).sort()),de=new Qm(this.tileID,this.promoteId);de.bucketLayerIDs=[];const _e={},ye=new Lw(256,256),ve={featureIndex:de,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:ye,availableImages:le,brightness:this.brightness},Se=te.familiesBySource[this.source];for(const te in Se){const ce=C.layers[te];if(!ce)continue;let he=!1,ye=!1,Me=!1;for(const C of Se[te])"symbol"===C[0].type?he=!0:ye=!0,C[0].is3D()&&"model"!==C[0].type&&(Me=!0);if(this.extraShadowCaster&&!Me)continue;if(!0===this.isSymbolTile&&!he)continue;if(!1===this.isSymbolTile&&!ye)continue;1===ce.version&&H(`Vector tile source "${this.source}" layer "${te}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Ae=ue.encode(te),Ce=[];for(let C=0;C<ce.length;C++){const le=ce.feature(C),he=de.getId(le,te);Ce.push({feature:le,id:he,index:C,sourceLayerIndex:Ae})}for(const C of Se[te]){const te=C[0];(!this.extraShadowCaster||te.is3D()&&"model"!==te.type)&&(void 0!==this.isSymbolTile&&"symbol"===te.type!==this.isSymbolTile||te.minzoom&&this.zoom<Math.floor(te.minzoom)||te.maxzoom&&this.zoom>=te.maxzoom||"none"!==te.visibility&&(Fw(C,this.zoom,ve.brightness,le),(_e[te.id]=te.createBucket({index:de.bucketLayerIDs.length,layers:C,zoom:this.zoom,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Ae,sourceID:this.source,projection:this.projection.spec})).populate(Ce,ve,this.tileID.canonical,this.tileTransform),de.bucketLayerIDs.push(C.map((C=>C.id)))))}}let Me,Ae,Ce,Oe;ye.trim();const Ne={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},_=()=>{if(Me)return this.status="done",he(Me);if(this.extraShadowCaster)this.status="done",he(null,{buckets:L(_e).filter((C=>!C.isEmpty())),featureIndex:de,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:ve.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(Ae&&Ce&&Oe){const C=new Ow(Ae),te=new eg(Ce,Oe);for(const ce in _e){const he=_e[ce];he instanceof Nx?(Fw(he.layers,this.zoom,ve.brightness,le),vg(he,Ae,C.positions,Ce,te.iconPositions,this.showCollisionBoxes,le,this.tileID.canonical,this.tileZoom,this.projection,this.brightness)):he.hasPattern&&(he instanceof Ey||he instanceof jf||he instanceof vb)&&(Fw(he.layers,this.zoom,ve.brightness,le),he.addFeatures(ve,this.tileID.canonical,te.patternPositions,le,this.tileTransform,this.brightness))}this.status="done",he(null,{buckets:L(_e).filter((C=>!C.isEmpty())),featureIndex:de,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:C.image,lineAtlas:ye,imageAtlas:te,brightness:ve.brightness})}};if(!this.extraShadowCaster){const C=q(ve.glyphDependencies,(C=>Object.keys(C).map(Number)));Object.keys(C).length?ce.send("getGlyphs",{uid:this.uid,stacks:C,scope:this.scope},((C,te)=>{Me||(Me=C,Ae=te,_())}),void 0,!1,Ne):Ae={};const te=Object.keys(ve.iconDependencies);te.length?ce.send("getImages",{icons:te,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},((C,te)=>{Me||(Me=C,Ce=te,_())}),void 0,!1,Ne):Ce={};const le=Object.keys(ve.patternDependencies);le.length?ce.send("getImages",{icons:le,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},((C,te)=>{Me||(Me=C,Oe=te,_())}),void 0,!1,Ne):Oe={}}_()}}function Fw(C,te,le,ce){const he=new oa(te,{brightness:le});for(const te of C)te.recalculate(he,ce)}class Nw{constructor(C){this.entries={},this.scheduler=C}request(C,te,le,ce){const he=this.entries[C]=this.entries[C]||{callbacks:[]};if(he.result){const[C,le]=he.result;return this.scheduler?this.scheduler.add((()=>{ce(C,le)}),te):ce(C,le),()=>{}}return he.callbacks.push(ce),he.cancel||(he.cancel=le(((le,ce)=>{he.result=[le,ce];for(const C of he.callbacks)this.scheduler?this.scheduler.add((()=>{C(le,ce)}),te):C(le,ce);setTimeout((()=>delete this.entries[C]),3e3)}))),()=>{he.result||(he.callbacks=he.callbacks.filter((C=>C!==ce)),he.callbacks.length||(he.cancel(),delete this.entries[C]))}}}function Uw(C,le,ce){const he=JSON.stringify(C.request);return C.data&&((this||te).deduped.entries[he]={result:[null,C.data]}),(this||te).deduped.request(he,{type:"parseTile",isSymbolTile:C.isSymbolTile,zoom:C.tileZoom},(te=>{const le=Te(C.request,((C,le,he,ue)=>{C?te(C):le&&te(null,{vectorTile:ce?void 0:new __(new J_(le)),rawData:le,cacheControl:he,expires:ue})}));return()=>{le.cancel(),te()}}),le)}class Vw extends zt{constructor(C,te,le,ce){if(super(),this.id=C,this.dispatcher=le,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,k(this,O(te,["url","scheme","tileSize","promoteId"])),this._options=k({type:"vector"},te),this._collectResourceTiming=!!te.collectResourceTiming,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(ce),this._tileWorkers={},this._deduped=new Nw}load(C){this._loaded=!1,this.fire(new It("dataloading",{dataType:"source"}));const te=Array.isArray(this.map._language)?this.map._language.join():this.map._language,le=this.map._worldview;this._tileJSONRequest=Dw(this._options,this.map._requestManager,te,le,((ce,he)=>{this._tileJSONRequest=null,this._loaded=!0,ce?(te&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${te}`),le&&2!==le.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${le}`),this.fire(new Ct(ce))):he&&(k(this,he),he.bounds&&(this.tileBounds=new Rw(he.bounds,this.minzoom,this.maxzoom)),Pt(he.tiles,this.map._requestManager._customAccessToken),this.fire(new It("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new It("data",{dataType:"source",sourceDataType:"content"}))),C&&C(ce)}))}loaded(){return this._loaded}hasTile(C){return!this.tileBounds||this.tileBounds.contains(C.canonical)}onAdd(C){this.map=C,this.load()}reload(){this.cancelTileJSONRequest();const C=va(this.id,this.scope);this.load((()=>this.map.style.clearSource(C)))}setTiles(C){return this._options.tiles=C,this.reload(),this}setUrl(C){return this.url=C,this._options.url=C,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return k({},this._options)}loadTile(C,te){const le=this.map._requestManager.normalizeTileURL(C.tileID.canonical.url(this.tiles,this.scheme)),ce={request:this.map._requestManager.transformRequest(le,st.Tile),data:void 0,uid:C.uid,tileID:C.tileID,tileZoom:C.tileZoom,zoom:C.tileID.overscaledZ,tileSize:this.tileSize*C.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:bi.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:C.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:C.isExtraShadowCaster};if(ce.request.collectResourceTiming=this._collectResourceTiming,C.actor&&"expired"!==C.state)"loading"===C.state?C.reloadCallback=te:C.request=C.actor.send("reloadTile",ce,n.bind(this));else if(C.actor=this._tileWorkers[le]=this._tileWorkers[le]||this.dispatcher.getActor(),this.dispatcher.ready)C.request=C.actor.send("loadTile",ce,n.bind(this),void 0,!0);else{const te=Uw.call({deduped:this._deduped},ce,((te,le)=>{te||!le?n.call(this,te):(ce.data={cacheControl:le.cacheControl,expires:le.expires,rawData:le.rawData.slice(0)},C.actor&&C.actor.send("loadTile",ce,n.bind(this),void 0,!0))}),!0);C.request={cancel:te}}function n(le,ce){return delete C.request,C.aborted?te(null):le&&404!==le.status?te(le):(ce&&ce.resourceTiming&&(C.resourceTiming=ce.resourceTiming),this.map._refreshExpiredTiles&&ce&&C.setExpiryData(ce),C.loadVectorData(ce,this.map.painter),ge(this.dispatcher),te(null),void(C.reloadCallback&&(this.loadTile(C,C.reloadCallback),C.reloadCallback=null)))}}abortTile(C){C.request&&(C.request.cancel(),delete C.request),C.actor&&C.actor.send("abortTile",{uid:C.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(C){C.actor&&C.actor.send("removeTile",{uid:C.uid,type:this.type,source:this.id,scope:this.scope}),C.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class jw extends zt{constructor(C,te,le,ce){super(),this.id=C,this.dispatcher=le,this.setEventedParent(ce),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=k({type:"raster"},te),k(this,O(te,["url","scheme","tileSize"]))}load(C){this._loaded=!1,this.fire(new It("dataloading",{dataType:"source"})),this._tileJSONRequest=Dw(this._options,this.map._requestManager,null,null,((te,le)=>{this._tileJSONRequest=null,this._loaded=!0,te?this.fire(new Ct(te)):le&&(k(this,le),le.bounds&&(this.tileBounds=new Rw(le.bounds,this.minzoom,this.maxzoom)),Pt(le.tiles),this.fire(new It("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new It("data",{dataType:"source",sourceDataType:"content"}))),C&&C(te)}))}loaded(){return this._loaded}onAdd(C){this.map=C,this.load()}reload(){this.cancelTileJSONRequest();const C=va(this.id,this.scope);this.load((()=>this.map.style.clearSource(C)))}setTiles(C){return this._options.tiles=C,this.reload(),this}setUrl(C){return this.url=C,this._options.url=C,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return k({},this._options)}hasTile(C){return!this.tileBounds||this.tileBounds.contains(C.canonical)}loadTile(C,te){const le=bi.devicePixelRatio>=2,ce=this.map._requestManager.normalizeTileURL(C.tileID.canonical.url(this.tiles,this.scheme),le,this.tileSize);C.request=Ie(this.map._requestManager.transformRequest(ce,st.Tile),((le,ce,he,ue)=>(delete C.request,C.aborted?(C.state="unloaded",te(null)):le?(C.state="errored",te(le)):ce?(this.map._refreshExpiredTiles&&C.setExpiryData({cacheControl:he,expires:ue}),C.setTexture(ce,this.map.painter),C.state="loaded",ge(this.dispatcher),void te(null)):te(null))))}abortTile(C,te){C.request&&(C.request.cancel(),delete C.request),te()}unloadTile(C,te){C.texture&&C.texture instanceof My?(C.destroy(!0),C.texture&&C.texture instanceof My&&this.map.painter.saveTileTexture(C.texture)):C.destroy(),te()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}function Gw(){return null!=UI.workerClass?new UI.workerClass:new le.Worker(UI.workerUrl)}const lS="mapboxgl_preloaded_worker_pool";class Zw{constructor(){this.active={}}acquire(C){if(!this.workers)for(this.workers=[];this.workers.length<Zw.workerCount;)this.workers.push(new Gw);return this.active[C]=!0,this.workers.slice()}release(C){delete this.active[C],this.workers&&0===this.numActive()&&(this.workers.forEach((C=>{C.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[lS]}numActive(){return Object.keys(this.active).length}}let cS;function Ww(){return cS||(cS=new Zw),cS}Zw.workerCount=2;let hS,ES,FS,VS=null;function Jw(){return Q()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:ES||de.DRACO_URL}const iM=5123,rM=5126,pM={5120:Int8Array,5121:Uint8Array,5122:Int16Array,[iM]:Uint16Array,5125:Uint32Array,[rM]:Float32Array},fM={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",[iM]:"DT_UINT16",5125:"DT_UINT32",[rM]:"DT_FLOAT32"},gM={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function nT(C,te,le){const ce=le.json.bufferViews.length,he=le.buffers.length;te.bufferView=ce,le.json.bufferViews[ce]={buffer:he,byteLength:C.byteLength},le.buffers[he]=C}const SM="KHR_draco_mesh_compression";function sT(C,te){const le=C.extensions&&C.extensions[SM];if(!le)return;const ce=new FS.Decoder,he=uT(te,le.bufferView),ue=new FS.Mesh;if(!ce.DecodeArrayToMesh(he,he.byteLength,ue))throw new Error("Failed to decode Draco mesh");const de=te.json.accessors[C.indices],_e=pM[de.componentType],ye=de.count*_e.BYTES_PER_ELEMENT,ve=FS._malloc(ye);_e===Uint16Array?ce.GetTrianglesUInt16Array(ue,ye,ve):ce.GetTrianglesUInt32Array(ue,ye,ve),nT(FS.memory.buffer.slice(ve,ve+ye),de,te),FS._free(ve);for(const he of Object.keys(le.attributes)){const de=ce.GetAttributeByUniqueId(ue,le.attributes[he]),_e=te.json.accessors[C.attributes[he]],ye=fM[_e.componentType],ve=_e.count*gM[_e.type]*pM[_e.componentType].BYTES_PER_ELEMENT,Se=FS._malloc(ve);ce.GetAttributeDataArrayForAllPoints(ue,de,FS[ye],ve,Se),nT(FS.memory.buffer.slice(Se,Se+ve),_e,te),FS._free(Se)}ce.destroy(),ue.destroy(),delete C.extensions[SM]}const RM=1179937895,NM=new TextDecoder("utf8");function cT(C,te){return new URL(C,te).href}function hT(C,te,le,ce){return fetch(cT(C.uri,ce)).then((C=>C.arrayBuffer())).then((C=>{te.buffers[le]=C}))}function uT(C,te){const le=C.json.bufferViews[te];return new Uint8Array(C.buffers[le.buffer],le.byteOffset||0,le.byteLength)}function dT(C,te,ce,he){if(C.uri){const ue=cT(C.uri,he);return fetch(ue).then((C=>C.blob())).then((C=>le.createImageBitmap(C))).then((C=>{te.images[ce]=C}))}if(void 0!==C.bufferView){const he=uT(te,C.bufferView),ue=new le.Blob([he],{type:C.mimeType});return le.createImageBitmap(ue).then((C=>{te.images[ce]=C}))}}function pT(C,te=0,le){const ce={json:null,images:[],buffers:[]};if(new Uint32Array(C,te,1)[0]===RM){const le=new Uint32Array(C,te);let he=2;const ue=(le[he++]>>2)-3,de=le[he++]>>2;if(he++,ce.json=JSON.parse(NM.decode(le.subarray(he,he+de))),he+=de,he<ue){const ue=le[he++];he++;const de=te+(he<<2);ce.buffers[0]=C.slice(de,de+ue)}}else ce.json=JSON.parse(NM.decode(new Uint8Array(C,te)));const{buffers:he,images:ue,meshes:de,extensionsUsed:_e}=ce.json;let ye=Promise.resolve();if(he){const C=[];for(let te=0;te<he.length;te++){const ue=he[te];ue.uri?C.push(hT(ue,ce,te,le)):ce.buffers[te]||(ce.buffers[te]=null)}ye=Promise.all(C)}return ye.then((()=>{const C=[],te=_e&&_e.includes(SM);if(te&&C.push(function(){if(!FS)return hS||(hS=function(C){let te,le=null;function r(){te=new Uint8Array(le.buffer)}function n(){throw new Error("Unexpected Draco error.")}const ce={a:{a:n,d:function(C,le,ce){return te.copyWithin(C,le,le+ce)},c:function(C){const ce=te.length,he=Math.max(C>>>0,Math.ceil(1.2*ce)),ue=Math.ceil((he-ce)/65536);try{return le.grow(ue),r(),!0}catch(C){return!1}},b:n}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(C,ce):C.then((C=>C.arrayBuffer())).then((C=>WebAssembly.instantiate(C,ce)))).then((C=>{const{Rb:ce,Qb:he,P:ue,T:de,X:_e,Ja:ye,La:ve,Qa:Se,Va:Me,Wa:Ae,eb:Ce,jb:Oe,f:Ne,e:je,yb:Ge,zb:Ze,Ab:qe,Bb:$e,Db:He,Gb:We}=C.instance.exports;le=je;const Xe=(()=>{let C=0,le=0,ue=0,de=0;return _e=>{ue&&(ce(de),ce(C),le+=ue,ue=C=0),C||(le+=128,C=he(le));const ye=_e.length+7&-8;let ve=C;ye>=le&&(ue=ye,ve=de=he(ye));for(let C=0;C<_e.length;C++)te[ve+C]=_e[C];return ve}})();return r(),Ne(),{memory:je,_free:ce,_malloc:he,Mesh:class{constructor(){this.ptr=ue()}destroy(){de(this.ptr)}},Decoder:class{constructor(){this.ptr=ye()}destroy(){Oe(this.ptr)}DecodeArrayToMesh(C,te,le){const ce=Xe(C),he=ve(this.ptr,ce,te,le.ptr);return!!_e(he)}GetAttributeByUniqueId(C,te){return{ptr:Se(this.ptr,C.ptr,te)}}GetTrianglesUInt16Array(C,te,le){Me(this.ptr,C.ptr,te,le)}GetTrianglesUInt32Array(C,te,le){Ae(this.ptr,C.ptr,te,le)}GetAttributeDataArrayForAllPoints(C,te,le,ce,he){Ce(this.ptr,C.ptr,te.ptr,le,ce,he)}},DT_INT8:Ge(),DT_UINT8:Ze(),DT_INT16:qe(),DT_UINT16:$e(),DT_UINT32:He(),DT_FLOAT32:We()}}))}(fetch(Jw())),hS.then((C=>{FS=C,hS=void 0})))}()),ue)for(let te=0;te<ue.length;te++)C.push(dT(ue[te],ce,te,le));return(C.length?Promise.all(C):Promise.resolve()).then((()=>{if(te&&de)for(const{primitives:C}of de)for(const te of C)sT(te,ce);return ce}))}))}function fT(C){return fetch(C).then((C=>C.arrayBuffer())).then((te=>pT(te,0,C)))}class mT{constructor(C,te,le){if(this.triangleCount=te.length/3,this.min=new je(0,0),this.max=new je(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],0===this.triangleCount||0===C.length||0===le)return;const ce=C.map((C=>C.x)),he=C.map((C=>C.y));this.min=new je(Math.min(...ce),Math.min(...he)),this.max=new je(Math.max(...ce),Math.max(...he));const ue=this.max.sub(this.min);ue.x=Math.max(ue.x,1),ue.y=Math.max(ue.y,1);const de=Math.max(ue.x,ue.y)/le;this.cellsX=Math.max(1,Math.ceil(ue.x/de)),this.cellsY=Math.max(1,Math.ceil(ue.y/de)),this.xScale=1/de,this.yScale=1/de;const _e=[];for(let le=0;le<this.triangleCount;le++){const ce=C[te[3*le+0]].sub(this.min),he=C[te[3*le+1]].sub(this.min),ue=C[te[3*le+2]].sub(this.min),ye=_T(Math.floor(Math.min(ce.x,he.x,ue.x)),this.xScale,this.cellsX),ve=_T(Math.floor(Math.max(ce.x,he.x,ue.x)),this.xScale,this.cellsX),Se=_T(Math.floor(Math.min(ce.y,he.y,ue.y)),this.yScale,this.cellsY),Me=_T(Math.floor(Math.max(ce.y,he.y,ue.y)),this.yScale,this.cellsY),Ae=new je(0,0),Ce=new je(0,0),Oe=new je(0,0),Ne=new je(0,0);for(let C=Se;C<=Me;++C){Ae.y=Ce.y=C*de,Oe.y=Ne.y=(C+1)*de;for(let te=ye;te<=ve;++te)Ae.x=Oe.x=te*de,Ce.x=Ne.x=(te+1)*de,(Lp(ce,he,ue,Ae,Ce,Ne)||Lp(ce,he,ue,Ae,Ne,Oe))&&_e.push({cellIdx:C*this.cellsX+te,triIdx:le})}}if(0===_e.length)return;_e.sort(((C,te)=>C.cellIdx-te.cellIdx||C.triIdx-te.triIdx));let ye=0;for(;ye<_e.length;){const C=_e[ye].cellIdx,te={start:this.payload.length,len:0};for(;ye<_e.length&&_e[ye].cellIdx===C;)++te.len,this.payload.push(_e[ye++].triIdx);this.cells[C]=te}}query(C,te,le){if(0===this.triangleCount||0===this.cells.length)return;if(C.x>this.max.x||this.min.x>te.x)return;if(C.y>this.max.y||this.min.y>te.y)return;this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8)));for(let C=0;C<this.lookup.length;C++)this.lookup[C]=0;const ce=_T(C.x-this.min.x,this.xScale,this.cellsX),he=_T(te.x-this.min.x,this.xScale,this.cellsX),ue=_T(C.y-this.min.y,this.yScale,this.cellsY),de=_T(te.y-this.min.y,this.yScale,this.cellsY);for(let C=ue;C<=de;C++)for(let te=ce;te<=he;te++){const ce=this.cells[C*this.cellsX+te];if(ce)for(let C=0;C<ce.len;C++){const te=this.payload[ce.start+C],he=Math.floor(te/8),ue=1<<te%8;if(!(this.lookup[he]&ue)&&(this.lookup[he]|=ue,le.push(te),le.length===this.triangleCount))return}}}}function _T(C,te,le){return Math.max(0,Math.min(le-1,Math.floor(C*te)))}function gT(C,te){const le=C.json.bufferViews[te.bufferView];return new(0,pM[te.componentType])(C.buffers[le.buffer],(te.byteOffset||0)+(le.byteOffset||0),te.count*gM[te.type])}function yT(C,te,le){const ce=C.indices,he=C.attributes,ue={};ue.indexArray=new Wa;const de=te.json.accessors[ce],_e=de.count/3;ue.indexArray.reserve(_e);const ye=gT(te,de);for(let C=0;C<_e;C++)ue.indexArray.emplaceBack(ye[3*C],ye[3*C+1],ye[3*C+2]);ue.indexArray._trim(),ue.vertexArray=new tl;const ve=te.json.accessors[he.POSITION];ue.vertexArray.reserve(ve.count);const Se=gT(te,ve);for(let C=0;C<ve.count;C++)ue.vertexArray.emplaceBack(Se[3*C],Se[3*C+1],Se[3*C+2]);if(ue.vertexArray._trim(),ue.aabb=new ed(ve.min,ve.max),ue.centroid=function(C,te){const le=[0,0,0],ce=C.length;if(ce>0){for(let he=0;he<ce;he++){const ce=3*C[he];le[0]+=te[ce],le[1]+=te[ce+1],le[2]+=te[ce+2]}le[0]/=ce,le[1]/=ce,le[2]/=ce}return le}(ye,Se),void 0!==he.COLOR_0){const C=te.json.accessors[he.COLOR_0],le=gM[C.type];if(C.componentType===rM){ue.colorArray=3===le?new tl:new ka,ue.colorArray.reserve(C.count);const ce=gT(te,C);if(3===le)for(let te=0;te<C.count;te++)ue.colorArray.emplaceBack(ce[3*te],ce[3*te+1],ce[3*te+2]);else for(let te=0;te<C.count;te++)ue.colorArray.emplaceBack(ce[4*te],ce[4*te+1],ce[4*te+2],ce[4*te+3]);ue.colorArray._trim()}else if(C.componentType===iM&&4===le){ue.colorArray=new ka,ue.colorArray.resize(C.count);const le=gT(te,C),ce=1/65535,he=ue.colorArray.float32;for(let C=0;C<4*le.length;++C)he[C]=le[C]*ce}else H(`glTF color buffer parsing for accessor ${JSON.stringify(C)} is not supported`)}if(void 0!==he.NORMAL){ue.normalArray=new tl;const C=te.json.accessors[he.NORMAL];ue.normalArray.reserve(C.count);const le=gT(te,C);for(let te=0;te<C.count;te++)ue.normalArray.emplaceBack(le[3*te],le[3*te+1],le[3*te+2]);ue.normalArray._trim()}if(void 0!==he.TEXCOORD_0&&le.length>0){ue.texcoordArray=new il;const C=te.json.accessors[he.TEXCOORD_0];ue.texcoordArray.reserve(C.count);const le=gT(te,C);for(let te=0;te<C.count;te++)ue.texcoordArray.emplaceBack(le[2*te],le[2*te+1]);ue.texcoordArray._trim()}const Me=C.material;return ue.material=function(C,te){const{emissiveFactor:le=[0,0,0],alphaMode:ce="OPAQUE",alphaCutoff:he=.5,normalTexture:ue,occlusionTexture:de,emissiveTexture:_e,doubleSided:ye}=C,{baseColorFactor:ve=[1,1,1,1],metallicFactor:Se=1,roughnessFactor:Me=1,baseColorTexture:Ae,metallicRoughnessTexture:Ce}=C.pbrMetallicRoughness||{};return{pbrMetallicRoughness:{baseColorFactor:new qr(...ve),metallicFactor:Se,roughnessFactor:Me,baseColorTexture:Ae?te[Ae.index]:void 0,metallicRoughnessTexture:Ce?te[Ce.index]:void 0},doubleSided:ye,emissiveFactor:le,alphaMode:ce,alphaCutoff:he,normalTexture:ue?te[ue.index]:void 0,occlusionTexture:de?te[de.index]:void 0,emissionTexture:_e?te[_e.index]:void 0,defined:void 0===C.defined}}(void 0!==Me?te.json.materials[Me]:{defined:!1},le),void 0!==he._FEATURE_RGBA4444&&(ue.featureData=new Uint32Array(gT(te,te.json.accessors[he._FEATURE_RGBA4444]).buffer)),ue}function xT(C,te,le){const{matrix:ce,rotation:he,translation:ue,scale:de,mesh:_e,extras:ye,children:ve}=C,Se={};if(Se.matrix=ce||ld.fromRotationTranslationScale([],he||[0,0,0,1],ue||[0,0,0],de||[1,1,1]),void 0!==_e){Se.meshes=le[_e];const C=Se.anchor=[0,0];for(const te of Se.meshes){const{min:le,max:ce}=te.aabb;C[0]+=le[0]+ce[0],C[1]+=le[1]+ce[1]}C[0]=Math.floor(C[0]/Se.meshes.length/2),C[1]=Math.floor(C[1]/Se.meshes.length/2)}if(ye&&(ye.id&&(Se.id=ye.id),ye.lights&&(Se.lights=function(C){if(!C.length)return[];const te=function(C){const te=atob(C),le=new Uint8Array(te.length);for(let C=0;C<te.length;C++)le[C]=te.codePointAt(C);return le}(C),le=[],ce=te.length/24,he=new Uint16Array(te.buffer),ue=new Float32Array(te.buffer);for(let C=0;C<ce;C++){const te=he[2*C*6]/30,ce=he[2*C*6+1]/30,de=he[2*C*6+10]/100,_e=ue[6*C+1],ye=ue[6*C+2],ve=ue[6*C+3],Se=ue[6*C+4],Me=ve-_e,Ae=Se-ye,Ce=Math.hypot(Me,Ae);le.push({pos:[_e+.5*Me,ye+.5*Ae,ce],normal:[Ae/Ce,-Me/Ce,0],width:Ce,height:te,depth:de,points:[_e,ye,ve,Se]})}return le}(ye.lights))),ve){const C=[];for(const ce of ve)C.push(xT(te.json.nodes[ce],te,le));Se.children=C}return Se}function vT(C){if(0===C.vertices.length||0===C.indices.length)return null;const[te,le]=[C.vertices[0].clone(),C.vertices[0].clone()];for(let ce=1;ce<C.vertices.length;++ce){const he=C.vertices[ce];te.x=Math.min(te.x,he.x),te.y=Math.min(te.y,he.y),le.x=Math.max(le.x,he.x),le.y=Math.max(le.y,he.y)}const ce=Math.ceil(Math.max(le.x-te.x,le.y-te.y)/256),he=Math.max(8,ce),ue=new mT(C.vertices,C.indices,he);return{vertices:C.vertices,indices:C.indices,grid:ue,min:te,max:le}}function bT(C){if(!C.extras||!C.extras.ground)return null;const te=C.extras.ground;if(!te||!Array.isArray(te)||0===te.length)return null;const le=te[0];if(!le||!Array.isArray(le)||0===le.length)return null;const ce=[];for(const C of le){if(!Array.isArray(C)||2!==C.length)continue;const te=C[0],le=C[1];"number"==typeof te&&"number"==typeof le&&ce.push(new je(te,le))}if(ce.length<3)return null;ce.length>1&&ce[ce.length-1].equals(ce[0])&&ce.pop();let he=0;for(let C=0;C<ce.length;C++){const te=ce[C],le=ce[(C+1)%ce.length],ue=ce[(C+2)%ce.length];he+=(te.x-le.x)*(ue.y-le.y)-(ue.x-le.x)*(te.y-le.y)}he>0&&ce.reverse();const ue=xm(ce.flatMap((C=>[C.x,C.y])),[]);return 0===ue.length?null:{vertices:ce,indices:ue}}function wT(C){const te=[],le=[];let ce=0;for(const he of C){ce=te.length;const C=he.vertexArray.float32,ue=he.indexArray.uint16;for(let le=0;le<he.vertexArray.length;le++)te.push(new je(C[3*le+0],C[3*le+1]));for(let C=0;C<3*he.indexArray.length;C++)le.push(ue[C]+ce)}if(le.length%3!=0)return null;for(let C=0;C<le.length;C+=3){const ce=te[le[C+0]],he=te[le[C+1]],ue=te[le[C+2]];(ce.x-he.x)*(ue.y-he.y)-(ue.x-he.x)*(ce.y-he.y)>0&&([le[C+1],le[C+2]]=[le[C+2],le[C+1]])}return{vertices:te,indices:le}}function TT(C){const te=function(C,te){const ce=[],he=le.WebGL2RenderingContext;if(C.json.textures)for(const le of C.json.textures){const ue={magFilter:he.LINEAR,minFilter:he.NEAREST,wrapS:he.REPEAT,wrapT:he.REPEAT};void 0!==le.sampler&&Object.assign(ue,C.json.samplers[le.sampler]),ce.push({image:te[le.source],sampler:ue,uploaded:!1})}return ce}(C,C.images),ce=function(C,te){const le=[];for(const ce of C.json.meshes){const he=[];for(const le of ce.primitives)he.push(yT(le,C,te));le.push(he)}return le}(C,te),{scenes:he,scene:ue,nodes:de}=C.json,_e=he?he[ue||0].nodes:de,ye=[];for(const te of _e)ye.push(xT(de[te],C,ce));return function(C,te,le){const ce={},he=new Set;for(let ue=0;ue<C.length;ue++){const C=le[te[ue]];if(!C.extras)continue;const de=C.extras["mapbox:footprint:version"],_e=C.extras["mapbox:footprint:id"];(de||_e)&&he.add(ue),"1.0.0"===de&&_e&&(ce[_e]=ue)}for(let ue=0;ue<C.length;ue++){if(he.has(ue))continue;const de=C[ue],_e=le[te[ue]];if(!_e.extras)continue;let ye=null;de.id in ce&&(ye=wT(C[ce[de.id]].meshes)),ye||(ye=bT(_e)),ye&&(de.footprint=vT(ye))}if(he.size>0){const te=Array.from(he.values()).sort(((C,te)=>C-te));for(let le=te.length-1;le>=0;le--)C.splice(te[le],1)}}(ye,_e,C.json.nodes),ye}function ET(C){C.heightmap=new Float32Array(4096),C.heightmap.fill(-1);const te=C.vertexArray.float32,le=C.aabb.min[0]-1,ce=C.aabb.min[1]-1,he=Xb/(C.aabb.max[0]-le+2),ue=Xb/(C.aabb.max[1]-ce+2);for(let de=0;de<te.length;de+=3){const _e=te[de+2],ye=(te[de+0]-le)*he|0,ve=(te[de+1]-ce)*ue|0;_e>C.heightmap[ve*Xb+ye]&&(C.heightmap[ve*Xb+ye]=_e)}}function MT(C,te){const le={};le.indexArray=new Wa,le.indexArray.reserve(4*C.length),le.vertexArray=new tl,le.vertexArray.reserve(10*C.length),le.colorArray=new ka,le.vertexArray.reserve(10*C.length);let ce=0;for(const he of C){const C=Math.min(10,Math.max(4,1.3*he.height))*te,ue=[-he.normal[1],he.normal[0],0],de=Math.min(.29,.1*he.width/he.depth),_e=he.width-2*he.depth*te*(de+.01),ye=Zd.scaleAndAdd([],he.pos,ue,_e/2),ve=Zd.scaleAndAdd([],he.pos,ue,-_e/2),Se=[ye[0],ye[1],ye[2]+he.height],Me=[ve[0],ve[1],ve[2]+he.height],Ae=Zd.scaleAndAdd([],he.normal,ue,de);Zd.scale(Ae,Ae,C);const Ce=Zd.scaleAndAdd([],he.normal,ue,-de);Zd.scale(Ce,Ce,C),Zd.add(Ae,ye,Ae),Zd.add(Ce,ve,Ce),ye[2]+=.1,ve[2]+=.1,le.vertexArray.emplaceBack(Ae[0],Ae[1],Ae[2]),le.vertexArray.emplaceBack(Ce[0],Ce[1],Ce[2]),le.vertexArray.emplaceBack(ye[0],ye[1],ye[2]),le.vertexArray.emplaceBack(ve[0],ve[1],ve[2]),le.vertexArray.emplaceBack(Se[0],Se[1],Se[2]),le.vertexArray.emplaceBack(Me[0],Me[1],Me[2]),le.vertexArray.emplaceBack(ye[0],ye[1],ye[2]),le.vertexArray.emplaceBack(ve[0],ve[1],ve[2]),le.vertexArray.emplaceBack(Ae[0],Ae[1],Ae[2]),le.vertexArray.emplaceBack(Ce[0],Ce[1],Ce[2]);const Oe=_e/C/2;le.colorArray.emplaceBack(-Oe-de,-1,Oe,.8),le.colorArray.emplaceBack(Oe+de,-1,Oe,.8),le.colorArray.emplaceBack(-Oe,0,Oe,1.3),le.colorArray.emplaceBack(Oe,0,Oe,1.3),le.colorArray.emplaceBack(Oe+de,-.8,Oe,.7),le.colorArray.emplaceBack(Oe+de,-.8,Oe,.7),le.colorArray.emplaceBack(0,0,Oe,1.3),le.colorArray.emplaceBack(0,0,Oe,1.3),le.colorArray.emplaceBack(Oe+de,-1.2,Oe,.8),le.colorArray.emplaceBack(Oe+de,-1.2,Oe,.8),le.indexArray.emplaceBack(6+ce,4+ce,8+ce),le.indexArray.emplaceBack(7+ce,9+ce,5+ce),le.indexArray.emplaceBack(0+ce,1+ce,2+ce),le.indexArray.emplaceBack(1+ce,3+ce,2+ce),ce+=10}const he={defined:!0,emissiveFactor:[0,0,0]},ue={};return ue.baseColorFactor=qr.white,he.pbrMetallicRoughness=ue,le.material=he,le.aabb=new ed([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),le}Rs(mT,"TriangleGridIndex");const VM={vector:Vw,raster:jw,"raster-dem":class extends jw{constructor(C,te,le,ce){super(C,te,le,ce),this.type="raster-dem",this.maxzoom=22,this._options=k({type:"raster-dem"},te),this.encoding=te.encoding||"mapbox"}loadTile(C,te){const ce=this.map._requestManager.normalizeTileURL(C.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function n(le,ce){le&&(C.state="errored",te(le)),ce&&(C.dem=ce,C.dem.onDeserialize(),C.needsHillshadePrepare=!0,C.needsDEMTextureUpload=!0,C.state="loaded",te(null))}C.request=Ie(this.map._requestManager.transformRequest(ce,st.Tile),function(ce,he,ue,de){if(delete C.request,C.aborted)C.state="unloaded",te(null);else if(ce)C.state="errored",te(ce);else if(he){this.map._refreshExpiredTiles&&C.setExpiryData({cacheControl:ue,expires:de});const te=le.ImageBitmap&&he instanceof le.ImageBitmap&&ut(),ce=1-(he.width-((_e=he.width)<=1?1:Math.pow(2,Math.floor(Math.log(_e)/Math.LN2))))/2;ce<1||C.neighboringTiles||(C.neighboringTiles=this._getNeighboringTiles(C.tileID));const ye=te?he:bi.getImageData(he,ce),ve={uid:C.uid,coord:C.tileID,source:this.id,scope:this.scope,rawImageData:ye,encoding:this.encoding,padding:ce};C.actor&&"expired"!==C.state||(C.actor=this.dispatcher.getActor(),C.actor.send("loadDEMTile",ve,n.bind(this),void 0,!0))}var _e}.bind(this))}_getNeighboringTiles(C){const te=C.canonical,le=Math.pow(2,te.z),ce=(te.x-1+le)%le,he=0===te.x?C.wrap-1:C.wrap,ue=(te.x+1+le)%le,de=te.x+1===le?C.wrap+1:C.wrap,_e={};return _e[new qu(C.overscaledZ,he,te.z,ce,te.y).key]={backfilled:!1},_e[new qu(C.overscaledZ,de,te.z,ue,te.y).key]={backfilled:!1},te.y>0&&(_e[new qu(C.overscaledZ,he,te.z,ce,te.y-1).key]={backfilled:!1},_e[new qu(C.overscaledZ,C.wrap,te.z,te.x,te.y-1).key]={backfilled:!1},_e[new qu(C.overscaledZ,de,te.z,ue,te.y-1).key]={backfilled:!1}),te.y+1<le&&(_e[new qu(C.overscaledZ,he,te.z,ce,te.y+1).key]={backfilled:!1},_e[new qu(C.overscaledZ,C.wrap,te.z,te.x,te.y+1).key]={backfilled:!1},_e[new qu(C.overscaledZ,de,te.z,ue,te.y+1).key]={backfilled:!1}),_e}},geojson:class extends zt{constructor(C,te,le,ce){super(),this.id=C,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=le.getActor(),this.setEventedParent(ce),this._data=te.data,this._options=k({},te),this._collectResourceTiming=te.collectResourceTiming,void 0!==te.maxzoom&&(this.maxzoom=te.maxzoom),te.type&&(this.type=te.type),te.attribution&&(this.attribution=te.attribution),this.promoteId=te.promoteId;const he=Mn/this.tileSize;this.workerOptions=k({source:this.id,scope:this.scope,cluster:te.cluster||!1,geojsonVtOptions:{buffer:(void 0!==te.buffer?te.buffer:128)*he,tolerance:(void 0!==te.tolerance?te.tolerance:.375)*he,extent:Mn,maxZoom:this.maxzoom,lineMetrics:te.lineMetrics||!1,generateId:te.generateId||!1},superclusterOptions:{maxZoom:void 0!==te.clusterMaxZoom?te.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,te.clusterMinPoints||2),extent:Mn,radius:(void 0!==te.clusterRadius?te.clusterRadius:50)*he,log:!1,generateId:te.generateId||!1},clusterProperties:te.clusterProperties,filter:te.filter},te.workerOptions)}onAdd(C){this.map=C,this.setData(this._data)}setData(C){return this._data=C,this._updateWorkerData(),this}getClusterExpansionZoom(C,te){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:C,source:this.id,scope:this.scope},te),this}getClusterChildren(C,te){return this.actor.send("geojson.getClusterChildren",{clusterId:C,source:this.id,scope:this.scope},te),this}getClusterLeaves(C,te,le,ce){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:C,limit:te,offset:le},ce),this}_updateWorkerData(){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new It("dataloading",{dataType:"source"})),this._loaded=!1;const C=k({},this.workerOptions);C.scope=this.scope;const te=this._data;"string"==typeof te?(C.request=this.map._requestManager.transformRequest(bi.resolveURL(te),st.Source),C.request.collectResourceTiming=this._collectResourceTiming):C.data=JSON.stringify(te),this._pendingLoad=this.actor.send(`${this.type}.loadData`,C,((C,te)=>{if(this._loaded=!0,this._pendingLoad=null,C)this.fire(new Ct(C));else{const C={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&te&&te.resourceTiming&&te.resourceTiming[this.id]&&(C.resourceTiming=te.resourceTiming[this.id]),this.fire(new It("data",C)),this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(),this._coalesce=!1)}))}loaded(){return this._loaded}loadTile(C,te){const le=C.actor?"reloadTile":"loadTile";C.actor=this.actor;const ce={type:this.type,uid:C.uid,tileID:C.tileID,tileZoom:C.tileZoom,zoom:C.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,scope:this.scope,pixelRatio:bi.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0};C.request=this.actor.send(le,ce,((ce,he)=>(delete C.request,C.destroy(),C.aborted?te(null):ce?te(ce):(C.loadVectorData(he,this.map.painter,"reloadTile"===le),te(null)))),void 0,"loadTile"===le)}abortTile(C){C.request&&(C.request.cancel(),delete C.request),C.aborted=!0}unloadTile(C){this.actor.send("removeTile",{uid:C.uid,type:this.type,source:this.id,scope:this.scope}),C.destroy()}onRemove(){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return k({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends Jb{constructor(C,te,le,ce){super(C,te,le,ce),this.roundZoom=!0,this.type="video",this.options=te}load(){this._loaded=!1;const C=this.options;this.urls=[];for(const te of C.urls)this.urls.push(this.map._requestManager.transformRequest(te,st.Source).url);!function(C,te){const ce=le.document.createElement("video");ce.muted=!0,ce.onloadstart=function(){te(null,ce)};for(let te=0;te<C.length;te++){const he=le.document.createElement("source");Ee(C[te])||(ce.crossOrigin="Anonymous"),he.src=C[te],ce.appendChild(he)}}(this.urls,((C,te)=>{this._loaded=!0,C?this.fire(new Ct(C)):te&&(this.video=te,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading())}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(C){if(this.video){const te=this.video.seekable;C<te.start(0)||C>te.end(0)?this.fire(new Ct(new Dt(`sources.${this.id}`,null,`Playback for this video can be set only between the ${te.start(0)} and ${te.end(0)}-second mark.`))):this.video.currentTime=C}}getVideo(){return this.video}onAdd(C){this.map||(this.map=C,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;const C=this.map.painter.context,te=C.gl;this.texture?this.video.paused||(this.texture.bind(te.LINEAR,te.CLAMP_TO_EDGE),te.texSubImage2D(te.TEXTURE_2D,0,0,0,te.RGBA,te.UNSIGNED_BYTE,this.video)):(this.texture=new My(C,this.video,te.RGBA),this.texture.bind(te.LINEAR,te.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(C)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:Jb,model:class extends zt{constructor(C,te,le,ce){super(),this.id=C,this.type="model",this.models=[],this._loaded=!1,this._options=te}load(){const C=[];for(const te in this._options.models){const le=this._options.models[te],ce=fT(this.map._requestManager.transformRequest(le.uri,st.Model).url).then((C=>{if(!C)return;const ce=TT(C),he=new Cv(te,le.position,le.orientation,ce);he.computeBoundsAndApplyParent(),this.models.push(he)})).catch((C=>{this.fire(new Ct(new Error(`Could not load model ${te} from ${le.uri}: ${C.message}`)))}));C.push(ce)}return Promise.allSettled(C).then((()=>{this._loaded=!0,this.fire(new It("data",{dataType:"source",sourceDataType:"metadata"}))})).catch((C=>{this.fire(new Ct(new Error(`Could not load models: ${C.message}`)))}))}onAdd(C){this.map=C,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(C,te){}serialize(){return{type:"model"}}},"batched-model":class extends zt{constructor(C,te,le,ce){super(),this.type="batched-model",this.id=C,this.tileSize=512,this._options=te,this.tiles=this._options.tiles,this.maxzoom=te.maxzoom||19,this.minzoom=te.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=le,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(ce)}onAdd(C){this.map=C,this.load()}load(C){this._loaded=!1,this.fire(new It("dataloading",{dataType:"source"}));const te=Array.isArray(this.map._language)?this.map._language.join():this.map._language,le=this.map._worldview;this._tileJSONRequest=Dw(this._options,this.map._requestManager,te,le,((ce,he)=>{this._tileJSONRequest=null,this._loaded=!0,ce?(te&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${te}`),le&&2!==le.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${le}`),this.fire(new Ct(ce))):he&&(k(this,he),he.bounds&&(this.tileBounds=new Rw(he.bounds,this.minzoom,this.maxzoom)),Pt(he.tiles,this.map._requestManager._customAccessToken),this.fire(new It("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new It("data",{dataType:"source",sourceDataType:"content"}))),C&&C(ce)}))}hasTransition(){return!1}hasTile(C){return!this.tileBounds||this.tileBounds.contains(C.canonical)}loaded(){return this._loaded}loadTile(C,te){const le=this.map._requestManager.normalizeTileURL(C.tileID.canonical.url(this.tiles,this.scheme)),ce={request:this.map._requestManager.transformRequest(le,st.Tile),data:void 0,uid:C.uid,tileID:C.tileID,tileZoom:C.tileZoom,zoom:C.tileID.overscaledZ,tileSize:this.tileSize*C.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:C.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0};if(C.actor&&"expired"!==C.state)if("loading"===C.state)C.reloadCallback=te;else{if(C.buckets){const te=Object.values(C.buckets);for(const C of te)C.dirty=!0;return void(C.state="loaded")}C.request=C.actor.send("reloadTile",ce,n.bind(this))}else C.actor=this.dispatcher.getActor(),C.request=C.actor.send("loadTile",ce,n.bind(this),void 0,!0);function n(le,ce){return C.aborted?te(null):le&&404!==le.status?te(le):(ce&&(ce.resourceTiming&&(C.resourceTiming=ce.resourceTiming),this.map._refreshExpiredTiles&&C.setExpiryData(ce),C.buckets={...C.buckets,...ce.buckets}),C.state="loaded",void te(null))}}serialize(){return k({},this._options)}},canvas:class extends Jb{constructor(C,te,ce,he){super(C,te,ce,he),te.coordinates?Array.isArray(te.coordinates)&&4===te.coordinates.length&&!te.coordinates.some((C=>!Array.isArray(C)||2!==C.length||C.some((C=>"number"!=typeof C))))||this.fire(new Ct(new Dt(`sources.${C}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new Ct(new Dt(`sources.${C}`,null,'missing required property "coordinates"'))),te.animate&&"boolean"!=typeof te.animate&&this.fire(new Ct(new Dt(`sources.${C}`,null,'optional "animate" property must be a boolean value'))),te.canvas?"string"==typeof te.canvas||te.canvas instanceof le.HTMLCanvasElement||this.fire(new Ct(new Dt(`sources.${C}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new Ct(new Dt(`sources.${C}`,null,'missing required property "canvas"'))),this.options=te,this.animate=void 0===te.animate||te.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof le.HTMLCanvasElement?this.options.canvas:le.document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new Ct(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(C){this.map=C,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let C=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,C=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,C=!0),this._hasInvalidDimensions())return;if(0===Object.keys(this.tiles).length)return;const te=this.map.painter.context;this.texture?!C&&!this._playing||this.texture instanceof Ay||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new My(te,this.canvas,te.gl.RGBA,{premultiply:!0}),this._prepareData(te)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const C of[this.canvas.width,this.canvas.height])if(isNaN(C)||C<=0)return!0;return!1}},custom:class extends zt{constructor(C,te,le,ce){super(),this.id=C,this.type="custom",this._dataType="raster",this._dispatcher=le,this._implementation=te,this.setEventedParent(ce),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new Ct(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new Ct(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new Rw(this._implementation.bounds,this.minzoom,this.maxzoom)),te.update=this._update.bind(this),te.clearTiles=this._clearTiles.bind(this),te.coveringTiles=this._coveringTiles.bind(this),k(this,O(te,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return O(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new It("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new It("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(C){this._map=C,this._loaded=!1,this.fire(new It("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(C),this.load()}onRemove(C){this._implementation.onRemove&&this._implementation.onRemove(C)}hasTile(C){if(this._implementation.hasTile){const{x:te,y:le,z:ce}=C.canonical;return this._implementation.hasTile({x:te,y:le,z:ce})}return!this.tileBounds||this.tileBounds.contains(C.canonical)}loadTile(C,te){const{x:ce,y:he,z:ue}=C.tileID.canonical,de=new le.AbortController;C.request=Promise.resolve(this._implementation.loadTile({x:ce,y:he,z:ue},{signal:de.signal})).then(function(ce){return delete C.request,C.aborted?(C.state="unloaded",te(null)):void 0===ce?(C.state="errored",te(null)):null===ce?(this.loadTileData(C,{width:this.tileSize,height:this.tileSize,data:null}),C.state="loaded",te(null)):function(C){return C instanceof le.ImageData||C instanceof le.HTMLCanvasElement||C instanceof le.ImageBitmap||C instanceof le.HTMLImageElement}(ce)?(this.loadTileData(C,ce),C.state="loaded",void te(null)):(C.state="errored",te(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}.bind(this)).catch((le=>{20!==le.code&&(C.state="errored",te(le))})),C.request.cancel=()=>de.abort()}loadTileData(C,te){C.setTexture(te,this._map.painter)}unloadTile(C,te){if(C.texture&&C.texture instanceof My?(C.destroy(!0),C.texture&&C.texture instanceof My&&this._map.painter.saveTileTexture(C.texture)):C.destroy(),this._implementation.unloadTile){const{x:te,y:le,z:ce}=C.tileID.canonical;this._implementation.unloadTile({x:te,y:le,z:ce})}te()}abortTile(C,te){C.request&&C.request.cancel&&(C.request.cancel(),delete C.request),te()}hasTransition(){return!1}_coveringTiles(){return this._map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map((C=>({x:C.canonical.x,y:C.canonical.y,z:C.canonical.z})))}_clearTiles(){const C=va(this.id,this.scope);this._map.style.clearSource(C)}_update(){this.fire(new It("data",{dataType:"source",sourceDataType:"content"}))}}},ST=function(C,te,le,ce){const he=new VM[te.type](C,te,le,ce);if(he.id!==C)throw new Error(`Expected Source id to be ${C} instead of ${he.id}`);return j(["load","abort","unload","serialize","prepare"],he),he};function IT(C,te){const le=ld.identity([]);return ld.scale(le,le,[.5*C.width,.5*-C.height,1]),ld.translate(le,le,[1,-1,0]),ld.multiply(le,le,C.calculateProjMatrix(te.toUnwrapped())),Float32Array.from(le)}function CT(C,te,le,ce,he,ue,de,_e=!1){const ye=C.tilesIn(ce,de,_e);ye.sort(PT);const ve=[];for(const ce of ye)ve.push({wrappedTileID:ce.tile.tileID.wrapped().key,queryResults:ce.tile.queryRenderedFeatures(te,le,C._state,ce,he,ue,IT(C.transform,ce.tile.tileID),_e)});const Se=function(C){const te={},le={};for(const ce of C){const C=ce.queryResults,he=ce.wrappedTileID,ue=le[he]=le[he]||{};for(const le in C){const ce=C[le],he=ue[le]=ue[le]||{},de=te[le]=te[le]||[];for(const C of ce)he[C.featureIndex]||(he[C.featureIndex]=!0,de.push(C))}}return te}(ve);for(const te in Se)Se[te].forEach((te=>{const le=te.feature,ce=le.layer;ce&&"background"!==ce.type&&"sky"!==ce.type&&"slot"!==ce.type&&(le.source=ce.source,ce["source-layer"]&&(le.sourceLayer=ce["source-layer"]),le.state=void 0!==le.id?C.getFeatureState(ce["source-layer"],le.id):{})}));return Se}function zT(C,te){const le=C.getRenderableIds().map((te=>C.getTileByID(te))),ce=[],he={};for(let C=0;C<le.length;C++){const ue=le[C],de=ue.tileID.canonical.key;he[de]||(he[de]=!0,ue.querySourceFeatures(ce,te))}return ce}function PT(C,te){const le=C.tileID,ce=te.tileID;return le.overscaledZ-ce.overscaledZ||le.canonical.y-ce.canonical.y||le.wrap-ce.wrap||le.canonical.x-ce.canonical.x}class DT{constructor(C){this.style=C}processLayersChanged(){this.layers=[];for(const C in this.style._mergedLayers){const te=this.style._mergedLayers[C];if("fill-extrusion"===te.type)this.layers.push(te);else if("model"===te.type){const C=this.style.getLayerSource(te);C&&"batched-model"===C.type&&this.layers.push(te)}}}updateZOffset(C,te){this.currentBuildingBuckets=[];for(let C=0;C<this.layers.length;++C){const le=this.layers[C],ce=this.style.getLayerSourceCache(le);let he=1;"fill-extrusion"===le.type&&(he=le.paint.get("fill-extrusion-opacity")>0?le.paint.get("fill-extrusion-vertical-scale"):0);let ue=ce?ce.getTile(te):null;if(!ue&&ce&&te.canonical.z>ce.getSource().minzoom){let C=te.scaledTo(Math.min(ce.getSource().maxzoom,te.overscaledZ-1));for(;C.overscaledZ>=ce.getSource().minzoom&&(ue=ce.getTile(C),!ue&&0!==C.overscaledZ);)C=C.scaledTo(C.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:ue?ue.getBucket(le):null,tileID:ue?ue.tileID:te,verticalScale:he})}C.hasAnyZOffset=!1;let le=!1;for(let ce=0;ce<C.symbolInstances.length;ce++){const he=C.symbolInstances.get(ce),ue=he.zOffset,de=this._getHeightAtTileOffset(te,he.tileAnchorX,he.tileAnchorY);he.zOffset=-1!==de?de:ue,le||ue===he.zOffset||(le=!0),C.hasAnyZOffset||0===he.zOffset||(C.hasAnyZOffset=!0)}le&&(C.zOffsetBuffersNeedUpload=!0,C.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(C,te,le,ce){let he=te,ue=le;if(C.canonical.z!==ce.canonical.z){const de=ce.canonical,_e=1/(1<<C.canonical.z-de.z);he=(te+C.canonical.x*Mn)*_e-de.x*Mn|0,ue=(le+C.canonical.y*Mn)*_e-de.y*Mn|0}return{tileX:he,tileY:ue}}_getHeightAtTileOffset(C,te,le){let ce;for(let he=0;he<this.layers.length;++he){if("fill-extrusion"!==this.layers[he].type)continue;const{bucket:ue,tileID:de,verticalScale:_e}=this.currentBuildingBuckets[he];if(!ue)continue;const{tileX:ye,tileY:ve}=this._mapCoordToOverlappingTile(C,te,le,de),Se=ue.getHeightAtTileCoord(ye,ve);if(Se&&void 0!==Se.height){if(!Se.hidden)return Se.height*_e;ce=Se.height}}for(let he=0;he<this.layers.length;++he){if("model"!==this.layers[he].type)continue;const{bucket:ue,tileID:de}=this.currentBuildingBuckets[he];if(!ue)continue;const{tileX:_e,tileY:ye}=this._mapCoordToOverlappingTile(C,te,le,de),ve=ue.getHeightAtTileCoord(_e,ye);if(ve&&!ve.hidden)return void 0===ve.height&&void 0!==ce?Math.min(ve.maxHeight,ce)*ve.verticalScale:(ve.height||0)*ve.verticalScale}return-1}}var GM=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function LT(C,te){const le={};for(const te in C)"ref"!==te&&(le[te]=C[te]);return GM.forEach((C=>{C in te&&(le[C]=te[C])})),le}function kT(C){C=C.slice();const te=Object.create(null);for(let le=0;le<C.length;le++)te[C[le].id]=C[le];for(let le=0;le<C.length;le++)"ref"in C[le]&&(C[le]=LT(C[le],te[C[le].ref]));return C}const qM={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",setImportUrl:"setImportUrl",setImportData:"setImportData",setImportConfig:"setImportConfig"};function BT(C,te,le){le.push({command:qM.addSource,args:[C,te[C]]})}function FT(C,te,le){te.push({command:qM.removeSource,args:[C]}),le[C]=!0}function NT(C,te,le,ce){FT(C,le,ce),BT(C,te,le)}function UT(C,te,le){let ce;for(ce in C[le])if(C[le].hasOwnProperty(ce)&&"data"!==ce&&!x(C[le][ce],te[le][ce]))return!1;for(ce in te[le])if(te[le].hasOwnProperty(ce)&&"data"!==ce&&!x(C[le][ce],te[le][ce]))return!1;return!0}function VT(C,te,le,ce,he,ue){let de;for(de in te=te||{},C=C||{})C.hasOwnProperty(de)&&(x(C[de],te[de])||le.push({command:ue,args:[ce,de,te[de],he]}));for(de in te)te.hasOwnProperty(de)&&!C.hasOwnProperty(de)&&(x(C[de],te[de])||le.push({command:ue,args:[ce,de,te[de],he]}))}function jT(C){return C.id}function GT(C,te){return C[te.id]=te,C}class qT{constructor(C,te){this.reset(C,te)}reset(C,te){this.points=C||[],this._distances=[0];for(let C=1;C<this.points.length;C++)this._distances[C]=this._distances[C-1]+this.points[C].dist(this.points[C-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(te||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(C){if(1===this.points.length)return this.points[0];C=z(C,0,1);let te=1,le=this._distances[te];const ce=C*this.paddedLength+this.padding;for(;le<ce&&te<this._distances.length;)le=this._distances[++te];const he=te-1,ue=this._distances[he],de=le-ue,_e=de>0?(ce-ue)/de:0;return this.points[he].mult(1-_e).add(this.points[te].mult(_e))}}class ZT{constructor(C,te,le){const ce=this.boxCells=[],he=this.circleCells=[];this.xCellCount=Math.ceil(C/le),this.yCellCount=Math.ceil(te/le);for(let C=0;C<this.xCellCount*this.yCellCount;C++)ce.push([]),he.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=C,this.height=te,this.xScale=this.xCellCount/C,this.yScale=this.yCellCount/te,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(C,te,le,ce,he){this._forEachCell(te,le,ce,he,this._insertBoxCell,this.boxUid++),this.boxKeys.push(C),this.bboxes.push(te),this.bboxes.push(le),this.bboxes.push(ce),this.bboxes.push(he)}insertCircle(C,te,le,ce){this._forEachCell(te-ce,le-ce,te+ce,le+ce,this._insertCircleCell,this.circleUid++),this.circleKeys.push(C),this.circles.push(te),this.circles.push(le),this.circles.push(ce)}_insertBoxCell(C,te,le,ce,he,ue){this.boxCells[he].push(ue)}_insertCircleCell(C,te,le,ce,he,ue){this.circleCells[he].push(ue)}_query(C,te,le,ce,he,ue){if(le<0||C>this.width||ce<0||te>this.height)return!he&&[];const de=[];if(C<=0&&te<=0&&this.width<=le&&this.height<=ce){if(he)return!0;for(let C=0;C<this.boxKeys.length;C++)de.push({key:this.boxKeys[C],x1:this.bboxes[4*C],y1:this.bboxes[4*C+1],x2:this.bboxes[4*C+2],y2:this.bboxes[4*C+3]});for(let C=0;C<this.circleKeys.length;C++){const te=this.circles[3*C],le=this.circles[3*C+1],ce=this.circles[3*C+2];de.push({key:this.circleKeys[C],x1:te-ce,y1:le-ce,x2:te+ce,y2:le+ce})}return ue?de.filter(ue):de}return this._forEachCell(C,te,le,ce,this._queryCell,de,{hitTest:he,seenUids:{box:{},circle:{}}},ue),he?de.length>0:de}_queryCircle(C,te,le,ce,he){const ue=C-le,de=C+le,_e=te-le,ye=te+le;if(de<0||ue>this.width||ye<0||_e>this.height)return!ce&&[];const ve=[];return this._forEachCell(ue,_e,de,ye,this._queryCellCircle,ve,{hitTest:ce,circle:{x:C,y:te,radius:le},seenUids:{box:{},circle:{}}},he),ce?ve.length>0:ve}query(C,te,le,ce,he){return this._query(C,te,le,ce,!1,he)}hitTest(C,te,le,ce,he){return this._query(C,te,le,ce,!0,he)}hitTestCircle(C,te,le,ce){return this._queryCircle(C,te,le,!0,ce)}_queryCell(C,te,le,ce,he,ue,de,_e){const ye=de.seenUids,ve=this.boxCells[he];if(null!==ve){const he=this.bboxes;for(const Se of ve)if(!ye.box[Se]){ye.box[Se]=!0;const ve=4*Se;if(C<=he[ve+2]&&te<=he[ve+3]&&le>=he[ve+0]&&ce>=he[ve+1]&&(!_e||_e(this.boxKeys[Se]))){if(de.hitTest)return ue.push(!0),!0;ue.push({key:this.boxKeys[Se],x1:he[ve],y1:he[ve+1],x2:he[ve+2],y2:he[ve+3]})}}}const Se=this.circleCells[he];if(null!==Se){const he=this.circles;for(const ve of Se)if(!ye.circle[ve]){ye.circle[ve]=!0;const Se=3*ve;if(this._circleAndRectCollide(he[Se],he[Se+1],he[Se+2],C,te,le,ce)&&(!_e||_e(this.circleKeys[ve]))){if(de.hitTest)return ue.push(!0),!0;{const C=he[Se],te=he[Se+1],le=he[Se+2];ue.push({key:this.circleKeys[ve],x1:C-le,y1:te-le,x2:C+le,y2:te+le})}}}}}_queryCellCircle(C,te,le,ce,he,ue,de,_e){const ye=de.circle,ve=de.seenUids,Se=this.boxCells[he];if(null!==Se){const C=this.bboxes;for(const te of Se)if(!ve.box[te]){ve.box[te]=!0;const le=4*te;if(this._circleAndRectCollide(ye.x,ye.y,ye.radius,C[le+0],C[le+1],C[le+2],C[le+3])&&(!_e||_e(this.boxKeys[te])))return ue.push(!0),!0}}const Me=this.circleCells[he];if(null!==Me){const C=this.circles;for(const te of Me)if(!ve.circle[te]){ve.circle[te]=!0;const le=3*te;if(this._circlesCollide(C[le],C[le+1],C[le+2],ye.x,ye.y,ye.radius)&&(!_e||_e(this.circleKeys[te])))return ue.push(!0),!0}}}_forEachCell(C,te,le,ce,he,ue,de,_e){const ye=this._convertToXCellCoord(C),ve=this._convertToYCellCoord(te),Se=this._convertToXCellCoord(le),Me=this._convertToYCellCoord(ce);for(let Ae=ye;Ae<=Se;Ae++)for(let ye=ve;ye<=Me;ye++)if(he.call(this,C,te,le,ce,this.xCellCount*ye+Ae,ue,de,_e))return}_convertToXCellCoord(C){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(C*this.xScale)))}_convertToYCellCoord(C){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(C*this.yScale)))}_circlesCollide(C,te,le,ce,he,ue){const de=ce-C,_e=he-te,ye=le+ue;return ye*ye>de*de+_e*_e}_circleAndRectCollide(C,te,le,ce,he,ue,de){const _e=(ue-ce)/2,ye=Math.abs(C-(ce+_e));if(ye>_e+le)return!1;const ve=(de-he)/2,Se=Math.abs(te-(he+ve));if(Se>ve+le)return!1;if(ye<=_e||Se<=ve)return!0;const Me=ye-_e,Ae=Se-ve;return Me*Me+Ae*Ae<=le*le}}const $M=100;class WT{constructor(C,te,le=new ZT(C.width+200,C.height+200,25),ce=new ZT(C.width+200,C.height+200,25)){this.transform=C,this.grid=le,this.ignoredGrid=ce,this.pitchfactor=Math.cos(C._pitch)*C.cameraToCenterDistance,this.screenRightBoundary=C.width+$M,this.screenBottomBoundary=C.height+$M,this.gridRightBoundary=C.width+200,this.gridBottomBoundary=C.height+200,this.fogState=te}placeCollisionBox(C,te,le,ce,he,ue,de,_e){let ye=le.projectedAnchorX,ve=le.projectedAnchorY,Se=le.projectedAnchorZ;const Me=le.elevation,Ae=le.tileID,Ce=C.getProjection();if(Me&&Ae){const[C,te,ce]=Ce.upVector(Ae.canonical,le.tileAnchorX,le.tileAnchorY),he=Ce.upVectorScale(Ae.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;ye+=C*Me*he,ve+=te*Me*he,Se+=ce*Me*he}const Oe=this.projectAndGetPerspectiveRatio(de,ye,ve,Se,le.tileID,"globe"===Ce.name||!!Me||this.transform.pitch>0,Ce),Ne=ue*Oe.perspectiveRatio,je=(le.x1*te+ce.x-le.padding)*Ne+Oe.point.x,Ge=(le.y1*te+ce.y-le.padding)*Ne+Oe.point.y,Ze=(le.x2*te+ce.x+le.padding)*Ne+Oe.point.x,qe=(le.y2*te+ce.y+le.padding)*Ne+Oe.point.y,$e=Oe.perspectiveRatio<=.55||Oe.occluded;return!this.isInsideGrid(je,Ge,Ze,qe)||!he&&this.grid.hitTest(je,Ge,Ze,qe,_e)||$e?{box:[],offscreen:!1,occluded:Oe.occluded}:{box:[je,Ge,Ze,qe],offscreen:this.isOffscreen(je,Ge,Ze,qe),occluded:!1}}placeCollisionCircles(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe){const Ne=[],Ge=this.transform.elevation,Ze=C.getProjection(),qe=Ge?Ge.getAtTileOffsetFunc(Oe,this.transform.center.lat,this.transform.worldSize,Ze):null,$e=new je(le.tileAnchorX,le.tileAnchorY);let{x:He,y:We,z:Xe}=Ze.projectTilePoint($e.x,$e.y,Oe.canonical);if(qe){const[C,te,le]=qe($e);He+=C,We+=te,Xe+=le}const Ye="globe"===Ze.name,Je=this.projectAndGetPerspectiveRatio(de,He,We,Xe,Oe,Ye||!!Ge||this.transform.pitch>0,Ze),{perspectiveRatio:Qe}=Je,tt=(Se?ue/Qe:ue*Qe)/jg,rt=cv(He,We,Xe,_e),ot=Je.signedDistanceFromCamera>0?pv(tt,he,le.lineOffsetX*tt,le.lineOffsetY*tt,!1,rt,$e,le,ce,_e,{},Ge&&!Se?qe:null,Se&&!!Ge,Ze,Oe,Se):null;let st=!1,at=!1,lt=!0;if(ot&&!Je.occluded){const C=.5*Ae*Qe+Ce,le=new je(-100,-100),ce=new je(this.screenRightBoundary,this.screenBottomBoundary),he=new qT,{first:ue,last:de}=ot,_e=ue.path.length;let Se=[];for(let C=_e-1;C>=1;C--)Se.push(ue.path[C]);for(let C=1;C<de.path.length;C++)Se.push(de.path[C]);const Oe=2.5*C;ye&&(Se=Se.map((([C,te,le],ce)=>(qe&&!Ye&&(le=qe(ce<_e-1?ue.tilePath[_e-1-ce]:de.tilePath[ce-_e+2])[2]),cv(C,te,le,ye)))),Se.some((C=>C[3]<=0))&&(Se=[]));let Ge=[];if(Se.length>0){let C=1/0,te=-1/0,he=1/0,ue=-1/0;for(const le of Se)C=Math.min(C,le[0]),he=Math.min(he,le[1]),te=Math.max(te,le[0]),ue=Math.max(ue,le[1]);te>=le.x&&C<=ce.x&&ue>=le.y&&he<=ce.y&&(Ge=[Se.map((C=>new je(C[0],C[1])))],(C<le.x||te>ce.x||he<le.y||ue>ce.y)&&(Ge=Y_(Ge,le.x,le.y,ce.x,ce.y)))}for(const le of Ge){he.reset(le,.25*C);let ce=0;ce=he.length<=.5*C?1:Math.ceil(he.paddedLength/Oe)+1;for(let le=0;le<ce;le++){const ue=le/Math.max(ce-1,1),de=he.lerp(ue),_e=de.x+$M,ye=de.y+$M;Ne.push(_e,ye,C,0);const Se=_e-C,Ae=ye-C,Ce=_e+C,Oe=ye+C;if(lt=lt&&this.isOffscreen(Se,Ae,Ce,Oe),at=at||this.isInsideGrid(Se,Ae,Ce,Oe),!te&&this.grid.hitTestCircle(_e,ye,C,Me)&&(st=!0,!ve))return{circles:[],offscreen:!1,collisionDetected:st,occluded:!1}}}}return{circles:!ve&&st||!at?[]:Ne,offscreen:lt,collisionDetected:st,occluded:Je.occluded}}queryRenderedSymbols(C){if(0===C.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};const te=[];let le=1/0,ce=1/0,he=-1/0,ue=-1/0;for(const de of C){const C=new je(de.x+$M,de.y+$M);le=Math.min(le,C.x),ce=Math.min(ce,C.y),he=Math.max(he,C.x),ue=Math.max(ue,C.y),te.push(C)}const de=this.grid.query(le,ce,he,ue).concat(this.ignoredGrid.query(le,ce,he,ue)),_e={},ye={};for(const C of de){const le=C.key;void 0===_e[le.bucketInstanceId]&&(_e[le.bucketInstanceId]={}),_e[le.bucketInstanceId][le.featureIndex]||bp(te,[new je(C.x1,C.y1),new je(C.x2,C.y1),new je(C.x2,C.y2),new je(C.x1,C.y2)])&&(_e[le.bucketInstanceId][le.featureIndex]=!0,void 0===ye[le.bucketInstanceId]&&(ye[le.bucketInstanceId]=[]),ye[le.bucketInstanceId].push(le.featureIndex))}return ye}insertCollisionBox(C,te,le,ce,he){(te?this.ignoredGrid:this.grid).insert({bucketInstanceId:le,featureIndex:ce,collisionGroupID:he},C[0],C[1],C[2],C[3])}insertCollisionCircles(C,te,le,ce,he){const ue=te?this.ignoredGrid:this.grid,de={bucketInstanceId:le,featureIndex:ce,collisionGroupID:he};for(let te=0;te<C.length;te+=4)ue.insertCircle(de,C[te],C[te+1],C[te+2])}projectAndGetPerspectiveRatio(C,te,le,ce,he,ue,de){const _e=[te,le,ce,1];let ye=!1;if(ce||this.transform.pitch>0){if($u.transformMat4(_e,_e,C),this.fogState&&he&&"globe"!==de.name){const C=function(C,te,le,ce,he,ue){const de=ue.calculateFogTileMatrix(he),_e=[te,le,ce];return Zd.transformMat4(_e,_e,de),mw(C,Zd.length(_e),ue.pitch,ue._fov)}(this.fogState,te,le,ce,he.toUnwrapped(),this.transform);ye=C>.9}}else vv(_e,_e,C);const ve=_e[3];return{point:new je((_e[0]/ve+1)/2*this.transform.width+$M,(-_e[1]/ve+1)/2*this.transform.height+$M),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(de)/ve*.5,1.5),signedDistanceFromCamera:ve,occluded:ue&&_e[2]>ve||ye}}isOffscreen(C,te,le,ce){return le<$M||C>=this.screenRightBoundary||ce<$M||te>this.screenBottomBoundary}isInsideGrid(C,te,le,ce){return le>=0&&C<this.gridRightBoundary&&ce>=0&&te<this.gridBottomBoundary}getViewportMatrix(){const C=ld.identity([]);return ld.translate(C,C,[-100,-100,0]),C}}function HT(C,te,le){const ce=te.createTileMatrix(C,C.worldSize,le.toUnwrapped());return ld.multiply(new Float32Array(16),C.projMatrix,ce)}function XT(C,te,le){if(te.projection.name===le.projection.name)return C.projMatrix;const ce=le.clone();return ce.setProjection(te.projection),HT(ce,te.getProjection(),C)}function YT(C,te,le){return te.name===le.projection.name?C.projMatrix:HT(le,te,C)}class KT{constructor(C,te,le,ce){this.opacity=C?Math.max(0,Math.min(1,C.opacity+(C.placed?te:-te))):ce&&le?1:0,this.placed=le}isHidden(){return 0===this.opacity&&!this.placed}}class JT{constructor(C,te,le,ce,he,ue=!1){this.text=new KT(C?C.text:null,te,le,he),this.icon=new KT(C?C.icon:null,te,ce,he),this.clipped=ue}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class QT{constructor(C,te,le,ce=!1){this.text=C,this.icon=te,this.skipFade=le,this.clipped=ce}}class eE{constructor(){this.invProjMatrix=ld.create(),this.viewportMatrix=ld.create(),this.circles=[]}}class tE{constructor(C,te,le,ce,he){this.bucketInstanceId=C,this.featureIndex=te,this.sourceLayerIndex=le,this.bucketIndex=ce,this.tileID=he}}class iE{constructor(C){this.crossSourceCollisions=C,this.maxGroupID=0,this.collisionGroups={}}get(C){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[C]){const te=++this.maxGroupID;this.collisionGroups[C]={ID:te,predicate:C=>C.collisionGroupID===te}}return this.collisionGroups[C]}}function rE(C,te,le,ce,he){const{horizontalAlign:ue,verticalAlign:de}=F_(C),_e=-(ue-.5)*te,ye=-(de-.5)*le,ve=xg(C,ce);return new je(_e+ve[0]*he,ye+ve[1]*he)}function nE(C,te,le,ce,he){const ue=new je(C,te);return le&&ue._rotate(ce?he:-he),ue}class oE{constructor(C,te,le,ce,he,ue){this.transform=C.clone(),this.projection=C.projection.name,this.collisionIndex=new WT(this.transform,he),this.buildingIndex=ue,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=te,this.retainedQueryData={},this.collisionGroups=new iE(le),this.collisionCircleArrays={},this.prevPlacement=ce,ce&&(ce.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(C,te,le,ce){const he=le.getBucket(te),ue=le.latestFeatureIndex;if(!he||!ue||te.fqid!==he.layerIds[0])return;const de=he.layers[0].layout,_e=le.collisionBoxArray,ye=Math.pow(2,this.transform.zoom-le.tileID.overscaledZ),ve=le.tileSize/Mn,Se=le.tileID.toUnwrapped();this.transform.setProjection(he.projection);const Me=(Ae=le.tileID,Ce=he.getProjection(),Oe=this.transform,Ce.name===this.projection?Oe.calculateProjMatrix(Ae.toUnwrapped()):HT(Oe,Ce,Ae));var Ae,Ce,Oe;const Ne="map"===de.get("text-pitch-alignment"),je="map"===de.get("text-rotation-alignment");te.compileFilter();const Ge=te.dynamicFilter(),Ze=te.dynamicFilterNeedsFeature(),qe=this.transform.calculatePixelsToTileUnitsMatrix(le),$e=av(Me,le.tileID.canonical,Ne,je,this.transform,he.getProjection(),qe);let He=null;if(Ne){const C=lv(Me,le.tileID.canonical,Ne,je,this.transform,he.getProjection(),qe);He=ld.multiply([],this.transform.labelPlaneMatrix,C)}let We=null;Ge&&le.latestFeatureIndex&&(We={unwrappedTileID:Se,dynamicFilter:Ge,dynamicFilterNeedsFeature:Ze,featureIndex:le.latestFeatureIndex}),this.retainedQueryData[he.bucketInstanceId]=new tE(he.bucketInstanceId,ue,he.sourceLayerIndex,he.index,le.tileID);const Xe={bucket:he,layout:de,posMatrix:Me,textLabelPlaneMatrix:$e,labelToScreenMatrix:He,clippingData:We,scale:ye,textPixelRatio:ve,holdingForFade:le.holdingForFade(),collisionBoxArray:_e,partiallyEvaluatedTextSize:m_(he.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:m_(he.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(he.sourceID)};if(ce)for(const te of he.sortKeyRanges){const{sortKey:le,symbolInstanceStart:ce,symbolInstanceEnd:he}=te;C.push({sortKey:le,symbolInstanceStart:ce,symbolInstanceEnd:he,parameters:Xe})}else C.push({symbolInstanceStart:0,symbolInstanceEnd:he.symbolInstances.length,parameters:Xe})}attemptAnchorPlacement(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne,je,Ge){const{textOffset0:Ze,textOffset1:qe,crossTileID:$e}=Me,He=[Ze,qe],We=rE(C,le,ce,He,he),Xe=this.collisionIndex.placeCollisionBox(Ce,he,te,nE(We.x,We.y,ue,de,this.transform.angle),Se,_e,ye,ve.predicate);if(Ne){const C=Ce.getSymbolInstanceIconSize(Ge,this.transform.zoom,Me.placedIconSymbolIndex);if(0===this.collisionIndex.placeCollisionBox(Ce,C,Ne,nE(We.x,We.y,ue,de,this.transform.angle),Se,_e,ye,ve.predicate).box.length)return}if(Xe.box.length>0){let te;return this.prevPlacement&&this.prevPlacement.variableOffsets[$e]&&this.prevPlacement.placements[$e]&&this.prevPlacement.placements[$e].text&&(te=this.prevPlacement.variableOffsets[$e].anchor),this.variableOffsets[$e]={textOffset:He,width:le,height:ce,anchor:C,textScale:he,prevAnchor:te},this.markUsedJustification(Ce,C,Me,Oe),Ce.allowVerticalPlacement&&(this.markUsedOrientation(Ce,Oe,Me),this.placedOrientations[$e]=Oe),{shift:We,placedGlyphBoxes:Xe}}}placeLayerBucketPart(C,te,le,ce){const{bucket:he,layout:ue,posMatrix:de,textLabelPlaneMatrix:_e,labelToScreenMatrix:ye,clippingData:ve,textPixelRatio:Se,holdingForFade:Me,collisionBoxArray:Ae,partiallyEvaluatedTextSize:Ce,partiallyEvaluatedIconSize:Oe,collisionGroup:Ne}=C.parameters,Ge=ue.get("text-optional"),Ze=ue.get("icon-optional"),qe=ue.get("text-allow-overlap"),$e=ue.get("icon-allow-overlap"),He="map"===ue.get("text-rotation-alignment"),We="map"===ue.get("text-pitch-alignment"),Xe="viewport-y"===ue.get("symbol-z-order"),Ye=ue.get("symbol-z-elevate");this.transform.setProjection(he.projection);let Je=qe&&($e||!he.hasIconData()||Ze),Qe=$e&&(qe||!he.hasTextData()||Ge);!he.collisionArrays&&Ae&&he.deserializeCollisionBoxes(Ae),le&&ce&&he.updateCollisionDebugBuffers(this.transform.zoom,Ae);const S=(C,ce,Ae)=>{const{crossTileID:Xe,numVerticalGlyphVertices:Ye}=C;if(ve){const le={zoom:this.transform.zoom,pitch:this.transform.pitch};let ce=null;if(ve.dynamicFilterNeedsFeature){const te=this.retainedQueryData[he.bucketInstanceId];ce=ve.featureIndex.loadFeature({featureIndex:C.featureIndex,bucketIndex:te.bucketIndex,sourceLayerIndex:te.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,ve.dynamicFilter)(le,ce,this.retainedQueryData[he.bucketInstanceId].tileID.canonical,new je(C.tileAnchorX,C.tileAnchorY),this.transform.calculateDistanceTileData(ve.unwrappedTileID)))return this.placements[Xe]=new QT(!1,!1,!1,!0),void te.add(Xe)}if(te.has(Xe))return;if(Me)return void(this.placements[Xe]=new QT(!1,!1,!1));let tt=!1,rt=!1,ot=!0,st=!1,at=!1,lt=null,ct={box:null,offscreen:null,occluded:null},ht={box:null,offscreen:null,occluded:null},dt=null,mt=null,_t=null,gt=0,Pt=0,Ft=0;Ae.textFeatureIndex?gt=Ae.textFeatureIndex:C.useRuntimeCollisionCircles&&(gt=C.featureIndex),Ae.verticalTextFeatureIndex&&(Pt=Ae.verticalTextFeatureIndex);const V=te=>{te.tileID=this.retainedQueryData[he.bucketInstanceId].tileID;const le=this.transform.elevation;te.elevation=C.zOffset+(le?le.getAtTileOffset(te.tileID,te.tileAnchorX,te.tileAnchorY):0)},jt=Ae.textBox;if(jt){V(jt);const t=te=>{let le=iy.horizontal;if(he.allowVerticalPlacement&&!te&&this.prevPlacement){const te=this.prevPlacement.placedOrientations[Xe];te&&(this.placedOrientations[Xe]=te,le=te,this.markUsedOrientation(he,le,C))}return le},i=(C,te)=>{if(he.allowVerticalPlacement&&Ye>0&&Ae.verticalTextBox){for(const le of he.writingModes)if(le===iy.vertical?(ct=te(),ht=ct):ct=C(),ct&&ct.box&&ct.box.length)break}else ct=C()};if(ue.get("text-variable-anchor")){let te=ue.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[Xe]){const C=this.prevPlacement.variableOffsets[Xe];te.indexOf(C.anchor)>0&&(te=te.filter((te=>te!==C.anchor)),te.unshift(C.anchor))}const l=(le,ue,_e)=>{const ye=he.getSymbolInstanceTextSize(Ce,C,this.transform.zoom,ce),ve=(le.x2-le.x1)*ye+2*le.padding,Me=(le.y2-le.y1)*ye+2*le.padding,Ae=C.hasIconTextFit&&!$e?ue:null;Ae&&V(Ae);let je={box:[],offscreen:!1,occluded:!1};const Ge=qe?2*te.length:te.length;for(let ue=0;ue<Ge;++ue){const Ge=this.attemptAnchorPlacement(te[ue%te.length],le,ve,Me,ye,He,We,Se,de,Ne,ue>=te.length,C,ce,he,_e,Ae,Ce,Oe);if(Ge&&(je=Ge.placedGlyphBoxes,je&&je.box&&je.box.length)){tt=!0,lt=Ge.shift;break}}return je};i((()=>l(jt,Ae.iconBox,iy.horizontal)),(()=>{const C=Ae.verticalTextBox;return C&&V(C),he.allowVerticalPlacement&&!(ct&&ct.box&&ct.box.length)&&Ye>0&&C?l(C,Ae.verticalIconBox,iy.vertical):{box:null,offscreen:null,occluded:null}})),ct&&(tt=ct.box,ot=ct.offscreen,st=ct.occluded);const le=t(!(!ct||!ct.box));if(!tt&&this.prevPlacement){const te=this.prevPlacement.variableOffsets[Xe];te&&(this.variableOffsets[Xe]=te,this.markUsedJustification(he,te.anchor,C,le))}}else{const o=(te,le)=>{const ue=he.getSymbolInstanceTextSize(Ce,C,this.transform.zoom,ce),_e=this.collisionIndex.placeCollisionBox(he,ue,te,new je(0,0),qe,Se,de,Ne.predicate);return _e&&_e.box&&_e.box.length&&(this.markUsedOrientation(he,le,C),this.placedOrientations[Xe]=le),_e};i((()=>o(jt,iy.horizontal)),(()=>{const C=Ae.verticalTextBox;return he.allowVerticalPlacement&&Ye>0&&C?(V(C),o(C,iy.vertical)):{box:null,offscreen:null,occluded:null}})),t(!!(ct&&ct.box&&ct.box.length))}}if(dt=ct,tt=dt&&dt.box&&dt.box.length>0,ot=dt&&dt.offscreen,st=dt&&dt.occluded,C.useRuntimeCollisionCircles){const te=he.text.placedSymbolArray.get(C.centerJustifiedTextSymbolIndex>=0?C.centerJustifiedTextSymbolIndex:C.verticalPlacedTextSymbolIndex),ce=f_(he.textSizeData,Ce,te),ve=ue.get("text-padding");mt=this.collisionIndex.placeCollisionCircles(he,qe,te,he.lineVertexArray,he.glyphOffsetArray,ce,de,_e,ye,le,We,Ne.predicate,C.collisionCircleDiameter*ce/jg,ve,this.retainedQueryData[he.bucketInstanceId].tileID),tt=qe||mt.circles.length>0&&!mt.collisionDetected,ot=ot&&mt.offscreen,st=mt.occluded}if(Ae.iconFeatureIndex&&(Ft=Ae.iconFeatureIndex),Ae.iconBox){const t=te=>{V(te);const le=C.hasIconTextFit&&lt?nE(lt.x,lt.y,He,We,this.transform.angle):new je(0,0),ce=he.getSymbolInstanceIconSize(Oe,this.transform.zoom,C.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(he,ce,te,le,$e,Se,de,Ne.predicate)};ht&&ht.box&&ht.box.length&&Ae.verticalIconBox?(_t=t(Ae.verticalIconBox),rt=_t.box.length>0):(_t=t(Ae.iconBox),rt=_t.box.length>0),ot=ot&&_t.offscreen,at=_t.occluded}const Ut=Ge||0===C.numHorizontalGlyphVertices&&0===Ye,Vt=Ze||0===C.numIconVertices;if(Ut||Vt?Vt?Ut||(rt=rt&&tt):tt=rt&&tt:rt=tt=rt&&tt,tt&&dt&&dt.box&&this.collisionIndex.insertCollisionBox(dt.box,ue.get("text-ignore-placement"),he.bucketInstanceId,ht&&ht.box&&Pt?Pt:gt,Ne.ID),rt&&_t&&this.collisionIndex.insertCollisionBox(_t.box,ue.get("icon-ignore-placement"),he.bucketInstanceId,Ft,Ne.ID),mt&&(tt&&this.collisionIndex.insertCollisionCircles(mt.circles,ue.get("text-ignore-placement"),he.bucketInstanceId,gt,Ne.ID),le)){const C=he.bucketInstanceId;let te=this.collisionCircleArrays[C];void 0===te&&(te=this.collisionCircleArrays[C]=new eE);for(let C=0;C<mt.circles.length;C+=4)te.circles.push(mt.circles[C+0]),te.circles.push(mt.circles[C+1]),te.circles.push(mt.circles[C+2]),te.circles.push(mt.collisionDetected?1:0)}const Gt="globe"!==he.projection.name;Je=Je&&(Gt||!st),Qe=Qe&&(Gt||!at),this.placements[Xe]=new QT(tt||Je,rt||Qe,ot||he.justReloaded),te.add(Xe)};if(Ye&&this.buildingIndex&&(this.buildingIndex.updateZOffset(he,this.retainedQueryData[he.bucketInstanceId].tileID),he.updateZOffset()),Xe){const C=he.getSortedSymbolIndexes(this.transform.angle);for(let te=C.length-1;te>=0;--te){const le=C[te];S(he.symbolInstances.get(le),le,he.collisionArrays[le])}he.hasAnyZOffset&&H(`${he.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(he.hasAnyZOffset){const C=he.getSortedIndexesByZOffset();for(let te=0;te<C.length;++te){const le=C[te];S(he.symbolInstances.get(le),le,he.collisionArrays[le])}}else for(let te=C.symbolInstanceStart;te<C.symbolInstanceEnd;te++)S(he.symbolInstances.get(te),te,he.collisionArrays[te]);if(le&&he.bucketInstanceId in this.collisionCircleArrays){const C=this.collisionCircleArrays[he.bucketInstanceId];ld.invert(C.invProjMatrix,de),C.viewportMatrix=this.collisionIndex.getViewportMatrix()}he.justReloaded=!1}markUsedJustification(C,te,le,ce){const{leftJustifiedTextSymbolIndex:he,centerJustifiedTextSymbolIndex:ue,rightJustifiedTextSymbolIndex:de,verticalPlacedTextSymbolIndex:_e,crossTileID:ye}=le,ve=bg(te),Se=ce===iy.vertical?_e:"left"===ve?he:"center"===ve?ue:"right"===ve?de:-1;he>=0&&(C.text.placedSymbolArray.get(he).crossTileID=Se>=0&&he!==Se?0:ye),ue>=0&&(C.text.placedSymbolArray.get(ue).crossTileID=Se>=0&&ue!==Se?0:ye),de>=0&&(C.text.placedSymbolArray.get(de).crossTileID=Se>=0&&de!==Se?0:ye),_e>=0&&(C.text.placedSymbolArray.get(_e).crossTileID=Se>=0&&_e!==Se?0:ye)}markUsedOrientation(C,te,le){const ce=te===iy.horizontal||te===iy.horizontalOnly?te:0,he=te===iy.vertical?te:0,{leftJustifiedTextSymbolIndex:ue,centerJustifiedTextSymbolIndex:de,rightJustifiedTextSymbolIndex:_e,verticalPlacedTextSymbolIndex:ye}=le,ve=C.text.placedSymbolArray;ue>=0&&(ve.get(ue).placedOrientation=ce),de>=0&&(ve.get(de).placedOrientation=ce),_e>=0&&(ve.get(_e).placedOrientation=ce),ye>=0&&(ve.get(ye).placedOrientation=he)}commit(C){this.commitTime=C,this.zoomAtLastRecencyCheck=this.transform.zoom;const te=this.prevPlacement;let le=!1;this.prevZoomAdjustment=te?te.zoomAdjustment(this.transform.zoom):0;const ce=te?te.symbolFadeChange(C):1,he=te?te.opacities:{},ue=te?te.variableOffsets:{},de=te?te.placedOrientations:{};for(const C in this.placements){const te=this.placements[C],ue=he[C];ue?(this.opacities[C]=new JT(ue,ce,te.text,te.icon,null,te.clipped),le=le||te.text!==ue.text.placed||te.icon!==ue.icon.placed):(this.opacities[C]=new JT(null,ce,te.text,te.icon,te.skipFade,te.clipped),le=le||te.text||te.icon)}for(const C in he){const te=he[C];if(!this.opacities[C]){const he=new JT(te,ce,!1,!1);he.isHidden()||(this.opacities[C]=he,le=le||te.text.placed||te.icon.placed)}}for(const C in ue)this.variableOffsets[C]||!this.opacities[C]||this.opacities[C].isHidden()||(this.variableOffsets[C]=ue[C]);for(const C in de)this.placedOrientations[C]||!this.opacities[C]||this.opacities[C].isHidden()||(this.placedOrientations[C]=de[C]);le?this.lastPlacementChangeTime=C:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=te?te.lastPlacementChangeTime:C)}updateLayerOpacities(C,te){const le=new Set;for(const ce of te){const te=ce.getBucket(C);te&&ce.latestFeatureIndex&&C.fqid===te.layerIds[0]&&(this.updateBucketOpacities(te,le,ce.collisionBoxArray),te.layers[0].layout.get("symbol-z-elevate")&&this.buildingIndex&&(this.buildingIndex.updateZOffset(te,ce.tileID),te.updateZOffset()))}}updateBucketOpacities(C,te,le){C.hasTextData()&&C.text.opacityVertexArray.clear(),C.hasIconData()&&C.icon.opacityVertexArray.clear(),C.hasIconCollisionBoxData()&&C.iconCollisionBox.collisionVertexArray.clear(),C.hasTextCollisionBoxData()&&C.textCollisionBox.collisionVertexArray.clear();const ce=C.layers[0].layout,he=!!C.layers[0].dynamicFilter(),ue=new JT(null,0,!1,!1,!0),de=ce.get("text-allow-overlap"),_e=ce.get("icon-allow-overlap"),ye=ce.get("text-variable-anchor"),ve="map"===ce.get("text-rotation-alignment"),Se="map"===ce.get("text-pitch-alignment"),Me=new JT(null,0,de&&(_e||!C.hasIconData()||ce.get("icon-optional")),_e&&(de||!C.hasTextData()||ce.get("text-optional")),!0);!C.collisionArrays&&le&&(C.hasIconCollisionBoxData()||C.hasTextCollisionBoxData())&&C.deserializeCollisionBoxes(le);const d=(C,te,le)=>{for(let ce=0;ce<te/4;ce++)C.opacityVertexArray.emplaceBack(le)};let Ae=0;for(let le=0;le<C.symbolInstances.length;le++){const ce=C.symbolInstances.get(le),{numHorizontalGlyphVertices:de,numVerticalGlyphVertices:_e,crossTileID:Ce,numIconVertices:Oe}=ce,Ne=te.has(Ce);let Ge=this.opacities[Ce];Ne?Ge=ue:Ge||(Ge=Me,this.opacities[Ce]=Ge),te.add(Ce);const Ze=de>0||_e>0,qe=Oe>0,$e=this.placedOrientations[Ce],He=$e===iy.vertical,We=$e===iy.horizontal||$e===iy.horizontalOnly;if(!Ze&&!qe||Ge.isHidden()||Ae++,Ze){const te=fE(Ge.text);d(C.text,de,He?mE:te),d(C.text,_e,We?mE:te);const le=Ge.text.isHidden(),{leftJustifiedTextSymbolIndex:he,centerJustifiedTextSymbolIndex:ue,rightJustifiedTextSymbolIndex:ye,verticalPlacedTextSymbolIndex:ve}=ce,Se=C.text.placedSymbolArray,Me=le||He?1:0;he>=0&&(Se.get(he).hidden=Me),ue>=0&&(Se.get(ue).hidden=Me),ye>=0&&(Se.get(ye).hidden=Me),ve>=0&&(Se.get(ve).hidden=le||We?1:0);const Ae=this.variableOffsets[Ce];Ae&&this.markUsedJustification(C,Ae.anchor,ce,$e);const Oe=this.placedOrientations[Ce];Oe&&(this.markUsedJustification(C,"left",ce,Oe),this.markUsedOrientation(C,Oe,ce))}if(qe){const te=fE(Ge.icon),{placedIconSymbolIndex:le,verticalPlacedIconSymbolIndex:he}=ce,ue=C.icon.placedSymbolArray,de=Ge.icon.isHidden()?1:0;le>=0&&(d(C.icon,Oe,He?mE:te),ue.get(le).hidden=de),he>=0&&(d(C.icon,ce.numVerticalIconVertices,We?mE:te),ue.get(he).hidden=de)}if(C.hasIconCollisionBoxData()||C.hasTextCollisionBoxData()){const te=C.collisionArrays[le];if(te){let le=new je(0,0),ue=!0;if(te.textBox||te.verticalTextBox){if(ye){const C=this.variableOffsets[Ce];C?(le=rE(C.anchor,C.width,C.height,C.textOffset,C.textScale),ve&&le._rotate(Se?this.transform.angle:-this.transform.angle)):ue=!1}he&&(ue=!Ge.clipped),te.textBox&&sE(C.textCollisionBox.collisionVertexArray,Ge.text.placed,!ue||He,le.x,le.y),te.verticalTextBox&&sE(C.textCollisionBox.collisionVertexArray,Ge.text.placed,!ue||We,le.x,le.y)}const de=ue&&Boolean(!We&&te.verticalIconBox);te.iconBox&&sE(C.iconCollisionBox.collisionVertexArray,Ge.icon.placed,de,ce.hasIconTextFit?le.x:0,ce.hasIconTextFit?le.y:0),te.verticalIconBox&&sE(C.iconCollisionBox.collisionVertexArray,Ge.icon.placed,!de,ce.hasIconTextFit?le.x:0,ce.hasIconTextFit?le.y:0)}}}if(C.fullyClipped=0===Ae,C.sortFeatures(this.transform.angle),this.retainedQueryData[C.bucketInstanceId]&&(this.retainedQueryData[C.bucketInstanceId].featureSortOrder=C.featureSortOrder),C.hasTextData()&&C.text.opacityVertexBuffer&&C.text.opacityVertexBuffer.updateData(C.text.opacityVertexArray),C.hasIconData()&&C.icon.opacityVertexBuffer&&C.icon.opacityVertexBuffer.updateData(C.icon.opacityVertexArray),C.hasIconCollisionBoxData()&&C.iconCollisionBox.collisionVertexBuffer&&C.iconCollisionBox.collisionVertexBuffer.updateData(C.iconCollisionBox.collisionVertexArray),C.hasTextCollisionBoxData()&&C.textCollisionBox.collisionVertexBuffer&&C.textCollisionBox.collisionVertexBuffer.updateData(C.textCollisionBox.collisionVertexArray),C.bucketInstanceId in this.collisionCircleArrays){const te=this.collisionCircleArrays[C.bucketInstanceId];C.placementInvProjMatrix=te.invProjMatrix,C.placementViewportMatrix=te.viewportMatrix,C.collisionCircleArray=te.circles,delete this.collisionCircleArrays[C.bucketInstanceId]}}symbolFadeChange(C){return 0===this.fadeDuration?1:(C-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(C){return Math.max(0,(this.transform.zoom-C)/1.5)}hasTransitions(C){return this.stale||C-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(C,te){const le=this.zoomAtLastRecencyCheck===te?1-this.zoomAdjustment(te):1;return this.zoomAtLastRecencyCheck=te,this.commitTime+this.fadeDuration*le>C}setStale(){this.stale=!0}}function sE(C,te,le,ce,he){C.emplaceBack(te?1:0,le?1:0,ce||0,he||0),C.emplaceBack(te?1:0,le?1:0,ce||0,he||0),C.emplaceBack(te?1:0,le?1:0,ce||0,he||0),C.emplaceBack(te?1:0,le?1:0,ce||0,he||0)}const aE=Math.pow(2,25),lE=Math.pow(2,24),cE=Math.pow(2,17),hE=Math.pow(2,16),uE=Math.pow(2,9),dE=Math.pow(2,8),pE=Math.pow(2,1);function fE(C){if(0===C.opacity&&!C.placed)return 0;if(1===C.opacity&&C.placed)return 4294967295;const te=C.placed?1:0,le=Math.floor(127*C.opacity);return le*aE+te*lE+le*cE+te*hE+le*uE+te*dE+le*pE+te}const mE=0;class _E{constructor(C){this._sortAcrossTiles="viewport-y"!==C.layout.get("symbol-z-order")&&void 0!==C.layout.get("symbol-sort-key").constantOr(1),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(C,te,le,ce,he){const ue=this._bucketParts;for(;this._currentTileIndex<C.length;)if(te.getBucketParts(ue,ce,C[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,he())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,ue.sort(((C,te)=>C.sortKey-te.sortKey)));this._currentPartIndex<ue.length;){const C=ue[this._currentPartIndex];if(te.placeLayerBucketPart(C,this._seenCrossTileIDs,le,0===C.symbolInstanceStart),this._currentPartIndex++,he())return!0}return!1}}class gE{constructor(C,te,le,ce,he,ue,de,_e,ye){this.placement=new oE(C,he,ue,de,_e,ye),this._currentPlacementIndex=te.length-1,this._forceFullPlacement=le,this._showCollisionBoxes=ce,this._done=!1}isDone(){return this._done}continuePlacement(C,te,le,ce){const he=bi.now(),o=()=>{const C=bi.now()-he;return!this._forceFullPlacement&&C>2};for(;this._currentPlacementIndex>=0;){const he=te[C[this._currentPlacementIndex]],ue=this.placement.collisionIndex.transform.zoom;if("symbol"===he.type&&(!he.minzoom||he.minzoom<=ue)&&(!he.maxzoom||he.maxzoom>ue)){const C=he,te=C.layout.get("symbol-z-elevate"),ue=this._inProgressLayer=this._inProgressLayer||new _E(C),de=va(he.source,he.scope);if(ue.continuePlacement(te?ce[de]:le[de],this.placement,this._showCollisionBoxes,he,o))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(C){return this.placement.commit(C),this.placement}}const yE=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class xE{static from(C){if(!(C instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[te,le]=new Uint8Array(C,0,2);if(219!==te)throw new Error("Data does not appear to be in a KDBush format.");const ce=le>>4;if(1!==ce)throw new Error(`Got v${ce} data when expected v1.`);const he=yE[15&le];if(!he)throw new Error("Unrecognized array type.");const[ue]=new Uint16Array(C,2,1),[de]=new Uint32Array(C,4,1);return new xE(de,ue,he,C)}constructor(C,te=64,le=Float64Array,ce){if(isNaN(C)||C<0)throw new Error(`Unpexpected numItems value: ${C}.`);this.numItems=+C,this.nodeSize=Math.min(Math.max(+te,2),65535),this.ArrayType=le,this.IndexArrayType=C<65536?Uint16Array:Uint32Array;const he=yE.indexOf(this.ArrayType),ue=2*C*this.ArrayType.BYTES_PER_ELEMENT,de=C*this.IndexArrayType.BYTES_PER_ELEMENT,_e=(8-de%8)%8;if(he<0)throw new Error(`Unexpected typed array class: ${le}.`);ce&&ce instanceof ArrayBuffer?(this.data=ce,this.ids=new this.IndexArrayType(this.data,8,C),this.coords=new this.ArrayType(this.data,8+de+_e,2*C),this._pos=2*C,this._finished=!0):(this.data=new ArrayBuffer(8+ue+de+_e),this.ids=new this.IndexArrayType(this.data,8,C),this.coords=new this.ArrayType(this.data,8+de+_e,2*C),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+he]),new Uint16Array(this.data,2,1)[0]=te,new Uint32Array(this.data,4,1)[0]=C)}add(C,te){const le=this._pos>>1;return this.ids[le]=le,this.coords[this._pos++]=C,this.coords[this._pos++]=te,le}finish(){const C=this._pos>>1;if(C!==this.numItems)throw new Error(`Added ${C} items when expected ${this.numItems}.`);return vE(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(C,te,le,ce){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:he,coords:ue,nodeSize:de}=this,_e=[0,he.length-1,0],ye=[];for(;_e.length;){const ve=_e.pop()||0,Se=_e.pop()||0,Me=_e.pop()||0;if(Se-Me<=de){for(let de=Me;de<=Se;de++){const _e=ue[2*de],ve=ue[2*de+1];_e>=C&&_e<=le&&ve>=te&&ve<=ce&&ye.push(he[de])}continue}const Ae=Me+Se>>1,Ce=ue[2*Ae],Oe=ue[2*Ae+1];Ce>=C&&Ce<=le&&Oe>=te&&Oe<=ce&&ye.push(he[Ae]),(0===ve?C<=Ce:te<=Oe)&&(_e.push(Me),_e.push(Ae-1),_e.push(1-ve)),(0===ve?le>=Ce:ce>=Oe)&&(_e.push(Ae+1),_e.push(Se),_e.push(1-ve))}return ye}within(C,te,le){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:ce,coords:he,nodeSize:ue}=this,de=[0,ce.length-1,0],_e=[],ye=le*le;for(;de.length;){const ve=de.pop()||0,Se=de.pop()||0,Me=de.pop()||0;if(Se-Me<=ue){for(let le=Me;le<=Se;le++)EE(he[2*le],he[2*le+1],C,te)<=ye&&_e.push(ce[le]);continue}const Ae=Me+Se>>1,Ce=he[2*Ae],Oe=he[2*Ae+1];EE(Ce,Oe,C,te)<=ye&&_e.push(ce[Ae]),(0===ve?C-le<=Ce:te-le<=Oe)&&(de.push(Me),de.push(Ae-1),de.push(1-ve)),(0===ve?C+le>=Ce:te+le>=Oe)&&(de.push(Ae+1),de.push(Se),de.push(1-ve))}return _e}}function vE(C,te,le,ce,he,ue){if(he-ce<=le)return;const de=ce+he>>1;bE(C,te,de,ce,he,ue),vE(C,te,le,ce,de-1,1-ue),vE(C,te,le,de+1,he,1-ue)}function bE(C,te,le,ce,he,ue){for(;he>ce;){if(he-ce>600){const de=he-ce+1,_e=le-ce+1,ye=Math.log(de),ve=.5*Math.exp(2*ye/3),Se=.5*Math.sqrt(ye*ve*(de-ve)/de)*(_e-de/2<0?-1:1);bE(C,te,le,Math.max(ce,Math.floor(le-_e*ve/de+Se)),Math.min(he,Math.floor(le+(de-_e)*ve/de+Se)),ue)}const de=te[2*le+ue];let _e=ce,ye=he;for(wE(C,te,ce,le),te[2*he+ue]>de&&wE(C,te,ce,he);_e<ye;){for(wE(C,te,_e,ye),_e++,ye--;te[2*_e+ue]<de;)_e++;for(;te[2*ye+ue]>de;)ye--}te[2*ce+ue]===de?wE(C,te,ce,ye):(ye++,wE(C,te,ye,he)),ye<=le&&(ce=ye+1),le<=ye&&(he=ye-1)}}function wE(C,te,le,ce){TE(C,le,ce),TE(te,2*le,2*ce),TE(te,2*le+1,2*ce+1)}function TE(C,te,le){const ce=C[te];C[te]=C[le],C[le]=ce}function EE(C,te,le,ce){const he=C-le,ue=te-ce;return he*he+ue*ue}const ME=512/Mn/2;class AE{constructor(C,te,le){this.tileID=C,this.bucketInstanceId=le,this.index=new xE(te.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const ce=C.canonical.x*Mn,he=C.canonical.y*Mn;for(let C=0;C<te.length;C++){const{key:le,crossTileID:ue,tileAnchorX:de,tileAnchorY:_e}=te.get(C),ye=Math.floor((ce+de)*ME),ve=Math.floor((he+_e)*ME);this.index.add(ye,ve),this.keys.push(le),this.crossTileIDs.push(ue)}this.index.finish()}findMatches(C,te,le){const ce=this.tileID.canonical.z<te.canonical.z?1:Math.pow(2,this.tileID.canonical.z-te.canonical.z),he=ME/Math.pow(2,te.canonical.z-this.tileID.canonical.z),ue=te.canonical.x*Mn,de=te.canonical.y*Mn;for(let te=0;te<C.length;te++){const _e=C.get(te);if(_e.crossTileID)continue;const{key:ye,tileAnchorX:ve,tileAnchorY:Se}=_e,Me=Math.floor((ue+ve)*he),Ae=Math.floor((de+Se)*he),Ce=this.index.range(Me-ce,Ae-ce,Me+ce,Ae+ce);for(const C of Ce){const te=this.crossTileIDs[C];if(this.keys[C]===ye&&!le.has(te)){le.add(te),_e.crossTileID=te;break}}}}}class SE{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class IE{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(C){const te=Math.round((C-this.lng)/360);if(0!==te)for(const C in this.indexes){const le=this.indexes[C],ce={};for(const C in le){const he=le[C];he.tileID=he.tileID.unwrapTo(he.tileID.wrap+te),ce[he.tileID.key]=he}this.indexes[C]=ce}this.lng=C}addBucket(C,te,le){if(this.indexes[C.overscaledZ]&&this.indexes[C.overscaledZ][C.key]){if(this.indexes[C.overscaledZ][C.key].bucketInstanceId===te.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(C.overscaledZ,this.indexes[C.overscaledZ][C.key])}for(let C=0;C<te.symbolInstances.length;C++)te.symbolInstances.get(C).crossTileID=0;this.usedCrossTileIDs[C.overscaledZ]||(this.usedCrossTileIDs[C.overscaledZ]=new Set);const ce=this.usedCrossTileIDs[C.overscaledZ];for(const le in this.indexes){const he=this.indexes[le];if(Number(le)>C.overscaledZ)for(const le in he){const ue=he[le];ue.tileID.isChildOf(C)&&ue.findMatches(te.symbolInstances,C,ce)}else{const ue=he[C.scaledTo(Number(le)).key];ue&&ue.findMatches(te.symbolInstances,C,ce)}}for(let C=0;C<te.symbolInstances.length;C++){const he=te.symbolInstances.get(C);he.crossTileID||(he.crossTileID=le.generate(),ce.add(he.crossTileID))}return void 0===this.indexes[C.overscaledZ]&&(this.indexes[C.overscaledZ]={}),this.indexes[C.overscaledZ][C.key]=new AE(C,te.symbolInstances,te.bucketInstanceId),!0}removeBucketCrossTileIDs(C,te){for(const le of te.crossTileIDs)this.usedCrossTileIDs[C].delete(le)}removeStaleBuckets(C){let te=!1;for(const le in this.indexes){const ce=this.indexes[le];for(const he in ce)C[ce[he].bucketInstanceId]||(this.removeBucketCrossTileIDs(le,ce[he]),delete ce[he],te=!0)}return te}}class CE{constructor(){this.layerIndexes={},this.crossTileIDs=new SE,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(C,te,le,ce){let he=this.layerIndexes[C.fqid];void 0===he&&(he=this.layerIndexes[C.fqid]=new IE);let ue=!1;const de={};"globe"!==ce.name&&he.handleWrapJump(le);for(const le of te){const te=le.getBucket(C);te&&C.fqid===te.layerIds[0]&&(te.bucketInstanceId||(te.bucketInstanceId=++this.maxBucketInstanceId),he.addBucket(le.tileID,te,this.crossTileIDs)&&(ue=!0),de[te.bucketInstanceId]=!0)}return he.removeStaleBuckets(de)&&(ue=!0),ue}pruneUnusedLayers(C){const te={};C.forEach((C=>{te[C]=!0}));for(const C in this.layerIndexes)te[C]||delete this.layerIndexes[C]}}var zE="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#ifdef RENDER_CUTOFF\nfloat cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w-0.0001;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}\n#endif",DE="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",PE="\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\n#ifdef TERRAIN\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nfloat nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nreturn currentElevation(apos);}\n#endif\nhighp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(\nunpack_depth(texture(u_depth,uv-df.xz)),unpack_depth(texture(u_depth,uv+df.xz)),unpack_depth(texture(u_depth,uv-df.zy)),unpack_depth(texture(u_depth,uv+df.zy))\n);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }\n#endif",RE="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",kE="highp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}\n#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {\n#ifdef FOG_DITHERING\nvec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);\n#else\nreturn color;\n#endif\n}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif",LE="#ifdef RASTER_ARRAY\nuniform sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);vec4 _raTexLinearCoord(vec2 texCoord,vec2 texResolution,out vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return (texCoord.xxyy+vec2(1.5,0.5).xyxy)/texResolution.xxyy;}vec2 _raTexLinearMix(vec2 fxy,vec4 colorMix,float colorOffset,vec4 t00,vec4 t10,vec4 t01,vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(vec2 texCoord,vec2 texResolution,vec4 colorMix,float colorOffset) {vec2 fxy;vec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texture(u_image0,c.yz),texture(u_image0,c.xz),texture(u_image0,c.yw),texture(u_image0,c.xw)\n);}vec2 raTexture2D_image1_linear(vec2 texCoord,vec2 texResolution,vec4 colorMix,float colorOffset) {vec2 fxy;vec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texture(u_image1,c.yz),texture(u_image1,c.xz),texture(u_image1,c.yw),texture(u_image1,c.xw)\n);}vec2 raTexture2D_image0_nearest(vec2 texCoord,vec2 texResolution,vec4 colorMix,float colorOffset) {vec4 t=texture(u_image0,texCoord);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(vec2 texCoord,vec2 texResolution,vec4 colorMix,float colorOffset) {vec4 t=texture(u_image1,texCoord);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}\n#endif",OE="#ifdef RENDER_SHADOWS\nuniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}\n#endif//RENDER_SHADOWS",BE="#ifdef RENDER_SHADOWS\n#ifdef DEPTH_TEXTURE\nuniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;\n#else\nuniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;\n#endif\nuniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_1,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_0,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;\n#ifdef NATIVE\nhighp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));\n#else\nhighp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(\nshadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)\n);\n#endif\nvec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return mix(lerpx.x,lerpx.y,f.y);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {\n#ifdef SHADOWS_SINGLE_CASCADE\nlight_view_pos0.xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);\n#else\nlight_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth));\n#endif\n}highp float calculate_shadow_bias(float NDotL) {\n#ifdef NORMAL_OFFSET\nreturn 0.5*u_shadow_bias.x;\n#else\nreturn 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));\n#endif\n}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}\n#endif";const FE=[];qE(zE,FE);const NE={"_prelude_fog.vertex.glsl":RE,"_prelude_terrain.vertex.glsl":PE,"_prelude_shadow.vertex.glsl":OE,"_prelude_fog.fragment.glsl":kE,"_prelude_shadow.fragment.glsl":BE,"_prelude_lighting.glsl":"\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}\n#endif//LIGHTING_3D_MODE","_prelude_raster_array.glsl":LE},jE={};ZE("",PE),ZE(kE,RE),ZE(BE,OE),ZE(LE,"");const UE=ZE("\nout vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\n#ifdef INDICATOR_CUTOUT\nuniform vec2 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;\n#endif\nvec4 applyCutout(vec4 color) {\n#ifdef INDICATOR_CUTOUT\nfloat holeMinOpacity=u_indicator_cutout_params.x;float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);\n#else\nreturn color;\n#endif\n}\n#ifdef DEBUG_WIREFRAME\n#define HANDLE_WIREFRAME_DEBUG \\\nglFragColor=vec4(0.7,0.0,0.0,0.7); \\\ngl_FragDepth=gl_FragCoord.z-0.0001;\n#else\n#define HANDLE_WIREFRAME_DEBUG\n#endif\n#ifdef RENDER_CUTOFF\nuniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;\n#endif","\n#define EXTENT 8192.0\n#define RAD_TO_DEG 180.0/PI\n#define DEG_TO_RAD PI/180.0\n#define GLOBE_RADIUS EXTENT/PI/2.0\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#ifndef PROJECTED_POS_ON_VIEWPORT\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}\n#ifdef RENDER_CUTOFF\nuniform vec4 u_cutoff_params;out float v_cutoff_opacity;\n#endif\nconst vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)\n{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}"),VE=zE;var GE={background:ZE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec4 u_color;uniform float u_opacity;\n#ifdef LIGHTING_3D_MODE\nin vec4 v_color;\n#endif\nvoid main() {vec4 out_color;\n#ifdef LIGHTING_3D_MODE\nout_color=v_color;\n#else\nout_color=u_color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_lighting.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef LIGHTING_3D_MODE\nv_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),backgroundPattern:ZE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in vec2 v_pos;void main() {vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=texture(u_image,pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_tile_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),circle:ZE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec3 v_data;in float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\nglFragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec3 v_data;out float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);\n#else \nsurface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nocclusion_world_center=world_center;occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}'),clippingMask:ZE("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:ZE('#include "_prelude_fog.fragment.glsl"\nuniform highp float u_intensity;in vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\nif (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\npos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),heatmapTexture:ZE("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(0.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}","in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:ZE("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",'#include "_prelude_terrain.vertex.glsl"\nin vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in float a_size_scale;in vec2 a_padding;in float a_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(a_z_offset+elevation(a_anchor_pos)),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}'),collisionCircle:ZE("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}","in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:ZE("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",'#include "_prelude_terrain.vertex.glsl"\nin vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;\n#endif\nout vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}'),fill:ZE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutline:ZE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec2 v_pos;uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;out vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutlinePattern:ZE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;in vec2 v_pos;in vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=texture(u_image,pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;out vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillPattern:ZE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;in vec2 v_pos;uniform float u_emissive_strength;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec4 out_color=texture(u_image,pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillExtrusion:ZE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec4 v_color;in vec4 v_flat;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;\n#endif\nuniform lowp float u_opacity;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec2 v_ao;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nin vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nin highp vec3 v_normal;\n#endif\nuniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nin float v_flood_radius;in float v_has_floodlight;\n#endif\nuniform float u_emissive_strength;in float v_height;void main() {\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvec3 normal=normalize(v_normal);\n#endif\nfloat z;vec4 color=v_color;\n#ifdef ZERO_ROOF_RADIUS\nz=float(normal.z > 0.00001);\n#ifdef LIGHTING_3D_MODE\nnormal=mix(normal,vec3(0.0,0.0,1.0),z);\n#else\ncolor=mix(v_color,v_roof_color,z);\n#endif\n#endif\nfloat h=max(0.0,v_height);float ao_shade=1.0;\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;\n#ifdef ZERO_ROOF_RADIUS\nconcave*=(1.0-z);\n#endif\nfloat x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\ncolor.rgb*=mix(ao_shade,1.0,v_has_floodlight);\n#else\ncolor.rgb*=ao_shade;\n#endif\n#else\ncolor.rgb*=ao_shade;\n#endif\n#endif\n#ifdef LIGHTING_3D_MODE\nfloat flood_radiance=0.0;\n#ifdef FLOOD_LIGHT\nflood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;\n#endif\n#ifdef RENDER_SHADOWS\n#ifdef FLOOD_LIGHT\nfloat ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,v_depth);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);\n#else\nfloat shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#endif\n#else\ncolor.rgb=apply_lighting(color.rgb,normal);\n#ifdef FLOOD_LIGHT\ncolor.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);\n#endif\n#endif\ncolor.rgb=mix(color.rgb,v_flat.rgb,u_emissive_strength);color*=u_opacity;\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));\n#endif\n#ifdef RENDER_CUTOFF\ncolor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_lighting.glsl"\n#ifdef RENDER_CUTOFF\ninvariant gl_Position;\n#endif\nuniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\nuniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nout vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nout highp vec3 v_normal;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec2 v_ao;\n#endif\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nout float v_flood_radius;out float v_has_floodlight;\n#endif\nout float v_height;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define highp float flood_light_wall_radius\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize highp float flood_light_wall_radius\nbase*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nv_normal=normal;\n#endif\nbase=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=0.0;float c_ele;vec3 pos;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);pos=vec3(pos_nx.xy,h);\n#else\nh=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);h=h-ele;v_height=h;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\nfloat NdotL=0.0;float colorvalue=0.0;\n#ifndef LIGHTING_3D_MODE\ncolorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#endif\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\nfloat is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;\n#endif\nv_color=vec4(color.rgb,1.0);v_flat=vec4(linearProduct(color.rgb,vec3(calculate_NdotL(normal))),1.0);\n#else\nv_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nfloat roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),fillExtrusionDepth:ZE("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_vertical_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\nout highp float v_depth;void main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\nbase*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nvec3 pos;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base);pos=vec3(pos_nx.xy,h);\n#else\npos=vec3(pos_nx.xy,t > 0.0 ? height : base);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}'),fillExtrusionPattern:ZE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nin vec3 v_normal;\n#endif\nin vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec4 out_color=texture(u_image,pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;\n#else\nout_color=out_color*v_lighting;\n#endif\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\nout vec2 v_pos;out vec4 v_lighting;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nout vec3 v_normal;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=z;vec3 p;float c_ele;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);p=vec3(pos_nx.xy,h);\n#else\np=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;\n#ifdef LIGHTING_3D_MODE\nNdotL=calculate_NdotL(normal);\n#else\nNdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);\n#endif\nif (normal.y !=0.0) {float r=0.84;\n#ifndef LIGHTING_3D_MODE\nr=mix(0.7,0.98,1.0-u_lightintensity);\n#endif\nNdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\nv_normal=normal;\n#else\nv_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#endif \n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}'),groundShadow:ZE('#include "_prelude_shadow.fragment.glsl"\nprecision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;in float v_depth;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\nvoid main() {float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);\n#ifdef RENDER_CUTOFF\nshadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,v_depth));\n#endif\n#ifdef FOG\nshadow=mix(shadow,vec3(1.0),v_fog_opacity);\n#endif\n#ifdef INDICATOR_CUTOUT\nshadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0)).r);\n#endif\nglFragColor=vec4(shadow,1.0);}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);v_depth=gl_Position.w;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);\n#endif\n}'),fillExtrusionGroundEffect:ZE("uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;\n#ifdef SDF_SUBPASS\nin highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}\n#ifdef FOG\nin highp float v_fog;\n#endif\n#endif\nvoid main() {\n#ifdef CLEAR_SUBPASS\nvec4 color=vec4(1.0);\n#ifdef CLEAR_FROM_TEXTURE\ncolor=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));\n#endif\nglFragColor=color;\n#else\n#ifdef SDF_SUBPASS\nhighp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;\n#ifdef FOG\nfog=v_fog;\n#endif\n#ifdef RENDER_CUTOFF\nfog*=v_cutoff_opacity;\n#endif\nglFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));\n#else\nvec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);\n#ifdef OVERDRAW_INSPECTOR\ncolor=vec4(1.0);\n#endif\nglFragColor=color;HANDLE_WIREFRAME_DEBUG;\n#endif\n#endif\n}",'#include "_prelude_fog.vertex.glsl"\nin highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;\n#ifdef SDF_SUBPASS\nout highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;\n#ifdef FOG\nout highp float v_fog;\n#endif\n#endif\nuniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp vec2 u_ao;\n#pragma mapbox: define highp float flood_light_ground_radius\nconst float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {\n#pragma mapbox: initialize highp float flood_light_ground_radius\nvec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;\n#ifdef FORCE_ABS_FL_GROUND_RADIUS\nfl_ground_radius=abs(flood_light_ground_radius);\n#endif\nfloat flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(1.0,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;\n#ifdef SDF_SUBPASS\nv_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);\n#ifdef FOG\nv_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);\n#endif\n#endif\nfloat hidden_by_landmark=0.0;\n#ifdef HAS_CENTROID\nhidden_by_landmark=a_hidden_by_landmark;\n#endif\nfloat isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),hillshadePrepare:ZE("precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}","uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:ZE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef LIGHTING_3D_MODE\nglFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);\n#endif\n#ifdef FOG\nglFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),line:ZE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec4 v_uv;\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;in vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;\n#endif\nfloat luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nfloat linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef RENDER_LINE_DASH\nfloat sdfdist=texture(u_dash_image,v_tex).a;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;alpha*=linearstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);\n#endif\nhighp vec4 out_color;\n#ifdef RENDER_LINE_GRADIENT\nout_color=texture(u_gradient_image,v_uv.xy);\n#else\nout_color=color;\n#endif\nfloat trimmed=1.0;\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {if (line_progress <=trim_end && line_progress >=trim_start) {out_color=vec4(0,0,0,0);trimmed=0.0;}}\n#endif\nif (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}\n#ifdef RENDER_LINE_BORDER\nfloat edgeBlur=(border_width+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {    \nfloat Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color.rgb=mix(border_color.rgb*border_color.a*trimmed,out_color.rgb,smoothAlpha);}}\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#define EXTRUDE_SCALE 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nin highp vec4 a_packed;\n#endif\n#ifdef RENDER_LINE_DASH\nin float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec4 v_uv;\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#else\nv_gamma_scale=1.0;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nfloat a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];\n#ifdef RENDER_LINE_GRADIENT\nhighp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec4(a_uv_x,a_split_index*texel_height-half_texel_height,a_clip_start,a_clip_end);\n#else\nv_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);\n#endif\n#endif\n#ifdef RENDER_LINE_DASH\nfloat scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/floorwidth,(-normal.y*height+dash.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),linePattern:ZE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in float v_linesofar;in float v_gamma_scale;in float v_width;\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;vec2 pattern_size=vec2(display_size.x/u_tile_units_to_pixels,display_size.y);float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x=mod(v_linesofar/pattern_size.x*aspect,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));vec4 color=texture(u_image,pos);\n#ifdef LIGHTING_3D_MODE\ncolor=apply_lighting_ground(color);\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#define scale 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;in float a_linesofar;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_linesofar;out float v_gamma_scale;out float v_width;\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#else\nv_gamma_scale=1.0;\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),raster:ZE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_raster_array.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;\n#ifndef RASTER_ARRAY\nuniform sampler2D u_image0;uniform sampler2D u_image1;\n#endif\n#ifdef RASTER_COLOR\nuniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;\n#endif\nvoid main() {vec4 color0,color1,color;vec2 value;\n#ifdef RASTER_COLOR\n#ifdef RASTER_ARRAY\n#ifdef RASTER_ARRAY_LINEAR\nvalue=mix(\nraTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#else\nvalue=mix(\nraTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#endif\nif (value.y > 0.0) value.x/=value.y;\n#else\ncolor=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);\n#endif\ncolor=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;\n#else\ncolor0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);\n#endif\ncolor.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef RENDER_CUTOFF\nglFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform vec4 u_tl_br;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8;\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#elif defined(PROJECTION_GLOBE_VIEW)\nin vec2 a_pos;\n#else\nin vec2 a_pos;in vec2 a_texture_pos;\n#endif\nout vec2 v_pos0;out vec2 v_pos1;out float v_depth;void main() {vec2 uv;\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);\n#endif\n#else\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec2 globe_tl=vec2(u_tl_br.x,u_tl_br.y);vec2 globe_br=vec2(u_tl_br.z,u_tl_br.w);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=1.0-((mercatorY-globe_br.y)/(globe_tl.y-globe_br.y));float mercatorX=mercatorXfromLng(latLng[1]);float uvX=(mercatorX-globe_br.x)/(globe_tl.x-globe_br.x);vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);uv=vec2(uvX,uvY);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\nfloat w=1.0+dot(a_texture_pos,u_perspective_transform);gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\nuv=a_texture_pos/8192.0;\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;\n#ifdef RENDER_CUTOFF\nv_depth=gl_Position.z;\n#endif\n}'),symbolIcon:ZE('#include "_prelude_lighting.glsl"\nuniform sampler2D u_texture;\n#ifdef ICON_TRANSITION\nuniform float u_icon_transition;\n#endif\nin float v_fade_opacity;in vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nin vec2 v_tex_b;\n#endif\nuniform mediump float u_icon_saturation;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float emissive_strength\nlowp float alpha=opacity*v_fade_opacity;vec4 out_color;\n#ifdef ICON_TRANSITION\nvec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b)*alpha;\n#else\nout_color=texture(u_texture,v_tex_a)*alpha;\n#endif\n#ifdef SATURATION\nvec3 luma=vec3(dot(out_color.rgb,vec3(0.2126,0.7152,0.0722)));out_color.rgb=mix(luma,out_color.rgb,u_icon_saturation);\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\n#ifdef ICON_TRANSITION\nin vec2 a_texb;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform vec3 u_up_vector;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nout vec2 v_tex_b;\n#endif\nout float v_fade_opacity;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float emissive_strength\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjected_point;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetProjected_point=u_matrix*vec4(a_globe_anchor+displacement,1);\n#else\noffsetProjected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);\n#endif\nvec2 a=projected_point.xy/projected_point.w;vec2 b=offsetProjected_point.xy/offsetProjected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nvec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nv_tex_a=a_tex/u_texsize;\n#ifdef ICON_TRANSITION\nv_tex_b=a_texb/u_texsize;\n#endif\nv_fade_opacity=out_fade_opacity;}'),symbolSDF:ZE('#include "_prelude_lighting.glsl"\n#define SDF_PX 8.0\nuniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;in float v_draw_halo;in vec2 v_data0;in vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout float v_draw_halo;out vec2 v_data0;out vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);\n#else\noffsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);\n#endif\nvec2 a=projected_point.xy/projected_point.w;vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nvec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nfloat gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,out_fade_opacity);}'),symbolTextAndIcon:ZE('#include "_prelude_lighting.glsl"\n#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_halo;in float v_draw_halo;in vec4 v_data0;in vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nfloat fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nreturn;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout float v_draw_halo;out vec4 v_data0;out vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offset_projected_point=u_matrix*vec4(a_pos+vec2(1,0),0,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offset_projected_point.xy/offset_projected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*font_scale);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nfloat out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nfloat gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,out_fade_opacity,is_sdf);}'),terrainRaster:ZE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;in vec2 v_pos0;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;in float v_depth;\n#endif\nuniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;\n#ifdef LIGHTING_3D_MODE\nconst vec3 normal=vec3(0.0,0.0,1.0);\n#ifdef RENDER_SHADOWS\nfloat cutoffOpacity=1.0;\n#ifdef RENDER_CUTOFF\ncutoffOpacity=cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nvec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,v_depth,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;\n#else\nfloat lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));\n#endif\n#else\nfloat lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;\n#endif\n#endif\n#else\ncolor=image_color;\n#endif\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#else\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;\n#endif\nvoid main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\nv_fog_pos=fog_position(decodedPos);\n#else\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);v_depth=gl_Position.w;\n#endif\n}'),terrainDepth:ZE("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}'),skybox:ZE('#include "_prelude_fog.fragment.glsl"\nin lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',DE),skyboxGradient:ZE('#include "_prelude_fog.fragment.glsl"\nin highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',DE),skyboxCapture:ZE("\nin highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}","in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:ZE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;in vec2 v_pos0;\n#ifndef FOG\nuniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;\n#endif\nvoid main() {vec4 color;\n#ifdef CUSTOM_ANTIALIASING\nvec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);vec3 dir=normalize(ray_dir);vec3 closest_point=dot(u_globe_pos,dir)*dir;float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nraster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(raster.rgb*antialias,antialias);\n#else\nraster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;\n#else\ncolor=apply_lighting_ground(color);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;\n#endif\nout vec2 v_pos0;void main() {\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;vec2 uv=a_uv;\n#else\nfloat tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);\n#endif\nv_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;\n#ifdef GLOBE_POLES\nvec3 up_vector=globe_derived_up_vector;\n#else\nvec3 up_vector=elevationVector(tile_pos);\n#endif\nfloat height=elevation(tile_pos);globe_pos+=up_vector*height;\n#ifndef GLOBE_POLES\nglobe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;\n#endif\n#ifdef GLOBE_POLES\nvec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);\n#else\nvec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);\n#endif\ngl_Position=u_proj_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n}'),globeAtmosphere:ZE('#include "_prelude_fog.fragment.glsl"\nuniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;\n#ifdef PROJECTION_GLOBE_VIEW\nglobe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {\n#ifdef ALPHA_PASS\nglFragColor=vec4(0,0,0,0);return;\n#else\n#ifdef NATIVE\nglFragColor=vec4(1,1,1,1);\n#else\nglFragColor=vec4(0,0,0,1);\n#endif\nreturn;\n#endif\n}\n#endif\nhighp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?\n0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;\n#ifdef PROJECTION_GLOBE_VIEW\nhighp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?\nPI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);\n#else\nhorizon_angle=horizon_angle_mercator;\n#endif\nhorizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;\n#ifdef ALPHA_PASS\nfloat a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);\n#else\nvec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;\n#ifndef NATIVE\nc=dither(c,gl_FragCoord.xy+u_temporal_offset);\n#endif\nglFragColor=vec4(c*t,t);\n#endif\n}',"in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(\nmix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}"),model:ZE('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#ifdef HAS_ATTRIBUTE_a_pbr\nin lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;\n#endif\n#ifdef HAS_TEXTURE_u_baseColorTexture\nuniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;\n#endif\n#ifdef HAS_TEXTURE_u_metallicRoughnessTexture\nuniform sampler2D u_metallicRoughnessTexture;\n#endif\n#ifdef HAS_TEXTURE_u_occlusionTexture\nuniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;\n#endif\n#ifdef HAS_TEXTURE_u_normalTexture\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef HAS_TEXTURE_u_emissionTexture\nuniform sampler2D u_emissionTexture;\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nin highp float v_depth;uniform sampler2D u_depthTexture;uniform vec2 u_inv_depth_size;bool isOccluded() {vec2 coord=gl_FragCoord.xy*u_inv_depth_size;highp float depth=unpack_depth(texture(u_depthTexture,coord));return v_depth > depth+0.0005;}\n#endif\n#define saturate(_x) clamp(_x,0.,1.)\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)\n{\n#ifdef LIGHTING_3D_MODE\nvec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));\n#endif\nreturn apply_lighting(albedo,transformed_normal,lighting_factor);\n#else\nvec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;\n#endif\n}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;\n#ifdef HAS_ATTRIBUTE_a_color_3f\nalbedo*=vec4(color_3f,1.0);\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#else\n#ifdef HAS_ATTRIBUTE_a_color_4f\nalbedo*=color_4f;\n#endif\n#endif\n#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)\nvec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}\n#ifdef UNPREMULT_TEXTURE_IN_SHADER\nif(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;\n#endif\ntexColor.rgb=sRGBToLinear(texColor.rgb);if(u_baseTextureIsAlpha) {if (texColor.w < 0.5) {discard;}albedo*=mix(vec4(texColor.rgb,texColor.a),vec4(texColor.a),float(u_baseTextureIsAlpha));} else {albedo*=texColor;}\n#endif\nreturn vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {\n#ifdef HAS_TEXTURE_u_normalTexture\nhighp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;\n#else\nreturn mat3(1.0);\n#endif\n}highp vec3 getNormal(){highp vec3 n;\n#ifdef HAS_ATTRIBUTE_a_normal_3f\nn=normalize(normal_3f);\n#else\nhighp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;\n#endif\n#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nvec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);\n#endif\nreturn n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;\n#ifdef HAS_ATTRIBUTE_a_pbr\nmat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;\n#endif\n#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) \nvec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;\n#endif\nconst float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)\n{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)\n{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)\n{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)\n{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)\n{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)\n{\n#ifdef LIGHTING_3D_MODE\nreturn mat.diffuseColor;\n#else\nreturn mat.diffuseColor/PI;\n#endif\n}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)\n{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)\n{vec3 env_light=vec3(0.65,0.65,0.65);\n#ifdef LIGHTING_3D_MODE\nfloat ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;\n#endif\nvec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)\n{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=NdotL;\n#endif\nvec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;\n#if !defined(LIGHTING_3D_MODE)\nconst vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);\n#endif\ncolor*=intensityFactor;return color;}void main() {\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nif (isOccluded()) {discard;}\n#endif\nvec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;\n#ifdef LIGHTING_3D_MODE\nlightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;\n#endif\nvec4 finalColor;\n#ifdef DIFFUSE_SHADED\nvec3 N=getNormal();vec3 diffuse=getDiffuseShadedColor(getBaseColor().rgb,N,lightDir,lightColor);\n#ifdef HAS_TEXTURE_u_occlusionTexture\nfloat ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;\n#endif\nfinalColor=vec4(diffuse,1.0)*u_opacity;\n#else\nMaterial mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;\n#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nao=(texture(u_occlusionTexture,uv_2f).x-1.0)*u_aoIntensity+1.0;color*=ao;\n#endif\nvec4 emissive=u_emissiveFactor;\n#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nemissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);\n#endif\ncolor+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;\n#ifdef HAS_ATTRIBUTE_a_pbr\nfloat resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);color=mix(color,v_color_mix.rgb,min(1.0,resEmission));\n#ifdef HAS_ATTRIBUTE_a_color_4f\nfloat distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);\n#endif\n#endif\nvec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);\n#endif\n#ifdef FOG\nfinalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));\n#endif\n#ifdef RENDER_CUTOFF\nfinalColor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nfinalColor=applyCutout(finalColor);\n#endif\nglFragColor=finalColor;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr\n#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength\nuniform mat4 u_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_normal_matrix;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\nout vec4 v_position_height;out lowp vec4 v_color_mix;\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nout highp float v_depth;\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\nout lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;\n#endif\nvec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute-custom highp vec4 pbr\n#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength\nhighp mat4 normal_matrix;\n#ifdef INSTANCED_ARRAYS\nnormal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\nnormal_matrix=u_normal_matrix;\n#endif\nvec3 local_pos;mat3 rs;\n#ifdef MODEL_POSITION_ON_GPU\nvec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=u_matrix*pos;pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;\n#else\nlocal_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);\n#endif\nv_position_height.w=a_pos_3f.z;\n#ifdef HAS_ATTRIBUTE_a_pbr\nvec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(local_pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nv_depth=gl_Position.z/gl_Position.w;\n#endif\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nfloat x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);\n#else\nnormal_3f=vec3(normal_matrix*vec4(normal_3f,0));\n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#ifdef HAS_ATTRIBUTE_a_color_4f\nv_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shadow_pos=local_pos;\n#ifdef NORMAL_OFFSET\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nvec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos+=offset*shadow_normal_offset_multiplier0();\n#else\nvec3 offset=shadow_normal_offset_model(normalize(normal_3f));shadow_pos+=offset*shadow_normal_offset_multiplier0();\n#endif\n#endif\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1);v_depth_shadows=gl_Position.w;\n#endif\n}'),modelDepth:ZE("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;\n#ifdef MODEL_POSITION_ON_GPU\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_instance;\n#endif\nuniform highp mat4 u_node_matrix;\n#endif\nvoid main() {\n#ifdef MODEL_POSITION_ON_GPU\nhighp mat4 instance;\n#ifdef INSTANCED_ARRAYS\ninstance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\ninstance=u_instance;\n#endif\nvec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=u_matrix*pos;\n#else\ngl_Position=u_matrix*vec4(a_pos_3f,1);\n#endif\nv_depth=gl_Position.z/gl_Position.w;}"),stars:ZE("in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)\n{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}","\nin vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}")};function qE(C,te){const le=C.replace(/\s*\/\/[^\n]*\n/g,"\n").split("\n");for(let C of le)if(C=C.trim(),"#"===C[0]&&C.includes("if")&&!C.includes("endif")){C=C.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const le=C.split(" ");for(const C of le)te.includes(C)||te.push(C)}}function ZE(C,te){const le=/#include\s+"([^"]+)"/g,ce=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let he=te.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);he&&(he=he.map((C=>{const te=C.split(" ");return te[te.length-1]})),he=[...new Set(he)]);const ue={},de=[],_e=[];C=C.replace(le,((C,te)=>(_e.push(te),""))),te=te.replace(le,((C,te)=>(de.push(te),"")));let ye=[...FE];qE(C,ye),qE(te,ye);for(const C of[...de,..._e])NE[C]||console.error(`Undefined include: ${C}`),jE[C]||(jE[C]=[],qE(NE[C],jE[C])),ye=[...ye,...jE[C]];return{fragmentSource:C=C.replace(ce,((C,te,le,ce,he)=>(ue[he]=!0,"define"===te?`\n#ifndef HAS_UNIFORM_u_${he}\nin ${le} ${ce} ${he};\n#else\nuniform ${le} ${ce} u_${he};\n#endif\n`:"initialize"===te?`\n#ifdef HAS_UNIFORM_u_${he}\n    ${le} ${ce} ${he} = u_${he};\n#endif\n`:"define-attribute"===te?`\n#ifdef HAS_ATTRIBUTE_a_${he}\n    in ${le} ${ce} ${he};\n#endif\n`:"initialize-attribute"===te?"":void 0))),vertexSource:te=te.replace(ce,((C,te,le,ce,he)=>{const de="float"===ce?"vec2":ce,_e=he.match(/color/)?"color":de;return"define-attribute-vertex-shader-only"===te?`\n#ifdef HAS_ATTRIBUTE_a_${he}\nin ${le} ${ce} a_${he};\n#endif\n`:ue[he]?"define"===te?`\n#ifndef HAS_UNIFORM_u_${he}\nuniform lowp float u_${he}_t;\nin ${le} ${de} a_${he};\nout ${le} ${ce} ${he};\n#else\nuniform ${le} ${ce} u_${he};\n#endif\n`:"initialize"===te?"vec4"===_e?`\n#ifndef HAS_UNIFORM_u_${he}\n    ${he} = a_${he};\n#else\n    ${le} ${ce} ${he} = u_${he};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${he}\n    ${he} = unpack_mix_${_e}(a_${he}, u_${he}_t);\n#else\n    ${le} ${ce} ${he} = u_${he};\n#endif\n`:"define-attribute"===te?`\n#ifdef HAS_ATTRIBUTE_a_${he}\n    in ${le} ${ce} a_${he};\n    out ${le} ${ce} ${he};\n#endif\n`:"initialize-attribute"===te?`\n#ifdef HAS_ATTRIBUTE_a_${he}\n    ${he} = a_${he};\n#endif\n`:void 0:"define"===te?`\n#ifndef HAS_UNIFORM_u_${he}\nuniform lowp float u_${he}_t;\nin ${le} ${de} a_${he};\n#else\nuniform ${le} ${ce} u_${he};\n#endif\n`:"define-instanced"===te?"mat4"===_e?`\n#ifdef INSTANCED_ARRAYS\nin vec4 a_${he}0;\nin vec4 a_${he}1;\nin vec4 a_${he}2;\nin vec4 a_${he}3;\n#else\nuniform ${le} ${ce} u_${he};\n#endif\n`:`\n#ifdef INSTANCED_ARRAYS\nin ${le} ${de} a_${he};\n#else\nuniform ${le} ${ce} u_${he};\n#endif\n`:"initialize-attribute-custom"===te?`\n#ifdef HAS_ATTRIBUTE_a_${he}\n    ${le} ${ce} ${he} = a_${he};\n#endif\n`:"vec4"===_e?`\n#ifndef HAS_UNIFORM_u_${he}\n    ${le} ${ce} ${he} = a_${he};\n#else\n    ${le} ${ce} ${he} = u_${he};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${he}\n    ${le} ${ce} ${he} = unpack_mix_${_e}(a_${he}, u_${he}_t);\n#else\n    ${le} ${ce} ${he} = u_${he};\n#endif\n`})),staticAttributes:he,usedDefines:ye,vertexIncludes:de,fragmentIncludes:_e}}class $E{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(C,te,le,ce,he,ue,de,_e){this.context=C;let ye=this.boundPaintVertexBuffers.length!==ce.length;for(let C=0;!ye&&C<ce.length;C++)this.boundPaintVertexBuffers[C]!==ce[C]&&(ye=!0);let ve=this.boundDynamicVertexBuffers.length!==de.length;for(let C=0;!ve&&C<de.length;C++)this.boundDynamicVertexBuffers[C]!==de[C]&&(ve=!0);if(!this.vao||this.boundProgram!==te||this.boundLayoutVertexBuffer!==le||ye||ve||this.boundIndexBuffer!==he||this.boundVertexOffset!==ue)this.freshBind(te,le,ce,he,ue,de,_e);else{C.bindVertexArrayOES.set(this.vao);for(const le of de)le&&(le.bind(),_e&&le.instanceCount&&le.setVertexAttribDivisor(C.gl,te,_e));he&&he.dynamicDraw&&he.bind()}}freshBind(C,te,le,ce,he,ue,de){const _e=C.numAttributes,ye=this.context,ve=ye.gl;this.vao&&this.destroy(),this.vao=ye.gl.createVertexArray(),ye.bindVertexArrayOES.set(this.vao),this.boundProgram=C,this.boundLayoutVertexBuffer=te,this.boundPaintVertexBuffers=le,this.boundIndexBuffer=ce,this.boundVertexOffset=he,this.boundDynamicVertexBuffers=ue,te.enableAttributes(ve,C),te.bind(),te.setVertexAttribPointers(ve,C,he);for(const te of le)te.enableAttributes(ve,C),te.bind(),te.setVertexAttribPointers(ve,C,he);for(const te of ue)te&&(te.enableAttributes(ve,C),te.bind(),te.setVertexAttribPointers(ve,C,he),de&&te.instanceCount&&te.setVertexAttribDivisor(ve,C,de));ce&&ce.bind(),ye.currentNumAttributes=_e}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function WE(C,te){const le=Math.pow(2,te.canonical.z),ce=te.canonical.y;return[new lp(0,ce/le).toLngLat().lat,new lp(0,(ce+1)/le).toLngLat().lat]}function HE(C,te,le,ce,he,ue,de){const _e=C.context,ye=_e.gl,ve=le.hillshadeFBO;if(!ve)return;C.prepareDrawTile();const Se=C.isTileAffectedByFog(te),Me=C.getOrCreateProgram("hillshade",{overrideFog:Se});_e.activeTexture.set(ye.TEXTURE0),ye.bindTexture(ye.TEXTURE_2D,ve.colorAttachment.get());const Ae=((C,te,le,ce)=>{const he=le.paint.get("hillshade-shadow-color"),ue=le.paint.get("hillshade-highlight-color"),de=le.paint.get("hillshade-accent-color"),_e=le.paint.get("hillshade-emissive-strength");let ye=w(le.paint.get("hillshade-illumination-direction"));if("viewport"===le.paint.get("hillshade-illumination-anchor"))ye-=C.transform.angle;else if(C.style&&C.style.enable3dLights()&&C.style.directionalLight){const te=C.style.directionalLight.properties.get("direction");ye=w(J(te.x,te.y,te.z)[1])}const ve=!C.options.moving;return{u_matrix:ce||C.transform.calculateProjMatrix(te.tileID.toUnwrapped(),ve),u_image:0,u_latrange:WE(0,te.tileID),u_light:[le.paint.get("hillshade-exaggeration"),ye],u_shadow:he,u_highlight:ue,u_emissive_strength:_e,u_accent:de}})(C,le,ce,C.terrain?te.projMatrix:null);C.uploadCommonUniforms(_e,Me,te.toUnwrapped());const{tileBoundsBuffer:Ce,tileBoundsIndexBuffer:Oe,tileBoundsSegments:Ne}=C.getTileBoundsBuffers(le);Me.draw(C,ye.TRIANGLES,he,ue,de,Dx.disabled,Ae,ce.id,Ce,Oe,Ne)}function XE(C,te,le){if(!te.needsDEMTextureUpload)return;const ce=C.context,he=ce.gl;ce.pixelStoreUnpackPremultiplyAlpha.set(!1),te.demTexture=te.demTexture||C.getTileTexture(le.stride);const ue=le.getPixels();te.demTexture?te.demTexture.update(ue,{premultiply:!1}):te.demTexture=new My(ce,ue,he.R32F,{premultiply:!1}),te.needsDEMTextureUpload=!1}function YE(C,te,le){const ce=C.context,he=ce.gl;if(!te.dem)return;const ue=te.dem;if(ce.activeTexture.set(he.TEXTURE1),XE(C,te,ue),!te.demTexture)return;te.demTexture.bind(he.NEAREST,he.CLAMP_TO_EDGE);const de=ue.dim;ce.activeTexture.set(he.TEXTURE0);let _e=te.hillshadeFBO;if(!_e){const C=new My(ce,{width:de,height:de,data:null},he.RGBA);C.bind(he.LINEAR,he.CLAMP_TO_EDGE),_e=te.hillshadeFBO=ce.createFramebuffer(de,de,!0,"renderbuffer"),_e.colorAttachment.set(C.texture)}ce.bindFramebuffer.set(_e.framebuffer),ce.viewport.set([0,0,de,de]);const{tileBoundsBuffer:ye,tileBoundsIndexBuffer:ve,tileBoundsSegments:Se}=C.getMercatorTileBoundsBuffers(),Me=[];C.linearFloatFilteringSupported()&&Me.push("TERRAIN_DEM_FLOAT_FORMAT"),C.getOrCreateProgram("hillshadePrepare",{defines:Me}).draw(C,he.TRIANGLES,Mx.disabled,Sx.disabled,Cx.unblended,Dx.disabled,((C,te)=>{const le=te.stride,ce=ld.create();return ld.ortho(ce,0,Mn,-Mn,0,0,1),ld.translate(ce,ce,[0,-Mn,0]),{u_matrix:ce,u_image:1,u_dimension:[le,le],u_zoom:C.overscaledZ}})(te.tileID,ue),le.id,ye,ve,Se),te.needsHillshadePrepare=!1}const KE=C=>({u_matrix:new jl(C),u_image0:new kl(C),u_skirt_height:new Ol(C),u_ground_shadow_factor:new Fl(C)}),JE=(C,te,le)=>({u_matrix:C,u_image0:0,u_skirt_height:te,u_ground_shadow_factor:le}),QE=(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe)=>({u_proj_matrix:Float32Array.from(C),u_globe_matrix:te,u_normalize_matrix:Float32Array.from(ce),u_merc_matrix:le,u_zoom_transition:he,u_merc_center:ue,u_image0:0,u_frustum_tl:de,u_frustum_tr:_e,u_frustum_br:ye,u_frustum_bl:ve,u_globe_pos:Se,u_globe_radius:Me,u_viewport:Ae,u_grid_matrix:Oe?Float32Array.from(Oe):new Float32Array(9),u_skirt_height:Ce}),eM=(C,te)=>{if(te>0&&C.terrain&&H("Cutoff is currently disabled on terrain"),te<=0||C.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,0]}};const le=C.transform,ce=Math.max(Math.abs(le._zoom-(C.minCutoffZoom-1)),1),he=le.isLODDisabled(!1)?P(60,45,le.pitch):P(30,15,le.pitch),ue=le._farZ-le._nearZ,de=te*le.height,_e=((1-(ye=he))*(.75*le.cameraToCenterDistance)+ye*(le._farZ+de))*ce;var ye;return{shouldRenderCutoff:he<1,uniformValues:{u_cutoff_params:[le._nearZ,le._farZ,(_e-le._nearZ)/ue,(_e-de-le._nearZ)/ue]}}};function tM(C,te){return null!=C&&null!=te&&!(!C.hasData()||!te.hasData())&&null!=C.demTexture&&null!=te.demTexture&&C.tileID.key!==te.tileID.key}const iA=new class{constructor(){this.operations={}}newMorphing(C,te,le,ce,he){if(C in this.operations){const te=this.operations[C];te.to.tileID.key!==le.tileID.key&&(te.queued=le)}else this.operations[C]={startTime:ce,phase:0,duration:he,from:te,to:le,queued:null}}getMorphValuesForProxy(C){if(!(C in this.operations))return null;const te=this.operations[C];return{from:te.from,to:te.to,phase:te.phase}}update(C){for(const te in this.operations){const le=this.operations[te];for(le.phase=(C-le.startTime)/le.duration;le.phase>=1||!this._validOp(le);)if(!this._nextOp(le,C)){delete this.operations[te];break}}}_nextOp(C,te){return!!C.queued&&(C.from=C.to,C.to=C.queued,C.queued=null,C.phase=0,C.startTime=te,!0)}_validOp(C){return C.from.hasData()&&C.to.hasData()}},rA={0:null,1:"TERRAIN_VERTEX_MORPHING"};function nM(C,te,le){if(0===te)return 0;const ce=te<1&&514===le?.25/te:1;return 6*Math.pow(1.5,22-C)*Math.max(te,1)*ce}function oM(C,te){const le=1<<C.z;return!te&&(0===C.x||C.x===le-1)||0===C.y||C.y===le-1}const sM=C=>({u_matrix:C});function aM(C,te,le,ce,he){if(he>0){const ue=bi.now(),de=(ue-C.timeAdded)/he,_e=te?(ue-te.timeAdded)/he:-1,ye=le.getSource(),ve=ce.coveringZoomLevel({tileSize:ye.tileSize,roundZoom:ye.roundZoom}),Se=!te||Math.abs(te.tileID.overscaledZ-ve)>Math.abs(C.tileID.overscaledZ-ve),Me=Se&&C.refreshedUponExpiration?1:z(Se?de:1-_e,0,1);return C.refreshedUponExpiration&&de>=1&&(C.refreshedUponExpiration=!1),te?{opacity:1,mix:1-Me}:{opacity:Me,mix:0}}return{opacity:1,mix:0}}class lM extends Lx{constructor(C){const te={type:"raster-dem",maxzoom:C.transform.maxZoom},le=new Ew(Ww(),null),ce=ST("mock-dem",te,le,C.style);super("mock-dem",ce,!1),ce.setEventedParent(this),this._sourceLoaded=!0}_loadTile(C,te){C.state="loaded",te(null)}}class cM extends Lx{constructor(C){const te=ST("proxy",{type:"geojson",maxzoom:C.transform.maxZoom},new Ew(Ww(),null),C.style);super("proxy",te,!1),te.setEventedParent(this),this.map=this.getSource().map=C,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(C,te,le){if(C.freezeTileCoverage)return;this.transform=C;const ce=C.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce(((te,le)=>{if(te[le.key]="",!this._tiles[le.key]){const te=new Oy(le,this._source.tileSize*le.overscaleFactor(),C.tileZoom);te.state="loaded",this._tiles[le.key]=te}return te}),{});for(const C in this._tiles)C in ce||(this.freeFBO(C),this._tiles[C].unloadVectorData(),delete this._tiles[C])}freeFBO(C){const te=this.proxyCachedFBO[C];if(void 0!==te){const le=Object.values(te);this.renderCachePool.push(...le),delete this.proxyCachedFBO[C]}}deallocRenderCache(){this.renderCache.forEach((C=>C.fb.destroy())),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class hM extends qu{constructor(C,te,le){super(C.overscaledZ,C.wrap,C.canonical.z,C.canonical.x,C.canonical.y),this.proxyTileKey=te,this.projMatrix=le}}class uM extends Km{constructor(C,te){super(),this.painter=C,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[le,ce,he]=function(C){const te=new za,le=new Wa,ce=131;te.reserve(17161),le.reserve(33800);const he=Mn/128,ue=Mn+he/2,de=ue+he;for(let C=-he;C<de;C+=he)for(let le=-he;le<de;le+=he){const ce=le<0||le>ue||C<0||C>ue?24575:0,he=z(Math.round(le),0,Mn),de=z(Math.round(C),0,Mn);te.emplaceBack(he+ce,de)}const a=(C,te)=>{const he=te*ce+C;le.emplaceBack(he+1,he,he+ce),le.emplaceBack(he+ce,he+ce+1,he+1)};for(let C=1;C<129;C++)for(let te=1;te<129;te++)a(te,C);return[0,129].forEach((C=>{for(let te=0;te<130;te++)a(te,C),a(C,te)})),[te,le,32768]}(),ue=C.context;this.gridBuffer=ue.createVertexBuffer(le,rp.members),this.gridIndexBuffer=ue.createIndexBuffer(ce),this.gridSegments=xl.simpleSegment(0,0,le.length,ce.length),this.gridNoSkirtSegments=xl.simpleSegment(0,0,le.length,he),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new cM(te.map),this.orthoMatrix=ld.create(),ld.ortho(this.orthoMatrix,"globe"===this.painter.transform.projection.name?.015:0,Mn,0,Mn,0,1);const de=ue.gl;this._overlapStencilMode=new Sx({func:de.GEQUAL,mask:255},0,255,de.KEEP,de.KEEP,de.REPLACE),this._previousZoom=C.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=te,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new lM(te.map),this._pendingGroundEffectLayers=[]}set style(C){C.on("data",this._onStyleDataEvent.bind(this)),this._style=C,this._style.map.on("moveend",(()=>{this._clearLineLayersFromRenderCache()}))}update(C,te,le){if(C&&C.terrain){this._style!==C&&(this.style=C,this._evaluationZoom=void 0);const ce=C.terrain.properties,he=0===C.terrain.drapeRenderMode,ue=C.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=bi.now();const de=C.terrain&&C.terrain.scope,_e=ce.get("source"),ye=he?this._mockSourceCache:C.getSourceCache(_e,de);if(!ye)return void H(`Couldn't find terrain source "${_e}".`);if(this.sourceCache=ye,this._exaggeration=ue?this.calculateExaggeration(te):ce.get("exaggeration"),!te.projection.requiresDraping&&ue&&0===this._exaggeration)return void this._disable();this.enabled=!0;const c=()=>{this.sourceCache.used&&H(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.\nThis leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const C=this.getScaledDemTileSize();this.sourceCache.update(te,C,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,c(),this._initializing=!0),c(),te.updateElevation(!0,le),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(te),this._emptyDEMTextureDirty=!0,this._previousZoom=te.zoom}else this._disable()}calculateExaggeration(C){const te=this._previousCameraAltitude,le=C.getFreeCameraOptions().position.z/C.pixelsPerMeter*C.worldSize;this._previousCameraAltitude=le;const ce=null!=te?le-te:Number.MAX_VALUE;if(Math.abs(ce)<2)return this._exaggeration;const he=C.zoom,ue=this._style.terrain;if(!this._previousUpdateTimestamp)return ue.getExaggeration(he);let de=he-this._previousZoom;const _e=this._previousUpdateTimestamp;let ye=he;null!=this._evaluationZoom&&(ye=this._evaluationZoom,Math.abs(he-ye)>.5&&(de=.5*(he-ye+de)),de*ce<0&&(ye+=de)),this._evaluationZoom=ye;const ve=ue.getExaggeration(ye),Se=ve===ue.getExaggeration(Math.max(0,ye-.1));if(Se&&Math.abs(ve-this._exaggeration)<.01)return ve;let Me=Math.min(.1,.00375*(this._updateTimestamp-_e));return(Se||ve<.1||Math.abs(de)<1e-4)&&(Me=Math.min(.2,4*Me)),Kr(this._exaggeration,ve,Me)}resetTileLookupCache(C){this._findCoveringTileCache[C]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(C){C.coord&&"source"===C.dataType?this._clearRenderCacheForTile(C.sourceCacheId,C.coord):"style"===C.dataType&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const C in this._style._mergedSourceCaches)this._style._mergedSourceCaches[C].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach((C=>C.fb.destroy())),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this._exaggeration}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const C=2*this.proxySourceCache.getSource().tileSize;return[C,C]}set useVertexMorphing(C){this._useVertexMorphing=C}updateTileBinding(C){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const te=this.proxySourceCache,le=this.painter.transform;this._initializing&&(this._initializing=0===le._centerAltitude&&-1===this.getAtPointOrZero(lp.fromLngLat(le.center),-1),this._emptyDEMTextureDirty=!this._initializing);const ce=this.proxyCoords=te.getIds().map((C=>{const ce=te.getTileByID(C).tileID;return ce.projMatrix=le.calculateProjMatrix(ce.toUnwrapped()),ce}));!function(C,te){const le=te.transform.pointCoordinate(te.transform.getCameraPoint()),ce=new je(le.x,le.y);C.sort(((C,te)=>{if(te.overscaledZ-C.overscaledZ)return te.overscaledZ-C.overscaledZ;const le=new je(C.canonical.x+(1<<C.canonical.z)*C.wrap,C.canonical.y),he=new je(te.canonical.x+(1<<te.canonical.z)*te.wrap,te.canonical.y),ue=ce.mult(1<<C.canonical.z);return ue.x-=.5,ue.y-=.5,ue.distSqr(le)-ue.distSqr(he)}))}(ce,this.painter);const he=this.proxyToSource||{};this.proxyToSource={},ce.forEach((C=>{this.proxyToSource[C.key]={}})),this.terrainTileForTile={};const ue=this._style._mergedSourceCaches;for(const te in ue){const le=ue[te];if(!le.used)continue;if(le!==this.sourceCache&&this.resetTileLookupCache(le.id),this._setupProxiedCoordsForOrtho(le,C[te],he),le.usedForTerrain)continue;const ce=C[te];le.getSource().reparseOverscaled&&this._assignTerrainTiles(ce)}this.proxiedCoords[te.id]=ce.map((C=>new hM(C,C.key,this.orthoMatrix))),this._assignTerrainTiles(ce),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(he),this.renderingToTexture=!1;const de={};this._visibleDemTiles=[];for(const C of this.proxyCoords){const te=this.terrainTileForTile[C.key];if(!te)continue;const le=te.tileID.key;le in de||(this._visibleDemTiles.push(te),de[le]=le)}}_assignTerrainTiles(C){this._initializing||C.forEach((C=>{if(this.terrainTileForTile[C.key])return;const te=this._findTileCoveringTileID(C,this.sourceCache);te&&(this.terrainTileForTile[C.key]=te)}))}_prepareDEMTextures(){const C=this.painter.context,te=C.gl;for(const le in this.terrainTileForTile){const ce=this.terrainTileForTile[le],he=ce.dem;!he||ce.demTexture&&!ce.needsDEMTextureUpload||(C.activeTexture.set(te.TEXTURE1),XE(this.painter,ce,he))}}_prepareDemTileUniforms(C,te,le,ce){if(!te||null==te.demTexture)return!1;const he=C.tileID.canonical,ue=Math.pow(2,te.tileID.canonical.z-he.z),de=ce||"";return le[`u_dem_tl${de}`]=[he.x*ue%1,he.y*ue%1],le[`u_dem_scale${de}`]=ue,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){const C=this.painter.context,te=C.gl;if(!this._emptyDepthBufferTexture){const le=new ef({width:1,height:1},Uint8Array.of(255,255,255,255));this._emptyDepthBufferTexture=new My(C,le,te.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){let C=0;const te=this._visibleDemTiles.reduce(((te,le)=>{if(!le.dem)return te;const ce=le.dem.tree.minimums[0];return ce>0&&C++,te+ce}),0);return C?te/C:0}_updateEmptyDEMTexture(){const C=this.painter.context,te=C.gl;C.activeTexture.set(te.TEXTURE2);const le=this._getLoadedAreaMinimum(),[ce,he]=(()=>{const C=new tf({width:1,height:1},new Float32Array([le]));return[te.R32F,C]})();this._emptyDEMTextureDirty=!1;let ue=this._emptyDEMTexture;return ue?ue.update(he,{premultiply:!1}):ue=this._emptyDEMTexture=new My(C,he,ce,{premultiply:!1}),ue}setupElevationDraw(C,te,le){const ce=this.painter.context,he=ce.gl,ue={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0};ue.u_exaggeration=this.exaggeration();let de=null,_e=null,ye=1;if(le&&le.morphing&&this._useVertexMorphing){const te=le.morphing.srcDemTile,ce=le.morphing.dstDemTile;ye=le.morphing.phase,te&&ce&&(this._prepareDemTileUniforms(C,te,ue,"_prev")&&(_e=te),this._prepareDemTileUniforms(C,ce,ue)&&(de=ce))}const c=C=>C&&C.demTexture&&this.painter.linearFloatFilteringSupported()?he.LINEAR:he.NEAREST,h=C=>{ue.u_dem_size=1===C.size[0]?1:C.size[0]-2};if(_e&&de)ce.activeTexture.set(he.TEXTURE2),de.demTexture.bind(c(de),he.CLAMP_TO_EDGE),ce.activeTexture.set(he.TEXTURE4),_e.demTexture.bind(c(_e),he.CLAMP_TO_EDGE),de.demTexture&&h(de.demTexture),ue.u_dem_lerp=ye;else{de=this.terrainTileForTile[C.tileID.key],ce.activeTexture.set(he.TEXTURE2);const te=this._prepareDemTileUniforms(C,de,ue)?de.demTexture:this.emptyDEMTexture;te.bind(c(de),he.CLAMP_TO_EDGE),h(te)}if(ce.activeTexture.set(he.TEXTURE3),le&&le.useDepthForOcclusion?(this._depthTexture&&this._depthTexture.bind(he.NEAREST,he.CLAMP_TO_EDGE),this._depthFBO&&(ue.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height])):(this.emptyDepthBufferTexture.bind(he.NEAREST,he.CLAMP_TO_EDGE),ue.u_depth_size_inv=[1,1]),le&&le.useMeterToDem&&de){const C=(1<<de.tileID.canonical.z)*Qd(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;ue.u_meter_to_dem=C}if(le&&le.labelPlaneMatrixInv&&(ue.u_label_plane_matrix_inv=le.labelPlaneMatrixInv),te.setTerrainUniformValues(ce,ue),"globe"===this.painter.transform.projection.name){const he=this.globeUniformValues(this.painter.transform,C.tileID.canonical,le&&le.useDenormalizedUpVectorScale);te.setGlobeUniformValues(ce,he)}}globeUniformValues(C,te,le){const ce=C.projection;return{u_tile_tl_up:ce.upVector(te,0,0),u_tile_tr_up:ce.upVector(te,Mn,0),u_tile_br_up:ce.upVector(te,Mn,Mn),u_tile_bl_up:ce.upVector(te,0,Mn),u_tile_up_scale:le?hd(1):ce.upVectorScale(te,C.center.lat,C.worldSize).metersToTile}}renderToBackBuffer(C){const te=this.painter,le=this.painter.context;0!==C.length&&(le.bindFramebuffer.set(null),le.viewport.set([0,0,te.width,te.height]),te.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(C,te,le,ce,he){if("globe"===C.transform.projection.name)!function(C,te,le,ce,he){const ue=C.context,de=ue.gl;let _e,ye;const ve=C.transform,Se=Ld(C,ue,ve),u=(te,le)=>{if(ye===le)return;const ce=[rA[le],"PROJECTION_GLOBE_VIEW"];Se&&ce.push("CUSTOM_ANTIALIASING");const he=C.isTileAffectedByFog(te);_e=C.getOrCreateProgram("globeRaster",{defines:ce,overrideFog:he}),ye=le},Me=C.colorModeForRenderPass(),Ae=new Mx(de.LEQUAL,Mx.ReadWrite,C.depthRangeFor3D);iA.update(he);const Ce=Pd(ve),Oe=[Kd(ve.center.lng),Jd(ve.center.lat)],Ne=C.globeSharedBuffers,je=[ve.width*bi.devicePixelRatio,ve.height*bi.devicePixelRatio],Ge=Float32Array.from(ve.globeMatrix),Ze={useDenormalizedUpVectorScale:!0};{const ve=C.transform,Se=nM(ve.zoom,te.exaggeration(),te.sourceCache._source.tileSize);ye=-1;const qe=de.TRIANGLES;for(const ye of ce){const ce=le.getTile(ye),$e=Sx.disabled,He=te.prevTerrainTileForTile[ye.key],We=te.terrainTileForTile[ye.key];tM(He,We)&&iA.newMorphing(ye.key,He,We,he,250),ue.activeTexture.set(de.TEXTURE0),ce.texture&&ce.texture.bind(de.LINEAR,de.CLAMP_TO_EDGE);const Xe=iA.getMorphValuesForProxy(ye.key),Ye=Xe?1:0;Xe&&Lt(Ze,{morphing:{srcDemTile:Xe.from,dstDemTile:Xe.to,phase:M(Xe.phase)}});const Je=xd(ye.canonical),Qe=Od(Je.getCenter().lat),tt=kd(ye.canonical,Je,Qe,ve.worldSize/ve._pixelsPerMercatorPixel),rt=Ad(fd(ye.canonical)),ot=QE(ve.expandedFarZProjMatrix,Ge,Ce,rt,Dd(ve.zoom),Oe,ve.frustumCorners.TL,ve.frustumCorners.TR,ve.frustumCorners.BR,ve.frustumCorners.BL,ve.globeCenterInViewSpace,ve.globeRadius,je,Se,tt);if(u(ye,Ye),_e&&(te.setupElevationDraw(ce,_e,Ze),C.uploadCommonUniforms(ue,_e,ye.toUnwrapped()),Ne)){const[te,le,ce]=Ne.getGridBuffers(Qe,0!==Se);_e.draw(C,qe,Ae,$e,Me,Dx.backCCW,ot,"globe_raster",te,le,ce)}}}if(Ne&&(C.renderDefaultNorthPole||C.renderDefaultSouthPole)){const he=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];Se&&he.push("CUSTOM_ANTIALIASING"),_e=C.getOrCreateProgram("globeRaster",{defines:he});for(const he of ce){const{x:ce,y:ye,z:Se}=he.canonical,Ce=0===ye,Ge=ye===(1<<Se)-1,[qe,$e,He,We]=Ne.getPoleBuffers(Se,!1);if(We&&(Ce||Ge)){const ye=le.getTile(he);ue.activeTexture.set(de.TEXTURE0),ye.texture&&ye.texture.bind(de.LINEAR,de.CLAMP_TO_EDGE);let Ne=Rd(Se,ce,ve);const Xe=Ad(fd(he.canonical)),E=(te,le)=>te.draw(C,de.TRIANGLES,Ae,Sx.disabled,Me,Dx.disabled,QE(ve.expandedFarZProjMatrix,Ne,Ne,Xe,0,Oe,ve.frustumCorners.TL,ve.frustumCorners.TR,ve.frustumCorners.BR,ve.frustumCorners.BL,ve.globeCenterInViewSpace,ve.globeRadius,je,0),"globe_pole_raster",le,He,We);te.setupElevationDraw(ye,_e,Ze),C.uploadCommonUniforms(ue,_e,he.toUnwrapped()),Ce&&C.renderDefaultNorthPole&&E(_e,qe),Ge&&C.renderDefaultSouthPole&&(Ne=ld.scale(ld.create(),Ne,[1,-1,1]),E(_e,$e))}}}}(C,te,le,ce,he);else{const ue=C.context,de=ue.gl;let _e,ye;const ve=C.shadowRenderer,Se=eM(C,C.longestCutoffRange),u=te=>{if(ye===te)return;const le=[];le.push(rA[te]),Se.shouldRenderCutoff&&le.push("RENDER_CUTOFF"),_e=C.getOrCreateProgram("terrainRaster",{defines:le}),ye=te},Me=C.colorModeForRenderPass(),Ae=new Mx(de.LEQUAL,Mx.ReadWrite,C.depthRangeFor3D);iA.update(he);const Ce=C.transform,Oe=nM(Ce.zoom,te.exaggeration(),te.sourceCache._source.tileSize);let Ne=[0,0,0];if(ve){const te=C.style.directionalLight,le=C.style.ambientLight;te&&le&&(Ne=WA(te,le))}{ye=-1;const je=de.TRIANGLES,[Ge,Ze]=[te.gridIndexBuffer,te.gridSegments];for(const ye of ce){const ce=le.getTile(ye),qe=Sx.disabled,$e=te.prevTerrainTileForTile[ye.key],He=te.terrainTileForTile[ye.key];tM($e,He)&&iA.newMorphing(ye.key,$e,He,he,250),ue.activeTexture.set(de.TEXTURE0),ce.texture&&ce.texture.bind(de.LINEAR,de.CLAMP_TO_EDGE);const We=iA.getMorphValuesForProxy(ye.key),Xe=We?1:0;let Ye;We&&(Ye={morphing:{srcDemTile:We.from,dstDemTile:We.to,phase:M(We.phase)}});const Je=JE(ye.projMatrix,oM(ye.canonical,Ce.renderWorldCopies)?Oe/10:Oe,Ne);if(u(Xe),!_e)continue;te.setupElevationDraw(ce,_e,Ye);const Qe=ye.toUnwrapped();ve&&ve.setupShadows(Qe,_e),C.uploadCommonUniforms(ue,_e,Qe,null,Se),_e.draw(C,je,Ae,qe,Me,Dx.backCCW,Je,"terrain_raster",te.gridBuffer,Ge,Ze)}}}}(te,this,this.proxySourceCache,C,this._updateTimestamp),this.renderingToTexture=!0,te.gpuTimingDeferredRenderEnd(),C.splice(0,C.length))}renderBatch(C){if(0===this._drapedRenderBatches.length)return C+1;this.renderingToTexture=!0;const te=this.painter,le=this.painter.context,ce=this.proxySourceCache,he=this.proxiedCoords[ce.id],ue=this._drapedRenderBatches.shift(),de=te.style.order,_e=[];let ye=0;for(const ve of he){const he=ce.getTileByID(ve.proxyTileKey),Se=ce.proxyCachedFBO[ve.key]?ce.proxyCachedFBO[ve.key][C]:void 0,Me=void 0!==Se?ce.renderCache[Se]:this.pool[ye++],Ae=void 0!==Se;if(he.texture=Me.tex,Ae&&!Me.dirty){_e.push(he.tileID);continue}let Ce;le.bindFramebuffer.set(Me.fb.framebuffer),this.renderedToTile=!1,Me.dirty&&(le.clear({color:qr.transparent,stencil:0}),Me.dirty=!1);for(let C=ue.start;C<=ue.end;++C){const ce=te.style._mergedLayers[de[C]];if(ce.isHidden(te.transform.zoom))continue;const he=te.style.getLayerSourceCache(ce),ue=he?this.proxyToSource[ve.key][he.id]:[ve];if(!ue)continue;const _e=ue;le.viewport.set([0,0,Me.fb.width,Me.fb.height]),Ce!==(he?he.id:null)&&(this._setupStencil(Me,ue,ce,he),Ce=he?he.id:null),te.renderLayer(te,he,ce,_e)}if(0===this._drapedRenderBatches.length)for(const C of this._pendingGroundEffectLayers){const ce=te.style._mergedLayers[de[C]];if(ce.isHidden(te.transform.zoom))continue;const he=te.style.getLayerSourceCache(ce),ue=he?this.proxyToSource[ve.key][he.id]:[ve];if(!ue)continue;const _e=ue;le.viewport.set([0,0,Me.fb.width,Me.fb.height]),Ce!==(he?he.id:null)&&(this._setupStencil(Me,ue,ce,he),Ce=he?he.id:null),te.renderLayer(te,he,ce,_e)}this.renderedToTile?(Me.dirty=!0,_e.push(he.tileID)):Ae||--ye,5===ye&&(ye=0,this.renderToBackBuffer(_e))}return this.renderToBackBuffer(_e),this.renderingToTexture=!1,le.bindFramebuffer.set(null),le.viewport.set([0,0,te.width,te.height]),ue.end+1}postRender(){}isLayerOrderingCorrect(C){const te=C.order.length;let le=-1,ce=te;for(let he=0;he<te;++he)this._style.isLayerDraped(C._mergedLayers[C.order[he]])?le=Math.max(le,he):ce=Math.min(ce,he);return ce>le}getMinElevationBelowMSL(){let C=0;return this._visibleDemTiles.filter((C=>C.dem)).forEach((te=>{C=Math.min(C,te.dem.tree.minimums[0])})),0===C?C:(C-30)*this._exaggeration}raycast(C,te,le){if(!this._visibleDemTiles)return null;const ce=this._visibleDemTiles.filter((C=>C.dem)).map((ce=>{const he=ce.tileID,ue=1<<he.overscaledZ,{x:de,y:_e}=he.canonical,ye=de/ue,ve=(de+1)/ue,Se=_e/ue,Me=(_e+1)/ue;return{minx:ye,miny:Se,maxx:ve,maxy:Me,t:ce.dem.tree.raycastRoot(ye,Se,ve,Me,C,te,le),tile:ce}}));ce.sort(((C,te)=>(null!==C.t?C.t:Number.MAX_VALUE)-(null!==te.t?te.t:Number.MAX_VALUE)));for(const he of ce){if(null==he.t)return null;const ce=he.tile.dem.tree.raycast(he.minx,he.miny,he.maxx,he.maxy,C,te,le);if(null!=ce)return ce}return null}_createFBO(){const C=this.painter.context,te=C.gl,le=this.drapeBufferSize;C.activeTexture.set(te.TEXTURE0);const ce=new My(C,{width:le[0],height:le[1],data:null},te.RGBA);ce.bind(te.LINEAR,te.CLAMP_TO_EDGE);const he=C.createFramebuffer(le[0],le[1],!0,null);return he.colorAttachment.set(ce.texture),he.depthAttachment=new Tx(C,he.framebuffer),void 0===this._sharedDepthStencil?(this._sharedDepthStencil=C.createRenderbuffer(C.gl.DEPTH_STENCIL,le[0],le[1]),this._stencilRef=0,he.depthAttachment.set(this._sharedDepthStencil),C.clear({stencil:0})):he.depthAttachment.set(this._sharedDepthStencil),C.extTextureFilterAnisotropic&&te.texParameterf(te.TEXTURE_2D,C.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,C.extTextureFilterAnisotropicMax),{fb:he,tex:ce,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._style.hasLightTransitions())return!0;for(const C in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[C].hasTransition())return!0;return this._style.order.some((C=>{const te=this._style._mergedLayers[C],le=te.isHidden(this.painter.transform.zoom);return"custom"===te.type?!le&&te.shouldRedrape():!le&&te.hasTransition()}))}_clearLineLayersFromRenderCache(){let C=!1;for(const te of this._style.getSources())if(te instanceof Vw){C=!0;break}if(!C)return;const te={};for(let C=0;C<this._style.order.length;++C){const le=this._style._mergedLayers[this._style.order[C]],ce=this._style.getLayerSourceCache(le);if(ce&&!te[ce.id]&&!le.isHidden(this.painter.transform.zoom)&&"line"===le.type&&le.widthExpression()instanceof Ao){te[ce.id]=!0;for(const C of this.proxyCoords){const te=this.proxyToSource[C.key][ce.id];if(te)for(const C of te)this._clearRenderCacheForTile(ce.id,C)}}}}_clearRasterLayersFromRenderCache(){let C=!1;for(const te in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[te]._source instanceof jw){C=!0;break}if(!C)return;const te={};for(let C=0;C<this._style.order.length;++C){const le=this._style._mergedLayers[this._style.order[C]],ce=this._style.getLayerSourceCache(le);if(!ce||te[ce.id])continue;if(le.isHidden(this.painter.transform.zoom)||"raster"!==le.type)continue;const he=le.paint.get("raster-fade-duration");for(const C of this.proxyCoords){const te=this.proxyToSource[C.key][ce.id];if(te)for(const C of te){const te=aM(ce.getTile(C),ce.findLoadedParent(C,0),ce,this.painter.transform,he);(1!==te.opacity||0!==te.mix)&&this._clearRenderCacheForTile(ce.id,C)}}}}_setupDrapedRenderBatches(){const C=this._style.order,te=C.length;if(0===te)return;const le=[];this._pendingGroundEffectLayers=[];let ce,he=0,ue=this._style._mergedLayers[C[he]];for(;!this._style.isLayerDraped(ue)&&ue.isHidden(this.painter.transform.zoom)&&++he<te;)ue=this._style._mergedLayers[C[he]];for(;he<te;++he){const te=this._style._mergedLayers[C[he]];te.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(te)?void 0===ce&&(ce=he):("fill-extrusion"===te.type&&this._pendingGroundEffectLayers.push(he),void 0!==ce&&(le.push({start:ce,end:he-1}),ce=void 0)))}if(void 0!==ce&&le.push({start:ce,end:he-1}),0!==le.length){const C=le[le.length-1],te=this._pendingGroundEffectLayers.every((te=>te>C.end));te||H("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=le}_setupRenderCache(C){const te=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,te.renderCache.length>te.renderCachePool.length){const C=Object.values(te.proxyCachedFBO);te.proxyCachedFBO={};for(let le=0;le<C.length;++le){const ce=Object.values(C[le]);te.renderCachePool.push(...ce)}}return}this._clearRasterLayersFromRenderCache();const le=this.proxyCoords,ce=this._tilesDirty;for(let he=le.length-1;he>=0;he--){const ue=le[he];if(te.getTileByID(ue.key),void 0!==te.proxyCachedFBO[ue.key]){const le=C[ue.key],he=this.proxyToSource[ue.key];let de=0;for(const C in he){const te=he[C],ue=le[C];if(!ue||ue.length!==te.length||te.some(((te,le)=>te!==ue[le]||ce[C]&&ce[C].hasOwnProperty(te.key)))){de=-1;break}++de}for(const C in te.proxyCachedFBO[ue.key])te.renderCache[te.proxyCachedFBO[ue.key][C]].dirty=de<0||de!==Object.values(le).length}}const he=[...this._drapedRenderBatches];he.sort(((C,te)=>te.end-te.start-(C.end-C.start)));for(const C of he)for(const ce of le){if(te.proxyCachedFBO[ce.key])continue;let le=te.renderCachePool.pop();void 0===le&&te.renderCache.length<50&&(le=te.renderCache.length,te.renderCache.push(this._createFBO())),void 0!==le&&(te.proxyCachedFBO[ce.key]={},te.proxyCachedFBO[ce.key][C.start]=le,te.renderCache[le].dirty=!0)}this._tilesDirty={}}_setupStencil(C,te,le,ce){if(!ce||!this._sourceTilesOverlap[ce.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const he=this.painter.context,ue=he.gl;if(te.length<=1)return void(this._overlapStencilType=!1);let de;if(le.isTileClipped())de=te.length,this._overlapStencilMode.test={func:ue.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(te[0].overscaledZ>te[te.length-1].overscaledZ))return void(this._overlapStencilType=!1);de=1,this._overlapStencilMode.test={func:ue.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+de>255&&(he.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=de,this._overlapStencilMode.ref=this._stencilRef,le.isTileClipped()&&this._renderTileClippingMasks(te,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return"Clip"===this._overlapStencilType||"Mask"===this._overlapStencilType}stencilModeForRTTOverlap(C){return this.renderingToTexture&&this._overlapStencilType?("Clip"===this._overlapStencilType&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[C.key]),this._overlapStencilMode):Sx.disabled}_renderTileClippingMasks(C,te){const le=this.painter,ce=this.painter.context,he=ce.gl;le._tileClippingMaskIDs={},ce.setColorMode(Cx.disabled),ce.setDepthMode(Mx.disabled);const ue=le.getOrCreateProgram("clippingMask");for(const ce of C){const C=le._tileClippingMaskIDs[ce.key]=--te;ue.draw(le,he.TRIANGLES,Mx.disabled,new Sx({func:he.ALWAYS,mask:0},C,255,he.KEEP,he.KEEP,he.REPLACE),Cx.disabled,Dx.disabled,sM(ce.projMatrix),"$clipping",le.tileExtentBuffer,le.quadTriangleIndexBuffer,le.tileExtentSegments)}}pointCoordinate(C){const te=this.painter.transform;if(C.x<0||C.x>te.width||C.y<0||C.y>te.height)return null;const le=[C.x,C.y,1,1];$u.transformMat4(le,le,te.pixelMatrixInverse),$u.scale(le,le,1/le[3]),le[0]/=te.worldSize,le[1]/=te.worldSize;const ce=te._camera.position,he=Qd(1,te.center.lat),ue=[ce[0],ce[1],ce[2]/he,0],de=Zd.subtract([],le.slice(0,3),ue);Zd.normalize(de,de);const _e=this.raycast(ue,de,this._exaggeration);return null!==_e&&_e?(Zd.scaleAndAdd(ue,ue,de,_e),ue[3]=ue[2],ue[2]*=he,ue):null}drawDepth(){const C=this.painter,te=C.context,le=this.proxySourceCache,ce=Math.ceil(C.width),he=Math.ceil(C.height);if(!this._depthFBO||this._depthFBO.width===ce&&this._depthFBO.height===he||(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),!this._depthFBO){const C=te.gl,le=te.createFramebuffer(ce,he,!0,"renderbuffer");te.activeTexture.set(C.TEXTURE0);const ue=new My(te,{width:ce,height:he,data:null},C.RGBA);ue.bind(C.NEAREST,C.CLAMP_TO_EDGE),le.colorAttachment.set(ue.texture);const de=te.createRenderbuffer(te.gl.DEPTH_COMPONENT16,ce,he);le.depthAttachment.set(de),this._depthFBO=le,this._depthTexture=ue}te.bindFramebuffer.set(this._depthFBO.framebuffer),te.viewport.set([0,0,ce,he]),function(C,te,le,ce){if("globe"===C.transform.projection.name)return;const he=C.context,ue=he.gl;he.clear({depth:1});const de=C.getOrCreateProgram("terrainDepth"),_e=new Mx(ue.LESS,Mx.ReadWrite,C.depthRangeFor3D);for(const he of ce){const ce=le.getTile(he),ye=JE(he.projMatrix,0,[0,0,0]);te.setupElevationDraw(ce,de),de.draw(C,ue.TRIANGLES,_e,Sx.disabled,Cx.unblended,Dx.backCCW,ye,"terrain_depth",te.gridBuffer,te.gridIndexBuffer,te.gridNoSkirtSegments)}}(C,this,le,this.proxyCoords)}_setupProxiedCoordsForOrtho(C,te,le){if(C.getSource()instanceof Jb)return this._setupProxiedCoordsForImageSource(C,te,le);this._findCoveringTileCache[C.id]=this._findCoveringTileCache[C.id]||{};const ce=this.proxiedCoords[C.id]=[],he=this.proxyCoords;for(let te=0;te<he.length;te++){const ue=he[te],de=this._findTileCoveringTileID(ue,C);if(de){const te=this._createProxiedId(ue,de,le[ue.key]&&le[ue.key][C.id]);ce.push(te),this.proxyToSource[ue.key][C.id]=[te]}}let ue=!1;for(let he=0;he<te.length;he++){const de=C.getTile(te[he]);if(!de||!de.hasData())continue;const _e=this._findTileCoveringTileID(de.tileID,this.proxySourceCache);if(_e&&_e.tileID.canonical.z!==de.tileID.canonical.z){const te=this.proxyToSource[_e.tileID.key][C.id],he=this._createProxiedId(_e.tileID,de,le[_e.tileID.key]&&le[_e.tileID.key][C.id]);te?te.splice(te.length-1,0,he):this.proxyToSource[_e.tileID.key][C.id]=[he],ce.push(he),ue=!0}}this._sourceTilesOverlap[C.id]=ue}_setupProxiedCoordsForImageSource(C,te,le){if(!C.getSource().loaded())return;const ce=this.proxiedCoords[C.id]=[],he=this.proxyCoords,ue=C.getSource(),de=ue.tileID;if(!de)return;const _e=new je(de.x,de.y)._div(1<<de.z),ye=ue.coordinates.map(lp.fromLngLat).reduce(((C,te)=>(C.min.x=Math.min(C.min.x,te.x-_e.x),C.min.y=Math.min(C.min.y,te.y-_e.y),C.max.x=Math.max(C.max.x,te.x-_e.x),C.max.y=Math.max(C.max.y,te.y-_e.y),C)),{min:new je(Number.MAX_VALUE,Number.MAX_VALUE),max:new je(-Number.MAX_VALUE,-Number.MAX_VALUE)}),c=(C,te)=>{const le=C.wrap+C.canonical.x/(1<<C.canonical.z),ce=C.canonical.y/(1<<C.canonical.z),he=Mn/(1<<C.canonical.z),ue=te.wrap+te.canonical.x/(1<<te.canonical.z),de=te.canonical.y/(1<<te.canonical.z);return le+he<ue+ye.min.x||le>ue+ye.max.x||ce+he<de+ye.min.y||ce>de+ye.max.y};for(let ue=0;ue<he.length;ue++){const de=he[ue];for(let he=0;he<te.length;he++){const ue=C.getTile(te[he]);if(!ue||!ue.hasData())continue;if(c(de,ue.tileID))continue;const _e=this._createProxiedId(de,ue,le[de.key]&&le[de.key][C.id]),ye=this.proxyToSource[de.key][C.id];ye?ye.push(_e):this.proxyToSource[de.key][C.id]=[_e],ce.push(_e)}}}_createProxiedId(C,te,le){let ce=this.orthoMatrix;if(le){const C=le.find((C=>C.key===te.tileID.key));if(C)return C}if(te.tileID.key!==C.key){const le=C.canonical.z-te.tileID.canonical.z;let he,ue,de;ce=ld.create();const _e=te.tileID.wrap-C.wrap<<C.overscaledZ;le>0?(he=Mn>>le,ue=he*((te.tileID.canonical.x<<le)-C.canonical.x+_e),de=he*((te.tileID.canonical.y<<le)-C.canonical.y)):(he=Mn<<-le,ue=Mn*(te.tileID.canonical.x-(C.canonical.x+_e<<-le)),de=Mn*(te.tileID.canonical.y-(C.canonical.y<<-le))),ld.ortho(ce,0,he,0,he,0,1),ld.translate(ce,ce,[ue,de,0])}return new hM(te.tileID,C.key,ce)}_findTileCoveringTileID(C,te){let le=te.getTile(C);if(le&&le.hasData())return le;const ce=this._findCoveringTileCache[te.id],he=ce[C.key];if(le=he?te.getTileByID(he):null,le&&le.hasData()||null===he)return le;let ue=le?le.tileID:C,de=ue.overscaledZ;const _e=te.getSource().minzoom,ye=[];if(!he){const ce=te.getSource().maxzoom;if(C.canonical.z>=ce){const le=C.canonical.z-ce;te.getSource().reparseOverscaled?(de=Math.max(C.canonical.z+2,te.transform.tileZoom),ue=new qu(de,C.wrap,ce,C.canonical.x>>le,C.canonical.y>>le)):0!==le&&(de=ce,ue=new qu(de,C.wrap,ce,C.canonical.x>>le,C.canonical.y>>le))}ue.key!==C.key&&(ye.push(ue.key),le=te.getTile(ue))}const c=C=>{ye.forEach((te=>{ce[te]=C})),ye.length=0};for(de-=1;de>=_e&&(!le||!le.hasData());de--){le&&c(le.tileID.key);const C=ue.calculateScaledKey(de);if(le=te.getTileByID(C),le&&le.hasData())break;const he=ce[C];if(null===he)break;void 0===he?ye.push(C):le=te.getTileByID(he)}return c(le?le.tileID.key:null),le&&le.hasData()?le:null}findDEMTileFor(C){return this.enabled?this._findTileCoveringTileID(C,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(C,te){let le=this._tilesDirty[C];le||(le=this._tilesDirty[C]={}),le[te.key]=!0}}function dM(C,te,le){const ce=function(C,te,le){const ce=Zd.dot(te,C),he=Zd.dot(le,[.2126,.7152,.0722]),o=(C,te,le)=>(1-le)*C+le*te,ue=o(1-.3*Math.min(he,1),1,Math.min(ce+1,1));return o(.92,1,Math.asin(z(te[2],-1,1))/Math.PI+.5)*ue}(C,[0,0,1],te),he=[0,0,0];Zd.scale(he,le.slice(0,3),ce);const ue=[0,0,0];Zd.scale(ue,te.slice(0,3),C[2]);const de=[0,0,0];return Zd.add(de,he,ue),ae(de)}const nA=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],aA=["stars","fillExtrusion","fillExtrusionGroundEffect","model","symbolSDF","symbolIcon","symbolTextAndIcon"];class mM{static cacheKey(C,te,le,ce){let he=`${te}${ce?ce.cacheKey:""}`;for(const te of le)C.usedDefines.includes(te)&&(he+=`/${te}`);return he}constructor(C,te,le,ce,he,ue){const de=C.gl;this.program=de.createProgram(),this.configuration=ce,this.name=te,this.fixedDefines=[...ue];const _e=ce?ce.getBinderAttributes():[],ye=(le.staticAttributes||[]).concat(_e);let ve=ce?ce.defines():[];ve=ve.concat(ue.map((C=>`#define ${C}`)));const Se="#version 300 es\n";let Me=Se+ve.concat("precision mediump float;",VE,UE.fragmentSource).join("\n");for(const C of le.fragmentIncludes)Me+=`\n${NE[C]}`;Me+=`\n${le.fragmentSource}`;let Ae=Se+ve.concat("precision highp float;",VE,UE.vertexSource).join("\n");for(const C of le.vertexIncludes)Ae+=`\n${NE[C]}`;Ae+=`\n${le.vertexSource}`;const Ce=de.createShader(de.FRAGMENT_SHADER);if(de.isContextLost())return void(this.failedToCreate=!0);de.shaderSource(Ce,Me),de.compileShader(Ce),de.attachShader(this.program,Ce);const Oe=de.createShader(de.VERTEX_SHADER);if(de.isContextLost())this.failedToCreate=!0;else{de.shaderSource(Oe,Ae),de.compileShader(Oe),de.attachShader(this.program,Oe),this.attributes={},this.numAttributes=ye.length;for(let C=0;C<this.numAttributes;C++)if(ye[C]){const te=ye[C].startsWith("a_")?ye[C]:`a_${ye[C]}`;de.bindAttribLocation(this.program,C,te),this.attributes[te]=C}de.linkProgram(this.program),de.deleteShader(Oe),de.deleteShader(Ce),this.fixedUniforms=he(C),this.binderUniforms=ce?ce.getUniforms(C):[],ue.includes("TERRAIN")&&(this.terrainUniforms=(C=>({u_dem:new kl(C),u_dem_prev:new kl(C),u_dem_tl:new Bl(C),u_dem_scale:new Ol(C),u_dem_tl_prev:new Bl(C),u_dem_scale_prev:new Ol(C),u_dem_size:new Ol(C),u_dem_lerp:new Ol(C),u_exaggeration:new Ol(C),u_depth:new kl(C),u_depth_size_inv:new Bl(C),u_meter_to_dem:new Ol(C),u_label_plane_matrix_inv:new jl(C)}))(C)),ue.includes("GLOBE")&&(this.globeUniforms=(C=>({u_tile_tl_up:new Fl(C),u_tile_tr_up:new Fl(C),u_tile_br_up:new Fl(C),u_tile_bl_up:new Fl(C),u_tile_up_scale:new Ol(C)}))(C)),ue.includes("FOG")&&(this.fogUniforms=(C=>({u_fog_matrix:new jl(C),u_fog_range:new Bl(C),u_fog_color:new Nl(C),u_fog_horizon_blend:new Ol(C),u_fog_vertical_limit:new Bl(C),u_fog_temporal_offset:new Ol(C),u_frustum_tl:new Fl(C),u_frustum_tr:new Fl(C),u_frustum_br:new Fl(C),u_frustum_bl:new Fl(C),u_globe_pos:new Fl(C),u_globe_radius:new Ol(C),u_globe_transition:new Ol(C),u_is_globe:new kl(C),u_viewport:new Bl(C)}))(C)),ue.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(C=>({u_cutoff_params:new Nl(C)}))(C)),ue.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(C=>({u_lighting_ambient_color:new Fl(C),u_lighting_directional_dir:new Fl(C),u_lighting_directional_color:new Fl(C),u_ground_radiance:new Fl(C)}))(C)),ue.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(C=>({u_light_matrix_0:new jl(C),u_light_matrix_1:new jl(C),u_fade_range:new Bl(C),u_shadow_normal_offset:new Fl(C),u_shadow_intensity:new Ol(C),u_shadow_texel_size:new Ol(C),u_shadow_map_resolution:new Ol(C),u_shadow_direction:new Fl(C),u_shadow_bias:new Fl(C),u_shadowmap_0:new kl(C),u_shadowmap_1:new kl(C)}))(C))}}setTerrainUniformValues(C,te){if(!this.terrainUniforms)return;const le=this.terrainUniforms;if(!this.failedToCreate){C.program.set(this.program);for(const C in te)le[C]&&le[C].set(this.program,C,te[C])}}setGlobeUniformValues(C,te){if(!this.globeUniforms)return;const le=this.globeUniforms;if(!this.failedToCreate){C.program.set(this.program);for(const C in te)le[C]&&le[C].set(this.program,C,te[C])}}setFogUniformValues(C,te){if(!this.fogUniforms)return;const le=this.fogUniforms;if(!this.failedToCreate){C.program.set(this.program);for(const C in te)le[C].set(this.program,C,te[C])}}setCutoffUniformValues(C,te){if(!this.cutoffUniforms)return;const le=this.cutoffUniforms;if(!this.failedToCreate){C.program.set(this.program);for(const C in te)le[C].set(this.program,C,te[C])}}setLightsUniformValues(C,te){if(!this.lightsUniforms)return;const le=this.lightsUniforms;if(!this.failedToCreate){C.program.set(this.program);for(const C in te)le[C].set(this.program,C,te[C])}}setShadowUniformValues(C,te){if(this.failedToCreate||!this.shadowUniforms)return;const le=this.shadowUniforms;C.program.set(this.program);for(const C in te)le[C].set(this.program,C,te[C])}_drawDebugWireframe(C,te,le,ce,he,ue,de,_e,ye,ve){const Se=C.options.wireframe;if(!1===Se.terrain&&!1===Se.layers2D&&!1===Se.layers3D)return;const Me=C.context;if(!(()=>!(!Se.terrain||"terrainRaster"!==this.name&&"globeRaster"!==this.name)||!(!Se.layers2D||C._terrain&&C._terrain.renderingToTexture||!nA.includes(this.name))||!(!Se.layers3D||!aA.includes(this.name)))())return;const Ae=Me.gl,Ce=C.wireframeDebugCache.getLinesFromTrianglesBuffer(C.frameCounter,he,Me);if(!Ce)return;const Oe=[...this.fixedDefines];Oe.push("DEBUG_WIREFRAME");const Ne=C.getOrCreateProgram(this.name,{config:this.configuration,defines:Oe});Me.program.set(Ne.program);const _=(C,te,le)=>{if(te[C]&&le[C])for(const ce in te[C])le[C][ce]&&le[C][ce].set(le.program,ce,te[C][ce].current)};ye&&ye.setUniforms(Ne.program,Me,Ne.binderUniforms,de,{zoom:_e}),_("fixedUniforms",this,Ne),_("terrainUniforms",this,Ne),_("globeUniforms",this,Ne),_("fogUniforms",this,Ne),_("lightsUniforms",this,Ne),_("shadowUniforms",this,Ne),Ce.bind(),Me.setColorMode(new Cx([Ae.ONE,Ae.ONE_MINUS_SRC_ALPHA,Ae.ZERO,Ae.ONE],qr.transparent,[!0,!0,!0,!1])),Me.setDepthMode(new Mx(te.func===Ae.LESS?Ae.LEQUAL:te.func,Mx.ReadOnly,te.range)),Me.setStencilMode(Sx.disabled);const je=3*ue.primitiveLength*2,Ge=3*ue.primitiveOffset*2*2;ve&&ve>1?Ae.drawElementsInstanced(Ae.LINES,je,Ae.UNSIGNED_SHORT,Ge,ve):Ae.drawElements(Ae.LINES,je,Ae.UNSIGNED_SHORT,Ge),he.bind(),Me.program.set(this.program),Me.setDepthMode(te),Me.setStencilMode(le),Me.setColorMode(ce)}draw(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne){const je=C.context,Ge=je.gl;if(this.failedToCreate)return;je.program.set(this.program),je.setDepthMode(le),je.setStencilMode(ce),je.setColorMode(he),je.setCullFace(ue);for(const C of Object.keys(this.fixedUniforms))this.fixedUniforms[C].set(this.program,C,de[C]);Ce&&Ce.setUniforms(this.program,je,this.binderUniforms,Me,{zoom:Ae});const Ze={[Ge.LINES]:2,[Ge.TRIANGLES]:3,[Ge.LINE_STRIP]:1}[te],qe=Ne&&Ne>0?1:void 0;for(const ue of Se.get()){const de=ue.vaos||(ue.vaos={});(de[_e]||(de[_e]=new $E)).bind(je,this,ye,Ce?Ce.getPaintVertexBuffers():[],ve,ue.vertexOffset,Oe||[],qe),Ne&&Ne>1?Ge.drawElementsInstanced(te,ue.primitiveLength*Ze,Ge.UNSIGNED_SHORT,ue.primitiveOffset*Ze*2,Ne):Ge.drawElements(te,ue.primitiveLength*Ze,Ge.UNSIGNED_SHORT,ue.primitiveOffset*Ze*2),te===Ge.TRIANGLES&&this._drawDebugWireframe(C,le,ce,he,ve,ue,Me,Ae,Ce,Ne)}}}function _M(C,te){const le=Math.pow(2,te.tileID.overscaledZ),ce=te.tileSize*Math.pow(2,C.transform.tileZoom)/le,he=ce*(te.tileID.canonical.x+te.tileID.wrap*le),ue=ce*te.tileID.canonical.y;return{u_image:0,u_texsize:te.imageAtlasTexture?te.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/rv(te,1,C.transform.tileZoom),u_pixel_coord_upper:[he>>16,ue>>16],u_pixel_coord_lower:[65535&he,65535&ue]}}const lA=ld.create(),yM=(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne)=>{const je=te.style.light,Ge=je.properties.get("position"),Ze=[Ge.x,Ge.y,Ge.z],qe=sd.create();"viewport"===je.properties.get("anchor")&&(sd.fromRotation(qe,-te.transform.angle),Zd.transformMat3(Ze,Ze,qe));const $e=je.properties.get("color"),He=te.transform,We={u_matrix:C,u_lightpos:Ze,u_lightintensity:je.properties.get("intensity"),u_lightcolor:[$e.r,$e.g,$e.b],u_vertical_gradient:+le,u_opacity:ce,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:lA,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_ao:he,u_edge_radius:ue,u_flood_light_color:Me,u_vertical_scale:Ae,u_flood_light_intensity:Ce,u_ground_shadow_factor:Oe,u_emissive_strength:Ne};return"globe"===He.projection.name&&(We.u_tile_id=[de.canonical.x,de.canonical.y,1<<de.canonical.z],We.u_zoom_transition=ye,We.u_inv_rot_matrix=Se,We.u_merc_center=ve,We.u_up_dir=He.projection.upVector(new ju(0,0,0),ve[0]*Mn,ve[1]*Mn),We.u_height_lift=_e),We},xM=(C,te,le)=>({u_matrix:C,u_edge_radius:te,u_vertical_scale:le}),vM=(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce)=>{const Oe=yM(C,te,le,ce,he,ue,de,ye,ve,Se,Me,Ae,Ce,1,[0,0,0],0),Ne={u_height_factor:-Math.pow(2,de.overscaledZ)/_e.tileSize/8};return k(Oe,_M(te,_e),Ne)},bM=(C,te)=>({u_matrix:C,u_emissive_strength:te}),wM=(C,te,le,ce)=>k(bM(C,te),_M(le,ce)),TM=(C,te,le)=>({u_matrix:C,u_world:le,u_emissive_strength:te}),EM=(C,te,le,ce,he)=>k(wM(C,te,le,ce),{u_world:he}),MM=(C,te,le,ce)=>{const he=Mn/le.tileSize;return{u_matrix:C,u_camera_to_center_distance:te.getCameraToCenterDistance(ce),u_extrude_scale:[te.pixelsToGLUnits[0]/he,te.pixelsToGLUnits[1]/he]}},AM=(C,te,le=1)=>({u_matrix:C,u_color:te,u_overlay:0,u_overlay_scale:le}),cA=ld.create(),IM=(C,te,le,ce,he,ue,de)=>{const _e=C.transform,ye="globe"===_e.projection.name,ve=ye?Cd(_e.zoom,te.canonical)*_e._pixelsPerMercatorPixel:rv(le,1,ue),Se={u_matrix:te.projMatrix,u_extrude_scale:ve,u_intensity:de,u_inv_rot_matrix:cA,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(ye){Se.u_inv_rot_matrix=ce,Se.u_merc_center=he,Se.u_tile_id=[te.canonical.x,te.canonical.y,1<<te.canonical.z],Se.u_zoom_transition=Dd(_e.zoom);const C=he[0]*Mn,le=he[1]*Mn;Se.u_up_dir=_e.projection.upVector(new ju(0,0,0),C,le)}return Se},CM=(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne,je,Ge,Ze,qe,$e,He)=>{return{u_matrix:C,u_normalize_matrix:te,u_globe_matrix:le,u_merc_matrix:ce,u_grid_matrix:he,u_tl_parent:ue,u_scale_parent:Se,u_fade_t:Me.mix,u_opacity:Me.opacity*Ae.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:Ae.paint.get("raster-brightness-min"),u_brightness_high:Ae.paint.get("raster-brightness-max"),u_saturation_factor:(Xe=Ae.paint.get("raster-saturation"),Xe>0?1-1/(1.001-Xe):-Xe),u_contrast_factor:(We=Ae.paint.get("raster-contrast"),We>0?1/(1-We):1+We),u_spin_weights:zM(Ae.paint.get("raster-hue-rotate")),u_perspective_transform:Ce,u_raster_elevation:Oe,u_tl_br:de,u_zoom_transition:_e,u_merc_center:ye,u_cutoff_params:ve,u_colorization_mix:PM(je,Ze),u_colorization_offset:DM(Ge,Ze),u_color_ramp:Ne,u_texture_offset:[$e/(qe+2*$e),qe/(qe+2*$e)],u_texture_res:[qe+2*$e,qe+2*$e],u_emissive_strength:He};var We,Xe};function zM(C){C*=Math.PI/180;const te=Math.sin(C),le=Math.cos(C);return[(2*le+1)/3,(-Math.sqrt(3)*te-le+1)/3,(Math.sqrt(3)*te-le+1)/3]}function PM([C,te,le,ce],[he,ue]){if(he===ue)return[0,0,0,0];const de=259/257/(ue-he);return[C*de,te*de,le*de,ce*de]}function DM(C,[te,le]){return te===le?0:((C-te)/(le-te)*259-1)/257}const hA=ld.create(),LM=(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne,je,Ge)=>{const Ze=he.transform,qe={u_is_size_zoom_constant:+("constant"===C||"source"===C),u_is_size_feature_constant:+("constant"===C||"camera"===C),u_size_t:te?te.uSizeT:0,u_size:te?te.uSize:0,u_camera_to_center_distance:Ze.getCameraToCenterDistance(Ne),u_rotate_symbol:+le,u_aspect_ratio:Ze.width/Ze.height,u_fade_change:he.options.fadeDuration?he.symbolFadeChange:1,u_matrix:ue,u_label_plane_matrix:de,u_coord_matrix:_e,u_is_text:+ye,u_pitch_with_map:+ce,u_texsize:ve,u_texture:0,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:hA,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:hA,u_up_vector:[0,-1,0],u_icon_transition:Ge||0,u_icon_saturation:je};return"globe"===Ne.name&&(qe.u_tile_id=[Se.canonical.x,Se.canonical.y,1<<Se.canonical.z],qe.u_zoom_transition=Me,qe.u_inv_rot_matrix=Ce,qe.u_merc_center=Ae,qe.u_camera_forward=Ze._camera.forward(),qe.u_ecef_origin=function(C,te){const le=[0,0,0],ce=Ad(fd(te.canonical));return Zd.transformMat4(le,le,ce),Zd.transformMat4(le,le,C),le}(Ze.globeMatrix,Se.toUnwrapped()),qe.u_tile_matrix=Float32Array.from(Ze.globeMatrix),qe.u_up_vector=Oe),qe},kM=(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne,je)=>k(LM(C,te,le,ce,he,ue,de,_e,ye,ve,Me,Ae,Ce,Oe,Ne,je,1),{u_gamma_scale:ce?he.transform.getCameraToCenterDistance(je)*Math.cos(he.terrain?0:he.transform._pitch):1,u_device_pixel_ratio:bi.devicePixelRatio,u_is_halo:+Se,undefined:void 0}),OM=(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne)=>k(kM(C,te,le,ce,he,ue,de,_e,!0,ye,!0,Se,Me,Ae,Ce,Oe,Ne),{u_texsize_icon:ve,u_texture_icon:1}),BM=(C,te,le,ce)=>({u_matrix:C,u_emissive_strength:te,u_opacity:le,u_color:ce}),FM=(C,te,le,ce,he,ue,de)=>k(function(C,te,le,ce){const he=le.imageManager.getPattern(C.toString(),te),{width:ue,height:de}=le.imageManager.getPixelSize(te),_e=Math.pow(2,ce.tileID.overscaledZ),ye=ce.tileSize*Math.pow(2,le.transform.tileZoom)/_e,ve=ye*(ce.tileID.canonical.x+ce.tileID.wrap*_e),Se=ye*ce.tileID.canonical.y;return{u_image:0,u_pattern_tl:he.tl,u_pattern_br:he.br,u_texsize:[ue,de],u_pattern_size:he.displaySize,u_tile_units_to_pixels:1/rv(ce,1,le.transform.tileZoom),u_pixel_coord_upper:[ve>>16,Se>>16],u_pixel_coord_lower:[65535&ve,65535&Se]}}(he,ue,ce,de),{u_matrix:C,u_emissive_strength:te,u_opacity:le}),uA={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,ShadowMap0:10},UM=(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae=[0,0,0])=>{const Ce=ce.style.light,Oe=Ce.properties.get("position"),Ne=[-Oe.x,-Oe.y,Oe.z],je=sd.create();"viewport"===Ce.properties.get("anchor")&&(sd.fromRotation(je,-ce.transform.angle),Zd.transformMat3(Ne,Ne,je));const Ge="MASK"===ve.alphaMode,Ze=Ce.properties.get("color"),qe=Me.paint.get("model-ambient-occlusion-intensity"),$e=Me.paint.get("model-color").constantOr(qr.white),He=Me.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:C,u_lighting_matrix:te,u_normal_matrix:le,u_lightpos:Ne,u_lightintensity:Ce.properties.get("intensity"),u_lightcolor:[Ze.r,Ze.g,Ze.b],u_camera_pos:Ae,u_opacity:he,u_baseTextureIsAlpha:0,u_alphaMask:+Ge,u_alphaCutoff:ve.alphaCutoff,u_baseColorFactor:[ue.r,ue.g,ue.b,ue.a],u_emissiveFactor:[de[0],de[1],de[2],1],u_metallicFactor:_e,u_roughnessFactor:ye,u_baseColorTexture:uA.BaseColor,u_metallicRoughnessTexture:uA.MetallicRoughness,u_normalTexture:uA.Normal,u_occlusionTexture:uA.Occlusion,u_emissionTexture:uA.Emission,u_color_mix:[$e.r,$e.g,$e.b,He],u_aoIntensity:qe,u_emissive_strength:Se}},_A=new Float32Array(16),jM=(C,te=_A,le=_A)=>({u_matrix:C,u_instance:te,u_node_matrix:le}),gA={fillExtrusion:C=>({u_matrix:new jl(C),u_lightpos:new Fl(C),u_lightintensity:new Ol(C),u_lightcolor:new Fl(C),u_vertical_gradient:new Ol(C),u_opacity:new Ol(C),u_edge_radius:new Ol(C),u_ao:new Bl(C),u_tile_id:new Fl(C),u_zoom_transition:new Ol(C),u_inv_rot_matrix:new jl(C),u_merc_center:new Bl(C),u_up_dir:new Fl(C),u_height_lift:new Ol(C),u_flood_light_color:new Fl(C),u_vertical_scale:new Ol(C),u_flood_light_intensity:new Ol(C),u_ground_shadow_factor:new Fl(C),u_emissive_strength:new Ol(C)}),fillExtrusionDepth:C=>({u_matrix:new jl(C),u_edge_radius:new Ol(C),u_vertical_scale:new Ol(C)}),fillExtrusionPattern:C=>({u_matrix:new jl(C),u_lightpos:new Fl(C),u_lightintensity:new Ol(C),u_lightcolor:new Fl(C),u_vertical_gradient:new Ol(C),u_height_factor:new Ol(C),u_edge_radius:new Ol(C),u_ao:new Bl(C),u_tile_id:new Fl(C),u_zoom_transition:new Ol(C),u_inv_rot_matrix:new jl(C),u_merc_center:new Bl(C),u_up_dir:new Fl(C),u_height_lift:new Ol(C),u_image:new kl(C),u_texsize:new Bl(C),u_pixel_coord_upper:new Bl(C),u_pixel_coord_lower:new Bl(C),u_tile_units_to_pixels:new Ol(C),u_opacity:new Ol(C)}),fillExtrusionGroundEffect:C=>({u_matrix:new jl(C),u_opacity:new Ol(C),u_ao_pass:new Ol(C),u_meter_to_tile:new Ol(C),u_ao:new Bl(C),u_flood_light_intensity:new Ol(C),u_flood_light_color:new Fl(C),u_attenuation:new Ol(C),u_edge_radius:new Ol(C),u_fb:new kl(C),u_fb_size:new Ol(C)}),fill:C=>({u_matrix:new jl(C),u_emissive_strength:new Ol(C)}),fillPattern:C=>({u_matrix:new jl(C),u_emissive_strength:new Ol(C),u_image:new kl(C),u_texsize:new Bl(C),u_pixel_coord_upper:new Bl(C),u_pixel_coord_lower:new Bl(C),u_tile_units_to_pixels:new Ol(C)}),fillOutline:C=>({u_matrix:new jl(C),u_emissive_strength:new Ol(C),u_world:new Bl(C)}),fillOutlinePattern:C=>({u_matrix:new jl(C),u_emissive_strength:new Ol(C),u_world:new Bl(C),u_image:new kl(C),u_texsize:new Bl(C),u_pixel_coord_upper:new Bl(C),u_pixel_coord_lower:new Bl(C),u_tile_units_to_pixels:new Ol(C)}),circle:C=>({u_camera_to_center_distance:new Ol(C),u_extrude_scale:new $l(C),u_device_pixel_ratio:new Ol(C),u_matrix:new jl(C),u_inv_rot_matrix:new jl(C),u_merc_center:new Bl(C),u_tile_id:new Fl(C),u_zoom_transition:new Ol(C),u_up_dir:new Fl(C),u_emissive_strength:new Ol(C)}),collisionBox:C=>({u_matrix:new jl(C),u_camera_to_center_distance:new Ol(C),u_extrude_scale:new Bl(C)}),collisionCircle:C=>({u_matrix:new jl(C),u_inv_matrix:new jl(C),u_camera_to_center_distance:new Ol(C),u_viewport_size:new Bl(C)}),debug:C=>({u_color:new Ul(C),u_matrix:new jl(C),u_overlay:new kl(C),u_overlay_scale:new Ol(C)}),clippingMask:C=>({u_matrix:new jl(C)}),heatmap:C=>({u_extrude_scale:new Ol(C),u_intensity:new Ol(C),u_matrix:new jl(C),u_inv_rot_matrix:new jl(C),u_merc_center:new Bl(C),u_tile_id:new Fl(C),u_zoom_transition:new Ol(C),u_up_dir:new Fl(C)}),heatmapTexture:C=>({u_image:new kl(C),u_color_ramp:new kl(C),u_opacity:new Ol(C)}),hillshade:C=>({u_matrix:new jl(C),u_image:new kl(C),u_latrange:new Bl(C),u_light:new Bl(C),u_shadow:new Ul(C),u_highlight:new Ul(C),u_emissive_strength:new Ol(C),u_accent:new Ul(C)}),hillshadePrepare:C=>({u_matrix:new jl(C),u_image:new kl(C),u_dimension:new Bl(C),u_zoom:new Ol(C)}),line:C=>({u_matrix:new jl(C),u_pixels_to_tile_units:new $l(C),u_device_pixel_ratio:new Ol(C),u_units_to_pixels:new Bl(C),u_dash_image:new kl(C),u_gradient_image:new kl(C),u_image_height:new Ol(C),u_texsize:new Bl(C),u_tile_units_to_pixels:new Ol(C),u_alpha_discard_threshold:new Ol(C),u_trim_offset:new Bl(C),u_emissive_strength:new Ol(C)}),linePattern:C=>({u_matrix:new jl(C),u_texsize:new Bl(C),u_pixels_to_tile_units:new $l(C),u_device_pixel_ratio:new Ol(C),u_image:new kl(C),u_units_to_pixels:new Bl(C),u_tile_units_to_pixels:new Ol(C),u_alpha_discard_threshold:new Ol(C)}),raster:C=>({u_matrix:new jl(C),u_normalize_matrix:new jl(C),u_globe_matrix:new jl(C),u_merc_matrix:new jl(C),u_grid_matrix:new ql(C),u_tl_parent:new Bl(C),u_scale_parent:new Ol(C),u_fade_t:new Ol(C),u_opacity:new Ol(C),u_image0:new kl(C),u_image1:new kl(C),u_brightness_low:new Ol(C),u_brightness_high:new Ol(C),u_saturation_factor:new Ol(C),u_contrast_factor:new Ol(C),u_spin_weights:new Fl(C),u_perspective_transform:new Bl(C),u_raster_elevation:new Ol(C),u_tl_br:new Nl(C),u_zoom_transition:new Ol(C),u_merc_center:new Bl(C),u_cutoff_params:new Nl(C),u_colorization_mix:new Nl(C),u_colorization_offset:new Ol(C),u_color_ramp:new kl(C),u_texture_offset:new Bl(C),u_texture_res:new Bl(C),u_emissive_strength:new Ol(C)}),symbolIcon:C=>({u_is_size_zoom_constant:new kl(C),u_is_size_feature_constant:new kl(C),u_size_t:new Ol(C),u_size:new Ol(C),u_camera_to_center_distance:new Ol(C),u_rotate_symbol:new kl(C),u_aspect_ratio:new Ol(C),u_fade_change:new Ol(C),u_matrix:new jl(C),u_label_plane_matrix:new jl(C),u_coord_matrix:new jl(C),u_is_text:new kl(C),u_pitch_with_map:new kl(C),u_texsize:new Bl(C),u_tile_id:new Fl(C),u_zoom_transition:new Ol(C),u_inv_rot_matrix:new jl(C),u_merc_center:new Bl(C),u_camera_forward:new Fl(C),u_tile_matrix:new jl(C),u_up_vector:new Fl(C),u_ecef_origin:new Fl(C),u_texture:new kl(C),u_icon_transition:new Ol(C),u_icon_saturation:new Ol(C)}),symbolSDF:C=>({u_is_size_zoom_constant:new kl(C),u_is_size_feature_constant:new kl(C),u_size_t:new Ol(C),u_size:new Ol(C),u_camera_to_center_distance:new Ol(C),u_rotate_symbol:new kl(C),u_aspect_ratio:new Ol(C),u_fade_change:new Ol(C),u_matrix:new jl(C),u_label_plane_matrix:new jl(C),u_coord_matrix:new jl(C),u_is_text:new kl(C),u_pitch_with_map:new kl(C),u_texsize:new Bl(C),u_texture:new kl(C),u_gamma_scale:new Ol(C),u_device_pixel_ratio:new Ol(C),u_tile_id:new Fl(C),u_zoom_transition:new Ol(C),u_inv_rot_matrix:new jl(C),u_merc_center:new Bl(C),u_camera_forward:new Fl(C),u_tile_matrix:new jl(C),u_up_vector:new Fl(C),u_ecef_origin:new Fl(C),u_is_halo:new kl(C)}),symbolTextAndIcon:C=>({u_is_size_zoom_constant:new kl(C),u_is_size_feature_constant:new kl(C),u_size_t:new Ol(C),u_size:new Ol(C),u_camera_to_center_distance:new Ol(C),u_rotate_symbol:new kl(C),u_aspect_ratio:new Ol(C),u_fade_change:new Ol(C),u_matrix:new jl(C),u_label_plane_matrix:new jl(C),u_coord_matrix:new jl(C),u_is_text:new kl(C),u_pitch_with_map:new kl(C),u_texsize:new Bl(C),u_texsize_icon:new Bl(C),u_texture:new kl(C),u_texture_icon:new kl(C),u_gamma_scale:new Ol(C),u_device_pixel_ratio:new Ol(C),u_is_halo:new kl(C)}),background:C=>({u_matrix:new jl(C),u_emissive_strength:new Ol(C),u_opacity:new Ol(C),u_color:new Ul(C)}),backgroundPattern:C=>({u_matrix:new jl(C),u_emissive_strength:new Ol(C),u_opacity:new Ol(C),u_image:new kl(C),u_pattern_tl:new Bl(C),u_pattern_br:new Bl(C),u_texsize:new Bl(C),u_pattern_size:new Bl(C),u_pixel_coord_upper:new Bl(C),u_pixel_coord_lower:new Bl(C),u_tile_units_to_pixels:new Ol(C)}),terrainRaster:KE,terrainDepth:KE,skybox:C=>({u_matrix:new jl(C),u_sun_direction:new Fl(C),u_cubemap:new kl(C),u_opacity:new Ol(C),u_temporal_offset:new Ol(C)}),skyboxGradient:C=>({u_matrix:new jl(C),u_color_ramp:new kl(C),u_center_direction:new Fl(C),u_radius:new Ol(C),u_opacity:new Ol(C),u_temporal_offset:new Ol(C)}),skyboxCapture:C=>({u_matrix_3f:new ql(C),u_sun_direction:new Fl(C),u_sun_intensity:new Ol(C),u_color_tint_r:new Nl(C),u_color_tint_m:new Nl(C),u_luminance:new Ol(C)}),globeRaster:C=>({u_proj_matrix:new jl(C),u_globe_matrix:new jl(C),u_normalize_matrix:new jl(C),u_merc_matrix:new jl(C),u_zoom_transition:new Ol(C),u_merc_center:new Bl(C),u_image0:new kl(C),u_grid_matrix:new ql(C),u_skirt_height:new Ol(C),u_frustum_tl:new Fl(C),u_frustum_tr:new Fl(C),u_frustum_br:new Fl(C),u_frustum_bl:new Fl(C),u_globe_pos:new Fl(C),u_globe_radius:new Ol(C),u_viewport:new Bl(C)}),globeAtmosphere:C=>({u_frustum_tl:new Fl(C),u_frustum_tr:new Fl(C),u_frustum_br:new Fl(C),u_frustum_bl:new Fl(C),u_horizon:new Ol(C),u_transition:new Ol(C),u_fadeout_range:new Ol(C),u_color:new Nl(C),u_high_color:new Nl(C),u_space_color:new Nl(C),u_temporal_offset:new Ol(C),u_horizon_angle:new Ol(C)}),model:C=>({u_matrix:new jl(C),u_lighting_matrix:new jl(C),u_normal_matrix:new jl(C),u_lightpos:new Fl(C),u_lightintensity:new Ol(C),u_lightcolor:new Fl(C),u_camera_pos:new Fl(C),u_opacity:new Ol(C),u_baseColorFactor:new Nl(C),u_emissiveFactor:new Nl(C),u_metallicFactor:new Ol(C),u_roughnessFactor:new Ol(C),u_baseTextureIsAlpha:new kl(C),u_alphaMask:new kl(C),u_alphaCutoff:new Ol(C),u_baseColorTexture:new kl(C),u_metallicRoughnessTexture:new kl(C),u_normalTexture:new kl(C),u_occlusionTexture:new kl(C),u_emissionTexture:new kl(C),u_color_mix:new Nl(C),u_aoIntensity:new Ol(C),u_emissive_strength:new Ol(C)}),modelDepth:C=>({u_matrix:new jl(C),u_instance:new jl(C),u_node_matrix:new jl(C)}),groundShadow:C=>({u_matrix:new jl(C),u_ground_shadow_factor:new Fl(C)}),stars:C=>({u_matrix:new jl(C),u_up:new Fl(C),u_right:new Fl(C),u_intensity_multiplier:new Ol(C)})};let bA;function ZM(C,te,le,ce,he,ue,de){const _e=C.context,ye=_e.gl,ve=C.transform,Se=C.getOrCreateProgram("collisionBox"),Me=[];let Ae=0,Ce=0;for(let _e=0;_e<ce.length;_e++){const Oe=ce[_e],Ne=te.getTile(Oe),je=Ne.getBucket(le);if(!je)continue;const Ge=XT(Oe,je,ve);let Ze=Ge;0===he[0]&&0===he[1]||(Ze=C.translatePosMatrix(Ge,Ne,he,ue));const qe=de?je.textCollisionBox:je.iconCollisionBox,$e=je.collisionCircleArray;if($e.length>0){const C=ld.create(),te=Ze;ld.mul(C,je.placementInvProjMatrix,ve.glCoordMatrix),ld.mul(C,C,je.placementViewportMatrix),Me.push({circleArray:$e,circleOffset:Ce,transform:te,invTransform:C,projection:je.getProjection()}),Ae+=$e.length/4,Ce=Ae}qe&&(C.terrain&&C.terrain.setupElevationDraw(Ne,Se),Se.draw(C,ye.LINES,Mx.disabled,Sx.disabled,C.colorModeForRenderPass(),Dx.disabled,MM(Ze,ve,Ne,je.getProjection()),le.id,qe.layoutVertexBuffer,qe.indexBuffer,qe.segments,null,ve.zoom,null,[qe.collisionVertexBuffer,qe.collisionVertexBufferExt]))}if(!de||!Me.length)return;const Oe=C.getOrCreateProgram("collisionCircle"),Ne=new Za;Ne.resize(4*Ae),Ne._trim();let je=0;for(const C of Me)for(let te=0;te<C.circleArray.length/4;te++){const le=4*te,ce=C.circleArray[le+0],he=C.circleArray[le+1],ue=C.circleArray[le+2],de=C.circleArray[le+3];Ne.emplace(je++,ce,he,ue,de,0),Ne.emplace(je++,ce,he,ue,de,1),Ne.emplace(je++,ce,he,ue,de,2),Ne.emplace(je++,ce,he,ue,de,3)}(!bA||bA.length<2*Ae)&&(bA=function(C){const te=2*C,le=new Wa;le.resize(te),le._trim();for(let C=0;C<te;C++){const te=6*C;le.uint16[te+0]=4*C+0,le.uint16[te+1]=4*C+1,le.uint16[te+2]=4*C+2,le.uint16[te+3]=4*C+2,le.uint16[te+4]=4*C+3,le.uint16[te+5]=4*C+0}return le}(Ae));const Ge=_e.createIndexBuffer(bA,!0),Ze=_e.createVertexBuffer(Ne,Ng.members,!0);for(const te of Me){const ce={u_matrix:te.transform,u_inv_matrix:te.invTransform,u_camera_to_center_distance:(qe=ve).getCameraToCenterDistance(te.projection),u_viewport_size:[qe.width,qe.height]};Oe.draw(C,ye.TRIANGLES,Mx.disabled,Sx.disabled,C.colorModeForRenderPass(),Dx.disabled,ce,le.id,Ze,Ge,xl.simpleSegment(0,2*te.circleOffset,te.circleArray.length,te.circleArray.length/2),null,ve.zoom)}var qe;Ze.destroy(),Ge.destroy()}const TA=ld.create();function WM({width:C,height:te,anchor:le,textOffset:ce,textScale:he},ue){const{horizontalAlign:de,verticalAlign:_e}=F_(le),ye=-(de-.5)*C,ve=-(_e-.5)*te,Se=xg(le,ce);return new je((ye/he+Se[0])*ue,(ve/he+Se[1])*ue)}function HM(C,te,le,ce,he,ue,de,_e,ye,ve,Se){const Me=C.text.placedSymbolArray,Ae=C.text.dynamicLayoutVertexArray,Ce=C.icon.dynamicLayoutVertexArray,Oe={},Ne=C.getProjection(),je=YT(_e,Ne,ue),Ge=ue.elevation,Ze=Ne.upVectorScale(_e.canonical,ue.center.lat,ue.worldSize).metersToTile;Ae.clear();for(let Ce=0;Ce<Me.length;Ce++){const qe=Me.get(Ce),{tileAnchorX:$e,tileAnchorY:He,numGlyphs:We}=qe,Xe=qe.hidden||!qe.crossTileID||C.allowVerticalPlacement&&!qe.placedOrientation?null:ce[qe.crossTileID];if(Xe){let ce=0,Me=0,Ce=0;if(Ge){const C=Ge?Ge.getAtTileOffset(_e,$e,He):0,[te,le,he]=Ne.upVector(_e.canonical,$e,He);ce=C*te*Ze,Me=C*le*Ze,Ce=C*he*Ze}let[Ye,Je,Qe,tt]=cv(qe.projectedAnchorX+ce,qe.projectedAnchorY+Me,qe.projectedAnchorZ+Ce,le?je:de);const rt=hv(ue.getCameraToCenterDistance(Ne),tt);let ot=he.evaluateSizeForFeature(C.textSizeData,ve,qe)*rt/jg;le&&(ot*=C.tilePixelRatio/ye);const st=WM(Xe,ot);le?(({x:Ye,y:Je,z:Qe}=Ne.projectTilePoint($e+st.x,He+st.y,_e.canonical)),[Ye,Je,Qe]=cv(Ye+ce,Je+Me,Qe+Ce,de)):(te&&st._rotate(-ue.angle),Ye+=st.x,Je+=st.y,Qe=0);const at=C.allowVerticalPlacement&&qe.placedOrientation===iy.vertical?Math.PI/2:0;for(let C=0;C<We;C++)dy(Ae,Ye,Je,Qe,at);Se&&qe.associatedIconIndex>=0&&(Oe[qe.associatedIconIndex]={x:Ye,y:Je,z:Qe,angle:at})}else xv(We,Ae)}if(Se){Ce.clear();const te=C.icon.placedSymbolArray;for(let C=0;C<te.length;C++){const le=te.get(C),{numGlyphs:ce}=le,he=Oe[C];if(le.hidden||!he)xv(ce,Ce);else{const{x:C,y:te,z:le,angle:ue}=he;for(let he=0;he<ce;he++)dy(Ce,C,te,le,ue)}}C.icon.dynamicLayoutVertexBuffer.updateData(Ce)}C.text.dynamicLayoutVertexBuffer.updateData(Ae)}function XM(C,te,le){return le.iconsInText&&te?"symbolTextAndIcon":C?"symbolSDF":"symbolIcon"}function YM(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae){const Ce=C.context,Oe=Ce.gl,Ne=C.transform,je="map"===_e,Ge="map"===ye,Ze=je&&"point"!==le.layout.get("symbol-placement"),qe=je&&!Ge&&!Ze,$e=void 0!==le.layout.get("symbol-sort-key").constantOr(1);let He=!1;const We=C.depthModeForSublayer(0,Mx.ReadOnly),Xe=[Kd(Ne.center.lng),Jd(Ne.center.lat)],Ye=le.layout.get("text-variable-anchor"),Je="globe"===Ne.projection.name,Qe=[],tt=[0,-1,0];let rt=tt;!Je&&!Ne.mercatorFromTransition||je||(rt=function(C){const te=C._camera.getWorldToCamera(C.worldSize,1),le=ld.multiply([],te,C.globeMatrix);ld.invert(le,le);const ce=[0,0,0],he=[0,1,0,0];return $u.transformMat4(he,he,le),ce[0]=he[0],ce[1]=he[1],ce[2]=he[2],Zd.normalize(ce,ce),ce}(Ne));for(const _e of ce){const ce=te.getTile(_e),ye=ce.getBucket(le);if(!ye)continue;if("mercator"===ye.projection.name&&Je)continue;const Me=he?ye.text:ye.icon;if(!Me||ye.fullyClipped||!Me.segments.get().length)continue;const Ae=Me.programConfigurations.get(le.id),Ce=he||ye.sdfIcons,We=he?ye.textSizeData:ye.iconSizeData,ot=Ge||0!==Ne.pitch,st=m_(We,Ne.zoom);let at,lt,ct,ht,dt=[0,0],mt=null;if(he)lt=ce.glyphAtlasTexture?ce.glyphAtlasTexture:null,ct=Oe.LINEAR,at=ce.glyphAtlasTexture?ce.glyphAtlasTexture.size:[0,0],ye.iconsInText&&(dt=ce.imageAtlasTexture?ce.imageAtlasTexture.size:[0,0],mt=ce.imageAtlasTexture?ce.imageAtlasTexture:null,ht=ot||C.options.rotating||C.options.zooming||"composite"===We.kind||"camera"===We.kind?Oe.LINEAR:Oe.NEAREST);else{const te=1!==le.layout.get("icon-size").constantOr(0)||ye.iconsNeedLinear;lt=ce.imageAtlasTexture?ce.imageAtlasTexture:null,ct=Ce||C.options.rotating||C.options.zooming||te||ot?Oe.LINEAR:Oe.NEAREST,at=ce.imageAtlasTexture?ce.imageAtlasTexture.size:[0,0]}const _t="globe"===ye.projection.name,gt=_t?rt:tt,Pt=_t?Dd(Ne.zoom):0,Ft=YT(_e,ye.getProjection(),Ne),jt=Ne.calculatePixelsToTileUnitsMatrix(ce),Ut=sv(Ft,ce.tileID.canonical,Ge,je,Ne,ye.getProjection(),jt),Vt=C.terrain&&Ge&&Ze?ld.invert(ld.create(),Ut):TA,Gt=lv(Ft,ce.tileID.canonical,Ge,je,Ne,ye.getProjection(),jt),Zt=Ye&&ye.hasTextData(),qt=ye.hasIconTextFit()&&Zt&&ye.hasIconData();if(Ze){const te=Ne.elevation,le=te?te.getAtTileOffsetFunc(_e,Ne.center.lat,Ne.worldSize,ye.getProjection()):null,ue=av(Ft,ce.tileID.canonical,Ge,je,Ne,ye.getProjection(),jt);dv(ye,Ft,C,he,ue,Gt,Ge,ve,le,_e)}const $t=Ze||he&&Ye||qt,Ht=C.translatePosMatrix(Ft,ce,ue,de),Wt=$t?TA:Ut,Xt=C.translatePosMatrix(Gt,ce,ue,de,!0),Yt=ye.getProjection().createInversionMatrix(Ne,_e.canonical),Qt=le.paint.get("icon-image-cross-fade").constantOr(0),ri=[];C.terrainRenderModeElevated()&&Ge&&ri.push("PITCH_WITH_MAP_TERRAIN"),_t&&(ri.push("PROJECTION_GLOBE_VIEW"),$t&&ri.push("PROJECTED_POS_ON_VIEWPORT")),Qt>0&&ri.push("ICON_TRANSITION"),Me.zOffsetVertexBuffer&&ri.push("Z_OFFSET");const ni=Ce&&0!==le.paint.get(he?"text-halo-width":"icon-halo-width").constantOr(1);let hi;Ce?hi=ye.iconsInText?OM(We.kind,st,qe,Ge,C,Ht,Wt,Xt,at,dt,_e,Pt,Xe,Yt,gt,ye.getProjection()):kM(We.kind,st,qe,Ge,C,Ht,Wt,Xt,he,at,!0,_e,Pt,Xe,Yt,gt,ye.getProjection()):(Se<1&&ri.push("SATURATION"),hi=LM(We.kind,st,qe,Ge,C,Ht,Wt,Xt,he,at,_e,Pt,Xe,Yt,gt,ye.getProjection(),Se,Qt));const vi={program:C.getOrCreateProgram(XM(Ce,he,ye),{config:Ae,defines:ri}),buffers:Me,uniformValues:hi,atlasTexture:lt,atlasTextureIcon:mt,atlasInterpolation:ct,atlasInterpolationIcon:ht,isSDF:Ce,hasHalo:ni,tile:ce,labelPlaneMatrixInv:Vt};if($e&&ye.canOverlap){He=!0;const C=Me.segments.get();for(const te of C)Qe.push({segments:new xl([te]),sortKey:te.sortKey,state:vi})}else Qe.push({segments:Me.segments,sortKey:0,state:vi})}He&&Qe.sort(((C,te)=>C.sortKey-te.sortKey));for(const te of Qe){const ce=te.state;if(C.terrain&&C.terrain.setupElevationDraw(ce.tile,ce.program,{useDepthForOcclusion:Ne.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:ce.labelPlaneMatrixInv}),Ce.activeTexture.set(Oe.TEXTURE0),ce.atlasTexture&&ce.atlasTexture.bind(ce.atlasInterpolation,Oe.CLAMP_TO_EDGE),ce.atlasTextureIcon&&(Ce.activeTexture.set(Oe.TEXTURE1),ce.atlasTextureIcon&&ce.atlasTextureIcon.bind(ce.atlasInterpolationIcon,Oe.CLAMP_TO_EDGE)),C.uploadCommonLightUniforms(C.context,ce.program),ce.hasHalo){const he=ce.uniformValues;he.u_is_halo=1,KM(ce.buffers,te.segments,le,C,ce.program,We,Me,Ae,he,2),he.u_is_halo=0}else{if(ce.isSDF){const he=ce.uniformValues;ce.hasHalo&&(he.u_is_halo=1,KM(ce.buffers,te.segments,le,C,ce.program,We,Me,Ae,he,1)),he.u_is_halo=0}KM(ce.buffers,te.segments,le,C,ce.program,We,Me,Ae,ce.uniformValues,1)}}}function KM(C,te,le,ce,he,ue,de,_e,ye,ve){const Se=[C.dynamicLayoutVertexBuffer,C.opacityVertexBuffer,C.iconTransitioningVertexBuffer,C.globeExtVertexBuffer,C.zOffsetVertexBuffer];he.draw(ce,ce.context.gl.TRIANGLES,ue,de,_e,Dx.disabled,ye,le.id,C.layoutVertexBuffer,C.indexBuffer,te,le.paint,ce.transform.zoom,C.programConfigurations.get(le.id),Se,ve)}function JM(C,te,le,ce,he,ue,de){const _e=C.context.gl,ye=le.paint.get("fill-pattern"),ve=ye&&ye.constantOr(1);let Se,Me,Ae,Ce,Oe;de?(Me=ve&&!le.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",Se=_e.LINES):(Me=ve?"fillPattern":"fill",Se=_e.TRIANGLES);for(const Ne of ce){const ce=te.getTile(Ne);if(ve&&!ce.patternsLoaded())continue;const je=ce.getBucket(le);if(!je)continue;C.prepareDrawTile();const Ge=je.programConfigurations.get(le.id),Ze=C.isTileAffectedByFog(Ne),qe=C.getOrCreateProgram(Me,{config:Ge,overrideFog:Ze});ve&&(C.context.activeTexture.set(_e.TEXTURE0),ce.imageAtlasTexture&&ce.imageAtlasTexture.bind(_e.LINEAR,_e.CLAMP_TO_EDGE),Ge.updatePaintBuffers());const $e=ye.constantOr(null);if($e&&ce.imageAtlas){const C=ce.imageAtlas.patternPositions[$e.toString()];C&&Ge.setConstantPatternPositions(C)}const He=C.translatePosMatrix(Ne.projMatrix,ce,le.paint.get("fill-translate"),le.paint.get("fill-translate-anchor")),We=le.paint.get("fill-emissive-strength");if(de){Ce=je.indexBuffer2,Oe=je.segments2;const te=C.terrain&&C.terrain.renderingToTexture?C.terrain.drapeBufferSize:[_e.drawingBufferWidth,_e.drawingBufferHeight];Ae="fillOutlinePattern"===Me&&ve?EM(He,We,C,ce,te):TM(He,We,te)}else Ce=je.indexBuffer,Oe=je.segments,Ae=ve?wM(He,We,C,ce):bM(He,We);C.uploadCommonUniforms(C.context,qe,Ne.toUnwrapped()),qe.draw(C,Se,he,C.stencilModeForClipping(Ne),ue,Dx.disabled,Ae,le.id,je.layoutVertexBuffer,Ce,Oe,le.paint,C.transform.zoom,Ge,void 0)}}function QM(C,te,le,ce,he,ue,de,_e){le.resetLayerRenderingStats();const ye=C.context,ve=ye.gl,Se=C.transform,Me=le.paint.get("fill-extrusion-pattern"),Ae=Me.constantOr(1),Ce=le.paint.get("fill-extrusion-opacity"),Oe=C.style.enable3dLights(),Ne=le.paint.get(Oe&&!Ae?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),je=[le.paint.get("fill-extrusion-ambient-occlusion-intensity"),Ne],Ge=le.layout.get("fill-extrusion-edge-radius"),Ze=Ge>0&&!le.paint.get("fill-extrusion-rounded-roof"),qe=Ze?0:Ge,$e="globe"===Se.projection.name?Ib():0,He="globe"===Se.projection.name,We=He?Dd(Se.zoom):0,Xe=[Kd(Se.center.lng),Jd(Se.center.lat)],Ye=le.paint.get("fill-extrusion-flood-light-color").toArray01().slice(0,3),Je=le.paint.get("fill-extrusion-flood-light-intensity"),Qe=le.paint.get("fill-extrusion-vertical-scale"),tt=eM(C,le.paint.get("fill-extrusion-cutoff-fade-range")),rt=le.paint.get("fill-extrusion-emissive-strength"),ot=[];let st;He&&ot.push("PROJECTION_GLOBE_VIEW"),je[0]>0&&ot.push("FAUX_AO"),Ze&&ot.push("ZERO_ROOF_RADIUS"),_e&&ot.push("HAS_CENTROID"),Je>0&&ot.push("FLOOD_LIGHT"),tt.shouldRenderCutoff&&ot.push("RENDER_CUTOFF");const at="shadow"===C.renderPass,lt=C.shadowRenderer,ct=at&&!!lt;C.shadowRenderer&&(C.shadowRenderer.useNormalOffset=!0);let ht=[0,0,0];if(lt){const te=C.style.directionalLight,le=C.style.ambientLight;te&&le&&(ht=WA(te,le)),st=ot.concat(["SHADOWS_SINGLE_CASCADE"])}const dt=ct?"fillExtrusionDepth":Ae?"fillExtrusionPattern":"fillExtrusion",mt=le.getLayerRenderingStats();for(const Oe of ce){const ce=te.getTile(Oe),Ne=ce.getBucket(le);if(!Ne||Ne.projection.name!==Se.projection.name)continue;let Ge=!1;lt&&(Ge=0===lt.getMaxCascadeForTile(Oe.toUnwrapped()));const Ze=C.isTileAffectedByFog(Oe),ct=Ne.programConfigurations.get(le.id),_t=C.getOrCreateProgram(dt,{config:ct,defines:Ge?st:ot,overrideFog:Ze});if(C.terrain&&C.terrain.setupElevationDraw(ce,_t,{useMeterToDem:!0}),!Ne.centroidVertexBuffer){const C=_t.attributes.a_centroid_pos;void 0!==C&&ve.vertexAttrib2f(C,0,0)}!at&&lt&&lt.setupShadows(ce.tileID.toUnwrapped(),_t,"vector-tile",ce.tileID.overscaledZ),Ae&&(C.context.activeTexture.set(ve.TEXTURE0),ce.imageAtlasTexture&&ce.imageAtlasTexture.bind(ve.LINEAR,ve.CLAMP_TO_EDGE),ct.updatePaintBuffers());const gt=Me.constantOr(null);if(gt&&ce.imageAtlas){const C=ce.imageAtlas.patternPositions[gt.toString()];C&&ct.setConstantPatternPositions(C)}const Pt=le.paint.get("fill-extrusion-vertical-gradient");let Ft;if(at&&lt){if(oA(ce.tileID,Ne,C))continue;const te=lt.calculateShadowPassMatrixFromTile(ce.tileID.toUnwrapped());Ft=xM(te,qe,Qe)}else{const te=C.translatePosMatrix(Oe.expandedProjMatrix,ce,le.paint.get("fill-extrusion-translate"),le.paint.get("fill-extrusion-translate-anchor")),he=Se.projection.createInversionMatrix(Se,Oe.canonical);Ft=Ae?vM(te,C,Pt,Ce,je,qe,Oe,ce,$e,We,Xe,he,Ye,Qe):yM(te,C,Pt,Ce,je,qe,Oe,$e,We,Xe,he,Ye,Qe,Je,ht,rt)}C.uploadCommonUniforms(ye,_t,Oe.toUnwrapped(),null,tt);let jt=Ne.segments;if("mercator"===Se.projection.name&&!at&&(jt=Ne.getVisibleSegments(ce.tileID,C.terrain,C.transform.getFrustum(0)),!jt.get().length))continue;if(mt)if(at)for(const C of jt.get())mt.numRenderedVerticesInShadowPass+=C.primitiveLength;else for(const C of jt.get())mt.numRenderedVerticesInTransparentPass+=C.primitiveLength;const Ut=[];(C.terrain||_e)&&Ut.push(Ne.centroidVertexBuffer),He&&Ut.push(Ne.layoutVertexExtBuffer),_t.draw(C,ye.gl.TRIANGLES,he,ue,de,Dx.backCCW,Ft,le.id,Ne.layoutVertexBuffer,Ne.indexBuffer,jt,le.paint,C.transform.zoom,ct,Ut)}C.shadowRenderer&&(C.shadowRenderer.useNormalOffset=!1)}function eA(C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me,Ae,Ce,Oe,Ne,je,Ge,Ze){const qe=C.context,$e=qe.gl,He=C.transform,We=C.transform.zoom,Xe=[],Ye=eM(C,le.paint.get("fill-extrusion-cutoff-fade-range"));"clear"===ve?(Xe.push("CLEAR_SUBPASS"),Ze&&(Xe.push("CLEAR_FROM_TEXTURE"),qe.activeTexture.set($e.TEXTURE0),Ze.bind($e.LINEAR,$e.CLAMP_TO_EDGE))):"sdf"===ve&&Xe.push("SDF_SUBPASS"),je&&Xe.push("HAS_CENTROID"),Ye.shouldRenderCutoff&&Xe.push("RENDER_CUTOFF");const Je=le.layout.get("fill-extrusion-edge-radius"),A=(te,ce,ve,Ge,$e)=>{const He=ce.programConfigurations.get(le.id),Qe=C.isTileAffectedByFog(te),tt=C.getOrCreateProgram("fillExtrusionGroundEffect",{config:He,defines:Xe,overrideFog:Qe}),rt=((C,te,le,ce,he,ue,de,_e,ye,ve,Se)=>({u_matrix:te,u_opacity:le,u_ao_pass:ce?1:0,u_meter_to_tile:he,u_ao:ue,u_flood_light_intensity:de,u_flood_light_color:_e,u_attenuation:ye,u_edge_radius:ve,u_fb:0,u_fb_size:Se}))(0,Ge,Se,ye,$e,[Me,Ae*$e],Ce,Oe,Ne,We>=17?0:Je*$e,Ze?Ze.size[0]:0),ot=[];je&&ot.push(ce.hiddenByLandmarkVertexBuffer),C.uploadCommonUniforms(qe,tt,te.toUnwrapped(),null,Ye),tt.draw(C,qe.gl.TRIANGLES,he,ue,de,_e,rt,le.id,ce.vertexBuffer,ce.indexBuffer,ve,le.paint,We,He,ot)};for(const he of ce){const ce=te.getTile(he),ue=ce.getBucket(le);if(!ue||ue.projection.name!==He.projection.name||!ue.groundEffect||ue.groundEffect&&!ue.groundEffect.hasData())continue;const de=ue.groundEffect,_e=1/ue.tileToMeter;{const te=C.translatePosMatrix(he.projMatrix,ce,le.paint.get("fill-extrusion-translate"),le.paint.get("fill-extrusion-translate-anchor")),ue=de.getDefaultSegment();A(he,de,ue,te,_e)}if(Ge)for(let ue=0;ue<4;ue++){const de=Np[ue](he),ye=te.getTile(de);if(!ye)continue;const ve=ye.getBucket(le);if(!ve||ve.projection.name!==He.projection.name||!ve.groundEffect||ve.groundEffect&&!ve.groundEffect.hasData())continue;const Se=ve.groundEffect;let Me,Ae;0===ue?(Me=[-Mn,0,0],Ae=1):1===ue?(Me=[Mn,0,0],Ae=0):2===ue?(Me=[0,-Mn,0],Ae=3):(Me=[0,Mn,0],Ae=2);const Ce=Se.regionSegments[Ae];if(!Ce)continue;const Oe=new Float32Array(16);ld.translate(Oe,he.projMatrix,Me),A(he,Se,Ce,C.translatePosMatrix(Oe,ce,le.paint.get("fill-extrusion-translate"),le.paint.get("fill-extrusion-translate-anchor")),_e)}}}function tA(C,te,le,ce,he,ue,de){0===ce.centroidVertexArray.length&&ce.createCentroidsBuffer();const _e=ue?ue.findDEMTileFor(le):null;if(!(_e&&_e.dem||de))return;const l=C=>{const le=te.getSource().minzoom,r=C=>{const le=te.getTileByID(C);if(le&&le.hasData())return le.getBucket(he)},ce=[0,-1,1];for(const te of ce){if(C.overscaledZ+te<le)continue;const ce=r(C.calculateScaledKey(C.overscaledZ+te));if(ce)return ce}},ye=[0,0,0],h=(C,te)=>(ye[0]=Math.min(C.min.y,te.min.y),ye[1]=Math.max(C.max.y,te.max.y),ye[2]=Mn-te.min.x>C.max.x?te.min.x-Mn:C.max.x,ye),u=(C,te)=>(ye[0]=Math.min(C.min.x,te.min.x),ye[1]=Math.max(C.max.x,te.max.x),ye[2]=Mn-te.min.y>C.max.y?te.min.y-Mn:C.max.y,ye),ve=[(C,te)=>h(C,te),(C,te)=>h(te,C),(C,te)=>u(C,te),(C,te)=>u(te,C)],p=(C,te,ce,he,de,ye,ve)=>{if(!ue)return 0;const Se=[[ye?ce:C,ye?C:ce,0],[ye?ce:te,ye?te:ce,0]],Me=ve<0?Mn+ve:ve,Ae=[ye?Me:(C+te)/2,ye?(C+te)/2:Me,0];return 0===ce&&ve<0||0!==ce&&ve>0?ue.getForTilePoints(de,[Ae],!0,he):Se.push(Ae),ue.getForTilePoints(le,Se,!0,_e),Math.max(Se[0][2],Se[1][2],Ae[2])/ue.exaggeration()};for(let C=0;C<4;C++){const te=ce.borderFeatureIndices[C];if(0===te.length)continue;const he=Np[C](le),_e=l(he);if(!(_e&&_e instanceof vb))continue;if(ce.borderDoneWithNeighborZ[C]===_e.canonical.z)continue;0===_e.centroidVertexArray.length&&_e.createCentroidsBuffer();const ye=ue?ue.findDEMTileFor(he):null;if(!(ye&&ye.dem||de))continue;const Ce=(C<2?1:5)-C,Oe=_e.borderDoneWithNeighborZ[Ce]!==ce.canonical.z,Ne=_e.borderFeatureIndices[Ce];let Ge=0;if(ce.canonical.z!==_e.canonical.z){for(const C of te)ce.showCentroid(ce.featuresOnBorder[C]);if(Oe)for(const C of Ne)_e.showCentroid(_e.featuresOnBorder[C]);ce.borderDoneWithNeighborZ[C]=_e.canonical.z,_e.borderDoneWithNeighborZ[Ce]=ce.canonical.z}for(const le of te){const te=ce.featuresOnBorder[le],ue=ce.centroidData[te.centroidDataIndex],Oe=te.borders[C];let Ze;for(;Ge<Ne.length;){Ze=_e.featuresOnBorder[Ne[Ge]];const C=Ze.borders[Ce];if(C[1]>Oe[0]+3||C[0]>Oe[0]-3)break;_e.showCentroid(Ze),Ge++}if(Ze&&Ge<Ne.length){const le=Ge;let qe=0;for(;!(Ze.borders[Ce][0]>Oe[1]-3)&&(qe++,++Ge!==Ne.length);)Ze=_e.featuresOnBorder[Ne[Ge]];if(Ze=_e.featuresOnBorder[Ne[le]],qe>1){const C=Ze.borders[Ce];Math.abs(Oe[0]-C[0])<3&&Math.abs(Oe[1]-C[1])<3&&(qe=1,Ge=le+1)}else if(0===qe){ce.showCentroid(te);continue}const $e=_e.centroidData[Ze.centroidDataIndex];de&&1===qe&&(((Me=ue).flags|(Ae=$e).flags)&Sw?(Me.flags|=Sw,Ae.flags|=Sw):(Me.flags&=2147483647,Ae.flags&=2147483647));let He=new je(0,0);if(qe>1)Ge=le;else if(ye&&ye.dem&&!(te.intersectsCount()>1||Ze.intersectsCount()>1)){const te=ve[C](ue,$e),le=C%2?Mn-1:0;Se=p(te[0],Math.min(Mn-1,te[1]),le,ye,he,C<2,te[2]),He=new je(Math.ceil(7*(Se+450)),0)}ue.centroidXY=$e.centroidXY=He,ce.writeCentroidToBuffer(ue),_e.writeCentroidToBuffer($e)}else ce.showCentroid(te)}ce.borderDoneWithNeighborZ[C]=_e.canonical.z,_e.borderDoneWithNeighborZ[Ce]=ce.canonical.z}var Se,Me,Ae;(ce.needsCentroidUpdate||!ce.centroidVertexBuffer&&0!==ce.centroidVertexArray.length)&&ce.uploadCentroid(C)}const PA=[1,0,0],LA=[0,1,0],FA=[0,0,1];function oA(C,te,le){const ce=le.transform,he=le.shadowRenderer;if(!he)return!0;const ue=C.toUnwrapped(),de=ce.tileSize*he._cascades[le.currentShadowCascade].scale;let _e=te.maxHeight;if(ce.elevation){const te=ce.elevation.getMinMaxForTile(C);te&&(_e+=te.max)}const ye=[...he.shadowDirection];ye[2]=-ye[2];const ve=he.computeSimplifiedTileShadowVolume(ue,_e,de,ye);if(!ve)return!1;const Se=[PA,LA,FA,ye,[ye[0],0,ye[2]],[0,ye[1],ye[2]]],Me="globe"===ce.projection.name,Ae=ce.scaleZoom(de),Ce=Qu.fromInvProjectionMatrix(ce.invProjMatrix,ce.worldSize,Ae,!Me),Oe=he.getCurrentCascadeFrustum();return 0===Ce.intersectsPrecise(ve.vertices,ve.planes,Se)||0===Oe.intersectsPrecise(ve.vertices,ve.planes,Se)}function sA(C){const te=C._nearZ,le=C.projection.farthestPixelDistance(C),ce=le-te,he=.2*C.height,ue=te+he;return[te,le,(ue-he-te)/ce,(ue-te)/ce]}const NA=new qr(1,0,0,1),VA=new qr(0,1,0,1),KA=new qr(0,0,1,1),JA=new qr(1,0,1,1),QA=new qr(0,1,1,1);function dA(C,te,le){const ce=C.context,he=C.transform,ue=ce.gl,de="globe"===he.projection.name,_e=de?["PROJECTION_GLOBE_VIEW"]:[];let ye=le.projMatrix;if(de&&Dd(he.zoom)>0){const C=Sd(_d(le.canonical,he));ye=ld.multiply(new Float32Array(16),he.globeMatrix,C),ld.multiply(ye,he.projMatrix,ye)}const ve=C.getOrCreateProgram("debug",{defines:_e}),Se=te.getTileByID(le.key);C.terrain&&C.terrain.setupElevationDraw(Se,ve);const Me=Mx.disabled,Ae=Sx.disabled,Ce=C.colorModeForRenderPass(),Oe="$debug";ce.activeTexture.set(ue.TEXTURE0),C.emptyTexture.bind(ue.LINEAR,ue.CLAMP_TO_EDGE),de?Se._makeGlobeTileDebugBuffers(C.context,he):Se._makeDebugTileBoundsBuffers(C.context,he.projection);const Ne=Se._tileDebugBuffer||C.debugBuffer,je=Se._tileDebugIndexBuffer||C.debugIndexBuffer,Ge=Se._tileDebugSegments||C.debugSegments;ve.draw(C,ue.LINE_STRIP,Me,Ae,Ce,Dx.disabled,AM(ye,qr.red),Oe,Ne,je,Ge,null,null,null,[Se._globeTileDebugBorderBuffer]);const Ze=Se.latestRawTileData,qe=Math.floor((Ze&&Ze.byteLength||0)/1024),$e=te.getTile(le).tileSize,He=512/Math.min($e,512)*(le.overscaledZ/he.zoom)*.5;let We=le.canonical.toString();le.overscaledZ!==le.canonical.z&&(We+=` => ${le.overscaledZ}`),We+=` ${qe}kb`,function(C,te){C.initDebugOverlayCanvas();const le=C.debugOverlayCanvas,ce=C.context.gl,he=C.debugOverlayCanvas.getContext("2d");he.clearRect(0,0,le.width,le.height),he.shadowColor="white",he.shadowBlur=2,he.lineWidth=1.5,he.strokeStyle="white",he.textBaseline="top",he.font="bold 36px Open Sans, sans-serif",he.fillText(te,5,5),he.strokeText(te,5,5),C.debugOverlayTexture.update(le),C.debugOverlayTexture.bind(ce.LINEAR,ce.CLAMP_TO_EDGE)}(C,We);const Xe=Se._tileDebugTextBuffer||C.debugBuffer,Ye=Se._tileDebugTextIndexBuffer||C.quadTriangleIndexBuffer,Je=Se._tileDebugTextSegments||C.debugSegments;ve.draw(C,ue.TRIANGLES,Me,Ae,Cx.alphaBlended,Dx.disabled,AM(ye,qr.transparent,He),Oe,Xe,Ye,Je,null,null,null,[Se._globeTileDebugTextBuffer])}function pA(C,te,le,ce){mA(C,0,te+le/2,C.transform.width,le,ce)}function fA(C,te,le,ce){mA(C,te-le/2,0,le,C.transform.height,ce)}function mA(C,te,le,ce,he,ue){const de=C.context,_e=de.gl;_e.enable(_e.SCISSOR_TEST),_e.scissor(te*bi.devicePixelRatio,le*bi.devicePixelRatio,ce*bi.devicePixelRatio,he*bi.devicePixelRatio),de.clear({color:ue}),_e.disable(_e.SCISSOR_TEST)}const eI=Ia([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:sI}=eI;function yA(C,te,le,ce){C.emplaceBack(te,le,ce)}class xA{constructor(C){this.vertexArray=new tl,this.indices=new Wa,yA(this.vertexArray,-1,-1,1),yA(this.vertexArray,1,-1,1),yA(this.vertexArray,-1,1,1),yA(this.vertexArray,1,1,1),yA(this.vertexArray,-1,-1,-1),yA(this.vertexArray,1,-1,-1),yA(this.vertexArray,-1,1,-1),yA(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=C.createVertexBuffer(this.vertexArray,sI),this.indexBuffer=C.createIndexBuffer(this.indices),this.segment=xl.simpleSegment(0,0,36,12)}}function vA(C,te,le,ce,he,ue){const de=C.context.gl,_e=te.paint.get("sky-atmosphere-color"),ye=te.paint.get("sky-atmosphere-halo-color"),ve=te.paint.get("sky-atmosphere-sun-intensity"),Se=((C,te,le,ce,he)=>({u_matrix_3f:C,u_sun_direction:te,u_sun_intensity:le,u_color_tint_r:[ce.r,ce.g,ce.b,ce.a],u_color_tint_m:[he.r,he.g,he.b,he.a],u_luminance:5e-5}))(sd.fromMat4(sd.create(),ce),he,ve,_e,ye);de.framebufferTexture2D(de.FRAMEBUFFER,de.COLOR_ATTACHMENT0,de.TEXTURE_CUBE_MAP_POSITIVE_X+ue,te.skyboxTexture,0),le.draw(C,de.TRIANGLES,Mx.disabled,Sx.disabled,Cx.unblended,Dx.frontCW,Se,"skyboxCapture",te.skyboxGeometry.vertexBuffer,te.skyboxGeometry.indexBuffer,te.skyboxGeometry.segment)}const lI=Ia([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class wA{constructor(C){const te=new Ka;te.emplaceBack(-1,1,1,0,0),te.emplaceBack(1,1,1,1,0),te.emplaceBack(1,-1,1,1,1),te.emplaceBack(-1,-1,1,0,1);const le=new Wa;le.emplaceBack(0,1,2),le.emplaceBack(2,3,0),this.vertexBuffer=C.createVertexBuffer(te,lI.members),this.indexBuffer=C.createIndexBuffer(le),this.segments=xl.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const cI=Ia([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class EA{constructor(){this.colorModeAlphaBlendedWriteRGB=new Cx([1,ob,1,ob],qr.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new Cx([1,0,1,0],qr.transparent,[!1,!1,!1,!0])}update(C){const te=C.context;if(!this.atmosphereBuffer){this.atmosphereBuffer=new wA(te);const C=100,le=200,ce=function(C){const te=Xn(30),le=[];for(let C=0;C<16e3;++C){const C=2*Math.PI*te(),ce=Math.acos(1-2*te())-.5*Math.PI;le.push(Zd.fromValues(Math.cos(ce)*Math.cos(C),Math.cos(ce)*Math.sin(C),Math.sin(ce)))}return le}(),he=Xn(300),ue=new Ja,de=new Wa;let _e=0;for(let te=0;te<ce.length;++te){const ye=Zd.scale([],ce[te],200),ve=Math.max(0,1+.01*C*(1*he()-.5)),Se=Math.max(0,1+.01*le*(1*he()-.5));ue.emplaceBack(ye[0],ye[1],ye[2],-1,-1,ve,Se),ue.emplaceBack(ye[0],ye[1],ye[2],1,-1,ve,Se),ue.emplaceBack(ye[0],ye[1],ye[2],1,1,ve,Se),ue.emplaceBack(ye[0],ye[1],ye[2],-1,1,ve,Se),de.emplaceBack(_e+0,_e+1,_e+2),de.emplaceBack(_e+0,_e+2,_e+3),_e+=4}this.starsVx=te.createVertexBuffer(ue,cI.members),this.starsIdx=te.createIndexBuffer(de),this.starsSegments=xl.simpleSegment(0,0,ue.length,de.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(C,te){const le=C.context,ce=le.gl,he=C.transform,ue=new Mx(ce.LEQUAL,Mx.ReadOnly,[0,1]),de=Dd(he.zoom),_e=te.properties.get("color").toArray01(),ye=te.properties.get("high-color").toArray01(),ve=te.properties.get("space-color").toArray01PremultipliedAlpha(),Se=5e-4,Me=z((te.properties.get("horizon-blend")-0)/1*.2495+Se,5e-4,.25),Ae=Ld(C,le,he)&&Me===Se?he.worldSize/(2*Math.PI*1.025)-1:he.globeRadius,Ce=C.frameCounter/1e3%1,Oe=Zd.length(he.globeCenterInViewSpace),Ne=Math.sqrt(Math.pow(Oe,2)-Math.pow(Ae,2)),je=Math.acos(Ne/Oe),g=te=>{const Se="globe"===he.projection.name?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];te&&Se.push("ALPHA_PASS");const Ae=C.getOrCreateProgram("globeAtmosphere",{defines:Se}),Oe=((C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me)=>({u_frustum_tl:C,u_frustum_tr:te,u_frustum_br:le,u_frustum_bl:ce,u_horizon:he,u_transition:ue,u_fadeout_range:de,u_color:_e,u_high_color:ye,u_space_color:ve,u_temporal_offset:Se,u_horizon_angle:Me}))(he.frustumCorners.TL,he.frustumCorners.TR,he.frustumCorners.BR,he.frustumCorners.BL,he.frustumCorners.horizon,de,Me,_e,ye,ve,Ce,je);C.uploadCommonUniforms(le,Ae);const Ne=this.atmosphereBuffer;Ne&&Ae.draw(C,ce.TRIANGLES,ue,Sx.disabled,te?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Dx.backCW,Oe,te?"atmosphere_glow_alpha":"atmosphere_glow",Ne.vertexBuffer,Ne.indexBuffer,Ne.segments)};g(!1),g(!0)}drawStars(C,te){const le=z(te.properties.get("star-intensity"),0,1);if(0===le)return;const ce=C.context,he=ce.gl,ue=C.transform,de=C.getOrCreateProgram("stars"),_e=Md.identity([]);Md.rotateX(_e,_e,-ue._pitch),Md.rotateZ(_e,_e,-ue.angle),Md.rotateX(_e,_e,w(ue._center.lat)),Md.rotateY(_e,_e,-w(ue._center.lng));const ye=ld.fromQuat(new Float32Array(16),_e),ve=ld.multiply([],ue.starsProjMatrix,ye),Se=sd.fromMat4([],ye),Me=sd.invert([],Se),Ae=[0,1,0];Zd.transformMat3(Ae,Ae,Me),Zd.scale(Ae,Ae,.15);const Ce=[1,0,0];Zd.transformMat3(Ce,Ce,Me),Zd.scale(Ce,Ce,.15);const Oe=((C,te,le,ce)=>({u_matrix:Float32Array.from(C),u_up:te,u_right:le,u_intensity_multiplier:ce}))(ve,Ae,Ce,le);C.uploadCommonUniforms(ce,de),this.starsVx&&this.starsIdx&&de.draw(C,he.TRIANGLES,Mx.disabled,Sx.disabled,this.colorModeAlphaBlendedWriteRGB,Dx.disabled,Oe,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function MA(C,te){const le=[...C],ce=te.cameraWorldSizeForFog/te.worldSize,he=ld.identity([]);return ld.scale(he,he,[ce,ce,1]),ld.multiply(le,he,le),ld.multiply(le,te.worldToFogMatrix,le),le}function AA(C,te,le,ce){const he=le.material,ue=ce.context,{baseColorTexture:de,metallicRoughnessTexture:_e}=he.pbrMetallicRoughness,{normalTexture:ye,occlusionTexture:ve,emissionTexture:Se}=he;function u(te,le,ce){if(te&&(C.push(le),ue.activeTexture.set(ue.gl.TEXTURE0+ce),te.gfxTexture)){const{minFilter:C,magFilter:le,wrapS:ce,wrapT:he}=te.sampler;te.gfxTexture.bindExtraParam(C,le,ce,he)}}u(de,"HAS_TEXTURE_u_baseColorTexture",uA.BaseColor),u(_e,"HAS_TEXTURE_u_metallicRoughnessTexture",uA.MetallicRoughness),u(ye,"HAS_TEXTURE_u_normalTexture",uA.Normal),u(ve,"HAS_TEXTURE_u_occlusionTexture",uA.Occlusion),u(Se,"HAS_TEXTURE_u_emissionTexture",uA.Emission),le.texcoordBuffer&&(C.push("HAS_ATTRIBUTE_a_uv_2f"),te.push(le.texcoordBuffer)),le.colorBuffer&&(C.push(12===le.colorBuffer.itemSize?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),te.push(le.colorBuffer)),le.normalBuffer&&(C.push("HAS_ATTRIBUTE_a_normal_3f"),te.push(le.normalBuffer)),le.pbrBuffer&&(C.push("HAS_ATTRIBUTE_a_pbr"),C.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),te.push(le.pbrBuffer)),"OPAQUE"!==he.alphaMode&&"MASK"!==he.alphaMode||C.push("UNPREMULT_TEXTURE_IN_SHADER"),he.defined||C.push("DIFFUSE_SHADED"),C.push("USE_STANDARD_DERIVATIVES")}function SA(C,te,le,ce,he,ue){const de=le.paint.get("model-opacity"),_e=te.context,ye=new Mx(te.context.gl.LEQUAL,Mx.ReadWrite,te.depthRangeFor3D),ve=te.transform,Se=C.mesh,Me=Se.material,Ae=Me.pbrMetallicRoughness,Ce=te.style.fog;let Oe;Oe="pixels"===te.transform.projection.zAxisUnit?[...C.nodeModelMatrix]:ld.multiply([],ce.zScaleMatrix,C.nodeModelMatrix),ld.multiply(Oe,ce.negCameraPosMatrix,Oe);const Ne=ld.invert([],Oe);ld.transpose(Ne,Ne);const je=le.paint.get("model-emissive-strength").constantOr(0),Ge=UM(new Float32Array(C.worldViewProjection),new Float32Array(Oe),new Float32Array(Ne),te,de,Ae.baseColorFactor,Me.emissiveFactor,Ae.metallicFactor,Ae.roughnessFactor,Me,je,le),Ze={defines:[]},qe=[];AA(Ze.defines,qe,Se,te);const $e=te.shadowRenderer;$e&&($e.useNormalOffset=!1);let He=null;if(Ce){const le=MA(C.nodeModelMatrix,te.transform);if(He=new Float32Array(le),"globe"!==ve.projection.name){const C=Se.aabb.min,te=Se.aabb.max,[ce,he]=Ce.getOpacityForBounds(le,C[0],C[1],te[0],te[1]);Ze.overrideFog=ce>=$T||he>=$T}}const We=eM(te,le.paint.get("model-cutoff-fade-range"));We.shouldRenderCutoff&&Ze.defines.push("RENDER_CUTOFF");const Xe=te.getOrCreateProgram("model",Ze);te.uploadCommonUniforms(_e,Xe,null,He,We),"shadow"!==te.renderPass&&$e&&$e.setupShadowsFromMatrix(C.nodeModelMatrix,Xe),Xe.draw(te,_e.gl.TRIANGLES,ye,he,ue,Se.material.doubleSided?Dx.disabled:Dx.backCCW,Ge,le.id,Se.vertexBuffer,Se.indexBuffer,Se.segments,le.paint,te.transform.zoom,void 0,qe)}function IA(C,te,le,ce,he,ue,de){let _e;_e="globe"===C.projection.name?Av(le,C):[...le],ld.multiply(_e,_e,te.matrix);const ye=ld.multiply([],ce,_e);if(te.meshes)for(const C of te.meshes){if("BLEND"!==C.material.alphaMode){de.push({mesh:C,depth:0,modelIndex:he,worldViewProjection:ye,nodeModelMatrix:_e});continue}const te=Zd.transformMat4([],C.centroid,ye);te[2]>0&&ue.push({mesh:C,depth:te[2],modelIndex:he,worldViewProjection:ye,nodeModelMatrix:_e})}if(te.children)for(const _e of te.children)IA(C,_e,le,ce,he,ue,de)}function CA(C,te,le,ce){const he=le.shadowRenderer;if(!he)return;const ue=he.getShadowPassDepthMode(),de=he.getShadowPassColorMode(),_e=he.calculateShadowPassMatrixFromMatrix(te),ye=jM(_e);le.getOrCreateProgram("modelDepth",{defines:["DEPTH_TEXTURE"]}).draw(le,le.context.gl.TRIANGLES,ue,Sx.disabled,de,Dx.backCCW,ye,ce.id,C.vertexBuffer,C.indexBuffer,C.segments,ce.paint,le.transform.zoom,void 0,void 0)}function zA(C,te,le){const ce=te.updateZoomBasedPaintProperties(),he=function(C,te,le){let ce,he,ue,de=C.terrain?C.terrain.exaggeration():0;if(C.terrain&&de>0){const te=C.terrain,he=te.findDEMTileFor(le);he&&he.dem?ce=Jm.create(te,le,he):de=0}if(0===de&&(te.terrainElevationMin=0,te.terrainElevationMax=0),de===te.validForExaggeration&&(0===de||ce&&ce._demTile&&ce._demTile.tileID===te.validForDEMTile.id&&ce._dem._timestamp===te.validForDEMTile.timestamp))return!1;for(const C in te.instancesPerModel){const le=te.instancesPerModel[C];for(let C=0;C<le.instancedDataArray.length;++C){const _e=(ce?de*ce.getElevationAt(0|le.instancedDataArray.float32[16*C],0|le.instancedDataArray.float32[16*C+1],!0,!0):0)+le.instancesEvaluatedElevation[C];le.instancedDataArray.float32[16*C+6]=_e,he=he?Math.min(te.terrainElevationMin,_e):_e,ue=ue?Math.max(te.terrainElevationMax,_e):_e}}return te.terrainElevationMin=he||0,te.terrainElevationMax=ue||0,te.validForExaggeration=de,te.validForDEMTile=ce&&ce._demTile?{id:ce._demTile.tileID,timestamp:ce._dem._timestamp}:{id:void 0,timestamp:0},!0}(C,te,le);(ce||he)&&(te.uploaded=!1,te.upload(C.context))}const dI={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new ed([0,0,0],[Mn,Mn,0])};function DA(C,te){const le=1<<C.canonical.z,ce=te.getFreeCameraOptions().position,he=te.elevation,ue=C.canonical.x/le,de=(C.canonical.x+1)/le,_e=C.canonical.y/le,ye=(C.canonical.y+1)/le;let ve=te._centerAltitude;if(he){const te=he.getMinMaxForTile(C);te&&te.max>ve&&(ve=te.max)}const Se=z(ce.x,ue,de)-ce.x,Me=z(ce.y,_e,ye)-ce.y,Ae=Qd(ve,te.center.lat)-ce.z;return te._zoomFromMercatorZ(Math.sqrt(Se*Se+Me*Me+Ae*Ae))}function RA(C,te,le,ce,he,ue,de){const _e=C.context,ye="shadow"===C.renderPass,ve=C.shadowRenderer,Se=ye&&ve?ve.getShadowPassDepthMode():new Mx(_e.gl.LEQUAL,Mx.ReadWrite,C.depthRangeFor3D),Me=C.isTileAffectedByFog(ue);if(le.meshes)for(const Ae of le.meshes){const Ce=["MODEL_POSITION_ON_GPU"],Oe=[];let Ne,je,Ge;ce.instancedDataArray.length>20&&Ce.push("INSTANCED_ARRAYS");const Ze=eM(C,te.paint.get("model-cutoff-fade-range"));if(Ze.shouldRenderCutoff&&Ce.push("RENDER_CUTOFF"),ye&&ve)Ne=C.getOrCreateProgram("modelDepth",{defines:Ce}),je=jM(de.shadowTileMatrix,de.shadowTileMatrix,Float32Array.from(le.matrix)),Ge=ve.getShadowPassColorMode();else{AA(Ce,Oe,Ae,C),Ne=C.getOrCreateProgram("model",{defines:Ce,overrideFog:Me});const ce=Ae.material,ye=ce.pbrMetallicRoughness,Se=te.paint.get("model-opacity"),qe=te.paint.get("model-emissive-strength").constantOr(0);je=UM(ue.expandedProjMatrix,Float32Array.from(le.matrix),new Float32Array(16),C,Se,ye.baseColorFactor,ce.emissiveFactor,ye.metallicFactor,ye.roughnessFactor,ce,qe,te,he),ve&&(de.shadowUniformsInitialized?Ne.setShadowUniformValues(_e,ve.getShadowUniformValues()):(ve.setupShadows(ue.toUnwrapped(),Ne,"model-tile",ue.overscaledZ),de.shadowUniformsInitialized=!0)),Ge=Ze.shouldRenderCutoff||Se<1||"OPAQUE"!==ce.alphaMode?Cx.alphaBlended:Cx.unblended}C.uploadCommonUniforms(_e,Ne,ue.toUnwrapped(),null,Ze);const qe=Ae.material.doubleSided?Dx.disabled:Dx.backCCW;if(ce.instancedDataArray.length>20)Oe.push(ce.instancedDataBuffer),Ne.draw(C,_e.gl.TRIANGLES,Se,Sx.disabled,Ge,qe,je,te.id,Ae.vertexBuffer,Ae.indexBuffer,Ae.segments,te.paint,C.transform.zoom,void 0,Oe,ce.instancedDataArray.length);else{const le=ye?"u_instance":"u_normal_matrix";for(let he=0;he<ce.instancedDataArray.length;++he)je[le]=new Float32Array(ce.instancedDataArray.arrayBuffer,64*he,16),Ne.draw(C,_e.gl.TRIANGLES,Se,Sx.disabled,Ge,qe,je,te.id,Ae.vertexBuffer,Ae.indexBuffer,Ae.segments,te.paint,C.transform.zoom,void 0,Oe)}}if(le.children)for(const _e of le.children)RA(C,te,_e,ce,he,ue,de)}const pI=[1,-1,1];function kA(C,te,le,ce){if(!le.modelManager)return!0;const he=le.modelManager;if(!le.shadowRenderer)return!0;const ue=le.shadowRenderer,de=te.aabb;let _e=!0,ye=C.maxHeight;if(0===ye){let te=0;for(const le in C.instancesPerModel){const C=he.getModel(le,ce);C?te=Math.max(te,Math.max(Math.max(C.aabb.max[0],C.aabb.max[1]),C.aabb.max[2])):_e=!1}ye=C.maxScale*te*1.41+C.maxVerticalOffset,_e&&(C.maxHeight=ye)}de.max[2]=ye,de.min[2]+=C.terrainElevationMin,de.max[2]+=C.terrainElevationMax,Zd.transformMat4(de.min,de.min,te.tileMatrix),Zd.transformMat4(de.max,de.max,te.tileMatrix);const ve=de.intersects(ue.getCurrentCascadeFrustum());return 0===le.currentShadowCascade&&(C.isInsideFirstShadowMapFrustum=2===ve),0===ve}class OA{}class BA{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(C,te,le){{const le=this._storage.get(te.id);if(le)return le.lastUsedFrameIdx=C,le.buf}const ce=le.gl,he=ce.getBufferParameter(ce.ELEMENT_ARRAY_BUFFER,ce.BUFFER_SIZE),ue=new ArrayBuffer(he),de=new Int16Array(ue);ce.getBufferSubData(ce.ELEMENT_ARRAY_BUFFER,0,new Int16Array(ue));const _e=new ja;for(let C=0;C<he/2;C+=3){const te=de[C],le=de[C+1],ce=de[C+2];_e.emplaceBack(te,le),_e.emplaceBack(le,ce),_e.emplaceBack(ce,te)}const ye=le.bindVertexArrayOES.current,ve=new OA;return ve.buf=new Fy(le,_e),ve.lastUsedFrameIdx=C,this._storage.set(te.id,ve),le.bindVertexArrayOES.set(ye),ve.buf}update(C){for(const[te,le]of this._storage)C-le.lastUsedFrameIdx>30&&(le.buf.destroy(),this._storage.delete(te))}destroy(){for(const[C,te]of this._storage)te.buf.destroy(),this._storage.delete(C)}}const fI={symbol:function(C,te,le,ce,he){if("translucent"!==C.renderPass)return;const ue=Sx.disabled,de=C.colorModeForRenderPass();le.layout.get("text-variable-anchor")&&function(C,te,le,ce,he,ue,de){const _e=te.transform,ye="map"===he,ve="map"===ue;for(const te of C){const C=ce.getTile(te),he=C.getBucket(le);if(!he||!he.text||!he.text.segments.get().length)continue;const ue=m_(he.textSizeData,_e.zoom),Se=YT(te,he.getProjection(),_e),Me=_e.calculatePixelsToTileUnitsMatrix(C),Ae=sv(Se,C.tileID.canonical,ve,ye,_e,he.getProjection(),Me),Ce=he.hasIconTextFit()&&he.hasIconData();if(ue){const le=Math.pow(2,_e.zoom-C.tileID.overscaledZ);HM(he,ye,ve,de,Vg,_e,Ae,te,le,ue,Ce)}}}(ce,C,le,te,le.layout.get("text-rotation-alignment"),le.layout.get("text-pitch-alignment"),he),0!==le.paint.get("icon-opacity").constantOr(1)&&YM(C,te,le,ce,!1,le.paint.get("icon-translate"),le.paint.get("icon-translate-anchor"),le.layout.get("icon-rotation-alignment"),le.layout.get("icon-pitch-alignment"),le.layout.get("icon-keep-upright"),le.paint.get("icon-color-saturation"),ue,de),0!==le.paint.get("text-opacity").constantOr(1)&&YM(C,te,le,ce,!0,le.paint.get("text-translate"),le.paint.get("text-translate-anchor"),le.layout.get("text-rotation-alignment"),le.layout.get("text-pitch-alignment"),le.layout.get("text-keep-upright"),le.paint.get("icon-color-saturation"),ue,de),te.map.showCollisionBoxes&&(ZM(C,te,le,ce,le.paint.get("text-translate"),le.paint.get("text-translate-anchor"),!0),ZM(C,te,le,ce,le.paint.get("icon-translate"),le.paint.get("icon-translate-anchor"),!1))},circle:function(C,te,le,ce){if("translucent"!==C.renderPass)return;const he=le.paint.get("circle-opacity"),ue=le.paint.get("circle-stroke-width"),de=le.paint.get("circle-stroke-opacity"),_e=void 0!==le.layout.get("circle-sort-key").constantOr(1),ye=le.paint.get("circle-emissive-strength");if(0===he.constantOr(1)&&(0===ue.constantOr(1)||0===de.constantOr(1)))return;const ve=C.context,Se=ve.gl,Me=C.transform,Ae=C.depthModeForSublayer(0,Mx.ReadOnly),Ce=Sx.disabled,Oe=C.colorModeForDrapableLayerRenderPass(ye),Ne="globe"===Me.projection.name,je=[Kd(Me.center.lng),Jd(Me.center.lat)],Ge=[];for(let he=0;he<ce.length;he++){const ue=ce[he],de=te.getTile(ue),ye=de.getBucket(le);if(!ye||ye.projection.name!==Me.projection.name)continue;const ve=ye.programConfigurations.get(le.id),Se=Gp(le),Ae=C.isTileAffectedByFog(ue);Ne&&Se.push("PROJECTION_GLOBE_VIEW");const Ce=C.getOrCreateProgram("circle",{config:ve,defines:Se,overrideFog:Ae}),Oe=ye.layoutVertexBuffer,Ze=ye.globeExtVertexBuffer,qe=ye.indexBuffer,$e=Me.projection.createInversionMatrix(Me,ue.canonical),He={programConfiguration:ve,program:Ce,layoutVertexBuffer:Oe,globeExtVertexBuffer:Ze,indexBuffer:qe,uniformValues:jp(C,ue,de,$e,je,le),tile:de};if(_e){const C=ye.segments.get();for(const te of C)Ge.push({segments:new xl([te]),sortKey:te.sortKey,state:He})}else Ge.push({segments:ye.segments,sortKey:0,state:He})}_e&&Ge.sort(((C,te)=>C.sortKey-te.sortKey));const Ze={useDepthForOcclusion:Me.depthOcclusionForSymbolsAndCircles};for(const te of Ge){const{programConfiguration:ce,program:he,layoutVertexBuffer:ue,globeExtVertexBuffer:de,indexBuffer:_e,uniformValues:ye,tile:Ne}=te.state,je=te.segments;C.terrain&&C.terrain.setupElevationDraw(Ne,he,Ze),C.uploadCommonUniforms(ve,he,Ne.tileID.toUnwrapped()),he.draw(C,Se.TRIANGLES,Ae,Ce,Oe,Dx.disabled,ye,le.id,ue,_e,je,le.paint,Me.zoom,ce,[de])}},heatmap:function(C,te,le,ce){if(0!==le.paint.get("heatmap-opacity"))if("offscreen"===C.renderPass){const he=C.context,ue=he.gl,de=Sx.disabled,_e=new Cx([ue.ONE,ue.ONE,ue.ONE,ue.ONE],qr.transparent,[!0,!0,!0,!0]);!function(C,te,le,ce){const he=C.gl,ue=te.width*ce,de=te.height*ce;C.activeTexture.set(he.TEXTURE1),C.viewport.set([0,0,ue,de]);let _e=le.heatmapFbo;if(!_e||_e&&(_e.width!==ue||_e.height!==de)){_e&&_e.destroy();const te=he.createTexture();he.bindTexture(he.TEXTURE_2D,te),he.texParameteri(he.TEXTURE_2D,he.TEXTURE_WRAP_S,he.CLAMP_TO_EDGE),he.texParameteri(he.TEXTURE_2D,he.TEXTURE_WRAP_T,he.CLAMP_TO_EDGE),he.texParameteri(he.TEXTURE_2D,he.TEXTURE_MIN_FILTER,he.LINEAR),he.texParameteri(he.TEXTURE_2D,he.TEXTURE_MAG_FILTER,he.LINEAR),_e=le.heatmapFbo=C.createFramebuffer(ue,de,!0,null),function(C,te,le,ce,he,ue){const de=C.gl;de.texImage2D(de.TEXTURE_2D,0,C.extRenderToTextureHalfFloat?de.RGBA16F:de.RGBA,he,ue,0,de.RGBA,C.extRenderToTextureHalfFloat?de.HALF_FLOAT:de.UNSIGNED_BYTE,null),ce.colorAttachment.set(le)}(C,0,te,_e,ue,de)}else he.bindTexture(he.TEXTURE_2D,_e.colorAttachment.get()),C.bindFramebuffer.set(_e.framebuffer)}(he,C,le,"globe"===C.transform.projection.name?.5:.25),he.clear({color:qr.transparent});const ye=C.transform,ve="globe"===ye.projection.name,Se=ve?["PROJECTION_GLOBE_VIEW"]:[],Me=ve?Dx.frontCCW:Dx.disabled,Ae=[Kd(ye.center.lng),Jd(ye.center.lat)];for(let Ce=0;Ce<ce.length;Ce++){const Oe=ce[Ce];if(te.hasRenderableParent(Oe))continue;const Ne=te.getTile(Oe),je=Ne.getBucket(le);if(!je||je.projection.name!==ye.projection.name)continue;const Ge=C.isTileAffectedByFog(Oe),Ze=je.programConfigurations.get(le.id),qe=C.getOrCreateProgram("heatmap",{config:Ze,defines:Se,overrideFog:Ge}),{zoom:$e}=C.transform;C.terrain&&C.terrain.setupElevationDraw(Ne,qe),C.uploadCommonUniforms(he,qe,Oe.toUnwrapped());const He=ye.projection.createInversionMatrix(ye,Oe.canonical);qe.draw(C,ue.TRIANGLES,Mx.disabled,de,_e,Me,IM(C,Oe,Ne,He,Ae,$e,le.paint.get("heatmap-intensity")),le.id,je.layoutVertexBuffer,je.indexBuffer,je.segments,le.paint,C.transform.zoom,Ze,ve?[je.globeExtVertexBuffer]:null)}he.viewport.set([0,0,C.width,C.height])}else"translucent"===C.renderPass&&(C.context.setColorMode(C.colorModeForRenderPass()),function(C,te){const le=C.context,ce=le.gl,he=te.heatmapFbo;if(!he)return;le.activeTexture.set(ce.TEXTURE0),ce.bindTexture(ce.TEXTURE_2D,he.colorAttachment.get()),le.activeTexture.set(ce.TEXTURE1);let ue=te.colorRampTexture;ue||(ue=te.colorRampTexture=new My(le,te.colorRamp,ce.RGBA)),ue.bind(ce.LINEAR,ce.CLAMP_TO_EDGE),C.getOrCreateProgram("heatmapTexture").draw(C,ce.TRIANGLES,Mx.disabled,Sx.disabled,C.colorModeForRenderPass(),Dx.disabled,((C,te,le,ce)=>({u_image:0,u_color_ramp:1,u_opacity:te.paint.get("heatmap-opacity")}))(0,te),te.id,C.viewportBuffer,C.quadTriangleIndexBuffer,C.viewportSegments,te.paint,C.transform.zoom)}(C,le))},line:function(C,te,le,ce){if("translucent"!==C.renderPass)return;const he=le.paint.get("line-opacity"),ue=le.paint.get("line-width");if(0===he.constantOr(1)||0===ue.constantOr(1))return;const de=le.paint.get("line-emissive-strength"),_e=C.depthModeForSublayer(0,Mx.ReadOnly),ye=C.colorModeForDrapableLayerRenderPass(de),ve=C.terrain&&C.terrain.renderingToTexture?1:bi.devicePixelRatio,Se=le.paint.get("line-dasharray"),Me=Se.constantOr(1),Ae=le.layout.get("line-cap"),Ce=le.paint.get("line-pattern"),Oe=Ce.constantOr(1),Ne=le.paint.get("line-pattern").constantOr(1),je=1!==le.paint.get("line-opacity").constantOr(1);let Ge=!Ne&&je;const Ze=le.paint.get("line-gradient"),qe=Oe?"linePattern":"line",$e=C.context,He=$e.gl,We=Gb(le);C.terrain&&C.terrain.clipOrMaskOverlapStencilType()&&(Ge=!1);for(const he of ce){const ce=te.getTile(he);if(Oe&&!ce.patternsLoaded())continue;const ue=ce.getBucket(le);if(!ue)continue;C.prepareDrawTile();const de=ue.programConfigurations.get(le.id),Ne=C.isTileAffectedByFog(he),je=C.getOrCreateProgram(qe,{config:de,defines:We,overrideFog:Ne}),Xe=Ce.constantOr(null);if(Xe&&ce.imageAtlas){const C=ce.imageAtlas.patternPositions[Xe.toString()];C&&de.setConstantPatternPositions(C)}const Ye=Se.constantOr(null),Je=Ae.constantOr(null);if(!Oe&&Ye&&Je&&ce.lineAtlas){const C=ce.lineAtlas.getDash(Ye,Je);C&&de.setConstantPatternPositions(C)}let[Qe,tt]=le.paint.get("line-trim-offset");if("round"===Je||"square"===Je){const C=1;Qe!==tt&&(0===Qe&&(Qe-=C),1===tt&&(tt+=C))}const rt=C.terrain?he.projMatrix:null,ot=Oe?Ub(C,ce,le,rt,ve):Nb(C,ce,le,rt,ue.lineClipsArray.length,ve,[Qe,tt]);if(Ze){const ce=ue.gradients[le.id];let de=ce.texture;if(le.gradientVersion!==ce.version){let _e=256;if(le.stepInterpolant){const le=te.getSource().maxzoom,ce=he.canonical.z===le?Math.ceil(1<<C.transform.maxZoom-he.canonical.z):1;_e=z(U(ue.maxLineLength/Mn*1024*ce),256,$e.maxTextureSize)}ce.gradient=of({expression:le.gradientExpression(),evaluationKey:"lineProgress",resolution:_e,image:ce.gradient||void 0,clips:ue.lineClipsArray}),ce.texture?ce.texture.update(ce.gradient):ce.texture=new My($e,ce.gradient,He.RGBA),ce.version=le.gradientVersion,de=ce.texture}$e.activeTexture.set(He.TEXTURE1),de.bind(le.stepInterpolant?He.NEAREST:He.LINEAR,He.CLAMP_TO_EDGE)}Me&&($e.activeTexture.set(He.TEXTURE0),ce.lineAtlasTexture&&ce.lineAtlasTexture.bind(He.LINEAR,He.REPEAT),de.updatePaintBuffers()),Oe&&($e.activeTexture.set(He.TEXTURE0),ce.imageAtlasTexture&&ce.imageAtlasTexture.bind(He.LINEAR,He.CLAMP_TO_EDGE),de.updatePaintBuffers()),C.uploadCommonUniforms($e,je,he.toUnwrapped());const P=te=>{je.draw(C,He.TRIANGLES,_e,te,ye,Dx.disabled,ot,le.id,ue.layoutVertexBuffer,ue.indexBuffer,ue.segments,le.paint,C.transform.zoom,de,[ue.layoutVertexBuffer2])};if(Ge){const te=C.stencilModeForClipping(he).ref;0===te&&C.terrain&&$e.clear({stencil:0});const le={func:He.EQUAL,mask:255};ot.u_alpha_discard_threshold=.8,P(new Sx(le,te,255,He.KEEP,He.KEEP,He.INVERT)),ot.u_alpha_discard_threshold=0,P(new Sx(le,te,255,He.KEEP,He.KEEP,He.KEEP))}else P(C.stencilModeForClipping(he))}Ge&&(C.resetStencilClippingMasks(),C.terrain&&$e.clear({stencil:0}))},fill:function(C,te,le,ce){const he=le.paint.get("fill-color"),ue=le.paint.get("fill-opacity");if(0===ue.constantOr(1))return;const de=le.paint.get("fill-emissive-strength"),_e=C.colorModeForDrapableLayerRenderPass(de),ye=le.paint.get("fill-pattern"),ve=C.opaquePassEnabledForLayer()&&!ye.constantOr(1)&&1===he.constantOr(qr.transparent).a&&1===ue.constantOr(0)?"opaque":"translucent";if(C.renderPass===ve){const he=C.depthModeForSublayer(1,"opaque"===C.renderPass?Mx.ReadWrite:Mx.ReadOnly);JM(C,te,le,ce,he,_e,!1)}if("translucent"===C.renderPass&&le.paint.get("fill-antialias")){const he=C.depthModeForSublayer(le.getPaintProperty("fill-outline-color")?2:0,Mx.ReadOnly);JM(C,te,le,ce,he,_e,!0)}},"fill-extrusion":function(C,te,le,ce){const he=le.paint.get("fill-extrusion-opacity"),ue=C.context,de=ue.gl,_e=C.terrain,ye=_e&&_e.renderingToTexture,ve=le.paint.get("fill-extrusion-cutoff-fade-range");if(0===he)return;const Se=C.conflationActive&&C.layerUsedInConflation(le,te.getSource());if(Se&&function(C,te,le,ce){for(const he of ce){const ce=te.getTile(he).getBucket(le);ce&&(ce.updateReplacement(he,C.replacementSource),ce.uploadCentroid(C.context))}}(C,te,le,ce),_e||Se)for(const he of ce){const ce=te.getTile(he).getBucket(le);ce&&tA(C.context,te,he,ce,le,_e,Se)}if("shadow"===C.renderPass&&C.shadowRenderer){const ue=C.shadowRenderer;if(_e&&he<.65&&le._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof Ao)return;const de=ue.getShadowPassDepthMode(),ye=ue.getShadowPassColorMode();QM(C,te,le,ce,de,Sx.disabled,ye,Se)}else if("translucent"===C.renderPass){const Me=!le.paint.get("fill-extrusion-pattern").constantOr(1);if(!ye){const ue=new Mx(C.context.gl.LEQUAL,Mx.ReadWrite,C.depthRangeFor3D);0===ve&&1===he&&Me?QM(C,te,le,ce,ue,Sx.disabled,Cx.unblended,Se):(QM(C,te,le,ce,ue,Sx.disabled,Cx.disabled,Se),QM(C,te,le,ce,ue,C.stencilModeFor3D(),C.colorModeForRenderPass(),Se),C.resetStencilClippingMasks())}if(C.style.enable3dLights()&&Me&&(!_e&&"globe"!==C.transform.projection.name||ye)){const he=le.paint.get("fill-extrusion-opacity"),ve=le.paint.get("fill-extrusion-ambient-occlusion-intensity"),Me=le.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),Ae=le.paint.get("fill-extrusion-flood-light-intensity"),Ce=le.paint.get("fill-extrusion-flood-light-color").toArray01().slice(0,3),Oe=ve>0&&Me>0,Ne=Ae>0,_=(C,te,le)=>(1-le)*C+le*te,g=ue=>{const _e=C.depthModeForSublayer(1,Mx.ReadOnly,de.LEQUAL,!0),ye=le.paint.get(ue?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Oe=_(.1,3,ye),Ne=C._showOverdrawInspector;if(!Ne){const ye=new Sx({func:de.ALWAYS,mask:255},255,255,de.KEEP,de.KEEP,de.REPLACE),Ne=new Cx([de.ONE,de.ONE,de.ONE,de.ONE],qr.transparent,[!1,!1,!1,!0],de.MIN);eA(C,te,le,ce,_e,ye,Ne,Dx.disabled,ue,"sdf",he,ve,Me,Ae,Ce,Oe,Se,!1)}{const ye=Ne?Sx.disabled:new Sx({func:de.EQUAL,mask:255},255,255,de.KEEP,de.DECR,de.DECR),je=Ne?C.colorModeForRenderPass():new Cx([de.ONE_MINUS_DST_ALPHA,de.DST_ALPHA,de.ONE,de.ONE],qr.transparent,[!0,!0,!0,!0]);eA(C,te,le,ce,_e,ye,je,Dx.disabled,ue,"color",he,ve,Me,Ae,Ce,Oe,Se,!1)}};if(ye){const l=(ue,_e,ye)=>{const Oe=C.depthModeForSublayer(1,Mx.ReadOnly,de.LEQUAL,!1),Ne=le.paint.get(ue?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),je=_(.1,3,Ne);{const ye=new Cx([de.ONE,de.ONE,de.ONE,de.ONE],qr.transparent,[!1,!1,!1,!0]);eA(C,te,le,ce,Oe,Sx.disabled,ye,Dx.disabled,ue,"clear",he,ve,Me,Ae,Ce,je,Se,_e)}{const ye=new Sx({func:de.ALWAYS,mask:255},255,255,de.KEEP,de.KEEP,de.REPLACE),Ne=new Cx([de.ONE,de.ONE,de.ONE,de.ONE],qr.transparent,[!1,!1,!1,!0],de.MIN);eA(C,te,le,ce,Oe,ye,Ne,Dx.disabled,ue,"sdf",he,ve,Me,Ae,Ce,je,Se,_e)}{const ye=ue?de.ZERO:de.ONE_MINUS_DST_ALPHA,Ne=new Sx({func:de.EQUAL,mask:255},255,255,de.KEEP,de.DECR,de.DECR),Ge=new Cx([ye,de.DST_ALPHA,de.ONE_MINUS_DST_ALPHA,de.ZERO],qr.transparent,[!0,!0,!0,!0]);eA(C,te,le,ce,Oe,Ne,Ge,Dx.disabled,ue,"color",he,ve,Me,Ae,Ce,je,Se,_e)}{const Ne=new Cx([de.ONE,de.ONE,de.ONE,ue?de.ZERO:de.ONE],qr.transparent,[!1,!1,!1,!0],ue?de.FUNC_ADD:de.MAX);eA(C,te,le,ce,Oe,Sx.disabled,Ne,Dx.disabled,ue,"clear",he,ve,Me,Ae,Ce,je,Se,_e,ye)}};if(Oe||Ne){let te;if(C.prepareDrawTile(),_e){const C=_e.drapeBufferSize[0],le=_e.drapeBufferSize[1];te=_e.framebufferCopyTexture,te&&(!te||te.size[0]===C&&te.size[1]===le)||(te&&te.destroy(),te=_e.framebufferCopyTexture=new My(ue,new ef({width:C,height:le}),de.RGBA)),te.bind(de.LINEAR,de.CLAMP_TO_EDGE),de.copyTexImage2D(de.TEXTURE_2D,0,de.RGBA,0,0,C,le,0)}Oe&&l(!0,!1,te),Ne&&l(!1,!0,te)}}else Oe&&g(!0),Ne&&g(!1)}}},hillshade:function(C,te,le,ce){if("offscreen"!==C.renderPass&&"translucent"!==C.renderPass)return;if(C.style.disableElevatedTerrain)return;const he=C.context,ue=C.terrain&&C.terrain.renderingToTexture,[de,_e]="translucent"!==C.renderPass||ue?[{},ce]:C.stencilConfigForOverlap(ce);for(const ce of _e){const he=te.getTile(ce);if(he.needsHillshadePrepare&&"offscreen"===C.renderPass)YE(C,he,le);else if("translucent"===C.renderPass){const te=C.depthModeForSublayer(0,Mx.ReadOnly),_e=le.paint.get("hillshade-emissive-strength"),ye=C.colorModeForDrapableLayerRenderPass(_e),ve=ue&&C.terrain?C.terrain.stencilModeForRTTOverlap(ce):de[ce.overscaledZ];HE(C,ce,he,le,te,ve,ye)}}he.viewport.set([0,0,C.width,C.height]),C.resetStencilClippingMasks()},raster:function(C,te,le,ce,he,ue){if("translucent"!==C.renderPass)return;if(0===le.paint.get("raster-opacity"))return;const de=C.context,_e=de.gl,ye=te.getSource(),ve=function(C,te,le){const ce=C.paint.get("raster-color"),he=[],ue=C.paint.get("raster-resampling"),de=C.paint.get("raster-color-mix"),_e=C.paint.get("raster-color-range"),ye=[de[0],de[1],de[2],0],ve=de[3],Se="nearest"===ue?le.NEAREST:le.LINEAR;if(ce&&he.push("RASTER_COLOR"),ce){te.activeTexture.set(le.TEXTURE2);let ce=C.colorRampTexture;ce||(ce=C.colorRampTexture=new My(te,C.colorRamp,le.RGBA)),ce.bind(le.LINEAR,le.CLAMP_TO_EDGE)}return{mix:ye,range:_e,offset:ve,defines:he,resampling:Se}}(le,de,_e),Se=ve.defines,Me="globe"===C.transform.projection.name;let Ae=!1;if(ye instanceof Jb&&!ce.length){if(!Me)return;if(ye.onNorthPole)Ae=!0,Se.push("GLOBE_POLES");else{if(!ye.onSouthPole)return;Ae=!0,Se.push("GLOBE_POLES")}}const Ce=le.paint.get("raster-emissive-strength"),Oe=C.colorModeForDrapableLayerRenderPass(Ce),Ne=C.terrain&&C.terrain.renderingToTexture,je=ye instanceof Jb&&0!==le.paint.get("raster-elevation"),Ge=!C.options.moving,Ze="nearest"===le.paint.get("raster-resampling")?_e.NEAREST:_e.LINEAR;if(Ae){const ce=te.getSource();if(!(ce instanceof Jb))return;const he=ce.texture;if(!he)return;const ue=C.globeSharedBuffers;if(!ue)return;const ye=new Mx(_e.LEQUAL,Mx.ReadWrite,C.depthRangeFor3D),Se=Float32Array.from(C.transform.expandedFarZProjMatrix);let Me=Rd(0,0,C.transform);const Ae=Float32Array.from(Ad(fd(new ju(0,0,0)))),Ne={opacity:1,mix:0};C.terrain&&C.terrain.prepareDrawTile(),de.activeTexture.set(_e.TEXTURE0),he.bind(Ze,_e.CLAMP_TO_EDGE),de.activeTexture.set(_e.TEXTURE1),he.bind(Ze,_e.CLAMP_TO_EDGE),he.useMipmap&&de.extTextureFilterAnisotropic&&C.transform.pitch>20&&_e.texParameterf(_e.TEXTURE_2D,de.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,de.extTextureFilterAnisotropicMax);const[je,Ge,qe,$e]=ue.getPoleBuffers(0,!0);let He;ce.onNorthPole?(He=je,C.renderDefaultNorthPole=!1):(Me=ld.scale(ld.create(),Me,[1,-1,1]),He=Ge,C.renderDefaultSouthPole=!1);const We=((C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me)=>CM(C,te,le,new Float32Array(16),new Float32Array(9),[0,0],[0,0,0,0],0,[0,0],[0,0,0,0],1,ce,he,ue||[0,0],de,2,ye,ve,Se,1,0,Me))(Se,Ae,Me,Ne,le,ce.perspectiveTransform||[0,0],le.paint.get("raster-elevation"),0,ve.mix,ve.offset,ve.range,Ce),Xe=C.getOrCreateProgram("raster",{defines:ve.defines});return C.uploadCommonUniforms(de,Xe,null),void Xe.draw(C,_e.TRIANGLES,ye,Sx.disabled,Oe,Dx.disabled,We,le.id,He,qe,$e)}if(!ce.length)return;const[qe,$e]=ye instanceof Jb||Ne?[{},ce]:C.stencilConfigForOverlap(ce),He=$e[$e.length-1].overscaledZ,We=je&&Me;We&&ve.defines.push("PROJECTION_GLOBE_VIEW"),je&&ve.defines.push("RENDER_CUTOFF");for(const ce of $e){const he=ce.toUnwrapped(),Se=te.getTile(ce);if(Ne&&(!Se||!Se.hasData()))continue;if(!Se.texture)continue;let Ae,$e;Ne?(Ae=Mx.disabled,$e=ce.projMatrix):je?(Ae=new Mx(_e.LEQUAL,Mx.ReadWrite,C.depthRangeFor3D),$e=Me?Float32Array.from(C.transform.expandedFarZProjMatrix):C.transform.calculateProjMatrix(he,Ge)):(Ae=C.depthModeForSublayer(ce.overscaledZ-He,1===le.paint.get("raster-opacity")?Mx.ReadWrite:Mx.ReadOnly,_e.LESS),$e=C.transform.calculateProjMatrix(he,Ge));const Xe=C.terrain&&Ne?C.terrain.stencilModeForRTTOverlap(ce):qe[ce.overscaledZ],Ye=ue?0:le.paint.get("raster-fade-duration");Se.registerFadeDuration(Ye);const Je=te.findLoadedParent(ce,0),Qe=aM(Se,Je,te,C.transform,Ye);let tt,rt;C.terrain&&C.terrain.prepareDrawTile(),de.activeTexture.set(_e.TEXTURE0),Se.texture&&Se.texture.bind(Ze,_e.CLAMP_TO_EDGE),de.activeTexture.set(_e.TEXTURE1),Je?(Je.texture&&Je.texture.bind(Ze,_e.CLAMP_TO_EDGE),tt=Math.pow(2,Je.tileID.overscaledZ-Se.tileID.overscaledZ),rt=[Se.tileID.canonical.x*tt%1,Se.tileID.canonical.y*tt%1]):Se.texture&&Se.texture.bind(Ze,_e.CLAMP_TO_EDGE),Se.texture&&Se.texture.useMipmap&&de.extTextureFilterAnisotropic&&C.transform.pitch>20&&_e.texParameterf(_e.TEXTURE_2D,de.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,de.extTextureFilterAnisotropicMax);const ot=C.transform,st=ye instanceof Jb?ye.perspectiveTransform:[0,0],at=je?sA(ot):[0,0,0,0];let lt,ct,ht,dt,mt,_t;if(We&&ye instanceof Jb&&ye.coordinates.length>3){lt=Float32Array.from(Ad(fd(new ju(0,0,0)))),ct=Float32Array.from(ot.globeMatrix),ht=Float32Array.from(Pd(ot)),dt=[Kd(ot.center.lng),Jd(ot.center.lat)],_t=[Kd(ye.coordinates[1][0]),Jd(ye.coordinates[1][1]),Kd(ye.coordinates[3][0]),Jd(ye.coordinates[3][1])];const te=new sc(ye.coordinates[1],ye.coordinates[3]);mt=Float32Array.from(kd(new ju(0,0,0),te,0,ot.worldSize/C.transform._pixelsPerMercatorPixel))}else lt=new Float32Array(16),ct=new Float32Array(9),ht=new Float32Array(16),dt=[0,0],mt=new Float32Array(16),_t=[0,0,0,0];const gt=CM($e,lt,ct,ht,mt,rt||[0,0],_t,Dd(C.transform.zoom),dt,at,tt||1,Qe,le,st,je?le.paint.get("raster-elevation"):0,2,ve.mix,ve.offset,ve.range,1,0,Ce),Pt=C.isTileAffectedByFog(ce),Ft=C.getOrCreateProgram("raster",{defines:ve.defines,overrideFog:Pt});if(C.uploadCommonUniforms(de,Ft,he),ye instanceof Jb){if(Ne||!Me)ye.boundsBuffer&&ye.boundsSegments&&Ft.draw(C,_e.TRIANGLES,Ae,Sx.disabled,Oe,Dx.disabled,gt,le.id,ye.boundsBuffer,C.quadTriangleIndexBuffer,ye.boundsSegments);else if(C.globeSharedBuffers){const[te,ce,he]=C.globeSharedBuffers.getGridBuffers(0,!1);Ft.draw(C,_e.TRIANGLES,Ae,Sx.disabled,Oe,Dx.frontCCW,gt,le.id,te,ce,he),Ft.draw(C,_e.TRIANGLES,Ae,Sx.disabled,Oe,Dx.backCCW,gt,le.id,te,ce,he)}}else{const{tileBoundsBuffer:te,tileBoundsIndexBuffer:ce,tileBoundsSegments:he}=C.getTileBoundsBuffers(Se);Ft.draw(C,_e.TRIANGLES,Ae,Xe,Oe,Dx.disabled,gt,le.id,te,ce,he)}}C.resetStencilClippingMasks()},background:function(C,te,le,ce){const he=le.paint.get("background-color"),ue=le.paint.get("background-opacity"),de=le.paint.get("background-emissive-strength");if(0===ue)return;const _e=C.context,ye=_e.gl,ve=C.transform,Se=ve.tileSize,Me=le.paint.get("background-pattern");if(C.isPatternMissing(Me,le.scope))return;const Ae=!Me&&1===he.a&&1===ue&&C.opaquePassEnabledForLayer()?"opaque":"translucent";if(C.renderPass!==Ae)return;const Ce=Sx.disabled,Oe=C.depthModeForSublayer(0,"opaque"===Ae?Mx.ReadWrite:Mx.ReadOnly),Ne=C.colorModeForDrapableLayerRenderPass(de),je=Me?"backgroundPattern":"background";let Ge,Ze=ce;Ze||(Ge=C.getBackgroundTiles(),Ze=Object.values(Ge).map((C=>C.tileID))),Me&&(_e.activeTexture.set(ye.TEXTURE0),C.imageManager.bind(C.context,le.scope));for(const Ae of Ze){const Ze=C.isTileAffectedByFog(Ae),qe=C.getOrCreateProgram(je,{overrideFog:Ze}),$e=Ae.toUnwrapped(),He=ce?Ae.projMatrix:C.transform.calculateProjMatrix($e);C.prepareDrawTile();const We=te?te.getTile(Ae):Ge?Ge[Ae.key]:new Oy(Ae,Se,ve.zoom,C),Xe=Me?FM(He,de,ue,C,Me,le.scope,{tileID:Ae,tileSize:Se}):BM(He,de,ue,he);C.uploadCommonUniforms(_e,qe,$e);const{tileBoundsBuffer:Ye,tileBoundsIndexBuffer:Je,tileBoundsSegments:Qe}=C.getTileBoundsBuffers(We);qe.draw(C,ye.TRIANGLES,Oe,Ce,Ne,Dx.disabled,Xe,le.id,Ye,Je,Qe)}},sky:function(C,te,le){const ce=C._atmosphere?Dd(C.transform.zoom):1,he=le.paint.get("sky-opacity")*ce;if(0===he)return;const ue=C.context,de=le.paint.get("sky-type"),_e=new Mx(ue.gl.LEQUAL,Mx.ReadOnly,[0,1]),ye=C.frameCounter/1e3%1;"atmosphere"===de?"offscreen"===C.renderPass?le.needsSkyboxCapture(C)&&(function(C,te,le,ce){const he=C.context,ue=he.gl;let de=te.skyboxFbo;if(!de){de=te.skyboxFbo=he.createFramebuffer(32,32,!0,null),te.skyboxGeometry=new xA(he),te.skyboxTexture=he.gl.createTexture(),ue.bindTexture(ue.TEXTURE_CUBE_MAP,te.skyboxTexture),ue.texParameteri(ue.TEXTURE_CUBE_MAP,ue.TEXTURE_WRAP_S,ue.CLAMP_TO_EDGE),ue.texParameteri(ue.TEXTURE_CUBE_MAP,ue.TEXTURE_WRAP_T,ue.CLAMP_TO_EDGE),ue.texParameteri(ue.TEXTURE_CUBE_MAP,ue.TEXTURE_MIN_FILTER,ue.LINEAR),ue.texParameteri(ue.TEXTURE_CUBE_MAP,ue.TEXTURE_MAG_FILTER,ue.LINEAR);for(let C=0;C<6;++C)ue.texImage2D(ue.TEXTURE_CUBE_MAP_POSITIVE_X+C,0,ue.RGBA,32,32,0,ue.RGBA,ue.UNSIGNED_BYTE,null)}he.bindFramebuffer.set(de.framebuffer),he.viewport.set([0,0,32,32]);const _e=te.getCenter(C,!0),ye=C.getOrCreateProgram("skyboxCapture"),ve=new Float64Array(16);ld.identity(ve),ld.rotateY(ve,ve,.5*-Math.PI),vA(C,te,ye,ve,_e,0),ld.identity(ve),ld.rotateY(ve,ve,.5*Math.PI),vA(C,te,ye,ve,_e,1),ld.identity(ve),ld.rotateX(ve,ve,.5*-Math.PI),vA(C,te,ye,ve,_e,2),ld.identity(ve),ld.rotateX(ve,ve,.5*Math.PI),vA(C,te,ye,ve,_e,3),ld.identity(ve),vA(C,te,ye,ve,_e,4),ld.identity(ve),ld.rotateY(ve,ve,Math.PI),vA(C,te,ye,ve,_e,5),he.viewport.set([0,0,C.width,C.height])}(C,le),le.markSkyboxValid(C)):"sky"===C.renderPass&&function(C,te,le,ce,he){const ue=C.context,de=ue.gl,_e=C.transform,ye=C.getOrCreateProgram("skybox");ue.activeTexture.set(de.TEXTURE0),de.bindTexture(de.TEXTURE_CUBE_MAP,te.skyboxTexture);const ve=((C,te,le,ce,he)=>({u_matrix:C,u_sun_direction:te,u_cubemap:0,u_opacity:ce,u_temporal_offset:he}))(_e.skyboxMatrix,te.getCenter(C,!1),0,ce,he);C.uploadCommonUniforms(ue,ye),ye.draw(C,de.TRIANGLES,le,Sx.disabled,C.colorModeForRenderPass(),Dx.backCW,ve,"skybox",te.skyboxGeometry.vertexBuffer,te.skyboxGeometry.indexBuffer,te.skyboxGeometry.segment)}(C,le,_e,he,ye):"gradient"===de&&"sky"===C.renderPass&&function(C,te,le,ce,he){const ue=C.context,de=ue.gl,_e=C.transform,ye=C.getOrCreateProgram("skyboxGradient");te.skyboxGeometry||(te.skyboxGeometry=new xA(ue)),ue.activeTexture.set(de.TEXTURE0);let ve=te.colorRampTexture;ve||(ve=te.colorRampTexture=new My(ue,te.colorRamp,de.RGBA)),ve.bind(de.LINEAR,de.CLAMP_TO_EDGE);const Se=((C,te,le,ce,he)=>({u_matrix:C,u_color_ramp:0,u_center_direction:te,u_radius:w(le),u_opacity:ce,u_temporal_offset:he}))(_e.skyboxMatrix,te.getCenter(C,!1),te.paint.get("sky-gradient-radius"),ce,he);C.uploadCommonUniforms(ue,ye),ye.draw(C,de.TRIANGLES,le,Sx.disabled,C.colorModeForRenderPass(),Dx.backCW,Se,"skyboxGradient",te.skyboxGeometry.vertexBuffer,te.skyboxGeometry.indexBuffer,te.skyboxGeometry.segment)}(C,le,_e,he,ye)},debug:function(C,te,le){for(let ce=0;ce<le.length;ce++)dA(C,te,le[ce])},custom:function(C,te,le,ce){const he=C.context,ue=le.implementation;if(!C.transform.projection.unsupportedLayers||!C.transform.projection.unsupportedLayers.includes("custom")||C.terrain&&(C.terrain.renderingToTexture||"offscreen"===C.renderPass)&&le.isLayerDraped(te)){if("offscreen"===C.renderPass){const te=ue.prerender;if(te){if(C.setCustomLayerDefaults(),he.setColorMode(C.colorModeForRenderPass()),"globe"===C.transform.projection.name){const le=C.transform.pointMerc;te.call(ue,he.gl,C.transform.customLayerMatrix(),C.transform.getProjection(),C.transform.globeToMercatorMatrix(),Dd(C.transform.zoom),[le.x,le.y],C.transform.pixelsPerMeterRatio)}else te.call(ue,he.gl,C.transform.customLayerMatrix());he.setDirty(),C.setBaseState()}}else if("translucent"===C.renderPass){if(C.terrain&&C.terrain.renderingToTexture){const te=ue.renderToTile;if(te){const le=ce[0].canonical,de=new lp(le.x+ce[0].wrap*(1<<le.z),le.y,le.z);he.setDepthMode(Mx.disabled),he.setStencilMode(Sx.disabled),he.setColorMode(C.colorModeForRenderPass()),C.setCustomLayerDefaults(),te.call(ue,he.gl,de),he.setDirty(),C.setBaseState()}return}C.setCustomLayerDefaults(),he.setColorMode(C.colorModeForRenderPass()),he.setStencilMode(Sx.disabled);const te="3d"===ue.renderingMode?new Mx(C.context.gl.LEQUAL,Mx.ReadWrite,C.depthRangeFor3D):C.depthModeForSublayer(0,Mx.ReadOnly);if(he.setDepthMode(te),"globe"===C.transform.projection.name){const te=C.transform.pointMerc;ue.render(he.gl,C.transform.customLayerMatrix(),C.transform.getProjection(),C.transform.globeToMercatorMatrix(),Dd(C.transform.zoom),[te.x,te.y],C.transform.pixelsPerMeterRatio)}else ue.render(he.gl,C.transform.customLayerMatrix());he.setDirty(),C.setBaseState(),he.bindFramebuffer.set(null)}}else H("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(C,te,le,ce){if("opaque"===C.renderPass)return;const he=le.paint.get("model-opacity");if(0===he)return;const ue=le.paint.get("model-cast-shadows");if("shadow"===C.renderPass){if(!ue)return;if(C.terrain&&he<.65&&le._transitionablePaint._values["model-opacity"].value.expression instanceof Ao)return}const de=C.shadowRenderer,_e=le.paint.get("model-receive-shadows");de&&(de.useNormalOffset=!0,_e||(de.enabled=!1));const l=()=>{de&&(de.useNormalOffset=!0,_e||(de.enabled=!0))},ye=te.getSource();if("light-beam"===C.renderPass&&"batched-model"!==ye.type)return;if("vector"===ye.type||"geojson"===ye.type)return function(C,te,le,ce){const he=C.transform;if("mercator"!==he.projection.name)return void H(`Drawing 3D models for ${he.projection.name} projection is not yet implemented`);const ue=he.getFreeCameraOptions().position;if(!C.modelManager)return;const de=C.modelManager,_e=C.shadowRenderer;if(!le._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const ye=le._unevaluatedLayout._values["model-id"],ve={...le.layout.get("model-id").parameters};for(const Se of ce){const ce=te.getTile(Se).getBucket(le);if(!ce||ce.projection.name!==he.projection.name)continue;const Me=DA(Se,he);ve.zoom=Me;const Ae=ye.possiblyEvaluate(ve);if(zA(C,ce,Se),dI.shadowUniformsInitialized=!1,dI.useSingleShadowCascade=!!_e&&0===_e.getMaxCascadeForTile(Se.toUnwrapped()),"shadow"===C.renderPass&&_e){if(1===C.currentShadowCascade&&ce.isInsideFirstShadowMapFrustum)continue;const te=he.calculatePosMatrix(Se.toUnwrapped(),he.worldSize);if(dI.tileMatrix.set(te),dI.shadowTileMatrix=Float32Array.from(_e.calculateShadowPassMatrixFromMatrix(te)),dI.aabb.min.fill(0),dI.aabb.max[0]=dI.aabb.max[1]=Mn,dI.aabb.max[2]=0,kA(ce,dI,C,le.scope))continue}const Ce=1<<Se.canonical.z,Oe=[((ue.x-Se.wrap)*Ce-Se.canonical.x)*Mn,(ue.y*Ce-Se.canonical.y)*Mn,ue.z*Ce*Mn];for(let te in ce.instancesPerModel){const he=ce.instancesPerModel[te];he.features.length>0&&(te=Ae.evaluate(he.features[0].feature,{}));const ue=de.getModel(te,le.scope);if(ue&&ue.uploaded)for(const te of ue.nodes)RA(C,le,te,he,Oe,Se,dI)}}}(C,te,le,ce),void l();if(!ye.loaded())return;if("batched-model"===ye.type)return function(C,te,le,ce){const he=C.context,ue=C.transform,de=C.style.fog,_e=C.shadowRenderer;if("mercator"!==ue.projection.name)return void H(`Drawing 3D landmark models for ${ue.projection.name} projection is not yet implemented`);const ye=C.transform.getFreeCameraOptions().position,ve=Zd.scale([],[ye.x,ye.y,ye.z],C.transform.worldSize);Zd.negate(ve,ve);const Se=ld.identity([]),Me=op(ue.center.lat,ue.zoom),Ae=ld.fromScaling([],[1,1,1/Me]);ld.translate(Se,Se,ve);const Ce=le.paint.get("model-opacity"),Oe=new Mx(he.gl.LEQUAL,Mx.ReadWrite,C.depthRangeFor3D),Ne=new Mx(he.gl.LEQUAL,Mx.ReadOnly,C.depthRangeFor3D),_=function(ye,ve){for(const Me of ce){const ce=te.getTile(Me).getBucket(le);if(!ce||!ce.uploaded)continue;let je=!1;_e&&(je=0===_e.getMaxCascadeForTile(Me.toUnwrapped()));const Ge=ue.calculatePosMatrix(Me.toUnwrapped(),ue.worldSize),Ze=ce.modelTraits;for(const te of ce.getNodesInfo()){if(te.hiddenByReplacement)continue;if(!te.node.meshes)continue;const ce=te.node,qe="light-beam"===C.renderPass,$e=[...Ge],He=te.evaluatedScale;let We=0;C.terrain&&ce.elevation&&(We=ce.elevation*C.terrain.exaggeration()),ld.translate($e,$e,[(ce.anchor?ce.anchor[0]:0)*(He[0]-1),(ce.anchor?ce.anchor[1]:0)*(He[1]-1),We]),He!==Yb&&ld.scale($e,$e,He),ld.multiply($e,$e,ce.matrix);const Xe=ld.multiply([],Ae,$e);ld.multiply(Xe,Se,Xe);const Ye=ld.invert([],Xe);ld.transpose(Ye,Ye),ld.scale(Ye,Ye,pI);const Je=ld.multiply([],ue.expandedFarZProjMatrix,$e);for(let Se=0;Se<ce.meshes.length;++Se){const Ae=ce.meshes[Se],Ge=Se===ce.lightMeshIndex;if(Ge){if(!qe&&!C.terrain&&C.shadowRenderer){C.currentLayer<C.firstLightBeamLayer&&(C.firstLightBeamLayer=C.currentLayer);continue}}else if(qe)continue;const He={defines:[]},We=[];AA(He.defines,We,Ae,C),4&Ze||He.defines.push("DIFFUSE_SHADED"),je&&He.defines.push("SHADOWS_SINGLE_CASCADE");const Qe="shadow"===C.renderPass;if(Qe){CA(Ae,$e,C,le);continue}let tt=null;if(de){const te=MA($e,C.transform);if(tt=new Float32Array(te),"globe"!==ue.projection.name){const C=Ae.aabb.min,le=Ae.aabb.max,[ce,he]=de.getOpacityForBounds(te,C[0],C[1],le[0],le[1]);He.overrideFog=ce>=$T||he>=$T}}const rt=C.getOrCreateProgram("model",He);!Qe&&_e&&(_e.useNormalOffset=!!Ae.normalBuffer,_e.setupShadowsFromMatrix($e,rt,_e.useNormalOffset)),C.uploadCommonUniforms(he,rt,Me.toUnwrapped(),tt);const ot=Ae.material,st=ot.pbrMetallicRoughness;st.metallicFactor=.9,st.roughnessFactor=.5;const at=0,lt=UM(new Float32Array(Je),new Float32Array(Xe),new Float32Array(Ye),C,Ce,st.baseColorFactor,ot.emissiveFactor,st.metallicFactor,st.roughnessFactor,ot,at,le);rt.draw(C,he.gl.TRIANGLES,ve&&!Ge?Oe:Ne,Sx.disabled,ye?Ge||Ce<1||te.hasTranslucentParts?Cx.alphaBlended:Cx.unblended:Cx.disabled,Dx.backCCW,lt,le.id,Ae.vertexBuffer,Ae.indexBuffer,Ae.segments,le.paint,C.transform.zoom,void 0,We)}}}};(function(C,te,le,ce){const he=C.terrain?C.terrain.exaggeration():0,ue=C.transform.zoom;for(const de of ce){const ce=te.getTile(de).getBucket(le);ce&&(C.conflationActive&&ce.updateReplacement(de,C.replacementSource),ce.evaluateScale(C,le),C.terrain&&he>0&&ce.elevationUpdate(C.terrain,he,de,le.source),ce.needsReEvaluation(C,ue,le)&&ce.evaluate(le))}})(C,te,le,ce),1===Ce?_(!0,!0):(_(!1,!0),_(!0,!1))}(C,te,le,ce),void l();const ve=ye.getModels(),Se=[],Me=C.transform.getFreeCameraOptions().position,Ae=Zd.scale([],[Me.x,Me.y,Me.z],C.transform.worldSize);Zd.negate(Ae,Ae);const Ce=[],Oe=[];let Ne=0;for(const te of ve){const ce=le.paint.get("model-rotation").constantOr(null),he=le.paint.get("model-scale").constantOr(null),ue=le.paint.get("model-translation").constantOr(null);te.computeModelMatrix(C,ce,he,ue,!0,!0,!1);const de=ld.identity([]),_e=op(te.position.lat,C.transform.zoom),ye=ld.fromScaling([],[1,1,1/_e]);ld.translate(de,de,Ae),Se.push({zScaleMatrix:ye,negCameraPosMatrix:de});for(const le of te.nodes)IA(C.transform,le,te.matrix,C.transform.expandedFarZProjMatrix,Ne,Ce,Oe);Ne++}if(Ce.sort(((C,te)=>te.depth-C.depth)),"shadow"!==C.renderPass){if(1===he)for(const te of Oe)SA(te,C,le,Se[te.modelIndex],Sx.disabled,C.colorModeForRenderPass());else{for(const te of Oe)SA(te,C,le,Se[te.modelIndex],Sx.disabled,Cx.disabled);for(const te of Oe)SA(te,C,le,Se[te.modelIndex],C.stencilModeFor3D(),C.colorModeForRenderPass());C.resetStencilClippingMasks()}for(const te of Ce)SA(te,C,le,Se[te.modelIndex],Sx.disabled,C.colorModeForRenderPass());l()}else{for(const te of Oe)CA(te.mesh,te.nodeModelMatrix,C,le);for(const te of Ce)CA(te.mesh,te.nodeModelMatrix,C,le);l()}}},_I={modelUpload:function(C,te,le){const ce=te.getSource();if(!ce.loaded())return;if("vector"===ce.type||"geojson"===ce.type)return void(C.modelManager&&C.modelManager.upload(C,le));if("batched-model"===ce.type)return;const he=ce.getModels();for(const te of he)te.upload(C.context)}};class UA{constructor(C,te,le){this.context=new Rx(C,te),this.transform=le,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.setup(),this.numSublayers=Lx.maxUnderzooming+Lx.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new Xv,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new qA(this),this._wireframeDebugCache=new BA,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0}updateTerrain(C,te){const le=!!C&&!!C.terrain&&this.transform.projection.supportsTerrain;if(!(le||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new uM(this,C));const ce=this._terrain;this.transform.elevation=le?ce:null,ce.update(C,this.transform,te),this.transform.elevation&&!ce.enabled&&(this.transform.elevation=null)}_updateFog(C){const te=C.fog;if(!te||"globe"===this.transform.projection.name||te.getOpacity(this.transform.pitch)<1||te.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[le,ce]=te.getFovAdjustedRange(this.transform._fov);if(le>ce)return void(this.transform.fogCullDistSq=null);const he=le+.78*(ce-le);this.transform.fogCullDistSq=he*he}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled?this._terrain:null}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(C,te){if(this.width=C*bi.devicePixelRatio,this.height=te*bi.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const C of this.style.order)this.style._mergedLayers[C].resize()}setup(){const C=this.context,te=new za;te.emplaceBack(0,0),te.emplaceBack(Mn,0),te.emplaceBack(0,Mn),te.emplaceBack(Mn,Mn),this.tileExtentBuffer=C.createVertexBuffer(te,rp.members),this.tileExtentSegments=xl.simpleSegment(0,0,4,2);const ce=new za;ce.emplaceBack(0,0),ce.emplaceBack(Mn,0),ce.emplaceBack(0,Mn),ce.emplaceBack(Mn,Mn),this.debugBuffer=C.createVertexBuffer(ce,rp.members),this.debugSegments=xl.simpleSegment(0,0,4,5);const he=new za;he.emplaceBack(-1,-1),he.emplaceBack(1,-1),he.emplaceBack(-1,1),he.emplaceBack(1,1),this.viewportBuffer=C.createVertexBuffer(he,rp.members),this.viewportSegments=xl.simpleSegment(0,0,4,2);const ue=new Da;ue.emplaceBack(0,0,0,0),ue.emplaceBack(Mn,0,Mn,0),ue.emplaceBack(0,Mn,0,Mn),ue.emplaceBack(Mn,Mn,Mn,Mn),this.mercatorBoundsBuffer=C.createVertexBuffer(ue,Uv.members),this.mercatorBoundsSegments=xl.simpleSegment(0,0,4,2);const de=new Wa;de.emplaceBack(0,1,2),de.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=C.createIndexBuffer(de);const _e=new el;for(const C of[0,1,3,2,0])_e.emplaceBack(C);this.debugIndexBuffer=C.createIndexBuffer(_e),this.emptyTexture=new My(C,new ef({width:1,height:1},Uint8Array.of(0,0,0,0)),C.gl.RGBA),this.identityMat=ld.create();const ye=this.context.gl;this.stencilClearMode=new Sx({func:ye.ALWAYS,mask:0},0,255,ye.ZERO,ye.ZERO,ye.ZERO),this.loadTimeStamps.push(le.performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(C){return C._makeTileBoundsBuffers(this.context,this.transform.projection),C._tileBoundsBuffer?{tileBoundsBuffer:C._tileBoundsBuffer,tileBoundsIndexBuffer:C._tileBoundsIndexBuffer,tileBoundsSegments:C._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const C=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,C.TRIANGLES,Mx.disabled,this.stencilClearMode,Cx.disabled,Dx.disabled,sM(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(C,te,le){if(!te||this.currentStencilSource===te.id||!C.isTileClipped()||!le||0===le.length)return;if(this._tileClippingMaskIDs&&!this.terrain){let C=!1;for(const te of le)if(void 0===this._tileClippingMaskIDs[te.key]){C=!0;break}if(!C)return}this.currentStencilSource=te.id;const ce=this.context,he=ce.gl;this.nextStencilID+le.length>256&&this.clearStencil(),ce.setColorMode(Cx.disabled),ce.setDepthMode(Mx.disabled);const ue=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const C of le){const le=te.getTile(C),ce=this._tileClippingMaskIDs[C.key]=this.nextStencilID++,{tileBoundsBuffer:de,tileBoundsIndexBuffer:_e,tileBoundsSegments:ye}=this.getTileBoundsBuffers(le);ue.draw(this,he.TRIANGLES,Mx.disabled,new Sx({func:he.ALWAYS,mask:0},ce,255,he.KEEP,he.KEEP,he.REPLACE),Cx.disabled,Dx.disabled,sM(C.projMatrix),"$clipping",de,_e,ye)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const C=this.nextStencilID++,te=this.context.gl;return new Sx({func:te.NOTEQUAL,mask:255},C,255,te.KEEP,te.KEEP,te.REPLACE)}stencilModeForClipping(C){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(C);const te=this.context.gl;return new Sx({func:te.EQUAL,mask:255},this._tileClippingMaskIDs[C.key],0,te.KEEP,te.KEEP,te.REPLACE)}stencilConfigForOverlap(C){const te=this.context.gl,le=C.sort(((C,te)=>te.overscaledZ-C.overscaledZ)),ce=le[le.length-1].overscaledZ,he=le[0].overscaledZ-ce+1;if(he>1){this.currentStencilSource=void 0,this.nextStencilID+he>256&&this.clearStencil();const C={};for(let le=0;le<he;le++)C[le+ce]=new Sx({func:te.GEQUAL,mask:255},le+this.nextStencilID,255,te.KEEP,te.KEEP,te.REPLACE);return this.nextStencilID+=he,[C,le]}return[{[ce]:Sx.disabled},le]}colorModeForRenderPass(){const C=this.context.gl;if(this._showOverdrawInspector){const te=1/8;return new Cx([C.CONSTANT_COLOR,C.ONE,C.CONSTANT_COLOR,C.ONE],new qr(te,te,te,0),[!0,!0,!0,!0])}return"opaque"===this.renderPass?Cx.unblended:Cx.alphaBlended}colorModeForDrapableLayerRenderPass(C){const te=this.context.gl;return(()=>this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture)()&&"translucent"===this.renderPass?new Cx([te.ONE,te.ONE_MINUS_SRC_ALPHA,te.CONSTANT_ALPHA,te.ONE_MINUS_SRC_ALPHA],new qr(0,0,0,void 0===C?0:C),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(C,te,le,ce=!1){if(!this.opaquePassEnabledForLayer()&&!ce)return Mx.disabled;const he=1-((1+this.currentLayer)*this.numSublayers+C)*this.depthEpsilon;return new Mx(le||this.context.gl.LEQUAL,te,[he,he])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(C,te){this._wireframeDebugCache.update(this.frameCounter),this.style=C,this.options=te;const ce=this.style._mergedLayers,he=this.style.order,ue=he.map((C=>ce[C])),de=this.style._mergedSourceCaches;this.imageManager=C.imageManager,this.modelManager=C.modelManager,this.symbolFadeChange=C.placement.symbolFadeChange(bi.now()),this.imageManager.beginFrame();let _e=0,ye=!1;for(const C in de){const te=de[C];te.used&&(te.prepare(this.context),te.getSource().usedInConflation&&++_e)}const ve={},Se={},Me={},Ae={},Ce={};for(const C in de){const te=de[C];ve[C]=te.getVisibleCoordinates(),Se[C]=ve[C].slice().reverse(),Me[C]=te.getVisibleCoordinates(!0).reverse(),Ae[C]=te.getShadowCasterCoordinates(),Ce[C]=te.sortCoordinatesByDistance(ve[C])}const f=C=>{const te=this.style.getLayerSourceCache(C);return te&&te.used?te.getSource():null};if(_e){const C=[];for(const te of ue)this.layerUsedInConflation(te,f(te))&&C.push(te);if(C&&C.length>1){const te=[];for(const le of C){const C=this.style.getLayerSourceCache(le);C&&C.used&&C.getSource().usedInConflation&&te.push({layer:le.fqid,cache:C})}this.replacementSource.setSources(te),ye=!0}}ye||this.replacementSource.clear(),this.conflationActive=ye,this.minCutoffZoom=0,this.longestCutoffRange=0;for(const C of ue){const te=C.cutoffRange();if(this.longestCutoffRange=Math.max(te,this.longestCutoffRange),te>0){const te=f(C);te&&(this.minCutoffZoom=Math.max(te.minzoom,this.minCutoffZoom)),C.minzoom&&(this.minCutoffZoom=Math.max(C.minzoom,this.minCutoffZoom))}}this.opaquePassCutoff=1/0;for(let C=0;C<ue.length;C++)if(ue[C].is3D()){this.opaquePassCutoff=C;break}const Oe=this.style&&this.style.fog;Oe?(this._fogVisible=0!==Oe.getOpacity(this.transform.pitch),this._fogVisible&&"globe"!==this.transform.projection.name&&(this._fogVisible=Oe.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(Me),this.opaquePassCutoff=0);const Ne=this._shadowRenderer;if(Ne){Ne.updateShadowParameters(this.transform,this.style.directionalLight);for(const C in de)for(const te of ve[C]){let C={min:0,max:0};this.terrain&&(C=this.terrain.getMinMaxForTile(te)||C),Ne.addShadowReceiver(te.toUnwrapped(),C.min,C.max)}}"globe"!==this.transform.projection.name||this.globeSharedBuffers||(this.globeSharedBuffers=new Gd(this.context));for(const te of ue){if(te.isHidden(this.transform.zoom))continue;const le=C.getLayerSourceCache(te);this.uploadLayer(this,te,le)}if(this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new EA),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),!qt.has(this.context.gl))return;this.renderPass="offscreen";for(const te of ue){const le=C.getLayerSourceCache(te);if(!te.hasOffscreenPass()||te.isHidden(this.transform.zoom))continue;const ce=le?Se[le.id]:void 0;("custom"===te.type||"raster"===te.type||te.isSky()||ce&&ce.length)&&this.renderLayer(this,le,te,ce)}this.depthRangeFor3D=[0,1-(ue.length+2)*this.numSublayers*this.depthEpsilon];const je=this.terrain;je&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&!this.transform.isOrthographic&&je.drawDepth(),this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,Ae)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const Ge="globe"===this.transform.projection.name||this.transform.isHorizonVisible(),Ze=(()=>{if(te.showOverdrawInspector)return qr.black;if(this.style.fog&&this.transform.projection.supportsFog&&!Ge){const C=this.style.fog.properties.get("color").toArray01();return new qr(...C)}if(this.style.fog&&this.transform.projection.supportsFog&&Ge){const C=this.style.fog.properties.get("space-color").toArray01();return new qr(...C)}return qr.transparent})();if(this.context.clear({color:Ze,depth:1}),this.clearStencil(),this._showOverdrawInspector=te.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&Ge&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=he.length-1;this.currentLayer>=0;this.currentLayer--){const te=ue[this.currentLayer],le=C.getLayerSourceCache(te);if(te.isSky())continue;const ce=le?(te.is3D()?Ce:Se)[le.id]:void 0;this._renderTileClippingMasks(te,le,ce),this.renderLayer(this,le,te,ce)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&Ge&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||Dd(this.transform.zoom)>0)&&("globe"===this.transform.projection.name||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<he.length;this.currentLayer++){const te=ue[this.currentLayer],le=C.getLayerSourceCache(te);te.isSky()&&this.renderLayer(this,le,te,le?Se[le.id]:void 0)}this.renderPass="translucent",this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let qe=0;for(Ne&&(qe=Ne.getShadowCastingLayerCount());this.currentLayer<he.length;){const te=ue[this.currentLayer],le=C.getLayerSourceCache(te);if(te.isSky()){++this.currentLayer;continue}if(je&&this.style.isLayerDraped(te)){if(te.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=je.renderBatch(this.currentLayer);continue}let ce;if(le&&(ce=("symbol"===te.type?Me:te.is3D()?Ce:Se)[le.id]),this._renderTileClippingMasks(te,le,le?ve[le.id]:void 0),this.renderLayer(this,le,te,ce),!je&&Ne&&qe>0&&te.hasShadowPass()&&0==--qe&&(Ne.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){const te=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=te;this.currentLayer++){const te=ue[this.currentLayer];if(!te.hasLightBeamPass())continue;const le=C.getLayerSourceCache(te);this.renderLayer(this,le,te,le?Se[le.id]:void 0)}this.currentLayer=te,this.renderPass="translucent"}++this.currentLayer}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let te=null;ue.forEach((le=>{const ce=C.getLayerSourceCache(le);ce&&!le.isHidden(this.transform.zoom)&&ce.getVisibleCoordinates().length&&(!te||te.getSource().maxzoom<ce.getSource().maxzoom)&&(te=ce)})),te&&this.options.showTileBoundaries&&fI.debug(this,te,te.getVisibleCoordinates())}this.options.showPadding&&function(C){const te=C.transform.padding;pA(C,C.transform.height-(te.top||0),3,NA),pA(C,te.bottom||0,3,VA),fA(C,te.left||0,3,KA),fA(C,C.transform.width-(te.right||0),3,JA);const le=C.transform.centerPoint;!function(C,te,le,ce){mA(C,te-1,le-10,2,20,ce),mA(C,te-10,le-1,20,2,ce)}(C,le.x,C.transform.height-le.y,QA)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(le.performance.now()),this.saveCanvasCopy()),ye||(this.conflationActive=!1)}uploadLayer(C,te,le){this.gpuTimingStart(te),(!C.transform.projection.unsupportedLayers||!C.transform.projection.unsupportedLayers.includes(te.type)||C.terrain&&"custom"===te.type)&&_I[`${te.type}Upload`]&&_I[`${te.type}Upload`](C,le,te.scope),this.gpuTimingEnd()}renderLayer(C,te,le,ce){le.isHidden(this.transform.zoom)||("background"===le.type||"sky"===le.type||"custom"===le.type||"model"===le.type||"raster"===le.type||ce&&ce.length)&&(this.id=le.id,this.gpuTimingStart(le),(!C.transform.projection.unsupportedLayers||!C.transform.projection.unsupportedLayers.includes(le.type)||C.terrain&&"custom"===le.type)&&fI[le.type](C,te,le,ce,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(C){if(!this.options.gpuTiming)return;const te=this.context.extTimerQuery,le=this.context.gl;let ce=this.gpuTimers[C.id];ce||(ce=this.gpuTimers[C.id]={calls:0,cpuTime:0,query:le.createQuery()}),ce.calls++,le.beginQuery(te.TIME_ELAPSED_EXT,ce.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const C=this.context.extTimerQuery,te=this.context.gl,le=te.createQuery();this.deferredRenderGpuTimeQueries.push(le),te.beginQuery(C.TIME_ELAPSED_EXT,le)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const C=this.gpuTimers;return this.gpuTimers={},C}collectDeferredRenderGpuQueries(){const C=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],C}queryGpuTimers(C){const te={};for(const le in C){const ce=C[le],he=this.context.extTimerQuery,ue=he.getQueryParameter(ce.query,this.context.gl.QUERY_RESULT)/1e6;he.deleteQueryEXT(ce.query),te[le]=ue}return te}queryGpuTimeDeferredRender(C){if(!this.options.gpuTimingDeferredRender)return 0;const te=this.context.extTimerQuery,le=this.context.gl;let ce=0;for(const he of C)ce+=te.getQueryParameter(he,le.QUERY_RESULT)/1e6,te.deleteQueryEXT(he);return ce}translatePosMatrix(C,te,le,ce,he){if(!le[0]&&!le[1])return C;const ue=he?"map"===ce?this.transform.angle:0:"viewport"===ce?-this.transform.angle:0;if(ue){const C=Math.sin(ue),te=Math.cos(ue);le=[le[0]*te-le[1]*C,le[0]*C+le[1]*te]}const de=[he?le[0]:rv(te,le[0],this.transform.zoom),he?le[1]:rv(te,le[1],this.transform.zoom),0],_e=new Float32Array(16);return ld.translate(_e,C,de),_e}saveTileTexture(C){const te=C.size[0],le=this._tileTextures[te];le?le.push(C):this._tileTextures[te]=[C]}getTileTexture(C){const te=this._tileTextures[C];return te&&te.length>0?te.pop():null}isPatternMissing(C,te){return null===C||void 0!==C&&!this.imageManager.getPattern(C.toString(),te)}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture}linearFloatFilteringSupported(){return null!=this.context.extTextureFloatLinear}currentGlobalDefines(C,te,le){const ce=void 0===le?this.terrain&&this.terrain.renderingToTexture:le,he=this.terrain&&0===this.terrain.exaggeration(),ue=[];return this.style&&this.style.enable3dLights()&&("globeRaster"===C||"terrainRaster"===C?(ue.push("LIGHTING_3D_MODE"),ue.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):ce||ue.push("LIGHTING_3D_MODE")),"shadow"===this.renderPass?this._shadowMapDebug||ue.push("DEPTH_TEXTURE"):this.shadowRenderer&&(this.shadowRenderer.useNormalOffset?ue.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"):ue.push("RENDER_SHADOWS","DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(ue.push("TERRAIN"),this.linearFloatFilteringSupported()&&ue.push("TERRAIN_DEM_FLOAT_FORMAT"),he&&ue.push("ZERO_EXAGGERATION")),"globe"===this.transform.projection.name&&ue.push("GLOBE"),!this._fogVisible||ce||void 0!==te&&!te||ue.push("FOG","FOG_DITHERING"),ce&&ue.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&ue.push("OVERDRAW_INSPECTOR"),ue}getOrCreateProgram(C,te){this.cache=this.cache||{};const le=te&&te.defines||[],ce=te&&te.config,he=this.currentGlobalDefines(C,te&&te.overrideFog,te&&te.overrideRtt).concat(le),ue=mM.cacheKey(GE[C],C,he,ce);return this.cache[ue]||(this.cache[ue]=new mM(this.context,C,GE[C],ce,gA[C],he)),this.cache[ue]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const C=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(C.FUNC_ADD)}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=le.document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new My(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(C,te){if(this.style.enable3dLights()){const le=this.style.directionalLight,ce=this.style.ambientLight;if(le&&ce){const he=((C,te)=>{const le=C.properties.get("direction"),ce=C.properties.get("color").toArray01(),he=C.properties.get("intensity"),ue=te.properties.get("color").toArray01(),de=te.properties.get("intensity"),_e=[le.x,le.y,le.z],ye=se(ue,de),ve=se(ce,he);return{u_lighting_ambient_color:ye,u_lighting_directional_dir:_e,u_lighting_directional_color:ve,u_ground_radiance:dM(_e,ve,ye)}})(le,ce);te.setLightsUniformValues(C,he)}}}uploadCommonUniforms(C,te,le,ce,he){if(this.uploadCommonLightUniforms(C,te),this.terrain&&this.terrain.renderingToTexture)return;const ue=this.style.fog;if(ue){const he=ue.getOpacity(this.transform.pitch),de=((C,te,le,ce,he,ue,de,_e,ye,ve,Se,Me)=>{const Ae=C.transform,Ce=te.properties.get("color").toArray01();Ce[3]=ce;const Oe=C.frameCounter/1e3%1,[Ne,je]=te.properties.get("vertical-range");return{u_fog_matrix:le?Ae.calculateFogTileMatrix(le):Me||C.identityMat,u_fog_range:te.getFovAdjustedRange(Ae._fov),u_fog_color:Ce,u_fog_horizon_blend:te.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(Ne,je),je],u_fog_temporal_offset:Oe,u_frustum_tl:he,u_frustum_tr:ue,u_frustum_br:de,u_frustum_bl:_e,u_globe_pos:ye,u_globe_radius:ve,u_viewport:Se,u_globe_transition:Dd(Ae.zoom),u_is_globe:+("globe"===Ae.projection.name)}})(this,ue,le,he,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*bi.devicePixelRatio,this.transform.height*bi.devicePixelRatio],ce);te.setFogUniformValues(C,de)}he&&te.setCutoffUniformValues(C,he.uniformValues)}setTileLoadedFlag(C){this.tileLoaded=C}saveCanvasCopy(){const C=this.canvasCopy();C&&(this.frameCopies.push(C),this.tileLoaded=!1)}canvasCopy(){const C=this.context.gl,te=C.createTexture();return C.bindTexture(C.TEXTURE_2D,te),C.copyTexImage2D(C.TEXTURE_2D,0,C.RGBA,0,0,C.drawingBufferWidth,C.drawingBufferHeight,0),te}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const C=this.style&&this.style.fog;return!!C&&0!==C.getOpacity(this.transform.pitch)}getBackgroundTiles(){const C=this._backgroundTiles,te=this._backgroundTiles={},le=this.transform.coveringTiles({tileSize:512});for(const ce of le)te[ce.key]=C[ce.key]||new Oy(ce,512,this.transform.tileZoom,this);return te}clearBackgroundTiles(){this._backgroundTiles={}}layerUsedInConflation(C,te){return!(!C.is3D()||C.minzoom&&C.minzoom>this.transform.zoom||"building"!==C.sourceLayer&&(!te||"batched-model"!==te.type))}isTileAffectedByFog(C){if(!this.style||!this.style.fog)return!1;if("globe"===this.transform.projection.name)return!0;let te=this._cachedTileFogOpacities[C.key];return te||(this._cachedTileFogOpacities[C.key]=te=this.style.fog.getOpacityForTile(C)),te[0]>=$T||te[1]>=$T}}const gI=2048;class jA{constructor(C,te){this.aabb=C,this.lastCascade=te}}class GA{add(C,te){const le=this.receivers[C.key];void 0!==le?(le.aabb.min[0]=Math.min(le.aabb.min[0],te.min[0]),le.aabb.min[1]=Math.min(le.aabb.min[1],te.min[1]),le.aabb.min[2]=Math.min(le.aabb.min[2],te.min[2]),le.aabb.max[0]=Math.max(le.aabb.max[0],te.max[0]),le.aabb.max[1]=Math.max(le.aabb.max[1],te.max[1]),le.aabb.max[2]=Math.max(le.aabb.max[2],te.max[2])):this.receivers[C.key]=new jA(te,null)}clear(){this.receivers={}}get(C){return this.receivers[C.key]}computeRequiredCascades(C,te,le){const ce=ed.fromPoints(C.points);let he=0;for(const C in this.receivers){const ue=this.receivers[C];if(!ue)continue;if(!ce.intersectsAabb(ue.aabb))continue;ue.aabb.min=ce.closestPoint(ue.aabb.min),ue.aabb.max=ce.closestPoint(ue.aabb.max);const de=ue.aabb.getCorners();for(let C=0;C<le.length;C++){let ce=!0;for(const he of de){const ue=[he[0]*te,he[1]*te,he[2]];if(Zd.transformMat4(ue,ue,le[C].matrix),ue[0]<-1||ue[0]>1||ue[1]<-1||ue[1]>1){ce=!1;break}}if(ue.lastCascade=C,he=Math.max(he,C),ce)break}}return he+1}}class qA{constructor(C){this.painter=C,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new GA,this._depthMode=new Mx(C.context.gl.LEQUAL,Mx.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this.useNormalOffset=!1}destroy(){for(const C of this._cascades)C.texture.destroy(),C.framebuffer.destroy();this._cascades=[]}updateShadowParameters(C,te){const le=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!te||!te.properties)return;const ce=te.properties.get("shadow-intensity");if(!te.shadowsEnabled()||ce<=0)return;if(this._shadowLayerCount=le.style.order.reduce(((te,ce)=>{const he=le.style._mergedLayers[ce];return te+(he.hasShadowPass()&&!he.isHidden(C.zoom)?1:0)}),0),this._enabled=this._shadowLayerCount>0,!this._enabled)return;const he=le.context,ue=gI,de=gI;if(0===this._cascades.length)for(let C=0;C<2;++C){const C=le._shadowMapDebug,te=he.gl,ce=he.createFramebuffer(ue,de,C,"texture"),_e=new My(he,{width:ue,height:de,data:null},te.DEPTH_COMPONENT);if(ce.depthAttachment.set(_e.texture),C){const C=new My(he,{width:ue,height:de,data:null},te.RGBA);ce.colorAttachment.set(C.texture)}this._cascades.push({framebuffer:ce,texture:_e,matrix:[],far:0,boundingSphereRadius:0,frustum:new Qu,scale:0})}this.shadowDirection=$A(te);let _e=0;if(C.elevation){const te=C.elevation,le=[1e4,-1e4];te.visibleDemTiles.filter((C=>C.dem)).forEach((C=>{const te=C.dem.tree;le[0]=Math.min(le[0],te.minimums[0]),le[1]=Math.max(le[1],te.maximums[0])})),1e4!==le[0]&&(_e=(le[1]-le[0])*te.exaggeration())}const ye=1.5*C.cameraToCenterDistance,ve=3*ye,Se=new Float64Array(16);for(let te=0;te<2;++te){const le=this._cascades[te];let ce=C.height/50,he=1;0===te?he=ye:(ce=ye,he=ve);const[ue,de]=HA(C,this.shadowDirection,ce,he,gI,_e);le.scale=C.scale,le.matrix=ue,le.boundingSphereRadius=de,ld.invert(Se,le.matrix),le.frustum=Qu.fromInvProjectionMatrix(Se,1,0,!0),le.far=he}this._uniformValues.u_fade_range=[.75*this._cascades[1].far,this._cascades[1].far],this._uniformValues.u_shadow_intensity=ce,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=.00048828125,this._uniformValues.u_shadow_map_resolution=gI,this._uniformValues.u_shadowmap_0=uA.ShadowMap0,this._uniformValues.u_shadowmap_1=uA.ShadowMap0+1,this._groundShadowTiles=le.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const Me=le.transform.elevation;for(const C of this._groundShadowTiles){let te={min:0,max:0};if(Me){const le=Me.getMinMaxForTile(C);le&&(te=le)}this.addShadowReceiver(C.toUnwrapped(),te.min,te.max)}}get enabled(){return this._enabled}set enabled(C){this._enabled=C}drawShadowPass(C,te){if(!this._enabled)return;const le=this.painter,ce=le.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(le.transform.getFrustum(0),le.transform.worldSize,this._cascades),ce.viewport.set([0,0,gI,gI]);for(let he=0;he<this._numCascadesToRender;++he){le.currentShadowCascade=he,ce.bindFramebuffer.set(this._cascades[he].framebuffer.framebuffer),ce.clear({color:qr.white,depth:1});for(const ce of C.order){const he=C._mergedLayers[ce];if(!he.hasShadowPass()||he.isHidden(le.transform.zoom))continue;const ue=C.getLayerSourceCache(he),de=ue?te[ue.id]:void 0;("model"===he.type||de&&de.length)&&le.renderLayer(le,ue,he,de)}}le.currentShadowCascade=0}drawGroundShadows(){if(!this._enabled)return;const C=this.painter,te=C.style,le=C.context,ce=te.directionalLight,he=te.ambientLight;if(!ce||!he)return;const ue=[],de=eM(C,C.longestCutoffRange);de.shouldRenderCutoff&&ue.push("RENDER_CUTOFF");const _e=WA(ce,he),ye=new Mx(le.gl.LEQUAL,Mx.ReadOnly,C.depthRangeFor3D);for(const te of this._groundShadowTiles){const ce=te.toUnwrapped(),he=C.isTileAffectedByFog(te),ve=C.getOrCreateProgram("groundShadow",{defines:ue,overrideFog:he});this.setupShadows(ce,ve),C.uploadCommonUniforms(le,ve,ce,null,de);const Se={u_matrix:C.transform.calculateProjMatrix(ce),u_ground_shadow_factor:_e};ve.draw(C,le.gl.TRIANGLES,ye,Sx.disabled,Cx.multiply,Dx.disabled,Se,"ground_shadow",C.tileExtentBuffer,C.quadTriangleIndexBuffer,C.tileExtentSegments,{},C.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?Cx.unblended:Cx.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(C){const te=this.painter.transform,le=te.calculatePosMatrix(C,te.worldSize);return ld.multiply(le,this._cascades[this.painter.currentShadowCascade].matrix,le),Float32Array.from(le)}calculateShadowPassMatrixFromMatrix(C){return ld.multiply(C,this._cascades[this.painter.currentShadowCascade].matrix,C),Float32Array.from(C)}setupShadows(C,te,le,ce=0){if(!this._enabled)return;const he=this.painter.transform,ue=this.painter.context,de=ue.gl,_e=this._uniformValues,ye=new Float64Array(16),ve=he.calculatePosMatrix(C,he.worldSize);for(let C=0;C<2;C++)ld.multiply(ye,this._cascades[C].matrix,ve),_e[0===C?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(ye),ue.activeTexture.set(de.TEXTURE0+uA.ShadowMap0+C),this._cascades[C].texture.bind(de.NEAREST,de.CLAMP_TO_EDGE);if(this.useNormalOffset=!!le,this.useNormalOffset){const te=ap(C.canonical),ue=2/he.tileSize*Mn/gI,de=ue*this._cascades[0].boundingSphereRadius,ye=ue*this._cascades[1].boundingSphereRadius,ve=("vector-tile"===le?1:3)/Math.pow(2,ce-C.canonical.z-(1-he.zoom+Math.floor(he.zoom)));_e.u_shadow_normal_offset=[te,de*ve,ye*ve],_e.u_shadow_bias=[6e-5,.0012,.012]}else _e.u_shadow_bias=[36e-5,.0012,.012];te.setShadowUniformValues(ue,_e)}setupShadowsFromMatrix(C,te,le=!1){if(!this._enabled)return;const ce=this.painter.context,he=ce.gl,ue=this._uniformValues,de=new Float64Array(16);for(let te=0;te<2;te++)ld.multiply(de,this._cascades[te].matrix,C),ue[0===te?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(de),ce.activeTexture.set(he.TEXTURE0+uA.ShadowMap0+te),this._cascades[te].texture.bind(he.NEAREST,he.CLAMP_TO_EDGE);if(this.useNormalOffset=le,le){const C=5;ue.u_shadow_normal_offset=[1,C,C],ue.u_shadow_bias=[6e-5,.0012,.012]}else ue.u_shadow_bias=[36e-5,.0012,.012];te.setShadowUniformValues(ce,ue)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(C,te,le,ce){if(ce[2]>=0)return{};const he=function(C,te,le){const ce=le/(1<<C.canonical.z);return new ed([C.canonical.x*ce+C.wrap*le,C.canonical.y*ce+C.wrap*le,0],[(C.canonical.x+1)*ce+C.wrap*le,(C.canonical.y+1)*ce+C.wrap*le,te])}(C,te,le).getCorners(),ue=te/-ce[2];ce[0]<0?(Zd.add(he[0],he[0],[ce[0]*ue,0,0]),Zd.add(he[3],he[3],[ce[0]*ue,0,0])):ce[0]>0&&(Zd.add(he[1],he[1],[ce[0]*ue,0,0]),Zd.add(he[2],he[2],[ce[0]*ue,0,0])),ce[1]<0?(Zd.add(he[0],he[0],[0,ce[1]*ue,0]),Zd.add(he[1],he[1],[0,ce[1]*ue,0])):ce[1]>0&&(Zd.add(he[2],he[2],[0,ce[1]*ue,0]),Zd.add(he[3],he[3],[0,ce[1]*ue,0]));const de={};return de.vertices=he,de.planes=[ZA(he[1],he[0],he[4]),ZA(he[2],he[1],he[5]),ZA(he[3],he[2],he[6]),ZA(he[0],he[3],he[7])],de}addShadowReceiver(C,te,le){this._receivers.add(C,ed.fromTileIdAndHeight(C,te,le))}getMaxCascadeForTile(C){const te=this._receivers.get(C);return te&&te.lastCascade?te.lastCascade:0}}function ZA(C,te,le){const ce=Zd.sub([],le,te),he=Zd.sub([],C,te),ue=Zd.cross([],ce,he),de=Zd.length(ue);return 0===de?[0,0,1,0]:(Zd.scale(ue,ue,1/de),[ue[0],ue[1],ue[2],-Zd.dot(ue,te)])}function $A(C){const te=C.properties.get("direction"),le=J(te.x,te.y,te.z);le[2]=z(le[2],0,75);const ce=K([le[0],le[1],le[2]]);return Zd.fromValues(ce.x,ce.y,ce.z)}function WA(C,te){const le=C.properties.get("color"),ce=C.properties.get("intensity"),he=C.properties.get("direction"),ue=[he.x,he.y,he.z],de=te.properties.get("color"),_e=te.properties.get("intensity"),ye=Math.max(Zd.dot([0,0,1],ue),0),ve=[0,0,0];Zd.scale(ve,de.toArray01Linear().slice(0,3),_e);const Se=[0,0,0];return Zd.scale(Se,le.toArray01Linear().slice(0,3),ye*ce),ae([ve[0]>0?ve[0]/(ve[0]+Se[0]):0,ve[1]>0?ve[1]/(ve[1]+Se[1]):0,ve[2]>0?ve[2]/(ve[2]+Se[2]):0])}function HA(C,te,le,ce,he,ue){const de=C.zoom,_e=C.scale,ye=C.worldSize,ve=1/ye,Se=C.aspect,Me=Math.sqrt(1+Se*Se)*Math.tan(.5*C.fovX),Ae=Me*Me,Ce=ce-le,Oe=ce+le;let Ne,je;Ae>Ce/Oe?(Ne=ce,je=ce*Me):(Ne=.5*Oe*(1+Ae),je=.5*Math.sqrt(Ce*Ce+2*(ce*ce+le*le)*Ae+Oe*Oe*Ae*Ae));const Ge=C.projection.pixelsPerMeter(C.center.lat,ye),Ze=C._camera.getCameraToWorldMercator(),qe=[0,0,-Ne*ve];Zd.transformMat4(qe,qe,Ze);let $e=je*ve;const He=C._edgeInsets;if(!(0===He.left&&0===He.top&&0===He.right&&0===He.bottom||He.left===He.right&&He.top===He.bottom)){const te=C._camera.getWorldToCamera(C.worldSize,"meters"===C.projection.zAxisUnit?Ge:1),he=C._camera.getCameraToClipPerspective(C._fov,C.width/C.height,le,ce);he[8]=2*-C.centerOffset.x/C.width,he[9]=2*C.centerOffset.y/C.height;const ue=new Float64Array(16);ld.mul(ue,he,te);const ve=new Float64Array(16);ld.invert(ve,ue);const Se=Qu.fromInvProjectionMatrix(ve,ye,de,!0);for(const te of Se.points){const le=((We=te)[0]/=_e,We[1]/=_e,We[2]=Qd(We[2],C._center.lat),We);$e=Math.max($e,Zd.len(Zd.subtract([],qe,le)))}}var We;$e*=he/(he-1);const Xe=Math.acos(te[2]),Ye=Math.atan2(-te[0],-te[1]),Je=new Yx;Je.position=qe,Je.setPitchBearing(Xe,Ye);const Qe=Je.getWorldToCamera(ye,Ge),tt=$e*ye,rt=Math.min(C._mercatorZfromZoom(17)*ye*-2,-2*tt),ot=Je.getCameraToClipOrthographic(-tt,tt,-tt,tt,rt,(tt+ue*Ge)/te[2]),st=new Float64Array(16);ld.multiply(st,ot,Qe);const at=Zd.fromValues(Math.floor(1e6*qe[0])/1e6*ye,Math.floor(1e6*qe[1])/1e6*ye,0),lt=.5*he,ct=[0,0,0];Zd.transformMat4(ct,at,st),Zd.scale(ct,ct,lt);const ht=[Math.floor(ct[0]),Math.floor(ct[1]),Math.floor(ct[2])],dt=[0,0,0];Zd.sub(dt,ct,ht),Zd.scale(dt,dt,-1/lt);const mt=new Float64Array(16);return ld.identity(mt),ld.translate(mt,mt,dt),ld.multiply(st,mt,st),[st,tt]}class XA extends zt{constructor(C){super(),this.requestManager=C,this.models={"":{}},this.numModelsLoading={}}loadModel(C,te){return fT(this.requestManager.transformRequest(te,st.Model).url).then((te=>{if(!te)return;const le=TT(te),ce=new Cv(C,void 0,void 0,le);return ce.computeBoundsAndApplyParent(),ce})).catch((le=>{this.fire(new Ct(new Error(`Could not load model ${C} from ${te}: ${le.message}`)))}))}load(C,te){this.models[te]||(this.models[te]={});const le=Object.keys(C);this.numModelsLoading[te]=(this.numModelsLoading[te]||0)+le.length;const ce=[];for(const te of le)ce.push(this.loadModel(te,C[te]));Promise.allSettled(ce).then((C=>{for(let ce=0;ce<C.length;ce++){const{status:he,value:ue}=C[ce];"fulfilled"===he&&ue&&(this.models[te][le[ce]]=ue)}this.numModelsLoading[te]-=le.length,this.fire(new It("data",{dataType:"style"}))})).catch((C=>{this.fire(new Ct(new Error(`Could not load models: ${C.message}`)))}))}isLoaded(){for(const C in this.numModelsLoading)if(this.numModelsLoading[C]>0)return!1;return!0}hasModel(C,te){return!!this.getModel(C,te)}getModel(C,te){return this.models[te]||(this.models[te]={}),this.models[te][C]}addModel(C,te,le){this.models[le]||(this.models[le]={}),this.hasModel(C,le)&&this.removeModel(C,le),this.load({[C]:this.requestManager.normalizeModelURL(te)},le)}addModels(C,te){const le={};for(const te in C)le[te]=this.requestManager.normalizeModelURL(C[te]);this.load(le,te)}removeModel(C,te){this.models[te]||(this.models[te]={});const le=this.models[te][C];delete this.models[te][C],le.destroy()}listModels(C){return this.models[C]||(this.models[C]={}),Object.keys(this.models[C])}upload(C,te){this.models[te]||(this.models[te]={});for(const le in this.models[te])this.models[te][le].upload(C.context)}}const YA=(C,te)=>Ss(C,te&&te.filter((C=>"source.canvas"!==C.identifier))),yI=O(qM,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection","setCamera","addImport","removeImport","setImportUrl","setImportData","setImportConfig"]),xI=O(qM,["setCenter","setZoom","setBearing","setPitch"]),vI={version:8,layers:[],sources:{}},bI={duration:300,delay:0},wI=new Set(["fill","line","background","hillshade","raster"]);class iS extends zt{constructor(C,te={}){super(),this.map=C,this.scope=te.scope||"",this.fragments=[],this.importDepth=te.importDepth||0,this.importsCache=te.importsCache||new Map,this.resolvedImports=te.resolvedImports||new Set,this.transition=k({},bI),this._buildingIndex=new DT(this),this.crossTileSymbolIndex=new CE,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=te.styleChanges||new Ea,this.dispatcher=te.dispatcher?te.dispatcher:new Ew(Ww(),this),te.imageManager?this.imageManager=te.imageManager:(this.imageManager=new aw,this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=te.glyphManager?te.glyphManager:new og(C._requestManager,te.localFontFamily?2:te.localIdeographFontFamily?1:0,te.localFontFamily||te.localIdeographFontFamily),te.modelManager?this.modelManager=te.modelManager:(this.modelManager=new XA(C._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this.options=new Map,this._configDependentLayers=new Set,this._config=te.config,this.dispatcher.broadcast("setReferrer",at());const le=this;this._rtlTextPluginCallback=iS.registerForPluginStateChange((C=>{le.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:C.pluginStatus,pluginURL:C.pluginURL},((C,te)=>{if(Qs(C),te&&te.every((C=>C)))for(const C in le._sourceCaches){const te=le._sourceCaches[C],ce=te.getSource().type;"vector"!==ce&&"geojson"!==ce||te.reload()}}))})),this.on("data",(C=>{if("source"!==C.dataType||"metadata"!==C.sourceDataType)return;const te=this.getOwnSource(C.sourceId);if(te&&te.vectorLayerIds)for(const C in this._layers){const le=this._layers[C];le.source===te.id&&this._validateLayer(le)}}))}loadURL(C,te={}){this.fire(new It("dataloading",{dataType:"style"}));const le="boolean"==typeof te.validate?te.validate:!Pe(C);C=this.map._requestManager.normalizeStyleURL(C,te.accessToken),this.resolvedImports.add(C);const ce=this.importsCache.get(C);if(ce)return this._load(ce,le);const he=this.map._requestManager.transformRequest(C,st.Style);this._request=we(he,((te,ce)=>{if(this._request=null,te)this.fire(new Ct(te));else if(ce)return this.importsCache.set(C,ce),this._load(ce,le)}))}loadJSON(C,te={}){this.fire(new It("dataloading",{dataType:"style"})),this._request=bi.frame((()=>{this._request=null,this._load(C,!1!==te.validate)}))}loadEmpty(){this.fire(new It("dataloading",{dataType:"style"})),this._load(vI,!1)}_loadImports(C,te){if(this.importDepth>=4)return H("Style doesn't support nesting deeper than 5"),Promise.resolve();const le=[];for(const ce of C){const C=this._createFragmentStyle(ce),he=new Promise((te=>{C.once("style.import.load",te),C.once("error",te)})).then((()=>this.mergeAll()));if(le.push(he),this.resolvedImports.has(ce.url)){C.loadEmpty();continue}const ue=ce.data||this.importsCache.get(ce.url);ue?C.loadJSON(ue,{validate:te}):ce.url?C.loadURL(ce.url,{validate:te}):C.loadEmpty(),this.fragments.push({style:C,id:ce.id,config:ce.config})}return Promise.allSettled(le)}_createFragmentStyle(C){const te=this.scope?va(C.id,this.scope):C.id,le=new iS(this.map,{scope:te,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:C.config});return le.setEventedParent(this.map,{style:le}),le}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options});const C=this.isRootStyle();this._shouldPrecompile=C,this.fire(new It(C?"style.load":"style.import.load"))}_load(C,te){const le=C.schema;if(this.isRootStyle()&&(C.fragment||le&&!1!==C.fragment)){const le=k({},vI,{imports:[{id:"basemap",data:C,url:""}]});return void this._load(le,te)}if(this.setConfig(this._config,le),te&&YA(this,ms(C)))return;this._loaded=!0,this.stylesheet=$(C);for(const te in C.sources)this.addSource(te,C.sources[te],{validate:!1,isInitialLoad:!0});C.sprite?this._loadSprite(C.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.glyphManager.setURL(C.glyphs,this.scope);const ce=kT(this.stylesheet.layers);if(this._order=ce.map((C=>C.id)),this.stylesheet.light&&H("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(1===this.stylesheet.lights.length&&"flat"===this.stylesheet.lights[0].type){const C=this.stylesheet.lights[0];this.light=new cw(C.properties,C.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new cw(this.stylesheet.light)),this._layers={},this._serializedLayers={};for(const C of ce){const te=ow(C,this.options);te.setScope(this.scope),te.isConfigDependent&&this._configDependentLayers.add(te.fqid),te.setEventedParent(this,{layer:{id:te.id}}),this._layers[te.id]=te,this._serializedLayers[te.id]=te.serialize();const le=this.getOwnLayerSourceCache(te),ce=!!this.directionalLight&&this.directionalLight.shadowsEnabled();le&&te.canCastShadows()&&ce&&(le.castsShadows=!0)}this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);const he=this.stylesheet.terrain;he&&(void 0===this.disableElevatedTerrain&&(this.disableElevatedTerrain=bi.hasCanvasFingerprintNoise()),this.disableElevatedTerrain?H("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."):this.terrainSetForDrapingOnly()||this._createTerrain(he,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new It("data",{dataType:"style"})),C.imports?this._loadImports(C.imports,te).then((()=>this._reloadImports())):this._reloadImports()}isRootStyle(){return 0===this.importDepth}mergeAll(){let C,te,le,ce,he,ue,de,_e;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((ye=>{if(ye.stylesheet){if(null!=ye.light&&(C=ye.light),ye.stylesheet.lights)for(const C of ye.stylesheet.lights)"ambient"===C.type&&null!=ye.ambientLight&&(te=ye.ambientLight),"directional"===C.type&&null!=ye.directionalLight&&(le=ye.directionalLight);ce=this._prioritizeTerrain(ce,ye.terrain,ye.stylesheet.terrain),ye.stylesheet.fog&&null!=ye.fog&&(he=ye.fog),null!=ye.stylesheet.camera&&(_e=ye.stylesheet.camera),null!=ye.stylesheet.projection&&(ue=ye.stylesheet.projection),null!=ye.stylesheet.transition&&(de=ye.stylesheet.transition)}})),this.light=C,this.ambientLight=te,this.directionalLight=le,this.fog=he,null===ce?delete this.terrain:this.terrain=ce,this.camera=_e||{"camera-projection":"perspective"},this.projection=ue||{name:"mercator"},this.transition=k({},bI,de),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(C){const t=te=>{for(const C of te.fragments)t(C.style);C(te)};t(this)}_prioritizeTerrain(C,te,le){const ce=C&&0===C.drapeRenderMode;return null===le?te&&0===te.drapeRenderMode?te:ce?C:null:null!=te&&(!C||ce||te&&1===te.drapeRenderMode)?te:C}mergeTerrain(){let C;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((te=>{C=this._prioritizeTerrain(C,te.terrain,te.stylesheet.terrain)})),null===C?delete this.terrain:this.terrain=C}mergeProjection(){let C;this.forEachFragmentStyle((te=>{null!=te.stylesheet.projection&&(C=te.stylesheet.projection)})),this.projection=C||{name:"mercator"}}mergeSources(){const C={},te={},le={};this.forEachFragmentStyle((ce=>{for(const te in ce._sourceCaches){const le=va(te,ce.scope);C[le]=ce._sourceCaches[te]}for(const C in ce._otherSourceCaches){const le=va(C,ce.scope);te[le]=ce._otherSourceCaches[C]}for(const C in ce._symbolSourceCaches){const te=va(C,ce.scope);le[te]=ce._symbolSourceCaches[C]}})),this._mergedSourceCaches=C,this._mergedOtherSourceCaches=te,this._mergedSymbolSourceCaches=le}mergeLayers(){const C={},te=[],le={};this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle((le=>{for(const ce of le._order){const he=le._layers[ce];if("slot"===he.type){const te=ba(ce);if(C[te])continue;C[te]=[]}he.slot&&C[he.slot]?C[he.slot].push(he):te.push(he)}})),this._mergedOrder=[];const r=(te=[])=>{for(const ce of te)if("slot"===ce.type){const te=ba(ce.id);C[te]&&r(C[te])}else{const C=va(ce.id,ce.scope);this._mergedOrder.push(C),le[C]=ce,ce.is3D()&&(this._has3DLayers=!0),"circle"===ce.type&&(this._hasCircleLayers=!0),"symbol"===ce.type&&(this._hasSymbolLayers=!0)}};r(te),this._mergedLayers=le,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&0===this.terrain.drapeRenderMode}getCamera(){return this.stylesheet.camera}setCamera(C){return this.stylesheet.camera=k({},this.stylesheet.camera,C),this.camera=this.stylesheet.camera,this}setProjection(C){C?this.stylesheet.projection=C:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?this.getTerrain()||this.stylesheet.terrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(C){this._spriteRequest=function(C,te,le){let ce,he,ue;const de=bi.devicePixelRatio>1?"@2x":"";let _e=we(te.transformRequest(te.normalizeSpriteURL(C,de,".json"),st.SpriteJSON),((C,te)=>{_e=null,ue||(ue=C,ce=te,c())})),ye=Ie(te.transformRequest(te.normalizeSpriteURL(C,de,".png"),st.SpriteImage),((C,te)=>{ye=null,ue||(ue=C,he=te,c())}));function c(){if(ue)le(ue);else if(ce&&he){const C=bi.getImageData(he),te={};for(const le in ce){const{width:he,height:ue,x:de,y:_e,sdf:ye,pixelRatio:ve,stretchX:Se,stretchY:Me,content:Ae}=ce[le],Ce=new ef({width:he,height:ue});ef.copy(C,Ce,{x:de,y:_e},{x:0,y:0},{width:he,height:ue}),te[le]={data:Ce,pixelRatio:ve,sdf:ye,stretchX:Se,stretchY:Me,content:Ae}}le(null,te)}}return{cancel(){_e&&(_e.cancel(),_e=null),ye&&(ye.cancel(),ye=null)}}}(C,this.map._requestManager,((C,te)=>{if(this._spriteRequest=null,C)this.fire(new Ct(C));else if(te)for(const C in te)this.imageManager.addImage(C,this.scope,te[C]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new It("data",{dataType:"style"}))}))}_validateLayer(C){const te=this.getOwnSource(C.source);if(!te)return;const le=C.sourceLayer;le&&("geojson"===te.type||te.vectorLayerIds&&-1===te.vectorLayerIds.indexOf(le))&&this.fire(new Ct(new Error(`Source layer "${le}" does not exist on source "${te.id}" as specified by style layer "${C.id}"`)))}loaded(){if(!this._loaded)return!1;if(Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const C in this._sourceCaches)if(!this._sourceCaches[C].loaded())return!1;if(!this.imageManager.isLoaded())return!1;if(!this.modelManager.isLoaded())return!1;for(const{style:C}of this.fragments)if(!C.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map(((C,te)=>{const le=this.fragments[te];return le&&le.style&&(C.data=le.style.serialize()),C}))}_serializeSources(){const C={};for(const te in this._sourceCaches){const le=this._sourceCaches[te].getSource();C[le.id]||(C[le.id]=le.serialize())}return C}_serializeLayers(C){const te=[];for(const le of C){const C=this._layers[le];C&&"custom"!==C.type&&te.push(C.serialize())}return te}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasTransitions(){if(this.hasLightTransitions())return!0;if(this.hasFogTransition())return!0;for(const C in this._sourceCaches)if(this._sourceCaches[C].hasTransition())return!0;for(const C in this._layers)if(this._layers[C].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}isLayerDraped(C){return!!this.terrain&&("function"==typeof C.isLayerDraped?C.isLayerDraped(this.getLayerSourceCache(C)):wI.has(C.type))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(C){const te=this.getOwnLayer(C);if(te)return te;this.fire(new Ct(new Error(`The layer '${C}' does not exist in the map's style.`)))}_checkSource(C){const te=this.getOwnSource(C);if(te)return te;this.fire(new Ct(new Error(`The source '${C}' does not exist in the map's style.`)))}update(C){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(C),this.directionalLight&&this.directionalLight.recalculate(C);const te=this.calculateLightsBrightness();C.brightness=te||0,te!==this._brightness&&(this._brightness=te,this.dispatcher.broadcast("setBrightness",te));const le=this._changes.isDirty();if(this._changes.isDirty()){const te=this._changes.getLayerUpdatesByScope();for(const C in te){const{updatedIds:le,removedIds:ce}=te[C];(le||ce)&&this._updateWorkerLayers(C,le,ce)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(C),this.light&&this.light.updateTransitions(C),this.ambientLight&&this.ambientLight.updateTransitions(C),this.directionalLight&&this.directionalLight.updateTransitions(C),this.fog&&this.fog.updateTransitions(C),this._changes.reset()}const ce={};for(const C in this._mergedSourceCaches){const te=this._mergedSourceCaches[C];ce[C]=te.used,te.used=!1}for(const te of this._mergedOrder){const le=this._mergedLayers[te];if(le.recalculate(C,this._availableImages),!le.isHidden(C.zoom)){const C=this.getLayerSourceCache(le);C&&(C.used=!0)}if(!this._precompileDone&&this._shouldPrecompile)for(let te=le.minzoom||0;te<(le.maxzoom||25.5);te++){const te=this.map.painter;if(te){const ce=le.getProgramIds();if(!ce)continue;for(const he of ce){const ce=le.getDefaultProgramParams(he,C.zoom);ce&&(te.style=this,this.fog&&(te._fogVisible=!0,ce.overrideFog=!0,te.getOrCreateProgram(he,ce)),te._fogVisible=!1,ce.overrideFog=!1,te.getOrCreateProgram(he,ce),(this.stylesheet.terrain||this.stylesheet.projection&&"globe"===this.stylesheet.projection.name)&&(ce.overrideRtt=!0,te.getOrCreateProgram(he,ce)))}}}}this._shouldPrecompile&&(this._precompileDone=!0);for(const C in ce){const te=this._mergedSourceCaches[C];ce[C]!==te.used&&te.getSource().fire(new It("data",{sourceDataType:"visibility",dataType:"source",sourceId:te.getSource().id}))}this.light&&this.light.recalculate(C),this.terrain&&this.terrain.recalculate(C),this.fog&&this.fog.recalculate(C),this.z=C.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),le&&this.fire(new It("data",{dataType:"style"}))}_updateTilesForChangedImages(){const C=this._changes.getUpdatedImages();if(C.length){for(const te in this._sourceCaches)this._sourceCaches[te].reloadTilesForDependencies(["icons","patterns"],C);this._changes.resetUpdatedImages()}}_updateWorkerLayers(C,te,le){const ce=this.getFragmentStyle(C);ce&&this.dispatcher.broadcast("updateLayers",{layers:te?ce._serializeLayers(te):[],scope:C,removedIds:le||[],options:ce.options})}setState(C){if(this._checkLoaded(),YA(this,ms(C)))return!1;(C=$(C)).layers=kT(C.layers);const te=function(C,te){if(!C)return[{command:qM.setStyle,args:[te]}];let le=[];try{if(!x(C.version,te.version))return[{command:qM.setStyle,args:[te]}];x(C.center,te.center)||le.push({command:qM.setCenter,args:[te.center]}),x(C.zoom,te.zoom)||le.push({command:qM.setZoom,args:[te.zoom]}),x(C.bearing,te.bearing)||le.push({command:qM.setBearing,args:[te.bearing]}),x(C.pitch,te.pitch)||le.push({command:qM.setPitch,args:[te.pitch]}),x(C.sprite,te.sprite)||le.push({command:qM.setSprite,args:[te.sprite]}),x(C.glyphs,te.glyphs)||le.push({command:qM.setGlyphs,args:[te.glyphs]}),x(C.imports,te.imports)||function(C=[],te=[],le){te=te||[];const ce=(C=C||[]).map(jT),he=te.map(jT),ue=C.reduce(GT,{}),de=te.reduce(GT,{}),_e=ce.slice();let ye,ve,Se,Me;for(ye=0,ve=0;ye<ce.length;ye++)Se=ce[ye],de.hasOwnProperty(Se)?ve++:(le.push({command:qM.removeImport,args:[Se]}),_e.splice(_e.indexOf(Se,ve),1));for(ye=0,ve=0;ye<he.length;ye++)Se=he[he.length-1-ye],_e[_e.length-1-ye]!==Se&&(ue.hasOwnProperty(Se)?(le.push({command:qM.removeImport,args:[Se]}),_e.splice(_e.lastIndexOf(Se,_e.length-ve),1)):ve++,Me=_e[_e.length-ye],le.push({command:qM.addImport,args:[de[Se],Me]}),_e.splice(_e.length-ye,0,Se));for(const C of te){const te=ue[C.id];if(!te||x(te,C))continue;x(te.config,C.config)||le.push({command:qM.setImportConfig,args:[C.id,C.config]}),x(te.url,C.url)||le.push({command:qM.setImportUrl,args:[C.id,C.url]});const ce=C.data;x(te&&te.data,ce)||le.push({command:qM.setImportData,args:[C.id,ce]})}}(C.imports,te.imports,le),x(C.transition,te.transition)||le.push({command:qM.setTransition,args:[te.transition]}),x(C.light,te.light)||le.push({command:qM.setLight,args:[te.light]}),x(C.fog,te.fog)||le.push({command:qM.setFog,args:[te.fog]}),x(C.projection,te.projection)||le.push({command:qM.setProjection,args:[te.projection]}),x(C.lights,te.lights)||le.push({command:qM.setLights,args:[te.lights]}),x(C.camera,te.camera)||le.push({command:qM.setCamera,args:[te.camera]});const ce={},he=[];!function(C,te,le,ce){let he;for(he in te=te||{},C=C||{})C.hasOwnProperty(he)&&(te.hasOwnProperty(he)||FT(he,le,ce));for(he in te){if(!te.hasOwnProperty(he))continue;const ue=te[he];C.hasOwnProperty(he)?x(C[he],ue)||("geojson"===C[he].type&&"geojson"===ue.type&&UT(C,te,he)?le.push({command:qM.setGeoJSONSourceData,args:[he,ue.data]}):NT(he,te,le,ce)):BT(he,te,le)}}(C.sources,te.sources,he,ce);const ue=[];C.layers&&C.layers.forEach((C=>{C.source&&ce[C.source]?le.push({command:qM.removeLayer,args:[C.id]}):ue.push(C)}));let de=C.terrain;de&&ce[de.source]&&(le.push({command:qM.setTerrain,args:[void 0]}),de=void 0),le=le.concat(he),x(de,te.terrain)||le.push({command:qM.setTerrain,args:[te.terrain]}),function(C,te,le){te=te||[];const ce=(C=C||[]).map(jT),he=te.map(jT),ue=C.reduce(GT,{}),de=te.reduce(GT,{}),_e=ce.slice(),ye=Object.create(null);let ve,Se,Me,Ae,Ce,Oe,Ne;for(ve=0,Se=0;ve<ce.length;ve++)Me=ce[ve],de.hasOwnProperty(Me)?Se++:(le.push({command:qM.removeLayer,args:[Me]}),_e.splice(_e.indexOf(Me,Se),1));for(ve=0,Se=0;ve<he.length;ve++)Me=he[he.length-1-ve],_e[_e.length-1-ve]!==Me&&(ue.hasOwnProperty(Me)?(le.push({command:qM.removeLayer,args:[Me]}),_e.splice(_e.lastIndexOf(Me,_e.length-Se),1)):Se++,Oe=_e[_e.length-ve],le.push({command:qM.addLayer,args:[de[Me],Oe]}),_e.splice(_e.length-ve,0,Me),ye[Me]=!0);for(ve=0;ve<he.length;ve++)if(Me=he[ve],Ae=ue[Me],Ce=de[Me],!ye[Me]&&!x(Ae,Ce))if(x(Ae.source,Ce.source)&&x(Ae["source-layer"],Ce["source-layer"])&&x(Ae.type,Ce.type)){for(Ne in VT(Ae.layout,Ce.layout,le,Me,null,qM.setLayoutProperty),VT(Ae.paint,Ce.paint,le,Me,null,qM.setPaintProperty),x(Ae.slot,Ce.slot)||le.push({command:qM.setSlot,args:[Me,Ce.slot]}),x(Ae.filter,Ce.filter)||le.push({command:qM.setFilter,args:[Me,Ce.filter]}),x(Ae.minzoom,Ce.minzoom)&&x(Ae.maxzoom,Ce.maxzoom)||le.push({command:qM.setLayerZoomRange,args:[Me,Ce.minzoom,Ce.maxzoom]}),Ae)Ae.hasOwnProperty(Ne)&&"layout"!==Ne&&"paint"!==Ne&&"filter"!==Ne&&"metadata"!==Ne&&"minzoom"!==Ne&&"maxzoom"!==Ne&&"slot"!==Ne&&(0===Ne.indexOf("paint.")?VT(Ae[Ne],Ce[Ne],le,Me,Ne.slice(6),qM.setPaintProperty):x(Ae[Ne],Ce[Ne])||le.push({command:qM.setLayerProperty,args:[Me,Ne,Ce[Ne]]}));for(Ne in Ce)Ce.hasOwnProperty(Ne)&&!Ae.hasOwnProperty(Ne)&&"layout"!==Ne&&"paint"!==Ne&&"filter"!==Ne&&"metadata"!==Ne&&"minzoom"!==Ne&&"maxzoom"!==Ne&&"slot"!==Ne&&(0===Ne.indexOf("paint.")?VT(Ae[Ne],Ce[Ne],le,Me,Ne.slice(6),qM.setPaintProperty):x(Ae[Ne],Ce[Ne])||le.push({command:qM.setLayerProperty,args:[Me,Ne,Ce[Ne]]}))}else le.push({command:qM.removeLayer,args:[Me]}),Oe=_e[_e.lastIndexOf(Me)+1],le.push({command:qM.addLayer,args:[Ce,Oe]})}(ue,te.layers,le)}catch(C){console.warn("Unable to compute style diff:",C),le=[{command:qM.setStyle,args:[te]}]}return le}(this.serialize(),C).filter((C=>!(C.command in xI)));if(0===te.length)return!1;const le=te.filter((C=>!(C.command in yI)));if(le.length>0)throw new Error(`Unimplemented: ${le.map((C=>C.command)).join(", ")}.`);return te.forEach((C=>{this[C.command].apply(this,C.args)})),this.stylesheet=C,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}addImage(C,te){return this.getImage(C)?this.fire(new Ct(new Error("An image with this name already exists."))):(this.imageManager.addImage(C,this.scope,te),this._afterImageUpdated(C),this)}updateImage(C,te){this.imageManager.updateImage(C,this.scope,te)}getImage(C){return this.imageManager.getImage(C,this.scope)}removeImage(C){return this.getImage(C)?(this.imageManager.removeImage(C,this.scope),this._afterImageUpdated(C),this):this.fire(new Ct(new Error("No image with this name exists.")))}_afterImageUpdated(C){this._availableImages=this.imageManager.listImages(this.scope),this._changes.updateImage(C),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.fire(new It("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(C,te,le={}){return this._checkLoaded(),this._validate(Ms,`models.${C}`,te,null,le)||(this.modelManager.addModel(C,te,this.scope),this._changes.setDirty()),this}hasModel(C){return this.modelManager.hasModel(C,this.scope)}removeModel(C){return this.hasModel(C)?(this.modelManager.removeModel(C,this.scope),this):this.fire(new Ct(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(C,te,le={}){if(this._checkLoaded(),void 0!==this.getOwnSource(C))throw new Error(`There is already a source with ID "${C}".`);if(!te.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(te).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(te.type)>=0&&this._validate(_s,`sources.${C}`,te,null,le))return;this.map&&this.map._collectResourceTiming&&(te.collectResourceTiming=!0);const ce=ST(C,te,this.dispatcher,this);ce.scope=this.scope,ce.setEventedParent(this,(()=>({isSourceLoaded:this._isSourceCacheLoaded(ce.id),source:ce.serialize(),sourceId:ce.id})));const n=C=>{const te=(C?"symbol:":"other:")+ce.id,le=va(te,this.scope),he=this._sourceCaches[te]=new Lx(le,ce,C);(C?this._symbolSourceCaches:this._otherSourceCaches)[ce.id]=he,he.onAdd(this.map)};n(!1),"vector"!==te.type&&"geojson"!==te.type||n(!0),ce.onAdd&&ce.onAdd(this.map),le.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(C){this._checkLoaded();const te=this.getOwnSource(C);if(!te)throw new Error("There is no source with this ID");for(const te in this._layers)if(this._layers[te].source===C)return this.fire(new Ct(new Error(`Source "${C}" cannot be removed while layer "${te}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===C)return this.fire(new Ct(new Error(`Source "${C}" cannot be removed while terrain is using it.`)));const le=this.getOwnSourceCaches(C);for(const C of le){const te=ba(C.id);delete this._sourceCaches[te],this._changes.discardSourceCacheUpdate(C.id),C.fire(new It("data",{sourceDataType:"metadata",dataType:"source",sourceId:C.getSource().id})),C.setEventedParent(null),C.clearTiles()}return delete this._otherSourceCaches[C],delete this._symbolSourceCaches[C],this.mergeSources(),te.setEventedParent(null),te.onRemove&&te.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(C,te){this._checkLoaded(),this.getOwnSource(C).setData(te),this._changes.setDirty()}getOwnSource(C){const te=this.getOwnSourceCache(C);return te&&te.getSource()}getOwnSources(){const C=[];for(const te in this._otherSourceCaches){const le=this.getOwnSourceCache(te);le&&C.push(le.getSource())}return C}setLights(C){if(this._checkLoaded(),!C)return delete this.ambientLight,void delete this.directionalLight;const te=this._getTransitionParameters();for(const le of C){if(this._validate(ys,"lights",le))return;switch(le.type){case"ambient":if(this.ambientLight){const C=this.ambientLight;C.set(le),C.updateTransitions(te)}else this.ambientLight=new Mw(le,tS,this.scope,this.options);break;case"directional":if(this.directionalLight){const C=this.directionalLight;C.set(le),C.updateTransitions(te)}else this.directionalLight=new Mw(le,sS,this.scope,this.options)}}const le=new oa(this.z||0,te);this.ambientLight&&this.ambientLight.recalculate(le),this.directionalLight&&this.directionalLight.recalculate(le),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const C=this.directionalLight,te=this.ambientLight;if(!C||!te)return;const i=C=>.2126*(C[0]<=.03928?C[0]/12.92:Math.pow((C[0]+.055)/1.055,2.4))+.7152*(C[1]<=.03928?C[1]/12.92:Math.pow((C[1]+.055)/1.055,2.4))+.0722*(C[2]<=.03928?C[2]/12.92:Math.pow((C[2]+.055)/1.055,2.4)),le=C.properties.get("color").toArray01(),ce=C.properties.get("intensity"),he=C.properties.get("direction"),ue=1-J(he.x,he.y,he.z)[2]/90,de=i(le)*ce*ue,_e=te.properties.get("color").toArray01(),ye=te.properties.get("intensity");return(de+i(_e)*ye)/2}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const C=[];return this.directionalLight&&C.push(this.directionalLight.get()),this.ambientLight&&C.push(this.ambientLight.get()),C}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(C){if(!C)return this;if(xa(C)){const te=function(C){const te=C.indexOf(cc);return te>=0?C.slice(te+1):""}(C),le=this.fragments.find((({id:C})=>C===te));if(!le)throw new Error(`Style import not found: ${C}`);const ce=ba(C);return le.style.getFragmentStyle(ce)}{const te=this.fragments.find((({id:te})=>te===C));if(!te)throw new Error(`Style import not found: ${C}`);return te.style}}getConfigProperty(C,te){const le=this.getFragmentStyle(C);if(!le)return null;const ce=le.options.get(te),he=ce?ce.value||ce.default:null;return he?he.serialize():null}setConfigProperty(C,te,le){const ce=Eo(le);if("success"!==ce.result)return void YA(this,ce.value);const he=ce.value.expression,ue=this.getFragmentStyle(C);if(!ue)return;const de=ue.options.get(te);de&&(ue.options.set(te,{...de,value:he}),ue.updateConfigDependencies())}setConfig(C,te){if(this._config=C,C||te)if(te){this.options.clear();for(const le in te){let ce,he;const ue=Eo(te[le].default);if("success"===ue.result&&(ce=ue.value.expression),C&&void 0!==C[le]){const te=Eo(C[le]);"success"===te.result&&(he=te.value.expression)}const{minValue:de,maxValue:_e,stepValue:ye,type:ve,values:Se}=te[le];ce?this.options.set(le,{default:ce,value:he,minValue:de,maxValue:_e,stepValue:ye,type:ve,values:Se}):this.fire(new Ct(new Error(`No schema defined for config option "${le}".`)))}}else this.fire(new Ct(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(){for(const C of this._configDependentLayers){const te=this.getLayer(C);te&&(te.possiblyEvaluateVisibility(),this._updateLayer(te))}this.ambientLight&&this.ambientLight.scope===this.scope&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.scope===this.scope&&this.directionalLight.updateConfig(this.options),this._changes.setDirty()}addLayer(C,te,le={}){this._checkLoaded();const ce=C.id;if(this._layers[ce])return void this.fire(new Ct(new Error(`Layer with id "${ce}" already exists on this map`)));let he;if("custom"===C.type){if(YA(this,function(C){const te=[],le=C.id;return void 0===le&&te.push({message:`layers.${le}: missing required property "id"`}),void 0===C.render&&te.push({message:`layers.${le}: missing required method "render"`}),C.renderingMode&&"2d"!==C.renderingMode&&"3d"!==C.renderingMode&&te.push({message:`layers.${le}: property "renderingMode" must be either "2d" or "3d"`}),te}(C)))return;he=ow(C,this.options)}else{if("object"==typeof C.source&&(this.addSource(ce,C.source),C=k(C=$(C),{source:ce})),this._validate(bs,`layers.${ce}`,C,{arrayIndex:-1},le))return;he=ow(C,this.options),this._validateLayer(he),he.setEventedParent(this,{layer:{id:ce}}),this._serializedLayers[he.id]=he.serialize()}he.isConfigDependent&&this._configDependentLayers.add(he.fqid),he.setScope(this.scope);let ue=this._order.length;if(te){const C=this._order.indexOf(te);if(-1===C)return void this.fire(new Ct(new Error(`Layer with id "${te}" does not exist on this map.`)));he.slot===this._layers[te].slot?ue=C:H(`Layer with id "${te}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(ue,0,ce),this._layerOrderChanged=!0,this._layers[ce]=he;const de=this.getOwnLayerSourceCache(he),_e=!!this.directionalLight&&this.directionalLight.shadowsEnabled();de&&he.canCastShadows()&&_e&&(de.castsShadows=!0);const ye=this._changes.getRemovedLayer(he);if(ye&&he.source&&de&&"custom"!==he.type){this._changes.discardLayerRemoval(he);const C=va(he.source,he.scope);ye.type!==he.type?this._changes.updateSourceCache(C,"clear"):(this._changes.updateSourceCache(C,"reload"),de.pause())}this._updateLayer(he),he.onAdd&&he.onAdd(this.map),he.scope=this.scope,this.mergeLayers()}moveLayer(C,te){this._checkLoaded();const le=this._checkLayer(C);if(!le)return;if(C===te)return;const ce=this._order.indexOf(C);this._order.splice(ce,1);let he=this._order.length;if(te){const C=this._order.indexOf(te);if(-1===C)return void this.fire(new Ct(new Error(`Layer with id "${te}" does not exist on this map.`)));le.slot===this._layers[te].slot?he=C:H(`Layer with id "${te}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(he,0,C),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(C){this._checkLoaded();const te=this._checkLayer(C);if(!te)return;te.setEventedParent(null);const le=this._order.indexOf(C);this._order.splice(le,1),delete this._layers[C],delete this._serializedLayers[C],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(te.fqid),this._changes.removeLayer(te);const ce=this.getOwnLayerSourceCache(te);if(ce&&ce.castsShadows){let C=!1;for(const le in this._layers)if(this._layers[le].source===te.source&&this._layers[le].canCastShadows()){C=!0;break}ce.castsShadows=C}te.onRemove&&te.onRemove(this.map),this.mergeLayers()}getOwnLayer(C){return this._layers[C]}hasLayer(C){return C in this._mergedLayers}hasLayerType(C){for(const te in this._layers)if(this._layers[te].type===C)return!0;return!1}setLayerZoomRange(C,te,le){this._checkLoaded();const ce=this._checkLayer(C);ce&&(ce.minzoom===te&&ce.maxzoom===le||(null!=te&&(ce.minzoom=te),null!=le&&(ce.maxzoom=le),this._updateLayer(ce)))}setSlot(C,te){this._checkLoaded();const le=this._checkLayer(C);le&&le.slot!==te&&(le.slot=te,this._updateLayer(le))}setFilter(C,te,le={}){this._checkLoaded();const ce=this._checkLayer(C);if(ce&&!x(ce.filter,te))return null==te?(ce.filter=void 0,void this._updateLayer(ce)):void(this._validate(ws,`layers.${ce.id}.filter`,te,{layerType:ce.type},le)||(ce.filter=$(te),this._updateLayer(ce)))}getFilter(C){const te=this._checkLayer(C);if(te)return $(te.filter)}setLayoutProperty(C,te,le,ce={}){this._checkLoaded();const he=this._checkLayer(C);he&&(x(he.getLayoutProperty(te),le)||(he.setLayoutProperty(te,le,ce),he.isConfigDependent&&this._configDependentLayers.add(he.fqid),this._updateLayer(he)))}getLayoutProperty(C,te){const le=this._checkLayer(C);if(le)return le.getLayoutProperty(te)}setPaintProperty(C,te,le,ce={}){this._checkLoaded();const he=this._checkLayer(C);if(!he)return;if(x(he.getPaintProperty(te),le))return;const ue=he.setPaintProperty(te,le,ce);he.isConfigDependent&&this._configDependentLayers.add(he.fqid),ue&&this._updateLayer(he),this._changes.updatePaintProperties(he)}getPaintProperty(C,te){const le=this._checkLayer(C);if(le)return le.getPaintProperty(te)}setFeatureState(C,te){this._checkLoaded();const le=C.source,ce=C.sourceLayer,he=this._checkSource(le);if(!he)return;const ue=he.type;if("geojson"===ue&&ce)return void this.fire(new Ct(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if("vector"===ue&&!ce)return void this.fire(new Ct(new Error("The sourceLayer parameter must be provided for vector source types.")));void 0===C.id&&this.fire(new Ct(new Error("The feature id parameter must be provided.")));const de=this.getOwnSourceCaches(le);for(const le of de)le.setFeatureState(ce,C.id,te)}removeFeatureState(C,te){this._checkLoaded();const le=C.source,ce=this._checkSource(le);if(!ce)return;const he=ce.type,ue="vector"===he?C.sourceLayer:void 0;if("vector"===he&&!ue)return void this.fire(new Ct(new Error("The sourceLayer parameter must be provided for vector source types.")));if(te&&"string"!=typeof C.id&&"number"!=typeof C.id)return void this.fire(new Ct(new Error("A feature id is required to remove its specific state property.")));const de=this.getOwnSourceCaches(le);for(const le of de)le.removeFeatureState(ue,C.id,te)}getFeatureState(C){this._checkLoaded();const te=C.source,le=C.sourceLayer,ce=this._checkSource(te);if(ce){if("vector"!==ce.type||le)return void 0===C.id&&this.fire(new Ct(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(te)[0].getFeatureState(le,C.id);this.fire(new Ct(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(C){return this.stylesheet.transition=k({},this.stylesheet.transition,C),this.transition=this.stylesheet.transition,this}getTransition(){return k({},this.stylesheet.transition)}serialize(){this._checkLoaded();const C=this.getTerrain(),te=C&&this.terrain&&this.terrain.scope===this.scope?C:this.stylesheet.terrain;return Z({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:te,fog:this.stylesheet.fog,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},(C=>void 0!==C))}_updateLayer(C){this._changes.updateLayer(C);const te=this.getLayerSourceCache(C),le=va(C.source,C.scope),ce=this._changes.getUpdatedSourceCaches();C.source&&!ce[le]&&te&&"raster"!==te.getSource().type&&(this._changes.updateSourceCache(le,"reload"),te.pause()),C.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(C){const t=C=>"fill-extrusion"===this._mergedLayers[C].type,te=this.order,le={},ce=[];for(let he=te.length-1;he>=0;he--){const ue=te[he];if(t(ue)){le[ue]=he;for(const te of C){const C=te[ue];if(C)for(const te of C)ce.push(te)}}}ce.sort(((C,te)=>te.intersectionZ-C.intersectionZ));const he=[];for(let ue=te.length-1;ue>=0;ue--){const de=te[ue];if(t(de))for(let C=ce.length-1;C>=0;C--){const te=ce[C].feature;if(le[te.layer.id]<ue)break;he.push(te),ce.pop()}else for(const te of C){const C=te[de];if(C)for(const te of C)he.push(te.feature)}}return he}queryRenderedFeatures(C,te,le){te&&te.filter&&this._validate(ws,"queryRenderedFeatures.filter",te.filter,null,te),te.scope=this.scope,te.availableImages=this._availableImages,te.serializedLayers=this._serializedLayers;const ce={};if(te&&te.layers){if(!Array.isArray(te.layers))return this.fire(new Ct(new Error("parameters.layers must be an Array."))),[];for(const C of te.layers){const te=this._mergedLayers[C];if(!te)return this.fire(new Ct(new Error(`The layer '${C}' does not exist in the map's style and cannot be queried for features.`))),[];ce[te.source]=!0}}const he=[],ue=te.serializedLayers||{},de=te&&te.layers?te.layers.some((C=>{const te=this.getLayer(C);return te&&te.is3D()})):this.has3DLayers(),_e=Iw.createFromScreenPoints(C,le);for(const C in this._mergedSourceCaches){const ye=this._mergedSourceCaches[C].getSource();if(!ye||ye.scope!==te.scope)continue;const ve=this._mergedSourceCaches[C].getSource().id;te.layers&&!ce[ve]||he.push(CT(this._mergedSourceCaches[C],this._mergedLayers,ue,_e,te,le,de,!!this.map._showQueryGeometry))}return this.placement&&he.push(function(C,te,le,ce,he,ue,de){const _e={},ye=ue.queryRenderedSymbols(ce),ve=[];for(const C of Object.keys(ye).map(Number))ve.push(de[C]);ve.sort(PT);for(const le of ve){const ce=le.featureIndex.lookupSymbolFeatures(ye[le.bucketInstanceId],te,le.bucketIndex,le.sourceLayerIndex,he.filter,he.layers,he.availableImages,C);for(const C in ce){const te=_e[C]=_e[C]||[],he=ce[C];he.sort(((C,te)=>{const ce=le.featureSortOrder;if(ce){const le=ce.indexOf(C.featureIndex);return ce.indexOf(te.featureIndex)-le}return te.featureIndex-C.featureIndex}));for(const C of he)te.push(C)}}for(const te in _e)_e[te].forEach((ce=>{const he=ce.feature,ue=le(C[te]);if(!ue)return;const de=ue.getFeatureState(he.layer["source-layer"],he.id);he.source=he.layer.source,he.layer["source-layer"]&&(he.sourceLayer=he.layer["source-layer"]),he.state=de}));return _e}(this._mergedLayers,ue,this.getLayerSourceCache.bind(this),_e.screenGeometry,te,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(he)}querySourceFeatures(C,te){te&&te.filter&&this._validate(ws,"querySourceFeatures.filter",te.filter,null,te);const le=this.getOwnSourceCaches(C);let ce=[];for(const C of le)ce=ce.concat(zT(C,te));return ce}addSourceType(C,te,le){return iS.getSourceType(C)?le(new Error(`A source type called "${C}" already exists.`)):(iS.setSourceType(C,te),te.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:C,url:te.workerSourceURL},le):le(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(C,te,le={}){this._checkLoaded();const ce=this.light.getLight();let he=!1;for(const te in C)if(!x(C[te],ce[te])){he=!0;break}if(!he)return;const ue=this._getTransitionParameters();this.light.setLight(C,te,le),this.light.updateTransitions(ue)}getTerrain(){return this.terrain&&1===this.terrain.drapeRenderMode?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}setTerrain(C,te=1){if(this._checkLoaded(),!C)return delete this.terrain,null===C?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);let le=C;const ce=null==C.source;if(1===te){if("object"==typeof le.source){const C="terrain-dem-src";this.addSource(C,le.source),le=$(le),le=k(le,{source:C})}const C=k({},le),te={};if(this.terrain&&ce){C.source=this.terrain.get().source;const le=this.terrain?this.getFragmentStyle(this.terrain.scope):null;le&&(te.style=le.serialize())}if(this._validate(xs,"terrain",C,te))return}if(!this.terrain||this.terrain.scope!==this.scope&&!ce||this.terrain&&te!==this.terrain.drapeRenderMode){if(!le)return;this._createTerrain(le,te),this.fire(new It("data",{dataType:"style"}))}else{const te=this.terrain,ce=te.get();for(const C of Object.keys(zi.terrain))!le.hasOwnProperty(C)&&zi.terrain[C].default&&(le[C]=zi.terrain[C].default);for(const le in C)if(!x(C[le],ce[le])){te.set(C,this.options),this.stylesheet.terrain=C;const le=this._getTransitionParameters({duration:0});te.updateTransitions(le),this.fire(new It("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(C){const te=this.fog=new vw(C,this.map.transform);this.stylesheet.fog=te.get();const le=this._getTransitionParameters({duration:0});te.updateTransitions(le)}_updateMarkersOpacity(){0!==this.map._markers.length&&this.map._requestDomTask((()=>{for(const C of this.map._markers)C._evaluateOpacity()}))}getFog(){return this.fog?this.fog.get():null}setFog(C){if(this._checkLoaded(),!C)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const te=this.fog;if(!x(te.get(),C)){te.set(C),this.stylesheet.fog=te.get();const le=this._getTransitionParameters({duration:0});te.updateTransitions(le)}}else this._createFog(C);this._markersNeedUpdate=!0}_getTransitionParameters(C){return{now:bi.now(),transition:k(this.transition,C)}}updateDrapeFirstLayers(){if(!this.terrain)return;const C=[],te=[];for(const le in this._mergedLayers)this.isLayerDraped(this._mergedLayers[le])?C.push(le):te.push(le);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...C),this._drapedFirstOrder.push(...te)}_createTerrain(C,te){const le=this.terrain=new AT(C,te,this.scope,this.options);1===te&&(this.stylesheet.terrain=C),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const ce=this._getTransitionParameters({duration:0});le.updateTransitions(ce)}_force3DLayerUpdate(){for(const C in this._layers){const te=this._layers[C];"fill-extrusion"===te.type&&this._updateLayer(te)}}_forceSymbolLayerUpdate(){for(const C in this._layers){const te=this._layers[C];"symbol"===te.type&&this._updateLayer(te)}}_validate(C,te,le,ce,he={}){if(he&&!1===he.validate)return!1;const ue=k({},this.serialize());return YA(this,C.call(ms,k({key:te,style:ue,value:le,styleSpec:zi},ce)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),ac.off("pluginStateChange",this._rtlTextPluginCallback);for(const C in this._mergedLayers)this._mergedLayers[C].setEventedParent(null);for(const C in this._mergedSourceCaches)this._mergedSourceCaches[C].clearTiles(),this._mergedSourceCaches[C].setEventedParent(null);this.setEventedParent(null),delete this.fog,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(C){const te=this.getSourceCaches(C);for(const C of te)C.clearTiles()}clearSources(){for(const C in this._mergedSourceCaches)this._mergedSourceCaches[C].clearTiles()}reloadSource(C){const te=this.getSourceCaches(C);for(const C of te)C.resume(),C.reload()}reloadSources(){for(const C of this.getSources())C.reload&&C.reload()}updateSources(C){let te;this.directionalLight&&(te=$A(this.directionalLight));for(const le in this._mergedSourceCaches)this._mergedSourceCaches[le].update(C,void 0,void 0,te)}_generateCollisionBoxes(){for(const C in this._sourceCaches){const te=this._sourceCaches[C];te.resume(),te.reload()}}_updatePlacement(C,te,le,ce,he=!1){let ue=!1,de=!1;const _e={},ye={};for(const te of this._mergedOrder){const le=this._mergedLayers[te];if("symbol"!==le.type)continue;const ce=va(le.source,le.scope);let he=_e[ce];if(!he){const C=this.getLayerSourceCache(le);if(!C)continue;const te=C.getRenderableIds(!0).map((te=>C.getTileByID(te)));ye[ce]=te.slice(),he=_e[ce]=te.sort(((C,te)=>te.tileID.overscaledZ-C.tileID.overscaledZ||(C.tileID.isLessThan(te.tileID)?-1:1)))}const de=this.crossTileSymbolIndex.addLayer(le,he,C.center.lng,C.projection);ue=ue||de}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),he=he||this._layerOrderChanged||0===le,this._layerOrderChanged&&this.fire(new It("neworder")),(he||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(bi.now(),C.zoom))&&(this.pauseablePlacement=new gE(C,this._mergedOrder,he,te,le,ce,this.placement,this.fog&&C.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,_e,ye),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(bi.now()),de=!0),ue&&this.pauseablePlacement.placement.setStale()),de||ue)for(const C of this._mergedOrder){const te=this._mergedLayers[C];"symbol"===te.type&&this.placement.updateLayerOpacities(te,_e[va(te.source,te.scope)])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(bi.now())}_releaseSymbolFadeTiles(){for(const C in this._sourceCaches)this._sourceCaches[C].releaseSymbolFadeTiles()}addImport(C){this._checkLoaded();const te=this.stylesheet.imports=this.stylesheet.imports||[],le=te.findIndex((({id:te})=>te===C.id));return-1!==le?this.fire(new Ct(new Error(`Import with id '${C.id}' already exists in the map's style.`))):(te.push(C),this._loadImports([C],!0),this)}setImportUrl(C,te){this._checkLoaded();const le=this.stylesheet.imports||[],ce=this.getImportIndex(C);if(-1===ce)return this;le[ce].url=te;const he=this.fragments[ce];return he.style=this._createFragmentStyle(le[ce]),he.style.on("style.import.load",(()=>this.mergeAll())),he.style.loadURL(te),this}setImportData(C,te){this._checkLoaded();const le=this.getImportIndex(C),ce=this.stylesheet.imports||[];return-1===le?this:te?(this.fragments[le].style.setState(te),this._reloadImports(),this):(delete ce[le].data,this.setImportUrl(C,ce[le].url))}setImportConfig(C,te){this._checkLoaded();const le=this.getImportIndex(C),ce=this.stylesheet.imports||[];if(-1===le)return this;te?ce[le].config=te:delete ce[le].config;const he=this.fragments[le],ue=he.style.stylesheet&&he.style.stylesheet.schema;return he.config=te,he.style.setConfig(te,ue),he.style.updateConfigDependencies(),this}removeImport(C){this._checkLoaded();const te=this.stylesheet.imports||[],le=this.getImportIndex(C);return-1===le||(te.splice(le,1),this.fragments[le].style._remove(),this.fragments.splice(le,1),this._reloadImports()),this}getImportIndex(C){const te=(this.stylesheet.imports||[]).findIndex((te=>te.id===C));return-1===te&&this.fire(new Ct(new Error(`Import '${C}' does not exist in the map's style and cannot be updated.`))),te}getLayer(C){return this._mergedLayers[C]}getSources(){const C=[];for(const te in this._mergedOtherSourceCaches){const le=this._mergedOtherSourceCaches[te];le&&C.push(le.getSource())}return C}getSource(C,te){const le=this.getSourceCache(C,te);return le&&le.getSource()}getLayerSource(C){const te=this.getLayerSourceCache(C);return te&&te.getSource()}getSourceCache(C,te){const le=va(C,te);return this._mergedOtherSourceCaches[le]}getLayerSourceCache(C){const te=va(C.source,C.scope);return"symbol"===C.type?this._mergedSymbolSourceCaches[te]:this._mergedOtherSourceCaches[te]}getSourceCaches(C){const te=[];return this._mergedOtherSourceCaches[C]&&te.push(this._mergedOtherSourceCaches[C]),this._mergedSymbolSourceCaches[C]&&te.push(this._mergedSymbolSourceCaches[C]),te}updateSourceCaches(){const C=this._changes.getUpdatedSourceCaches();for(const te in C){const le=C[te];"reload"===le?this.reloadSource(te):"clear"===le&&this.clearSource(te)}}updateLayers(C){const te=this._changes.getUpdatedPaintProperties();for(const le of te){const te=this.getLayer(le);te&&te.updateTransitions(C)}}getImages(C,te,le){this.imageManager.getImages(te.icons,te.scope,le),this._updateTilesForChangedImages();const r=C=>{C&&C.setDependencies(te.tileID.key,te.type,te.icons)};r(this._otherSourceCaches[te.source]),r(this._symbolSourceCaches[te.source])}getGlyphs(C,te,le){this.glyphManager.getGlyphs(te.stacks,te.scope,le)}getResource(C,te,le){return be(te,le)}getOwnSourceCache(C){return this._otherSourceCaches[C]}getOwnLayerSourceCache(C){return"symbol"===C.type?this._symbolSourceCaches[C.source]:this._otherSourceCaches[C.source]}getOwnSourceCaches(C){const te=[];return this._otherSourceCaches[C]&&te.push(this._otherSourceCaches[C]),this._symbolSourceCaches[C]&&te.push(this._symbolSourceCaches[C]),te}_isSourceCacheLoaded(C){const te=this.getOwnSourceCaches(C);return 0===te.length?(this.fire(new Ct(new Error(`There is no source with ID '${C}'`))),!1):te.every((C=>C.loaded()))}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}function rS(C,te){let le=!1,ce=null;const n=()=>{ce=null,le&&(C(),ce=setTimeout(n,te),le=!1)};return()=>(le=!0,ce||n(),ce)}iS.getSourceType=function(C){return VM[C]},iS.setSourceType=function(C,te){VM[C]=te},iS.registerForPluginStateChange=function(C){return C({pluginStatus:rc,pluginURL:nc}),ac.on("pluginStateChange",C),C};class nS{constructor(C){this._hashName=C&&encodeURIComponent(C),j(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=rS(this._updateHashUnthrottled.bind(this),300)}addTo(C){return this._map=C,le.addEventListener("hashchange",this._onHashChange,!1),C.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),le.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const C=this._map;if(!C)return"";const te=oS(C);if(this._hashName){const C=this._hashName;let ce=!1;const he=le.location.hash.slice(1).split("&").map((le=>{const he=le.split("=")[0];return he===C?(ce=!0,`${he}=${te}`):le})).filter((C=>C));return ce||he.push(`${C}=${te}`),`#${he.join("&")}`}return`#${te}`}_getCurrentHash(){const C=le.location.hash.replace("#","");if(this._hashName){let te;return C.split("&").map((C=>C.split("="))).forEach((C=>{C[0]===this._hashName&&(te=C)})),(te&&te[1]||"").split("/")}return C.split("/")}_onHashChange(){const C=this._map;if(!C)return!1;const te=this._getCurrentHash();if(te.length>=3&&!te.some((C=>isNaN(C)))){const le=C.dragRotate.isEnabled()&&C.touchZoomRotate.isEnabled()?+(te[3]||0):C.getBearing();return C.jumpTo({center:[+te[2],+te[1]],zoom:+te[0],bearing:le,pitch:+(te[4]||0)}),!0}return!1}_updateHashUnthrottled(){const C=le.location.href.replace(/(#.+)?$/,this.getHashString());le.history.replaceState(le.history.state,null,C)}}function oS(C,te){const le=C.getCenter(),ce=Math.round(100*C.getZoom())/100,he=Math.ceil((ce*Math.LN2+Math.log(512/360/.5))/Math.LN10),ue=Math.pow(10,he),de=Math.round(le.lng*ue)/ue,_e=Math.round(le.lat*ue)/ue,ye=C.getBearing(),ve=C.getPitch();let Se=te?`/${de}/${_e}/${ce}`:`${ce}/${_e}/${de}`;return(ye||ve)&&(Se+="/"+Math.round(10*ye)/10),ve&&(Se+=`/${Math.round(ve)}`),Se}const TI={linearity:.3,easing:I(0,0,.3,1)},SI=k({deceleration:2500,maxSpeed:1400},TI),MI=k({deceleration:20,maxSpeed:1400},TI),EI=k({deceleration:1e3,maxSpeed:360},TI),AI=k({deceleration:1e3,maxSpeed:90},TI);class uS{constructor(C){this._map=C,this.clear()}clear(){this._inertiaBuffer=[]}record(C){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:bi.now(),settings:C})}_drainInertiaBuffer(){const C=this._inertiaBuffer,te=bi.now();for(;C.length>0&&te-C[0].time>160;)C.shift()}_onMoveEnd(C){if(this._map._prefersReducedMotion())return;if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const te={zoom:0,bearing:0,pitch:0,pan:new je(0,0),pinchAround:void 0,around:void 0};for(const{settings:C}of this._inertiaBuffer)te.zoom+=C.zoomDelta||0,te.bearing+=C.bearingDelta||0,te.pitch+=C.pitchDelta||0,C.panDelta&&te.pan._add(C.panDelta),C.around&&(te.around=C.around),C.pinchAround&&(te.pinchAround=C.pinchAround);const le=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,ce={};if(te.pan.mag()){const he=pS(te.pan.mag(),le,k({},SI,C||{}));ce.offset=te.pan.mult(he.amount/te.pan.mag()),ce.center=this._map.transform.center,dS(ce,he)}if(te.zoom){const C=pS(te.zoom,le,MI);ce.zoom=this._map.transform.zoom+C.amount,dS(ce,C)}if(te.bearing){const C=pS(te.bearing,le,EI);ce.bearing=this._map.transform.bearing+z(C.amount,-179,179),dS(ce,C)}if(te.pitch){const C=pS(te.pitch,le,AI);ce.pitch=this._map.transform.pitch+C.amount,dS(ce,C)}if(ce.zoom||ce.bearing){const C=void 0===te.pinchAround?te.around:te.pinchAround;ce.around=C?this._map.unproject(C):this._map.getCenter()}return this.clear(),ce.noMoveStart=!0,ce}}function dS(C,te){(!C.duration||C.duration<te.duration)&&(C.duration=te.duration,C.easing=te.easing)}function pS(C,te,le){const{maxSpeed:ce,linearity:he,deceleration:ue}=le,de=z(C*he/(te/1e3),-ce,ce),_e=Math.abs(de)/(ue*he);return{easing:le.easing,duration:1e3*_e,amount:de*(_e/2)}}class fS extends It{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(C,te,le,ce={}){const he=wt(te.getCanvasContainer(),le);super(C,k({point:he,lngLat:te.unproject(he),originalEvent:le},ce)),this._defaultPrevented=!1,this.target=te}}class mS extends It{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(C,te,le){const ce="touchend"===C?le.changedTouches:le.touches,he=Tt(te.getCanvasContainer(),ce),ue=he.map((C=>te.unproject(C))),de=he.reduce(((C,te,le,ce)=>C.add(te.div(ce.length))),new je(0,0));super(C,{points:he,point:de,lngLats:ue,lngLat:te.unproject(de),originalEvent:le}),this._defaultPrevented=!1}}class _S extends It{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(C,te,le){super(C,{originalEvent:le}),this._defaultPrevented=!1}}class gS{constructor(C,te){this._map=C,this._clickTolerance=te.clickTolerance}reset(){this._mousedownPos=void 0}wheel(C){return this._firePreventable(new _S(C.type,this._map,C))}mousedown(C,te){return this._mousedownPos=te,this._firePreventable(new fS(C.type,this._map,C))}mouseup(C){this._map.fire(new fS(C.type,this._map,C))}preclick(C){const te=k({},C);te.type="preclick",this._map.fire(new fS(te.type,this._map,te))}click(C,te){this._mousedownPos&&this._mousedownPos.dist(te)>=this._clickTolerance||(this.preclick(C),this._map.fire(new fS(C.type,this._map,C)))}dblclick(C){return this._firePreventable(new fS(C.type,this._map,C))}mouseover(C){this._map.fire(new fS(C.type,this._map,C))}mouseout(C){this._map.fire(new fS(C.type,this._map,C))}touchstart(C){return this._firePreventable(new mS(C.type,this._map,C))}touchmove(C){this._map.fire(new mS(C.type,this._map,C))}touchend(C){this._map.fire(new mS(C.type,this._map,C))}touchcancel(C){this._map.fire(new mS(C.type,this._map,C))}_firePreventable(C){if(this._map.fire(C),C.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class yS{constructor(C){this._map=C}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(C){this._map.fire(new fS(C.type,this._map,C))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new fS("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(C){this._delayContextMenu?this._contextMenuEvent=C:this._map.fire(new fS(C.type,this._map,C)),this._map.listens("contextmenu")&&C.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class xS{constructor(C,te){this._map=C,this._el=C.getCanvasContainer(),this._container=C.getContainer(),this._clickTolerance=te.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(C,te){this.isEnabled()&&C.shiftKey&&0===C.button&&(yt(),this._startPos=this._lastPos=te,this._active=!0)}mousemoveWindow(C,te){if(!this._active)return;const le=te,ce=this._startPos,he=this._lastPos;if(!ce||!he||he.equals(le)||!this._box&&le.dist(ce)<this._clickTolerance)return;this._lastPos=le,this._box||(this._box=pt("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",C));const ue=Math.min(ce.x,le.x),de=Math.max(ce.x,le.x),_e=Math.min(ce.y,le.y),ye=Math.max(ce.y,le.y);this._map._requestDomTask((()=>{this._box&&(this._box.style.transform=`translate(${ue}px,${_e}px)`,this._box.style.width=de-ue+"px",this._box.style.height=ye-_e+"px")}))}mouseupWindow(C,te){if(!this._active)return;const le=this._startPos,ce=te;if(le&&0===C.button){if(this.reset(),bt(),le.x!==ce.x||le.y!==ce.y)return this._map.fire(new It("boxzoomend",{originalEvent:C})),{cameraAnimation:C=>C.fitScreenCoordinates(le,ce,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",C)}}keydown(C){this._active&&27===C.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",C))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),xt(),delete this._startPos,delete this._lastPos}_fireEvent(C,te){return this._map.fire(new It(C,{originalEvent:te}))}}function vS(C,te){const le={};for(let ce=0;ce<C.length;ce++)le[C[ce].identifier]=te[ce];return le}class bS{constructor(C){this.reset(),this.numTouches=C.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(C,te,le){(this.centroid||le.length>this.numTouches)&&(this.aborted=!0),this.aborted||(0===this.startTime&&(this.startTime=C.timeStamp),le.length===this.numTouches&&(this.centroid=function(C){const te=new je(0,0);for(const le of C)te._add(le);return te.div(C.length)}(te),this.touches=vS(le,te)))}touchmove(C,te,le){if(this.aborted||!this.centroid)return;const ce=vS(le,te);for(const C in this.touches){const te=ce[C];(!te||te.dist(this.touches[C])>30)&&(this.aborted=!0)}}touchend(C,te,le){if((!this.centroid||C.timeStamp-this.startTime>500)&&(this.aborted=!0),0===le.length){const C=!this.aborted&&this.centroid;if(this.reset(),C)return C}}}class wS{constructor(C){this.singleTap=new bS(C),this.numTaps=C.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(C,te,le){this.singleTap.touchstart(C,te,le)}touchmove(C,te,le){this.singleTap.touchmove(C,te,le)}touchend(C,te,le){const ce=this.singleTap.touchend(C,te,le);if(ce){const te=C.timeStamp-this.lastTime<500,le=!this.lastTap||this.lastTap.dist(ce)<30;if(te&&le||this.reset(),this.count++,this.lastTime=C.timeStamp,this.lastTap=ce,this.count===this.numTaps)return this.reset(),ce}}}class TS{constructor(){this._zoomIn=new wS({numTouches:1,numTaps:2}),this._zoomOut=new wS({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(C,te,le){this._zoomIn.touchstart(C,te,le),this._zoomOut.touchstart(C,te,le)}touchmove(C,te,le){this._zoomIn.touchmove(C,te,le),this._zoomOut.touchmove(C,te,le)}touchend(C,te,le){const ce=this._zoomIn.touchend(C,te,le),he=this._zoomOut.touchend(C,te,le);return ce?(this._active=!0,C.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:te=>te.easeTo({duration:300,zoom:te.getZoom()+1,around:te.unproject(ce)},{originalEvent:C})}):he?(this._active=!0,C.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:te=>te.easeTo({duration:300,zoom:te.getZoom()-1,around:te.unproject(he)},{originalEvent:C})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const II={0:1,2:2};class MS{constructor(C){this.reset(),this._clickTolerance=C.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(C,te){return!1}_move(C,te){return{}}mousedown(C,te){if(this._lastPoint)return;const le=Et(C);this._correctButton(C,le)&&(this._lastPoint=te,this._eventButton=le)}mousemoveWindow(C,te){const le=this._lastPoint;if(le)if(C.preventDefault(),null!=this._eventButton&&function(C,te){const le=II[te];return void 0===C.buttons||(C.buttons&le)!==le}(C,this._eventButton))this.reset();else if(this._moved||!(te.dist(le)<this._clickTolerance))return this._moved=!0,this._lastPoint=te,this._move(le,te)}mouseupWindow(C){this._lastPoint&&Et(C)===this._eventButton&&(this._moved&&bt(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class AS extends MS{mousedown(C,te){super.mousedown(C,te),this._lastPoint&&(this._active=!0)}_correctButton(C,te){return 0===te&&!C.ctrlKey}_move(C,te){return{around:te,panDelta:te.sub(C)}}}class SS extends MS{_correctButton(C,te){return 0===te&&C.ctrlKey||2===te}_move(C,te){const le=.8*(te.x-C.x);if(le)return this._active=!0,{bearingDelta:le}}contextmenu(C){C.preventDefault()}}class IS extends MS{_correctButton(C,te){return 0===te&&C.ctrlKey||2===te}_move(C,te){const le=-.5*(te.y-C.y);if(le)return this._active=!0,{pitchDelta:le}}contextmenu(C){C.preventDefault()}}class CS{constructor(C,te){this._map=C,this._el=C.getCanvasContainer(),this._minTouches=1,this._clickTolerance=te.clickTolerance||1,this.reset(),j(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new je(0,0)}touchstart(C,te,le){return this._calculateTransform(C,te,le)}touchmove(C,te,le){if(this._active&&!(le.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(1===le.length&&!ie())return void this._showTouchPanBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return C.cancelable&&C.preventDefault(),this._calculateTransform(C,te,le)}}touchend(C,te,le){this._calculateTransform(C,te,le),this._active&&le.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(C,te,le){le.length>0&&(this._active=!0);const ce=vS(le,te),he=new je(0,0),ue=new je(0,0);let de=0;for(const C in ce){const te=ce[C],le=this._touches[C];le&&(he._add(te),ue._add(te.sub(le)),de++,ce[C]=te)}if(this._touches=ce,de<this._minTouches||!ue.mag())return;const _e=ue.div(de);return this._sum._add(_e),this._sum.mag()<this._clickTolerance?void 0:{around:he.div(de),panDelta:_e}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=pt("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","null")}),500)}}class zS{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(C){}_move(C,te,le){return{}}touchstart(C,te,le){this._firstTwoTouches||le.length<2||(this._firstTwoTouches=[le[0].identifier,le[1].identifier],this._start([te[0],te[1]]))}touchmove(C,te,le){const ce=this._firstTwoTouches;if(!ce)return;C.preventDefault();const[he,ue]=ce,de=PS(le,te,he),_e=PS(le,te,ue);if(!de||!_e)return;const ye=this._aroundCenter?null:de.add(_e).div(2);return this._move([de,_e],ye,C)}touchend(C,te,le){if(!this._firstTwoTouches)return;const[ce,he]=this._firstTwoTouches,ue=PS(le,te,ce),de=PS(le,te,he);ue&&de||(this._active&&bt(),this.reset())}touchcancel(){this.reset()}enable(C){this._enabled=!0,this._aroundCenter=!!C&&"center"===C.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function PS(C,te,le){for(let ce=0;ce<C.length;ce++)if(C[ce].identifier===le)return te[ce]}function DS(C,te){return Math.log(C/te)/Math.LN2}class RS extends zS{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(C){this._startDistance=this._distance=C[0].dist(C[1])}_move(C,te){const le=this._distance;if(this._distance=C[0].dist(C[1]),this._active||!(Math.abs(DS(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:DS(this._distance,le),pinchAround:te}}}function LS(C,te){return 180*C.angleWith(te)/Math.PI}class kS extends zS{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(C){this._startVector=this._vector=C[0].sub(C[1]),this._minDiameter=C[0].dist(C[1])}_move(C,te){const le=this._vector;if(this._vector=C[0].sub(C[1]),le&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:LS(this._vector,le),pinchAround:te}}_isBelowThreshold(C){this._minDiameter=Math.min(this._minDiameter,C.mag());const te=25/(Math.PI*this._minDiameter)*360,le=this._startVector;if(!le)return!1;const ce=LS(C,le);return Math.abs(ce)<te}}function OS(C){return Math.abs(C.y)>Math.abs(C.x)}class BS extends zS{constructor(C){super(),this._map=C}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(C){this._lastPoints=C,OS(C[0].sub(C[1]))&&(this._valid=!1)}_move(C,te,le){const ce=this._lastPoints;if(!ce)return;const he=C[0].sub(ce[0]),ue=C[1].sub(ce[1]);return this._map._cooperativeGestures&&!ie()&&le.touches.length<3||(this._valid=this.gestureBeginsVertically(he,ue,le.timeStamp),!this._valid)?void 0:(this._lastPoints=C,this._active=!0,{pitchDelta:(he.y+ue.y)/2*-.5})}gestureBeginsVertically(C,te,le){if(void 0!==this._valid)return this._valid;const ce=C.mag()>=2,he=te.mag()>=2;if(!ce&&!he)return;if(!ce||!he)return null==this._firstMove&&(this._firstMove=le),le-this._firstMove<100&&void 0;const ue=C.y>0==te.y>0;return OS(C)&&OS(te)&&ue}}const CI={panStep:100,bearingStep:15,pitchStep:10};class NS{constructor(){const C=CI;this._panStep=C.panStep,this._bearingStep=C.bearingStep,this._pitchStep=C.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(C){if(C.altKey||C.ctrlKey||C.metaKey)return;let te=0,le=0,ce=0,he=0,ue=0;switch(C.keyCode){case 61:case 107:case 171:case 187:te=1;break;case 189:case 109:case 173:te=-1;break;case 37:C.shiftKey?le=-1:(C.preventDefault(),he=-1);break;case 39:C.shiftKey?le=1:(C.preventDefault(),he=1);break;case 38:C.shiftKey?ce=1:(C.preventDefault(),ue=-1);break;case 40:C.shiftKey?ce=-1:(C.preventDefault(),ue=1);break;default:return}return this._rotationDisabled&&(le=0,ce=0),{cameraAnimation:de=>{const _e=de.getZoom();de.easeTo({duration:300,easeId:"keyboardHandler",easing:US,zoom:te?Math.round(_e)+te*(C.shiftKey?2:1):_e,bearing:de.getBearing()+le*this._bearingStep,pitch:de.getPitch()+ce*this._pitchStep,offset:[-he*this._panStep,-ue*this._panStep],center:de.getCenter()},{originalEvent:C})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function US(C){return C*(2-C)}const zI=4.000244140625;class jS{constructor(C,te){this._map=C,this._el=C.getCanvasContainer(),this._handler=te,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,j(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(C){this._defaultZoomRate=C}setWheelZoomRate(C){this._wheelZoomRate=C}isEnabled(){return!!this._enabled}isActive(){return this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(C){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!C&&"center"===C.around,this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(C){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(C.ctrlKey||C.metaKey||this.isZooming()||ie()))return void this._showBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let te=C.deltaMode===le.WheelEvent.DOM_DELTA_LINE?40*C.deltaY:C.deltaY;const ce=bi.now(),he=ce-(this._lastWheelEventTime||0);this._lastWheelEventTime=ce,0!==te&&te%zI==0?this._type="wheel":0!==te&&Math.abs(te)<4?this._type="trackpad":he>400?(this._type=null,this._lastValue=te,this._timeout=setTimeout(this._onTimeout,40,C)):this._type||(this._type=Math.abs(he*te)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,te+=this._lastValue)),C.shiftKey&&te&&(te/=4),this._type&&(this._lastWheelEvent=C,this._delta-=te,this._active||this._start(C)),C.preventDefault()}_onTimeout(C){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(C)}_start(C){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const te=wt(this._el,C);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:te,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId)return;if(this._frameId=null,!this.isActive())return;const C=this._map.transform;"wheel"===this._type&&C.projection.wrap&&(C._center.lng>=180||C._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const t=()=>C._terrainEnabled()&&this._aroundCoord?C.computeZoomRelativeTo(this._aroundCoord):C.zoom;if(0!==this._delta){const te="wheel"===this._type&&Math.abs(this._delta)>zI?this._wheelZoomRate:this._defaultZoomRate;let le=2/(1+Math.exp(-Math.abs(this._delta*te)));this._delta<0&&0!==le&&(le=1/le);const ce=t(),he=Math.pow(2,ce),ue="number"==typeof this._targetZoom?C.zoomScale(this._targetZoom):he;this._targetZoom=Math.min(C.maxZoom,Math.max(C.minZoom,C.scaleZoom(ue*le))),"wheel"===this._type&&(this._startZoom=ce,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const te="number"==typeof this._targetZoom?this._targetZoom:t(),le=this._startZoom,ce=this._easing;let he,ue=!1;if("wheel"===this._type&&le&&ce){const C=Math.min((bi.now()-this._lastWheelEventTime)/200,1);he=Kr(le,te,ce(C)),C<1?this._frameId||(this._frameId=!0):ue=!0}else he=te,ue=!0;this._active=!0,ue&&(this._active=!1,this._finishTimeout=setTimeout((()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout}),200));let de=he-t();return de*this._lastDelta<0&&(de=0),{noInertia:!0,needsRenderFrame:!ue,zoomDelta:de,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(C){let te=$e;if(this._prevEase){const C=this._prevEase,le=(bi.now()-C.start)/C.duration,ce=C.easing(le+.01)-C.easing(le),he=.27/Math.sqrt(ce*ce+1e-4)*.01;te=I(he,Math.sqrt(.0729-he*he),.25,1)}return this._prevEase={start:bi.now(),duration:C,easing:te},te}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=pt("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(le.navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","null")}),200)}}class GS{constructor(C,te){this._clickZoom=C,this._tapZoom=te}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class qS{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(C,te){return C.preventDefault(),{cameraAnimation:le=>{le.easeTo({duration:300,zoom:le.getZoom()+(C.shiftKey?-1:1),around:le.unproject(te)},{originalEvent:C})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class ZS{constructor(){this._tap=new wS({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(C,te,le){this._swipePoint||(this._tapTime&&C.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?le.length>0&&(this._swipePoint=te[0],this._swipeTouch=le[0].identifier):this._tap.touchstart(C,te,le))}touchmove(C,te,le){if(this._tapTime){if(this._swipePoint){if(le[0].identifier!==this._swipeTouch)return;const ce=te[0],he=ce.y-this._swipePoint.y;return this._swipePoint=ce,C.preventDefault(),this._active=!0,{zoomDelta:he/128}}}else this._tap.touchmove(C,te,le)}touchend(C,te,le){this._tapTime?this._swipePoint&&0===le.length&&this.reset():this._tap.touchend(C,te,le)&&(this._tapTime=C.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class $S{constructor(C,te,le){this._el=C,this._mousePan=te,this._touchPan=le}enable(C){this._inertiaOptions=C||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class WS{constructor(C,te,le){this._pitchWithRotate=C.pitchWithRotate,this._mouseRotate=te,this._mousePitch=le}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class HS{constructor(C,te,le,ce){this._el=C,this._touchZoom=te,this._touchRotate=le,this._tapDragZoom=ce,this._rotationDisabled=!1,this._enabled=!0}enable(C){this._touchZoom.enable(C),this._rotationDisabled||this._touchRotate.enable(C),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const XS=C=>C.zoom||C.drag||C.pitch||C.rotate;class YS extends It{}class KS{constructor(){this.constants=[1,1,.01],this.radius=0}setup(C,te){const le=Zd.sub([],te,C);this.radius=Zd.length(le[2]<0?Zd.div([],le,this.constants):[le[0],le[1],0])}projectRay(C){Zd.div(C,C,this.constants),Zd.normalize(C,C),Zd.mul(C,C,this.constants);const te=Zd.scale([],C,this.radius);if(te[2]>0){const C=Zd.scale([],[0,0,1],Zd.dot(te,[0,0,1])),le=Zd.scale([],Zd.normalize([],[te[0],te[1],0]),this.radius),ce=Zd.add([],te,Zd.scale([],Zd.sub([],Zd.add([],le,C),te),2));te[0]=ce[0],te[1]=ce[1]}return te}}function JS(C){return C.panDelta&&C.panDelta.mag()||C.zoomDelta||C.bearingDelta||C.pitchDelta}class QS{constructor(C,te){this._map=C,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new uS(C),this._bearingSnap=te.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new KS,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(te),j(["handleEvent","handleWindowEvent"],this);const ce=this._el;this._listeners=[[ce,"touchstart",{passive:!0}],[ce,"touchmove",{passive:!1}],[ce,"touchend",void 0],[ce,"touchcancel",void 0],[ce,"mousedown",void 0],[ce,"mousemove",void 0],[ce,"mouseup",void 0],[le.document,"mousemove",{capture:!0}],[le.document,"mouseup",void 0],[ce,"mouseover",void 0],[ce,"mouseout",void 0],[ce,"dblclick",void 0],[ce,"click",void 0],[ce,"keydown",{capture:!1}],[ce,"keyup",void 0],[ce,"wheel",{passive:!1}],[ce,"contextmenu",void 0],[le,"blur",void 0]];for(const[C,te,ce]of this._listeners)C.addEventListener(te,C===le.document?this.handleWindowEvent:this.handleEvent,ce)}destroy(){for(const[C,te,ce]of this._listeners)C.removeEventListener(te,C===le.document?this.handleWindowEvent:this.handleEvent,ce)}_addDefaultHandlers(C){const te=this._map,le=te.getCanvasContainer();this._add("mapEvent",new gS(te,C));const ce=te.boxZoom=new xS(te,C);this._add("boxZoom",ce);const he=new TS,ue=new qS;te.doubleClickZoom=new GS(ue,he),this._add("tapZoom",he),this._add("clickZoom",ue);const de=new ZS;this._add("tapDragZoom",de);const _e=te.touchPitch=new BS(te);this._add("touchPitch",_e);const ye=new SS(C),ve=new IS(C);te.dragRotate=new WS(C,ye,ve),this._add("mouseRotate",ye,["mousePitch"]),this._add("mousePitch",ve,["mouseRotate"]);const Se=new AS(C),Me=new CS(te,C);te.dragPan=new $S(le,Se,Me),this._add("mousePan",Se),this._add("touchPan",Me,["touchZoom","touchRotate"]);const Ae=new kS,Ce=new RS;te.touchZoomRotate=new HS(le,Ce,Ae,de),this._add("touchRotate",Ae,["touchPan","touchZoom"]),this._add("touchZoom",Ce,["touchPan","touchRotate"]),this._add("blockableMapEvent",new yS(te));const Oe=te.scrollZoom=new jS(te,this);this._add("scrollZoom",Oe,["mousePan"]);const Ne=te.keyboard=new NS;this._add("keyboard",Ne);for(const le of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])C.interactive&&C[le]&&te[le].enable(C[le])}_add(C,te,le){this._handlers.push({handlerName:C,handler:te,allowed:le}),this._handlersById[C]=te}stop(C){if(!this._updatingCamera){for(const{handler:C}of this._handlers)C.reset();this._inertia.clear(),this._fireEvents({},{},C),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:C}of this._handlers)if(C.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!XS(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(C,te,le){for(const ce in C)if(ce!==le&&(!te||te.indexOf(ce)<0))return!0;return!1}handleWindowEvent(C){this.handleEvent(C,`${C.type}Window`)}_getMapTouches(C){const te=[];for(const le of C)this._el.contains(le.target)&&te.push(le);return te}handleEvent(C,te){this._updatingCamera=!0;const le="renderFrame"===C.type,ce=le?void 0:C,he={needsRenderFrame:!1},ue={},de={},_e=C.touches?this._getMapTouches(C.touches):void 0,ye=_e?Tt(this._el,_e):le?void 0:wt(this._el,C);for(const{handlerName:le,handler:ve,allowed:Se}of this._handlers){if(!ve.isEnabled())continue;let Me;this._blockedByActive(de,Se,le)?ve.reset():ve[te||C.type]&&(Me=ve[te||C.type](C,ye,_e),this.mergeHandlerResult(he,ue,Me,le,ce),Me&&Me.needsRenderFrame&&this._triggerRenderFrame()),(Me||ve.isActive())&&(de[le]=ve)}const ve={};for(const C in this._previousActiveHandlers)de[C]||(ve[C]=ce);this._previousActiveHandlers=de,(Object.keys(ve).length||JS(he))&&(this._changes.push([he,ue,ve]),this._triggerRenderFrame()),(Object.keys(de).length||JS(he))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:Se}=he;Se&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],Se(this._map))}mergeHandlerResult(C,te,le,ce,he){if(!le)return;k(C,le);const ue={handlerName:ce,originalEvent:le.originalEvent||he};void 0!==le.zoomDelta&&(te.zoom=ue),void 0!==le.panDelta&&(te.drag=ue),void 0!==le.pitchDelta&&(te.pitch=ue),void 0!==le.bearingDelta&&(te.rotate=ue)}_applyChanges(){const C={},te={},le={};for(const[ce,he,ue]of this._changes)ce.panDelta&&(C.panDelta=(C.panDelta||new je(0,0))._add(ce.panDelta)),ce.zoomDelta&&(C.zoomDelta=(C.zoomDelta||0)+ce.zoomDelta),ce.bearingDelta&&(C.bearingDelta=(C.bearingDelta||0)+ce.bearingDelta),ce.pitchDelta&&(C.pitchDelta=(C.pitchDelta||0)+ce.pitchDelta),void 0!==ce.around&&(C.around=ce.around),void 0!==ce.aroundCoord&&(C.aroundCoord=ce.aroundCoord),void 0!==ce.pinchAround&&(C.pinchAround=ce.pinchAround),ce.noInertia&&(C.noInertia=ce.noInertia),k(te,he),k(le,ue);this._updateMapTransform(C,te,le),this._changes=[]}_updateMapTransform(C,te,le){const ce=this._map,he=ce.transform,o=C=>[C.x,C.y,C.z];if((C=>{const te=this._eventsInProgress.drag;return te&&!this._handlersById[te.handlerName].isActive()})()&&!JS(C)){const C=he.zoom;he.cameraElevationReference="sea",null!=this._originalZoom&&he._orthographicProjectionAtLowPitch&&"globe"!==he.projection.name&&0===he.pitch?(he.cameraElevationReference="ground",he.zoom=this._originalZoom):(he.recenterOnTerrain(),he.cameraElevationReference="ground"),C!==he.zoom&&this._map._update(!0)}if(he._isCameraConstrained&&ce._stop(!0),!JS(C))return void this._fireEvents(te,le,!0);let{panDelta:ue,zoomDelta:de,bearingDelta:_e,pitchDelta:ye,around:ve,aroundCoord:Se,pinchAround:Me}=C;he._isCameraConstrained&&(de>0&&(de=0),he._isCameraConstrained=!1),void 0!==Me&&(ve=Me),(de||(C=>te[C]&&!this._eventsInProgress[C])("drag"))&&ve&&(this._dragOrigin=o(he.pointCoordinate3D(ve)),this._originalZoom=he.zoom,this._trackingEllipsoid.setup(he._camera.position,this._dragOrigin)),he.cameraElevationReference="sea",ce._stop(!0),ve=ve||ce.transform.centerPoint,_e&&(he.bearing+=_e),ye&&(he.pitch+=ye),he._updateCameraState();const Ae=[0,0,0];if(ue)if("mercator"===he.projection.name){const C=this._trackingEllipsoid.projectRay(he.screenPointToMercatorRay(ve).dir),te=this._trackingEllipsoid.projectRay(he.screenPointToMercatorRay(ve.sub(ue)).dir);Ae[0]=te[0]-C[0],Ae[1]=te[1]-C[1]}else{const C=he.pointCoordinate(ve);if("globe"===he.projection.name){ue=ue.rotate(-he.angle);const te=he._pixelsPerMercatorPixel/he.worldSize;Ae[0]=-ue.x*sp(tp(C.y))*te,Ae[1]=-ue.y*sp(he.center.lat)*te}else{const te=he.pointCoordinate(ve.sub(ue));C&&te&&(Ae[0]=te.x-C.x,Ae[1]=te.y-C.y)}}const Ce=he.zoom,Oe=[0,0,0];if(de){const C=o(Se||he.pointCoordinate3D(ve)),te={dir:Zd.normalize([],Zd.sub([],C,he._camera.position))};if(te.dir[2]<0){const le=he.zoomDeltaToMovement(C,de);Zd.scale(Oe,te.dir,le)}}const Ne=Zd.add(Ae,Ae,Oe);he._translateCameraConstrained(Ne),de&&Math.abs(he.zoom-Ce)>1e-4&&he.recenterOnTerrain(),he.cameraElevationReference="ground",this._map._update(),C.noInertia||this._inertia.record(C),this._fireEvents(te,le,!0)}_fireEvents(C,te,le){const ce=XS(this._eventsInProgress),he=XS(C),ue={};for(const te in C){const{originalEvent:le}=C[te];this._eventsInProgress[te]||(ue[`${te}start`]=le),this._eventsInProgress[te]=C[te]}!ce&&he&&this._fireEvent("movestart",he.originalEvent);for(const C in ue)this._fireEvent(C,ue[C]);he&&this._fireEvent("move",he.originalEvent);for(const te in C){const{originalEvent:le}=C[te];this._fireEvent(te,le)}const de={};let _e;for(const C in this._eventsInProgress){const{handlerName:le,originalEvent:ce}=this._eventsInProgress[C];this._handlersById[le].isActive()||(delete this._eventsInProgress[C],_e=te[le]||ce,de[`${C}end`]=_e)}for(const C in de)this._fireEvent(C,de[C]);const ye=XS(this._eventsInProgress);if(le&&(ce||he)&&!ye){this._updatingCamera=!0;const C=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),t=C=>0!==C&&-this._bearingSnap<C&&C<this._bearingSnap;C?(t(C.bearing||this._map.getBearing())&&(C.bearing=0),this._map.easeTo(C,{originalEvent:_e})):(this._map.fire(new It("moveend",{originalEvent:_e})),t(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(C,te){this._map.fire(new It(C,te?{originalEvent:te}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((C=>{this._frameId=void 0,this.handleEvent(new YS("renderFrame",{timeStamp:C})),this._applyChanges()}))}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}}const DI="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class tI extends zt{constructor(C,te){super(),this._moving=!1,this._zooming=!1,this.transform=C,this._bearingSnap=te.bearingSnap,this._respectPrefersReducedMotion=!1!==te.respectPrefersReducedMotion,j(["_renderFrameCallback"],this)}getCenter(){return new $f(this.transform.center.lng,this.transform.center.lat)}setCenter(C,te){return this.jumpTo({center:C},te)}panBy(C,te,le){return C=je.convert(C).mult(-1),this.panTo(this.transform.center,k({offset:C},te),le)}panTo(C,te,le){return this.easeTo(k({center:C},te),le)}getZoom(){return this.transform.zoom}setZoom(C,te){return this.jumpTo({zoom:C},te),this}zoomTo(C,te,le){return this.easeTo(k({zoom:C},te),le)}zoomIn(C,te){return this.zoomTo(this.getZoom()+1,C,te),this}zoomOut(C,te){return this.zoomTo(this.getZoom()-1,C,te),this}getBearing(){return this.transform.bearing}setBearing(C,te){return this.jumpTo({bearing:C},te),this}getPadding(){return this.transform.padding}setPadding(C,te){return this.jumpTo({padding:C},te),this}rotateTo(C,te,le){return this.easeTo(k({bearing:C},te),le)}resetNorth(C,te){return this.rotateTo(0,k({duration:1e3},C),te),this}resetNorthPitch(C,te){return this.easeTo(k({bearing:0,pitch:0,duration:1e3},C),te),this}snapToNorth(C,te){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(C,te):this}getPitch(){return this.transform.pitch}setPitch(C,te){return this.jumpTo({pitch:C},te),this}cameraForBounds(C,te){C=sc.convert(C);const le=te&&te.bearing||0,ce=te&&te.pitch||0,he=C.getNorthWest(),ue=C.getSouthEast();return this._cameraForBounds(this.transform,he,ue,le,ce,te)}_extendCameraOptions(C){const te={top:0,bottom:0,right:0,left:0};if("number"==typeof(C=k({padding:te,offset:[0,0],maxZoom:this.transform.maxZoom},C)).padding){const te=C.padding;C.padding={top:te,bottom:te,right:te,left:te}}return C.padding=k(te,C.padding),C}_minimumAABBFrustumDistance(C,te){const le=te.max[0]-te.min[0],ce=te.max[1]-te.min[1];return le/ce>C.aspect?le/(2*Math.tan(.5*C.fovX)*C.aspect):ce/(2*Math.tan(.5*C.fovY)*C.aspect)}_cameraForBoundsOnGlobe(C,te,le,ce,he,ue){const de=C.clone(),_e=this._extendCameraOptions(ue);de.bearing=ce,de.pitch=he;const ye=$f.convert(te),ve=$f.convert(le),Se=.5*(ye.lat+ve.lat),Me=.5*(ye.lng+ve.lng),Ae=wd(Se,Me),Ce=Zd.normalize([],Ae),Oe=Zd.normalize([],Zd.cross([],Ce,[0,1,0])),Ne=Zd.cross([],Oe,Ce),je=[Oe[0],Oe[1],Oe[2],0,Ne[0],Ne[1],Ne[2],0,Ce[0],Ce[1],Ce[2],0,0,0,0,1],Ge=[Ae,wd(ye.lat,ye.lng),wd(ve.lat,ye.lng),wd(ve.lat,ve.lng),wd(ye.lat,ve.lng),wd(Se,ye.lng),wd(Se,ve.lng),wd(ye.lat,Me),wd(ve.lat,Me)];let Ze=ed.fromPoints(Ge.map((C=>[Zd.dot(Oe,C),Zd.dot(Ne,C),Zd.dot(Ce,C)])));const qe=Zd.transformMat4([],Ze.center,je);0===Zd.squaredLength(qe)&&Zd.set(qe,0,0,1),Zd.normalize(qe,qe),Zd.scale(qe,qe,$p),de.center=function([C,te,le]){const ce=Math.hypot(C,te,le),he=Math.atan2(C,le),ue=.5*Math.PI-Math.acos(-te/ce);return new $f(T(he),T(ue))}(qe);const $e=de.getWorldToCameraMatrix(),He=ld.invert(new Float64Array(16),$e);Ze=ed.applyTransform(Ze,ld.multiply([],$e,je)),Zd.transformMat4(qe,qe,$e);const We=.5*(Ze.max[2]-Ze.min[2]),Xe=this._minimumAABBFrustumDistance(de,Ze),Ye=Zd.scale([],[0,0,1],We),Je=Zd.add(Ye,qe,Ye),Qe=Xe+(0===de.pitch?0:Zd.distance(qe,Je)),tt=de.globeCenterInViewSpace,rt=Zd.sub([],qe,[tt[0],tt[1],tt[2]]);Zd.normalize(rt,rt),Zd.scale(rt,rt,Qe);const ot=Zd.add([],qe,rt);Zd.transformMat4(ot,ot,He);const st=Zf/$p,at=Zd.length(ot),lt=Qd(Math.max(at*st-Zf,Number.EPSILON),0),ct=Math.min(de.zoomFromMercatorZAdjusted(lt),_e.maxZoom);return ct>.5*(Up+Vp)?(de.setProjection({name:"mercator"}),de.zoom=ct,this._cameraForBounds(de,te,le,ce,he,ue)):{center:de.center,zoom:ct,bearing:ce,pitch:he}}queryTerrainElevation(C,te){const le=this.transform.elevation;return le?(te=k({},{exaggerated:!0},te),le.getAtPoint(lp.fromLngLat(C),null,te.exaggerated)):null}_cameraForBounds(C,te,le,ce,he,ue){if("globe"===C.projection.name)return this._cameraForBoundsOnGlobe(C,te,le,ce,he,ue);const de=C.clone(),_e=this._extendCameraOptions(ue),ye=de.padding;de.bearing=ce,de.pitch=he;const ve=$f.convert(te),Se=$f.convert(le),Me=new $f(ve.lng,Se.lat),Ae=new $f(Se.lng,ve.lat),Ce=de.project(ve),Oe=de.project(Se),Ne=this.queryTerrainElevation(ve),Ge=this.queryTerrainElevation(Se),Ze=this.queryTerrainElevation(Me),qe=this.queryTerrainElevation(Ae),$e=[[Ce.x,Ce.y,Math.min(Ne||0,Ge||0,Ze||0,qe||0)],[Oe.x,Oe.y,Math.max(Ne||0,Ge||0,Ze||0,qe||0)]];let He=ed.fromPoints($e);const We=de.getWorldToCameraMatrix(),Xe=ld.invert(new Float64Array(16),We);He=ed.applyTransform(He,We);const Ye=Zd.sub([],He.max,He.min),Je=ye.left||0,Qe=ye.right||0,tt=ye.bottom||0,rt=ye.top||0,{left:ot,right:st,top:at,bottom:lt}=_e.padding,ct=.5*(Je+Qe),ht=.5*(rt+tt),dt=Math.min(de.scaleZoom(de.scale*Math.min((de.width-(Je+Qe+ot+st))/Ye[0],(de.height-(tt+rt+lt+at))/Ye[1])),_e.maxZoom),mt=de.scale/de.zoomScale(dt);He=new ed([He.min[0]-(ot+ct)*mt,He.min[1]-(lt+ht)*mt,He.min[2]],[He.max[0]+(st+ct)*mt,He.max[1]+(at+ht)*mt,He.max[2]]);const _t=.5*Ye[2],gt=this._minimumAABBFrustumDistance(de,He),Pt=[0,0,1,0];$u.transformMat4(Pt,Pt,We),$u.normalize(Pt,Pt);const Ft=Zd.scale([],Pt,gt+_t),jt=Zd.add([],He.center,Ft),Ut=("number"==typeof _e.offset.x&&"number"==typeof _e.offset.y?new je(_e.offset.x,_e.offset.y):je.convert(_e.offset)).rotate(-w(ce));He.center[0]-=Ut.x*mt,He.center[1]+=Ut.y*mt,Zd.transformMat4(He.center,He.center,Xe),Zd.transformMat4(jt,jt,Xe);const Vt=[He.center[0],He.center[1],jt[2]*de.pixelsPerMeter];Zd.scale(Vt,Vt,1/de.worldSize);const Gt=ep(Vt[0]),Zt=tp(Vt[1]),qt=Math.min(de._zoomFromMercatorZ(Vt[2]),_e.maxZoom),$t=new $f(Gt,Zt);return de.mercatorFromTransition&&qt<.5*(Up+Vp)?(de.setProjection({name:"globe"}),de.zoom=qt,this._cameraForBounds(de,te,le,ce,he,ue)):{center:$t,zoom:qt,bearing:ce,pitch:he}}fitBounds(C,te,le){const ce=this.cameraForBounds(C,te);return this._fitInternal(ce,te,le)}fitScreenCoordinates(C,te,le,ce,he){const ue=je.convert(C),de=je.convert(te),_e=new je(Math.min(ue.x,de.x),Math.min(ue.y,de.y)),ye=new je(Math.max(ue.x,de.x),Math.max(ue.y,de.y));if("mercator"===this.transform.projection.name&&this.transform.anyCornerOffEdge(ue,de))return this;const ve=this.transform.pointLocation3D(_e),Se=this.transform.pointLocation3D(ye),Me=this.transform.pointLocation3D(new je(_e.x,ye.y)),Ae=this.transform.pointLocation3D(new je(ye.x,_e.y)),Ce=[Math.min(ve.lng,Se.lng,Me.lng,Ae.lng),Math.min(ve.lat,Se.lat,Me.lat,Ae.lat)],Oe=[Math.max(ve.lng,Se.lng,Me.lng,Ae.lng),Math.max(ve.lat,Se.lat,Me.lat,Ae.lat)],Ne=ce&&ce.pitch?ce.pitch:this.getPitch(),Ge=this._cameraForBounds(this.transform,Ce,Oe,le,Ne,ce);return this._fitInternal(Ge,ce,he)}_fitInternal(C,te,le){return C?(delete(te=k(C,te)).padding,te.linear?this.easeTo(te,le):this.flyTo(te,le)):this}jumpTo(C,te){this.stop();const le=C.preloadOnly?this.transform.clone():this.transform;let ce=!1,he=!1,ue=!1;return"zoom"in C&&le.zoom!==+C.zoom&&(ce=!0,le.zoom=+C.zoom),void 0!==C.center&&(le.center=$f.convert(C.center)),"bearing"in C&&le.bearing!==+C.bearing&&(he=!0,le.bearing=+C.bearing),"pitch"in C&&le.pitch!==+C.pitch&&(ue=!0,le.pitch=+C.pitch),null==C.padding||le.isPaddingEqual(C.padding)||(le.padding=C.padding),C.preloadOnly?(this._preloadTiles(le),this):(this.fire(new It("movestart",te)).fire(new It("move",te)),ce&&this.fire(new It("zoomstart",te)).fire(new It("zoom",te)).fire(new It("zoomend",te)),he&&this.fire(new It("rotatestart",te)).fire(new It("rotate",te)).fire(new It("rotateend",te)),ue&&this.fire(new It("pitchstart",te)).fire(new It("pitch",te)).fire(new It("pitchend",te)),this.fire(new It("moveend",te)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||H(DI),this.transform.getFreeCameraOptions()}setFreeCameraOptions(C,te){const le=this.transform;if(!le.projection.supportsFreeCamera)return H(DI),this;this.stop();const ce=le.zoom,he=le.pitch,ue=le.bearing;le.setFreeCameraOptions(C);const de=ce!==le.zoom,_e=he!==le.pitch,ye=ue!==le.bearing;return this.fire(new It("movestart",te)).fire(new It("move",te)),de&&this.fire(new It("zoomstart",te)).fire(new It("zoom",te)).fire(new It("zoomend",te)),ye&&this.fire(new It("rotatestart",te)).fire(new It("rotate",te)).fire(new It("rotateend",te)),_e&&this.fire(new It("pitchstart",te)).fire(new It("pitch",te)).fire(new It("pitchend",te)),this.fire(new It("moveend",te)),this}easeTo(C,te){this._stop(!1,C.easeId),(!1===(C=k({offset:[0,0],duration:500,easing:$e},C)).animate||this._prefersReducedMotion(C))&&(C.duration=0);const le=this.transform,ce=this.getZoom(),he=this.getBearing(),ue=this.getPitch(),de=this.getPadding(),_e="zoom"in C?+C.zoom:ce,ye="bearing"in C?this._normalizeBearing(C.bearing,he):he,ve="pitch"in C?+C.pitch:ue,Se="padding"in C?C.padding:le.padding,Me=je.convert(C.offset);let Ae,Ce,Oe;if("globe"===le.projection.name){const te=lp.fromLngLat(le.center),ce=Me.rotate(-le.angle);te.x+=ce.x/le.worldSize,te.y+=ce.y/le.worldSize;const he=te.toLngLat(),ue=$f.convert(C.center||he);this._normalizeCenter(ue),Ae=le.centerPoint.add(ce),Ce=new je(te.x,te.y).mult(le.worldSize),Oe=new je(Kd(ue.lng),Jd(ue.lat)).mult(le.worldSize).sub(Ce)}else{Ae=le.centerPoint.add(Me);const te=le.pointLocation(Ae),ce=$f.convert(C.center||te);this._normalizeCenter(ce),Ce=le.project(te),Oe=le.project(ce).sub(Ce)}const Ne=le.zoomScale(_e-ce);let Ge,Ze;C.around&&(Ge=$f.convert(C.around),Ze=le.locationPoint(Ge));const qe=this._zooming||_e!==ce,He=this._rotating||he!==ye,We=this._pitching||ve!==ue,Xe=!le.isPaddingEqual(Se),T=le=>je=>{if(qe&&(le.zoom=Kr(ce,_e,je)),He&&(le.bearing=Kr(he,ye,je)),We&&(le.pitch=Kr(ue,ve,je)),Xe&&(le.interpolatePadding(de,Se,je),Ae=le.centerPoint.add(Me)),Ge)le.setLocationAtPoint(Ge,Ze);else{const C=le.zoomScale(le.zoom-ce),te=_e>ce?Math.min(2,Ne):Math.max(.5,Ne),he=Math.pow(te,1-je),ue=le.unproject(Ce.add(Oe.mult(je*he)).mult(C));le.setLocationAtPoint(le.renderWorldCopies?ue.wrap():ue,Ae)}return C.preloadOnly||this._fireMoveEvents(te),le};if(C.preloadOnly){const te=this._emulate(T,C.duration,le);return this._preloadTiles(te),this}const Ye={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=qe,this._rotating=He,this._pitching=We,this._padding=Xe,this._easeId=C.easeId,this._prepareEase(te,C.noMoveStart,Ye),this._ease(T(le),(C=>{"sea"===le.cameraElevationReference&&le.recenterOnTerrain(),this._afterEase(te,C)}),C),this}_prepareEase(C,te,le={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&0===this.transform.pitch&&"globe"!==this.transform.projection.name&&(this.transform.cameraElevationReference="ground"),te||le.moving||this.fire(new It("movestart",C)),this._zooming&&!le.zooming&&this.fire(new It("zoomstart",C)),this._rotating&&!le.rotating&&this.fire(new It("rotatestart",C)),this._pitching&&!le.pitching&&this.fire(new It("pitchstart",C))}_fireMoveEvents(C){this.fire(new It("move",C)),this._zooming&&this.fire(new It("zoom",C)),this._rotating&&this.fire(new It("rotate",C)),this._pitching&&this.fire(new It("pitch",C))}_afterEase(C,te){if(this._easeId&&te&&this._easeId===te)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const le=this._zooming,ce=this._rotating,he=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,le&&this.fire(new It("zoomend",C)),ce&&this.fire(new It("rotateend",C)),he&&this.fire(new It("pitchend",C)),this.fire(new It("moveend",C))}flyTo(C,te){if(this._prefersReducedMotion(C)){const le=O(C,["center","zoom","bearing","pitch","around"]);return this.jumpTo(le,te)}this.stop(),C=k({offset:[0,0],speed:1.2,curve:1.42,easing:$e},C);const le=this.transform,ce=this.getZoom(),he=this.getBearing(),ue=this.getPitch(),de=this.getPadding(),_e="zoom"in C?z(+C.zoom,le.minZoom,le.maxZoom):ce,ye="bearing"in C?this._normalizeBearing(C.bearing,he):he,ve="pitch"in C?+C.pitch:ue,Se="padding"in C?C.padding:le.padding,Me=le.zoomScale(_e-ce),Ae=je.convert(C.offset);let Ce=le.centerPoint.add(Ae);const Oe=le.pointLocation(Ce),Ne=$f.convert(C.center||Oe);this._normalizeCenter(Ne);const Ge=le.project(Oe),Ze=le.project(Ne).sub(Ge);let qe=C.curve;const He=Math.max(le.width,le.height),We=He/Me,Xe=Ze.mag();if("minZoom"in C){const te=z(Math.min(C.minZoom,ce,_e),le.minZoom,le.maxZoom),he=He/le.zoomScale(te-ce);qe=Math.sqrt(he/Xe*2)}const Ye=qe*qe;function E(C){const te=(We*We-He*He+(C?-1:1)*Ye*Ye*Xe*Xe)/(2*(C?We:He)*Ye*Xe);return Math.log(Math.sqrt(te*te+1)-te)}function M(C){return(Math.exp(C)-Math.exp(-C))/2}function A(C){return(Math.exp(C)+Math.exp(-C))/2}const Je=E(0);let I=function(C){return A(Je)/A(Je+qe*C)},P=function(C){return He*((A(Je)*(M(te=Je+qe*C)/A(te))-M(Je))/Ye)/Xe;var te},Qe=(E(1)-Je)/qe;if(Math.abs(Xe)<1e-6||!isFinite(Qe)){if(Math.abs(He-We)<1e-6)return this.easeTo(C,te);const le=We<He?-1:1;Qe=Math.abs(Math.log(We/He))/qe,P=function(){return 0},I=function(C){return Math.exp(le*qe*C)}}C.duration="duration"in C?+C.duration:1e3*Qe/("screenSpeed"in C?+C.screenSpeed/qe:+C.speed),C.maxDuration&&C.duration>C.maxDuration&&(C.duration=0);const tt=he!==ye,rt=ve!==ue,ot=!le.isPaddingEqual(Se),F=le=>Me=>{const Oe=Me*Qe,je=1/I(Oe);le.zoom=1===Me?_e:ce+le.scaleZoom(je),tt&&(le.bearing=Kr(he,ye,Me)),rt&&(le.pitch=Kr(ue,ve,Me)),ot&&(le.interpolatePadding(de,Se,Me),Ce=le.centerPoint.add(Ae));const qe=1===Me?Ne:le.unproject(Ge.add(Ze.mult(P(Oe))).mult(je));return le.setLocationAtPoint(le.renderWorldCopies?qe.wrap():qe,Ce),le._updateCameraOnTerrain(),C.preloadOnly||this._fireMoveEvents(te),le};if(C.preloadOnly){const te=this._emulate(F,C.duration,le);return this._preloadTiles(te),this}return this._zooming=!0,this._rotating=tt,this._pitching=rt,this._padding=ot,this._prepareEase(te,!1),this._ease(F(le),(()=>this._afterEase(te)),C),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(C,te){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const C=this._onEaseEnd;this._onEaseEnd=void 0,C.call(this,te)}if(!C){const C=this.handlers;C&&C.stop(!1)}return this}_ease(C,te,le){!1===le.animate||0===le.duration?(C(1),te()):(this._easeStart=bi.now(),this._easeOptions=le,this._onEaseFrame=C,this._onEaseEnd=te,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const C=Math.min((bi.now()-this._easeStart)/this._easeOptions.duration,1),te=this._onEaseFrame;te&&te(this._easeOptions.easing(C)),C<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(C,te){C=D(C,-180,180);const le=Math.abs(C-te);return Math.abs(C-360-te)<le&&(C-=360),Math.abs(C+360-te)<le&&(C+=360),C}_normalizeCenter(C){const te=this.transform;if(te.maxBounds)return;if("globe"!==te.projection.name&&!te.renderWorldCopies)return;const le=C.lng-te.center.lng;C.lng+=le>180?-360:le<-180?360:0}_prefersReducedMotion(C){return this._respectPrefersReducedMotion&&bi.prefersReducedMotion&&!(C&&C.essential)}_emulate(C,te,le){const ce=Math.ceil(15*te/1e3),he=[],ue=C(le.clone());for(let C=0;C<=ce;C++){const te=ue(C/ce);he.push(te.clone())}return he}}class iI{constructor(C={}){this.options=C,j(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(C){const te=this.options&&this.options.compact;return this._map=C,this._container=pt("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=pt("button","mapboxgl-ctrl-attrib-button",this._container),pt("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden","true"),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=pt("div","mapboxgl-ctrl-attrib-inner",this._container),te&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),void 0===te&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(C,te){const le=this._map._getUIString(`AttributionControl.${te}`);C.removeAttribute("title"),C.firstElementChild&&C.firstElementChild.setAttribute("title",le)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let C=this._editLink;C||(C=this._editLink=this._container.querySelector(".mapbox-improve-map"));const te=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||de.ACCESS_TOKEN}];if(C){const le=te.reduce(((C,le,ce)=>(le.value&&(C+=`${le.key}=${le.value}${ce<te.length-1?"&":""}`),C)),"?");C.href=`${de.FEEDBACK_URL}/${le}#${oS(this._map,!0)}`,C.rel="noopener nofollow",this._setElementTitle(C,"MapFeedback")}}_updateData(C){!C||"metadata"!==C.sourceDataType&&"visibility"!==C.sourceDataType&&"style"!==C.dataType||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let C=[];if(this._map.style.stylesheet){const C=this._map.style.stylesheet;this.styleOwner=C.owner,this.styleId=C.id}const te=this._map.style._mergedSourceCaches;for(const le in te){const ce=te[le];if(ce.used){const te=ce.getSource();te.attribution&&C.indexOf(te.attribution)<0&&C.push(te.attribution)}}C.sort(((C,te)=>C.length-te.length)),C=C.filter(((te,le)=>{for(let ce=le+1;ce<C.length;ce++)if(C[ce].indexOf(te)>=0)return!1;return!0})),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?C=[...this.options.customAttribution,...C]:C.unshift(this.options.customAttribution));const le=C.join(" | ");le!==this._attribHTML&&(this._attribHTML=le,C.length?(this._innerContainer.innerHTML=le,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class rI{constructor(){j(["_updateLogo","_updateCompact"],this)}onAdd(C){this._map=C,this._container=pt("div","mapboxgl-ctrl");const te=pt("a","mapboxgl-ctrl-logo");return te.target="_blank",te.rel="noopener nofollow",te.href="https://www.mapbox.com/",te.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),te.setAttribute("rel","noopener nofollow"),this._container.appendChild(te),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(C){C&&"metadata"!==C.sourceDataType||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const C=this._map.style._sourceCaches;if(0===Object.entries(C).length)return!0;for(const te in C){const le=C[te].getSource();if(le.hasOwnProperty("mapbox_logo")&&!le.mapbox_logo)return!1}return!0}_updateCompact(){const C=this._container.children;if(C.length){const te=C[0];this._map.getCanvasContainer().offsetWidth<250?te.classList.add("mapboxgl-compact"):te.classList.remove("mapboxgl-compact")}}}class nI{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(C){const te=++this._id;return this._queue.push({callback:C,id:te,cancelled:!1}),te}remove(C){const te=this._currentlyRunning,le=te?this._queue.concat(te):this._queue;for(const te of le)if(te.id===C)return void(te.cancelled=!0)}run(C=0){const te=this._currentlyRunning=this._queue;this._queue=[];for(const le of te)if(!le.cancelled&&(le.callback(C),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function oI(C,te,le){if(C=new $f(C.lng,C.lat),te){const ce=new $f(C.lng-360,C.lat),he=new $f(C.lng+360,C.lat),ue=360*Math.ceil(Math.abs(C.lng-le.center.lng)/360),de=le.locationPoint(C).distSqr(te),_e=te.x<0||te.y<0||te.x>le.width||te.y>le.height;le.locationPoint(ce).distSqr(te)<de&&(_e||Math.abs(ce.lng-le.center.lng)<ue)?C=ce:le.locationPoint(he).distSqr(te)<de&&(_e||Math.abs(he.lng-le.center.lng)<ue)&&(C=he)}for(;Math.abs(C.lng-le.center.lng)>180;){const te=le.locationPoint(C);if(te.x>=0&&te.y>=0&&te.x<=le.width&&te.y<=le.height)break;C.lng>le.center.lng?C.lng-=360:C.lng+=360}return C}const PI={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class aI extends zt{constructor(C,te){if(super(),(C instanceof le.HTMLElement||te)&&(C=k({element:C},te)),j(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=C&&C.anchor||"center",this._color=C&&C.color||"#3FB1CE",this._scale=C&&C.scale||1,this._draggable=C&&C.draggable||!1,this._clickTolerance=C&&C.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=C&&C.rotation||0,this._rotationAlignment=C&&C.rotationAlignment||"auto",this._pitchAlignment=C&&C.pitchAlignment&&C.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=C&&C.occludedOpacity||.2,C&&C.element)this._element=C.element,this._offset=je.convert(C&&C.offset||[0,0]);else{this._defaultMarker=!0,this._element=pt("div");const te=41,le=27,ce=ft("svg",{display:"block",height:te*this._scale+"px",width:le*this._scale+"px",viewBox:`0 0 ${le} ${te}`},this._element),he=ft("radialGradient",{id:"shadowGradient"},ft("defs",{},ce));ft("stop",{offset:"10%","stop-opacity":.4},he),ft("stop",{offset:"100%","stop-opacity":.05},he),ft("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},ce),ft("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},ce),ft("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},ce),ft("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},ce),this._offset=je.convert(C&&C.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",(C=>{C.preventDefault()})),this._element.addEventListener("mousedown",(C=>{C.preventDefault()}));const ce=this._element.classList;for(const C in PI)ce.remove(`mapboxgl-marker-anchor-${C}`);ce.add(`mapboxgl-marker-anchor-${this._anchor}`);const he=C&&C.className?C.className.trim().split(/\s+/):[];ce.add(...he),this._popup=null}addTo(C){return C===this._map||(this.remove(),this._map=C,C.getCanvasContainer().appendChild(this._element),C.on("move",this._updateMoving),C.on("moveend",this._update),C.on("remove",this._clearFadeTimer),C._addMarker(this),this.setDraggable(this._draggable),this._update(),C.on("click",this._onMapClick)),this}remove(){const C=this._map;return C&&(C.off("click",this._onMapClick),C.off("move",this._updateMoving),C.off("moveend",this._update),C.off("mousedown",this._addDragHandler),C.off("touchstart",this._addDragHandler),C.off("mouseup",this._onUp),C.off("touchend",this._onUp),C.off("mousemove",this._onMove),C.off("touchmove",this._onMove),C.off("remove",this._clearFadeTimer),C._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(C){return this._lngLat=$f.convert(C),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(C){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),C){if(!("offset"in C.options)){const te=38.1,le=13.5,ce=Math.sqrt(Math.pow(le,2)/2);C.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-te],"bottom-left":[ce,-1*(te-le+ce)],"bottom-right":[-ce,-1*(te-le+ce)],left:[le,-1*(te-le)],right:[-le,-1*(te-le)]}:this._offset}this._popup=C,C._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(C){const te=C.code,le=C.charCode||C.keyCode;"Space"!==te&&"Enter"!==te&&32!==le&&13!==le||this.togglePopup()}_onMapClick(C){const te=C.originalEvent.target,le=this._element;this._popup&&(te===le||le.contains(te))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const C=this._popup;return C?(C.isOpen()?(C.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(C.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const C=this._map,te=this._pos;if(!C||!te)return!1;const le=C.unproject(te),ce=C.getFreeCameraOptions();if(!ce.position)return!1;const he=ce.position.toLngLat();return he.distanceTo(le)<.9*he.distanceTo(this._lngLat)}_evaluateOpacity(){const C=this._map;if(!C)return;const te=this._pos;if(!te||te.x<0||te.x>C.transform.width||te.y<0||te.y>C.transform.height)return void this._clearFadeTimer();const le=C.unproject(te);let ce;C._showingGlobe()&&Nd(C.transform,this._lngLat)?ce=0:(ce=1-C._queryFogOpacity(le),C.transform._terrainEnabled()&&C.getTerrain()&&this._behindTerrain()&&(ce*=this._occludedOpacity)),this._element.style.opacity=`${ce}`,this._element.style.pointerEvents=ce>0?"auto":"none",this._popup&&this._popup._setOpacity(ce),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const C=this._pos;if(!C||!this._map)return;const te=this._offset.mult(this._scale);this._element.style.transform=`\n            translate(${C.x}px,${C.y}px)\n            ${PI[this._anchor]}\n            ${this._calculateXYTransform()} ${this._calculateZTransform()}\n            translate(${te.x}px,${te.y}px)\n        `}_calculateXYTransform(){const C=this._pos,te=this._map,le=this.getPitchAlignment();if(!te||!C||"map"!==le)return"";if(!te._showingGlobe()){const C=te.getPitch();return C?`rotateX(${C}deg)`:""}const ce=T(Fd(te.transform,this._lngLat)),he=C.sub(Bd(te.transform)),ue=Math.abs(he.x)+Math.abs(he.y);if(0===ue)return"";const de=ce/ue;return`rotateX(${-he.y*de}deg) rotateY(${he.x*de}deg)`}_calculateZTransform(){const C=this._pos,te=this._map;if(!te||!C)return"";let le=0;const ce=this.getRotationAlignment();if("map"===ce)if(te._showingGlobe()){const C=te.project(new $f(this._lngLat.lng,this._lngLat.lat+.001)),ce=te.project(new $f(this._lngLat.lng,this._lngLat.lat-.001)).sub(C);le=T(Math.atan2(ce.y,ce.x))-90}else le=-te.getBearing();else if("horizon"===ce){const ce=P(4,6,te.getZoom()),he=Bd(te.transform);he.y+=ce*te.transform.height;const ue=C.sub(he),de=T(Math.atan2(ue.y,ue.x));le=(de>90?de-270:de+90)*(1-ce)}return le+=this._rotation,le?`rotateZ(${le}deg)`:""}_update(C){le.cancelAnimationFrame(this._updateFrameId);const te=this._map;te&&(te.transform.renderWorldCopies&&(this._lngLat=oI(this._lngLat,this._pos,te.transform)),this._pos=te.project(this._lngLat),!0===C?this._updateFrameId=le.requestAnimationFrame((()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())})):this._pos=this._pos.round(),te._requestDomTask((()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(te._showingGlobe()||te.getTerrain()||te.getFog())&&!this._fadeTimer&&(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))})))}getOffset(){return this._offset}setOffset(C){return this._offset=je.convert(C),this._update(),this}addClassName(C){return this._element.classList.add(C),this}removeClassName(C){return this._element.classList.remove(C),this}toggleClassName(C){return this._element.classList.toggle(C)}_onMove(C){const te=this._map;if(!te)return;const le=this._pointerdownPos,ce=this._positionDelta;if(le&&ce){if(!this._isDragging){const ce=this._clickTolerance||te._clickTolerance;if(C.point.dist(le)<ce)return;this._isDragging=!0}this._pos=C.point.sub(ce),this._lngLat=te.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new It("dragstart"))),this.fire(new It("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const C=this._map;C&&(C.off("mousemove",this._onMove),C.off("touchmove",this._onMove)),"active"===this._state&&this.fire(new It("dragend")),this._state="inactive"}_addDragHandler(C){const te=this._map,le=this._pos;te&&le&&this._element.contains(C.originalEvent.target)&&(C.preventDefault(),this._positionDelta=C.point.sub(le),this._pointerdownPos=C.point,this._state="pending",te.on("mousemove",this._onMove),te.on("touchmove",this._onMove),te.once("mouseup",this._onUp),te.once("touchend",this._onUp))}setDraggable(C){this._draggable=!!C;const te=this._map;return te&&(C?(te.on("mousedown",this._addDragHandler),te.on("touchstart",this._addDragHandler)):(te.off("mousedown",this._addDragHandler),te.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(C){return this._rotation=C||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(C){return this._rotationAlignment=C||"auto",this._update(),this}getRotationAlignment(){return"auto"===this._rotationAlignment||"horizon"===this._rotationAlignment&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(C){return this._pitchAlignment=C||"auto",this._update(),this}getPitchAlignment(){return"auto"===this._pitchAlignment?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(C){return this._occludedOpacity=C||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const RI={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},kI=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function hI(C=new je(0,0),te="bottom"){if("number"==typeof C){const le=Math.round(Math.sqrt(.5*Math.pow(C,2)));switch(te){case"top":return new je(0,C);case"top-left":return new je(le,le);case"top-right":return new je(-le,le);case"bottom":return new je(0,-C);case"bottom-left":return new je(le,-le);case"bottom-right":return new je(-le,-le);case"left":return new je(C,0);case"right":return new je(-C,0)}return new je(0,0)}return C instanceof je||Array.isArray(C)?je.convert(C):je.convert(C[te]||[0,0])}class uI{constructor(C){this.jumpTo(C)}getValue(C){if(C<=this._startTime)return this._start;if(C>=this._endTime)return this._end;const te=M((C-this._startTime)/(this._endTime-this._startTime));return this._start*(1-te)+this._end*te}isEasing(C){return C>=this._startTime&&C<=this._endTime}jumpTo(C){this._startTime=-1/0,this._endTime=-1/0,this._start=C,this._end=C}easeTo(C,te,le){this._start=this.getValue(te),this._end=C,this._startTime=te,this._endTime=te+le}}const LI={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use  + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},OI={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1},BI={showCompass:!0,showZoom:!0,visualizePitch:!1};class mI{constructor(C,te,le=!1){this._clickTolerance=10,this.element=te,this.mouseRotate=new SS({clickTolerance:C.dragRotate._mouseRotate._clickTolerance}),this.map=C,le&&(this.mousePitch=new IS({clickTolerance:C.dragRotate._mousePitch._clickTolerance})),j(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),te.addEventListener("mousedown",this.mousedown),te.addEventListener("touchstart",this.touchstart,{passive:!1}),te.addEventListener("touchmove",this.touchmove),te.addEventListener("touchend",this.touchend),te.addEventListener("touchcancel",this.reset)}down(C,te){this.mouseRotate.mousedown(C,te),this.mousePitch&&this.mousePitch.mousedown(C,te),yt()}move(C,te){const le=this.map,ce=this.mouseRotate.mousemoveWindow(C,te),he=ce&&ce.bearingDelta;if(he&&le.setBearing(le.getBearing()+he),this.mousePitch){const ce=this.mousePitch.mousemoveWindow(C,te),he=ce&&ce.pitchDelta;he&&le.setPitch(le.getPitch()+he)}}off(){const C=this.element;C.removeEventListener("mousedown",this.mousedown),C.removeEventListener("touchstart",this.touchstart,{passive:!1}),C.removeEventListener("touchmove",this.touchmove),C.removeEventListener("touchend",this.touchend),C.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){xt(),le.removeEventListener("mousemove",this.mousemove),le.removeEventListener("mouseup",this.mouseup)}mousedown(C){this.down(k({},C,{ctrlKey:!0,preventDefault:()=>C.preventDefault()}),wt(this.element,C)),le.addEventListener("mousemove",this.mousemove),le.addEventListener("mouseup",this.mouseup)}mousemove(C){this.move(C,wt(this.element,C))}mouseup(C){this.mouseRotate.mouseupWindow(C),this.mousePitch&&this.mousePitch.mouseupWindow(C),this.offTemp()}touchstart(C){1!==C.targetTouches.length?this.reset():(this._startPos=this._lastPos=Tt(this.element,C.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>C.preventDefault()},this._startPos))}touchmove(C){1!==C.targetTouches.length?this.reset():(this._lastPos=Tt(this.element,C.targetTouches)[0],this.move({preventDefault:()=>C.preventDefault()},this._lastPos))}touchend(C){0===C.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const FI={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},NI={maxWidth:100,unit:"metric"},jI={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},UI={version:he,supported:Xt,setRTLTextPlugin:function(C,te,le=!1){if(rc===Vl||rc===Gl||rc===Zl)throw new Error("setRTLTextPlugin cannot be called multiple times.");nc=bi.resolveURL(C),rc=Vl,tc=te,ea(),le||ra()},getRTLTextPluginStatus:ia,Map:class extends tI{constructor(C){Ht.mark($t.create);const te=C;if(null!=(C=k({},OI,C)).minZoom&&null!=C.maxZoom&&C.minZoom>C.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(null!=C.minPitch&&null!=C.maxPitch&&C.minPitch>C.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(null!=C.minPitch&&C.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(null!=C.maxPitch&&C.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(C.antialias&&function(C){const te=C.navigator?C.navigator.userAgent:null;return!!function(C){if(null==Xe){const te=C.navigator?C.navigator.userAgent:null;Xe=!!C.safari||!(!te||!(/\b(iPad|iPhone|iPod)\b/.test(te)||te.match("Safari")&&!te.match("Chrome")))}return Xe}(C)&&te&&(te.match("Version/15.4")||te.match("Version/15.5")||te.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))}(le)&&(C.antialias=!1,H("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Tv(C.minZoom,C.maxZoom,C.minPitch,C.maxPitch,C.renderWorldCopies),C),this._interactive=C.interactive,this._minTileCacheSize=C.minTileCacheSize,this._maxTileCacheSize=C.maxTileCacheSize,this._failIfMajorPerformanceCaveat=C.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=C.preserveDrawingBuffer,this._antialias=C.antialias,this._trackResize=C.trackResize,this._bearingSnap=C.bearingSnap,this._refreshExpiredTiles=C.refreshExpiredTiles,this._fadeDuration=C.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=C.crossSourceCollisions,this._collectResourceTiming=C.collectResourceTiming,this._language=this._parseLanguage(C.language),this._worldview=C.worldview,this._renderTaskQueue=new nI,this._domRenderTaskQueue=new nI,this._controls=[],this._markers=[],this._popups=[],this._mapId=F(),this._locale=k({},LI,C.locale),this._clickTolerance=C.clickTolerance,this._cooperativeGestures=C.cooperativeGestures,this._performanceMetricsCollection=C.performanceMetricsCollection,this._containerWidth=0,this._containerHeight=0,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new uI(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._requestManager=new ze(C.transformRequest,C.accessToken,C.testMode),this._silenceAuthErrors=!!C.testMode,this._contextCreateOptions=C.contextCreateOptions?{...C.contextCreateOptions}:{},"string"==typeof C.container){if(this._container=le.document.getElementById(C.container),!this._container)throw new Error(`Container '${C.container.toString()}' not found.`)}else{if(!(C.container instanceof le.HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=C.container}if(this._container.childNodes.length>0&&H("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),C.maxBounds&&this.setMaxBounds(C.maxBounds),j(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),void 0===this.painter)throw new Error("Failed to initialize WebGL.");if(this.on("move",(()=>this._update(!1))),this.on("moveend",(()=>this._update(!1))),this.on("zoom",(()=>this._update(!0))),void 0!==le&&(this._fullscreenchangeEvent="onfullscreenchange"in le.document?"fullscreenchange":"webkitfullscreenchange",le.addEventListener("online",this._onWindowOnline,!1),le.addEventListener("resize",this._onWindowResize,!1),le.addEventListener("orientationchange",this._onWindowResize,!1),le.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),le.addEventListener("visibilitychange",this._onVisibilityChange,!1)),this.handlers=new QS(this,C),this._localFontFamily=C.localFontFamily,this._localIdeographFontFamily=C.localIdeographFontFamily,(C.style||!C.testMode)&&this.setStyle(C.style||de.DEFAULT_STYLE,{localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),C.projection&&this.setProjection(C.projection),C.hash&&(this._hash=new nS("string"==typeof C.hash&&C.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){null==te.center&&null==te.zoom||(this.transform._unmodified=!1),this.jumpTo({center:C.center,zoom:C.zoom,bearing:C.bearing,pitch:C.pitch});const le=C.bounds;le&&(this.resize(),this.fitBounds(le,k({},C.fitBoundsOptions,{duration:0})))}this.resize(),C.attributionControl&&this.addControl(new iI({customAttribution:C.customAttribution})),this._logoControl=new rI,this.addControl(this._logoControl,C.logoPosition),this.on("style.load",(()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)})),this.on("data",(C=>{this._update("style"===C.dataType),this.fire(new It(`${C.dataType}data`,C))})),this.on("dataloading",(C=>{this.fire(new It(`${C.dataType}dataloading`,C))}))}_getMapId(){return this._mapId}addControl(C,te){if(void 0===te&&(te=C.getDefaultPosition?C.getDefaultPosition():"top-right"),!C||!C.onAdd)return this.fire(new Ct(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const le=C.onAdd(this);this._controls.push(C);const ce=this._controlPositions[te];return-1!==te.indexOf("bottom")?ce.insertBefore(le,ce.firstChild):ce.appendChild(le),this}removeControl(C){if(!C||!C.onRemove)return this.fire(new Ct(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const te=this._controls.indexOf(C);return te>-1&&this._controls.splice(te,1),C.onRemove(this),this}hasControl(C){return this._controls.indexOf(C)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(C){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const te=!this._moving;return te&&this.fire(new It("movestart",C)).fire(new It("move",C)),this.fire(new It("resize",C)),te&&this.fire(new It("moveend",C)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(C){return this.transform.setMaxBounds(sc.convert(C)),this._update()}setMinZoom(C){if((C=null==C?-2:C)>=-2&&C<=this.transform.maxZoom)return this.transform.minZoom=C,this._update(),this.getZoom()<C?this.setZoom(C):this.fire(new It("zoomstart")).fire(new It("zoom")).fire(new It("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(C){if((C=null==C?22:C)>=this.transform.minZoom)return this.transform.maxZoom=C,this._update(),this.getZoom()>C?this.setZoom(C):this.fire(new It("zoomstart")).fire(new It("zoom")).fire(new It("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(C){if((C=null==C?0:C)<0)throw new Error("minPitch must be greater than or equal to 0");if(C>=0&&C<=this.transform.maxPitch)return this.transform.minPitch=C,this._update(),this.getPitch()<C?this.setPitch(C):this.fire(new It("pitchstart")).fire(new It("pitch")).fire(new It("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(C){if((C=null==C?85:C)>85)throw new Error("maxPitch must be less than or equal to 85");if(C>=this.transform.minPitch)return this.transform.maxPitch=C,this._update(),this.getPitch()>C?this.setPitch(C):this.fire(new It("pitchstart")).fire(new It("pitch")).fire(new It("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(C){return this.transform.renderWorldCopies=C,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(C){return"auto"===C?le.navigator.language:Array.isArray(C)?0===C.length?void 0:C.map((C=>"auto"===C?le.navigator.language:C)):C}setLanguage(C){const te=this._parseLanguage(C);if(!this.style||te===this._language)return this;this._language=te,this.style.reloadSources();for(const C of this._controls)C._setLanguage&&C._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(C){return this.style&&C!==this._worldview?(this._worldview=C,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return"globe"===this.transform.projection.name}setProjection(C){return this._lazyInitEmptyStyle(),C?"string"==typeof C&&(C={name:C}):C=null,this._useExplicitProjection=!!C,this._prioritizeAndUpdateProjection(C,this.style.projection)}_updateProjectionTransition(){if("globe"!==this.getProjection().name)return;const C=this.transform,te=C.projection.name;let le;"globe"===te&&C.zoom>=Vp?(C.setMercatorFromTransition(),le=!0):"mercator"===te&&C.zoom<Vp&&(C.setProjection({name:"globe"}),le=!0),le&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(C,te){return this._updateProjection(C||te||{name:"mercator"})}_updateProjection(C){let te;return te="globe"===C.name&&this.transform.zoom>=Vp?this.transform.setMercatorFromTransition():this.transform.setProjection(C),this.style.applyProjectionUpdate(),te&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(C){return this.transform.locationPoint3D($f.convert(C))}unproject(C){return this.transform.pointLocation3D(je.convert(C))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(C,te,le){if("mouseenter"===C||"mouseover"===C){let ce=!1;const n=he=>{const ue=te.filter((C=>this.getLayer(C))),de=ue.length?this.queryRenderedFeatures(he.point,{layers:ue}):[];de.length?ce||(ce=!0,le.call(this,new fS(C,this,he.originalEvent,{features:de}))):ce=!1},o=()=>{ce=!1};return{layers:new Set(te),listener:le,delegates:{mousemove:n,mouseout:o}}}if("mouseleave"===C||"mouseout"===C){let ce=!1;const n=he=>{const ue=te.filter((C=>this.getLayer(C)));(ue.length?this.queryRenderedFeatures(he.point,{layers:ue}):[]).length?ce=!0:ce&&(ce=!1,le.call(this,new fS(C,this,he.originalEvent)))},o=te=>{ce&&(ce=!1,le.call(this,new fS(C,this,te.originalEvent)))};return{layers:new Set(te),listener:le,delegates:{mousemove:n,mouseout:o}}}{const r=C=>{const ce=te.filter((C=>this.getLayer(C))),he=ce.length?this.queryRenderedFeatures(C.point,{layers:ce}):[];he.length&&(C.features=he,le.call(this,C),delete C.features)};return{layers:new Set(te),listener:le,delegates:{[C]:r}}}}on(C,te,le){if(void 0===le)return super.on(C,te);if(Array.isArray(te)||(te=[te]),te)for(const C of te)if(!this._isValidId(C))return this;const ce=this._createDelegatedListener(C,te,le);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[C]=this._delegatedListeners[C]||[],this._delegatedListeners[C].push(ce);for(const C in ce.delegates)this.on(C,ce.delegates[C]);return this}once(C,te,le){if(void 0===le)return super.once(C,te);if(Array.isArray(te)||(te=[te]),te)for(const C of te)if(!this._isValidId(C))return this;const ce=this._createDelegatedListener(C,te,le);for(const C in ce.delegates)this.once(C,ce.delegates[C]);return this}off(C,te,le){if(void 0===le)return super.off(C,te);te=new Set(Array.isArray(te)?te:[te]);for(const C of te)if(!this._isValidId(C))return this;const r=(C,te)=>{if(C.size!==te.size)return!1;for(const le of C)if(!te.has(le))return!1;return!0},ce=this._delegatedListeners?this._delegatedListeners[C]:void 0;return ce&&(C=>{for(let ce=0;ce<C.length;ce++){const he=C[ce];if(he.listener===le&&r(he.layers,te)){for(const C in he.delegates)this.off(C,he.delegates[C]);return C.splice(ce,1),this}}})(ce),this}queryRenderedFeatures(C,te){if(!this.style)return[];if(void 0!==te||void 0===C||C instanceof je||Array.isArray(C)||(te=C,C=void 0),C=C||[[0,0],[this.transform.width,this.transform.height]],(te=te||{}).layers&&Array.isArray(te.layers))for(const C of te.layers)if(!this._isValidId(C))return[];return this.style.queryRenderedFeatures(C,te,this.transform)}querySourceFeatures(C,te){return this._isValidId(C)?this.style.querySourceFeatures(C,te):[]}isPointOnSurface(C){const{name:te}=this.transform.projection;return"globe"!==te&&"mercator"!==te&&H(`${te} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(je.convert(C))}setStyle(C,te){return!1!==(te=k({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},te)).diff&&te.localIdeographFontFamily===this._localIdeographFontFamily&&te.localFontFamily===this._localFontFamily&&this.style&&C?(this._diffStyle(C,te),this):(this._localIdeographFontFamily=te.localIdeographFontFamily,this._localFontFamily=te.localFontFamily,this._updateStyle(C,te))}_getUIString(C){const te=this._locale[C];if(null==te)throw new Error(`Missing UI string '${C}'`);return te}_updateStyle(C,te){return this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),C&&(this.style=new iS(this,te||{}),this.style.setEventedParent(this,{style:this.style}),"string"==typeof C?this.style.loadURL(C):this.style.loadJSON(C)),this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new iS(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(C,te){if("string"==typeof C){const le=this._requestManager.normalizeStyleURL(C),ce=this._requestManager.transformRequest(le,st.Style);we(ce,((C,le)=>{C?this.fire(new Ct(C)):le&&this._updateDiff(le,te)}))}else"object"==typeof C&&this._updateDiff(C,te)}_updateDiff(C,te){try{this.style.setState(C)&&this._update(!0)}catch(le){H(`Unable to perform style diff: ${le.message||le.error||le}.  Rebuilding the style from scratch.`),this._updateStyle(C,te)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(H("There is no style added to the map."),!1)}_isValidId(C){return null==C?(this.fire(new Ct(new Error("IDs can't be empty."))),!1):!xa(C)||(this.fire(new Ct(new Error(`IDs can't contain special symbols: "${C}".`))),!1)}addSource(C,te){return this._isValidId(C)?(this._lazyInitEmptyStyle(),this.style.addSource(C,te),this._update(!0)):this}isSourceLoaded(C){return!!this._isValidId(C)&&!!this.style&&this.style._isSourceCacheLoaded(C)}areTilesLoaded(){const C=this.style&&this.style._sourceCaches;for(const te in C){const le=C[te]._tiles;for(const C in le){const te=le[C];if("loaded"!==te.state&&"errored"!==te.state)return!1}}return!0}addSourceType(C,te,le){this._lazyInitEmptyStyle(),this.style.addSourceType(C,te,le)}removeSource(C){return this._isValidId(C)?(this.style.removeSource(C),this._updateTerrain(),this._update(!0)):this}getSource(C){return this._isValidId(C)?this.style.getOwnSource(C):null}addImage(C,te,{pixelRatio:ce=1,sdf:he=!1,stretchX:ue,stretchY:de,content:_e}={}){if(this._lazyInitEmptyStyle(),te instanceof le.HTMLImageElement||le.ImageBitmap&&te instanceof le.ImageBitmap){const{width:le,height:ye,data:ve}=bi.getImageData(te);this.style.addImage(C,{data:new ef({width:le,height:ye},ve),pixelRatio:ce,stretchX:ue,stretchY:de,content:_e,sdf:he,version:0})}else if(void 0===te.width||void 0===te.height)this.fire(new Ct(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:le,height:ye}=te,ve=te;this.style.addImage(C,{data:new ef({width:le,height:ye},new Uint8Array(ve.data)),pixelRatio:ce,stretchX:ue,stretchY:de,content:_e,sdf:he,version:0,userImage:ve}),ve.onAdd&&ve.onAdd(this,C)}}updateImage(C,te){this._lazyInitEmptyStyle();const ce=this.style.getImage(C);if(!ce)return void this.fire(new Ct(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const he=te instanceof le.HTMLImageElement||le.ImageBitmap&&te instanceof le.ImageBitmap?bi.getImageData(te):te,{width:ue,height:de}=he;void 0!==ue&&void 0!==de?ue===ce.data.width&&de===ce.data.height?(ce.data.replace(he.data,!(te instanceof le.HTMLImageElement||le.ImageBitmap&&te instanceof le.ImageBitmap)),this.style.updateImage(C,ce)):this.fire(new Ct(new Error(`The width and height of the updated image (${ue}, ${de})\n                must be that same as the previous version of the image\n                (${ce.data.width}, ${ce.data.height})`))):this.fire(new Ct(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")))}hasImage(C){return C?!!this.style&&!!this.style.getImage(C):(this.fire(new Ct(new Error("Missing required image id"))),!1)}removeImage(C){this.style.removeImage(C)}loadImage(C,te){Ie(this._requestManager.transformRequest(C,st.Image),((C,ce)=>{te(C,ce instanceof le.HTMLImageElement?bi.getImageData(ce):ce)}))}listImages(){return this.style.listImages()}addModel(C,te){this._lazyInitEmptyStyle(),this.style.addModel(C,te)}hasModel(C){return C?this.style.hasModel(C):(this.fire(new Ct(new Error("Missing required model id"))),!1)}removeModel(C){this.style.removeModel(C)}listModels(){return this.style.listModels()}addLayer(C,te){return this._isValidId(C.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(C,te),this._update(!0)):this}moveLayer(C,te){return this._isValidId(C)?(this.style.moveLayer(C,te),this._update(!0)):this}removeLayer(C){return this._isValidId(C)?(this.style.removeLayer(C),this._update(!0)):this}getLayer(C){return this._isValidId(C)?this.style.getOwnLayer(C):null}setLayerZoomRange(C,te,le){return this._isValidId(C)?(this.style.setLayerZoomRange(C,te,le),this._update(!0)):this}setFilter(C,te,le={}){return this._isValidId(C)?(this.style.setFilter(C,te,le),this._update(!0)):this}getFilter(C){return this._isValidId(C)?this.style.getFilter(C):null}setPaintProperty(C,te,le,ce={}){return this._isValidId(C)?(this.style.setPaintProperty(C,te,le,ce),this._update(!0)):this}getPaintProperty(C,te){return this._isValidId(C)?this.style.getPaintProperty(C,te):null}setLayoutProperty(C,te,le,ce={}){return this._isValidId(C)?(this.style.setLayoutProperty(C,te,le,ce),this._update(!0)):this}getLayoutProperty(C,te){return this._isValidId(C)?this.style.getLayoutProperty(C,te):null}getConfigProperty(C,te){return this.style.getConfigProperty(C,te)}setConfigProperty(C,te,le){return this.style.setConfigProperty(C,te,le),this._update(!0)}setLights(C){if(this._lazyInitEmptyStyle(),C&&1===C.length&&"flat"===C[0].type){const te=C[0];te.properties?this.style.setFlatLight(te.properties,te.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(C),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const C=this.style.getLights()||[];return 0===C.length&&C.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),C}setLight(C,te={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:C}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(C){return this._lazyInitEmptyStyle(),!C&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(C),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(C){return this._lazyInitEmptyStyle(),this.style.setFog(C),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setCamera(C){return this.style.setCamera(C),this._triggerCameraUpdate(C)}_triggerCameraUpdate(C){return this._update(this.transform.setOrthographicProjectionAtLowPitch("orthographic"===C["camera-projection"]))}getCamera(){return this.style.camera}_queryFogOpacity(C){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng($f.convert(C),this.transform):0}setFeatureState(C,te){return this._isValidId(C.source)?(this.style.setFeatureState(C,te),this._update()):this}removeFeatureState(C,te){return this._isValidId(C.source)?(this.style.removeFeatureState(C,te),this._update()):this}getFeatureState(C){return this._isValidId(C.source)?this.style.getFeatureState(C):null}_updateContainerDimensions(){if(!this._container)return;const C=this._container.getBoundingClientRect().width||400,te=this._container.getBoundingClientRect().height||300;let ce,he,ue,de=this._container;for(;de&&(!he||!ue);){const C=le.getComputedStyle(de).transform;C&&"none"!==C&&(ce=C.match(/matrix.*\((.+)\)/)[1].split(", "),ce[0]&&"0"!==ce[0]&&"1"!==ce[0]&&(he=ce[0]),ce[3]&&"0"!==ce[3]&&"1"!==ce[3]&&(ue=ce[3])),de=de.parentElement}this._containerWidth=he?Math.abs(C/he):C,this._containerHeight=ue?Math.abs(te/ue):te}_detectMissingCSS(){"rgb(250, 128, 114)"!==le.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")&&H("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const C=this._container;C.classList.add("mapboxgl-map"),(this._missingCSSCanary=pt("div","mapboxgl-canary",C)).style.visibility="hidden",this._detectMissingCSS();const te=this._canvasContainer=pt("div","mapboxgl-canvas-container",C);this._canvas=pt("canvas","mapboxgl-canvas",te),this._interactive&&(te.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const le=this._controlContainer=pt("div","mapboxgl-control-container",C),ce=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach((C=>{ce[C]=pt("div",`mapboxgl-ctrl-${C}`,le)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(C,te){const le=bi.devicePixelRatio||1;this._canvas.width=le*Math.ceil(C),this._canvas.height=le*Math.ceil(te),this._canvas.style.width=`${C}px`,this._canvas.style.height=`${te}px`}_addMarker(C){this._markers.push(C)}_removeMarker(C){const te=this._markers.indexOf(C);-1!==te&&this._markers.splice(te,1)}_addPopup(C){this._popups.push(C)}_removePopup(C){const te=this._popups.indexOf(C);-1!==te&&this._popups.splice(te,1)}_setupPainter(){const C=k({},Xt.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),te=this._canvas.getContext("webgl2",C);te?(Ke(te,!0),this.painter=new UA(te,this._contextCreateOptions,this.transform),this.on("data",(C=>{"source"===C.dataType&&this.painter.setTileLoadedFlag(!0)})),_e.testSupport(te)):this.fire(new Ct(new Error("Failed to initialize WebGL")))}_contextLost(C){C.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new It("webglcontextlost",{originalEvent:C}))}_contextRestored(C){this._setupPainter(),this.resize(),this._update(),this.fire(new It("webglcontextrestored",{originalEvent:C}))}_onMapScroll(C){if(C.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(C){return this.style?(this._styleDirty=this._styleDirty||C,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(C){return this._update(),this._renderTaskQueue.add(C)}_cancelRenderFrame(C){this._renderTaskQueue.remove(C)}_requestDomTask(C){!this.loaded()||this.loaded()&&!this.isMoving()?C():this._domRenderTaskQueue.add(C)}_render(C){let te;this.fire(new It("renderstart"));const ce=this.painter.context.extTimerQuery,he=bi.now(),ue=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(te=ue.createQuery(),ue.beginQuery(ce.TIME_ELAPSED_EXT,te)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],le.performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],le.performance.now())),this._renderTaskQueue.run(C),this._domRenderTaskQueue.run(C),this._removed)return;this._updateProjectionTransition();const de=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const C=this.transform.zoom,te=this.transform.pitch,le=bi.now(),ce=new oa(C,{now:le,fadeDuration:de,pitch:te,transition:this.style.transition});this.style.update(ce)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let _e=!1;if(this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),_e=this._updateAverageElevation(he),this.style.updateSources(this.transform),this._forceMarkerAndPopupUpdate()):_e=this._updateAverageElevation(he),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,de,this._crossSourceCollisions),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:de,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new It("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new It("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),te){const C=bi.now()-he;ue.endQuery(ce.TIME_ELAPSED_EXT),setTimeout((()=>{const ce=ue.getQueryParameter(te,ue.QUERY_RESULT)/1e6;ue.deleteQuery(te),this.fire(new It("gpu-timing-frame",{cpuTime:C,gpuTime:ce})),le.performance.mark("frame-gpu",{startTime:he,detail:{gpuTime:ce}})}),50)}if(this.listens("gpu-timing-layer")){const C=this.painter.collectGpuTimers();setTimeout((()=>{const te=this.painter.queryGpuTimers(C);this.fire(new It("gpu-timing-layer",{layerTimes:te}))}),50)}if(this.listens("gpu-timing-deferred-render")){const C=this.painter.collectDeferredRenderGpuQueries();setTimeout((()=>{const te=this.painter.queryGpuTimeDeferredRender(C);this.fire(new It("gpu-timing-deferred-render",{gpuTime:te}))}),50)}const ye=this._sourcesDirty||this._styleDirty||this._placementDirty||_e;if(ye||this._repaint)this.triggerRepaint();else{const C=!this.isMoving()&&this.loaded();if(C&&(_e=this._updateAverageElevation(he,!0)),_e)this.triggerRepaint();else if(this._triggerFrame(!1),C&&(this.fire(new It("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const C=this._calculateSpeedIndex();this.fire(new It("speedindexcompleted",{speedIndex:C})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||ye||(this._fullyLoaded=!0,Ht.mark($t.fullLoad),this._performanceMetricsCollection&&Vt(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(C){for(const te of this._markers)C&&!this.getRenderWorldCopies()&&(te._lngLat=te._lngLat.wrap()),te._update();for(const te of this._popups)!C||this.getRenderWorldCopies()||te._trackPointer||(te._lngLat=te._lngLat.wrap()),te._update()}_updateAverageElevation(C,te=!1){const i=C=>(this.transform.averageElevation=C,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return 0!==this.transform.averageElevation&&i(0);const le=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(le||(te||C-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(C)){const te=this.transform.averageElevation;let ce=this.transform.sampleAverageElevation();this.transform.elevation&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(ce)?ce=0:this._averageElevationLastSampledAt=C;const he=Math.abs(te-ce);if(he>1){if(this._isInitialLoad||le)return this._averageElevation.jumpTo(ce),i(ce);this._averageElevation.easeTo(ce,C,300)}else if(he>1e-4)return this._averageElevation.jumpTo(ce),i(ce)}return!!this._averageElevation.isEasing(C)&&i(this._averageElevation.getValue(C))}_authenticate(){Zt(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(C=>{if(C&&(C.message===dt||401===C.status)){const C=this.painter.context.gl;Ke(C,!1),this._logoControl instanceof rI&&this._logoControl._updateLogo(),C&&C.clear(C.DEPTH_BUFFER_BIT|C.COLOR_BUFFER_BIT|C.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new Ct(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}})),jt(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(()=>{}))}_updateTerrain(){const C=this._isDragging();this.painter.updateTerrain(this.style,C)}_calculateSpeedIndex(){const C=this.painter.canvasCopy(),te=this.painter.getCanvasCopiesAndTimestamps();te.timeStamps.push(performance.now());const le=this.painter.context.gl,ce=le.createFramebuffer();function n(C){le.framebufferTexture2D(le.FRAMEBUFFER,le.COLOR_ATTACHMENT0,le.TEXTURE_2D,C,0);const te=new Uint8Array(le.drawingBufferWidth*le.drawingBufferHeight*4);return le.readPixels(0,0,le.drawingBufferWidth,le.drawingBufferHeight,le.RGBA,le.UNSIGNED_BYTE,te),te}return le.bindFramebuffer(le.FRAMEBUFFER,ce),this._canvasPixelComparison(n(C),te.canvasCopies.map(n),te.timeStamps)}_canvasPixelComparison(C,te,le){let ce=le[1]-le[0];const he=C.length/4;for(let ue=0;ue<te.length;ue++){const de=te[ue];let _e=0;for(let te=0;te<de.length;te+=4)de[te]===C[te]&&de[te+1]===C[te+1]&&de[te+2]===C[te+2]&&de[te+3]===C[te+3]&&(_e+=1);ce+=(le[ue+2]-le[ue+1])*(1-_e/he)}return ce}remove(){this._hash&&this._hash.remove();for(const C of this._controls)C.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),void 0!==le&&(le.removeEventListener("resize",this._onWindowResize,!1),le.removeEventListener("orientationchange",this._onWindowResize,!1),le.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),le.removeEventListener("online",this._onWindowOnline,!1),le.removeEventListener("visibilitychange",this._onVisibilityChange,!1));const C=this.painter.context.gl.getExtension("WEBGL_lose_context");C&&C.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),qt.delete(this.painter.context.gl),this._removed=!0,this.fire(new It("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(C){this._renderNextFrame=this._renderNextFrame||C,this.style&&!this._frame&&(this._frame=bi.frame((C=>{const te=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,te&&this._render(C)})))}_preloadTiles(C){return R(this.style?Object.values(this.style._sourceCaches):[],((te,le)=>te._preloadTiles(C,le)),(()=>{this.triggerRepaint()})),this}_onWindowOnline(){this._update()}_onWindowResize(C){this._trackResize&&this.resize({originalEvent:C})._update()}_onVisibilityChange(){"hidden"===le.document.visibilityState&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(C){this._showTileBoundaries!==C&&(this._showTileBoundaries=C,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(C){this._showTerrainWireframe!==C&&(this._showTerrainWireframe=C,this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(C){this._showLayers2DWireframe!==C&&(this._showLayers2DWireframe=C,this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(C){this._showLayers3DWireframe!==C&&(this._showLayers3DWireframe=C,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(C){this._speedIndexTiming!==C&&(this._speedIndexTiming=C,this._update())}get showPadding(){return!!this._showPadding}set showPadding(C){this._showPadding!==C&&(this._showPadding=C,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(C){this._showCollisionBoxes!==C&&(this._showCollisionBoxes=C,C?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(C){this._showOverdrawInspector!==C&&(this._showOverdrawInspector=C,this._update())}get repaint(){return!!this._repaint}set repaint(C){this._repaint!==C&&(this._repaint=C,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(C){this._vertices=C,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(C){this._showTileAABBs!==C&&(this._showTileAABBs=C,C&&this._update())}_setCacheLimits(C,te){!function(C,te){Je=C,Qe=te}(C,te)}get version(){return he}},NavigationControl:class{constructor(C){this.options=k({},BI,C),this._container=pt("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",(C=>C.preventDefault())),this.options.showZoom&&(j(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",(C=>{this._map&&this._map.zoomIn({},{originalEvent:C})})),pt("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",(C=>{this._map&&this._map.zoomOut({},{originalEvent:C})})),pt("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(j(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",(C=>{const te=this._map;te&&(this.options.visualizePitch?te.resetNorthPitch({},{originalEvent:C}):te.resetNorth({},{originalEvent:C}))})),this._compassIcon=pt("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const C=this._map;if(!C)return;const te=C.getZoom(),le=te===C.getMaxZoom(),ce=te===C.getMinZoom();this._zoomInButton.disabled=le,this._zoomOutButton.disabled=ce,this._zoomInButton.setAttribute("aria-disabled",le.toString()),this._zoomOutButton.setAttribute("aria-disabled",ce.toString())}_rotateCompassArrow(){const C=this._map;if(!C)return;const te=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(C.transform.pitch*(Math.PI/180)),.5)}) rotateX(${C.transform.pitch}deg) rotateZ(${C.transform.angle*(180/Math.PI)}deg)`:`rotate(${C.transform.angle*(180/Math.PI)}deg)`;C._requestDomTask((()=>{this._compassIcon&&(this._compassIcon.style.transform=te)}))}onAdd(C){return this._map=C,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),C.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&C.on("pitch",this._rotateCompassArrow),C.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new mI(C,this._compass,this.options.visualizePitch)),this._container}onRemove(){const C=this._map;C&&(this._container.remove(),this.options.showZoom&&C.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&C.off("pitch",this._rotateCompassArrow),C.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(C,te){const le=pt("button",C,this._container);return le.type="button",le.addEventListener("click",te),le}_setButtonTitle(C,te){if(!this._map)return;const le=this._map._getUIString(`NavigationControl.${te}`);C.setAttribute("aria-label",le),C.firstElementChild&&C.firstElementChild.setAttribute("title",le)}},GeolocateControl:class extends zt{constructor(C){super(),this.options=k({geolocation:le.navigator.geolocation},FI,C),j(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=rS(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(C){return this._map=C,this._container=pt("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){void 0!==this._geolocationWatchID&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(C){const i=(te=!!this.options.geolocation)=>{this._supportsGeolocation=te,C(te)};void 0!==this._supportsGeolocation?C(this._supportsGeolocation):void 0!==le.navigator.permissions?le.navigator.permissions.query({name:"geolocation"}).then((C=>i("denied"!==C.state))).catch((()=>i())):i()}_isOutOfMapMaxBounds(C){const te=this._map.getMaxBounds(),le=C.coords;return!!te&&(le.longitude<te.getWest()||le.longitude>te.getEast()||le.latitude<te.getSouth()||le.latitude>te.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(C){if(this._map){if(this._isOutOfMapMaxBounds(C))return this._setErrorState(),this.fire(new It("outofmaxbounds",C)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=C,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(C),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(C),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new It("geolocate",C)),this._finish()}}_updateCamera(C){const te=new $f(C.coords.longitude,C.coords.latitude),le=C.coords.accuracy,ce=k({bearing:this._map.getBearing()},this.options.fitBoundsOptions);this._map.fitBounds(te.toBounds(le),ce,{geolocateSource:!0})}_updateMarker(C){if(C){const te=new $f(C.coords.longitude,C.coords.latitude);this._accuracyCircleMarker.setLngLat(te).addTo(this._map),this._userLocationDotMarker.setLngLat(te).addTo(this._map),this._accuracy=C.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const C=this._map.transform,te=Qd(1,C._center.lat)*C.worldSize,le=Math.ceil(2*this._accuracy*te);this._circleElement.style.width=`${le}px`,this._circleElement.style.height=`${le}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&"number"==typeof this._heading?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(C){if(this._map){if(this.options.trackUserLocation)if(1===C.code){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const C=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",C),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",C),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===C.code&&this._noTimeout)return;this._setErrorState()}"OFF"!==this._watchState&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new It("error",C)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(C){if(void 0!==this._map){if(this._container.addEventListener("contextmenu",(C=>C.preventDefault())),this._geolocateButton=pt("button","mapboxgl-ctrl-geolocate",this._container),pt("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",!1===C){H("Geolocation support is not available so the GeolocateControl will be disabled.");const C=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",C),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",C)}else{const C=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",C),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",C)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=pt("div","mapboxgl-user-location"),this._dotElement.appendChild(pt("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(pt("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new aI({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=pt("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new aI({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(C=>{C.geolocateSource||"ACTIVE_LOCK"!==this._watchState||C.originalEvent&&"resize"===C.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new It("trackuserlocationend")))}))}}_onDeviceOrientation(C){this._userLocationDotMarker&&(C.webkitCompassHeading?this._heading=C.webkitCompassHeading:!0===C.absolute&&(this._heading=-1*C.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return H("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new It("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new It("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new It("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let C;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(C={maximumAge:6e5,timeout:0},this._noTimeout=!0):(C=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,C),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const e=()=>{le.addEventListener("ondeviceorientationabsolute"in le?"deviceorientationabsolute":"deviceorientation",this._onDeviceOrientation)};void 0!==le.DeviceMotionEvent&&"function"==typeof le.DeviceMotionEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((C=>{"granted"===C&&e()})).catch(console.error):e()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),le.removeEventListener("deviceorientation",this._onDeviceOrientation),le.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:iI,ScaleControl:class{constructor(C){this.options=k({},NI,C),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch(C){return!1}}(),j(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const C=this.options.maxWidth||100,te=this._map,le=te._containerHeight/2,ce=te._containerWidth/2-C/2,he=te.unproject([ce,le]),ue=te.unproject([ce+C,le]),de=he.distanceTo(ue);if("imperial"===this.options.unit){const te=3.2808*de;te>5280?this._setScale(C,te/5280,"mile"):this._setScale(C,te,"foot")}else"nautical"===this.options.unit?this._setScale(C,de/1852,"nautical-mile"):de>=1e3?this._setScale(C,de/1e3,"kilometer"):this._setScale(C,de,"meter")}_setScale(C,te,le){this._map._requestDomTask((()=>{const ce=function(C){const te=Math.pow(10,`${Math.floor(C)}`.length-1);let le=C/te;return le=le>=10?10:le>=5?5:le>=3?3:le>=2?2:le>=1?1:function(C){const te=Math.pow(10,Math.ceil(-Math.log(C)/Math.LN10));return Math.round(C*te)/te}(le),te*le}(te),he=ce/te;this._container.innerHTML=this._isNumberFormatSupported&&"nautical-mile"!==le?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:le}).format(ce):`${ce}&nbsp;${jI[le]}`,this._container.style.width=C*he+"px"}))}onAdd(C){return this._map=C,this._language=C.getLanguage(),this._container=pt("div","mapboxgl-ctrl mapboxgl-ctrl-scale",C.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(C){this._language=C,this._update()}setUnit(C){this.options.unit=C,this._update()}},FullscreenControl:class{constructor(C){this._fullscreen=!1,C&&C.container&&(C.container instanceof le.HTMLElement?this._container=C.container:H("Full screen control 'container' must be a DOM element.")),j(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in le.document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in le.document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(C){return this._map=C,this._container||(this._container=this._map.getContainer()),this._controlContainer=pt("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",H("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,le.document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!le.document.fullscreenEnabled&&!le.document.webkitFullscreenEnabled)}_setupUI(){const C=this._fullscreenButton=pt("button","mapboxgl-ctrl-fullscreen",this._controlContainer);pt("span","mapboxgl-ctrl-icon",C).setAttribute("aria-hidden","true"),C.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),le.document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const C=this._getTitle();this._fullscreenButton.setAttribute("aria-label",C),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",C)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(le.document.fullscreenElement||le.document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?le.document.exitFullscreen?le.document.exitFullscreen():le.document.webkitCancelFullScreen&&le.document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends zt{constructor(C){super(),this.options=k(Object.create(RI),C),j(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(C&&C.className?C.className.trim().split(/\s+/):[])}addTo(C){return this._map&&this.remove(),this._map=C,this.options.closeOnClick&&C.on("preclick",this._onClose),this.options.closeOnMove&&C.on("move",this._onClose),C.on("remove",this.remove),this._update(),C._addPopup(this),this._focusFirstElement(),this._trackPointer?(C.on("mousemove",this._onMouseEvent),C.on("mouseup",this._onMouseEvent),C._canvasContainer.classList.add("mapboxgl-track-pointer")):C.on("move",this._update),this.fire(new It("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const C=this._map;return C&&(C.off("move",this._update),C.off("move",this._onClose),C.off("preclick",this._onClose),C.off("click",this._onClose),C.off("remove",this.remove),C.off("mousemove",this._onMouseEvent),C.off("mouseup",this._onMouseEvent),C.off("drag",this._onMouseEvent),C._canvasContainer&&C._canvasContainer.classList.remove("mapboxgl-track-pointer"),C._removePopup(this),this._map=void 0),this.fire(new It("close")),this}getLngLat(){return this._lngLat}setLngLat(C){this._lngLat=$f.convert(C),this._pos=null,this._trackPointer=!1,this._update();const te=this._map;return te&&(te.on("move",this._update),te.off("mousemove",this._onMouseEvent),te._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const C=this._map;return C&&(C.off("move",this._update),C.on("mousemove",this._onMouseEvent),C.on("drag",this._onMouseEvent),C._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(C){return this.setDOMContent(le.document.createTextNode(C))}setHTML(C){const te=le.document.createDocumentFragment(),ce=le.document.createElement("body");let he;for(ce.innerHTML=C;he=ce.firstChild,he;)te.appendChild(he);return this.setDOMContent(te)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(C){return this.options.maxWidth=C,this._update(),this}setDOMContent(C){let te=this._content;if(te)for(;te.hasChildNodes();)te.firstChild&&te.removeChild(te.firstChild);else te=this._content=pt("div","mapboxgl-popup-content",this._container||void 0);if(te.appendChild(C),this.options.closeButton){const C=this._closeButton=pt("button","mapboxgl-popup-close-button",te);C.type="button",C.setAttribute("aria-label","Close popup"),C.setAttribute("aria-hidden","true"),C.innerHTML="&#215;",C.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(C){return this._classList.add(C),this._updateClassList(),this}removeClassName(C){return this._classList.delete(C),this._updateClassList(),this}setOffset(C){return this.options.offset=C,this._update(),this}toggleClassName(C){let te;return this._classList.delete(C)?te=!1:(this._classList.add(C),te=!0),this._updateClassList(),te}_onMouseEvent(C){this._update(C.point)}_getAnchor(C){if(this.options.anchor)return this.options.anchor;const te=this._map,le=this._container,ce=this._pos;if(!te||!le||!ce)return"bottom";const he=le.offsetWidth,ue=le.offsetHeight,de=ce.x<he/2,_e=ce.x>te.transform.width-he/2;if(ce.y+C<ue)return de?"top-left":_e?"top-right":"top";if(ce.y>te.transform.height-ue){if(de)return"bottom-left";if(_e)return"bottom-right"}return de?"left":_e?"right":"bottom"}_updateClassList(){const C=this._container;if(!C)return;const te=[...this._classList];te.push("mapboxgl-popup"),this._anchor&&te.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&te.push("mapboxgl-popup-track-pointer"),C.className=te.join(" ")}_update(C){const te=this._map,le=this._content;if(!te||!this._lngLat&&!this._trackPointer||!le)return;let ce=this._container;if(ce||(ce=this._container=pt("div","mapboxgl-popup",te.getContainer()),this._tip=pt("div","mapboxgl-popup-tip",ce),ce.appendChild(le)),this.options.maxWidth&&ce.style.maxWidth!==this.options.maxWidth&&(ce.style.maxWidth=this.options.maxWidth),te.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=oI(this._lngLat,this._pos,te.transform)),!this._trackPointer||C){const le=this._pos=this._trackPointer&&C?C:te.project(this._lngLat),ce=hI(this.options.offset),he=this._anchor=this._getAnchor(ce.y),ue=hI(this.options.offset,he),de=le.add(ue).round();te._requestDomTask((()=>{this._container&&he&&(this._container.style.transform=`${PI[he]} translate(${de.x}px,${de.y}px)`)}))}if(!this._marker&&te._showingGlobe()){const C=Nd(te.transform,this._lngLat)?0:1;this._setOpacity(C)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const C=this._container.querySelector(kI);C&&C.focus()}_onClose(){this.remove()}_setOpacity(C){this._container&&(this._container.style.opacity=`${C}`),this._content&&(this._content.style.pointerEvents=C?"auto":"none")}},Marker:aI,Style:iS,LngLat:$f,LngLatBounds:sc,Point:je,MercatorCoordinate:lp,FreeCameraOptions:Xx,Evented:zt,config:de,prewarm:function(){Ww().acquire(lS)},clearPrewarmedResources:function(){const C=cS;C&&(C.isPreloaded()&&1===C.numActive()?(C.release(lS),cS=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},get accessToken(){return de.ACCESS_TOKEN},set accessToken(C){de.ACCESS_TOKEN=C},get baseApiUrl(){return de.API_URL},set baseApiUrl(C){de.API_URL=C},get workerCount(){return Zw.workerCount},set workerCount(C){Zw.workerCount=C},get maxParallelImageRequests(){return de.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(C){de.MAX_PARALLEL_IMAGE_REQUESTS=C},clearStorage(C){!function(C){if(!pe())return;const te=le.caches.delete(Ye);C&&te.catch(C).then((()=>C()))}(C)},workerUrl:"",workerClass:null,get dracoUrl(){return Jw()},set dracoUrl(C){!function(C){ES=bi.resolveURL(C),VS||(VS=new Ew(Ww(),new zt)),VS.broadcast("setDracoUrl",ES)}(C)},setNow:bi.setNow,restoreNow:bi.restoreNow};C.A=Tw,C.D=Ym,C.E=Mn,C.F=Qm,C.K=xE,C.O=qu,C.P=je,C.T=Zv,C.V=y_,C.a=a_,C.b=S_,C.c=ow,C.d=class extends zt{constructor(C,te,le,ce,he,ue){super(),this.actor=C,this.layerIndex=te,this.availableImages=le,this.loadVectorData=he||Uw,this.loading={},this.loaded={},this.deduped=new Nw(C.scheduler),this.isSpriteLoaded=ce,this.scheduler=C.scheduler,this.brightness=ue}loadTile(C,te){const le=C.uid,ce=C&&C.request,he=ce&&ce.collectResourceTiming,ue=this.loading[le]=new Bw(C);ue.abort=this.loadVectorData(C,((de,_e)=>{const ye=!this.loading[le];if(delete this.loading[le],ye||de||!_e)return ue.status="done",ye||(this.loaded[le]=ue),te(de);const ve=_e.rawData,Se={};_e.expires&&(Se.expires=_e.expires),_e.cacheControl&&(Se.cacheControl=_e.cacheControl),ue.vectorTile=_e.vectorTile||new __(new J_(ve));const u=()=>{ue.parse(ue.vectorTile,this.layerIndex,this.availableImages,this.actor,((C,le)=>{if(C||!le)return te(C);const ue={};if(he){const C=it(ce);C.length>0&&(ue.resourceTiming=JSON.parse(JSON.stringify(C)))}te(null,k({rawTileData:ve.slice(0)},le,Se,ue))}))};this.isSpriteLoaded?u():this.once("isSpriteLoaded",(()=>{this.scheduler?this.scheduler.add(u,{type:"parseTile",isSymbolTile:C.isSymbolTile,zoom:C.tileZoom}):u()})),this.loaded=this.loaded||{},this.loaded[le]=ue}))}reloadTile(C,te){const le=this.loaded,ce=C.uid,he=this;if(le&&le[ce]){const ue=le[ce];ue.showCollisionBoxes=C.showCollisionBoxes,ue.projection=C.projection,ue.brightness=C.brightness,ue.tileTransform=Pg(C.tileID.canonical,C.projection),ue.extraShadowCaster=C.extraShadowCaster;const s=(C,le)=>{const ce=ue.reloadCallback;ce&&(delete ue.reloadCallback,ue.parse(ue.vectorTile,he.layerIndex,this.availableImages,he.actor,ce)),te(C,le)};"parsing"===ue.status?ue.reloadCallback=s:"done"===ue.status&&(ue.vectorTile?ue.parse(ue.vectorTile,this.layerIndex,this.availableImages,this.actor,s):s())}else te(null,void 0)}abortTile(C,te){const le=C.uid,ce=this.loading[le];ce&&(ce.abort&&ce.abort(),delete this.loading[le]),te()}removeTile(C,te){const le=this.loaded,ce=C.uid;le&&le[ce]&&delete le[ce],te()}},C.e=Eo,C.f=it,C.g=d,C.h=we,C.i=Te,C.j=function(C,te){const le=TT(C);for(const C of le){for(const te of C.meshes)ET(te);C.lights&&(C.lightMeshIndex=C.meshes.length,C.meshes.push(MT(C.lights,te)))}return le},C.k=oa,C.l=function(C){let te=0;if(new Uint32Array(C,0,1)[0]!==RM){const le=new Uint32Array(C,0,7),[,,ce,he,ue,de]=le;te=le.byteLength+he+ue+de+ue,(ce!==C.byteLength||te>=C.byteLength)&&H("Invalid b3dm header information.")}return pT(C,te)},C.m=ty,C.n=lc,C.o=It,C.p=Ne,C.q=function(C){fe(),tt&&tt.then((te=>{te.keys().then((le=>{for(let ce=0;ce<le.length-C;ce++)te.delete(le[ce])}))}))},C.r=GM,C.s=UI,C.t=ap,C.v=L,C.w=le}));define(["./shared"],(function(C){function t(C){if("number"==typeof C||"boolean"==typeof C||"string"==typeof C||null==C)return JSON.stringify(C);if(Array.isArray(C)){let te="[";for(const le of C)te+=`${t(le)},`;return`${te}]`}let te="{";for(const le of Object.keys(C).sort())te+=`${le}:${t(C[le])},`;return`${te}}`}function r(te){let le="";for(const ce of C.r)le+=`/${t(te[ce])}`;return le}class o{constructor(C){this.keyCache={},this._layers={},this._layerConfigs={},C&&this.replace(C)}replace(C,te){this._layerConfigs={},this._layers={},this.update(C,[],te)}update(te,le,ce){this._options=ce;for(const le of te){this._layerConfigs[le.id]=le;const te=this._layers[le.id]=C.c(le,this._options);te.setScope(this.scope),te.compileFilter(),this.keyCache[le.id]&&delete this.keyCache[le.id]}for(const C of le)delete this.keyCache[C],delete this._layerConfigs[C],delete this._layers[C];this.familiesBySource={};const he=function(C,te){const le={};for(let ce=0;ce<C.length;ce++){const he=te&&te[C[ce].id]||r(C[ce]);te&&(te[C[ce].id]=he);let ue=le[he];ue||(ue=le[he]=[]),ue.push(C[ce])}const ce=[];for(const C in le)ce.push(le[C]);return ce}(C.v(this._layerConfigs),this.keyCache);for(const C of he){const te=C.map((C=>this._layers[C.id])),le=te[0];if("none"===le.visibility)continue;const ce=le.source||"";let he=this.familiesBySource[ce];he||(he=this.familiesBySource[ce]={});const ue=le.sourceLayer||"_geojsonTileLayer";let de=he[ue];de||(de=he[ue]=[]),de.push(te)}}}class i{loadTile(te,le){const{uid:ce,encoding:he,rawImageData:ue,padding:de}=te,_e=C.w.ImageBitmap&&ue instanceof C.w.ImageBitmap?this.getImageData(ue,de):ue;le(null,new C.D(ce,_e,he,de<1))}getImageData(C,te){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(C.width,C.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=C.width,this.offscreenCanvas.height=C.height,this.offscreenCanvasContext.drawImage(C,0,0,C.width,C.height);const le=this.offscreenCanvasContext.getImageData(-te,-te,C.width+2*te,C.height+2*te);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),le}}function s(C,te){if(0!==C.length){n(C[0],te);for(var le=1;le<C.length;le++)n(C[le],!te)}}function n(C,te){for(var le=0,ce=0,he=0,ue=C.length,de=ue-1;he<ue;de=he++){var _e=(C[he][0]-C[de][0])*(C[de][1]+C[he][1]),ye=le+_e;ce+=Math.abs(le)>=Math.abs(_e)?le-ye+_e:_e-ye+le,le=ye}le+ce>=0!=!!te&&C.reverse()}var le=C.g((function e(C,te){var le,ce=C&&C.type;if("FeatureCollection"===ce)for(le=0;le<C.features.length;le++)e(C.features[le],te);else if("GeometryCollection"===ce)for(le=0;le<C.geometries.length;le++)e(C.geometries[le],te);else if("Feature"===ce)e(C.geometry,te);else if("Polygon"===ce)s(C.coordinates,te);else if("MultiPolygon"===ce)for(le=0;le<C.coordinates.length;le++)s(C.coordinates[le],te);return C}));const ce=C.V.prototype.toGeoJSON;var he={exports:{}},ue=C.p,de=C.a.VectorTileFeature,_e=d;function d(C,le){(this||te).options=le||{},(this||te).features=C,(this||te).length=C.length}function p(C,le){(this||te).id="number"==typeof C.id?C.id:void 0,(this||te).type=C.type,(this||te).rawGeometry=1===C.type?[C.geometry]:C.geometry,(this||te).properties=C.tags,(this||te).extent=le||4096}d.prototype.feature=function(C){return new p((this||te).features[C],(this||te).options.extent)},p.prototype.loadGeometry=function(){var C=(this||te).rawGeometry;(this||te).geometry=[];for(var le=0;le<C.length;le++){for(var ce=C[le],he=[],de=0;de<ce.length;de++)he.push(new ue(ce[de][0],ce[de][1]));(this||te).geometry.push(he)}return(this||te).geometry},p.prototype.bbox=function(){(this||te).geometry||this.loadGeometry();for(var C=(this||te).geometry,le=1/0,ce=-1/0,he=1/0,ue=-1/0,de=0;de<C.length;de++)for(var _e=C[de],ye=0;ye<_e.length;ye++){var ve=_e[ye];le=Math.min(le,ve.x),ce=Math.max(ce,ve.x),he=Math.min(he,ve.y),ue=Math.max(ue,ve.y)}return[le,he,ce,ue]},p.prototype.toGeoJSON=de.prototype.toGeoJSON;var ye=C.b,ve=_e;function y(C){var te=new ye;return function(C,te){for(var le in C.layers)te.writeMessage(3,v,C.layers[le])}(C,te),te.finish()}function v(C,te){var le;te.writeVarintField(15,C.version||1),te.writeStringField(1,C.name||""),te.writeVarintField(5,C.extent||4096);var ce={keys:[],values:[],keycache:{},valuecache:{}};for(le=0;le<C.length;le++)ce.feature=C.feature(le),te.writeMessage(2,w,ce);var he=ce.keys;for(le=0;le<he.length;le++)te.writeStringField(3,he[le]);var ue=ce.values;for(le=0;le<ue.length;le++)te.writeMessage(4,I,ue[le])}function w(C,te){var le=C.feature;void 0!==le.id&&te.writeVarintField(1,le.id),te.writeMessage(2,x,C),te.writeVarintField(3,le.type),te.writeMessage(4,b,le)}function x(C,te){var le=C.feature,ce=C.keys,he=C.values,ue=C.keycache,de=C.valuecache;for(var _e in le.properties){var ye=le.properties[_e],ve=ue[_e];if(null!==ye){void 0===ve&&(ce.push(_e),ue[_e]=ve=ce.length-1),te.writeVarint(ve);var Se=typeof ye;"string"!==Se&&"boolean"!==Se&&"number"!==Se&&(ye=JSON.stringify(ye));var Me=Se+":"+ye,Ae=de[Me];void 0===Ae&&(he.push(ye),de[Me]=Ae=he.length-1),te.writeVarint(Ae)}}}function S(C,te){return(te<<3)+(7&C)}function M(C){return C<<1^C>>31}function b(C,te){for(var le=C.loadGeometry(),ce=C.type,he=0,ue=0,de=le.length,_e=0;_e<de;_e++){var ye=le[_e],ve=1;1===ce&&(ve=ye.length),te.writeVarint(S(1,ve));for(var Se=3===ce?ye.length-1:ye.length,Me=0;Me<Se;Me++){1===Me&&1!==ce&&te.writeVarint(S(2,Se-1));var Ae=ye[Me].x-he,Ce=ye[Me].y-ue;te.writeVarint(M(Ae)),te.writeVarint(M(Ce)),he+=Ae,ue+=Ce}3===ce&&te.writeVarint(S(7,1))}}function I(C,te){var le=typeof C;"string"===le?te.writeStringField(1,C):"boolean"===le?te.writeBooleanField(7,C):"number"===le&&(C%1!=0?te.writeDoubleField(3,C):C<0?te.writeSVarintField(6,C):te.writeVarintField(5,C))}he.exports=y,he.exports.fromVectorTileJs=y,he.exports.fromGeojsonVt=function(C,te){te=te||{};var le={};for(var ce in C)le[ce]=new ve(C[ce].features,te),le[ce].name=ce,le[ce].version=te.version,le[ce].extent=te.extent;return y({layers:le})},he.exports.GeoJSONWrapper=ve;var Se=C.g(he.exports);const Me={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:C=>C},Ae=Math.fround||(Ce=new Float32Array(1),C=>(Ce[0]=+C,Ce[0]));var Ce;const Oe=3,Ne=5,je=6;class j{constructor(C){this.options=Object.assign(Object.create(Me),C),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(C){const{log:te,minZoom:le,maxZoom:ce}=this.options;te&&console.time("total time");const he=`prepare ${C.length} points`;te&&console.time(he),this.points=C;const ue=[];for(let te=0;te<C.length;te++){const le=C[te];if(!le.geometry)continue;const[ce,he]=le.geometry.coordinates,de=Ae(z(ce)),_e=Ae(D(he));ue.push(de,_e,1/0,te,-1,1),this.options.reduce&&ue.push(0)}let de=this.trees[ce+1]=this._createTree(ue);te&&console.timeEnd(he);for(let C=ce;C>=le;C--){const le=+Date.now();de=this.trees[C]=this._createTree(this._cluster(de,C)),te&&console.log("z%d: %d clusters in %dms",C,de.numItems,+Date.now()-le)}return te&&console.timeEnd("total time"),this}getClusters(C,te){let le=((C[0]+180)%360+360)%360-180;const ce=Math.max(-90,Math.min(90,C[1]));let he=180===C[2]?180:((C[2]+180)%360+360)%360-180;const ue=Math.max(-90,Math.min(90,C[3]));if(C[2]-C[0]>=360)le=-180,he=180;else if(le>he){const C=this.getClusters([le,ce,180,ue],te),de=this.getClusters([-180,ce,he,ue],te);return C.concat(de)}const de=this.trees[this._limitZoom(te)],_e=de.range(z(le),D(ue),z(he),D(ce)),ye=de.data,ve=[];for(const C of _e){const te=this.stride*C;ve.push(ye[te+Ne]>1?F(ye,te,this.clusterProps):this.points[ye[te+Oe]])}return ve}getChildren(C){const te=this._getOriginId(C),le=this._getOriginZoom(C),ce="No cluster with the specified id.",he=this.trees[le];if(!he)throw new Error(ce);const ue=he.data;if(te*this.stride>=ue.length)throw new Error(ce);const de=this.options.radius/(this.options.extent*Math.pow(2,le-1)),_e=he.within(ue[te*this.stride],ue[te*this.stride+1],de),ye=[];for(const te of _e){const le=te*this.stride;ue[le+4]===C&&ye.push(ue[le+Ne]>1?F(ue,le,this.clusterProps):this.points[ue[le+Oe]])}if(0===ye.length)throw new Error(ce);return ye}getLeaves(C,te,le){const ce=[];return this._appendLeaves(ce,C,te=te||10,le=le||0,0),ce}getTile(C,te,le){const ce=this.trees[this._limitZoom(C)],he=Math.pow(2,C),{extent:ue,radius:de}=this.options,_e=de/ue,ye=(le-_e)/he,ve=(le+1+_e)/he,Se={features:[]};return this._addTileFeatures(ce.range((te-_e)/he,ye,(te+1+_e)/he,ve),ce.data,te,le,he,Se),0===te&&this._addTileFeatures(ce.range(1-_e/he,ye,1,ve),ce.data,he,le,he,Se),te===he-1&&this._addTileFeatures(ce.range(0,ye,_e/he,ve),ce.data,-1,le,he,Se),Se.features.length?Se:null}getClusterExpansionZoom(C){let te=this._getOriginZoom(C)-1;for(;te<=this.options.maxZoom;){const le=this.getChildren(C);if(te++,1!==le.length)break;C=le[0].properties.cluster_id}return te}_appendLeaves(C,te,le,ce,he){const ue=this.getChildren(te);for(const te of ue){const ue=te.properties;if(ue&&ue.cluster?he+ue.point_count<=ce?he+=ue.point_count:he=this._appendLeaves(C,ue.cluster_id,le,ce,he):he<ce?he++:C.push(te),C.length===le)break}return he}_createTree(te){const le=new C.K(te.length/this.stride|0,this.options.nodeSize,Float32Array);for(let C=0;C<te.length;C+=this.stride)le.add(te[C],te[C+1]);return le.finish(),le.data=te,le}_addTileFeatures(C,te,le,ce,he,ue){for(const de of C){const C=de*this.stride,_e=te[C+Ne]>1;let ye,ve,Se;if(_e)ye=Z(te,C,this.clusterProps),ve=te[C],Se=te[C+1];else{const le=this.points[te[C+Oe]];ye=le.properties;const[ce,he]=le.geometry.coordinates;ve=z(ce),Se=D(he)}const Me={type:1,geometry:[[Math.round(this.options.extent*(ve*he-le)),Math.round(this.options.extent*(Se*he-ce))]],tags:ye};let Ae;Ae=_e||this.options.generateId?te[C+Oe]:this.points[te[C+Oe]].id,void 0!==Ae&&(Me.id=Ae),ue.features.push(Me)}}_limitZoom(C){return Math.max(this.options.minZoom,Math.min(Math.floor(+C),this.options.maxZoom+1))}_cluster(C,te){const{radius:le,extent:ce,reduce:he,minPoints:ue}=this.options,de=le/(ce*Math.pow(2,te)),_e=C.data,ye=[],ve=this.stride;for(let le=0;le<_e.length;le+=ve){if(_e[le+2]<=te)continue;_e[le+2]=te;const ce=_e[le],Se=_e[le+1],Me=C.within(_e[le],_e[le+1],de),Ae=_e[le+Ne];let Ce=Ae;for(const C of Me){const le=C*ve;_e[le+2]>te&&(Ce+=_e[le+Ne])}if(Ce>Ae&&Ce>=ue){let C,ue=ce*Ae,de=Se*Ae,Oe=-1;const je=((le/ve|0)<<5)+(te+1)+this.points.length;for(const ce of Me){const ye=ce*ve;if(_e[ye+2]<=te)continue;_e[ye+2]=te;const Se=_e[ye+Ne];ue+=_e[ye]*Se,de+=_e[ye+1]*Se,_e[ye+4]=je,he&&(C||(C=this._map(_e,le,!0),Oe=this.clusterProps.length,this.clusterProps.push(C)),he(C,this._map(_e,ye)))}_e[le+4]=je,ye.push(ue/Ce,de/Ce,1/0,je,-1,Ce),he&&ye.push(Oe)}else{for(let C=0;C<ve;C++)ye.push(_e[le+C]);if(Ce>1)for(const C of Me){const le=C*ve;if(!(_e[le+2]<=te)){_e[le+2]=te;for(let C=0;C<ve;C++)ye.push(_e[le+C])}}}}return ye}_getOriginId(C){return C-this.points.length>>5}_getOriginZoom(C){return(C-this.points.length)%32}_map(C,te,le){if(C[te+Ne]>1){const ce=this.clusterProps[C[te+je]];return le?Object.assign({},ce):ce}const ce=this.points[C[te+Oe]].properties,he=this.options.map(ce);return le&&he===ce?Object.assign({},he):he}}function F(C,te,le){return{type:"Feature",id:C[te+Oe],properties:Z(C,te,le),geometry:{type:"Point",coordinates:[(ce=C[te],360*(ce-.5)),E(C[te+1])]}};var ce}function Z(C,te,le){const ce=C[te+Ne],he=ce>=1e4?`${Math.round(ce/1e3)}k`:ce>=1e3?Math.round(ce/100)/10+"k":ce,ue=C[te+je],de=-1===ue?{}:Object.assign({},le[ue]);return Object.assign(de,{cluster:!0,cluster_id:C[te+Oe],point_count:ce,point_count_abbreviated:he})}function z(C){return C/360+.5}function D(C){const te=Math.sin(C*Math.PI/180),le=.5-.25*Math.log((1+te)/(1-te))/Math.PI;return le<0?0:le>1?1:le}function E(C){const te=(180-360*C)*Math.PI/180;return 360*Math.atan(Math.exp(te))/Math.PI-90}var Ge={exports:{}};Ge.exports=function(){function e(C,te,le,ce){for(var he,ue=ce,de=le-te>>1,_e=le-te,ye=C[te],ve=C[te+1],Se=C[le],Me=C[le+1],Ae=te+3;Ae<le;Ae+=3){var Ce=t(C[Ae],C[Ae+1],ye,ve,Se,Me);if(Ce>ue)he=Ae,ue=Ce;else if(Ce===ue){var Oe=Math.abs(Ae-de);Oe<_e&&(he=Ae,_e=Oe)}}ue>ce&&(he-te>3&&e(C,te,he,ce),C[he+2]=ue,le-he>3&&e(C,he,le,ce))}function t(C,te,le,ce,he,ue){var de=he-le,_e=ue-ce;if(0!==de||0!==_e){var ye=((C-le)*de+(te-ce)*_e)/(de*de+_e*_e);ye>1?(le=he,ce=ue):ye>0&&(le+=de*ye,ce+=_e*ye)}return(de=C-le)*de+(_e=te-ce)*_e}function r(C,te,le,ce){var he={id:void 0===C?null:C,type:te,geometry:le,tags:ce,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(C){var te=C.geometry,le=C.type;if("Point"===le||"MultiPoint"===le||"LineString"===le)o(C,te);else if("Polygon"===le||"MultiLineString"===le)for(var ce=0;ce<te.length;ce++)o(C,te[ce]);else if("MultiPolygon"===le)for(ce=0;ce<te.length;ce++)for(var he=0;he<te[ce].length;he++)o(C,te[ce][he])}(he),he}function o(C,te){for(var le=0;le<te.length;le+=3)C.minX=Math.min(C.minX,te[le]),C.minY=Math.min(C.minY,te[le+1]),C.maxX=Math.max(C.maxX,te[le]),C.maxY=Math.max(C.maxY,te[le+1])}function i(C,te,le,ce){if(te.geometry){var he=te.geometry.coordinates,ue=te.geometry.type,de=Math.pow(le.tolerance/((1<<le.maxZoom)*le.extent),2),_e=[],ye=te.id;if(le.promoteId?ye=te.properties[le.promoteId]:le.generateId&&(ye=ce||0),"Point"===ue)s(he,_e);else if("MultiPoint"===ue)for(var ve=0;ve<he.length;ve++)s(he[ve],_e);else if("LineString"===ue)n(he,_e,de,!1);else if("MultiLineString"===ue){if(le.lineMetrics){for(ve=0;ve<he.length;ve++)n(he[ve],_e=[],de,!1),C.push(r(ye,"LineString",_e,te.properties));return}a(he,_e,de,!1)}else if("Polygon"===ue)a(he,_e,de,!0);else{if("MultiPolygon"!==ue){if("GeometryCollection"===ue){for(ve=0;ve<te.geometry.geometries.length;ve++)i(C,{id:ye,geometry:te.geometry.geometries[ve],properties:te.properties},le,ce);return}throw new Error("Input data is not a valid GeoJSON object.")}for(ve=0;ve<he.length;ve++){var Se=[];a(he[ve],Se,de,!0),_e.push(Se)}}C.push(r(ye,ue,_e,te.properties))}}function s(C,te){te.push(l(C[0])),te.push(h(C[1])),te.push(0)}function n(C,te,le,ce){for(var he,ue,de=0,_e=0;_e<C.length;_e++){var ye=l(C[_e][0]),ve=h(C[_e][1]);te.push(ye),te.push(ve),te.push(0),_e>0&&(de+=ce?(he*ve-ye*ue)/2:Math.sqrt(Math.pow(ye-he,2)+Math.pow(ve-ue,2))),he=ye,ue=ve}var Se=te.length-3;te[2]=1,e(te,0,Se,le),te[Se+2]=1,te.size=Math.abs(de),te.start=0,te.end=te.size}function a(C,te,le,ce){for(var he=0;he<C.length;he++){var ue=[];n(C[he],ue,le,ce),te.push(ue)}}function l(C){return C/360+.5}function h(C){var te=Math.sin(C*Math.PI/180),le=.5-.25*Math.log((1+te)/(1-te))/Math.PI;return le<0?0:le>1?1:le}function u(C,te,le,ce,he,ue,de,_e){if(ce/=te,ue>=(le/=te)&&de<ce)return C;if(de<le||ue>=ce)return null;for(var ye=[],ve=0;ve<C.length;ve++){var Se=C[ve],Me=Se.geometry,Ae=Se.type,Ce=0===he?Se.minX:Se.minY,Oe=0===he?Se.maxX:Se.maxY;if(Ce>=le&&Oe<ce)ye.push(Se);else if(!(Oe<le||Ce>=ce)){var Ne=[];if("Point"===Ae||"MultiPoint"===Ae)c(Me,Ne,le,ce,he);else if("LineString"===Ae)f(Me,Ne,le,ce,he,!1,_e.lineMetrics);else if("MultiLineString"===Ae)p(Me,Ne,le,ce,he,!1);else if("Polygon"===Ae)p(Me,Ne,le,ce,he,!0);else if("MultiPolygon"===Ae)for(var je=0;je<Me.length;je++){var Ge=[];p(Me[je],Ge,le,ce,he,!0),Ge.length&&Ne.push(Ge)}if(Ne.length){if(_e.lineMetrics&&"LineString"===Ae){for(je=0;je<Ne.length;je++)ye.push(r(Se.id,Ae,Ne[je],Se.tags));continue}"LineString"!==Ae&&"MultiLineString"!==Ae||(1===Ne.length?(Ae="LineString",Ne=Ne[0]):Ae="MultiLineString"),"Point"!==Ae&&"MultiPoint"!==Ae||(Ae=3===Ne.length?"Point":"MultiPoint"),ye.push(r(Se.id,Ae,Ne,Se.tags))}}}return ye.length?ye:null}function c(C,te,le,ce,he){for(var ue=0;ue<C.length;ue+=3){var de=C[ue+he];de>=le&&de<=ce&&(te.push(C[ue]),te.push(C[ue+1]),te.push(C[ue+2]))}}function f(C,te,le,ce,he,ue,de){for(var _e,ye,ve=d(C),Se=0===he?m:y,Me=C.start,Ae=0;Ae<C.length-3;Ae+=3){var Ce=C[Ae],Oe=C[Ae+1],Ne=C[Ae+2],je=C[Ae+3],Ge=C[Ae+4],Ze=0===he?Ce:Oe,qe=0===he?je:Ge,$e=!1;de&&(_e=Math.sqrt(Math.pow(Ce-je,2)+Math.pow(Oe-Ge,2))),Ze<le?qe>le&&(ye=Se(ve,Ce,Oe,je,Ge,le),de&&(ve.start=Me+_e*ye)):Ze>ce?qe<ce&&(ye=Se(ve,Ce,Oe,je,Ge,ce),de&&(ve.start=Me+_e*ye)):g(ve,Ce,Oe,Ne),qe<le&&Ze>=le&&(ye=Se(ve,Ce,Oe,je,Ge,le),$e=!0),qe>ce&&Ze<=ce&&(ye=Se(ve,Ce,Oe,je,Ge,ce),$e=!0),!ue&&$e&&(de&&(ve.end=Me+_e*ye),te.push(ve),ve=d(C)),de&&(Me+=_e)}var He=C.length-3;Ce=C[He],Oe=C[He+1],Ne=C[He+2],(Ze=0===he?Ce:Oe)>=le&&Ze<=ce&&g(ve,Ce,Oe,Ne),He=ve.length-3,ue&&He>=3&&(ve[He]!==ve[0]||ve[He+1]!==ve[1])&&g(ve,ve[0],ve[1],ve[2]),ve.length&&te.push(ve)}function d(C){var te=[];return te.size=C.size,te.start=C.start,te.end=C.end,te}function p(C,te,le,ce,he,ue){for(var de=0;de<C.length;de++)f(C[de],te,le,ce,he,ue,!1)}function g(C,te,le,ce){C.push(te),C.push(le),C.push(ce)}function m(C,te,le,ce,he,ue){var de=(ue-te)/(ce-te);return C.push(ue),C.push(le+(he-le)*de),C.push(1),de}function y(C,te,le,ce,he,ue){var de=(ue-le)/(he-le);return C.push(te+(ce-te)*de),C.push(ue),C.push(1),de}function v(C,te){for(var le=[],ce=0;ce<C.length;ce++){var he,ue=C[ce],de=ue.type;if("Point"===de||"MultiPoint"===de||"LineString"===de)he=w(ue.geometry,te);else if("MultiLineString"===de||"Polygon"===de){he=[];for(var _e=0;_e<ue.geometry.length;_e++)he.push(w(ue.geometry[_e],te))}else if("MultiPolygon"===de)for(he=[],_e=0;_e<ue.geometry.length;_e++){for(var ye=[],ve=0;ve<ue.geometry[_e].length;ve++)ye.push(w(ue.geometry[_e][ve],te));he.push(ye)}le.push(r(ue.id,de,he,ue.tags))}return le}function w(C,te){var le=[];le.size=C.size,void 0!==C.start&&(le.start=C.start,le.end=C.end);for(var ce=0;ce<C.length;ce+=3)le.push(C[ce]+te,C[ce+1],C[ce+2]);return le}function x(C,te){if(C.transformed)return C;var le,ce,he,ue=1<<C.z,de=C.x,_e=C.y;for(le=0;le<C.features.length;le++){var ye=C.features[le],ve=ye.geometry,Se=ye.type;if(ye.geometry=[],1===Se)for(ce=0;ce<ve.length;ce+=2)ye.geometry.push(S(ve[ce],ve[ce+1],te,ue,de,_e));else for(ce=0;ce<ve.length;ce++){var Me=[];for(he=0;he<ve[ce].length;he+=2)Me.push(S(ve[ce][he],ve[ce][he+1],te,ue,de,_e));ye.geometry.push(Me)}}return C.transformed=!0,C}function S(C,te,le,ce,he,ue){return[Math.round(le*(C*ce-he)),Math.round(le*(te*ce-ue))]}function M(C,te,le,ce,he){for(var ue=te===he.maxZoom?0:he.tolerance/((1<<te)*he.extent),de={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:le,y:ce,z:te,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},_e=0;_e<C.length;_e++){de.numFeatures++,b(de,C[_e],ue,he);var ye=C[_e].minX,ve=C[_e].minY,Se=C[_e].maxX,Me=C[_e].maxY;ye<de.minX&&(de.minX=ye),ve<de.minY&&(de.minY=ve),Se>de.maxX&&(de.maxX=Se),Me>de.maxY&&(de.maxY=Me)}return de}function b(C,te,le,ce){var he=te.geometry,ue=te.type,de=[];if("Point"===ue||"MultiPoint"===ue)for(var _e=0;_e<he.length;_e+=3)de.push(he[_e]),de.push(he[_e+1]),C.numPoints++,C.numSimplified++;else if("LineString"===ue)I(de,he,C,le,!1,!1);else if("MultiLineString"===ue||"Polygon"===ue)for(_e=0;_e<he.length;_e++)I(de,he[_e],C,le,"Polygon"===ue,0===_e);else if("MultiPolygon"===ue)for(var ye=0;ye<he.length;ye++){var ve=he[ye];for(_e=0;_e<ve.length;_e++)I(de,ve[_e],C,le,!0,0===_e)}if(de.length){var Se=te.tags||null;if("LineString"===ue&&ce.lineMetrics){for(var Me in Se={},te.tags)Se[Me]=te.tags[Me];Se.mapbox_clip_start=he.start/he.size,Se.mapbox_clip_end=he.end/he.size}var Ae={geometry:de,type:"Polygon"===ue||"MultiPolygon"===ue?3:"LineString"===ue||"MultiLineString"===ue?2:1,tags:Se};null!==te.id&&(Ae.id=te.id),C.features.push(Ae)}}function I(C,te,le,ce,he,ue){var de=ce*ce;if(ce>0&&te.size<(he?de:ce))le.numPoints+=te.length/3;else{for(var _e=[],ye=0;ye<te.length;ye+=3)(0===ce||te[ye+2]>de)&&(le.numSimplified++,_e.push(te[ye]),_e.push(te[ye+1])),le.numPoints++;he&&function(C,te){for(var le=0,ce=0,he=C.length,ue=he-2;ce<he;ue=ce,ce+=2)le+=(C[ce]-C[ue])*(C[ce+1]+C[ue+1]);if(le>0===te)for(ce=0,he=C.length;ce<he/2;ce+=2){var de=C[ce],_e=C[ce+1];C[ce]=C[he-2-ce],C[ce+1]=C[he-1-ce],C[he-2-ce]=de,C[he-1-ce]=_e}}(_e,ue),C.push(_e)}}function k(C,le){var ce=(le=(this||te).options=function(C,te){for(var le in te)C[le]=te[le];return C}(Object.create((this||te).options),le)).debug;if(ce&&console.time("preprocess data"),le.maxZoom<0||le.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(le.promoteId&&le.generateId)throw new Error("promoteId and generateId cannot be used together.");var he=function(C,te){var le=[];if("FeatureCollection"===C.type)for(var ce=0;ce<C.features.length;ce++)i(le,C.features[ce],te,ce);else i(le,"Feature"===C.type?C:{geometry:C},te);return le}(C,le);(this||te).tiles={},(this||te).tileCoords=[],ce&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",le.indexMaxZoom,le.indexMaxPoints),console.time("generate tiles"),(this||te).stats={},(this||te).total=0),(he=function(C,te){var le=te.buffer/te.extent,ce=C,he=u(C,1,-1-le,le,0,-1,2,te),ue=u(C,1,1-le,2+le,0,-1,2,te);return(he||ue)&&(ce=u(C,1,-le,1+le,0,-1,2,te)||[],he&&(ce=v(he,1).concat(ce)),ue&&(ce=ce.concat(v(ue,-1)))),ce}(he,le)).length&&this.splitTile(he,0,0,0),ce&&(he.length&&console.log("features: %d, points: %d",(this||te).tiles[0].numFeatures,(this||te).tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",(this||te).total,JSON.stringify((this||te).stats)))}function P(C,te,le){return 32*((1<<C)*le+te)+C}return k.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},k.prototype.splitTile=function(C,le,ce,he,ue,de,_e){for(var ye=[C,le,ce,he],ve=(this||te).options,Se=ve.debug;ye.length;){he=ye.pop(),ce=ye.pop(),le=ye.pop(),C=ye.pop();var Me=1<<le,Ae=P(le,ce,he),Ce=(this||te).tiles[Ae];if(!Ce&&(Se>1&&console.time("creation"),Ce=(this||te).tiles[Ae]=M(C,le,ce,he,ve),(this||te).tileCoords.push({z:le,x:ce,y:he}),Se)){Se>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",le,ce,he,Ce.numFeatures,Ce.numPoints,Ce.numSimplified),console.timeEnd("creation"));var Oe="z"+le;(this||te).stats[Oe]=((this||te).stats[Oe]||0)+1,(this||te).total++}if(Ce.source=C,ue){if(le===ve.maxZoom||le===ue)continue;var Ne=1<<ue-le;if(ce!==Math.floor(de/Ne)||he!==Math.floor(_e/Ne))continue}else if(le===ve.indexMaxZoom||Ce.numPoints<=ve.indexMaxPoints)continue;if(Ce.source=null,0!==C.length){Se>1&&console.time("clipping");var je,Ge,Ze,qe,$e,He,We=.5*ve.buffer/ve.extent,Xe=.5-We,Ye=.5+We,Je=1+We;je=Ge=Ze=qe=null,$e=u(C,Me,ce-We,ce+Ye,0,Ce.minX,Ce.maxX,ve),He=u(C,Me,ce+Xe,ce+Je,0,Ce.minX,Ce.maxX,ve),C=null,$e&&(je=u($e,Me,he-We,he+Ye,1,Ce.minY,Ce.maxY,ve),Ge=u($e,Me,he+Xe,he+Je,1,Ce.minY,Ce.maxY,ve),$e=null),He&&(Ze=u(He,Me,he-We,he+Ye,1,Ce.minY,Ce.maxY,ve),qe=u(He,Me,he+Xe,he+Je,1,Ce.minY,Ce.maxY,ve),He=null),Se>1&&console.timeEnd("clipping"),ye.push(je||[],le+1,2*ce,2*he),ye.push(Ge||[],le+1,2*ce,2*he+1),ye.push(Ze||[],le+1,2*ce+1,2*he),ye.push(qe||[],le+1,2*ce+1,2*he+1)}}},k.prototype.getTile=function(C,le,ce){var he=(this||te).options,ue=he.extent,de=he.debug;if(C<0||C>24)return null;var _e=1<<C,ye=P(C,le=(le%_e+_e)%_e,ce);if((this||te).tiles[ye])return x((this||te).tiles[ye],ue);de>1&&console.log("drilling down to z%d-%d-%d",C,le,ce);for(var ve,Se=C,Me=le,Ae=ce;!ve&&Se>0;)Se--,Me=Math.floor(Me/2),Ae=Math.floor(Ae/2),ve=(this||te).tiles[P(Se,Me,Ae)];return ve&&ve.source?(de>1&&console.log("found parent tile z%d-%d-%d",Se,Me,Ae),de>1&&console.time("drilling down"),this.splitTile(ve.source,Se,Me,Ae,C,le,ce),de>1&&console.timeEnd("drilling down"),(this||te).tiles[ye]?x((this||te).tiles[ye],ue):null):null},function(C,te){return new k(C,te)}}();var Ze=C.g(Ge.exports);function Y(le,he){const ue=le.tileID.canonical;if(!(this||te)._geoJSONIndex)return he(null,null);const de=(this||te)._geoJSONIndex.getTile(ue.z,ue.x,ue.y);if(!de)return he(null,null);const _e=new class{constructor(te){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=C.E,this.length=te.length,this._features=te}feature(te){return new class{constructor(te){this._feature=te,this.extent=C.E,this.type=te.type,this.properties=te.tags,"id"in te&&!isNaN(te.id)&&(this.id=parseInt(te.id,10))}loadGeometry(){if(1===this._feature.type){const te=[];for(const le of this._feature.geometry)te.push([new C.P(le[0],le[1])]);return te}{const te=[];for(const le of this._feature.geometry){const ce=[];for(const te of le)ce.push(new C.P(te[0],te[1]));te.push(ce)}return te}}toGeoJSON(C,te,le){return ce.call(this,C,te,le)}}(this._features[te])}}(de.features);let ye=Se(_e);0===ye.byteOffset&&ye.byteLength===ye.buffer.byteLength||(ye=new Uint8Array(ye)),he(null,{vectorTile:_e,rawData:ye.buffer})}class G extends C.d{constructor(C,te,le,ce,he,ue){super(C,te,le,ce,Y,ue),he&&(this.loadGeoJSON=he)}loadData(te,ce){const he=te&&te.request,ue=he&&he.collectResourceTiming;this.loadGeoJSON(te,((de,_e)=>{if(de||!_e)return ce(de);if("object"!=typeof _e)return ce(new Error(`Input data given to '${te.source}' is not a valid GeoJSON object.`));{le(_e,!0);try{if(te.filter){const le=C.e(te.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===le.result)throw new Error(le.value.map((C=>`${C.key}: ${C.message}`)).join(", "));const ce=_e.features.filter((C=>le.value.evaluate({zoom:0},C)));_e={type:"FeatureCollection",features:ce}}this._geoJSONIndex=te.cluster?new j(function({superclusterOptions:te,clusterProperties:le}){if(!le||!te)return te;const ce={},he={},ue={accumulated:null,zoom:0},de={properties:null},_e=Object.keys(le);for(const te of _e){const[ue,de]=le[te],_e=C.e(de),ye=C.e("string"==typeof ue?[ue,["accumulated"],["get",te]]:ue);ce[te]=_e.value,he[te]=ye.value}return te.map=C=>{de.properties=C;const te={};for(const C of _e)te[C]=ce[C].evaluate(ue,de);return te},te.reduce=(C,te)=>{de.properties=te;for(const te of _e)ue.accumulated=C[te],C[te]=he[te].evaluate(ue,de)},te}(te)).load(_e.features):Ze(_e,te.geojsonVtOptions)}catch(de){return ce(de)}this.loaded={};const ye={};if(ue){const le=C.f(he);le&&(ye.resourceTiming={},ye.resourceTiming[te.source]=JSON.parse(JSON.stringify(le)))}ce(null,ye)}}))}reloadTile(C,te){const le=this.loaded;return le&&le[C.uid]?super.reloadTile(C,te):this.loadTile(C,te)}loadGeoJSON(te,le){if(te.request)C.h(te.request,le);else{if("string"!=typeof te.data)return le(new Error(`Input data given to '${te.source}' is not a valid GeoJSON object.`));try{return le(null,JSON.parse(te.data))}catch(C){return le(new Error(`Input data given to '${te.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(C,te){try{te(null,this._geoJSONIndex.getClusterExpansionZoom(C.clusterId))}catch(C){te(C)}}getClusterChildren(C,te){try{te(null,this._geoJSONIndex.getChildren(C.clusterId))}catch(C){te(C)}}getClusterLeaves(C,te){try{te(null,this._geoJSONIndex.getLeaves(C.clusterId,C.limit,C.offset))}catch(C){te(C)}}}class W{constructor(te,le){this.tileID=new C.O(te.tileID.overscaledZ,te.tileID.wrap,te.tileID.canonical.z,te.tileID.canonical.x,te.tileID.canonical.y),this.tileZoom=te.tileZoom,this.uid=te.uid,this.zoom=te.zoom,this.canonical=te.tileID.canonical,this.pixelRatio=te.pixelRatio,this.tileSize=te.tileSize,this.source=te.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=te.projection,this.brightness=le}parse(te,le,ce,he){this.status="parsing";const ue=new C.O(ce.tileID.overscaledZ,ce.tileID.wrap,ce.tileID.canonical.z,ce.tileID.canonical.x,ce.tileID.canonical.y),de={},_e=le.familiesBySource[ce.source],ye=new C.F(ue,ce.promoteId);return ye.bucketLayerIDs=[],C.l(te).then((te=>{if(!te)return he(new Error("Could not parse tile"));const le=C.j(te,1/C.t(ce.tileID.canonical)),ve=te.json.extensionsUsed&&te.json.extensionsUsed.includes("MAPBOX_mesh_features"),Se=new C.k(this.zoom,{brightness:this.brightness});for(const ce in _e)for(const he of _e[ce]){const ce=he[0],_e=te.json.extensionsUsed;ce.recalculate(Se,[]);const ye=new C.T(le,ue,_e&&_e.includes("MAPBOX_mesh_features"),this.brightness);ve||(ye.needsUpload=!0),de[ce.fqid]=ye,ye.evaluate(ce)}this.status="done",he(null,{buckets:de,featureIndex:ye})})).catch((C=>he(new Error(C.message))))}}class X{constructor(C,te,le,ce,he,ue){this.actor=C,this.layerIndex=te,this.brightness=ue,this.loading={},this.loaded={}}loadTile(te,le){const ce=te.uid,he=this.loading[ce]=new W(te,this.brightness);C.i(te.request,((C,ue)=>{const de=!this.loading[ce];return delete this.loading[ce],de||C?(he.status="done",de||(this.loaded[ce]=he),le(C)):ue&&0!==ue.byteLength?void he.parse(ue,this.layerIndex,te,((C,te)=>{he.status="done",this.loaded=this.loaded||{},this.loaded[ce]=he,C||!te?le(C):le(null,te)})):(he.status="done",this.loaded[ce]=he,le())}))}reloadTile(C,te){const le=this.loaded,ce=C.uid;if(le&&le[ce]){const he=le[ce];he.projection=C.projection,he.brightness=C.brightness;const s=(le,ce)=>{he.reloadCallback&&(delete he.reloadCallback,this.loadTile(C,te)),te(le,ce)};"parsing"===he.status?he.reloadCallback=s:"done"===he.status&&this.loadTile(C,te)}}abortTile(C,te){const le=C.uid;this.loading[le]&&delete this.loading[le],te()}removeTile(C,te){const le=this.loaded,ce=C.uid;le&&le[ce]&&delete le[ce],te()}}class V{constructor(te){this.self=te,this.actor=new C.A(te,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=C.m({name:"mercator"}),this.workerSourceTypes={vector:C.d,geojson:G,"batched-model":X},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(C,te)=>{if(this.workerSourceTypes[C])throw new Error(`Worker source with name "${C}" already registered.`);this.workerSourceTypes[C]=te},this.self.registerRTLTextPlugin=te=>{if(C.n.isParsed())throw new Error("RTL text plugin already registered.");C.n.applyArabicShaping=te.applyArabicShaping,C.n.processBidirectionalText=te.processBidirectionalText,C.n.processStyledBidirectionalText=te.processStyledBidirectionalText}}clearCaches(C,te,le){delete this.layerIndexes[C],delete this.availableImages[C],delete this.workerSources[C],delete this.demWorkerSources[C],le()}checkIfReady(C,te,le){le()}setReferrer(C,te){this.referrer=te}spriteLoaded(te,{scope:le,isLoaded:ce}){if(this.isSpriteLoaded[te]||(this.isSpriteLoaded[te]={}),this.isSpriteLoaded[te][le]=ce,this.workerSources[te]&&this.workerSources[te][le])for(const he in this.workerSources[te][le]){const ue=this.workerSources[te][le][he];for(const te in ue)ue[te]instanceof C.d&&(ue[te].isSpriteLoaded=ce,ue[te].fire(new C.o("isSpriteLoaded")))}}setImages(C,{scope:te,images:le},ce){if(this.availableImages[C]||(this.availableImages[C]={}),this.availableImages[C][te]=le,this.workerSources[C]&&this.workerSources[C][te]){for(const ce in this.workerSources[C][te]){const he=this.workerSources[C][te][ce];for(const C in he)he[C].availableImages=le}ce()}else ce()}setProjection(te,le){this.projections[te]=C.m(le)}setBrightness(C,te,le){this.brightness=te,le()}setLayers(C,te,le){this.getLayerIndex(C,te.scope).replace(te.layers,te.options),le()}updateLayers(C,te,le){this.getLayerIndex(C,te.scope).update(te.layers,te.removedIds,te.options),le()}loadTile(C,te,le){te.projection=this.projections[C]||this.defaultProjection,this.getWorkerSource(C,te.type,te.source,te.scope).loadTile(te,le)}loadDEMTile(C,te,le){this.getDEMWorkerSource(C,te.source,te.scope).loadTile(te,le)}reloadTile(C,te,le){te.projection=this.projections[C]||this.defaultProjection,this.getWorkerSource(C,te.type,te.source,te.scope).reloadTile(te,le)}abortTile(C,te,le){this.getWorkerSource(C,te.type,te.source,te.scope).abortTile(te,le)}removeTile(C,te,le){this.getWorkerSource(C,te.type,te.source,te.scope).removeTile(te,le)}removeSource(C,te,le){if(!(this.workerSources[C]&&this.workerSources[C][te.scope]&&this.workerSources[C][te.scope][te.type]&&this.workerSources[C][te.scope][te.type][te.source]))return;const ce=this.workerSources[C][te.scope][te.type][te.source];delete this.workerSources[C][te.scope][te.type][te.source],void 0!==ce.removeSource?ce.removeSource(te,le):le()}loadWorkerSource(C,te,le){try{this.self.importScripts(te.url),le()}catch(C){le(C.toString())}}syncRTLPluginState(te,le,ce){try{C.n.setState(le);const te=C.n.getPluginURL();if(C.n.isLoaded()&&!C.n.isParsed()&&null!=te){this.self.importScripts(te);const le=C.n.isParsed();ce(le?void 0:new Error(`RTL Text Plugin failed to import scripts from ${te}`),le)}}catch(C){ce(C.toString())}}setDracoUrl(C,te){this.dracoUrl=te}getAvailableImages(C,te){this.availableImages[C]||(this.availableImages[C]={});let le=this.availableImages[C][te];return le||(le=[]),le}getLayerIndex(C,te){this.layerIndexes[C]||(this.layerIndexes[C]={});let le=this.layerIndexes[C][te];return le||(le=this.layerIndexes[C][te]=new o,le.scope=te),le}getWorkerSource(C,te,le,ce){if(this.workerSources[C]||(this.workerSources[C]={}),this.workerSources[C][ce]||(this.workerSources[C][ce]={}),this.workerSources[C][ce][te]||(this.workerSources[C][ce][te]={}),this.isSpriteLoaded[C]||(this.isSpriteLoaded[C]={}),!this.workerSources[C][ce][te][le]){const he={send:(te,le,ce,he,ue,de)=>{this.actor.send(te,le,ce,C,ue,de)},scheduler:this.actor.scheduler};this.workerSources[C][ce][te][le]=new this.workerSourceTypes[te](he,this.getLayerIndex(C,ce),this.getAvailableImages(C,ce),this.isSpriteLoaded[C][ce],void 0,this.brightness)}return this.workerSources[C][ce][te][le]}getDEMWorkerSource(C,te,le){return this.demWorkerSources[C]||(this.demWorkerSources[C]={}),this.demWorkerSources[C][le]||(this.demWorkerSources[C][le]={}),this.demWorkerSources[C][le][te]||(this.demWorkerSources[C][le][te]=new i),this.demWorkerSources[C][le][te]}enforceCacheSizeLimit(te,le){C.q(le)}getWorkerPerformanceMetrics(C,te,le){le(void 0,void 0)}}return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope&&(self.worker=new V(self)),V}));define(["./shared"],(function(C){return C.s}));var ue=he;return ue}));var he=le;export{he as default};

